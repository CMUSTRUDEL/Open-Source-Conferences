Title: Lightning Talk by R. Geoffrey Avery - "sudo From a Folder: For the Slightly Trusted User"
Publication date: 2017-06-21
Playlist: TPC 2017 in DC
Description: 
	
Captions: 
	00:00:00,000 --> 00:00:08,600
oh so I sit on that side of the gong

00:00:03,990 --> 00:00:08,600
about 75 times a year how hard can it be

00:00:08,719 --> 00:00:13,920
today we're going to talk about Sidhu

00:00:11,130 --> 00:00:17,850
from a folder for the slightly trusted

00:00:13,920 --> 00:00:19,560
user so the problem that I have is I

00:00:17,850 --> 00:00:21,359
have a Jenkins user running a Jenkins

00:00:19,560 --> 00:00:24,660
setup and occasionally he needs to run

00:00:21,359 --> 00:00:26,460
things as to do with full power but we

00:00:24,660 --> 00:00:28,470
don't want to just let him run anything

00:00:26,460 --> 00:00:31,669
because that would be bad so what ways

00:00:28,470 --> 00:00:35,219
do we have to do such a thing we could

00:00:31,669 --> 00:00:38,100
just become route either Sidhu sue or

00:00:35,219 --> 00:00:40,230
Sidhu - I that's interactive you have

00:00:38,100 --> 00:00:41,910
full power you are route but of course

00:00:40,230 --> 00:00:44,010
it's going to ask for your password it's

00:00:41,910 --> 00:00:46,379
not good for a script and it's

00:00:44,010 --> 00:00:48,329
interactive or we could tell it to do

00:00:46,379 --> 00:00:51,270
something specifically like to do LS

00:00:48,329 --> 00:00:52,530
it's still it's not interactive but it's

00:00:51,270 --> 00:00:54,300
going to ask for a password that's not

00:00:52,530 --> 00:00:56,340
terribly useful and in both these cases

00:00:54,300 --> 00:00:56,789
we have to give ourselves permission to

00:00:56,340 --> 00:00:58,500
do it

00:00:56,789 --> 00:01:01,109
which means you have to go in and edit

00:00:58,500 --> 00:01:02,670
the set cetera sudoers file which by the

00:01:01,109 --> 00:01:04,680
way if you're going to do that you have

00:01:02,670 --> 00:01:06,450
to use vis to do it's a special command

00:01:04,680 --> 00:01:09,180
don't go editing it through any other

00:01:06,450 --> 00:01:11,010
way bad things may happen and in this

00:01:09,180 --> 00:01:14,250
case notice the bottom of the examples

00:01:11,010 --> 00:01:17,729
it's me is full power everywhere can

00:01:14,250 --> 00:01:19,770
become routes so we don't want to give

00:01:17,729 --> 00:01:22,350
him power to do everything so let's go

00:01:19,770 --> 00:01:24,240
with Plan B he could do only special

00:01:22,350 --> 00:01:29,070
things so we go into that same file we

00:01:24,240 --> 00:01:31,259
edit it with VI Sidhu and Jenkins does

00:01:29,070 --> 00:01:33,270
not need a password but he can only run

00:01:31,259 --> 00:01:35,340
these two very specific commands you

00:01:33,270 --> 00:01:39,869
have to put them out exactly but commas

00:01:35,340 --> 00:01:42,390
between them unfortunately if you want

00:01:39,869 --> 00:01:43,829
to give him more powers later you have

00:01:42,390 --> 00:01:46,170
to come back and edit this file which is

00:01:43,829 --> 00:01:50,820
just a pain so we're going to go with

00:01:46,170 --> 00:01:53,850
Plan C it turns out that if you say in

00:01:50,820 --> 00:01:56,399
there a directory name with the flash on

00:01:53,850 --> 00:01:58,799
the end this Jenkins user now without a

00:01:56,399 --> 00:01:59,189
password can run any exact executable

00:01:58,799 --> 00:02:01,619
command

00:01:59,189 --> 00:02:03,299
in that directory can't do anything in

00:02:01,619 --> 00:02:04,829
subdirectories can't do anything in

00:02:03,299 --> 00:02:07,079
parent directories but if you put it in

00:02:04,829 --> 00:02:08,819
that directory and make it executable he

00:02:07,079 --> 00:02:12,120
can run it with full power and that's

00:02:08,819 --> 00:02:13,680
what you need to make it work so that's

00:02:12,120 --> 00:02:15,060
the important slide

00:02:13,680 --> 00:02:16,709
if you forget everything else today

00:02:15,060 --> 00:02:18,959
that's the one to remember and remember

00:02:16,709 --> 00:02:22,140
the slash on the end is important so now

00:02:18,959 --> 00:02:24,030
how can we make this easy for us our

00:02:22,140 --> 00:02:25,739
developers write their code in the

00:02:24,030 --> 00:02:28,739
normal way put it in the normal

00:02:25,739 --> 00:02:30,959
repository and push it out to the

00:02:28,739 --> 00:02:32,579
servers in a normal way and it's sitting

00:02:30,959 --> 00:02:34,530
there waiting for you it's not so doable

00:02:32,579 --> 00:02:37,680
yet but we're going to take care of that

00:02:34,530 --> 00:02:39,810
then the very frosted user that's you

00:02:37,680 --> 00:02:41,489
comes along and make sure that your

00:02:39,810 --> 00:02:45,209
developers have given you something and

00:02:41,489 --> 00:02:47,700
have it tried to a salami slice half

00:02:45,209 --> 00:02:49,889
cents off so you are the final line of

00:02:47,700 --> 00:02:52,769
defense you put it in that place and

00:02:49,889 --> 00:02:54,180
then be very slightly trusted user can

00:02:52,769 --> 00:02:58,260
do the things you've given in permission

00:02:54,180 --> 00:02:59,879
to do so to make this all work I picked

00:02:58,260 --> 00:03:02,069
the directory I put it in the Jenkins

00:02:59,879 --> 00:03:03,810
home directory and I made ass doable

00:03:02,069 --> 00:03:05,220
place and I put a private directory

00:03:03,810 --> 00:03:07,379
inside it which is going to have the

00:03:05,220 --> 00:03:09,000
script from the next few lines to make

00:03:07,379 --> 00:03:10,680
my life easy it's going to automatically

00:03:09,000 --> 00:03:12,810
move the things that I need into the

00:03:10,680 --> 00:03:15,599
right place and we do all of this as

00:03:12,810 --> 00:03:17,639
route one thing to notice that I put it

00:03:15,599 --> 00:03:19,349
in home Jenkins which isn't actually

00:03:17,639 --> 00:03:21,510
owned by root it's owned by the Jenkins

00:03:19,349 --> 00:03:23,790
user which means he could go up a level

00:03:21,510 --> 00:03:25,139
and the nefarious thing so you probably

00:03:23,790 --> 00:03:26,760
should put it in the directory that from

00:03:25,139 --> 00:03:30,000
that point up it's route all the way

00:03:26,760 --> 00:03:31,500
keep yourself out of trouble and the

00:03:30,000 --> 00:03:33,030
script that we're going to be using in

00:03:31,500 --> 00:03:34,139
the next couple lines I call promote

00:03:33,030 --> 00:03:36,750
Jenkins - doable

00:03:34,139 --> 00:03:38,159
this is owned by root when you call it

00:03:36,750 --> 00:03:40,470
you give it a list of script that you

00:03:38,159 --> 00:03:42,419
want to grab from the repositories you

00:03:40,470 --> 00:03:47,790
just checked out put into the special

00:03:42,419 --> 00:03:49,319
place and let it run so three parts

00:03:47,790 --> 00:03:50,909
first thing we're going to do is you're

00:03:49,319 --> 00:03:52,889
going to call that script and you're

00:03:50,909 --> 00:03:54,629
going to give it the list of files we're

00:03:52,889 --> 00:03:57,180
going to move up now and it just loops

00:03:54,629 --> 00:03:58,650
through them and it makes the two

00:03:57,180 --> 00:03:59,849
sources the source file and the

00:03:58,650 --> 00:04:01,530
destination where you're going to put it

00:03:59,849 --> 00:04:02,849
so notice that it's coming from

00:04:01,530 --> 00:04:04,799
somewhere that you've checked it out of

00:04:02,849 --> 00:04:06,599
the repository and you're putting it in

00:04:04,799 --> 00:04:08,639
that special place that we put in the

00:04:06,599 --> 00:04:15,030
sudoers file that he actually has power

00:04:08,639 --> 00:04:17,130
to do stuff and as we can see I'm on

00:04:15,030 --> 00:04:19,789
slide 12 of 27 we're right on track

00:04:17,130 --> 00:04:19,789
we're in good shape

00:04:20,170 --> 00:04:27,890
so after it loops through this it take

00:04:24,860 --> 00:04:30,050
it looks at the source file and it goes

00:04:27,890 --> 00:04:32,210
to check is it there if it is there it

00:04:30,050 --> 00:04:33,980
will show you a diff of the thing that

00:04:32,210 --> 00:04:35,870
you've just got out of the repository

00:04:33,980 --> 00:04:38,510
and the thing that you've already got in

00:04:35,870 --> 00:04:40,400
production remember you are the very

00:04:38,510 --> 00:04:41,150
trusted user you are the last line of

00:04:40,400 --> 00:04:43,580
defense

00:04:41,150 --> 00:04:45,830
if you hit yes and say go ahead and copy

00:04:43,580 --> 00:04:47,360
it over anybody with access to the

00:04:45,830 --> 00:04:48,920
Jenkins user will now be able to run

00:04:47,360 --> 00:04:52,370
this with full powers root

00:04:48,920 --> 00:04:54,500
don't just let anything through you are

00:04:52,370 --> 00:04:56,690
the last line of protection if the files

00:04:54,500 --> 00:04:58,880
not there it's going to assume you had a

00:04:56,690 --> 00:05:00,260
typo you misspelled the script name it

00:04:58,880 --> 00:05:02,270
will show you the directories that are

00:05:00,260 --> 00:05:04,100
it the files that are in that directory

00:05:02,270 --> 00:05:06,710
so that you can go in and deal with them

00:05:04,100 --> 00:05:08,870
fix your mistake and lastly it's going

00:05:06,710 --> 00:05:11,630
to ask you do you really want to move it

00:05:08,870 --> 00:05:13,460
and if you say yes it'll copy it over

00:05:11,630 --> 00:05:15,350
you could also say that you want to

00:05:13,460 --> 00:05:16,940
delete it and get it out of there if you

00:05:15,350 --> 00:05:18,980
try to delete the script that we're

00:05:16,940 --> 00:05:20,930
actually talking about here it has a

00:05:18,980 --> 00:05:23,000
message very funny but deleting this

00:05:20,930 --> 00:05:26,690
will make you sad because this script is

00:05:23,000 --> 00:05:30,710
here just to make our life simpler so a

00:05:26,690 --> 00:05:33,740
quick example remember earlier in Plan B

00:05:30,710 --> 00:05:36,140
we allowed it to start and restart the

00:05:33,740 --> 00:05:38,000
server and you had to type it precisely

00:05:36,140 --> 00:05:40,700
and it had to be in the file precisely

00:05:38,000 --> 00:05:43,490
now you just have to have the file name

00:05:40,700 --> 00:05:45,200
in there right and the script tells

00:05:43,490 --> 00:05:47,060
exactly what to do when it goes off and

00:05:45,200 --> 00:05:49,100
does its thing and you never have to

00:05:47,060 --> 00:05:51,650
worry about going back and this one to

00:05:49,100 --> 00:05:54,500
start and restart but it doesn't have a

00:05:51,650 --> 00:05:56,480
delete shut down the server so you can

00:05:54,500 --> 00:05:57,860
go back and add a shutdown you just have

00:05:56,480 --> 00:05:59,510
to put the script to the right place you

00:05:57,860 --> 00:06:03,110
don't have to go edit the sudoers file

00:05:59,510 --> 00:06:05,300
anymore and you could even send

00:06:03,110 --> 00:06:08,150
parameters in here in this case I'm

00:06:05,300 --> 00:06:09,620
looking at some log files do be safe if

00:06:08,150 --> 00:06:11,150
you choose to do this it's a bit more

00:06:09,620 --> 00:06:13,550
dangerous than the other option and put

00:06:11,150 --> 00:06:15,650
it in double quotes there so that you

00:06:13,550 --> 00:06:17,660
won't get into trouble in this case I'm

00:06:15,650 --> 00:06:21,170
just using a couple variables to go look

00:06:17,660 --> 00:06:21,500
for the right kind of file so it's a

00:06:21,170 --> 00:06:22,050
search

00:06:21,500 --> 00:06:24,310
[Applause]

00:06:22,050 --> 00:06:37,109
[Music]

00:06:24,310 --> 00:06:37,109

YouTube URL: https://www.youtube.com/watch?v=RarVGKBar0A


