Title: Dominik Kundel: coffee js? How I hacked my coffee machine | JSUnconf 2017
Publication date: 2017-06-23
Playlist: JSUnconf 2017
Description: 
	
Captions: 
	00:00:00,030 --> 00:00:05,190
and yeah so how did we do the whole

00:00:03,389 --> 00:00:06,990
thing because now we know what we use

00:00:05,190 --> 00:00:09,929
but we don't really know how to attack a

00:00:06,990 --> 00:00:11,910
coffee machine so neither me nor my

00:00:09,929 --> 00:00:13,920
flatmate are electrical engineers I did

00:00:11,910 --> 00:00:15,900
like two semesters in university but

00:00:13,920 --> 00:00:18,660
like most of the people here probably if

00:00:15,900 --> 00:00:21,300
you didn't do a topic for years you tend

00:00:18,660 --> 00:00:23,369
to forget everything or most of it as

00:00:21,300 --> 00:00:26,970
you will see throughout the process that

00:00:23,369 --> 00:00:28,980
I clearly forgot a lot and so we did

00:00:26,970 --> 00:00:30,689
what most people would do when they when

00:00:28,980 --> 00:00:32,430
they figure something out that they have

00:00:30,689 --> 00:00:34,559
no clue about we just opened this thing

00:00:32,430 --> 00:00:36,950
so we took out all the screws that were

00:00:34,559 --> 00:00:39,300
there literally all the screws initially

00:00:36,950 --> 00:00:40,829
that were like from the casing so we

00:00:39,300 --> 00:00:43,140
took all sides out even though we were

00:00:40,829 --> 00:00:44,940
only interested on this side and there

00:00:43,140 --> 00:00:47,370
were a couple of things here that were

00:00:44,940 --> 00:00:50,010
of interest for us and they were all in

00:00:47,370 --> 00:00:51,870
that corner um so the whole machine can

00:00:50,010 --> 00:00:53,699
be controlled it has a major power

00:00:51,870 --> 00:00:56,129
switch on the back but all the other

00:00:53,699 --> 00:00:59,699
controls are on the right side of the

00:00:56,129 --> 00:01:01,350
coffee machine and our buttons so we

00:00:59,699 --> 00:01:02,699
have the buttons here and then we have a

00:01:01,350 --> 00:01:05,180
micro controller that does the actual

00:01:02,699 --> 00:01:07,619
work and we have this interesting cable

00:01:05,180 --> 00:01:10,439
that connects the two and it was

00:01:07,619 --> 00:01:12,780
interesting because it was an actual

00:01:10,439 --> 00:01:15,270
cable they weren't soldered together or

00:01:12,780 --> 00:01:16,979
something was like a pretty big cable

00:01:15,270 --> 00:01:20,150
that we could just unplug so we did that

00:01:16,979 --> 00:01:22,740
and we just took out the whole thing and

00:01:20,150 --> 00:01:24,689
this is what we ended up with so this is

00:01:22,740 --> 00:01:30,420
the actual control panel of the button

00:01:24,689 --> 00:01:32,189
and it allows you to basically have

00:01:30,420 --> 00:01:33,750
eight pins down there that's where the

00:01:32,189 --> 00:01:35,790
cable plugged in and then you have seven

00:01:33,750 --> 00:01:38,460
LEDs that are on the one hand used to

00:01:35,790 --> 00:01:40,829
show state but they also use for error

00:01:38,460 --> 00:01:42,720
messages etc and then you have those six

00:01:40,829 --> 00:01:43,920
buttons so the bottom right one is the

00:01:42,720 --> 00:01:46,560
important one that's power

00:01:43,920 --> 00:01:49,140
the top one top right one is espresso

00:01:46,560 --> 00:01:52,680
and the top and the right one in the

00:01:49,140 --> 00:01:55,740
middle is is a normal coffee the left

00:01:52,680 --> 00:01:57,329
ones are for for milk coffees etc also

00:01:55,740 --> 00:02:00,540
we didn't we didn't focus on them

00:01:57,329 --> 00:02:02,390
initially and this is the interesting

00:02:00,540 --> 00:02:04,649
table unfortunately didn't have a

00:02:02,390 --> 00:02:05,790
picture of the original setup so this

00:02:04,649 --> 00:02:08,190
would be actually the picture of the

00:02:05,790 --> 00:02:09,929
final setup that's where that's why we

00:02:08,190 --> 00:02:11,459
have nice tape around it but basically

00:02:09,929 --> 00:02:11,819
what we did is we took one side of the

00:02:11,459 --> 00:02:13,170
cable

00:02:11,819 --> 00:02:15,629
we just jammed in a bunch of jumper

00:02:13,170 --> 00:02:18,510
wires so we could connect that to to the

00:02:15,629 --> 00:02:23,129
temple or later into the into a

00:02:18,510 --> 00:02:25,109
breadboard and then we we sat down and

00:02:23,129 --> 00:02:26,879
thought about what do we actually know

00:02:25,109 --> 00:02:29,280
about this board so we have eight cables

00:02:26,879 --> 00:02:30,989
or eight pins that we want to control we

00:02:29,280 --> 00:02:33,870
have six switches and we have seven LEDs

00:02:30,989 --> 00:02:35,639
now the idea that we had was well we

00:02:33,870 --> 00:02:37,230
have a cable so we can connect this to

00:02:35,639 --> 00:02:40,019
the tehsil and we can figure out what

00:02:37,230 --> 00:02:42,840
protocol is being spoken between this

00:02:40,019 --> 00:02:44,849
control plate and the microprocessor we

00:02:42,840 --> 00:02:48,030
can spoof this and then just let the

00:02:44,849 --> 00:02:51,959
tehsil sent this protocol so basically

00:02:48,030 --> 00:02:57,090
what our idea was is that we have power

00:02:51,959 --> 00:02:59,609
going in from one pin and then we have

00:02:57,090 --> 00:03:02,010
at least three pins that must represent

00:02:59,609 --> 00:03:04,980
the buttons because say we have six pins

00:03:02,010 --> 00:03:07,379
or six buttons we could use like a

00:03:04,980 --> 00:03:09,569
binary flag and just represented with

00:03:07,379 --> 00:03:11,790
three pins and then we have three pins

00:03:09,569 --> 00:03:13,709
to control the LEDs but what is the

00:03:11,790 --> 00:03:15,150
eighth cable for because our math

00:03:13,709 --> 00:03:17,310
doesn't really add up here

00:03:15,150 --> 00:03:19,500
but we figured let's let's go for the

00:03:17,310 --> 00:03:23,159
assumptions and try naive approach so

00:03:19,500 --> 00:03:25,079
this is the script to control the castle

00:03:23,159 --> 00:03:27,720
using johnny-five

00:03:25,079 --> 00:03:31,199
so we import the johnny-five library and

00:03:27,720 --> 00:03:34,139
then we are import the tesla Isle plugin

00:03:31,199 --> 00:03:36,060
so that allows us to communicate with

00:03:34,139 --> 00:03:38,669
the johnny-five library and the tehsil

00:03:36,060 --> 00:03:42,090
and then once the board is ready we just

00:03:38,669 --> 00:03:44,159
create seven pins we admit omitted the

00:03:42,090 --> 00:03:46,799
one that we connected to five poles

00:03:44,159 --> 00:03:48,689
because 3.3 volts didn't lit up the LEDs

00:03:46,799 --> 00:03:50,220
5 volts did so you can see how

00:03:48,689 --> 00:03:54,509
scientifically we approach this whole

00:03:50,220 --> 00:03:56,750
thing and then we set them to analog

00:03:54,509 --> 00:03:59,969
mode so the idea was can we figure out

00:03:56,750 --> 00:04:02,310
if the analog mode measures the voltage

00:03:59,969 --> 00:04:04,229
on the pin so we could see if there is a

00:04:02,310 --> 00:04:07,709
voltage difference when we press a

00:04:04,229 --> 00:04:09,239
button for example and then we injected

00:04:07,709 --> 00:04:10,739
them in the repple because journey 5 has

00:04:09,239 --> 00:04:13,500
a nice rattle so when we start off the

00:04:10,739 --> 00:04:14,939
script we can interact with that so we

00:04:13,500 --> 00:04:18,000
just measured the values and

00:04:14,939 --> 00:04:20,400
unfortunately analog pins are very good

00:04:18,000 --> 00:04:22,320
and fluctuating so we couldn't get a

00:04:20,400 --> 00:04:24,510
proper value out of this so we had to

00:04:22,320 --> 00:04:26,790
you tweak this slightly and take out

00:04:24,510 --> 00:04:28,800
this analog mode and turn it into a

00:04:26,790 --> 00:04:31,410
digital pin so the difference is you can

00:04:28,800 --> 00:04:33,360
only set a digital pin to high or low

00:04:31,410 --> 00:04:37,770
and you can only read high or low so

00:04:33,360 --> 00:04:39,510
it's 1 or 0 and we did that and we

00:04:37,770 --> 00:04:42,270
figure it out so when we just plug in

00:04:39,510 --> 00:04:46,560
power we have the three of the right

00:04:42,270 --> 00:04:49,260
LEDs glowing up so that's good that part

00:04:46,560 --> 00:04:51,480
seems to be power and if we turn off

00:04:49,260 --> 00:04:53,940
three of the pins we can actually turn

00:04:51,480 --> 00:04:56,010
off these three LEDs all the other ones

00:04:53,940 --> 00:04:57,330
didn't work we we literally wrote a

00:04:56,010 --> 00:05:00,020
binary flag that went through all

00:04:57,330 --> 00:05:03,300
combinations but we couldn't get them on

00:05:00,020 --> 00:05:05,010
but we knew that when you four pins now

00:05:03,300 --> 00:05:06,720
we knew one is power and three can

00:05:05,010 --> 00:05:11,070
control the LEDs so we're getting close

00:05:06,720 --> 00:05:12,690
to our our initial assumption so what we

00:05:11,070 --> 00:05:14,280
did with the other four pins was we

00:05:12,690 --> 00:05:17,580
declared them as button so johnny-five

00:05:14,280 --> 00:05:19,380
has a has a button clasp in it that

00:05:17,580 --> 00:05:22,530
allows us to really use the power of

00:05:19,380 --> 00:05:24,600
JavaScript by having our event listeners

00:05:22,530 --> 00:05:26,340
on press and release so this is where

00:05:24,600 --> 00:05:29,120
javascript is really cool for hardware

00:05:26,340 --> 00:05:31,620
hacking because we can say listen for

00:05:29,120 --> 00:05:34,800
whenever a button is pressed or when

00:05:31,620 --> 00:05:36,780
it's released and it's just way easier

00:05:34,800 --> 00:05:40,290
than writing a loop and figuring out of

00:05:36,780 --> 00:05:43,440
the value changed and we did this and it

00:05:40,290 --> 00:05:45,780
was some notes that we took in the

00:05:43,440 --> 00:05:47,970
meantime and I could go through them but

00:05:45,780 --> 00:05:49,710
they all don't mean anything but we were

00:05:47,970 --> 00:05:53,040
onto something because we knew that pin

00:05:49,710 --> 00:05:55,080
one was power 4 2 5 and 7 the LEDs were

00:05:53,040 --> 00:05:58,830
able we were able to control through

00:05:55,080 --> 00:06:00,650
pins 4 to 6 but the weird part was 7 & 8

00:05:58,830 --> 00:06:04,650
were the only ones reacting on buttons

00:06:00,650 --> 00:06:05,130
so whenever we press the bottom right

00:06:04,650 --> 00:06:07,680
one

00:06:05,130 --> 00:06:10,640
they were triggering 7 & 8 respectively

00:06:07,680 --> 00:06:13,650
when we press the top two ones they

00:06:10,640 --> 00:06:19,260
progressive and eight and if we set if

00:06:13,650 --> 00:06:20,850
it helped set one bit to high we would

00:06:19,260 --> 00:06:24,090
be able to trigger the other two as well

00:06:20,850 --> 00:06:25,950
so we could use pin 2 & 3 to turn off

00:06:24,090 --> 00:06:27,540
the buttons left and right but that's

00:06:25,950 --> 00:06:30,689
not what we wanted right we want to be

00:06:27,540 --> 00:06:32,399
able to figure out if that button was

00:06:30,689 --> 00:06:35,249
but we could just figure out if one of

00:06:32,399 --> 00:06:39,629
three of if one of three buttons has

00:06:35,249 --> 00:06:41,610
been pressed which meant that that was

00:06:39,629 --> 00:06:43,919
pretty useless so we had to go back to

00:06:41,610 --> 00:06:46,739
the drawing board quite literally so we

00:06:43,919 --> 00:06:48,239
took a picture of this for the first

00:06:46,739 --> 00:06:49,229
time because I mean the plate is like

00:06:48,239 --> 00:06:51,360
this big

00:06:49,229 --> 00:06:53,789
and we're like looking at it like this

00:06:51,360 --> 00:06:55,649
the whole time so we figured maybe

00:06:53,789 --> 00:06:57,899
taking a picture is a bit more

00:06:55,649 --> 00:06:59,849
productive so we took a picture zoomed

00:06:57,899 --> 00:07:02,129
into it and then use the software called

00:06:59,849 --> 00:07:05,399
Fritzing that you can use to create

00:07:02,129 --> 00:07:09,479
diagrams and we turned this into this

00:07:05,399 --> 00:07:11,219
beautiful diagram and it looks like a

00:07:09,479 --> 00:07:14,819
mess and it is a mess because what we

00:07:11,219 --> 00:07:17,009
did is we assumed into the picture and I

00:07:14,819 --> 00:07:20,519
went to said okay I'm going to go from

00:07:17,009 --> 00:07:23,579
this pin to this pin because they might

00:07:20,519 --> 00:07:26,249
be connected and then my flatmates used

00:07:23,579 --> 00:07:28,529
a multimeter to measure the resistance

00:07:26,249 --> 00:07:30,059
between these two parts and if the

00:07:28,529 --> 00:07:33,629
resistance is zero that means the two

00:07:30,059 --> 00:07:35,309
pins are connected our approach meant

00:07:33,629 --> 00:07:37,619
that we had to go from resistor to

00:07:35,309 --> 00:07:39,779
resistor as well so that's what we left

00:07:37,619 --> 00:07:43,709
out all the resistors on this thing or

00:07:39,779 --> 00:07:45,300
what we deemed were resistors and while

00:07:43,709 --> 00:07:46,919
this looks like a mess this was way more

00:07:45,300 --> 00:07:50,579
useful for us because we could finally

00:07:46,919 --> 00:07:52,439
figure out that not only pour a pin one

00:07:50,579 --> 00:07:54,300
was power but pin two and three were

00:07:52,439 --> 00:07:56,339
power as well and that was the reason

00:07:54,300 --> 00:07:59,009
why the other LEDs never laid on because

00:07:56,339 --> 00:08:01,860
we had to put five volts on this pin in

00:07:59,009 --> 00:08:04,709
order to actually see that this that

00:08:01,860 --> 00:08:06,749
these LEDs light up and the process of

00:08:04,709 --> 00:08:11,189
figuring this out we'd burn two of the

00:08:06,749 --> 00:08:12,959
LEDs though so by figuring out hey what

00:08:11,189 --> 00:08:17,459
if we connect five volts directly to

00:08:12,959 --> 00:08:21,229
this LED we that was I'd like 4 a.m. so

00:08:17,459 --> 00:08:23,789
we were slightly slightly tired so we

00:08:21,229 --> 00:08:26,339
broke two but in the end all of them

00:08:23,789 --> 00:08:29,459
that were still working lit up so that

00:08:26,339 --> 00:08:32,159
was a good approach but the switches

00:08:29,459 --> 00:08:35,009
still showed the same problem we knew

00:08:32,159 --> 00:08:36,389
that 1 2 3 R power 4 to 6 or LEDs so we

00:08:35,009 --> 00:08:39,209
were able to finally flick on the

00:08:36,389 --> 00:08:41,390
different LEDs but 7 to 8 we're still

00:08:39,209 --> 00:08:43,640
the only ones that react to buttons

00:08:41,390 --> 00:08:47,720
and we can't figure out which button was

00:08:43,640 --> 00:08:49,580
pressed by just having two bit and so we

00:08:47,720 --> 00:08:52,700
realized that three of these things

00:08:49,580 --> 00:08:53,600
aren't LEDs does anyone have an idea

00:08:52,700 --> 00:08:55,580
what this is

00:08:53,600 --> 00:08:58,280
I mean it's written there but does

00:08:55,580 --> 00:09:01,460
anyone know what it diet is alright one

00:08:58,280 --> 00:09:03,620
person so diets are a few people so

00:09:01,460 --> 00:09:06,980
diets are similar to LEDs they have one

00:09:03,620 --> 00:09:09,950
property which is the current can only

00:09:06,980 --> 00:09:12,260
flow into one direction to be and the

00:09:09,950 --> 00:09:16,790
other directions blocked so an LED does

00:09:12,260 --> 00:09:19,370
that and light up light up but diet will

00:09:16,790 --> 00:09:22,550
just control the current going only in

00:09:19,370 --> 00:09:24,650
one direction so we drop the LEDs from

00:09:22,550 --> 00:09:26,450
the diagram and we added the three diets

00:09:24,650 --> 00:09:28,760
and suddenly stuff made more sense we

00:09:26,450 --> 00:09:32,570
could because we could follow the power

00:09:28,760 --> 00:09:34,040
and we could see where it went and this

00:09:32,570 --> 00:09:36,620
was super useful because we finally

00:09:34,040 --> 00:09:38,330
figured out that there was a mapping and

00:09:36,620 --> 00:09:40,970
the mapping was ATS which one was

00:09:38,330 --> 00:09:43,760
connected between P 3 and P 7 switch to

00:09:40,970 --> 00:09:45,470
was P 3 to P 8 and you see that all of

00:09:43,760 --> 00:09:48,080
them are connected ultimately to seven

00:09:45,470 --> 00:09:50,720
or eight so that that finally explained

00:09:48,080 --> 00:09:52,970
why we you could only listen to the two

00:09:50,720 --> 00:09:54,800
it gave us the same gave up a problem

00:09:52,970 --> 00:09:58,880
though that all of these switches were

00:09:54,800 --> 00:10:00,770
dependent on the input as well and that

00:09:58,880 --> 00:10:03,710
meant we can fake the protocol we can

00:10:00,770 --> 00:10:06,560
just send in high low high low to tell

00:10:03,710 --> 00:10:08,990
it what button was pressed but we had a

00:10:06,560 --> 00:10:12,470
useful thing at home that we've bought

00:10:08,990 --> 00:10:14,150
kind of in luckily right before the

00:10:12,470 --> 00:10:16,790
attack and those were relays

00:10:14,150 --> 00:10:20,270
so relays are digital switches like

00:10:16,790 --> 00:10:21,920
electronic switches that you can use for

00:10:20,270 --> 00:10:24,560
example microcontroller like the tehsil

00:10:21,920 --> 00:10:26,810
to flick them rather than having to

00:10:24,560 --> 00:10:29,180
press them so what we did is we wired

00:10:26,810 --> 00:10:31,880
the cable from the coffee machine into a

00:10:29,180 --> 00:10:34,700
breadboard and then from there we

00:10:31,880 --> 00:10:38,450
reconstructed the same setup that we had

00:10:34,700 --> 00:10:40,580
here on just with the relays instead so

00:10:38,450 --> 00:10:42,500
we only had four relate so we decided to

00:10:40,580 --> 00:10:47,150
map only the three right buttons and

00:10:42,500 --> 00:10:49,730
left out the left left three and we also

00:10:47,150 --> 00:10:52,550
wired up these LEDs to these three LEDs

00:10:49,730 --> 00:10:53,990
to show up which status it is in so that

00:10:52,550 --> 00:10:54,980
we know whether the coffee machine is

00:10:53,990 --> 00:11:00,110
heating right now

00:10:54,980 --> 00:11:02,240
etc so this was the initial wire up we

00:11:00,110 --> 00:11:05,959
had to be very careful to not touch the

00:11:02,240 --> 00:11:07,160
hot coffee machine while testing it even

00:11:05,959 --> 00:11:11,269
though my flatmate I think brewing

00:11:07,160 --> 00:11:13,420
himself twice and then we scripted a

00:11:11,269 --> 00:11:15,709
small manual script to control this and

00:11:13,420 --> 00:11:17,589
basically what we did is we leveraged

00:11:15,709 --> 00:11:20,240
the fact that there's also a relay class

00:11:17,589 --> 00:11:23,420
we connected it we said on which port

00:11:20,240 --> 00:11:25,160
where were connected to so we connected

00:11:23,420 --> 00:11:29,180
to normally open which means by default

00:11:25,160 --> 00:11:31,339
the switch is open and then we just

00:11:29,180 --> 00:11:33,980
close them immediately and injected the

00:11:31,339 --> 00:11:36,410
whole thing into the repple so that we

00:11:33,980 --> 00:11:40,130
can control it and I hope the video

00:11:36,410 --> 00:11:43,160
works so we ran grande open at like 5

00:11:40,130 --> 00:11:44,720
a.m. we started editing at 8 p.m. and it

00:11:43,160 --> 00:11:46,579
started running water it's a bit hard to

00:11:44,720 --> 00:11:48,380
see we didn't put coffee in it because

00:11:46,579 --> 00:11:50,290
we weren't sure yet if it works and we

00:11:48,380 --> 00:11:52,760
didn't want to waste coffee and once it

00:11:50,290 --> 00:11:54,940
once your trigger grinder closed it's

00:11:52,760 --> 00:11:58,970
going to it's going to close again

00:11:54,940 --> 00:12:00,529
alright um cool so once we were done

00:11:58,970 --> 00:12:03,230
with that we just locked up the whole

00:12:00,529 --> 00:12:05,149
thing um closed it again properly put

00:12:03,230 --> 00:12:07,130
the sides back on and use the fact that

00:12:05,149 --> 00:12:09,649
now that we remove the buttons we had

00:12:07,130 --> 00:12:11,630
some holes there so we just wired the

00:12:09,649 --> 00:12:15,620
cable through it put a button on it

00:12:11,630 --> 00:12:17,899
that's the Johnny Five logo and then

00:12:15,620 --> 00:12:21,050
wires the whole stuff on top so that in

00:12:17,899 --> 00:12:23,060
theory we could even unplug the cables

00:12:21,050 --> 00:12:24,589
here now and plug back in the control

00:12:23,060 --> 00:12:26,269
plate and we could use the coffee

00:12:24,589 --> 00:12:28,610
machine as intended without having

00:12:26,269 --> 00:12:31,550
broken it because we didn't solder

00:12:28,610 --> 00:12:33,290
anything but we still don't have an i/o

00:12:31,550 --> 00:12:35,209
tea coffee machine wrap we were able to

00:12:33,290 --> 00:12:39,139
control this with JavaScript but we

00:12:35,209 --> 00:12:41,930
aren't able to have something that's

00:12:39,139 --> 00:12:43,850
connected to the internet yet and this

00:12:41,930 --> 00:12:47,149
is where my favourite status code comes

00:12:43,850 --> 00:12:49,630
in for 18 I'm a teapot I don't know if

00:12:47,149 --> 00:12:52,430
you've heard of this before this is a

00:12:49,630 --> 00:12:54,769
suggested HTTP status code it's not an

00:12:52,430 --> 00:12:56,449
official one but some people use it so

00:12:54,769 --> 00:12:58,730
if you go to google.com slash

00:12:56,449 --> 00:13:03,500
teapot it actually returns that HTTP

00:12:58,730 --> 00:13:07,790
status code um and it was suggested in

00:13:03,500 --> 00:13:10,490
the IETF RFC to 3 to 4 which is the HTC

00:13:07,790 --> 00:13:13,850
CP or in other words the hypertext

00:13:10,490 --> 00:13:17,300
coffeepot control protocol which was

00:13:13,850 --> 00:13:19,160
suggested on April 1st 1998 and this

00:13:17,300 --> 00:13:20,780
gives you an idea why we actually hacked

00:13:19,160 --> 00:13:23,300
our coffee machine last weekend because

00:13:20,780 --> 00:13:25,460
we're approaching April 1st and we

00:13:23,300 --> 00:13:28,100
figure it is a good point to to

00:13:25,460 --> 00:13:29,930
implement this protocol so we took this

00:13:28,100 --> 00:13:31,940
protocol actually and implemented it or

00:13:29,930 --> 00:13:34,880
parts of it but I first want to give you

00:13:31,940 --> 00:13:37,220
an overview of it so it's it's based on

00:13:34,880 --> 00:13:39,290
top of HTTP so you can use gaps and post

00:13:37,220 --> 00:13:41,750
like there used to you can also use the

00:13:39,290 --> 00:13:43,790
new method brew it's not limited to

00:13:41,750 --> 00:13:46,960
copper to the coffee protocol though

00:13:43,790 --> 00:13:50,090
either just in case you want to derive a

00:13:46,960 --> 00:13:53,210
beer brewing protocol the RFC suggests

00:13:50,090 --> 00:13:55,430
you could use the same method it suggest

00:13:53,210 --> 00:13:57,710
you use a safe header to recommend

00:13:55,430 --> 00:13:59,120
whether you can do the same operation

00:13:57,710 --> 00:14:01,040
again so you can use this with

00:13:59,120 --> 00:14:03,070
conditionals as well like if user is

00:14:01,040 --> 00:14:06,350
awake you can't through another coffee

00:14:03,070 --> 00:14:09,310
and it adds a new except additions

00:14:06,350 --> 00:14:11,530
headers so you can add milk or serve or

00:14:09,310 --> 00:14:15,410
alcohol to your coffee

00:14:11,530 --> 00:14:18,020
it suggests the HTTP status code for 18

00:14:15,410 --> 00:14:20,270
in case you try to talk to a copy to a

00:14:18,020 --> 00:14:23,300
teapot rather than a coffee pot with

00:14:20,270 --> 00:14:26,240
your instructions and obviously we need

00:14:23,300 --> 00:14:29,780
to be able to address them so it defines

00:14:26,240 --> 00:14:31,340
a URI scheme as well and many more

00:14:29,780 --> 00:14:33,890
things this is actually the definition

00:14:31,340 --> 00:14:35,810
of the except additions header fields so

00:14:33,890 --> 00:14:38,750
with milk type syrup type sweetener type

00:14:35,810 --> 00:14:42,050
spice type and alcohol type on sweetener

00:14:38,750 --> 00:14:44,030
and spice type are not defined as what

00:14:42,050 --> 00:14:46,400
is limited to that's probably great for

00:14:44,030 --> 00:14:49,210
Starbucks so they can still use this if

00:14:46,400 --> 00:14:51,620
they want to do pumpkin spice lattes um

00:14:49,210 --> 00:14:52,190
but yeah that's basically what they

00:14:51,620 --> 00:14:54,230
recommend

00:14:52,190 --> 00:14:56,240
this is a coffee your eye scheme and I'm

00:14:54,230 --> 00:14:58,340
happy that the screen is so big because

00:14:56,240 --> 00:14:59,990
my favorite part is this so that's the

00:14:58,340 --> 00:15:03,080
German one and you can see it starts

00:14:59,990 --> 00:15:05,030
with like in person for be the reason I

00:15:03,080 --> 00:15:08,990
cut it actually out is written below is

00:15:05,030 --> 00:15:11,330
that they're internationalized and it

00:15:08,990 --> 00:15:13,340
insists on that you use a capital K for

00:15:11,330 --> 00:15:16,490
coffee if you're using the German

00:15:13,340 --> 00:15:19,520
protocol so you need to escape that by

00:15:16,490 --> 00:15:20,710
using person for B and then we have a

00:15:19,520 --> 00:15:23,140
pod integer

00:15:20,710 --> 00:15:25,149
you can add additions to it the great

00:15:23,140 --> 00:15:28,810
thing is it's a life we actually have

00:15:25,149 --> 00:15:30,460
something working and I'm going to do a

00:15:28,810 --> 00:15:34,000
demo so I'm going to switch to my lovely

00:15:30,460 --> 00:15:35,740
coffee machine here I couldn't bring my

00:15:34,000 --> 00:15:37,680
actual coffee machine because my flat

00:15:35,740 --> 00:15:39,399
net would have been really mad

00:15:37,680 --> 00:15:41,740
especially if I wouldn't have gotten

00:15:39,399 --> 00:15:43,839
this talking so I brought this coffee

00:15:41,740 --> 00:15:46,709
machine here it's a fake coffee machine

00:15:43,839 --> 00:15:49,899
it's basically a bunch of LEDs that

00:15:46,709 --> 00:15:51,910
somebody will simulate the three buttons

00:15:49,899 --> 00:15:53,440
that we would press so you can see that

00:15:51,910 --> 00:15:56,890
the button of the fake buttons are

00:15:53,440 --> 00:15:59,620
pressed and then we have the script here

00:15:56,890 --> 00:16:02,470
and we have the script running or any is

00:15:59,620 --> 00:16:04,330
basically an HTTP server so there's

00:16:02,470 --> 00:16:06,940
nothing Hardware specific in this script

00:16:04,330 --> 00:16:10,709
I'm using local tunnel to create an

00:16:06,940 --> 00:16:14,950
address that we can externally at access

00:16:10,709 --> 00:16:16,450
and basically once we have that all set

00:16:14,950 --> 00:16:18,790
up we set up the coffee machine and when

00:16:16,450 --> 00:16:20,260
that is ready we can use it and then we

00:16:18,790 --> 00:16:21,970
just handle the request so what you can

00:16:20,260 --> 00:16:23,529
see we check if the coffee machine is

00:16:21,970 --> 00:16:27,130
actually a teapot just in case

00:16:23,529 --> 00:16:29,050
we've get methods that respond with the

00:16:27,130 --> 00:16:30,970
appropriate coffee message coffee pot

00:16:29,050 --> 00:16:34,000
content type which is one that is

00:16:30,970 --> 00:16:36,550
suggested in the protocol we also have

00:16:34,000 --> 00:16:38,709
post and brew I don't think the HTTP

00:16:36,550 --> 00:16:42,310
from node supports grew but I didn't try

00:16:38,709 --> 00:16:44,800
that yet we set the headers armed and

00:16:42,310 --> 00:16:46,420
yeah we check for all this stuff like

00:16:44,800 --> 00:16:48,100
the correct content type we check for

00:16:46,420 --> 00:16:49,510
the accept additions unfortunately our

00:16:48,100 --> 00:16:54,370
coffee machine doesn't support any

00:16:49,510 --> 00:16:56,709
additions yet but it will come and yeah

00:16:54,370 --> 00:16:58,390
so let's do a quick demo I'm going to

00:16:56,709 --> 00:17:00,160
make this a bit bigger so I have my

00:16:58,390 --> 00:17:02,140
authorization here it talks about

00:17:00,160 --> 00:17:03,880
security in the RFC but I wasn't really

00:17:02,140 --> 00:17:05,860
sure what they weren't really specific

00:17:03,880 --> 00:17:07,800
what's the best authorization is so I

00:17:05,860 --> 00:17:11,860
just have like I created my own header

00:17:07,800 --> 00:17:14,620
and then we specify the content type so

00:17:11,860 --> 00:17:18,610
I'm going to do a get actually to pot 0

00:17:14,620 --> 00:17:22,150
so that should tell us if the internet

00:17:18,610 --> 00:17:23,920
isn't too slow like local tunnel is

00:17:22,150 --> 00:17:25,390
sometimes a bit slow there we go

00:17:23,920 --> 00:17:28,480
currently the coffee machine is on

00:17:25,390 --> 00:17:30,850
that's great now I had to improvise with

00:17:28,480 --> 00:17:33,530
the URI scheme a bit because it doesn't

00:17:30,850 --> 00:17:35,570
suggest like it's a copy pod

00:17:33,530 --> 00:17:37,880
supports multiple versions or copies

00:17:35,570 --> 00:17:41,660
which at not in 1998 wasn't really

00:17:37,880 --> 00:17:43,250
common so I extended the thing a bit so

00:17:41,660 --> 00:17:46,190
we can order an espresso and now you

00:17:43,250 --> 00:17:49,580
should look at the LEDs so I'm going to

00:17:46,190 --> 00:17:55,610
do a post request to the LEDs I'm going

00:17:49,580 --> 00:17:59,180
to specify start and there we go the LED

00:17:55,610 --> 00:18:00,680
lit up and the same port run there we

00:17:59,180 --> 00:18:03,730
have the problem that right now we

00:18:00,680 --> 00:18:06,500
aren't able to measure whether the

00:18:03,730 --> 00:18:08,180
status is the right one like whether

00:18:06,500 --> 00:18:11,480
it's currently brewing a coffee or not

00:18:08,180 --> 00:18:14,090
we could figure this out by checking

00:18:11,480 --> 00:18:15,530
what the value on the LEDs are on the

00:18:14,090 --> 00:18:17,780
respective ones that we have on the

00:18:15,530 --> 00:18:20,630
original board but the problem there is

00:18:17,780 --> 00:18:21,860
that we would literally like the current

00:18:20,630 --> 00:18:24,020
solution that we could only come up with

00:18:21,860 --> 00:18:27,320
is having a photo sensor measure whether

00:18:24,020 --> 00:18:29,150
literally the LED is on because we don't

00:18:27,320 --> 00:18:31,460
share a common ground between the tehsil

00:18:29,150 --> 00:18:33,440
and coffee machine so we can't measure

00:18:31,460 --> 00:18:34,820
the values if you want to know more

00:18:33,440 --> 00:18:39,740
about that we can talk about that later

00:18:34,820 --> 00:18:42,530
over coffee and yeah so we can also turn

00:18:39,740 --> 00:18:45,920
this whole thing off so that should

00:18:42,530 --> 00:18:48,350
trigger the other one boom so that all

00:18:45,920 --> 00:18:52,190
worked let's quickly look at the actual

00:18:48,350 --> 00:18:55,190
coffee code so what we do is we similar

00:18:52,190 --> 00:18:57,230
to the manual script we just initialize

00:18:55,190 --> 00:18:59,390
the different relays that we're

00:18:57,230 --> 00:19:00,950
connected to and then we have a press

00:18:59,390 --> 00:19:02,660
power method which just checks if it's

00:19:00,950 --> 00:19:04,370
on which currently is just a fake

00:19:02,660 --> 00:19:06,290
because I know it's like it takes 20

00:19:04,370 --> 00:19:09,980
seconds roughly to heat up so I'm

00:19:06,290 --> 00:19:11,750
waiting for 21 seconds until it's on and

00:19:09,980 --> 00:19:13,850
then we have a switch method and all of

00:19:11,750 --> 00:19:16,940
them call this press baton method which

00:19:13,850 --> 00:19:19,850
in order to simulate a button press we

00:19:16,940 --> 00:19:22,130
just open the relay wait for 500

00:19:19,850 --> 00:19:23,810
milliseconds and then close it again the

00:19:22,130 --> 00:19:25,970
reason for that is if we would just keep

00:19:23,810 --> 00:19:27,860
it open it would just continue running

00:19:25,970 --> 00:19:30,170
until we close it again but if we only

00:19:27,860 --> 00:19:31,610
present shortly starts brewing only the

00:19:30,170 --> 00:19:33,560
amount that we need so for a Nespresso

00:19:31,610 --> 00:19:35,990
would only brew that much rather than

00:19:33,560 --> 00:19:39,140
having to figure out how many seconds it

00:19:35,990 --> 00:19:41,450
takes to brew a copy we let that be done

00:19:39,140 --> 00:19:43,520
by the coffee machine itself and that's

00:19:41,450 --> 00:19:45,940
all like that's literally all the code

00:19:43,520 --> 00:19:45,940
that we need

00:19:46,210 --> 00:19:51,250
so let me switch back to my slides all

00:19:49,630 --> 00:19:53,710
right so what did what what did we

00:19:51,250 --> 00:19:56,320
actually learn during this during this

00:19:53,710 --> 00:19:58,960
hack um first of all reverse engineering

00:19:56,320 --> 00:20:01,270
is a lot of fun trying to figure this

00:19:58,960 --> 00:20:04,540
out it's it's way too addicting I think

00:20:01,270 --> 00:20:07,300
we started at 7 or 8 p.m. on on Friday

00:20:04,540 --> 00:20:09,840
and we stayed up until 6 a.m. or

00:20:07,300 --> 00:20:12,520
something until we finally had coffee

00:20:09,840 --> 00:20:13,810
which was useful at that time because

00:20:12,520 --> 00:20:18,340
like we totally didn't want to go to

00:20:13,810 --> 00:20:20,290
sleep but it was real really a lot of

00:20:18,340 --> 00:20:22,720
fun because reverse engineering an API

00:20:20,290 --> 00:20:24,040
or something is already interesting but

00:20:22,720 --> 00:20:26,740
reverse engineering something where you

00:20:24,040 --> 00:20:27,160
have even less of a clue that's even

00:20:26,740 --> 00:20:29,350
better

00:20:27,160 --> 00:20:34,090
it can be very very frustrating though

00:20:29,350 --> 00:20:37,240
because you can't just like it's harder

00:20:34,090 --> 00:20:41,320
to reverse engineer hardware than it is

00:20:37,240 --> 00:20:43,090
to reverse engineer software especially

00:20:41,320 --> 00:20:44,320
because it's easier to break things and

00:20:43,090 --> 00:20:45,970
if you're doing this in the middle of

00:20:44,320 --> 00:20:48,250
the night and you're burning something

00:20:45,970 --> 00:20:51,580
you might not be able to get replacement

00:20:48,250 --> 00:20:53,020
parts JavaScript and hardware work great

00:20:51,580 --> 00:20:56,650
so this was the first time I actually

00:20:53,020 --> 00:20:58,540
did a hack with any hope like the

00:20:56,650 --> 00:21:00,460
different options that we had there I

00:20:58,540 --> 00:21:02,500
have them lying around but I never had a

00:21:00,460 --> 00:21:05,890
good news case for it and I think this

00:21:02,500 --> 00:21:07,690
was a really good use days the tehsil 2

00:21:05,890 --> 00:21:11,260
is great like it's so much fun to work

00:21:07,690 --> 00:21:14,320
with it it has a great CLI on that you

00:21:11,260 --> 00:21:16,630
can spin a you can easily configure the

00:21:14,320 --> 00:21:18,730
Tesla you can run scripts on it you can

00:21:16,630 --> 00:21:21,100
port them on it it works really well and

00:21:18,730 --> 00:21:23,170
johnny-five is super useful because it

00:21:21,100 --> 00:21:25,330
allows you to do this cross cross

00:21:23,170 --> 00:21:27,310
hardware compatibility so that you can

00:21:25,330 --> 00:21:29,230
move this over to a different platform

00:21:27,310 --> 00:21:32,530
later if you want to use a different

00:21:29,230 --> 00:21:34,900
microcontroller so what's next

00:21:32,530 --> 00:21:37,840
we need to programmatically determine

00:21:34,900 --> 00:21:40,390
the state of the coffee machine which as

00:21:37,840 --> 00:21:42,700
I mentioned before is a bit tricky right

00:21:40,390 --> 00:21:47,380
now and we need to add more relate so we

00:21:42,700 --> 00:21:49,660
can finally like add milk to our coffee

00:21:47,380 --> 00:21:51,730
we need an Alexa integration so we have

00:21:49,660 --> 00:21:54,400
the API now but I figured that I've

00:21:51,730 --> 00:21:54,890
finished that on Wednesday or something

00:21:54,400 --> 00:21:57,610
I didn't have

00:21:54,890 --> 00:21:59,450
to finish up the the rest of the

00:21:57,610 --> 00:22:01,310
integration so we need an Alexa

00:21:59,450 --> 00:22:03,350
integration or at least an if this then

00:22:01,310 --> 00:22:04,730
that Handler and probably a Twilio

00:22:03,350 --> 00:22:08,170
integration so I can text when I'm

00:22:04,730 --> 00:22:10,520
walking home to brew your coffee and

00:22:08,170 --> 00:22:12,260
then if you have any suggestions I'm

00:22:10,520 --> 00:22:17,210
more than open to to hear any of your

00:22:12,260 --> 00:22:17,810
suggestions give any real cool idea like

00:22:17,210 --> 00:22:19,370
we need

00:22:17,810 --> 00:22:21,440
we definitely need an Irish coffee

00:22:19,370 --> 00:22:23,960
option so we need to figure out some way

00:22:21,440 --> 00:22:26,120
how we can pour whiskey into it since

00:22:23,960 --> 00:22:27,950
the accept additions headers of suggest

00:22:26,120 --> 00:22:32,210
already that with whiskey as an option

00:22:27,950 --> 00:22:35,090
and yeah with that thanks everyone my

00:22:32,210 --> 00:22:36,080
name is Dominic if I not hack coffee

00:22:35,090 --> 00:22:37,940
machines at work as a developer

00:22:36,080 --> 00:22:39,410
evangelist for Twilio and if you have

00:22:37,940 --> 00:22:43,750
any questions you can grab me later for

00:22:39,410 --> 00:22:43,750
a coffee beer or shoot me a message

00:22:52,220 --> 00:23:01,490
I think we have like a minute left or

00:22:55,789 --> 00:23:06,559
something there's a question yet yes so

00:23:01,490 --> 00:23:10,309
right that's exactly that's that's like

00:23:06,559 --> 00:23:12,770
v4 we first need to be able to brew all

00:23:10,309 --> 00:23:14,570
this stuff right now the the agreement

00:23:12,770 --> 00:23:16,460
that we have is whoever takes the coffee

00:23:14,570 --> 00:23:18,049
puts a new cup underneath it and puts a

00:23:16,460 --> 00:23:20,390
new because it's an espresso so you need

00:23:18,049 --> 00:23:22,280
to put this thing in it so you need to

00:23:20,390 --> 00:23:24,110
put that in and put the cup back onto it

00:23:22,280 --> 00:23:25,789
but you can do that in the evening or

00:23:24,110 --> 00:23:28,220
whenever you took the last coffee and

00:23:25,789 --> 00:23:29,870
it's ready so that when you wake up or

00:23:28,220 --> 00:23:31,190
when you really feel like your coffee

00:23:29,870 --> 00:23:33,710
but you don't feel like making your

00:23:31,190 --> 00:23:34,690
coffee you you don't have to worry about

00:23:33,710 --> 00:23:39,140
that anymore

00:23:34,690 --> 00:23:41,650
any other questions all right thanks for

00:23:39,140 --> 00:23:41,650
your attention

00:23:45,340 --> 00:23:49,300
also if you want to see the hardware you

00:23:47,380 --> 00:23:54,300
can drop by now or later or something I

00:23:49,300 --> 00:23:54,300

YouTube URL: https://www.youtube.com/watch?v=v02PMZherEI


