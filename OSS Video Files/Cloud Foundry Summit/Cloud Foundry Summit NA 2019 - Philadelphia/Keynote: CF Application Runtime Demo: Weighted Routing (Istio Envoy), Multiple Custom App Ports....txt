Title: Keynote: CF Application Runtime Demo: Weighted Routing (Istio Envoy), Multiple Custom App Ports...
Publication date: 2019-04-11
Playlist: Cloud Foundry Summit NA 2019 - Philadelphia
Description: 
	Keynote: CF Application Runtime Demo: Weighted Routing (Istio/Envoy), Multiple Custom App Ports, and App Revisions - Dieu Cao, Director of Product Management, Pivotal

Have you ever wanted to route traffic for a url to multiple applications in proportions that you can specify?  
How about specifying multiple custom application ports for an application to listen on? Perhaps for a hard-coded listening port? Or for exposing a management endpoint on a different route?
What about tracking changes to your application and being able to easily rollback to a previous version?

In this demo, I'll show how some of the latest features in CF Application Runtime work together to achieve all of the above, making application developer lives easier so they can focus on delivering business value.

About Dieu Cao
Dieu Cao is Director of Product Management at Pivotal, where she works on the product strategy for Pivotal Application Service.  She is also currently serving as the Cloud Foundry Foundation PMC Council Chair. She has been with Pivotal since 2010 and a core contributor to Cloud Foundry since 2014.

https://www.cloudfoundry.org/
Captions: 
	00:00:00,030 --> 00:00:07,799
all right can everyone hear me cool

00:00:03,720 --> 00:00:11,309
let's see if this works this time I

00:00:07,799 --> 00:00:13,650
don't for those of you that were at a CF

00:00:11,309 --> 00:00:19,080
summit Basel there was maybe a slight

00:00:13,650 --> 00:00:22,590
hiccup there but I am I've got my

00:00:19,080 --> 00:00:25,320
fingers crossed on this one so I'm going

00:00:22,590 --> 00:00:27,570
to be demoing a number of new ish

00:00:25,320 --> 00:00:29,670
capabilities in the Cloud Foundry

00:00:27,570 --> 00:00:33,120
application runtime I'll be using a

00:00:29,670 --> 00:00:35,190
number of CF CLI plugins in this demo a

00:00:33,120 --> 00:00:38,489
lot of these capabilities are available

00:00:35,190 --> 00:00:41,100
in the API already it's just not fully

00:00:38,489 --> 00:00:43,530
baked in the CF CLI so you can follow

00:00:41,100 --> 00:00:47,820
this bit later all to to go check those

00:00:43,530 --> 00:00:54,030
out they're very much dev quality lots

00:00:47,820 --> 00:00:56,670
of disclaimers over there okay so you

00:00:54,030 --> 00:00:58,199
can take a look here's a list of all of

00:00:56,670 --> 00:01:03,420
the plugins I have installed for this

00:00:58,199 --> 00:01:06,930
demo so to start with we've got three

00:01:03,420 --> 00:01:11,760
apps pushed in this space and I wanted

00:01:06,930 --> 00:01:14,610
to start with showing off metadata a new

00:01:11,760 --> 00:01:16,860
capability you can add metadata to Apps

00:01:14,610 --> 00:01:22,490
org space as many of the objects in

00:01:16,860 --> 00:01:27,330
Cloud Foundry so we can use this plug-in

00:01:22,490 --> 00:01:30,689
to add an environment variable to this

00:01:27,330 --> 00:01:34,560
app called hello jack that's my son's

00:01:30,689 --> 00:01:40,079
name and we'll say the department is

00:01:34,560 --> 00:01:45,240
equal to CF uh oops oh there's a dash in

00:01:40,079 --> 00:01:48,659
there cool

00:01:45,240 --> 00:01:56,850
so that applied and we can take a look

00:01:48,659 --> 00:02:00,390
at the metadata on another app here this

00:01:56,850 --> 00:02:02,520
app editor has similar metadata maybe a

00:02:00,390 --> 00:02:06,479
different department here and it also

00:02:02,520 --> 00:02:09,740
has an annotation with this description

00:02:06,479 --> 00:02:09,740
and then really is the best

00:02:09,780 --> 00:02:17,260
[Laughter]

00:02:12,250 --> 00:02:24,450
and and you can also with labels you can

00:02:17,260 --> 00:02:27,850
select on labels so let's show that

00:02:24,450 --> 00:02:30,370
you've got CF select apps with the

00:02:27,850 --> 00:02:34,660
department equal to CF label and that's

00:02:30,370 --> 00:02:38,080
hello jack and then the label cfar and

00:02:34,660 --> 00:02:39,640
that's editor so so that's just a

00:02:38,080 --> 00:02:41,920
preview of what you can do with metadata

00:02:39,640 --> 00:02:44,200
there's lots and lots of use cases here

00:02:41,920 --> 00:02:47,560
really interested to see what what folks

00:02:44,200 --> 00:02:50,110
come up with and think to do alright

00:02:47,560 --> 00:02:53,830
moving on next we're going to show off

00:02:50,110 --> 00:02:56,470
multiple application ports so we've got

00:02:53,830 --> 00:03:00,750
this editor up here I wanted to show

00:02:56,470 --> 00:03:06,100
real quick this app it really is running

00:03:00,750 --> 00:03:08,950
on port 8080 again best editor has been

00:03:06,100 --> 00:03:12,070
this is actually a very silly app it's a

00:03:08,950 --> 00:03:15,130
spring boot app but it's using CF Linux

00:03:12,070 --> 00:03:18,250
FS 3 it's using a clad foundries open

00:03:15,130 --> 00:03:24,580
JDK 11 so we're all good there on that

00:03:18,250 --> 00:03:27,730
front so what I'd like to do is show

00:03:24,580 --> 00:03:31,570
that you can now if you enabled the

00:03:27,730 --> 00:03:35,610
actuator port on a actuators on a

00:03:31,570 --> 00:03:42,000
different application port on port 8081

00:03:35,610 --> 00:03:42,000
we we can now enable and configure that

00:03:42,300 --> 00:03:51,900
so that's editor the domain is that

00:03:51,959 --> 00:03:58,390
we're going to call it actuator and the

00:03:57,160 --> 00:04:01,690
port 8081

00:03:58,390 --> 00:04:04,690
different from the default port and it

00:04:01,690 --> 00:04:08,050
says ok that totally worked right

00:04:04,690 --> 00:04:11,970
so we secured this actuator endpoint um

00:04:08,050 --> 00:04:17,230
I actually enabled the thread dump

00:04:11,970 --> 00:04:20,890
endpoint for this and we can take a look

00:04:17,230 --> 00:04:22,990
at it and see that yes I can trigger a

00:04:20,890 --> 00:04:28,900
thread dump off of

00:04:22,990 --> 00:04:31,020
this endpoint and let's pipe that tgq so

00:04:28,900 --> 00:04:37,539
it looks a little more normal

00:04:31,020 --> 00:04:39,699
whoops not that more so that looks like

00:04:37,539 --> 00:04:41,940
a thread dump right everyone it was

00:04:39,699 --> 00:04:45,599
secure it's on a different port and

00:04:41,940 --> 00:04:54,639
that's that's multiple application ports

00:04:45,599 --> 00:04:57,250
alright moving on I wanted to show

00:04:54,639 --> 00:05:01,419
revisions so we've shown in the last few

00:04:57,250 --> 00:05:04,599
summits revisions being able to do or

00:05:01,419 --> 00:05:06,820
sorry rolling deployments one of the

00:05:04,599 --> 00:05:10,720
pieces of feedback that we got about a

00:05:06,820 --> 00:05:15,099
rolling deployment is that it'd be quite

00:05:10,720 --> 00:05:18,250
nice to roll back so here we can see we

00:05:15,099 --> 00:05:24,250
have this plugin we can look at the

00:05:18,250 --> 00:05:28,360
revisions for Dora and we can see that

00:05:24,250 --> 00:05:30,130
right now on version 2 with this

00:05:28,360 --> 00:05:34,479
particular droplet coded here

00:05:30,130 --> 00:05:39,550
Dora is saying hello I'm Dora and what

00:05:34,479 --> 00:05:42,130
we can do now in a rolling deployment

00:05:39,550 --> 00:05:45,880
way kind of bouncing is to say CF

00:05:42,130 --> 00:05:48,930
rollback Dora - version 1 totally

00:05:45,880 --> 00:05:53,259
different droplet and we should see that

00:05:48,930 --> 00:05:54,880
it says it's succeeded it said go this

00:05:53,259 --> 00:05:57,190
is kind of asynchronous so that should

00:05:54,880 --> 00:05:59,500
take a little bit here but it should say

00:05:57,190 --> 00:06:01,570
something different there we go we've

00:05:59,500 --> 00:06:06,150
rolled back to Dora we didn't have any

00:06:01,570 --> 00:06:06,150
downtime and just very smooth

00:06:10,370 --> 00:06:21,720
one one other thing which CF revisions

00:06:15,710 --> 00:06:24,450
door out there you can see that when I

00:06:21,720 --> 00:06:27,240
rolled it back it created a new revision

00:06:24,450 --> 00:06:29,070
here three but with the same droplet

00:06:27,240 --> 00:06:32,690
give it is the one I rolled back to you

00:06:29,070 --> 00:06:37,080
so that that's that last piece of

00:06:32,690 --> 00:06:39,540
revisions alright moving on a weighted

00:06:37,080 --> 00:06:47,700
routing this is the the last thing I

00:06:39,540 --> 00:06:50,310
wanted to demo so I'm going to show the

00:06:47,700 --> 00:06:56,370
ability to use weighted routing between

00:06:50,310 --> 00:06:59,130
two apps hello jack and Dora and using

00:06:56,370 --> 00:07:02,850
the the newest EO routers that are now

00:06:59,130 --> 00:07:07,230
available for you all to to try out so

00:07:02,850 --> 00:07:11,100
we can see that let's see we can see

00:07:07,230 --> 00:07:17,610
what hello jack is is saying that says

00:07:11,100 --> 00:07:20,820
hello and Jack and we can then what we

00:07:17,610 --> 00:07:24,840
would do is look for the domains that is

00:07:20,820 --> 00:07:29,580
my the domain mapped to those sto

00:07:24,840 --> 00:07:31,680
routers and then map these routes so

00:07:29,580 --> 00:07:35,610
using the the very normal map route

00:07:31,680 --> 00:07:43,740
command specify the domain there specify

00:07:35,610 --> 00:07:48,440
a hostname of hello you can see let's

00:07:43,740 --> 00:07:54,660
see will cycle through this over here

00:07:48,440 --> 00:07:56,310
like this there we go so this is pretty

00:07:54,660 --> 00:07:59,460
cool actually already at this point

00:07:56,310 --> 00:08:02,220
because this is is coming through the

00:07:59,460 --> 00:08:03,960
sto routers through three to the app so

00:08:02,220 --> 00:08:08,550
that's already kind of working and

00:08:03,960 --> 00:08:12,450
configured step to map another app to

00:08:08,550 --> 00:08:16,170
that that same thing so hello jack and

00:08:12,450 --> 00:08:19,340
we can map that same domain oops

00:08:16,170 --> 00:08:19,340
do too

00:08:20,970 --> 00:08:28,290
- to that same hostname over here that's

00:08:24,540 --> 00:08:30,360
also added and within 15 to 30 seconds

00:08:28,290 --> 00:08:35,010
that should also be eventually

00:08:30,360 --> 00:08:38,270
consistent and you can see that balanced

00:08:35,010 --> 00:08:42,440
between the two apps by default when you

00:08:38,270 --> 00:08:46,740
map the route there's a weighting of 1

00:08:42,440 --> 00:08:52,290
the current UX the CLI plug-in I'm about

00:08:46,740 --> 00:08:52,710
to show you will allow you to there you

00:08:52,290 --> 00:08:55,380
go

00:08:52,710 --> 00:08:57,450
see some amount of hello jack hello Dora

00:08:55,380 --> 00:09:04,890
no leave it be eventually consistent

00:08:57,450 --> 00:09:08,090
with us those HDI routers so for the

00:09:04,890 --> 00:09:11,220
actual like kinda cool weighting

00:09:08,090 --> 00:09:15,150
weighted routes part using this plug-in

00:09:11,220 --> 00:09:21,090
over here we're going to give Jack a

00:09:15,150 --> 00:09:25,650
little more weight let's see that wrote

00:09:21,090 --> 00:09:30,000
over here and we're going to say 40 so

00:09:25,650 --> 00:09:35,340
right now you can specify the weight a

00:09:30,000 --> 00:09:39,420
number between 1 and 128 Oh update oops

00:09:35,340 --> 00:09:46,770
right had those mixed around update

00:09:39,420 --> 00:09:49,590
route tweet totally different things and

00:09:46,770 --> 00:09:51,960
the way that someone on the networking

00:09:49,590 --> 00:09:55,410
team explained to me how this should

00:09:51,960 --> 00:09:59,760
work is that for every you take the the

00:09:55,410 --> 00:10:02,670
weights of the two apps so 40 + 1 you

00:09:59,760 --> 00:10:06,839
add those together so for every 40

00:10:02,670 --> 00:10:09,060
requests 40 or 41 requests 40 of them

00:10:06,839 --> 00:10:13,860
should go to one one should go to the

00:10:09,060 --> 00:10:16,110
other roughly and I'm vamping again a

00:10:13,860 --> 00:10:19,230
little bit because 15 to 30 seconds for

00:10:16,110 --> 00:10:23,010
this to take effect we should see a

00:10:19,230 --> 00:10:27,089
steady stream of hello I'm Jack and then

00:10:23,010 --> 00:10:27,710
very very I think it took that part and

00:10:27,089 --> 00:10:30,620
that

00:10:27,710 --> 00:10:35,570
and I'm waiting for it to actually say

00:10:30,620 --> 00:10:37,399
hi I'm Dora cuz cuz because that would

00:10:35,570 --> 00:10:41,060
actually show its its balancing a little

00:10:37,399 --> 00:10:44,330
bit so this is totally going to do it

00:10:41,060 --> 00:10:56,899
any any second now fifteen to thirty

00:10:44,330 --> 00:11:08,000
seconds they told me oh where is the

00:10:56,899 --> 00:11:11,480
networking team well anything else

00:11:08,000 --> 00:11:14,660
oh so C F 1 XF is 3 you'll should really

00:11:11,480 --> 00:11:17,450
be migrating to that this month that's

00:11:14,660 --> 00:11:20,839
that's going to be end of support this

00:11:17,450 --> 00:11:25,330
month and yeah still more about being

00:11:20,839 --> 00:11:28,670
know did some did it happen no no no I

00:11:25,330 --> 00:11:32,089
totally did this right right alright

00:11:28,670 --> 00:11:33,800
well I'm gonna take my time here but it

00:11:32,089 --> 00:11:37,580
totally works

00:11:33,800 --> 00:11:39,790
you all can try it and thank you very

00:11:37,580 --> 00:11:39,790

YouTube URL: https://www.youtube.com/watch?v=-ZmSYzoWmto


