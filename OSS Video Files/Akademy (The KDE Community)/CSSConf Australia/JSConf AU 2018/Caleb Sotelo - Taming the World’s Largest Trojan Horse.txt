Title: Caleb Sotelo - Taming the World’s Largest Trojan Horse
Publication date: 2018-04-11
Playlist: JSConf AU 2018
Description: 
	In 2017, companies globally spent $80B on digital advertising—web pages and mobile apps—delivering ads to billions of users, trillions of times. The majority of these ads were rendered in JavaScript environments. Technically, the challenge for JS developers is to instantaneously find the perfect match between an advertiser and a user, regardless of the website, app, or user profile. This is fun. But economically, we’ve been incentivized to create a global delivery mechanism for arbitrary code onto every connected device, without a care for user experience. It’s the world’s largest, and spammiest, Trojan Horse, and JS developers created it.

(1) Construction — What does this Trojan Horse look like at a technical level? This section covers JavaScript constructs that are really unique to ad-tech, including the rise and anatomy of the “ad tag”, creating sandboxes for arbitrary markup, cookie tracking and pixel syncing, and the impression beacon.

(2) Payload — What kinds of undesirable things are being delivered to publisher properties, and onto our devices? This section goes beyond specific examples of ad quality issues, sniffing, tracking, and malware, also looking at a longer-term invasion happening beneath our feet: have content creators begun trading clicks for a kind of dystopian digital future where ad blockers are simply common sense?

(3) Inversion — What can we as JS developers do about all this? This section argues that we have the power to change ad technology from a Trojan Horse into a powerful message delivery system, one that allows the coexistence of free content, advertising, and delightful user experiences. Ethical and optimistic developers will be the Trojan Horse inside the Trojan Horse.
Captions: 
	hello good late afternoonhere don't really thank you because thisis the last talk of the day it's afterloaded up on choc tops so thanks hopethis is interesting to you hope we canlike explode brains in a kind of a newand different way in this last talk solet's get started I'm Caleb I'mcurrently a software architect I'veworked at the same company for six yearsit's called open X it's an ad exchangein Southern California Pasadena I was aJavaScript engineer there for five yearsand then I just transitioned to oh noscreensaver alright just gotta bring upmy speaker notes again well looks likewe exited presentation mode so let'sjust go with this right so I'm anarchitect now which means I get to fixall the code dead I created for myselfstarting in about taming the world's largest Trojanhorse so let's start with digitaladvertising and actually I'm curious howmany of you work directly in ADtechnology okay it's like how many of you in the course of yourjobs have to interact with thattechnology or work on platforms that areyou know monetize using digital ads okayso good good portion let's define someterms media advertising what is thatso we have marketers and we haveaudience right marketers are people withgoods and services you know that theywant to sell to an audience now they'relike many ways to go about it like oneless efficient way to do that would beto just like list out all the people inthe world and go up to them one by oneand ask them that they wanted to buythis thing right that's not superefficient and so we have somethingcalled media advertising which is wherethe marketer actually gets to theaudience by way of something that wecall a publisher which is someone whohas some kind of like attention realestate right so it could be a magazinecould be a billboard could be a websitesomething that the marketer can go toand say hey let me place my ad on thething that all the people are looking atanyway right and we have brokers whichare basically you know companies peoplewho are aggregating the markets you knowtaking what we call the demand on theone side and the supply on the other andconnecting it and the money is gonnaflow from left to right in this diagramthat's media advertising and here's anumber for you across the world globallyin dollars five hundred eighty four billiondollars spent on media advertising lastyear that's a lot so there's a subset ofmedia advertising that I want to talkabout for this talk and that's calleddigital display advertising so it's thesame diagram but the players are justkind of like subsets of what they werebefore our audience is Internet userspeople who are you know connected to theInternet somehow and the marketers arepretty much the same marketers butthey're tapping into Internet connectedaudiences I may have to do this everyfive minutes so I don't shut down againour publishers our digital displaypublishers as we call and they're folkswho run publications that are connectedto the Internet and that you know havescreens right so desktop web appwebsites what mobile apps mobile webconnected TVs anything that has a screenwith some pixel real estate that canshow display ads and is connected to theInternet and the broker is digitaldisplay ad tech that's the industry Iwork in here's a pie chart that kind ofgives some higher fidelity to that adspend a number of five hundred eightyfour billion and we can kind of break itdown all the blue stuff I highlightbecause that's kind of a bigger categorycalled digital in general and it's likeall Internet connected advertising so itincludes things like search classifiedads the display category is right hereright and that's just going to check ifthing has a laser pointer do we know ifit has a laser pointer no okay I wonderif the person let me borrow it is hereso the blue stuff right what'sinteresting about this pie chart is thatdigital category actually eclipse TVright so the first time ever traditionalTV ad spend was at together I think it's unprecedented right so this is a verylarge growing category and digitaldisplay which we're talking about todayis the largest chunk within digital thisis a very confusing picture right thisis the display loom escape and it's kindof used in ad tech talks to kind of likewave in front of people and say look howcomplicated digital display is right andit's really complicated all right sothis is the same kind of flow as theprevious diagram where you havemarketers on one side and publishers andthe audience on the other side exceptall these are actually companies thatare you know together they constitutedigital display ad tech it's a lot ofcompanies you can see the the dashedlines denote acquired company shutteredcompanies everyone's kind of merging andsplitting and growing my company isright there it's in this middle boxOpenX may be hard to see but we're in adexchange which means we sit pretty muchsmack in the middle of this huge wall ofmoney that's moving across right and youknow I'd like to say this reallyindicates like the the you know howthriving in this industry is rightthere's so much movement so many playerseveryone's kind of jumping up with theirstartup trying to get a piece of the pielet's talk about some numbers fordigital display spent spent right so if you backed out themath from the about a billion if we just go by Facebook'slast stat about their monthly activeusers which is they're all seeing digital ads so we'retalking about like large percentages ofthe entireworld population that's being reached bydigital display and then somethingcalledad impression which is really just likethe occurrence of an ad like gettingfrom an ad server onto one of thesepublicationsI asked me about happened in say if each of these you know three orfour billion people had a thousand adsserved to them over the course of theyear that's a reasonable number right actually shown to someone or marketed tosomeone and that brings us the kind ofthe point of this talk and why you knowthis is at J esketh and not at you knowon a an ad tech yacht in the South ofFrance right right this numberwhy is it important how do you how doyou get stuff how do you get arbitraryimages to show up on websites and webapps and mobile apps and stuffJavaScript right so number of times that JavaScript basedads rendered right and you could say ohwell what about mobile app right that'snot really most of these things are donein web views in mobile apps right sothis this we should be proud of thisright JavaScript engineers are helpingyou know they're the gatekeepers of thisenormous unprecedent unprecedentedindustry half a trillion dollars soround of applause please all of you areinvolved in this somehow right thiscommunity is powering this kind ofindustry and now we get to this metaphorthat that the talk is built around thisTrojan horse right so what happens whenyou combine a hundred and ten billiondollars of economic pressure with aplatform that can deliver arbitrary HTMLon to properties all across the worldright inevitably some bad things getthrough right and you know I've invokedthe Trojan horse metaphor so I need toqualify myself which is you know it'stypically a Trojan horse is we think ofit as being maliciously designed rightso ad technology isn't you know doesn'thave a malicious thought behind ithowever what I am interested in isthe idea that it's kind of anice-looking container for literallyanything right so any code can come andrun on a web page or a mobile app and soyou know we as JavaScript engineers areactually you know we're were thegatekeepers to this kind of thing and wehave the challenge of you know how do wedeal with all these kind of latentconsequences and undesirable code andthings that are running everywhere andthat's a really challenging thing andthat's what I want to share with youtoday so the talk is structured in threeparts construction payload and inversionand I'll explain what these seconds areand we get to them part one constructionwe're going to talk about some reallybasic building blocks of digital displayAdTech right and these are justJavaScript concepts that we're allprobably familiar with but they've kindof taken on meanings that they're in thead tech world and when you put them alltogether then I think we'll have abetter understanding of you know whatI'm talking aboutfirst is this thing called an ad tagright this is just some arbitrary markupthat's usually handed from you know somead tech company down this way in thesupply chain right to a publisher sothat they can put it on their page andwhen they put it on their like an adshows up right and it's typically in twoparts we have something where there'slike some configuration like declared inJavaScript you know this is the sitethat I'm coming from these are the sizesthat I want to allow in this little boxand then there's a call-out to a scriptthat's typically called an ad TAC rightor sorry a tag library so this is ahosted script that's hosted by you knowon some CDN by some ad tech company andit's going to download the JavaScriptthat's going to interpret theconfiguration and kick off what we calllike an ad request right the process ofsending an HTTP request out of thebrowser and getting an ad back nowwhat's important and you can see I'vekind of highlighted on this second lineHTML grabbing some property out of thead response object and that hTML is youknow it's it's also kind of arbitrarymarkup if we think of ad tagis kind of like a delivery mechanismthen iframes are in AdTech a containmentmechanism right so we can say I want todrop some like random markup fromsomeone way up the supply chain intothis little sandbox and we use iframesfor that and this is a veryoversimplified example because there aretons of edge cases that come in fordifferent browsers and differentsituations with subdomains and all thisand typically if you write a tag librarythis is gonna be one of the largerfunctions and you're just gonna like acreep like you know arcane knowledge ofhow to do iframesover the years now if you combine addtags and iframes what you get is thepossibility of like you can actuallytraffic an ad tag as the ad responds toHTML and you can kind of have likenever-ending chains where like whatyou're actually loading as your ad isnot an image but it's like another tagthat calls out and calls out and like wesee these like seven or eight levelsdeep sometimes just because how manypeople are actually involved in gettingan ad to show up to more as far asconstruction goes cookies right we knowand love cookies in AD text they're usedprimarily to identify users consistentlyso here's some code of you know aJavaScript based cookie but you can alsodo this on the server side you know aserver can declare that it wants to seta cookie the idea is that it gets tostore a little bit of information onbehalf of its domain in the in theuser's browser and we can use this toconsistently identify a user based onsome unique ID this would be like atracking mechanism and then the last oneis like an analytics mechanism we havewhat we call pixels which is a misnomerbut it came from this idea that youcould just kind of serve an imageelement that would contain some somelike query yards and when that image waswas requested it would return like a hidden jiff right and you basically justbe using the fact that you could renderan image but also sneak some getvariables like back to your servers andyou could have some idea of like whathappened as an ad tech company you couldsay oh I know that the person actuallysaw the adand you know I know that the impressionID was one two three four five now we dothis more programmatically withJavaScript this is an example from thekind of recent navigator dot send beaconAPI where we we have the flexibility tokind of construct a little bit more asfar as like the you know things we'dlike to send back all right so I'm gonnaborrow from the popular mean form meanformat to kind of like round out the thepicture of like what it's like to view aJavaScript ad tech developer blanks arelike the most unspecific way ofreporting a bug but you have to dealwith them all the time right dad's notshowing up it's blank what do I do Ihave to go debug I have to go you knowlike a me this morning and be diggingaround all inside the network tab andfind out why is the ad not showing upyour code versus third-party code thisis like battle bots right when you writeJavaScript and put it out there on theweb you have no idea who else is goingto be running in that global variablesoup I once had a bug where like therewas literally a library that was thename the same as mine and was likeconfusing like you know variablesstepping all over each other you have towrite your JavaScript code reallydefensively when you're an ad techNetwork tab you know you're gonna bethere for days like Network Tabak islike burned into my retinas is like aphysical location like I've been thereyou know should work in all browsersthis is a big one right because itdoesn't matter if Internet Explorer was sunsetted you know five years agoit's still a big enough percentage ofwith it you will be reading lots ofminified code you may break a majorwebsite and have to wake up and dealwith it basically don't merge code onFridays because you don't want to workon the weekend and then in the ad techversion of the waiting for it to compiletrick you can pretty much look at anywebsite you want and just say thatyou're you're debugging it all rightpart two so what kinds of things areactually coming through right this isbroken down into three hashtags first iswhoops right what are the kind ofundesirable things they're kind ofbenign alright you have like a reallynice clean template of a site and it'sgrayscale and modern and then your adcomes in right and it's like it makesyour eyes bleed right you have nocontrol over thatyou know autoplay audio and video rightthis is a great one you ever like youknow like got your head down you'reworking you know you got your Spotifygoing and then there's like this weirdvoice that's like you're like that's notpart of the song you know what's goingon yeah autoplay audio and video comingthrough adds block list violation soyou're like this little guy and yourplan minion rush and then all of asudden ad comes in that kind of likechallenges your worldview right you knowthat's not what my parents told me andyou freaked out right so this is like anad quality block list violation rightthese are just things we're like theperson who runs this game this mobilegame probably didn't want that to comethrough and maybe even if they indicatedthat it still came through our solutionas JavaScript engineers is to buildfeedback loops right so we've we kind ofturned to another skill that we have asfront engineers which is like buildinguser interfaces and these are somepictures from one of our tool suitescalled it's called add protectionbasically we allow you know users toreport an ad that they think isinappropriate and then we aggregate youknow these complaints and from you knowaggregate results from large scalescanners that are actually trying torender these like on the server side andalso allow them to be forwarded topeople more on this side of the supplychain right so if they came from otherbuyers that we like as an exchange asopen X that we deal with we have a toolthat kind of lets us you know forwardthe information to the right party rightand so we're we're using our our UX andfront-endskills as JavaScript engineers to buildthese kinds of tools that createfeedback loops the second one is justwhich is like I take to mean just likegeneral low-quality things that adscause to happen sometimes so here's onewhere you know I was trying to click ona blog post and then you know before Icould click this ad came in and you knowno offense to the folks at SendGridthey're great but I didn't want to gothere right I wanted to go to the blogpost and this is like technicallyactually called PageRank it's when thepage is actually re-rendering itselfsome people call it reflow but you haveno control over the code that comesthrough as part of this arbitrary addmarkup right and so it makes the page doweird things sometimes large files Ican't even like bear to look at this allright but no one's gonna keep you frommaking your your ad image like megabytes and so here's another one HTTPrequest party right what if you justwhat if your add markup comes in andjust has tons of requests and this isactually from a tool that we built it'scalled add footprint it's a chrome devtools extension you can download it onthe chrome store and it kind of breaksthings up by what types of requests areactually happening on a page it's kindof like lighthouse for AdTech we breakit up into content and then add requestsso there's initial requests that aregoing out of the browser and then adslots like the requests that come fromstuff within that first level of iframesthat gets written out and this kind ofhas a problem right so we dig in go toad slots we categorize all the ad slotson the page and look this having problems right load so we click in there and we can seebasically there's lot probably don't need that many andthere's this one one by one jiff righthere that's taken almost half a secondto load so the solution to this problemof Jake eNOS I think aside from buildingtools that let you understand it is tomake performance repeatable right forpublishers and people building websitesin general what if we had something thatwould do all these thingsand if you've spoken to the folksoutside at the MP table this is actuallyjust shamelessly copied from theirwebsite right this this is what amp doesit kind of is a restricted way ofwriting HTML that includes someperformance guarantees and what's niceabout this is not only that it's kind ofrelegating ads away from the main threadand making your content great butthere's also like amp for ATS right soyou can start to specify your ads ampdocuments as well and this is reallycool I think we as a community like haverecently started thinking more aboutperformance a lot of the talks today andyesterday we're focused on performanceand if we kind of aggregate knowledgeinto open source projects like like ampwe're gonna make the web better andwe're gonna solve Jake eNOS even if itcomes from third parties the last one isshadiness right finger printing sofinger printing looks kind of benignit's this is from an open-source versionof a finger printer from three years agoit's basically collecting a bunch ofrandom things about what's happening inthe browser and creating a unique stringout of them so what's the big deal aboutthat well basically there's enough likekind of entropy in all the differentsettings and things in in a browser thatyou can kind of mash them together andcreate a consistent unique ID for thatenvironmentaka user and basically if third-partycookies are turned off you canconsistently identify the user that'skind of shady right if user doesn't wantto be tracked you shouldn't be trackingthem but this stuff comes through rightit adds sometimes force redirects areone that's kind of been taken theindustry by storm last couple yearsyou're on a mobile site and thensuddenly you're in the App Storeright and there's not really much youcan do about it and this is because anad came through that you know kind ofexploited some some holes in the browserand was able to open the app store andtry and get you to download somethingthat you didn't want here's one that'stop of mind all right so on January of this year the number of coin hiveminers went up percent all the sudden right and whatwas happening was that someone was ifusing the double-click ad server toinsert some web mining code into adsthat were going all over the Internetand you know getting free coins and thisis just an example of like what we callmalvert izing right it's people who wereactually doing nefarious things inabusing the fact that ad tech deliversarbitrary code our solution is to likebuild tools that not only render ads andsee what they look like and create thosefeedback loops but actually try tounderstand at a more of a semantic levelwhat's happening right like who calledwho and what did they actually do sothis comes from our data protectionsuite and it's showing you a diagram oflike basically tag calls right so thisis from the open XCOM web page home pageand there's like a Google tag managerthere's not gonna be a lot of ad techstuff here but you can kind of get thesense that like the Google tag managerwas called and then it loaded a fewother things right the Google Analyticsdynamic remarketing some various thingsand this gives us a sense like starts togive us a sense of like who's actuallydoing what on web pages and we've alsodone some work actually analyzing thecode that comes through and here we'veclassified a bunch of add tags thatrendered on a page and given themindexes as far as security data sharinguser tracking tag chaining by actuallylike looking at the code that theydeliver and trying to understand it andthis is something that kind of like onlyJavaScript engineers can do becausewe're the ones who understand whatJavaScript code looks like and somethingthat's really cool is that we'veimplemented a container that I that ifyou load tags through the container onyour page you can actually blockspecific behaviors that arbitrary codemay try to do so you can you canactually turn off you know HTML cookiewriting or reading local storage and anumber of other things you can justblock those behaviors if you want Ithink it's pretty cool so the last andquick part of my talk is just likesome thoughts about you know where'sthis going what can we as a JavaScriptcommunity do to make things betterhere's some here's some thoughts rightso this is from the the data protectiontool this is a particularly egregiousexample of just the spam enos of adsright so this is a homepage the tagchain diagram of a real you know widelyused newspaper website pixels that collect data do other thingsfrom a total of right this is like crazy this is likeway too much stuff another thought I sawthis on Twitter just a couple days agosome people taking advantage of a newfeature called HSTs which is meant tohelp you make secure calls more oftenand they exploited the fact that itstored some new information in thebrowser and they were using it to dofingerprinting and this person says Ihate how the web has devolved into a warbetween bad actors and advertising andengineers who are trying to push thestate of web tech forward so these theselast two pictures right they're justmeant to make us think okay so we cankind of be in this arms race againstpeople doing bad things and an arms raceagainst undesirable janky whoopsy kindof ads but where is the web goingbecause of all this right are we gettingto a place where it's kind of like thispicture which is an artist renditionfrom later on our saw that movie there's like adseverywhere right they're plastered allover buildings in every possible squareinch of available space and not onlythat they're like highly targeted to theperson walking down the street like thead starts talking to the guy right isthis the world that we kind of want tomove to right is this where all theeconomic pressure is forcing us I wantto suggest not and specifically I wantto bring to our attention this idea ofsomething called a native ad now it hasa pretty plain definition nativeadvertising is a type of advertisingmostly online that matches the form andfunction of the platform upon which itappears now here are a couple examplesof thingthat have been maybe mistaken for beingnative ads but they're not quite therefirst one is you know these kind of likefrom around the web boxes that we oftensee at the bottom of reading an articlewhere you're like oh that looksinteresting oh wait you're right that'snot from no the people who wrote thearticle that I just read so it's kind ofhiding some people call that native notreally it may look like the content anddo a good job of getting people to clickon it it's not just returning your adwith JSON so instead of returning markupand just rendering it how it comes it'syou know natives sometimes people thinkoh that's just you know JSON and thenyou need some actual code on the frontend to like parse it and do stuff withit native ads may involve JSON as aresponse night but not necessarily andthen there's this format that's comingaround where you're kind of scrollingthrough a page and then like all of asudden like it kind of slides open andthere's a video playing native is notjust camel flage that's rightor as it kind of jump out at you andscare you right so what is native doneand this is my last slide it's just apicture of three ads that I think couldbe considered native and helped us youknow see how we can get away from thatpossible dystopian future this is frommy blog right and I have a small blog Iwrite technical articles on it I run iton digitalocean servers and so I putthis like link on there and a coupleyears ago because digitalocean has likea referral program and now the blog ispaying for itself right and it I thinkit matches the form and function of thesite on which it it lives here's onefrom a publication called The Vergewhere I I'm pretty sure this is an adI'm not sure but duolingo can now teachyou how to speak Klingon and it's likeyou know it's got the same style and youknow colors and stuff and like you knowthat's interesting to me as the readerof the verge and so it matches the formand function and then last of all youknow Twitter is a great example rightbecause they're monetizing through thevery format that the the the platforwas famous for which is tweets right andI just saw this the other day I thoughtit was interesting you know that Unitedactually used a promoted tweet to tellpeople that they had a network outageand are working to get the system's backonline right that's that's pretty coolright because this indicates that theway that the platform was monetized hasnow become like a general purposemessaging and targeting platform and Ithink that's that's really cooland so just final thought is that nativeis hard because what works on my blogdoesn't work on the verge and doesn'twork on Twitter and vice versa right andso it requires the engineers you and Iwho actually work on these publicationsto do some hard thinking and have somehard conversations about how to makethese things viable businesses withoutyou know selling out four clicks rightand I think that we're all more thancapable of doing that and in the processmaking the internet a much better placeso thank you[Applause]you
YouTube URL: https://www.youtube.com/watch?v=Oz-87M6O3HY


