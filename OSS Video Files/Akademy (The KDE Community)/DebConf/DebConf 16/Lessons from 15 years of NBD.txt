Title: Lessons from 15 years of NBD
Publication date: 2017-12-05
Playlist: DebConf 16
Description: 
	by Wouter Verhelst

At: Debconf 16 video RSS feed
https://debconf16.debconf.org/
Room: Menzies 12
Scheduled start: 2016-07-04 16:40:00
Captions: 
	00:00:00,000 --> 00:00:07,649
oh there we are okay so um before we get

00:00:04,470 --> 00:00:10,019
started I'm going to have to apologize a

00:00:07,649 --> 00:00:13,410
little bit if you look on schedule it

00:00:10,019 --> 00:00:15,690
says that I'm going to speak about MPD

00:00:13,410 --> 00:00:18,810
and how and try to compare it against

00:00:15,690 --> 00:00:21,720
Debian which was the grand idea that I

00:00:18,810 --> 00:00:23,519
had when I submitted to talk but as I

00:00:21,720 --> 00:00:26,939
was writing up the slides I realized

00:00:23,519 --> 00:00:29,220
that I may have been a bit impossible to

00:00:26,939 --> 00:00:31,470
do that so I I think there's still

00:00:29,220 --> 00:00:33,090
something grease in there but the

00:00:31,470 --> 00:00:35,489
comparison against their business is not

00:00:33,090 --> 00:00:38,670
part of the talk because it really makes

00:00:35,489 --> 00:00:40,860
no sense the idea of this talk is to see

00:00:38,670 --> 00:00:42,989
I mean I've been maintaining in Bini for

00:00:40,860 --> 00:00:46,050
fifteen years now and I've made a few

00:00:42,989 --> 00:00:47,760
mistakes and I'm here to talk about

00:00:46,050 --> 00:00:49,410
those mistakes so that maybe you can

00:00:47,760 --> 00:00:52,620
avoid making the same mistakes

00:00:49,410 --> 00:00:55,949
that's essentially what this is about so

00:00:52,620 --> 00:00:59,300
um a little bit of history I became a

00:00:55,949 --> 00:01:02,609
Debian developer in February of 2001 and

00:00:59,300 --> 00:01:05,309
I'm not sure exactly when anymore it's

00:01:02,609 --> 00:01:09,090
gotten lost through history but at some

00:01:05,309 --> 00:01:12,030
point in March or April of 2013 year a

00:01:09,090 --> 00:01:14,659
friend gave me an old m60 a Macintosh

00:01:12,030 --> 00:01:16,890
which had a broken L Co for the

00:01:14,659 --> 00:01:19,860
processor in there which meant that if

00:01:16,890 --> 00:01:22,290
you try to do something with the FPU it

00:01:19,860 --> 00:01:25,470
would seg faults or bus error on you

00:01:22,290 --> 00:01:28,470
ferries quickly so couldn't really use

00:01:25,470 --> 00:01:31,140
it so the next month I bought me another

00:01:28,470 --> 00:01:35,430
m6 tak Mac which came with a hard disk

00:01:31,140 --> 00:01:40,049
of a whopping 80 megabytes 80 megabytes

00:01:35,430 --> 00:01:42,899
is not much not even in those days but I

00:01:40,049 --> 00:01:45,420
try to build something on that machine I

00:01:42,899 --> 00:01:47,610
did not have the the disk space to build

00:01:45,420 --> 00:01:50,640
anything so I tried doing with NFS at

00:01:47,610 --> 00:01:52,229
first and that failed so because of

00:01:50,640 --> 00:01:52,799
other technical issues that I won't get

00:01:52,229 --> 00:01:57,090
into right now

00:01:52,799 --> 00:01:59,369
and so in April of that year I mailed to

00:01:57,090 --> 00:02:01,469
the m6 economists saying hey I found

00:01:59,369 --> 00:02:03,390
this nice interesting thing called NBD

00:02:01,469 --> 00:02:05,159
and we thought it works because the

00:02:03,390 --> 00:02:09,330
issues that we had with NFS don't apply

00:02:05,159 --> 00:02:12,850
there I used it to do builds over a 10

00:02:09,330 --> 00:02:16,270
megabit network and it seemed to work

00:02:12,850 --> 00:02:19,060
and since I did this anyway I started

00:02:16,270 --> 00:02:24,510
uploading it into Debian and that was in

00:02:19,060 --> 00:02:24,510
June of 2001 now just over 15 years ago

00:02:26,250 --> 00:02:30,450
something we can learn from that already

00:02:28,300 --> 00:02:30,450
actually

00:02:30,959 --> 00:02:36,280
beware of the MCC keep max you but guess

00:02:34,540 --> 00:02:36,760
nobody here is gonna buy an MCC kmac

00:02:36,280 --> 00:02:41,230
anymore

00:02:36,760 --> 00:02:44,080
let me rephrase that if it wants to do

00:02:41,230 --> 00:02:45,820
that be careful what you play with you

00:02:44,080 --> 00:02:48,459
might end up maintaining a network

00:02:45,820 --> 00:02:50,920
storage system probably not also

00:02:48,459 --> 00:02:52,300
something is going to be broken actually

00:02:50,920 --> 00:02:53,560
there are other network storage systems

00:02:52,300 --> 00:02:56,200
and beliefs not the only one there

00:02:53,560 --> 00:02:58,000
things like I scusi in at over Ethernet

00:02:56,200 --> 00:02:58,680
but I don't think people here will be

00:02:58,000 --> 00:03:01,330
interested

00:02:58,680 --> 00:03:03,850
the real lesson from to take home from

00:03:01,330 --> 00:03:06,760
this is that if you just play with

00:03:03,850 --> 00:03:08,920
something even if you think it's not

00:03:06,760 --> 00:03:12,100
useful at this time it's actually a good

00:03:08,920 --> 00:03:14,200
way to figure out new things to put in

00:03:12,100 --> 00:03:17,049
the Debian I do think that by

00:03:14,200 --> 00:03:19,030
maintaining MBD and by adding support to

00:03:17,049 --> 00:03:22,299
several things i've improved their beam

00:03:19,030 --> 00:03:24,940
in some ways and wouldn't have been the

00:03:22,299 --> 00:03:29,709
case had I not bought that 68k Mac so

00:03:24,940 --> 00:03:32,739
many years ago anyway something else

00:03:29,709 --> 00:03:35,200
when I started MBD it was totally

00:03:32,739 --> 00:03:36,970
undocumented there were some lines in

00:03:35,200 --> 00:03:38,620
the kernel source code showing you how

00:03:36,970 --> 00:03:41,340
to run it but that was pretty much it

00:03:38,620 --> 00:03:45,040
the code was not commented there were no

00:03:41,340 --> 00:03:49,420
man pages they were new really was

00:03:45,040 --> 00:03:51,190
nothing um so I worked this I got from a

00:03:49,420 --> 00:03:51,760
good history because it would it was way

00:03:51,190 --> 00:03:55,090
too long

00:03:51,760 --> 00:03:56,680
in October of 2005 I added some oxygen

00:03:55,090 --> 00:04:00,280
comments so I could at least understand

00:03:56,680 --> 00:04:03,549
the code this was by at that time I had

00:04:00,280 --> 00:04:05,920
taken over upstream maintenance in about

00:04:03,549 --> 00:04:08,049
a month later I described the protocol

00:04:05,920 --> 00:04:10,860
and asked somebody to write an e3 of

00:04:08,049 --> 00:04:15,160
this sector for me which happened

00:04:10,860 --> 00:04:17,140
several years later I wrote I converted

00:04:15,160 --> 00:04:23,240
that blog post into something that I

00:04:17,140 --> 00:04:26,300
could add into the coach upholstery and

00:04:23,240 --> 00:04:27,830
about a month later for the very first

00:04:26,300 --> 00:04:31,009
time somebody started actually

00:04:27,830 --> 00:04:32,330
contributing MPD before that I've had

00:04:31,009 --> 00:04:34,880
like people sending me one or two

00:04:32,330 --> 00:04:37,430
batches and then never reappear but

00:04:34,880 --> 00:04:39,620
after I added this to the code

00:04:37,430 --> 00:04:42,289
repository somebody actually started

00:04:39,620 --> 00:04:44,030
contributing yes

00:04:42,289 --> 00:04:46,039
a significant amount of code I think he

00:04:44,030 --> 00:04:47,330
made it like 50 or 60 patches in the

00:04:46,039 --> 00:04:52,479
course over the course of a few months

00:04:47,330 --> 00:04:52,479
so that was actually a welcome change

00:04:53,919 --> 00:04:58,699
two years ago we ran up a start TLS spec

00:04:57,199 --> 00:05:02,120
based on the documentation that was

00:04:58,699 --> 00:05:04,849
there etc and yeah insane since since

00:05:02,120 --> 00:05:08,660
then we've actually had more commits

00:05:04,849 --> 00:05:10,820
related to that particular document than

00:05:08,660 --> 00:05:14,120
to the actual implementation of the mvd

00:05:10,820 --> 00:05:17,509
protocol itself so what can we take home

00:05:14,120 --> 00:05:19,639
from that you could take home that

00:05:17,509 --> 00:05:21,889
writing documentation is way too hard so

00:05:19,639 --> 00:05:24,530
you shouldn't do that but I don't think

00:05:21,889 --> 00:05:26,659
that's the right lesson you could take

00:05:24,530 --> 00:05:29,599
home that writing documentation takes

00:05:26,659 --> 00:05:32,030
time it took me 15 years to do it

00:05:29,599 --> 00:05:37,310
properly but I also don't think that's

00:05:32,030 --> 00:05:39,590
the right thing to take home you could

00:05:37,310 --> 00:05:42,380
take home that writing documentation

00:05:39,590 --> 00:05:44,960
takes time away from other things and I

00:05:42,380 --> 00:05:46,400
think if you look at people in Debian

00:05:44,960 --> 00:05:48,409
and outside Debian open-source in

00:05:46,400 --> 00:05:50,120
general they like to write code but

00:05:48,409 --> 00:05:53,060
documentation is this other thing that

00:05:50,120 --> 00:05:54,560
doesn't really happen and somebody else

00:05:53,060 --> 00:05:58,039
will have to do it because I just do the

00:05:54,560 --> 00:05:59,360
code you could take that home from from

00:05:58,039 --> 00:06:03,740
this as well but I don't think that's

00:05:59,360 --> 00:06:05,719
the right thing to take home from it if

00:06:03,740 --> 00:06:07,699
you write documentation people will send

00:06:05,719 --> 00:06:10,430
you punches it only to the documentation

00:06:07,699 --> 00:06:12,020
but often also to the code if the code

00:06:10,430 --> 00:06:14,330
is properly document dated documented

00:06:12,020 --> 00:06:15,949
and so you could say I don't want to

00:06:14,330 --> 00:06:18,259
have patches so let's not do that but I

00:06:15,949 --> 00:06:20,210
don't think that's the right attitude

00:06:18,259 --> 00:06:22,550
in an open source or free software world

00:06:20,210 --> 00:06:24,800
I think the right thing to take home

00:06:22,550 --> 00:06:26,990
from this is that documentation actually

00:06:24,800 --> 00:06:28,849
allows people to understand your code

00:06:26,990 --> 00:06:31,039
and understand how everything works and

00:06:28,849 --> 00:06:31,789
by writing documentation you make it

00:06:31,039 --> 00:06:34,270
possible

00:06:31,789 --> 00:06:36,830
easy or even possible for them to

00:06:34,270 --> 00:06:38,210
understand and help you out so

00:06:36,830 --> 00:06:42,700
doing that may actually be more

00:06:38,210 --> 00:06:42,700
important than actually writing the code

00:06:43,150 --> 00:06:46,540
right um

00:06:46,810 --> 00:06:51,200
naming things the original version of

00:06:49,370 --> 00:06:54,830
the protocol did not have any way to

00:06:51,200 --> 00:06:56,450
negotiate certain things I mean the

00:06:54,830 --> 00:06:57,920
server just sent some data to the client

00:06:56,450 --> 00:07:00,320
and then the clients could either accept

00:06:57,920 --> 00:07:04,190
that or disconnect and try again with

00:07:00,320 --> 00:07:06,950
something else which was difficult so in

00:07:04,190 --> 00:07:10,010
2010 this was during DEFCON quite a way

00:07:06,950 --> 00:07:12,620
I decided that it that enough was enough

00:07:10,010 --> 00:07:15,560
and I just created an incompatible

00:07:12,620 --> 00:07:20,060
change between two protocols between the

00:07:15,560 --> 00:07:22,520
two protocol versions while I was doing

00:07:20,060 --> 00:07:24,680
that I formed a formally referred to

00:07:22,520 --> 00:07:26,330
this as the new style of negotiating and

00:07:24,680 --> 00:07:30,410
the other one has the old style of

00:07:26,330 --> 00:07:31,940
negotiating and then later of that year

00:07:30,410 --> 00:07:34,190
we found that there was a little bug in

00:07:31,940 --> 00:07:37,520
the new style and we then refer to the

00:07:34,190 --> 00:07:39,770
fix as the fixed new style this was

00:07:37,520 --> 00:07:42,040
originally informally but over the years

00:07:39,770 --> 00:07:45,710
actually they have now become the

00:07:42,040 --> 00:07:48,650
official names there's a fixed new style

00:07:45,710 --> 00:07:51,890
version of the protocol which is weird

00:07:48,650 --> 00:07:54,290
because it's already 6 years old it's a

00:07:51,890 --> 00:07:58,130
bit annoying because it's difficult for

00:07:54,290 --> 00:07:59,960
me to change it now and if I'd known

00:07:58,130 --> 00:08:02,060
that 6 years ago I probably wouldn't

00:07:59,960 --> 00:08:04,160
have made that mistake so what do we

00:08:02,060 --> 00:08:06,560
take home from that um be careful what

00:08:04,160 --> 00:08:08,270
you name things because you're gonna

00:08:06,560 --> 00:08:11,030
start with it you're gonna be stuck with

00:08:08,270 --> 00:08:13,310
it and it's if it's a stupid name like I

00:08:11,030 --> 00:08:15,590
did it's gonna be very annoying and

00:08:13,310 --> 00:08:17,390
embarrassing and you're not gonna be

00:08:15,590 --> 00:08:20,780
able to change it easily

00:08:17,390 --> 00:08:22,430
I tried but yeah too late now so having

00:08:20,780 --> 00:08:29,960
a good name is usually a good thing to

00:08:22,430 --> 00:08:33,380
do right um like I said the old side

00:08:29,960 --> 00:08:36,590
protocol also had a few issues so I

00:08:33,380 --> 00:08:40,190
create a new cell one the intent was

00:08:36,590 --> 00:08:43,460
always that I would eventually duplicate

00:08:40,190 --> 00:08:46,310
and disable the old side protocol when

00:08:43,460 --> 00:08:50,450
there would not be any clients in the

00:08:46,310 --> 00:08:52,430
world anymore after six year

00:08:50,450 --> 00:08:54,620
of new-style I thought the time was

00:08:52,430 --> 00:08:57,410
ready especially when a bug it was

00:08:54,620 --> 00:08:59,000
introduced that only existed because of

00:08:57,410 --> 00:09:01,790
the combination between old cell and new

00:08:59,000 --> 00:09:03,500
cell so I just dropped it from the

00:09:01,790 --> 00:09:05,480
implementation and at that point I found

00:09:03,500 --> 00:09:06,800
that many third party implementations of

00:09:05,480 --> 00:09:08,180
the mvd protocol we're really still

00:09:06,800 --> 00:09:10,310
using the old site protocol and

00:09:08,180 --> 00:09:15,470
depending on it and we're not ready to

00:09:10,310 --> 00:09:17,480
move to new style yet so I probably

00:09:15,470 --> 00:09:19,220
should have planned that better there

00:09:17,480 --> 00:09:21,920
were some issues that I could have

00:09:19,220 --> 00:09:23,840
avoided most of the issues that exist

00:09:21,920 --> 00:09:26,270
have me fixed now the implementations

00:09:23,840 --> 00:09:28,070
have been updated but I should not have

00:09:26,270 --> 00:09:31,700
probably probably should not have done

00:09:28,070 --> 00:09:32,870
so so that's something I learned I mean

00:09:31,700 --> 00:09:35,870
if you're going to duplicate something

00:09:32,870 --> 00:09:38,060
it's best to be explicit about it make a

00:09:35,870 --> 00:09:40,670
plan for the duplication publish that

00:09:38,060 --> 00:09:43,160
plan let people know that from that time

00:09:40,670 --> 00:09:44,590
on they will not be able to use the all

00:09:43,160 --> 00:09:47,690
three interfaces anymore

00:09:44,590 --> 00:09:49,820
and don't wait six years with it six

00:09:47,690 --> 00:09:51,050
years is way too long for something to

00:09:49,820 --> 00:09:52,490
be duplicated because people will

00:09:51,050 --> 00:09:54,050
eventually think that it's not actually

00:09:52,490 --> 00:09:57,530
duplicated because it's been there for

00:09:54,050 --> 00:10:00,170
so many years anyway right arm make it

00:09:57,530 --> 00:10:02,560
clear in a documentation in the code in

00:10:00,170 --> 00:10:04,850
the comments in you're not sick in

00:10:02,560 --> 00:10:06,740
wherever you can announce it that you

00:10:04,850 --> 00:10:09,670
might want to duplicate it while

00:10:06,740 --> 00:10:12,020
duplicate it because you or if you've

00:10:09,670 --> 00:10:13,850
one final thing you might want to

00:10:12,020 --> 00:10:15,680
consider is well do you really need to

00:10:13,850 --> 00:10:19,720
duplicate it I think in this case was

00:10:15,680 --> 00:10:19,720
necessary but maybe it's not right

00:10:20,140 --> 00:10:26,810
security issues I've had my share of the

00:10:23,210 --> 00:10:28,160
years in fact the second one and the

00:10:26,810 --> 00:10:29,750
first one were really the same thing

00:10:28,160 --> 00:10:32,060
because the first one was fixed on the

00:10:29,750 --> 00:10:33,440
master branch sorry it was fixed on the

00:10:32,060 --> 00:10:36,170
release branch and I forgot the master

00:10:33,440 --> 00:10:39,170
branch and then six years later somebody

00:10:36,170 --> 00:10:41,480
said yes six years later Ian Jackson

00:10:39,170 --> 00:10:42,950
told me and IRC I found this weird issue

00:10:41,480 --> 00:10:44,660
and I don't know but sometimes it

00:10:42,950 --> 00:10:47,750
crashes and I go oh oops

00:10:44,660 --> 00:10:49,190
and it turned out that I forgot to merge

00:10:47,750 --> 00:10:51,710
the commits to the master branch and

00:10:49,190 --> 00:10:55,370
yeah well then there's a second CVA

00:10:51,710 --> 00:10:57,830
there and then in 2013 we had one and

00:10:55,370 --> 00:10:59,750
then 2015 we had two but one of them

00:10:57,830 --> 00:11:01,430
actually was already fixed in 2013

00:10:59,750 --> 00:11:03,440
without realizing that it was a security

00:11:01,430 --> 00:11:06,740
issue so they had assigned one

00:11:03,440 --> 00:11:09,950
a security number from 2013 back in 2015

00:11:06,740 --> 00:11:12,520
which is a bit weird but anyway it

00:11:09,950 --> 00:11:15,350
happens I mean if you ride a server

00:11:12,520 --> 00:11:17,870
security issues will probably happen

00:11:15,350 --> 00:11:18,230
there's nothing essentially wrong with

00:11:17,870 --> 00:11:20,410
that

00:11:18,230 --> 00:11:24,620
and there's nothing to be ashamed about

00:11:20,410 --> 00:11:27,290
security issues and just be prepared for

00:11:24,620 --> 00:11:29,420
it and make sure that you know how

00:11:27,290 --> 00:11:31,310
everything works the first time I had to

00:11:29,420 --> 00:11:33,410
deal with the security issue it took me

00:11:31,310 --> 00:11:36,110
about three or four weeks before I could

00:11:33,410 --> 00:11:39,830
get it fixed by the time we got to the

00:11:36,110 --> 00:11:41,180
final one it was a bit quicker so this

00:11:39,830 --> 00:11:43,250
is something you might want to be

00:11:41,180 --> 00:11:45,890
prepared for I mean better to be

00:11:43,250 --> 00:11:48,230
prepared for the worst right it's better

00:11:45,890 --> 00:11:53,330
to avoid security if you can but well

00:11:48,230 --> 00:11:56,570
they happen of course like I said it's

00:11:53,330 --> 00:11:58,460
better to avoid them usually by doing

00:11:56,570 --> 00:12:01,130
proper design for that it's fairly easy

00:11:58,460 --> 00:12:03,050
bill to do that oh and don't forget to

00:12:01,130 --> 00:12:08,440
fix all branches like I might have

00:12:03,050 --> 00:12:11,090
forgotten we're almost at the end now

00:12:08,440 --> 00:12:14,990
there's a few there be a specific and

00:12:11,090 --> 00:12:17,870
Bini features that I implemented I wrote

00:12:14,990 --> 00:12:20,480
some def configuration for the client

00:12:17,870 --> 00:12:22,760
and the server and when I was doing the

00:12:20,480 --> 00:12:25,900
system D and BD unit the other day I

00:12:22,760 --> 00:12:29,180
found out that the client version of the

00:12:25,900 --> 00:12:30,830
Deb conf configuration was so broken

00:12:29,180 --> 00:12:33,860
that it must not have been used for like

00:12:30,830 --> 00:12:35,420
five years or something because it could

00:12:33,860 --> 00:12:37,910
not possibly generate a file it's

00:12:35,420 --> 00:12:42,070
configuration file so I threw that out

00:12:37,910 --> 00:12:44,420
because obviously nobody was using it I

00:12:42,070 --> 00:12:48,500
added installer supports and a system

00:12:44,420 --> 00:12:50,089
the MBD unit and an init scripts some of

00:12:48,500 --> 00:12:52,850
these features were interesting but I'm

00:12:50,089 --> 00:12:54,650
starting to be convinced that that conf

00:12:52,850 --> 00:12:58,420
is not as useful as I once thought it

00:12:54,650 --> 00:13:01,100
was but maybe some people disagree I

00:12:58,420 --> 00:13:05,360
think that's what I had planned for

00:13:01,100 --> 00:13:07,430
today yeah I still have some time for

00:13:05,360 --> 00:13:10,780
questions if people have any but other

00:13:07,430 --> 00:13:10,780
than that I think we're done

00:13:11,830 --> 00:13:17,000
no questions yeah I'm gonna have to

00:13:15,080 --> 00:13:19,400
question oh good thank you you were

00:13:17,000 --> 00:13:22,520
talking about deprecation aren't you

00:13:19,400 --> 00:13:25,280
left it in bits in for six years yeah

00:13:22,520 --> 00:13:28,430
that's what the third release cycle of

00:13:25,280 --> 00:13:29,870
Debian so you know the first one you

00:13:28,430 --> 00:13:30,440
announced it the second would you leave

00:13:29,870 --> 00:13:31,910
it then

00:13:30,440 --> 00:13:37,360
and on the third you've deletes it

00:13:31,910 --> 00:13:39,970
that's about right isn't it possibly

00:13:37,360 --> 00:13:43,000
this is of course an upstream

00:13:39,970 --> 00:13:46,490
deprecation that I'm talking about also

00:13:43,000 --> 00:13:48,110
the way I deprecated was I just added

00:13:46,490 --> 00:13:51,350
the warning this is now deprecated and

00:13:48,110 --> 00:13:52,700
when I threw it out it was almost an

00:13:51,350 --> 00:13:56,320
overnight decision and that might have

00:13:52,700 --> 00:13:59,660
made a mistake but yeah

00:13:56,320 --> 00:14:02,630
timing wise it's probably okay

00:13:59,660 --> 00:14:04,670
but planning it and announcing it and

00:14:02,630 --> 00:14:08,090
sticking to the plan might have been a

00:14:04,670 --> 00:14:09,560
better idea yeah I mean the biggest

00:14:08,090 --> 00:14:13,930
favor and we see it on some of the

00:14:09,560 --> 00:14:16,940
faster-moving projects is there nounce

00:14:13,930 --> 00:14:20,960
something they defecate it they drop it

00:14:16,940 --> 00:14:21,470
and it's gone in more mealy cycle of a

00:14:20,960 --> 00:14:24,580
distribution

00:14:21,470 --> 00:14:30,530
yeah and that might be a bit too quick

00:14:24,580 --> 00:14:32,120
all the questions okay

00:14:30,530 --> 00:14:33,920
I haven't at least it was very

00:14:32,120 --> 00:14:36,640
interesting or it was very boring I hope

00:14:33,920 --> 00:14:39,880
the first thank you very much down and

00:14:36,640 --> 00:14:39,880

YouTube URL: https://www.youtube.com/watch?v=T64fXAnGZYk


