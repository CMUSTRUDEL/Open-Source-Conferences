Title: Berlin Buzzwords 2015: Toke Eskildsen - Solr Sparse Faceting #bbuzz
Publication date: 2015-06-03
Playlist: Berlin Buzzwords 2015 #bbuzz
Description: 
	netarchive.dk maintains a historical archive of Danish net resources. We are indexing its 500TB of raw data into Solr. One of the requirements is to provide faceting on several fields, the largest having billions of unique String values. Stock Solr is not capable of doing that with satisfiable performance on our hardware. Inspection of Solr's core faceting code has led to multiple performance improvements for high cardinality faceting.

- Less memory overhead, using packed counters
- Less garbage collection, reusing counters
- Better performance for small result sets, using sparse counters
- Better performance overall with distribution, rewriting fine-counting logic

Performance gains relative to stock Solr varies with result size. A rule of thumb is 2x for single shard indexes and 4x for multi shard. The principles behind the improvements will be presented and their influence on the faceting performance curve will be discussed and visualized with data from tests and production systems.

Read more:
https://2015.berlinbuzzwords.de/session/solr-sparse-faceting

About Toke Eskildsen:
https://2015.berlinbuzzwords.de/users/toke-eskildsen

Website: https://berlinbuzzwords.de/
Twitter: https://twitter.com/berlinbuzzwords
LinkedIn: https://www.linkedin.com/showcase/berlin-buzzwords/ 
Reddit: https://www.reddit.com/r/berlinbuzzwords/
Captions: 
	                              I                               hello thank you for coming applause                               already                               it's actually solar sparse faceting but                               sorry in before we start I like to                               inform you how this will play out so the                               funny things are in the end of this                               presentation I come from the press enter                               the state and university library and                                you're thinking what does a library do                                with data well the point is that the                                part of a job is harvesting the Danish                                internet if four times a year so we                                accumulate a lot of data and of course                                we stole them and recently we were                                allowed to try and index them so the                                researchers they could actually find                                some data and we don't have a lot of                                hardware a big budget for it so we                                bought the cheap machines relative to                                what we could get out from them and we                                crammed a lot of data down in them fair                                enough it works fine Solar solar works                                with this without a problem except that                                the researchers actually wanted to use                                more than just plain search for the data                                they wanted to pass it on them problem                                is as soon as you start faceting on high                                Cardinals it feels in solar well whoops                                those charged slide switch the bill have                                been reversed and we get response times                                which are less than ideal now this graph                                and I had to explain at the x axis we                                have the results set the numbers of hits                                in the result set and on the y-axis we                                have response times in milliseconds this                                is just for a single shot on our machine                                and it was performed on a field that is                                called URL from a harvested web search                                it website web resources which is                                basically just the address of the                                resource we have                                                      in a single chart and well this is what                                happens                                so I like to go back to this life I just                                skipped over and say what is it that                                happens when you facet well faceting and                                so r is for four strings is really                                extremely simple it only has three                                phases at least with one shot we                                allocate a counter that's the first line                                then it run through all the results are                                all the documents in our results and                                extracts references to the terms in the                                facet that are in the results and we                                increment the counters which will give                                us a counter structure like the one to                                the right and we when we are finished                                incrementing all the counters from our                                result set well we extract the top                                                                                                           it's a simple thing but my leg works                                very well for a few million in values in                                this facet field as we can see we do                                have a bit of a problem with this                                    million Cardinals you think one of the                                problems is that such counter structures                                chat tend to be a fairly large so when                                we're doing this these requests these                                are by the way three threats that are                                hammering at the same time just to to                                stress it a bit what we have here on the                                blue line is memory usage and what we                                have down in the button is garbage                                collecting so in and the delight of pass                                at the bottom those are what you call it                                normal garbage collections and the                                darker ones are the full garbage                                collections which means a pause in the                                request so that influences the result a                                lot and I must say account for a lot of                                the fluctuations in the response times                                now I'm sure that somebody could tune                                the doc garbage collector a lot better                                than we can especially since we haven't                                tuned anything at all with just using                                the default one but the thought is why                                do garbage collecting at all                                well if you remember the old code there                                were three phases allocate a counter                                fill the counter extracted sub X result                                okay simple idea let's just allocate a                                counter from a pool fill it extract and                                then deliver it back to the pool and                                then reach you reuse it on the next call                                of course we need to clear the counter                                between the poles but it turns out                                that's a lot cheaper to do than                                reallocating it from the heap so what we                                 have here on the left is standard                                 behavior with the memory and the gaps                                 collectings and what we have here on the                                 right is the behavior of the garbage                                 collector after we have turned this                                 thing on still not perfect there are                                 some ugly spikes but we'll get to that                                 response times i know this is messy it                                 will be better so the blue stuff is                                 standard solar and the pink stuff is                                 well when we reuse the counters we                                 cannot make I can make cannot make head                                 or tail all this so if you used to                                 switch to this visualization instead                                 you'll see this more than once in this                                 presentation in each of these boxes we                                 have the quartiles so the top of the box                                 is the area if                                                         be served below this amount of time and                                 as we can see the blue boxes again is                                 without reuse of the counters and the                                 pink boxes are will reuse we get in a                                 better as smaller spread and the                                 response times and the median this is                                 the black line is moving downwards so it                                 seems to help now there's a slight                                 interesting thing about this because if                                 we look at the response time with the                                 minimum at the very bottom of these                                 candlesticks it starts at five hundred                                 milliseconds even for the very small                                 result sets so why's that well the point                                 is in our third part                                 which repeats allocate counter or we use                                 a counter update the counter then                                 extract the topix results we actually                                 its rate all the counters to the right                                 to extract the top                                                     if we had                                                             next step we want to do is say well if                                 we knew which counters were updated we                                 could only count those when we needed to                                 extract the top                                                        making a tracker besides the counter we                                 have the tracker from the start it's                                 empty and we update one counter that was                                 count of three in this case good what we                                 do here is say okay count of three it's                                 updated we'll just put three in the                                 tracker so now we know condo three is                                 updated we do another update that's kind                                 of one and the count and the tracker                                 says now we know counter one is updated                                 it's quite a simple principle we update                                 the count of three once again but hey it                                 was already updated so we don't need to                                 update the tracker and we go on when you                                 have finished this in collected collect                                 all the counts face we now have tracker                                 which this gives us exactly the the                                 counters which has been updated and it                                 looks like this in the code the yellow                                 parts are the new parts of the codes                                 which changed from the previous one by                                 the way am i right we are very very                                 quickly exiting standard solar lent now                                 I won't go through code but as you can                                 see it doesn't take much to add this                                 counter method there's a core of course                                 it down side to counting it introduces                                 an extra step in updating the values                                 which has a speed penalty and in it                                 introduces a memory overhead which                                 depends on how large you want to count                                 we found out that about eight percent of                                 the the counter size works fine                                 for this tracker mechanism beyond that                                 there's really no win in it and the                                 speed penalty well again as long as the                                 count tracker is below a certain point                                 we win so this is a result the blue                                 stuff is when we do not do you this                                 sparse faceting which is all about the                                                                                                        pink stuff is when we turn on this pass                                 this looks like a hockey stick now the                                 good thing about this is that this area                                 oh I can't use this we have here down in                                 the middle where everything is good and                                 perfect and we have this area where                                 things sent to go thoughts for the very                                 last result sets luckily most clear is                                 tipped to be down in this very low area                                 well depending on your Corp will send                                 you search patterns and and all that so                                 we're happy we removed the garbage                                 problem or at least minimized it we got                                 the response times down so and this                                 works but in these days Solar is snow so                                 Lars alone practically it's all in solar                                 cloud what happens in the solar cloud                                 well there's an extra step to faceting                                 when when doing cloud searches we have a                                 face one it's exactly as a single shot                                 set up to the facet pole maybe ask for a                                 bit more more faces than the one you                                 request because well statistics and all                                 that but basically do a standard                                 physical then the calling note it gets                                 resolved back it merges them it extracts                                 it calculates to the top                                                use and then we have the list small                                 problem that we are not sure that we                                 have the right counts because some of                                 the shots might not have returned                                 account for the term that was in top                                    good so the simple thing is well the                                 merger says those charts that did not                                 deliver                                 a result for for the top one of the top                                                                                                        to recount them the way that is done in                                 vanilla solar we see in this code                                 section here so the code of course I'm                                 lying a bit but it's really simple we                                 just for each term that we need the fine                                 count from four in this yard we perform                                 an extremely simple search which is just                                 for the field with the term and then do                                 an intersection i think the word is with                                 the full results sets well it works but                                 it has a peculiar property excuse me see                                 now these are response times again this                                 time we switched to cloud mode we have                                 nine shots here and be quiet but on the                                 other hand just to scale it down scale                                 up in shots scale down in faceting I'll                                 feel now only has                                                       a domain field if in our index by the                                 way to the right we see this natural                                 well as the count goes up well the                                 response time goes up but what is                                 happening in the middle because our nice                                 response times which were down below                                    milliseconds well we have a lot of them                                 up in the seconds that's pure statistics                                 if you had nine shots that deliver                                 results and they have very small result                                 sets well chances are that each shot has                                 the live has returned less than the top                                                                                                   complete set of facets possible for this                                 result set in that case it won't be                                 asked again because the merchant knows                                 it has no more information that's over                                 here to the left when we have more more                                 hits well we have the opposite situation                                 the chances are that the top                                          from each shot will be the same and as                                 they have already delivered counter                                 that's that term there's no need to ask                                 and again so be happy here but in the                                 middle we have this                                 pit of pain which was coined by Angie                                 Jackson from the British Library which                                 unfortunately means that statistically                                 nearly every term needs to be fine                                 counted from nearly every shot and if                                 you have a top                                                           it's our uh no above                                                     need to add or this request have a lot                                 of these intersections so that's bad one                                 solution which actually works pretty                                 well is not to find count but for this                                 talk we are focusing on getting exact                                 results what if we made it more                                 efficient to find count because as we                                 remember faceting the first phase of                                 assessing was quite fast so we could                                 just repeat that and then as we have the                                 counts is rate each term one at the time                                 and just look it up in the counter                                 structure which we have now okay that                                 works that was a level one of this until                                 we realized that the actually we already                                 did the counting in phase one if you                                 just remember the results the the                                 counter structure from phase                                           counts are there so we just need to take                                 it from a pool and then get the counts                                 directly sounds efficient and this so by                                 doing this little trick looking up in                                 another way we are virtually eliminating                                 this pit of pain this this large hill in                                 the middle that was about it for                                 performance now we have a setup we had a                                                                                                      about the memory and the worst thing is                                 that URL is just one of our fields one                                 other field we really like is the links                                 outgoing links from webpage                                 which has                                                               shot and it's reused a lot so we have                                 about                                                           documents to these values now the number                                 of references doesn't really matter with                                 regard to memory I'm just mentioning to                                 get the complete picture but the                                 cardinality of of the terms certainly                                 matters as well as how many document a                                 single term can be hot belong to well we                                 still want to fast it on this if it's                                 possible because the researchers would                                 like to build nice graphs between web                                 pages in a quick and responsive manner                                 so and we don't want to to allocate a                                 lot of memory so maybe we could look at                                 that see if you try and explode such a                                 if what you call a FS facet fields we                                 have three examples in our corpus one                                 was the domain which is fairly low cut                                 in LC with the                                                      other one why do L with                                                 the third one will links with about                                     billions this view this histogram view                                 you can see it directly in the solar                                 admin front end I really recommend it it                                 says a lot what it says among other                                 things is that we have a lot of values                                 which you only count                                                   in the index only a single document has                                 them that's the one on the top what we                                 can also see I'm sorry I don't think                                 half of you can see that is that at                                 least four links well we have a few                                 values that are references referenced a                                 lot of places which is about by a lot I                                 mean two percent of the pages or                                 something like that I think it's a                                 google tracker thingy or something or                                 robots.txt arenal so how these are                                 represented well ideally in an ideal                                 world the Platonic ideal of a counter                                 well if we have at the bottom the                                 different terms at at the top we have                                 some bits needed to count them we can                                 see here that                                 a only requires one bit because there's                                 only one pace                                                           so we know there is a least what is that                                                                                                          points to it we can we know these maxima                                 because well it's an index we can just                                 analyze it but this ideal world has                                 little to do with reality know how its                                 represented in the classic vanilla solar                                 is simple we just allocate one integer                                 to count each term okay it's not a                                 problem with low cardinality because who                                 cares if it's no one megabyte or two                                 megabyte but when we're talking about a                                 cardinality of                                                     suddenly have a counter structure of                                 nearly eight hundred megabytes to make                                 matters worse we need one counter                                 structure for each concurrent requests                                 so well it all counts up first thing                                 with it it was pretty simple if you know                                 if we look at the structure to the left                                 this by the way goes to                                             about the slides to visualize the wasted                                 space in red well we can see that the                                 highest counter in this example only                                 takes                                                                 all the counters that's a waste of space                                 so simple enough we just use                                             the counters that's the maximum we will                                 need to count works fine if you look at                                 the statistics from our sample chart we                                 can see that the well for URL which is a                                 nice fit we get int down to half the                                 mirror usage which and for links we sell                                 is a better fit because we have very                                 high counter some some a few very high                                 counters we only get down to                                            of many memory usage so not really a                                 game changer so                                 that will come to the fun part because                                 as everything red is wasted let's try                                 and minimize that this is an idea that i                                 called in plain counting and glad of a                                 peasant better name it really in                                 principle is very simple and it doesn't                                 really work which we'll see later but we                                 need this as a building blocks for                                 lipstick next step what we have held                                 here in the button is simple the first                                 bits of all the counters that's plain                                 one if you look at the ideal or to the                                 left well every counter needs at least                                 one bit fine so we have them on the                                 right to now for all these counters that                                 needs more than one bit we keep track of                                 that by having a second an overflow                                 bitmap on top this is the blue line for                                 every slightly darker blue square we                                 have here that means that the counter it                                 belongs to continues on the upper Plains                                 okay this is something the blue                                 structures are static when we open an                                 index is we can construct them so how do                                 we use this well this is the same                                 illustration as before I'll try                                 incrementing a counter here in this case                                 counter l so first time counter Ellis                                 visits it we just set the pits at the                                 first plane simple enough now counter                                 LLS visits it again what happens is we                                 visit counter l ok it's said that means                                 we need to set the next bit higher up                                 well we can see that it overflows                                 hopefully it should because I will have                                 an error and we can't film the lift with                                 the blue pits that says                                                 go to plane to at entry                                                  know that L continues here so that was                                 simple and that means we know where to                                 set the bit number two because we                                 counted                                            count to three well then we just put                                 down in El and so on so forth so now we                                 can count to                                                         that way in the planes to make this work                                 we need to be really quick at counting                                 these overflow bits fortunately there's                                 a function called rank which with very                                 low overhead three percent of memory and                                 dust that in constant time so no worries                                 there the problem was that it did not                                 work because we use tracking you                                 remember the tracker is very simple if                                 the previous value of the counter was                                   update the tracker but how do we know                                 that the previous value of the counter                                 is                                                                       because with this setup when we have                                 counted to                                                              again we cannot see if this is                                   represents                                                              we read all the way up in the planes                                 which is dark slow what we do about that                                 well we introduce a plus one and one and                                 a half bit plain good you got it this                                 performance wise it will work i can i                                 can tell you in memory wise it has a                                 worst-case overhead of one bit per                                 counter which is what it is fortunately                                 as we remember most of our counters two                                 thirds and is in this when we're talking                                 about links were really only one bit and                                 all the one bit counters they take up                                 exactly as much space and then the                                 previous version of this structure so                                 it's really all the counters that are                                 above one that takes this one extra bit                                 hit so what you have in the bottom plane                                 is one that kids track of is the counter                                 one or more and above that you have the                                 standard counters that was confusing                                 fortunately we'll just do the same                                 example                                 okay we wizard counter ill we updated                                 once we set the bit we are happy to                                 update the tracker now we try and update                                 counter air again in this case we see oh                                 this bit is already said let's not touch                                 that instead we move up at once do the                                 counting thing and update the entry up                                 in the one-and-a-half bit plain so this                                 big pattern confusing at it may seem                                 actually represents the number                                         plus                                                                  one minus one so up here in plain two                                 three and four we have a standard a bit                                 representation by Nibiru system and in                                 the the bottom which simply has a flag                                 saying plus one so let's update it once                                 again we hit the the l we don't charge                                 that we go sorry in plain one we go to                                 plane to and see okay there's a set bit                                 we need to change that bit pattern                                    and this make is                                                        once again and once again and all that                                 absolutely we had swell well which is                                 represented in this funny way okay now                                 this is all well and good but it's a lot                                 of Hoops to rack up through so what does                                 it gives us well the point is it's quite                                 a massive space saving if we look to the                                 right and ce                                                           our poster child for this we get it down                                 to                                                                    million values as opposed to if we had                                 just used the integer counter in in                                 plain vanilla sola which would be above                                 two gigabytes okay there are more good                                 news as remember that the the blue stuff                                 the overflow bits they were actually                                 static they never changed so that really                                 means that if we need another counter                                 because we have multiple concurrent                                 requests we only need about half the                                 space so that means that in                                 slightly less than                                                       extra counters we can do the counting of                                 these six hundred million values okay                                 nice we save memory how hot does it hit                                 us performance-wise well here are three                                 comparisons the blue one is the integer                                 representation the purple one was the                                 maximum bit representation we use the                                 structure called pectins from France                                 Allah and the green one is the in-plane                                 representation and as we can see not                                 surprisingly there is an overhead with                                 with using the same plane representation                                 but on the other hand we can actually do                                 it in quite a little quad little                                 requiring memory so we have all these                                 nice stuff those nice things so and we                                 have this little trust our let's let's                                 try and combine it all see what happens                                 so we have these three fields domain URL                                 and links with this cardinality we also                                 have nine shots and in order to get                                 anything going with just hitting it with                                 free concurrent requests oh well the                                 problem is that what we have under the                                 y-axis is is actually moving in two                                 minutes no not on this chart but it                                 keeps going we have a worst case of I                                 don't know five ten minutes so that was                                 not so good on the other hand we can get                                 by with this faceting on this one of the                                 shots with                                                            for nine hundred gigabytes in of shots                                 with this so we now have two situations                                 we have fast for smaller cardinality by                                 which I mean below                                                    have memory saving for higher                                 cardinality and we can use that that's                                 not all there are tricks but                                 frankly I don't think I have the time to                                 go through them instead I think that I                                 will let's see say try this at all now                                 silence and blank stares any questions
YouTube URL: https://www.youtube.com/watch?v=gcwOh9z4tj4


