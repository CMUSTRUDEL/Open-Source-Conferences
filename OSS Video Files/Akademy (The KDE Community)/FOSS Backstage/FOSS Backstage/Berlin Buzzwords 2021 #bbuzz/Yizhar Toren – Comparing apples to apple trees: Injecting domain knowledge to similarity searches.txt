Title: Yizhar Toren – Comparing apples to apple trees: Injecting domain knowledge to similarity searches
Publication date: 2021-06-24
Playlist: Berlin Buzzwords 2021 #bbuzz
Description: 
	Image & text similarity problems have plenty of textbook ML solutions. However in the wild, these solutions often fail. In this talk I'll present a use-case about inferring product similarity from multiple sources of data (images, text, etc) and discuss how we developed a practical & scalable approach using our understanding of domain knowledge.

Speaker:
Yizhar "Izzy" Toren – https://2021.berlinbuzzwords.de/member/yizhar-toren

More: https://2021.berlinbuzzwords.de/session/comparing-apples-apple-trees-injecting-domain-knowledge-similarity-searches
Captions: 
	                              today i'll be talking to you about                               domain knowledge about similarity                               calculations how to combine them                               together and also how to                               integrate similarity from different                               sources in a hopefully a smart way                               so i'm not going to introduce myself too                               much you can find me                               on my webpage on twitter and linkedin                                and i don't think i need to introduce my                                employer too much especially after the                                last year                                shopify is basically an e-commerce giant                                powers a lot of businesses around the                                world it's a canadian company but                                there's a very strong presence here in                                berlin                                and since we are talking about                                e-commerce let's talk about products                                so can you tell me just by looking at                                these                                product images and you know the little                                descriptions um                                what makes all of these products                                essentially the same thing                                well it's it's pretty hard to tell we                                have this psychedelic giraffe here we                                have a lovely place in italy                                and a red umbrella in the middle of the                                street well                                if we start working on the data that we                                have so i don't know use some                                um you know out of the box and i'll pick                                it you can                                immediately find that there are some                                similarities in the descriptions                                although                                these descriptions again the case i was                                working on these are marketing texts                                not always even describe the product                                itself maybe more                                about the experience and branding um and                                if you want to work really really hard                                and process                                hundreds of millions of images through                                some deep network                                deep neural network um labeling effort                                you might be able to find some                                overlapping labels but                                this is not great and something like                                embedding                                just by looking at the images you can                                pretty much say that something like                                embedding without a lot of training                                um we're probably not going to work here                                so                                what is going to work well if you dig a                                little bit deeper so like i said these                                are the main product images                                all of these products have more than one                                image they have                                                                                                 somewhere                                and each one of these products somewhere                                in the background had a version                                of one of these two images so all of                                these are pink by number products                                became super successful in terms of                                sales when the quarantine started                                and are still doing really really well                                so all of these                                again just by looking at the image you                                can't really say what it is but if you                                dig a little bit deeper and look at                                other images of the product                                you might be able to find the links so                                what kind of use case am i describing                                here so                                we have an entity of interest this can                                be something like a product this can be                                something like a user                                or a patient if you look at medical uh                                records                                and each one of these entities has some                                data items that are connected to it                                so in terms of products we talk about                                something like product reviews                                product images you know in terms of                                patients case notes                                test results imaging etc etc and                                where the main knowledge again in this                                example comes into play                                is the fact that all of these items are                                somehow linked through                                the entity that we're interested in now                                what we don't have                                and this is important what we don't have                                for this case                                is a natural way to somehow align                                 or sort the items so if you think about                                 something like um                                 you know um stocks so you think about                                 prices over time there is a natural way                                 to align                                 prices over time for each stock and if                                 that was the case i would use something                                 like you know                                 time series clustering but here there is                                 no natural way to order things we                                 basically have to compare everything to                                 everything                                 or think about a way how do we calculate                                 similarity                                 on the item level and then aggregate it                                 in a meaningful                                 and also efficient and scalable way to                                 what we actually want to know which is                                 similarity between products or between                                 users or between patients                                 or whatever so what does                                 domain knowledge in our case looks like                                 like i said we know that products that                                 sorry that images                                 are connected to products and again i                                 can work really really hard to say that                                 two images                                 of you know um an iphone cover                                 and then a picture of a man speaking on                                 the phone                                 are related to the same product but i                                 know this already this is something that                                 our suppliers told me and if i see that                                 product a and product b                                 share an image again this doesn't have                                 to be a you know one-to-many                                 relationship                                 but sharing image and product b and                                 product c have two images that are                                 similar enough in a sense i can say you                                 know this is uh the transitive                                 property i can say that product a and                                 product c are                                 somehow similar again just to emphasize                                 i'm not saying they are the same thing                                 i can say that product a and product b                                 are                                    similar and product b and product c are                                                                    similar and therefore a and c are let's                                 say                                                                                                         maximum or the minimum or whatever                                 but in essence i want to make the link                                 between products and i can do it through                                 the images                                 and i can also augment the the                                 similarity                                 between the images through the products                                 so what would that look like in terms of                                 implementation                                 here a little bit of math apologies                                 um basically domain knowledge if                                 if i take the approach i like to call it                                 once and done we'll see why in a second                                 um if the approach is that again                                 products that are images that are linked                                 to a product represent the same thing                                 and if it's enough that two products                                 share a single image in order to make                                 them                                 linked or similar in my in my domain                                 then i can do something really really                                 simple i                                 all i need to do is take the image                                 similarity matrix that i pre-calculated                                 um i can add on top of that a block                                 matrix of ones basically                                 uh blocks for each for all the images                                 that are linked to the same product or                                 the same patient or the same user and do                                 some capping there are some things you                                 need to do here but essentially if i                                 take                                 overlay the the product links on top of                                 the image similarity                                 and then i can take this matrix and if i                                 run whatever clustering algorithm i want                                 to run                                 or extract connected components or                                 whatever what i will get is clusters of                                 images but then                                 all i need to do is extract the product                                 ids and i will have clusters of products                                 and because of the way that this works i                                 can guarantee that a product will always                                 fall in a single cluster                                 everything will behave nicely uh with in                                 a really nice way                                 and also kind of a side note the the                                 connections between the                                 the images that belong to the same                                 product don't have to be absolute they                                 can be weakened                                 i can i don't have to use one i can use                                 weaker links or                                 i can use whatever counts of how many                                 users viewed the same product or                                 something a little bit more                                 sophisticated but again i wanted to keep                                 it simple here                                 um but again this is a very strong                                 assumption that i use here that it's                                 enough that                                 two products share a single image on you                                 know                                 similar enough and that immediately                                 makes them kind of                                 uh stick together what we found is that                                 this was a little bit too sticky in a                                 sense                                 too much too many products that cluster                                 together when we use this kind of                                 approach                                 so what we did instead was to                                 build something a little bit more                                 sophisticated again                                 if you remember from whatever whichever                                 machine learning course you took a                                 similarity matrix is equivalent to a                                 similarity                                 graph so what you see here is images                                 each                                 node is an image i just colored for your                                 convenience all the images that belong                                 to the same product                                 sorry and the links between the images                                 represent the similarity                                 and what i want to do is basically take                                 all the images that belong to the same                                 product and somehow                                 squish them together right into a single                                 node and this is what                                 is happening on this graph it's called                                 um quoting graphs or graphs of minors                                 and then i need to decide okay i                                 squished all the images into the product                                 this is the entity i want to                                 analyze how do i decide how this product                                 relates to this product well in this                                 case i just took                                 the maximal similarity of all possible                                 pairs                                 now and then i get the new similarity                                 matrix and i can continue working                                 doing my analysis um i just said a very                                 uh dangerous words when you talk a                                 dangerous                                 a few words when you talk about scale                                 between all possible pairs                                 yeah this does not scale very nicely so                                 i've looked                                 we've looked through different                                 implementations i think the one                                 implementation i found that worked out                                 of the box kind of immediately is                                 network x and python                                 if you know of any other implementations                                 that work very nicely out of the box                                 please                                 reach out to me and let me know i'd be                                 super interested but that was the one                                 that kind of                                 looked the most promising but it                                 definitely doesn't scale very very well                                 so i took my um i did a little bit more                                 math and took my uh                                 software engineering skills and wrote                                 two packages uh one for python one for r                                 um and you can find them on on github                                 and feel free to explore them and use                                 them if you want                                 and there's also a paper because the                                 approach that i use                                 network x is built on graph i went back                                 to the similarity matrix                                 that it's really nice because you can                                 use sparse representations                                 um so immediately kind of the scale                                 problem                                 goes down at least one two orders of                                 magnitude                                 especially when you're as far as                                 problems if you do want to extend this                                 further                                 i'm also building something for                                 tensorflow so you can actually scale                                 this up in terms of the memory                                 representation into really really really                                 large uh similarity uh                                 structures but the trade-off is that                                 when you do this kind of matrix approach                                 you are limited to a specific class of                                 aggregation functions                                 i mentioned something like maximum                                 similarity total similarity                                 counting how many images pairs of images                                 crossed a                                 certain threshold it's a very wide class                                 of functions                                 um and there's a paper on my website if                                 you want to see why the mathematics                                 works and you want to convince yourself                                 or if you wanna                                 i'm trying to publish it now if you want                                 to collaborate uh feel free to reach out                                 again sorry for the                                 shameless promotion and now                                 once we have an efficient way scalable                                 way                                 to aggregate the similarity from the                                 image level                                 to the um to the product level                                 then we can start doing some really                                 interesting things because                                 now that we have this uh um this tool in                                 our hand                                 and we can start aggregating things in                                 an interesting way we don't have to                                 limit ourselves to                                 to limit ourselves to images we can go                                 to text we can go to everything else we                                 can train weights we can combine things                                 we might even want to go beyond products                                 think about instead of comparing trees                                 we can compare                                 orchids or forests there's a lot to be                                 done here                                 um and again thank you for uh listening                                 um i have to mention we're hiring like i                                 said a global company and fully remote                                 so                                 feel free to browse the website if you                                 find anything interesting um                                 please mention me to the recruiters and                                 feel free to reach out to me on                                 twitter on my website and again thank                                 you for your time                                 you
YouTube URL: https://www.youtube.com/watch?v=Rn3rBzNpHmo


