Title: Houston Putman & Timothy Potter – Demystifying the Solr Operator
Publication date: 2021-07-01
Playlist: Berlin Buzzwords 2021 #bbuzz
Description: 
	Are you or your company migrating services to Kubernetes? Do you want to run everything there, even Solr? If so you might have a lot of questions on how to proceed. Houston and Tim intend to help clear things up a bit. 

This is a conversation about managing Solr on Kubernetes. Houston and Tim will be discussing the newly donated Apache Solr Operator, and how it fits into your Solr Management workflow on Kube. Specifically what aspects it has control over, and which aspects it does not. Covering all possible migration scenarios would be impossible, so the focus will be on explaining the architecture principles of the Solr Operator and defining the roles of each piece of the system.  

Hopefully, everyone will leave the discussion confident that they can answer the following questions:

- Who is in charge of what?
- Kubernetes?
- Solr Operator?
- Solr?
- Me???
- What happens when one part of the system goes down?
- Why should I, or should I not, use the Solr Operator?

Speaker: 
Houston Putman – https://2021.berlinbuzzwords.de/member/houston-putman-0
Timothy Potter – https://2021.berlinbuzzwords.de/member/timothy-potter
Captions: 
	                              yeah thank you                               for joining our discussion today we hope                               it'll be a good one and sort of to keep                               just the introductions brief houston and                               i work together at apple                               sort of where we advise various teams                               on deploying and scaling solar                               on kubernetes we're also both pmc                               members                                and try to actively contribute to the                                project                                and uh houston is actually the original                                creator of the solar operator                                so with that houston uh could you you                                know give us a brief introduction of                                what the operator is and the the                                problems                                is trying to solve yeah of course                                um so just to give a brief overview um                                you can look at the link at the bottom                                to see one of my previous                                uh conference presentations about kind                                of the introduction of the solar                                operator                                but just for lunch little introduction                                for those who might not be as familiar                                solar operator is basically a i mean if                                you've heard of kubrick's operators                                before                                it is a management tool for managing                                solar resources                                on kubernetes so this includes multiple                                types of researches                                like the solar cloud the solar                                prometheus exporter                                and for now solar backups uh and                                basically                                without any details what it does is                                abstracts the way                                uh extracts away the need for the user                                to have a lot of kubernetes knowledge                                and so a lot of the knowledge that is                                kind of necessary for running solar and                                kubernetes is built into the operator                                and we're able to provide a very easy                                solar kind of um dsl in front of it so                                that you can say i want a solar with                                these type of properties                                give it to kubernetes and the solar                                operator will go and manage that for you                                okay great um so let's dive into the                                discussion                                uh and you know                                before we get too far into the weeds on                                the on the solar operator                                you know i i think our our listeners                                here would like to just                                understand you know why might somebody                                want to run solar on kubernetes                                i mean that's a really good question so                                obviously                                i'm sure there's no one here that hasn't                                heard about                                their organization or an organization                                that they know about that is making a                                massive switch to kubernetes                                uh be it on like gke eks                                azure any of these type of platforms and                                so                                i guess i'm not going to answer why                                someone would move their entire                                organization there but                                for solar at least um it's a pretty                                good selling point it's like you want to                                be able to                                deploy solar like you deploy everything                                else your company                                so that your sres or the people who are                                actually managing these deployments                                don't need                                really special really kind of                                deep knowledge of how solar works the                                household deployments work                                and so if we're able to kind of                                standardize things and                                kubernetes is just a general way of                                standardizing deployments if we're able                                to kind of                                allow you to deploy solar in the                                standardized way                                it makes it a lot easier for you to                                kind of transfer transfer the um                                knowledge to these people on how to run                                these things and so                                um what you'll be able to have like one                                team running all of your things which is                                kind of nice and also uh it allows you                                to                                separate out your concerns and so one of                                 the reasons                                 why people and we'll get into this more                                 later but                                 one of the reasons why people run                                 massive solar clouds is that                                 it's kind of messy to run all these                                 little tiny solar                                 clouds independent of each other and so                                 on kubernetes we're allow we're able to                                 kind of scale up                                 these small solar clouds not in terms of                                 vertical scaling but horizontal scaling                                 and so it's a lot easier to manage many                                 solar clouds                                 and so you're able to kind of separate                                 your concerns                                 and have smaller more independent solar                                 clouds that are                                 safer because they're not impacted by                                 let's say independent                                 queries to two different collections on                                 the same cloud                                 um but i know you have a lot of                                 experience in this tim and so                                 like why have you seen organizations                                 moving in this direction                                 yeah yeah for sure and you know you                                 neglected to to mention um                                 you know being buzzword compliant i                                 think that i think that's a big one                                 and then you know it's also good for the                                 resume but uh no in all seriousness                                 um the one that really resonates with me                                 um                                 first off is kind of this this concept                                 of you know                                 eliminating snowflakes in the data                                 center                                 i think we probably all throughout our                                 careers have have had at least one                                 experience with                                 you know a jar patch not getting applied                                 correctly                                 or one of the machines not getting the                                 same configuration                                 um and i think just with solar being a                                 complex distributed system                                 uh kubernetes actually helps with that                                 because you know every pod is running                                 the same exact docker image                                 with the same config you know and and                                 that's                                 that's kind of um                                 an important thing for uh small clusters                                 but as you scale these things up that                                 becomes                                 absolutely critical right and the other                                 piece i like is that your developers and                                 your testers and your                                 uat environments they all run the same                                 software which is great                                 right um and then the other piece for me                                 about running on kubernetes                                 uh solar on kubernetes is um                                 it gives sort of a platform                                 for us as solar developers and i think                                 we'll see this more                                 in the talk um to actually build uh                                 and implement distributed system kind of                                 solutions on a platform                                 built around best practices so that's                                 kind of the other piece is that like                                 we building solar and supporting and                                 running solar we don't have to reinvent                                 the wheel on every kind of thing right                                 like kubernetes has                                 has come up with a lot of these concepts                                 and that's like you know uh                                 ingresses and services and um service                                 discovery and all those sorts of things                                 so                                 so that's kind of the the the things                                 that attracted me                                 uh to solar on kubernetes                                 um okay so switching gears a little bit                                 let's assume                                 um people are at least interested in in                                 trying solar on kubernetes                                 um you know other than the the solar                                 operator                                 you can you can just you know use a helm                                 chart i actually wrote a helm chart for                                 solar a long time ago and                                 wrote like a                                                           you know tell us a little bit houston                                 about you know why use a solar operator                                 over something like a like a helm chart                                 or some other type of config management                                 thing                                 yeah i mean that's a really good                                 question so if you look on like um                                 artifact hub or like any of those kind                                 of public helm trap repos you'll see a                                 couple                                 that are like popular and used for solar                                 and in general they're not                                 bad solutions and so they're really good                                 for if you want to be able to customize                                 your deployments more so for the solar                                 operator it's a                                 kind of a set config like you have a crd                                 that                                 it has a certain certain fields are                                 accepted and if you want to make changes                                 to that it's pretty hard you have to go                                 modify the go program                                 make a new docker image modify your crds                                 at that point you're                                 not up to date with like the official                                 apache release anymore                                 which makes it kind of hard to go back                                 um and so if you want to just be able to                                 like add little fields that aren't                                 supported by the solar operator                                 it's a lot easier to do that in a custom                                 helm chart and so you'll just                                 take the helm chart that's available                                 somewhere else add the fields that you                                 want                                 and then go and deploy it's much more                                 straightforward                                 however what the solar operator does buy                                 you                                 is safety and so with that we're talking                                 about                                 safe and efficient rolling restarts so                                 when you're using the helm chart                                 you're i would hope running uh solo                                 through stateful sets                                 and so the default staple set like                                 rolling restart logic whenever you                                 change a pod template                                 it works well for a lot of applications                                 it does not work that well for solar                                 uh in particular there's a lot of things                                 that you can get into                                 like the healthcare the liveness check                                 not taking into account that things are                                 still                                 were cut like rep because they're still                                 recovering on a note so you restart                                 another one which takes up the leader                                 and also if you have like let's say a                                 large solar cluster you want to be able                                 to restart                                 independent nodes like nodes that don't                                 have replicas of the same charts on them                                 in parallel and that's something that                                 the staple sets definitely cannot do                                 and so when you're running the solar                                 operator this operator has the ability                                 to take over that rolling restart logic                                 and really use the business logic that                                 we know about solar cloud                                 in order to make the most safe and                                 efficient rolling restarts                                 um it's also able to do other cool                                 things because it                                 has much more information about the live                                 kubernetes cluster                                 because it i mean it's living inside the                                 kubernetes cluster and it has                                 watches with the uh api server and so                                 we're able to do really cool things like                                 if you're running                                 um solar on kubernetes like solar with                                 ingresses on kubernetes                                 um you don't really want internode                                 traffic to go all the way out to your                                 external dns to your                                 ingress controller and back to the solar                                 node for every single request                                 between solar nodes you want to be able                                 to say i know what the ip address of the                                 service                                 that fronts the solar node is i'm going                                 to go inject                                 into each of my solar pods in the fcd                                 files i mean                                 etsy hosts files that this                                 ip like this ingress host maps to this                                 service ip address and so we can do                                 complete node to node traffic even                                 though the individual nodes                                 have ingresses fronting them that's                                 something that you very much cannot do                                 in helm                                 same with the solar cloud and so                                 there's kind of a give and take there                                 you get really cool features using solar                                 cloud but it's less                                 flexible for your unique use case um                                 there's another thing there where you                                 might be thinking well                                 the solar operator is another thing to                                 manage for myself                                 a helm is just like a static thing i run                                 it and then it's                                 there so what happens if like the solar                                 upper goes down                                 while i'm running my solar clouds that                                 is actually not as big of a deal as you                                 might think it is                                 so basically solar operator does do a                                 lot of the same thing that's home does                                 it templates                                 out the resources that it tells                                 kubernetes to run these are the stable                                 sets the config maps ingresses services                                 all those                                 and so if the solar operator goes down                                 and stops running                                 those things still exist in the                                 kubernetes cluster                                 and so your solar cloud won't go down                                 it's just because the solar operator is                                 in charge of doing rolling restarts                                 if you want to change something about                                 your solar cloud it won't actually                                 update and restart until the solar                                 operator starts again                                 and so it is an important thing to make                                 sure it's running                                 but it's not like it is um a part of                                 your critical                                 application path right and so                                 yeah i mean you've written an elm chart                                 before you've worked on the solar                                 operator                                 uh i clearly you have                                 some insight as to uh what organizations                                 would want                                 yeah and you know just to kind of                                 elaborate a little bit on your last                                 point                                 also like the operator gets deployed uh                                 two kubernetes just as a deployment                                 typically one                                 pod is fine um what i like about it is                                 it comes up in like less than a second                                 you know it's a lightweight                                 uh go go service um and so                                 very efficient um i you know it's not                                 like this cumbersome agent or something                                 that that you have to worry about                                 you know and the other thing for me with                                 the operator is                                 a lot of the configuration to get right                                 with solar                                 ends up being kind of tedious right and                                 it lends itself to being                                 programmatically                                 built versus trying to kind of temple uh                                 templatize that into a helm chart or                                 whatever                                 um you know if you haven't worked with                                 go templating it it has its nuances                                 um but you know a lot of just the the                                 tedious config that solar needs to get                                 right at scale like is                                 is really much better done you know in                                 code                                 at least i found that kind of like when                                 i implemented the                                 like the support for wiring up tls certs                                 and things like that and the other piece                                 and you touched on this houston                                 um is uh the operator does receive                                 events                                 from kubernetes but it also can like                                 look at the state of things like it                                 looks at the state                                 of the um uh and i'm using the word                                 looks at loosely here but say you know                                 your tls cert updates                                 right and that's stored in a coupe                                 secret the                                 uh the operator has a way to basically                                 say oh our search expired are about to                                 expire they renewed                                 so we're going to go ahead and do do                                 this rolling restore that                                 that houston talked about so i think all                                 of those things just really make it                                 a lot more flexible and powerful                                 solution                                 um for for using the operator                                 um so you know now i have my solar cloud                                 config the operator's managing it                                 um next question that comes in my mind                                 really houston is kind of like                                 well does this operator help solar kind                                 of run faster                                 or any of those kind of things uh i mean                                 this is definitely one of the first                                 questions everyone has                                 when they look at the different options                                 of earning solar and kubernetes and so                                 i just want to get this out there like                                 squash any misconceptions                                 no matter how you run solar on                                 kubernetes                                 it's not really going to impact how                                 solar runs                                 nearly as much as how you're running                                 kubernetes itself                                 so this includes what like servers                                 you're running your kubernetes nodes on                                 how full your cluster is like is the                                 scheduling really hard because there's                                 nowhere to put pods                                 um what kind of resources are you giving                                 to each individual pod                                 um and so these are the things that are                                 actually going to kind of affect the                                 runtime it's                                 much like what resources to the server                                 that you're running bare metal solar on                                 um and so the solar operator does                                 do some like kind of improvements that                                 we talked about earlier                                 which is like faster internode                                 communication when you're using                                 ingresses                                 it allows you to uh do like the more                                 efficient and                                 faster uh rolling restarts which are                                 probably gonna lead to less cluster and                                 stability                                 because the leaders already started last                                 um but in general                                 most of the like runtime effect is going                                 to be                                 how you're actually running on your                                 kubernetes cluster not                                 what you are using to manage your solar                                 pods                                 right and unfortunately uh you know this                                 the solar operator hasn't been able to                                 solve you know this age-old problem of                                 you know cluster sizing and                                 correctly assigning resource requests                                 and limits so i mean i i just want to                                 emphasize                                 um with people on the call that you know                                 kubernetes and the operator actually                                 help you manage these clusters as well                                 but                                 the hard work of really you know                                 sizing the cluster correctly and getting                                 that you know that that still                                 falls on uh you know a planning but also                                 uh testing and and running load tests                                 with a realistic load that kind of                                 simulates your your production traffic                                 i will say you know all this                                 infrastructure actually helps set                                 all that up faster and then if you do                                 need to                                 say you know increase memory                                 available to each pod or or cpu or                                 whatever of course this makes it a lot                                 easier but the                                 the actual work of sizing is still there                                 that's good to know um okay so                                 as we start to on our solar operator                                 journey                                 you know what are some of the best                                 practices that you've seen houston uh                                 for running the solar operator and just                                 you know that i guess best practices                                 um that the solar operator helps support                                 as well                                 yeah and i think this is a great                                 question to start with about the slow                                 operator so basically                                 i mean kubernetes is all about best                                 practices right we're trying to like                                 establish best practices for running                                 cloud applications                                 in a platform so that makes sense with                                 the solar operator as well                                 and so two things that the software                                 really i mean there's two things that                                 we've talked about already which is                                 basically                                 it really helps you manage like smaller                                 solar clouds with more isolated                                 collections                                 because i know it's a real big pain i've                                 run solar on bare metal on thousands of                                 machines and it is not fun                                 managing that it is a lot easier                                 to manage like a smaller number of solar                                 clouds that are giant                                 because there's less things to look at                                 um but with the solar operator you have                                 this like                                 solar crd so cloud crd that lets you                                 spin up a solar cloud and then you can                                 monitor it via kubernetes just to make                                 sure that it's up and running                                 you always know it's up and running i                                 mean it might not be healthy but you                                 know it's up and running                                 and you can like point your uh                                 prometheus you can point your                                 log monitoring there and it's pretty                                 easy                                 to manage a lot of independent solar                                 clouds at that point                                 and that allows you to have smaller like                                 smaller clouds or one                                 gonna perform better than one large                                 solar cloud with tons of collections in                                 them                                 and it also lets you separate concerns                                 between collections so                                 like one collection's load if like                                 they're getting really bad queries and                                 going oh                                 like getting lots of oms or like bad gc                                 uh like collection you're able to                                 like separate that concern so the                                 collection that is not                                 performing badly doesn't have their uh                                 like isn't impacted by that uh it also                                 allows your                                 like ops team to run solar as                                 infrastructure as code so you're able to                                 like                                 let's say you have                                                       take our                                               commit them to a github repo and we have                                 a way to                                 just re-deploy our cluster                                 at any time without any differences at                                 all                                 and so just kind of like it allows you                                 to really                                 focus in on that infrastructure's code                                 and run solar as a part of that as well                                 which is a completely new thing for                                 solar                                 yeah and then als okay no sorry go ahead                                 i was gonna say that                                 like i mean i know it's a pain to use uh                                 like solar security like tls uh                                 solar authentication all that kind of                                 stuff but                                 recently uh tim has written into                                 like the solar operator very easy setup                                 of both tls                                 and uh basic off so that it's basically                                 i mean it's very much recommended but                                 it's like almost just                                 plug and play and you're able to very                                 easily start your solar                                 in the recommended and secure way                                 yeah definitely i mean i i think it's                                 safe to say at this point like                                 there's really no reason for for                                 bringing up                                 solar cloud and kubernetes with the                                 operator you know without security                                 enabled it really is just as                                 as houston indicated plug and play                                 uh that enables basic authentication we                                 wire up                                 um a couple of different users                                 we ensure that like the liveness and                                 readiness check                                 the probes you know still work with an                                 authenticated solar                                 and you know then we wire in kind of                                 sensible                                 getting started uh authorization                                 controls                                 right and all this is just really it's a                                 flag                                 in this crd that you kind of enable                                 i've thought about just making that like                                 the default on                                 but um you know we're not there yet but                                 it it is abv                                 very easily yeah yeah uh and then you                                 know the tls                                 frankly who even wants to think about                                 that stuff anymore right um                                 so you know with that uh what we've done                                 is integrated with cert manager which                                 happens to be another operator that's                                 very popular in the kubernetes ecosystem                                 that for it has crds for managing                                 certificates and certificate signing                                 requests and you know                                 uh certificate authorities and things                                 like that and it will                                 go off and renew your certs and all                                 these things and then the solar operator                                 can actually                                 use and work with the cert manager to                                 wire in                                 um the tls config for solar and as i                                 mentioned earlier it can even                                 respond to the cert being updated by                                 cert manager                                 and trigger this restart um yeah sorry                                 for interrupting uh earlier                                 the thing i wanted to emphasize about                                 the crds is                                 it's what i like about it is                                 first off it's it's very solar specific                                 so anybody who kind of knows solar cloud                                 can look at it and really                                 kind of see almost you know                                 self-documenting of how their cloud                                 works                                 in kubernetes and i think that's really                                 nice because you don't get                                 bogged down in all the cube resources as                                 houston mentioned                                 you know at the beginning of the talk is                                 uh you don't have to worry about all the                                 kind of                                 nuts and bolts of kubernetes it's really                                 focused on you know how i want my solar                                 cloud to work and that's what's in the                                 crd right                                 and that translates on the back end to                                 all these crazy uh                                 config objects that get created by the                                 operator that kubernetes understands but                                 but for you and for                                 for your ops people they just work with                                 these solar cloud crds                                 um so this one                                 kind of seems like maybe the answer is                                 yes but you know                                 does the solar operator work with solar                                 collections in kubernetes                                 yeah uh we're running a lot of times                                 i'll just briefly answer this one but                                 i'm happy to answer it more after the                                 presentation                                 basically the answer used to be yes and                                 like the bloomberg version the solar                                 operator                                 when we moved to apache we removed the                                 ability to manage solar collections and                                 solar collection aliases                                 through kubernetes through the solar                                 operator and it was because we had two                                 different sources of truth we had the                                 kubernetes api server and then zookeeper                                 for solar cloud                                 both managing the same thing and they                                 didn't always agree with each other                                 so the solution for that was just to get                                 one rid of one of the sources of truth                                 which was the kubernetes one                                 and so basically now you have to manage                                 it all                                 through solar um but it's nice because                                 we just have                                 one api for everything at that point                                 everything in solar is one api and                                 everything about managing a solar                                 uh runtime is through kubernetes api                                 that's right and then you know we didn't                                 want as as                                 you know maintainers of the operator                                 code to have to like                                 you know duplicate all of the logic in                                 solar's collections apis and things like                                 that in this other area                                 but you know the the whole two sources                                 of truth                                 aside just you don't want to have to                                 duplicate all that logic so we think                                 it's a very nice separation of concerns                                 um this one comes up a lot because just                                 you know there's things organizations                                 need to put in various docker images                                 maybe you know their different um os                                 requirements what have you                                 so you know can you use the solar                                 operator with uh custom solar builds                                 yeah um so i would say you can the                                 prometheus exporter                                 especially but for the solar itself you                                 need to make sure it has                                 been solar it basically looks a lot like                                 the open the official docker image um                                 which for solo                                                           moved all that logic into the solo repo                                 and so                                 when you have all of your custom things                                 done to the repo                                 you can just use a cradle um command to                                 build yourself a ver                                 and completely compatible docker image                                 and there's tests for that as well                                 um but as for pre solar                                                  not even released yet                                 um i would say yes with the star                                 of make sure that you have like the                                 entry point                                 be a foreground bin solar and you                                 support everything that bin solar does                                 including all the invars all that stuff                                 right right                                 it's it's definitely doable i've i've                                 managed to work through it so                                 yeah if i can get through it i think i                                 think most tops folks can                                 um and so you know as we are running a                                 little short on time                                 um you know talk a little bit about                                 briefly just you know how solar                                 and the solar operator can kind of grow                                 together                                 yeah and that's kind of like the awesome                                 like                                 benefit of having this little opera be                                 a sub project of apache solar now is                                 that we're able to kind of                                 move together in like the same direction                                 and so that means growing the solar                                 operator when solar has new features and                                 growing solar to better fit these cloud                                 needs                                 and so i mean i'll just give a few                                 examples but                                 there's a ticket for giving individual                                 solar node                                 prometheus endpoints instead of just                                 having the prometheus exporter one                                 endpoint for all solar nodes                                 and this thing that would really help                                 enabling better                                 like horizontal body auto scaling in                                 kubernetes it's possible now                                 but it'll be a lot easier when each                                 solar node is able to                                 have prometheus metrics like exported                                 from it individually                                 um there's also other kind of weird                                 configurations that are necessary for                                 running solar cloud in a                                 like a real cloud environment                                 and so we're piece by piece                                 trying to like make all of these things                                 more configurable by default                                 not having to know weird esoteric solar                                 config                                 options and just kind of making solar                                 really a first                                 like a cloud runtime is a first class                                 option for solar cloud um                                 and this does include making like better                                 liveness checks                                 and other things for running in secure                                 modes because if you try to run solar                                 with tls on camry's now                                 um tim had to do this really let's say                                 uh                                 it was it was a good way of doing it                                 it's awkward                                 because of the way that solar makes him                                 do it but in the future we're trying to                                 make solar kind of understand the way                                 that clouds work                                 like not solar cloud but like cloud                                 providers work                                 and understand what it needs to do to                                 make it easier                                 gotcha um and so you know just to wrap                                 up um for those that are interested                                 in this is you know how how would they                                 get involved in this project                                 yeah and that's great i think we have                                 like very few to                                 me little time yet the answer is                                 communication basically we want you                                 trying it out                                 download it run it with like however                                 your company or you                                 run your like kubernetes clusters we                                 want to see as many different use cases                                 to make this                                 work for everyone that wants to use it                                 and so like obviously we love prs they                                 love documentation pr's they love new                                 features                                 but what we really really want is just                                 people                                 trying it out and telling us how you how                                 it works for you what you think about it                                 what needs to change                                 right that's a great point um and then                                 the other piece i'll add is like it's                                 actually a really fun code base and                                 project to work on especially if you're                                 like                                 wanting to learn go laying and and get                                 more in kubernetes i think it's a                                 fantastic way to kind of like                                 just get involved in that broader                                 ecosystem as well                                 compared to solar it is a tiny repo so                                 don't be afraid to go and look at it                                 that's that's it that's right um well                                 cool                                 i i think we're out of time with respect                                 to q                                 a um but the the good thing is is                                 houston and i are going to now shuttle                                 off over to the apple                                 uh chat room uh that's available um                                 uh in the buzzwords uh dashboard there                                 and we will be in there to answer any                                 questions that you have that                                 that have come up so apologize we ran a                                 little tight on time for questions here                                 but we'll definitely answer them over                                 there so uh with that thank you so much                                 houston i think this was really useful                                 and um you know thank you everyone for                                 for attending                                 yeah thank you                                 you
YouTube URL: https://www.youtube.com/watch?v=zl22KyzWqtM


