Title: Berlin Buzzwords 2017: Ivan Budincevic - Half a year of Measuring 2.0 in production @ bol.com #bbuzz
Publication date: 2017-06-15
Playlist: Berlin Buzzwords 2017
Description: 
	How do you measure the behavior of users firing 3,000 requests per second?

At bol.com, the biggest online retail platform in the Netherlands and Flanders, there are thousands of users visiting the site daily, and my team provides the measurement infrastructure providing near real-time metrics in the interactions of these customers with the platform.

Our new measuring system, Measuring 2.0 is built using open-source big data technologies like Apache Flink, Kafka, Avro, and Parquet, supported with in-house technology.

At Berlin Buzzwords 2016, Niels Basjes introduced this project, for which we can now share technical details of running it in production. During the talk I will guide you through how we kept our Kafka cluster resilient enough to handle our peak loads, how we used Apache Flink to show trending products on our website in real-time, how we handle continuous changes in our measurement data structure using Avro, how we use Parquet to deal with the great quantities of data while also keeping them easily accessible, and share the lessons we learned along the way.

Read more:
https://2017.berlinbuzzwords.de/17/session/half-year-measuring-20-production-bolcom

About Ivan Budincevic:
https://2017.berlinbuzzwords.de/users/ivan-budincevic

Website: https://berlinbuzzwords.de/
Twitter: https://twitter.com/berlinbuzzwords
LinkedIn: https://www.linkedin.com/showcase/berlin-buzzwords/ 
Reddit: https://www.reddit.com/r/berlinbuzzwords/
Captions: 
	                              yeah thank you very much                               welcome everybody to my talk so the                               outline of the thought would be as                               follows I'll give a short motivation                               kind of recapping what Neil said last                               year about why we went through this                               project then I'll talk about the design                               of the project itself how we actually                               implemented it and then I'll go to some                                experiences we learn from production of                                hopefully maybe giving you some lessons                                but you could maybe avoid and some                                future plans firstly to introduce myself                                my name is given within trovich it runs                                very well and I'm actually my background                                is I have a PhD in nuclear physics so                                it's kind of in line with the pre-shift                                rocker also come from a scientific                                background but in my scientific                                background I realized that I really like                                fiddling with codes and you know data                                analysis with Python so I thought man I                                want to go to IIT because it's fun                                because I can play with stuff so that's                                what I went to Bob Bob Prince come in                                the Netherlands and I've been there Java                                developer since                                                      because of my background I kind of liked                                working with data and I went to Big Data                                technologies because I can still fill                                with data to look at a lot of pretty                                graphs and do stuff so motivation behind                                a project is we are Baldwin comm we're                                the biggest online retailer in the                                Netherlands and the Flemish part of                                Belgium still I'm not really sure what                                the strategy is for just keeping                                ourselves tied down to two markets but                                okay and we started with selling only                                books at the web shop but now we                                basically brought out and we sell                                everything including the kitchen sink                                we know that joke anyway we it's an old                                joke I've heard from Bugs Bunny I want                                to use it so basically we have                                   million products in our catalogue at                                currently on sale we had                                              total we have more than                                                 customers                                            a lot of almost                                                      month                                                                 year so a lot of a lot of things                                happening and we need to handle this                                with Hadoop and we have a lot of                                technologies from the Fluke stack and as                                you can see as I hope you can see on my                                laptop I have stickers from Lincoln                                Kafka and I'm really happy to have                                finally you know embraced my inner                                hipster by being a developer with the                                Mac into stickers                                in Berlin so we use this tag and                                basically one of the things we use the                                caboose tag for is that we want to make                                recommendations but some of the                                limitations we currently have are that                                we use batching and we have things that                                run once per day so for example our                                search suggestions yeah I'm guessing the                                focus is not good but these are this is                                basically our website and you have                                somebody typing in dark and I get like                                things like Dark Souls here and                                basically we get these things from batch                                jobs once a day and this is a limitation                                when I get over and another thing we do                                is we show personal recommendations                                based on customer histories so here you                                see an example if I can look into this                                and like you know things you saw things                                that might also be interesting some                                purple pillows for me and that's because                                I bought a dragon ball when I was in                                Japan and I want to buy a purple mat for                                like Goku has a hand found on our                                website but I'll find it and basically                                these are the types of things that we                                like to do for customers we like to see                                what the customer likes what they're                                trying to find and personalize it and                                ideally we would like to do this in real                                time we want to be able to handle these                                yeah customer needs in real time this                                was the key motivation for our framework                                that called measurement out to oh and                                the one of the so as I said real time                                that's the key if we want to address so                                not having batches once a day and we                                don't want to measure everything so want                                 to measure everything the customer has                                 done everything that he has seen or I                                 mean sorry but they have done that they                                 have seen and yeah anyway we want to see                                 all that so basically this led to the                                 design of measurement to that oh we are                                 measuring everything all Ajax                                 asynchronous things all the channels                                 that we have we have a web shop but also                                 sent emails to people we have seller                                 dashboards so you basically want to                                 measure everything across the whole bulb                                 landscape and we want to have reliable                                 data we want to have low as possible                                 loads on the clients as possible                                 latencies we also want to be so since                                 this is an in-house solution which we've                                 made because we were not satisfied with                                 the other solutions that were available                                 at the time this is an in-house solution                                 that is that the key is for it to be                                 embedded in our landscape and for our                                 developers use it so we want them to be                                 able to                                 use it easily and to validate things                                 easily it's a testament so we're                                 constantly working with them to getting                                 feedback on if they like it or not                                 things we should change or not and we                                 also need to have good business                                 flexibility because we want to be able                                 to measure everything but they're also                                 aware that we might have not thought of                                 everything so that we also want to be                                 able to extend all the measurements to                                 ask new questions now and the final                                 thing is that we also want to handle                                 some perhaps sensitive things like                                 privacy there's a Vitamix or same exact                                 things like that people cannot be                                 tracked on a personal level longer than                                 two years some yeah the Netherlands like                                 their rules                                 so these ones rules we have to follow                                 and security things that we also of                                 course have to be safe against hackers                                 and that we can do profiling now going                                 into the design of the actual framework                                 what how we did it is that we have the                                 web shop the Volcom and basically when                                 this Web shop renders a page we generate                                 the measurements we generate the                                 measurements and this measurement is                                 sent into Kafka and at the moment of                                 generating the measurements this is the                                 moment where we rendered the page we                                 also generate some tags tags that we                                 insert in the HTML and these types are                                 basically the IDS of that measurement of                                 that event and this ID can be used for                                 in view measurements for things like if                                 a customer's curl down and then                                 something came in and out of view of                                 they clicked on it we can use this to                                 identify that they've clicked on                                 particular part of the page and that can                                 be seen by our web service that                                 generates a sort of so-called front end                                 measurement and puts it back into Kafka                                 the key being that this ID is the same                                 here and here and from the back end and                                 the front end so we can converse it to                                 later the measurements are then sent                                 from Kafka to the flink jobs and I think                                 it's simply interesting to point out                                 that the moment the generates a maze                                 until they get to Kafka it takes like                                 five milliseconds so there's we can                                 really ideally really do stuff really                                 real real real time and we can do some                                 processing on these Kafka streams fling                                 jobs which we output to HDFS Kafka                                 Cassandra debate depending on where                                 we're using the measurements at now this                                 is an example of a page which because of                                 incahuasi like the shopping basket                                 and this I will use to tell you about                                 the data structure of our measurements                                 so if you look at this page yeah don't                                 mind it is horribly focused but it's                                 like the point is that we have the page                                 and we have some components so the red                                 component is basically the entire page                                 this is something that it's a container                                 and it contains things that are in there                                 we have groups which are in blue which                                 are things that we can we can put                                 metadata in there like why are all these                                 things in blue what lies them together                                 here there are two items in a basket                                 shopping basket and green are specific                                 items like a product and the hook is                                 this basically anything that a customer                                 can interact with that something happens                                 that's a hook and what happens when the                                 customer clicks on a cook let's say a                                 customer clicks on this picture pointed                                 in purple they will get a URL and in the                                 URL we will attach an extra query                                 parameter which is an ID that I just                                 mentioned before is an ID for this                                 measurement now the customer will then                                 go on to a different page                                 but we will know from this hook that                                 they came from the previous page and                                 then we can relate that to this                                 container on this new page and then a                                 phone within this page they click on a                                 different item within this group or                                 within this item they go to another page                                 we still have this link so basically                                 this will also have the same this is a                                 list page with a list of different                                 products and the customer here we will                                 have the whole track from the beginning                                 when they were in the shopping page                                 shopping baskets to the product page                                 very run the product to the list page in                                 the end or I mean obviously they can                                 have much longer journeys but this                                 demonstrates our principle that we can                                 follow their entire path now moving on                                 to the actual experience we had in                                 production which I'm hoping you're going                                 to want to hear these are some of the                                 measurements to be gained and this is a                                 typical day of measurements this is                                                                                                               six put some key times here and these                                 are number of measurements generated per                                 minute now I like this bathroom because                                 this pattern happens every day and it                                 has some characteristic things for                                 example it has the sandwich dipped                                 because the Dutch people only sandwiches                                 for lunch which is really frustrating as                                 a serving use two barbecues                                 and then they have an after-lunch peak                                 and then you know go home for dinner                                 have some potatoes potato deep and then                                 there's the classic evening peak where                                 we get most of our key traffic now                                 sometimes they're also things happening                                 we love the nights which are most likely                                 BOTS and then this is something I like                                 is that kind of a side sight thing that                                 happened there was a period in April we                                 had days with a lot of spiky behavior we                                 couldn't really figure out what it was                                 then we talked to the security guys and                                 we figured out it's basically coming                                 from the boss Network from somewhere in                                 the US and by filtering out this network                                 we just managed to you know stable                                 either side have less BOTS and things                                 but this is I think a nice example of                                 something that the system was not                                 exactly designed to do but it's a new                                 question that was answered just because                                 of the system being there now this is                                 there some other little numbers and                                 things that we have currently having                                                                                                       this is still not this is really                                 important to say here that we are only                                 measuring fully the shopping page the                                 shopping basket pages of inkelaar today                                 they showed you before and this is                                 because we are now in the process with                                 our developers to actually tag every                                 single type of page in the webshop so                                 we're also using this as a learning                                 thing to improve the system but also                                 it's not not fully there yet and we are                                 expecting at peak time when everything                                 is tagged to have around                                           measurements per minute but you know                                 some things we can already show is that                                 pages are like like the product page                                 like this on this pie chart in blue are                                 the most visited which we were expecting                                 anyway but it's nice to be able to show                                 it specifically now something there's a                                 lesson that we would like to do we would                                 like to share with you from Kafka is                                 that we are one of the first users of                                 all that going with her using Kafka and                                 so these are some of the specs of our                                 cluster and one problem we had was that                                 in the beginning when we were setting                                 everything up and really running things                                 in production we saw that there was one                                 disk that spent a lot of time on Io                                 operations it was compositor getting                                 stuck on this we couldn't figure out why                                 and then finally we saw that there was a                                 property in Kafka called flash messages                                 which was set to zero this means that                                 they will constantly try to save stuff                                 to disk and when I was doing this with                                 yellow anivia or CRT guy I like to call                                 him jdog if you ever meet him call him                                 j-dog he hates it it's a nickname I want                                 to make using so we saw that there is                                 this property if you look into the Kafka                                 actual settings it says in general we                                 recommend you not set this so our lesson                                 was don't change the default potency                                 unless you know what you're doing                                 because we had no idea we were doing                                 yellow said I am Martin did that you                                 know when you were setting it everywhere                                 okay so this is something that we just                                 learned and an actual application of the                                 measurements Oh                                                         going way too fast okay cool yeah okay                                 I'll try to come up with a few jokes or                                 something along the way so so basically                                 this is it's really cool to have this                                 measuring infrastructure to be able to                                 measure everything but I mean at the end                                 of the day you want to use it for                                 something right so what this is one of                                 the first applications that we came up                                 with is if you remember in the beginning                                 of the talk I talked about the search                                 recommendations and how we do this we                                 have batches that run once every                                    hours                                 so the trending products at our website                                 unfortunately still run once every time                                 for hours and they actually compute the                                 previous day so you know it sure seems                                 something trending on both would come                                 it's actually really not raining anymore                                 so yeah we were few days later                                     spinners as well so one thing with so                                 this real-time trending project does is                                 that we actually look at our                                 measurements that we're creating and                                 sending it to Kafka                                 I'll show you slightly more details on                                 how we do it but we can do it now in                                 real time and calculate with specific                                 configuration parameters we can change                                 but for example we now calculate for the                                 last                                                              compared to the previous of a period of                                 the previous                                                         that this is a set of things that was                                 like sunscreen a pool and an air                                 conditioner which was happening on the                                 day when was one of those rare sunny                                 days and Islands when people had wanted                                 to actually buy sunscreen and that was                                 also like a movie but                                 you know I guess everybody want to go                                 out and you can see here actually I                                 think a nice example of our measurements                                 showing behavior in the data which                                 relates to trending so this is this is a                                 graph of this is the times of day and                                 this is like                                                            rest you don't really need to know the                                 moment it's other hours so and the and                                 the y axis is number of search results                                 for a given term and there is a TV show                                 and the Nerlens called the viral ride or                                 right door I think which basically goes                                 on every day and talks about popular                                 stuff with people looking at and it also                                 has a segment books of the month and on                                 this particular day I think this was in                                 March I had these four books the                                 dimensions at six seven ten or so seven                                 fifteen and then you solve it by                                     these books were already trending on our                                 website and this is directly coming from                                 our data and this was okay at the time                                 the whole trending products thing was                                 not finished but if it was finished then                                 these folks will already be live in the                                 training products they are alive now on                                 production behind maybe tests so things                                 like this we will pick up and how do we                                 do it this is a very simplified picture                                 of our fling I didn't want to show the                                 whole thing - / because it's way too                                 much detail but this shows you just the                                 principle of what we do is we have our                                 measurements coming from Kafka they go                                 through certain filters like people not                                 looking at the same page you know                                      times or BOTS people trying to push                                 their own products making them trending                                 so things like this we're filtering out                                 in this moment then we're counting how                                 many pages were seen calculating the                                 z-scores - basically how much the views                                 for a given product are deviating in how                                 many standard deviation from the mean of                                 the historical periods and then                                 outputting our results which is                                 basically just a little file with                                       whatever amount of z-scores we want                                 alpha dating is HDFS and Cassandra and                                 serving it back to our webshop so that                                 we can show it and finally                                 this is just a note that I want to share                                 with how we are storing our files is                                 that we're using some writing skills an                                 Avro because it's a very nice schema                                 language you can generate Java classes                                 supports scheme evolution and also                                 storing them in park' because yeah                                 Pirkei is most of you probably heard of                                 it but you know it's a columnar storage                                 format and it's good for read cases                                 where you need to read quickly from                                 park' and some and so we also contribute                                 to the bit new advisors who actually                                 design the measuring                                            contributor to Avro with the schema                                 evolution system by making a new message                                 type format that it was used there and                                 finally just the future plans so these                                 were so far I showed you what we did in                                 the first six months and the next step                                 is we are currently busy with tagging                                 the entire webshop as I said we were                                 only tagging the basket page we are not                                 going with the developers with the other                                 teams just you know what went wrong here                                 can we can we tag this page in that page                                 and then we see that something                                 completely doesn't work and then we fix                                 it so a regular process and then we also                                 want to tag the mobile app and because                                 this is not currently that yet customers                                 could do look at the website through the                                 mobile through your phone browsers they                                 are measured but if they're losing the                                 app itself they are not yet and we also                                 want to fully enable any view                                 measurements I didn't mention this but                                 we are currently trying to actually we                                 enable them last week I think for                                    percent so                                                               also generating things they actually saw                                 if they moved in and out of frame how                                 many things were in frame which is                                 something we could not have done before                                 with Omniture something like this and                                 we're also in the end as I said we                                 really want people to use our data so                                 we're going to provide tooling as well                                 for business analysts to look at it and                                 generate for example live reports                                 perhaps and many other many other things                                 and finally I want to thank you for                                 attention and yeah just this is sort of                                 a mini plug but I'm from both would calm                                 and we had like a first spaces summit                                 conference don't mind it I'm sweaty and                                 this looks a bit nasty but                                 we had this last week on Friday and                                 we're kind of hoping to make it a thing                                 so I'm just promoting it here it was an                                 in company conference for other because                                 we had                                                                   by the way if you want to join and yeah                                 we're hoping maybe this one I might                                 become a thing later and thank you for                                 attention with this again                                 [Applause]
YouTube URL: https://www.youtube.com/watch?v=3OiWGTlQBYQ


