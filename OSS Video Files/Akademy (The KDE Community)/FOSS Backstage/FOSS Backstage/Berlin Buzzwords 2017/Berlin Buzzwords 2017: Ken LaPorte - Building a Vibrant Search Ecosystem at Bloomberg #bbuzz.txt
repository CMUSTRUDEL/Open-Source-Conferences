Title: Berlin Buzzwords 2017: Ken LaPorte - Building a Vibrant Search Ecosystem at Bloomberg #bbuzz
Publication date: 2017-06-15
Playlist: Berlin Buzzwords 2017
Description: 
	Search is a core technology that allows Bloomberg to deliver financial news and information quickly and reliably to our clients. The Search Infrastructure team has created a high performance, stable and scalable search ecosystem to support a large, complex and diverse set of search applications.

Providing search as a service to the thousands of developers in this demanding environment requires us to take a holistic approach. In this talk I'll discuss both the organizational and technical challenges we've encountered and the approach we've taken to solve them. I'll dive into the details of our platform from the way we engage with our tenants, interact with the Solr community, to the infrastructure and tools we use to manage, monitor and scale our platform.

This talk is presented by Bloomberg.

Read more:
https://2017.berlinbuzzwords.de/17/session/building-vibrant-search-ecosystem-bloomberg

About Ken LaPorte:
https://2017.berlinbuzzwords.de/users/ken-laporte

Website: https://berlinbuzzwords.de/
Twitter: https://twitter.com/berlinbuzzwords
LinkedIn: https://www.linkedin.com/showcase/berlin-buzzwords/ 
Reddit: https://www.reddit.com/r/berlinbuzzwords/
Captions: 
	                              good afternoon everyone I know I'm the                               last Speaker of the day you guys are                               pretty tired and I'm in between you and                               beer so I will try and get                               as possible so like you said my name is                               Ken Laporte I run the search                               infrastructure team at Bloomberg                               specifically what we do is we provide                               search as a service to the rest of the                                company I've been in the search domain                                space for about eight years and our team                                has been in existence for about three or                                four I'm gonna talk a little bit about                                how we got started                                and what we're doing and what's next so                                a little bit about Bloomberg Bloomberg                                is the world's largest provider of                                financial news and information our                                clients really rely on us to get                                information to them as quickly and what                                the greatest consistency in quality as                                possible so high speed data entry                                retrieval systems like search are really                                critical to that as our databases but                                search is nothing new a Bloomberg                                search has been around for since the                                beginning of the company                                              ago so what happened well there were                                originally a lot of different search                                architectures and technologies being                                used some of them commercial some of                                them open source they were very                                difficult to maintain how do you                                maintain                                                       applications across all the teams there                                was no consistency there was best                                practices weren't being followed there's                                a lot of custom code and there wasn't a                                whole lot of sharing this was finally                                costly to maintain and almost impossible                                to evolve over time so that's where we                                came in                                we looked at some of the use cases that                                existed we want to make sure that we                                were going to offer search as a service                                but really try and show what we could do                                so we picked a few different use cases                                you can see the top left one is about                                emergence and acquisitions and the end                                of sorry top right and the bottom right                                is a geospatial search showing good I                                believe this is different boats in                                various waters and each of these had                                very distinct requirements the mergers                                and acquisitions was heavily analytical                                data that we actually developed a custom                                component for solar so it was really an                                interesting thing but why solar well we                                reviewed a bunch of different search                                engines and technologies                                search Sola was already heavily used in                                Bloomberg so that was a big plus there                                was a large community some people in                                this room actually are poly committers                                or have worked on different areas of                                solar it was established and growing                                very very quickly at the time finally we                                knit we did some testing we knit was                                scalable we knew it was stable and                                really working well for us and Bloomberg                                has a hole about the same time really                                wanted to commit to open source and this                                was very attractive to us we want to not                                only go into the solar and fix bugs and                                make minor tweaks but actually build out                                new and new software really contribute                                to the core add major features and since                                four or five we've had new new features                                added in almost every release and as a                                right now we have three different                                committers of Bloomberg one of the PMC                                member so a little bit more about                                searches of service we designed it with                                our application teams the people who are                                actually going to be using it we talked                                to them we found out what they needed                                what they wanted and with that we built                                a very flexible middleware layer between                                solar and our users this allows allowed                                us to do a lot of really cool things                                first we simplified the interface to                                solar we made it dead simple for them to                                get started get using it but it also                                allowed a pastor capability some people                                want to do anything they wanted what                                good or bad and just go ahead and go to                                town                                so we had to support that and finally we                                added some basic monitoring and metrics                                 to go with it more on that later so open                                 for business this is great day one we                                 started off with three tenants and over                                 time increase dramatically we did not                                 anticipate this kind of growth so very                                 quickly we were adding hundreds of                                 searchers search servers handling                                 thousands of queries per second                                 indexing billions of documents a day a                                 lot of these mission-critical to                                 Bloomberg and now a Bloomberg but the                                 financial industry overall                                 and then we realized it we've made a                                 huge mistake we didn't really think                                 about a few things we didn't think how                                 are we actually going to scale how are                                 we going to scale the personal support                                 that we've been offering tendance how                                 are we going to really monitor and                                 manage these collections how we're going                                 to handle the alarms we're getting                                 alarms daily when we're detecting things                                 we're getting problems reported to us by                                 our clients which is not what we want we                                 want to detect them before they they                                 know that there's a problem our                                 configuration management was a mess                                 I'll talk more about that and finally                                 there are lots of known unknowns we knew                                 there were things wrong we we knew that                                 there were problems we just were having                                 trouble identifying them so the first                                 thing that we talked about is our                                 ecosystem how do we fix this from the                                 ground up what's the what's the most                                 basic problem that we're having and the                                 first thing is ownership people who are                                 running their own search engines for a                                 long time thought that they should own                                 the search engine they others thought                                 hey I'm just going to throw my data over                                 the oldest or the fence these guys                                 they're going to own everything they're                                 going to manage everything some thought                                 we'd even write their code for them that                                 didn't happen so where's the line so                                 what it came down to is that we became                                 custodians of that of that data we made                                 sure that the api's and services were                                 all stable and everyone was kind of                                 happy with that how do we plan for scale                                 different groups were growing at                                 different different paces we had people                                 who were you know they'd say oh I think                                 I'm just going to start off with a                                 million documents before we knew it they                                 were at several billion and we had to                                 deal with issues like that and finally                                 educating our users these a lot of these                                 guys came from databases they had no                                 experience with search they didn't know                                 anything about the specific data types                                 tokenization relevant or some of the                                 features with solar or and search                                 engines in general like faceting                                 fascinating was a new concept to a lot                                 of people                                 there are several talks about relevance                                 today I see Mike over there who gave the                                 LTR plug and talk this morning and Diego                                 - sorry we've spent a lot of time                                 working on relevance but a lot of that                                 is also educating our users so the first                                 thing that we did to figure this out is                                 we came up with kind of a four-step                                 approach the first is the first step is                                 a survey we actually sit down and talk                                 with everyone who wants to have a                                 collection we find out exactly what they                                 want we talk to them about their use                                 cases whether even the search engine is                                 an appropriate use case for them how                                 quickly they plan on indexing data what                                 their queries look like and we work with                                 them to figure out how best to structure                                 all that next development test how are                                 they actually going to get this out how                                 can we make sure that it's stable                                 reliable that's my job to make sure that                                 nobody ever finds an outage that we find                                 out about it we fix it before our                                 clients know anything about it to do                                 that we help them follow some of the                                 best practices we develop code samples                                 and that they can use and copy we were                                 really good documentation and we did                                 other things like we hope we hold                                 regular office hours and have a support                                 chat where people can come ask us                                 questions whenever they want we really                                 involved other applications developers                                 in our Bloomberg to come in help help                                 each other out and finally we developed                                 a search guild of people interested in                                 search applications at Bloomberg not                                 only for my team the search                                 infrastructure team but throughout the                                 company the next step is validating                                 deploy how do we know that what they                                 created that is actually going to go to                                 prod it's actually going to work and                                 it's going to stand the test of time the                                 first step of this is hardware                                 provisioning I'm going to talk a bit                                 more about that later so I don't want to                                 go too much into it as I'm as our                                 automated deployments but one of the                                 features that we started offering is hot                                 and cold collections for some people who                                 are interested the ability is to index                                 to one collection and or to collections                                 and flip after                                 quality control checks this is a very                                 new concept to some people and they                                 really found it very useful                                 next load testing load testing is an                                 incredibly important part to my team as                                 well as to the company what we want to                                 make sure is whatever load I anticipate                                 we can not only handle that load but we                                 can handle that load in a disaster                                 recovery situation so if a data center                                 is down we can actually continue to                                 service their client load even at peak                                 finally how do we grow some of these                                 collections were created years ago                                 features change requirements change and                                 they want to add data changes so how do                                 you go from hey I want to you know I                                 have this proof-of-concept I'm going to                                 index a million documents and you know                                 maybe one one QPS how do I grow that up                                 how do i scale that to a thousand QPS                                 how do i scale that to ten billion                                 documents how do we and then how do we                                 monitor that and who controls that                                 monitoring so very often we'll find that                                 hey this user really knows what they're                                 doing I want to put him in control of                                 everything that's going to let him start                                 stop deploy do everything but with that                                 also comes the ability to turn on alarms                                 turn them off and handle those alarms                                 when they come in which brings me to                                 monitoring so or how do we monitor solar                                 first we have a very large monitoring                                 footprint it's huge we have thousands                                 and thousands of solar instances the                                 other thing is that what do you monitor                                 so there's a number of things first                                 looking at cluster state is easy you                                 look at live nodes you see what's up but                                 we're also going deeper we're actually                                 constantly pinging solar from different                                 nodes making sure there's no network                                 issues we're monitoring the process                                 health or making sure that that's going                                 that's running well and one level down                                 we're actually monitor we run our own                                 hardware and we're monitoring that                                 ourselves as well taking all that                                 together to really create a good picture                                 of the state of our system                                 this caused a problem all of a sudden                                 we're monitoring all these things and                                 we're seeing false alarms we're seeing                                 hey this node went into recovery for                                 five seconds a hundred times why they                                 weren't feeding anything they weren't                                 doing anything too special and we're                                 going to talk about that a little bit in                                 a minute so I really I had a cool demo                                 that I want to show you guys but the                                 demo gods did not allow me to do that so                                 we're going to move on so we decided                                 that we had to take all that those                                 different ways that we were monitoring                                 my solar and put them together to create                                 an aggregate view these aggregated                                 events really define whether or not                                 there's a problem with our clusters it                                 also allowed us to do something very                                 interesting it allowed us to delay                                 alarms as well as to use that time that                                 the alarming was happening to identify                                 how serious an alarm something is you                                 know if a collecting is down for two                                 seconds is that a problem or is it or is                                 it a problem in a minute or ten minutes                                 or half an hour where that line is we                                 can define it and we created two or I                                 should say Keith the guy back there                                 created two really cool tools to help us                                 monitor this night out which is the back                                 end process monitors all those things in                                 solar as well as other applications that                                 we that we manage like zookeeper some of                                 our own generic services and watch our                                 which with night owl allows us to                                 visualize all these things as you can                                 imagine with hundreds of servers how do                                 you visualize these things it gets very                                 very tight there's a lot of information                                 and we thought of some very cool ways to                                 kind of collapse fuse into different                                 racks so that from one screen we can say                                 okay everything that I have is good or                                 hey here's the problem that I have this                                 is in addition to automated alarms that                                 go in that let me sleep at night so some                                 of the things that we found first memory                                 issues was a huge huge problem for us                                 we're experiencing low garbage                                 collection pauses a few things that we                                 found we were making our heaps too big                                 so we started keeping our he                                 really really small Ian for large                                 collections for high-end guest                                 collections make them even smaller it                                 really helped us out a lot                                 use g                                                                 this improved performance and stability                                 significantly when we when we switched                                 over next out of memory exceptions out                                 of memory exceptions are almost                                 unavoidable you know no matter how good                                 you develop eventually you're going to                                 run this to something like this so one                                 of the things that we use is the OLM                                 killer lets you lets us bring down a                                 process bring it right back up and                                 resyncing and continue on but we have                                 monitoring and alerting on that should                                 that have should we get too many OMS or                                 should in an interference cluster state                                 we know about it we can action on it but                                 most of the OMS that we found have to                                 deal with users doing sorting filtering                                 on non dock value fields so at the cost                                 of some disk space we started enabling                                 dock values on a lot of these things and                                 all of a sudden we were going from                                 having these issues daily to being a                                 once in a once in a while on current                                 with the garbage collection process we                                 also found that we were having long                                 recovery times every time a collection                                 would go and into a                                                 garbage collection pause it would come                                 back up and then start recovering for an                                 hour why that that didn't make a lot of                                 sense to us after doing a lot of                                 investigation we found the transaction                                 logs just don't hold enough information                                 and you can see we created a few                                 different gear issues for those and                                 under high load it would do a full                                 recovery which a full full replication                                 which really wasn't working for us there                                 were a few other solar bugs that we                                 addressed and with those things we had                                 some massive stability improvements that                                 we found configuration management was                                 the next thing that we decided to tackle                                 in fact this is one of those challenges                                 that we're still working on today                                 back at the office there's two guys                                 right now toiling away with this                                 the current process is we take what we                                 wanted to find as our configuration and                                 what the user defines as their                                 configuration put them together and that                                 kind of creates a composite it allows                                 them to figure to define some things on                                 their own while still allowing us to                                 have control the problem with that                                 though is versioning becomes very very                                 difficult there are some changes that                                 you just can't rollback we experienced                                 this a lot when we moved from solar                                      solar fun where hey we just enabled dock                                 values and all of a sudden things don't                                 work because some segments have dock                                 values for a particular field and some                                 don't some do and some don't so it was                                 really good for some simple collections                                 but once we started doing some more                                 complicated things the Train kind of                                 came off the rails and we need some help                                 and finally when you're merging these                                 different configurations at different                                 times it's hard to say that you know                                 this version is exactly what I'm running                                 in production that lack of provenance is                                 is really problematic for us and for our                                 tenants because when they say hey there                                 was a problem I deployed some of my some                                 of my nodes had this configuration some                                 had that it was very difficult for us to                                 understand so we looked at and we                                 converted to an SD LC process we                                 basically said ok your configuration is                                 going to start living at a git                                 repository we're going to have we're                                 going to build that repository with with                                 maven and Jenkins we're going to create                                 artifacts that live in artifactory and                                 then we're going to push those artifacts                                 into zookeeper for Soler's use this is a                                 process that we're in that we're                                 currently automating but it also allows                                 us to do some very cool things so it                                 allows us to validate the configuration                                 to your static analysis it allows us to                                 say I see the Kings that you're making                                 this is a good change that this is a                                 known bad change it also allows us to                                 create unit tests with user-defined data                                 they can say here's a sample of my index                                 here's a thousand documents here's the                                 change before here's the change after is                                 this going to work or is this going to                                 break                                 and the last thing is that we're working                                 on completely automating this one of our                                 goals for this year is to really take                                 all take us out of the whole process                                 empower our users make a completely                                 self-service for them little little                                 puppies one of the issues that one of                                 the other issues that we had is the                                 substantial demand that we weren't ready                                 for traditionally Bloomberg getting new                                 hardware spun up is a very expensive                                 process with long lead times that wasn't                                 going to be acceptable to us we want to                                 really be able to drive those                                 requirements so we created a group of                                 DevOps or sres on our team and they                                 actually work side by side with us to                                 figure out exactly what we needed and                                 how to make it work                                 it was completely from the ground up we                                 really streamlined it as much as                                 possible                                 we used different tools like vagrant                                 Jenkins and then monitor all this with                                 zabbix as well as pulling from                                 artifactory and stuff the last thing                                 that I want to mention on this and I                                 know it's obvious but it's but it bears                                 worth it bears repeating that our                                 hardware is a better experience we did                                 substantial tests with different hard                                 drives SSDs actually do make it better                                 big surprise but it makes it                                 substantially better Solar is very                                 efficient in how it uses both disk and                                 network we have                                                          between nodes and during a recovery so                                 and we'll use all of that and pull it                                 over it will saturate the disks it's                                 really quite impressive when you see it                                 so with that we have all these servers                                 we have all these processes and now how                                 do we manage these that brings us to our                                 the next thing that we're going to                                 tackling it's how do we containerized                                 solar how do we run all of our                                 applications within containers how do we                                 make them work easier faster and better                                 we want to make sure that things like                                 zookeeper also run on the container they                                 run stable and they really perform as                                 well as they do as as they do now on                                 bare metal I would mention before we                                 want to make sure that our tenants are                                 completely self service that they have                                 everything that they need to do any sort                                 of configuration that they want to do                                 monitoring and manage their collections                                 almost like on Prem cloud if you will                                 and finally we're making a number of                                 improvements to solar I'd mentioned that                                 we created an analytics component well                                 for the last nine months we've been                                 working on a distributed version of that                                 that should be coming out soon the deer                                 ticket is there we've also done a ton of                                 work on streaming one of the committers                                 on my team Dennis Cove has been working                                 heavily on that and he continues to do                                 that right now and more we're still                                 looking at bugs we're still looking at                                 features and we're still trying to                                 figure out what the next thing is for us                                 all right and with that do you guys have                                 any questions first let's get Ken around                                 - applause                                 [Music]                                 any questions how much time does it take                                 the whole process from like the chaos -                                 well we're not a perfect yet                                 so we basically shut down creating new                                 collections for about three months where                                 we said okay we really can't do any more                                 deployments we just have to fix on the                                 process problems that we have so we                                 stopped everything we said okay we're                                 going to automate this step we're going                                 to let you do these things so about                                 three months to stable and probably                                 about two years after that we've got                                 we've got in a really good state that                                 said I'm really hoping that by the end                                 of this year we can be completely our                                 attendance can be completely                                 self-sufficient you know they can go to                                 some display and say I purchased these                                 servers I'm going to spin up you know                                 eight clouds with twelve collections                                 here are the configurations okay it's                                 great                                 I want a load test this now I want to                                 move it out to production and it'll be                                 and I want to set these kind of alarms                                 and these kind of metrics does that                                 answer your question                                 yeah and the Dean sighs it started                                 that's a great question sorry it started                                 off with three people then was five                                 start off with three people for a couple                                 years then five for a year and I think                                 it's now up to eight okay thank you                                 thank you                                 hello thanks for your talk                                 just one question regarding the                                 containerization you're planning I mean                                 I know the general theme why one wants                                 to do container containerization but                                 what is your why are you doing that are                                 there particular reasons why you're                                 planning for that sure there's actually                                 a lot of different reasons the first one                                 is that we want to be able to allow                                 someone to say on my desktop on my                                 laptop I'm going to spin up an entire                                 searching for structure I'm going to                                 create my own zookeepers I'm going to                                 create a                                                                all going to live locally that's a lot                                 harder to do without containers also we                                 have collections that run on shared                                 hardware this typically is not                                 problematic but we'd love to be able to                                 do quality of service on collections                                 we'd also like to be able to scale them                                 a little bit faster so sure we can bring                                 up new Java process but it would be                                 awesome if we had a scheduler where we                                 can just say hey in this data center we                                 expect you know                                                       running in this data center we're going                                 to do a load test so we want to have                                    of them running and just spin them up                                 let solar do its replication and just                                 run with it it's actually one thing that                                 we're still investigating though with                                 that is the performance of solar in a                                 container I've seen some numbers where                                 solar can take a five percent                                 performance it something like that might                                 not be acceptable to all of our tenants                                 they have hard requirements for how fast                                 they have to deliver data so that's an                                 it we've got to look at it might be hey                                 you check a box you'll run solar in a                                 container hey you want to have your own                                 collection not in a container you'll                                 have a nun barrel that's you that's for                                 you to                                 I have a question about the sres working                                 with your team sir and I'm wondering how                                 much time it took for them to get                                 familiar with the solar or did you look                                 for people already familiar or would you                                 even say it doesn't matter they don't                                 care about solar they care deeply about                                 solar they one of them has been on the                                 team for a year and a half and I think                                 he's the he's the first one that we                                 hired and although he does care about                                 solar deeply he's no expert in it you                                 know I will sit with him on a daily                                 course on a daily basis and you know                                 we'll parse out query logs and say okay                                 this is why this square was running slow                                 you know here's what we do what we tell                                 the tenants to fix it                                 so we'd actually didn't search for our                                 unicorn because you know some DevOps and                                 Sree who would you know really                                 understood things like vagrant and as                                 well as search that sort of thing I'd                                 rather just teach someone search I can                                 do that I I'd rather not teach them the                                 more DevOps II work does that answer                                 your question yes I'd rather have his                                 response was and that worked well for us                                 yes I think it helps that we have three                                 really really bright guys where I have a                                 lot of faith in and they have different                                 experiences one guy really really I gets                                 into the hardware he's done all we've                                 evaluated at least twenty or thirty                                 different types of hard drives and he's                                 found the perfect hard drive for our use                                 cases others are higher up the stack and                                 one of them is more involved with hey                                 let me create an API and a database to                                 track all these servers and what's on                                 what so from from that perspective                                 that's really worked out it also lends                                 themselves to be moved on to other                                 things so once we have a lot of the                                 stuff automated they can go work on                                 other tasks like worse we're starting to                                 toy around with them and data science                                 and machine learning so from that                                 perspective it's really worked out                                 I just wondering if you have any kind of                                 preliminary thoughts on how the                                 containerization would work in terms of                                 orchestration and things like that we're                                 evaluating a few different options                                 kubernetes is likely is the most likely                                 one right now in terms of orchestration                                 but once it's in a container and you                                 know there's some there's the whole idea                                 of stateful sets which may or not be a                                 good idea for us or maybe we just for                                 all of our cat for all of our stateless                                 services we use kubernetes but for solar                                 we write our own scheduler that that                                 knows a little bit more about solar and                                 about how we want to run them and we use                                 that to schedule our containers we're                                 not exactly sure yet we're still                                 figuring that out                                 I have a question queue                                 yeah so you are talking about streaming                                 in the solar yeah what are you using to                                 do that and what are the performance                                 considerations for like generating an                                 index that way so I am NOT an expert on                                 streaming yet we have one on our team                                 dennis cove so as far as the performance                                 he has told me that he has done some                                 really impressive performance tests and                                 i've seen the numbers and they look                                 really really good I don't have any of                                 them available to show you right now but                                 if you want we can talk after and I can                                 see if I can dig some up for you the                                 answer the answer I think you're                                 requesting is it's impressive the exact                                 answer I guess is also it depends I mean                                 there's a lot of factors when you're                                 talking about indexing there's what kind                                 of hardware am i running on how many                                 nodes do I have in my cluster how many                                 shards how am i sharding my cluster you                                 know the same sort of config                                 considerations that were doing when you                                 do a single you know update request                                 cool thanks Ben definitely I'd like to                                 talk about it afterwards sure any other                                 questions all right thank Ken again                                 [Applause]
YouTube URL: https://www.youtube.com/watch?v=zag4IrC4z1k


