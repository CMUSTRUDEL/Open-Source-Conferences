Title: Writing Viruses for Fun, not Profit | Ben Dechrai | IPC Spring 2018
Publication date: 2019-01-23
Playlist: International PHP Conference Spring 2018
Description: 
	Ben Dechrai (CTO for Hire): Going viral hasnâ€™t always been considered good. Whether youâ€™re fighting the common cold, or trying to remove the ILOVEYOU computer worm from your corporate file server, two things are certain: your immune system is based on your gut health, and computers have really poor gut health.

Stopping viruses is hard. The main reason for this is that viruses are really clever. Theyâ€™ve evolved over time to escape detection. Each previously detected virus allows the next iteration of the virus to become more resilient. The second reason is that your computerâ€™s gut health has to fight every virus, whereas each virus just has to find one immuno-compromised system to survive.

Letâ€™s work out how viruses hide. How to they sneak past the checkpoints. How they attach themselves to your system. How they fight detection, and removal. Weâ€™ll look at aspects such as self-replication, cryptographic obfuscation, and touch on methods of delivery and infection.

Now that youâ€™re thinking like a virus writer, you can anticipate which areas of your applications need hardening. Just remember, weâ€™re doing it for good, not profit ðŸ™‚

This presentation will feature live demos of writing viruses, and infection of willing targets. An understanding of PHP is not required.
Captions: 
	00:00:05,990 --> 00:00:12,559
good evening

00:00:09,290 --> 00:00:16,369
finally finally a real technical keynote

00:00:12,559 --> 00:00:18,859
whose develop in the room miss sharp

00:00:16,369 --> 00:00:23,580
almost who's not available in the room

00:00:18,859 --> 00:00:25,199
okay just a few hands ah okay finally a

00:00:23,580 --> 00:00:27,990
real technical keynote

00:00:25,199 --> 00:00:32,430
it's about viruses but not for profit

00:00:27,990 --> 00:00:34,110
but for fun and for this oh but before

00:00:32,430 --> 00:00:36,210
announce the keynote speaker and let me

00:00:34,110 --> 00:00:38,280
please mention that of course like

00:00:36,210 --> 00:00:40,200
yesterday night after the keynote there

00:00:38,280 --> 00:00:42,420
will be beer outside and we hope that

00:00:40,200 --> 00:00:45,000
Ben is stopping in time because he also

00:00:42,420 --> 00:00:47,789
said he's thirsty for beer yeah so after

00:00:45,000 --> 00:00:49,680
the keynote you also if provided there

00:00:47,789 --> 00:00:52,320
are some snacks and of course beer and

00:00:49,680 --> 00:00:54,870
soft drinks served outside but coming

00:00:52,320 --> 00:00:57,449
back to the keynote it's about writing

00:00:54,870 --> 00:00:59,730
viruses and you'll see coat and yuzu

00:00:57,449 --> 00:01:02,160
demos and I would just say I'm very

00:00:59,730 --> 00:01:04,199
happy that Ben to be honest I don't know

00:01:02,160 --> 00:01:07,460
exactly how to pronounce your second

00:01:04,199 --> 00:01:10,590
names your last name Tech Riordan yeah

00:01:07,460 --> 00:01:12,299
he came directly from Melbourne

00:01:10,590 --> 00:01:14,189
Australia and I've just heard his bow he

00:01:12,299 --> 00:01:15,180
was born in Mainz Germany yeah that's

00:01:14,189 --> 00:01:19,400
crazy

00:01:15,180 --> 00:01:19,400
so please welcome Ben for the keynote

00:01:19,810 --> 00:01:38,640
[Applause]

00:01:21,360 --> 00:01:41,740
thanks Melissa I love you so big my doom

00:01:38,640 --> 00:01:43,630
that's not actually the worst poem ever

00:01:41,740 --> 00:01:46,229
if anybody knows Hitchhiker's Guide

00:01:43,630 --> 00:01:49,990
Vogon poetry is the worst poetry ever

00:01:46,229 --> 00:01:54,910
those are the first four viruses that we

00:01:49,990 --> 00:01:57,970
saw on mass Melissa came out in 1999

00:01:54,910 --> 00:02:01,060
does anybody remember Melissa I'm glad

00:01:57,970 --> 00:02:04,899
I'm not the only one showing my age it

00:02:01,060 --> 00:02:05,950
infected 20% of computers worldwide you

00:02:04,899 --> 00:02:07,570
could argue there weren't very many

00:02:05,950 --> 00:02:10,660
computers back then but there was still

00:02:07,570 --> 00:02:12,600
a lot of computers in 2000 I love you

00:02:10,660 --> 00:02:17,110
attacked tens of millions of computers

00:02:12,600 --> 00:02:19,030
so Baek was in 2003 followed in 2004 by

00:02:17,110 --> 00:02:22,420
Maya doom which caused an estimated 38

00:02:19,030 --> 00:02:27,579
billion US dollars of damage viruses are

00:02:22,420 --> 00:02:30,220
nasty but we want to have some fun here

00:02:27,579 --> 00:02:31,180
tonight it's the end of a long day some

00:02:30,220 --> 00:02:32,650
we're going to dwell on the nastiness

00:02:31,180 --> 00:02:34,329
too much except for the fun parts of

00:02:32,650 --> 00:02:36,010
doing it but before we go any further

00:02:34,329 --> 00:02:37,959
I'm going to be one of those presenters

00:02:36,010 --> 00:02:42,579
I'm going to ask you to all stand up

00:02:37,959 --> 00:02:44,440
please because what we're doing here is

00:02:42,579 --> 00:02:49,570
very dangerous somebody could actually

00:02:44,440 --> 00:02:55,079
die so I need you to repeat after me the

00:02:49,570 --> 00:02:57,070
delegates pledge I insert your name

00:02:55,079 --> 00:02:59,790
pledge to use the following information

00:02:57,070 --> 00:02:59,790
for good

00:03:00,480 --> 00:03:05,160
if I fail to uphold this pledge I

00:03:05,370 --> 00:03:13,750
promise to commit to 200 hours of

00:03:07,540 --> 00:03:18,670
community service offering IT support

00:03:13,750 --> 00:03:20,349
via Twitter you are all now legally

00:03:18,670 --> 00:03:26,980
beholden upon this thank you very much

00:03:20,349 --> 00:03:29,019
you can sit down again so what is a

00:03:26,980 --> 00:03:30,430
virus the virus essentially has three

00:03:29,019 --> 00:03:32,049
main components you have an infection

00:03:30,430 --> 00:03:34,750
mechanism we need to get the virus into

00:03:32,049 --> 00:03:37,750
a system somehow then you have a payload

00:03:34,750 --> 00:03:39,640
which is the thing that happens and you

00:03:37,750 --> 00:03:42,069
have a trigger which is what makes it

00:03:39,640 --> 00:03:44,440
happen it could be that as soon as the

00:03:42,069 --> 00:03:46,540
virus gets uploaded it activates itself

00:03:44,440 --> 00:03:48,220
straightaway but on the other hand maybe

00:03:46,540 --> 00:03:50,019
you want to wait for something and we'll

00:03:48,220 --> 00:03:53,829
think of some of some ideas why we might

00:03:50,019 --> 00:03:55,870
do that later but what we would really

00:03:53,829 --> 00:03:58,750
want to know about it is how they

00:03:55,870 --> 00:04:00,190
detected because there's no point in

00:03:58,750 --> 00:04:01,690
writing a virus that can be detected so

00:04:00,190 --> 00:04:04,239
let's have a look at how systems

00:04:01,690 --> 00:04:07,209
antivirus systems look at viruses and

00:04:04,239 --> 00:04:09,970
work out that they're malicious so

00:04:07,209 --> 00:04:12,100
there's spread detection if an

00:04:09,970 --> 00:04:13,389
anti-virus software for example would

00:04:12,100 --> 00:04:14,650
have a look at the file system and if

00:04:13,389 --> 00:04:16,359
there's a lot of files being changed

00:04:14,650 --> 00:04:18,700
very quickly perhaps there's something

00:04:16,359 --> 00:04:20,530
not really right going on it's very rare

00:04:18,700 --> 00:04:21,459
that that happens and in fact you've

00:04:20,530 --> 00:04:23,229
probably seen if you're running

00:04:21,459 --> 00:04:25,240
antivirus software that when you run

00:04:23,229 --> 00:04:28,450
other software that's supposed to modify

00:04:25,240 --> 00:04:29,979
lots of files like a compaction software

00:04:28,450 --> 00:04:31,900
or a hard drive cleanup process that

00:04:29,979 --> 00:04:34,740
will come up and say there's suspicious

00:04:31,900 --> 00:04:38,349
activity so it can detect that way

00:04:34,740 --> 00:04:40,210
analysis detection maybe the virus isn't

00:04:38,349 --> 00:04:41,650
actually modifying lots of files but

00:04:40,210 --> 00:04:44,320
it's working out what your system is is

00:04:41,650 --> 00:04:45,880
it may be trying to find network

00:04:44,320 --> 00:04:49,479
mappings so that it can connect to

00:04:45,880 --> 00:04:50,919
networks and spread even further and of

00:04:49,479 --> 00:04:52,389
course they're stealing resources if the

00:04:50,919 --> 00:04:54,970
virus is actually running it's going to

00:04:52,389 --> 00:04:56,260
be using of memory if it's writing lots

00:04:54,970 --> 00:04:58,510
of files is going to be taking up disk

00:04:56,260 --> 00:05:00,820
space so they look for anomalies most

00:04:58,510 --> 00:05:03,160
virus detection systems look for

00:05:00,820 --> 00:05:06,940
anomalies so we need to avoid all of

00:05:03,160 --> 00:05:09,849
those anomalies we need to evade them so

00:05:06,940 --> 00:05:11,259
if we look at other security systems how

00:05:09,849 --> 00:05:16,889
they act

00:05:11,259 --> 00:05:20,110
after September 11 there was an analysis

00:05:16,889 --> 00:05:21,310
way after like a few years after the

00:05:20,110 --> 00:05:23,560
u.s. implemented a lot of these

00:05:21,310 --> 00:05:28,560
backscatter x-ray machines in order to

00:05:23,560 --> 00:05:30,580
detect malicious no viruses but people

00:05:28,560 --> 00:05:32,499
and there was a comparison made between

00:05:30,580 --> 00:05:34,689
the Israeli Airport and the US Airport

00:05:32,499 --> 00:05:36,159
in the azure its Ray the airport head of

00:05:34,689 --> 00:05:37,960
security wasn't implementing any

00:05:36,159 --> 00:05:41,259
backscatter methodology he was still

00:05:37,960 --> 00:05:43,419
employing only metal detectors and he

00:05:41,259 --> 00:05:45,219
was quoted as saying whereas most

00:05:43,419 --> 00:05:48,879
airports look at the contents of your

00:05:45,219 --> 00:05:50,379
luggage we look at the people if we look

00:05:48,879 --> 00:05:51,009
at somebody we say well this is not a

00:05:50,379 --> 00:05:53,020
terrorist

00:05:51,009 --> 00:05:56,319
then we don't mind if they take water on

00:05:53,020 --> 00:05:58,389
the plane whereas most every other

00:05:56,319 --> 00:06:01,000
country in the world says you can't take

00:05:58,389 --> 00:06:05,789
water on the plane that's water but

00:06:01,000 --> 00:06:08,860
that'll kill somebody maybe I don't know

00:06:05,789 --> 00:06:11,560
so the way to get by most airport

00:06:08,860 --> 00:06:14,879
security not sure whether I should say

00:06:11,560 --> 00:06:17,500
this out loud am I get arrested is to

00:06:14,879 --> 00:06:18,879
look like you're in the right place at

00:06:17,500 --> 00:06:20,919
the right time you're not standing out

00:06:18,879 --> 00:06:24,039
so we want our viruses to not stand out

00:06:20,919 --> 00:06:25,569
either and also want to adapt and evolve

00:06:24,039 --> 00:06:27,310
if you notice that somebody's looking at

00:06:25,569 --> 00:06:28,270
you and maybe your mannerism slightly

00:06:27,310 --> 00:06:29,529
strange as you're walking through the

00:06:28,270 --> 00:06:30,550
airport maybe you'll change the way you

00:06:29,529 --> 00:06:32,379
walk maybe you'll change the direction

00:06:30,550 --> 00:06:33,639
you're going into maybe you're about to

00:06:32,379 --> 00:06:36,810
put that suitcase down but you don't put

00:06:33,639 --> 00:06:39,129
the suitcase down you adapt and change

00:06:36,810 --> 00:06:40,479
and then you can obfuscate yourself I

00:06:39,129 --> 00:06:42,219
don't have an analogy for this in

00:06:40,479 --> 00:06:45,250
airports because I can't turn myself

00:06:42,219 --> 00:06:46,360
into a window but if you can make

00:06:45,250 --> 00:06:48,699
yourself look like something that's

00:06:46,360 --> 00:06:53,310
completely different to what it actually

00:06:48,699 --> 00:06:55,300
is almost see-through chameleon-like

00:06:53,310 --> 00:06:57,189
then it's easier to get through

00:06:55,300 --> 00:06:58,419
detection systems if you encrypt

00:06:57,189 --> 00:07:00,279
yourself if you scramble yourself up

00:06:58,419 --> 00:07:02,259
completely so nobody's got any idea what

00:07:00,279 --> 00:07:03,719
it is some systems might say this looks

00:07:02,259 --> 00:07:07,719
a bit strange I don't know what it is

00:07:03,719 --> 00:07:09,490
but it might stall it it through if you

00:07:07,719 --> 00:07:11,199
act benign looked like something how

00:07:09,490 --> 00:07:13,300
many people have installed an app on

00:07:11,199 --> 00:07:15,069
their mobile phone in the past year say

00:07:13,300 --> 00:07:16,930
that they haven't really done a lot of

00:07:15,069 --> 00:07:17,860
background research on as to whether it

00:07:16,930 --> 00:07:19,419
does the right thing but it's got a

00:07:17,860 --> 00:07:23,589
really cool functionality that I've just

00:07:19,419 --> 00:07:24,639
got to have yeah so maybe you will write

00:07:23,589 --> 00:07:26,979
one of those

00:07:24,639 --> 00:07:31,530
not today the iOS developers from way

00:07:26,979 --> 00:07:33,669
harder than than hacking viruses and PHP

00:07:31,530 --> 00:07:36,129
once you're in lay dormant don't do

00:07:33,669 --> 00:07:37,389
anything don't stand out just wait it

00:07:36,129 --> 00:07:39,129
gives you time to analyze slowly

00:07:37,389 --> 00:07:40,840
remember at the beginning I said we want

00:07:39,129 --> 00:07:42,189
to go slowly because what I'll say that

00:07:40,840 --> 00:07:43,960
again in a second going slowly means

00:07:42,189 --> 00:07:46,599
that it's harder to be detected and once

00:07:43,960 --> 00:07:48,310
you're in take it slow don't scan the

00:07:46,599 --> 00:07:50,639
whole network don't modify every file

00:07:48,310 --> 00:07:52,479
maybe do three at a time and that way

00:07:50,639 --> 00:07:57,219
detection systems are less likely to

00:07:52,479 --> 00:07:59,319
find what you're doing but you don't

00:07:57,219 --> 00:08:00,550
care about that deal you just want to

00:07:59,319 --> 00:08:04,120
see a demo which is fair enough because

00:08:00,550 --> 00:08:07,000
that's why I'm here too so I'm hoping

00:08:04,120 --> 00:08:13,080
that everybody can read that if not feel

00:08:07,000 --> 00:08:15,610
free to come on down I have a demo here

00:08:13,080 --> 00:08:16,900
which I tested just before so I'm gonna

00:08:15,610 --> 00:08:19,719
make sure that it's all fine

00:08:16,900 --> 00:08:21,490
yep that's fine so because it's very

00:08:19,719 --> 00:08:23,529
hard to type and talk at the same time I

00:08:21,490 --> 00:08:27,460
cheat and I have this mechanism

00:08:23,529 --> 00:08:28,360
that'll type for me means that I can

00:08:27,460 --> 00:08:30,400
talk to you and explain what's actually

00:08:28,360 --> 00:08:31,960
going on so we're going to write our own

00:08:30,400 --> 00:08:34,690
virus and we're going to call it boom

00:08:31,960 --> 00:08:36,550
dot php' because it's going to go boom

00:08:34,690 --> 00:08:37,659
obviously but I actually have sound in

00:08:36,550 --> 00:08:40,570
this maybe I should add that for the

00:08:37,659 --> 00:08:42,219
next time so as far as essentially going

00:08:40,570 --> 00:08:43,479
to check each file it's gonna open all

00:08:42,219 --> 00:08:46,390
the PHP files in the current directory

00:08:43,479 --> 00:08:47,920
and then it's going to go through yep

00:08:46,390 --> 00:08:50,529
that demo is already looking great isn't

00:08:47,920 --> 00:08:52,209
it it's going to go through and for each

00:08:50,529 --> 00:08:54,459
of the file names it's going to look at

00:08:52,209 --> 00:08:57,870
those files and then it's going to open

00:08:54,459 --> 00:09:02,010
the file that's not looking great at it

00:08:57,870 --> 00:09:06,399
let me just see if changing the size

00:09:02,010 --> 00:09:11,010
will help so we're going to go through

00:09:06,399 --> 00:09:16,990
each file and open the file in read mode

00:09:11,010 --> 00:09:19,570
that's looking rubbish so at this point

00:09:16,990 --> 00:09:24,750
here what usually happens is I come in

00:09:19,570 --> 00:09:24,750
here and we're gonna kill that

00:09:25,990 --> 00:09:43,630
this is the best bit of bad live demos

00:09:29,339 --> 00:09:45,550
and I want to find that one does imagine

00:09:43,630 --> 00:09:48,490
me so what we're gonna do now is we're

00:09:45,550 --> 00:09:51,010
going to look at da boom always have a

00:09:48,490 --> 00:09:53,020
backup so this is the file that I want

00:09:51,010 --> 00:09:55,959
to short talk you through can you see

00:09:53,020 --> 00:09:57,220
that are back given that I'm not using

00:09:55,959 --> 00:10:00,940
my audio type or I can actually make it

00:09:57,220 --> 00:10:02,260
via net so we want to get a list of all

00:10:00,940 --> 00:10:04,480
the files in the system obviously we

00:10:02,260 --> 00:10:07,510
want to infect PHP set files because we

00:10:04,480 --> 00:10:08,649
are writing a PHP file so glob star PHP

00:10:07,510 --> 00:10:10,120
is going to find all the files we're

00:10:08,649 --> 00:10:11,950
gonna going to then iterate through

00:10:10,120 --> 00:10:14,080
those files open each one of them in

00:10:11,950 --> 00:10:15,700
read mode now we could open it in read

00:10:14,080 --> 00:10:17,620
write mode because obviously we want to

00:10:15,700 --> 00:10:19,000
write a new virus to it but sometimes

00:10:17,620 --> 00:10:21,490
the permissions don't allow you to do

00:10:19,000 --> 00:10:23,770
that and sometimes systems will detect

00:10:21,490 --> 00:10:25,330
an update to a file more so than they

00:10:23,770 --> 00:10:27,760
would a renaming so we're going to go

00:10:25,330 --> 00:10:29,830
with the process of take the open a file

00:10:27,760 --> 00:10:31,930
and then create a copy of that file and

00:10:29,830 --> 00:10:33,760
as we're creating that copy but the

00:10:31,930 --> 00:10:35,620
virus inside and then we'll delete that

00:10:33,760 --> 00:10:38,500
one and move this one over it's less

00:10:35,620 --> 00:10:39,640
likely to be picked up so free to the

00:10:38,500 --> 00:10:41,410
file so can go through we're going to

00:10:39,640 --> 00:10:43,990
open it we're going to create another

00:10:41,410 --> 00:10:45,339
file called file name dot infected and

00:10:43,990 --> 00:10:48,459
into there we're going to write file

00:10:45,339 --> 00:10:49,630
infected as a PHP comment as you can

00:10:48,459 --> 00:10:50,740
imagine it's not going to do very much

00:10:49,630 --> 00:10:55,060
another one which is the proof of

00:10:50,740 --> 00:10:59,829
concept so we then put that string into

00:10:55,060 --> 00:11:01,029
the file into the infected file and then

00:10:59,829 --> 00:11:03,520
what we do is we loop through the

00:11:01,029 --> 00:11:05,170
original file for each of the lines we

00:11:03,520 --> 00:11:07,720
then write the original line into the

00:11:05,170 --> 00:11:10,000
copy of the file so we had the original

00:11:07,720 --> 00:11:12,130
file a blank file we wrote a virus line

00:11:10,000 --> 00:11:14,079
or the comment into the top and then

00:11:12,130 --> 00:11:16,300
line by line we copy it in for this file

00:11:14,079 --> 00:11:19,209
now is that a copy of that one except it

00:11:16,300 --> 00:11:21,279
has that first file infected line and

00:11:19,209 --> 00:11:22,690
then we close both of the scripts we

00:11:21,279 --> 00:11:24,339
delete the original and we rename the

00:11:22,690 --> 00:11:31,029
new one to the original so now we're

00:11:24,339 --> 00:11:31,810
infected so for now copy boom - boom on

00:11:31,029 --> 00:11:34,870
where I should be

00:11:31,810 --> 00:11:36,339
so let's have a quick look at another

00:11:34,870 --> 00:11:38,580
father I've got in here it's called

00:11:36,339 --> 00:11:48,280
exemple

00:11:38,580 --> 00:11:49,720
can any media tell me what this does if

00:11:48,280 --> 00:11:50,620
I heard mumbles but I'm assuming you all

00:11:49,720 --> 00:11:56,230
say it prints the numbers one through

00:11:50,620 --> 00:11:58,510
nine it's fantastic it's the most

00:11:56,230 --> 00:12:00,040
complicated script I've ever written and

00:11:58,510 --> 00:12:04,200
so now what we're going to do is we're

00:12:00,040 --> 00:12:04,200
going to run boom

00:12:14,280 --> 00:12:18,180
it's the moment where after having

00:12:16,710 --> 00:12:20,040
tested it a number of times and it goes

00:12:18,180 --> 00:12:34,440
wrong you stand here and go hmm

00:12:20,040 --> 00:12:38,490
interesting isn't that fun um I'm going

00:12:34,440 --> 00:12:43,130
to see whether the next step works just

00:12:38,490 --> 00:12:43,130
to see if there's an issue in the system

00:12:47,600 --> 00:12:57,960
okay that one seems to work so what I'm

00:12:57,000 --> 00:12:59,670
going to do is go straight on to the

00:12:57,960 --> 00:13:00,930
next step and we'll see the activity

00:12:59,670 --> 00:13:03,000
that happened in the first step go

00:13:00,930 --> 00:13:05,310
through so this is a very similar script

00:13:03,000 --> 00:13:08,220
but what we've done is we've added it

00:13:05,310 --> 00:13:10,640
into an execute function so we've still

00:13:08,220 --> 00:13:12,570
got the filenames get all the PHP files

00:13:10,640 --> 00:13:14,400
and we're still going to go through em

00:13:12,570 --> 00:13:16,380
we're going to open more and we're going

00:13:14,400 --> 00:13:18,270
to infect them but at this time what

00:13:16,380 --> 00:13:20,850
we're doing is we're passing dollar

00:13:18,270 --> 00:13:22,200
virus in as a parameter to the top so

00:13:20,850 --> 00:13:23,790
instead of writing that comment virus

00:13:22,200 --> 00:13:26,730
we're actually gonna write a real virus

00:13:23,790 --> 00:13:30,930
in because just putting a comment in

00:13:26,730 --> 00:13:32,190
it's not really gonna help anyone so the

00:13:30,930 --> 00:13:34,230
only difference on this line here is

00:13:32,190 --> 00:13:35,670
you'll notice that on the approximately

00:13:34,230 --> 00:13:37,620
six line down we've got infection

00:13:35,670 --> 00:13:39,270
instead of PHP comments we've got PHP

00:13:37,620 --> 00:13:42,839
dollar virus that the virus Lois passed

00:13:39,270 --> 00:13:46,350
in through the function and then down at

00:13:42,839 --> 00:13:48,000
the bottom here we're going to get the

00:13:46,350 --> 00:13:49,740
file contents of the current file so

00:13:48,000 --> 00:13:51,510
double unders double underscore file

00:13:49,740 --> 00:13:54,089
double underscore is a pH reference to

00:13:51,510 --> 00:13:56,370
the script that is currently running so

00:13:54,089 --> 00:13:59,070
we're saying open yourself read all your

00:13:56,370 --> 00:14:04,589
contents in and put it into a variable

00:13:59,070 --> 00:14:06,300
called virus now further up when we

00:14:04,589 --> 00:14:09,180
printed that virus out we put it inside

00:14:06,300 --> 00:14:11,490
PHP brackets but this file starts with a

00:14:09,180 --> 00:14:15,030
PHP bracket which means effectively we

00:14:11,490 --> 00:14:16,500
would have open PHP open PHP and then

00:14:15,030 --> 00:14:18,300
the virus which is obviously not going

00:14:16,500 --> 00:14:20,070
to work so you'll notice in there we

00:14:18,300 --> 00:14:21,660
also have a couple of sub strings so I'm

00:14:20,070 --> 00:14:23,640
going to see sayers look for a couple of

00:14:21,660 --> 00:14:25,050
markers the virus end that you can see

00:14:23,640 --> 00:14:26,670
at the bottom and if we scroll back up

00:14:25,050 --> 00:14:27,620
to the top you'll see the virus start at

00:14:26,670 --> 00:14:29,510
the top

00:14:27,620 --> 00:14:30,770
you're gonna trim that out so no matter

00:14:29,510 --> 00:14:33,470
what comes before us and what comes

00:14:30,770 --> 00:14:35,420
after it that's the only part of the

00:14:33,470 --> 00:14:37,790
virus that we want and this is going to

00:14:35,420 --> 00:14:40,130
help us in the future when an infected

00:14:37,790 --> 00:14:41,810
file an actually infected file runs

00:14:40,130 --> 00:14:43,279
itself because anything before it never

00:14:41,810 --> 00:14:45,860
anything after it will be the original

00:14:43,279 --> 00:14:47,930
file which we have no idea what that is

00:14:45,860 --> 00:14:48,950
we only want the virus components so

00:14:47,930 --> 00:14:56,870
we've got these markers and we're going

00:14:48,950 --> 00:14:59,870
to pull the virus out so I also haven't

00:14:56,870 --> 00:15:03,230
have example PHP in step two which is

00:14:59,870 --> 00:15:05,630
exactly the same thing now if I run PHP

00:15:03,230 --> 00:15:07,820
boom you'll notice that nothing happens

00:15:05,630 --> 00:15:10,100
and this is a desirable outcome for a

00:15:07,820 --> 00:15:12,050
virus infecting something you don't want

00:15:10,100 --> 00:15:14,660
there to be any kind of changed or

00:15:12,050 --> 00:15:17,330
altered output but if we look at the

00:15:14,660 --> 00:15:23,450
example PHP file now we'll see it says

00:15:17,330 --> 00:15:25,600
infected because I hadn't copied boom to

00:15:23,450 --> 00:15:25,600
boom

00:15:29,020 --> 00:15:32,720
so I'll run it again and now we're look

00:15:31,610 --> 00:15:35,360
at example we'll see that there's a

00:15:32,720 --> 00:15:36,380
virus in there so originally it just

00:15:35,360 --> 00:15:40,160
said echo the numbers one through nine

00:15:36,380 --> 00:15:42,709
and now it says here's a virus if we

00:15:40,160 --> 00:15:45,190
scroll to the bottom of this we'll see

00:15:42,709 --> 00:15:47,839
the original echo one through nine and

00:15:45,190 --> 00:15:49,820
you'll see the virus end there so when

00:15:47,839 --> 00:15:55,120
it then effects something effect let's

00:15:49,820 --> 00:15:55,120
try that we're going to make a new file

00:16:08,570 --> 00:16:16,610
perfect hallo forgot the line-break but

00:16:11,130 --> 00:16:20,060
there we go so now if I run example.com

00:16:16,610 --> 00:16:20,060
what do you think's gonna happen

00:16:20,930 --> 00:16:32,160
who will be infected any other thoughts

00:16:25,820 --> 00:16:33,120
sorry example will reinfect yourself do

00:16:32,160 --> 00:16:43,200
you think bloom will be coming

00:16:33,120 --> 00:16:48,900
reinfected it looks fine but I can't

00:16:43,200 --> 00:16:51,390
type so here we have boom at the top

00:16:48,900 --> 00:16:53,330
when we got the virus start and in fact

00:16:51,390 --> 00:16:56,490
if I do a search for virus

00:16:53,330 --> 00:17:00,330
we've got virus start a virus virus

00:16:56,490 --> 00:17:02,339
virus end and then we've got virus and

00:17:00,330 --> 00:17:05,900
then we've got virus tout say yes we get

00:17:02,339 --> 00:17:09,089
the reinfection but we also see that the

00:17:05,900 --> 00:17:10,770
foo has also been affected so it's

00:17:09,089 --> 00:17:13,709
reinfecting itself now the issue with

00:17:10,770 --> 00:17:16,800
this is if I run boom again we get an

00:17:13,709 --> 00:17:19,620
error so because we've now got to

00:17:16,800 --> 00:17:24,089
execute functions in the same script it

00:17:19,620 --> 00:17:25,410
breaks so what we really need to do is

00:17:24,089 --> 00:17:28,500
make sure that the file doesn't reinfect

00:17:25,410 --> 00:17:32,720
itself twice it's funny you should say

00:17:28,500 --> 00:17:32,720
that because I have an example for that

00:17:34,010 --> 00:17:44,240
fact let me copy this over first before

00:17:36,179 --> 00:17:44,240
I forget so

00:17:46,789 --> 00:17:51,929
actually before we do that I forgot the

00:17:49,890 --> 00:17:52,710
encryption step so the virus is in

00:17:51,929 --> 00:17:56,370
plaintext

00:17:52,710 --> 00:17:57,929
which means that if you have a piece of

00:17:56,370 --> 00:18:00,929
text at the top of your script that says

00:17:57,929 --> 00:18:02,640
start a virus what do you think an

00:18:00,929 --> 00:18:08,070
anti-virus software application is going

00:18:02,640 --> 00:18:10,440
to do so we're going to make scrambled

00:18:08,070 --> 00:18:14,220
egg going to encrypt it so essentially

00:18:10,440 --> 00:18:15,659
I've just wrapped on this line here not

00:18:14,220 --> 00:18:17,399
very easy to read but that line there

00:18:15,659 --> 00:18:19,950
the virus is now wrapped in the

00:18:17,399 --> 00:18:21,149
encrypted virus function so we're going

00:18:19,950 --> 00:18:22,260
to encrypt it I'm not going to go

00:18:21,149 --> 00:18:25,610
through the encryption in too much

00:18:22,260 --> 00:18:28,380
detail and but for anybody who's used

00:18:25,610 --> 00:18:29,760
encrypt it's not really recommended

00:18:28,380 --> 00:18:31,440
anymore but you know what I'm writing a

00:18:29,760 --> 00:18:33,210
virus I don't want cryptographically Z

00:18:31,440 --> 00:18:35,580
or content I just want scrambled content

00:18:33,210 --> 00:18:37,770
that I can undo hashing obviously you

00:18:35,580 --> 00:18:39,870
can't do encryption you need to so for

00:18:37,770 --> 00:18:41,669
our purposes encrypt is fine don't use

00:18:39,870 --> 00:18:44,730
it in production environments for

00:18:41,669 --> 00:18:46,110
absolutely secure data but essentially

00:18:44,730 --> 00:18:48,270
we need key we need an initialization

00:18:46,110 --> 00:18:50,460
vector we need the payload which is our

00:18:48,270 --> 00:18:54,840
virus itself we're going to pass it into

00:18:50,460 --> 00:18:57,149
the M crypt encrypt method now the issue

00:18:54,840 --> 00:18:59,610
now is that we've got an encrypted virus

00:18:57,149 --> 00:19:03,570
so how do or encrypted payload just a

00:18:59,610 --> 00:19:05,220
string random binary thing how do we

00:19:03,570 --> 00:19:08,210
execute that how do we put that back

00:19:05,220 --> 00:19:11,070
into the script so what we need to do is

00:19:08,210 --> 00:19:13,279
encode it we're going to take the

00:19:11,070 --> 00:19:19,919
initialization vector the key and the

00:19:13,279 --> 00:19:23,700
encrypted version of the virus and we're

00:19:19,919 --> 00:19:25,770
going to be 64 encode them so the main

00:19:23,700 --> 00:19:27,360
reason for this is because we don't know

00:19:25,770 --> 00:19:28,909
what character sets were playing with we

00:19:27,360 --> 00:19:31,679
don't want things to break

00:19:28,909 --> 00:19:33,360
putting binary into another text file

00:19:31,679 --> 00:19:35,460
would probably be a flag for an

00:19:33,360 --> 00:19:37,620
antivirus mechanism so we're going to

00:19:35,460 --> 00:19:39,960
pay 64 encoded and then we're going to

00:19:37,620 --> 00:19:42,149
create and notice we're doing this all

00:19:39,960 --> 00:19:46,460
as a string so there's a string called

00:19:42,149 --> 00:19:49,409
payload and inside that we're defining

00:19:46,460 --> 00:19:50,730
the variable name we're not actually

00:19:49,409 --> 00:19:52,110
assigning it to that variable name of

00:19:50,730 --> 00:19:54,390
the moment which is making a string that

00:19:52,110 --> 00:19:55,880
says if you executed this a variable

00:19:54,390 --> 00:19:58,320
would have a value assigned to it and

00:19:55,880 --> 00:20:01,770
then we decrypt it

00:19:58,320 --> 00:20:03,930
we evaluate it so this point is where we

00:20:01,770 --> 00:20:06,930
then execute it because we're evaluating

00:20:03,930 --> 00:20:09,750
this code which means we now have an

00:20:06,930 --> 00:20:12,330
execute method in memory because we just

00:20:09,750 --> 00:20:15,090
evaluated the uncompressed version of

00:20:12,330 --> 00:20:18,090
the virus we can then call exeed down at

00:20:15,090 --> 00:20:19,500
the bottom there we return that payload

00:20:18,090 --> 00:20:22,350
and that gets that's what gets put into

00:20:19,500 --> 00:20:25,980
the file at the top the rest of remains

00:20:22,350 --> 00:20:28,080
unchanged so if we have a look at

00:20:25,980 --> 00:20:31,470
example so we've still got the one

00:20:28,080 --> 00:20:32,090
through nine we run it we still got the

00:20:31,470 --> 00:20:37,770
one through nine

00:20:32,090 --> 00:20:39,600
if I run boom and then we have a look at

00:20:37,770 --> 00:20:40,280
example we'll see something very

00:20:39,600 --> 00:20:43,200
different

00:20:40,280 --> 00:20:45,720
there's no begin marker anymore there's

00:20:43,200 --> 00:20:48,200
no end marker anymore we've got a very

00:20:45,720 --> 00:20:52,560
long encrypted string base64 encoded

00:20:48,200 --> 00:20:54,540
payload we've got an IV and a key now

00:20:52,560 --> 00:20:56,400
again in production systems you wouldn't

00:20:54,540 --> 00:20:58,830
actually publish your key because that's

00:20:56,400 --> 00:21:00,060
what keeps it all secure but we're not

00:20:58,830 --> 00:21:03,390
looking for security we're looking for

00:21:00,060 --> 00:21:05,850
obfuscation so we put those in and then

00:21:03,390 --> 00:21:07,170
the EM crypt decrypt which was

00:21:05,850 --> 00:21:09,300
previously in a string which has now

00:21:07,170 --> 00:21:11,340
been written in is actually executed so

00:21:09,300 --> 00:21:13,080
the result of that is we have an execute

00:21:11,340 --> 00:21:24,300
method which then gets called down to

00:21:13,080 --> 00:21:26,520
the bottom so I could do another example

00:21:24,300 --> 00:21:29,640
with foo and show that it infects that

00:21:26,520 --> 00:21:31,890
as well but if we skip on to step four

00:21:29,640 --> 00:21:33,360
we'll look at the way of stopping HID

00:21:31,890 --> 00:21:35,910
reinfecting itself twice which was the

00:21:33,360 --> 00:21:38,420
issue we found back in step two so let's

00:21:35,910 --> 00:21:38,420
have a look at that

00:21:44,240 --> 00:21:50,790
so the main changes in this file if you

00:21:49,800 --> 00:21:52,770
look down towards the bottom there

00:21:50,790 --> 00:21:54,090
you've got a check not infected we want

00:21:52,770 --> 00:21:57,600
to make sure we only infect every file

00:21:54,090 --> 00:21:59,880
once so in order to do this we need some

00:21:57,600 --> 00:22:01,470
kind of fingerprint to know whether or

00:21:59,880 --> 00:22:02,730
not it's been affected we could just put

00:22:01,470 --> 00:22:06,120
a flag in there saying in effect it is

00:22:02,730 --> 00:22:09,150
true but a that's gonna attract the

00:22:06,120 --> 00:22:12,510
interest of a antivirus system it's not

00:22:09,150 --> 00:22:15,930
very elegant and also it's a static

00:22:12,510 --> 00:22:17,160
string that could be found so I don't

00:22:15,930 --> 00:22:19,340
know if anybody in here has ever tried

00:22:17,160 --> 00:22:21,450
to clean up an infected WordPress site

00:22:19,340 --> 00:22:22,710
often you'll find something that looks a

00:22:21,450 --> 00:22:25,860
little bit garbage we like the previous

00:22:22,710 --> 00:22:27,990
example we saw and all you've got to do

00:22:25,860 --> 00:22:29,940
is find one file and then you get the

00:22:27,990 --> 00:22:31,800
first twenty characters or so and you

00:22:29,940 --> 00:22:32,910
search your whole directory root for

00:22:31,800 --> 00:22:34,290
that string and I'll give you a list of

00:22:32,910 --> 00:22:36,450
all the files that have been affected so

00:22:34,290 --> 00:22:38,430
if you have a static string it's much

00:22:36,450 --> 00:22:46,950
easier to find we don't people to find

00:22:38,430 --> 00:22:49,890
us so we're going to create a md5 of the

00:22:46,950 --> 00:22:50,790
file name which means that this marker

00:22:49,890 --> 00:22:54,450
is going to be different for every

00:22:50,790 --> 00:22:55,320
single file except index dot PHP it's

00:22:54,450 --> 00:22:58,590
going to be the same for every one of

00:22:55,320 --> 00:23:00,150
those and we're going to read the first

00:22:58,590 --> 00:23:01,290
line out of the original file that we're

00:23:00,150 --> 00:23:02,640
trying to infect and we're going to

00:23:01,290 --> 00:23:05,820
compare it we're gonna say does this

00:23:02,640 --> 00:23:09,390
string the md5 of the file name exist in

00:23:05,820 --> 00:23:13,250
the first line of this file and if it

00:23:09,390 --> 00:23:15,750
does we're not going to reinfect it and

00:23:13,250 --> 00:23:17,100
then in order to actually get it in

00:23:15,750 --> 00:23:18,960
there you'll see further down that we

00:23:17,100 --> 00:23:21,420
created a string that says checksum is

00:23:18,960 --> 00:23:24,630
whatever that hashes the md5 will be

00:23:21,420 --> 00:23:28,290
created and we then insert that into the

00:23:24,630 --> 00:23:29,790
top of the new file and then we insert

00:23:28,290 --> 00:23:32,180
the first line that we pulled out and

00:23:29,790 --> 00:23:34,320
then we insert all the rest of the lines

00:23:32,180 --> 00:23:37,830
so now we've got a copy of the original

00:23:34,320 --> 00:23:44,800
file it starts with a checksum and then

00:23:37,830 --> 00:23:50,950
the viruses on the next line so

00:23:44,800 --> 00:23:52,510
our example file is uninfected and if we

00:23:50,950 --> 00:23:58,360
run BOOM nothing happens that's

00:23:52,510 --> 00:24:00,810
fantastic so if we now create our full

00:23:58,360 --> 00:24:00,810
file again

00:24:13,140 --> 00:24:18,450
that works beautifully - thank you very

00:24:16,290 --> 00:24:22,560
much for coming I notice there's more

00:24:18,450 --> 00:24:25,830
sorry so let's run boom so you can't

00:24:22,560 --> 00:24:28,550
read a click execute so there are

00:24:25,830 --> 00:24:28,550
already in this

00:24:40,160 --> 00:24:47,240
I need to show you this works because

00:24:42,320 --> 00:24:51,920
it's exciting so I'm gonna check out

00:24:47,240 --> 00:24:54,110
boom and example we'll leave foo there

00:24:51,920 --> 00:24:59,270
make sure that's not infected which it

00:24:54,110 --> 00:25:03,470
isn't I'm gonna move dot boom - boom so

00:24:59,270 --> 00:25:08,980
now we should only have the father I

00:25:03,470 --> 00:25:11,930
intend to run so if I now do beautiful

00:25:08,980 --> 00:25:13,760
so I've just run the infection across

00:25:11,930 --> 00:25:15,680
the files in the system and if we look

00:25:13,760 --> 00:25:21,680
at example you know have a check

00:25:15,680 --> 00:25:25,160
somewhere to top and if we look at foo

00:25:21,680 --> 00:25:26,270
we also have a check sum at the top but

00:25:25,160 --> 00:25:28,220
you'll notice the two checksums are

00:25:26,270 --> 00:25:30,260
different because they're based on the

00:25:28,220 --> 00:25:36,670
hash what else do you notice this is

00:25:30,260 --> 00:25:39,680
different the encrypted virus yep so

00:25:36,670 --> 00:25:41,150
when in the virus we said we want to

00:25:39,680 --> 00:25:43,220
insert here an encrypted version of the

00:25:41,150 --> 00:25:45,020
virus rather than at the bottom saying

00:25:43,220 --> 00:25:46,670
generate the virus then encrypted and

00:25:45,020 --> 00:25:50,240
inject that it means that every single

00:25:46,670 --> 00:25:51,440
time that loop runs it regenerated now

00:25:50,240 --> 00:25:52,880
on the one hand you could argue that

00:25:51,440 --> 00:25:55,730
that's probably going to use slightly

00:25:52,880 --> 00:25:58,370
more CPU resources although encrypts

00:25:55,730 --> 00:25:59,630
probably fairly quickly but it does mean

00:25:58,370 --> 00:26:01,790
that you get a different value every

00:25:59,630 --> 00:26:03,170
single time the virus is Rhian cryptid

00:26:01,790 --> 00:26:10,420
because we're generating a random key

00:26:03,170 --> 00:26:13,330
every time and also that's not a friend

00:26:10,420 --> 00:26:16,760
no matter how many times I run boom

00:26:13,330 --> 00:26:22,070
other than that time there you know what

00:26:16,760 --> 00:26:23,480
it is the issue is this is never

00:26:22,070 --> 00:26:25,430
happened before thank you for helping we

00:26:23,480 --> 00:26:27,550
debug this the issue is that the boom is

00:26:25,430 --> 00:26:29,720
an action encrypted version of virus

00:26:27,550 --> 00:26:30,980
therefore when it gets infected because

00:26:29,720 --> 00:26:32,570
there's no marker at the top saying I've

00:26:30,980 --> 00:26:34,670
not been affected it does get double

00:26:32,570 --> 00:26:37,250
entry infected and that's cause the

00:26:34,670 --> 00:26:38,780
issue when I run it but the other two

00:26:37,250 --> 00:26:43,190
files should not have been reinfected so

00:26:38,780 --> 00:26:45,070
if I run PHP example it still runs and I

00:26:43,190 --> 00:26:47,210
can run it as many times as I want

00:26:45,070 --> 00:26:49,240
except I can remove that file as many

00:26:47,210 --> 00:26:57,770
times as I want

00:26:49,240 --> 00:26:58,850
if I run Fuu it's still runs and if we

00:26:57,770 --> 00:27:01,130
look at these two files now we've got

00:26:58,850 --> 00:27:02,480
the checks some of the top and the hello

00:27:01,130 --> 00:27:06,230
at the bottom it's only infected once

00:27:02,480 --> 00:27:08,780
and the same for example but I check

00:27:06,230 --> 00:27:09,980
some the virus it's only being affected

00:27:08,780 --> 00:27:13,310
once even though we've run it over and

00:27:09,980 --> 00:27:14,990
over again so we have a virus of sorts

00:27:13,310 --> 00:27:16,910
we can do things with it well it infects

00:27:14,990 --> 00:27:17,930
itself but it doesn't really do anything

00:27:16,910 --> 00:27:21,710
at the moment

00:27:17,930 --> 00:27:25,550
other than infect other things so what

00:27:21,710 --> 00:27:30,290
we could have a look at now is some

00:27:25,550 --> 00:27:31,490
payload ideas so I have a demo of an

00:27:30,290 --> 00:27:35,720
actual infection which I'll show you in

00:27:31,490 --> 00:27:36,860
a second then in fact 16 minutes I can

00:27:35,720 --> 00:27:41,420
probably even tray you into some of the

00:27:36,860 --> 00:27:44,030
code so we have an opportunity to put a

00:27:41,420 --> 00:27:46,370
payload at the moment all we have is the

00:27:44,030 --> 00:27:48,140
reproduction side of the virus we have

00:27:46,370 --> 00:27:49,790
an opportunity to put a payload into the

00:27:48,140 --> 00:27:52,490
system which means we can actually do

00:27:49,790 --> 00:27:53,960
something once the system is infected so

00:27:52,490 --> 00:27:56,120
we're going to do a demo in a second

00:27:53,960 --> 00:27:58,250
where essentially if you pass in

00:27:56,120 --> 00:28:00,200
anything through an eval request

00:27:58,250 --> 00:28:02,660
it'll just valuated so I'll plunk that

00:28:00,200 --> 00:28:05,360
code into the virus and then we'll

00:28:02,660 --> 00:28:06,590
upload it some way but some other ideas

00:28:05,360 --> 00:28:09,500
that you could have because some systems

00:28:06,590 --> 00:28:11,180
don't support evil and if your systems

00:28:09,500 --> 00:28:14,420
support evil and your applications don't

00:28:11,180 --> 00:28:16,250
need it please do that perhaps you want

00:28:14,420 --> 00:28:19,160
to write a DDoS system so you can just

00:28:16,250 --> 00:28:20,600
call all of your drone servers out there

00:28:19,160 --> 00:28:24,470
and say I want you to attack that server

00:28:20,600 --> 00:28:28,490
over there or maybe you could even have

00:28:24,470 --> 00:28:28,850
your system your virus every time it's

00:28:28,490 --> 00:28:30,710
called

00:28:28,850 --> 00:28:32,510
point out a great idea but put some kind

00:28:30,710 --> 00:28:34,490
of limiter in there and say I'm going to

00:28:32,510 --> 00:28:36,470
go off to this server get a JSON file

00:28:34,490 --> 00:28:38,950
interpret it and find out what my

00:28:36,470 --> 00:28:41,210
instructions are so you've got these

00:28:38,950 --> 00:28:42,830
computers out there continuously looking

00:28:41,210 --> 00:28:44,210
for instructions of what to do and then

00:28:42,830 --> 00:28:46,400
all you've got to do is post a JSON file

00:28:44,210 --> 00:28:48,830
somewhere and a DDoS happens or you

00:28:46,400 --> 00:28:49,760
start emailing a spam or whatever it is

00:28:48,830 --> 00:28:51,020
you want to do to make money

00:28:49,760 --> 00:28:54,010
oh no we're not doing this for profit I

00:28:51,020 --> 00:28:54,010
forgot

00:28:54,780 --> 00:29:08,890
so let's have a look in here effort I'll

00:29:07,720 --> 00:29:12,040
just have a look at this so we've got

00:29:08,890 --> 00:29:20,650
three files in here index.php show image

00:29:12,040 --> 00:29:22,090
and upload and what you'll see is let me

00:29:20,650 --> 00:29:27,820
just try get that over there there we go

00:29:22,090 --> 00:29:29,530
a gallery something like that so you'll

00:29:27,820 --> 00:29:31,860
have a list of photos and you'll be able

00:29:29,530 --> 00:29:38,350
to upload another image to the gallery

00:29:31,860 --> 00:29:42,100
and the way this works is we skip down

00:29:38,350 --> 00:29:43,570
to the interesting part you'll notice

00:29:42,100 --> 00:29:46,330
towards the top there we've got the for

00:29:43,570 --> 00:29:47,590
each so we're going down a directory and

00:29:46,330 --> 00:29:48,790
into gallery images and we're finding

00:29:47,590 --> 00:29:51,760
all the files in the gallery images

00:29:48,790 --> 00:29:53,260
directory so the gallery images all the

00:29:51,760 --> 00:29:56,980
images are outside of the document root

00:29:53,260 --> 00:29:58,210
which is a good security principle and

00:29:56,980 --> 00:29:59,440
then free to those images we're going

00:29:58,210 --> 00:30:03,760
through and then we're going to URL

00:29:59,440 --> 00:30:07,270
encode the image name based on the path

00:30:03,760 --> 00:30:11,260
info and pass it in to show image dot

00:30:07,270 --> 00:30:13,450
PHP so we've got a PHP file Phyllis told

00:30:11,260 --> 00:30:15,160
I want to see this image because we have

00:30:13,450 --> 00:30:17,440
no direct access it to it because it's

00:30:15,160 --> 00:30:19,960
outside the document root which will

00:30:17,440 --> 00:30:28,440
then return the image for you so we have

00:30:19,960 --> 00:30:30,610
a firewall effectively there show image

00:30:28,440 --> 00:30:33,790
will check the referrer to make sure

00:30:30,610 --> 00:30:35,860
that the referrer is self it's a good

00:30:33,790 --> 00:30:38,470
starting point we can fake for refer as

00:30:35,860 --> 00:30:40,720
though so it's not great but it's not a

00:30:38,470 --> 00:30:42,040
bad starting point we then make sure the

00:30:40,720 --> 00:30:45,910
file name is saying we don't want any

00:30:42,040 --> 00:30:47,170
dots in it we don't want any part in

00:30:45,910 --> 00:30:49,210
probly have dots because this is like

00:30:47,170 --> 00:30:50,710
jpg but we don't want any slashes

00:30:49,210 --> 00:30:52,750
because we don't then getting out of the

00:30:50,710 --> 00:30:53,860
directory and we want them to have it on

00:30:52,750 --> 00:30:54,970
your certain set of characters so a

00:30:53,860 --> 00:30:57,100
regular expression there to make sure

00:30:54,970 --> 00:30:58,630
the file name is same and then we

00:30:57,100 --> 00:31:01,150
prepended with da top sash gallery

00:30:58,630 --> 00:31:02,590
images so it has to be in the directory

00:31:01,150 --> 00:31:04,040
that we're expecting and because it

00:31:02,590 --> 00:31:07,110
can't be a slash again we can't get

00:31:04,040 --> 00:31:08,940
we then analyze the image to see what

00:31:07,110 --> 00:31:10,590
the file type is to make sure that it's

00:31:08,940 --> 00:31:14,000
within a group of file types that we

00:31:10,590 --> 00:31:17,130
accept so is it a PNG a gif or a jpg and

00:31:14,000 --> 00:31:23,970
finally we include the file that file so

00:31:17,130 --> 00:31:25,650
that is output to the browser and if we

00:31:23,970 --> 00:31:27,750
want to upload one we do a very similar

00:31:25,650 --> 00:31:30,660
thing so we've all the same

00:31:27,750 --> 00:31:34,679
mime types to the top we get the file we

00:31:30,660 --> 00:31:36,750
pull it out to the files array we make

00:31:34,679 --> 00:31:38,370
sure that is acceptable mime type we

00:31:36,750 --> 00:31:41,940
check that it's got a same file name in

00:31:38,370 --> 00:31:44,429
the same way we move the file to gallery

00:31:41,940 --> 00:31:47,910
images and then we redirect the user

00:31:44,429 --> 00:31:50,760
back to the home page if it's an invalid

00:31:47,910 --> 00:31:52,460
file we're going to tell you that if

00:31:50,760 --> 00:31:57,480
there's no file will tell you there too

00:31:52,460 --> 00:32:00,330
because we're nice so theoretically if I

00:31:57,480 --> 00:32:05,040
click upload down it'll say invalid

00:32:00,330 --> 00:32:07,670
father should have been no fun no file

00:32:05,040 --> 00:32:10,590
is also a novella file file type I guess

00:32:07,670 --> 00:32:19,590
so let's have a look before we actually

00:32:10,590 --> 00:32:23,390
upload the file we are going to have a

00:32:19,590 --> 00:32:28,230
look at this so here we have red dot jpg

00:32:23,390 --> 00:32:32,160
who here likes bread I was expecting

00:32:28,230 --> 00:32:34,650
more hens to be honest I like bread so

00:32:32,160 --> 00:32:39,450
we have a bread dot jpg file here it

00:32:34,650 --> 00:32:40,800
looks like bread I'm glad that wasn't a

00:32:39,450 --> 00:32:43,820
reaction because I'd be really surprised

00:32:40,800 --> 00:32:49,190
if you're surprised by that but if we

00:32:43,820 --> 00:32:49,190
exit out of here so this file is in

00:32:49,970 --> 00:32:57,720
files images and who here uses vim and

00:32:55,370 --> 00:32:59,610
autocompletes on the command line did

00:32:57,720 --> 00:33:01,559
you know that JPEG isn't a valid

00:32:59,610 --> 00:33:02,910
autocomplete for vim it's almost as

00:33:01,559 --> 00:33:05,130
though they think you don't want to edit

00:33:02,910 --> 00:33:07,080
JPEG files in vim I'm not sure why that

00:33:05,130 --> 00:33:11,429
is so I'm gonna have to type it in form

00:33:07,080 --> 00:33:12,420
I still try to autocomplete my brain is

00:33:11,429 --> 00:33:15,620
just made

00:33:12,420 --> 00:33:17,910
so the beautiful thing with JPEG files

00:33:15,620 --> 00:33:19,890
I'm not sure you can actually describe

00:33:17,910 --> 00:33:21,900
them as beautiful but the beautiful

00:33:19,890 --> 00:33:23,280
thing about the design of a JPEG file is

00:33:21,900 --> 00:33:25,020
the first line is kind of like the

00:33:23,280 --> 00:33:27,060
metadata in this case here you can see a

00:33:25,020 --> 00:33:28,860
little further on that says jfif they're

00:33:27,060 --> 00:33:30,750
the characters to say I'm a JPEG and

00:33:28,860 --> 00:33:32,460
towards the end you can see the equality

00:33:30,750 --> 00:33:34,530
and the Creator there's a bit of

00:33:32,460 --> 00:33:38,850
metadata in there about whether it was

00:33:34,530 --> 00:33:40,500
saved at at 70% quality etc anything

00:33:38,850 --> 00:33:42,420
after that is fair game you can put

00:33:40,500 --> 00:33:44,160
whatever you want after it there's no

00:33:42,420 --> 00:33:46,710
end of file marker there's no content

00:33:44,160 --> 00:33:53,030
size marker so what we're going to do at

00:33:46,710 --> 00:33:56,160
the same time is we're going to go to

00:33:53,030 --> 00:33:59,730
step 5

00:33:56,160 --> 00:34:02,220
and grab boom so here's our virus we

00:33:59,730 --> 00:34:03,510
just wrote and this is step 5 I didn't

00:34:02,220 --> 00:34:07,410
demo that but this is the one that's got

00:34:03,510 --> 00:34:10,169
the payload included so I'm going to cut

00:34:07,410 --> 00:34:11,700
out of that 408 lines of virus gonna

00:34:10,169 --> 00:34:15,929
come in here I'm gonna paste that in

00:34:11,700 --> 00:34:17,909
from line to downwards I'm just going to

00:34:15,929 --> 00:34:19,800
check yeah we've got a closed PHP tag at

00:34:17,909 --> 00:34:22,050
the end which means the ones PHP is

00:34:19,800 --> 00:34:26,100
finished it'll continue outputting the

00:34:22,050 --> 00:34:27,600
rest of it which is the image now the

00:34:26,100 --> 00:34:31,200
most amazing thing about this I'm just

00:34:27,600 --> 00:34:33,540
gonna save that I think is if I come

00:34:31,200 --> 00:34:35,159
back to Firefox here which has got that

00:34:33,540 --> 00:34:39,000
Bread jpg file open

00:34:35,159 --> 00:34:42,090
we were just editing on our refresh it

00:34:39,000 --> 00:34:43,520
still looks like bread you can't

00:34:42,090 --> 00:34:45,960
actually tell it's got a virus in it

00:34:43,520 --> 00:34:47,790
it's not cached it actually still looks

00:34:45,960 --> 00:34:50,850
like bread and in fact in order to prove

00:34:47,790 --> 00:34:54,240
it to you let's come in here and we're

00:34:50,850 --> 00:34:56,550
going to choose the file and go demo

00:34:54,240 --> 00:34:59,160
files images even the preview in the

00:34:56,550 --> 00:35:01,830
upload for chromium still shows you

00:34:59,160 --> 00:35:07,260
bread it actually gets rendered as bread

00:35:01,830 --> 00:35:09,640
and if we upload it it looks like bread

00:35:07,260 --> 00:35:13,109
in the browser

00:35:09,640 --> 00:35:17,220
but guess what we just loaded the image

00:35:13,109 --> 00:35:17,220
let's have a look the PHP scripts again

00:35:23,940 --> 00:35:34,960
well that's nifty all right we have

00:35:30,599 --> 00:35:36,190
plenty of time that's great let's have a

00:35:34,960 --> 00:35:38,799
look at some examples of what we could

00:35:36,190 --> 00:35:42,160
now do so I told you that we can pass

00:35:38,799 --> 00:35:45,400
anything through in the eval parameter

00:35:42,160 --> 00:35:47,109
now so let's jump back over here now

00:35:45,400 --> 00:35:49,269
you'll have to take my word for it if

00:35:47,109 --> 00:35:53,109
you can't read it but essentially there

00:35:49,269 --> 00:35:58,420
I'm saying evil equals PHP info so if we

00:35:53,109 --> 00:36:00,160
run that now we get PHP info the PHP

00:35:58,420 --> 00:36:02,049
info at the top there I've put in it's

00:36:00,160 --> 00:36:03,430
just an echo eval so that we can see

00:36:02,049 --> 00:36:05,950
more easily what I put into the browser

00:36:03,430 --> 00:36:09,390
into the URL and then it actually

00:36:05,950 --> 00:36:09,390
executes it underneath

00:36:15,230 --> 00:36:26,510
now if my emails working this one will

00:36:19,970 --> 00:36:40,730
be fun if I can if I can work out how to

00:36:26,510 --> 00:36:42,079
copy and paste let me just close a

00:36:40,730 --> 00:36:50,630
browser and start again I think it's a

00:36:42,079 --> 00:36:51,800
little confused it's very confusing so

00:36:50,630 --> 00:36:58,760
means not worried for browser or

00:36:51,800 --> 00:37:01,430
something right it's taking a little

00:36:58,760 --> 00:37:03,710
while because when it comes up it's

00:37:01,430 --> 00:37:05,750
obvious that my mail server locally

00:37:03,710 --> 00:37:08,810
isn't running but I called mail benedek

00:37:05,750 --> 00:37:11,210
right oakum test this is spam so had my

00:37:08,810 --> 00:37:12,369
SMTP server been running locally who

00:37:11,210 --> 00:37:14,540
would have actually sent that email out

00:37:12,369 --> 00:37:16,910
so this is now a way that you can turn

00:37:14,540 --> 00:37:17,210
every single infected server not every

00:37:16,910 --> 00:37:18,920
server

00:37:17,210 --> 00:37:20,300
unfortunately we'd like to infect

00:37:18,920 --> 00:37:23,180
everything in the world 20% would be a

00:37:20,300 --> 00:37:30,609
good goal but you can use it to spend

00:37:23,180 --> 00:37:34,310
people or you can even do something like

00:37:30,609 --> 00:37:41,660
this so I'll give you a second to have a

00:37:34,310 --> 00:37:44,329
quick read of it so one of the things

00:37:41,660 --> 00:37:46,940
you can't do is you can't edit a file

00:37:44,329 --> 00:37:49,490
while it's open in memory when you load

00:37:46,940 --> 00:37:52,550
the index.php file it's open in memory

00:37:49,490 --> 00:37:54,920
there's a write lock on it but we want

00:37:52,550 --> 00:37:57,079
to change the index dot PHP file because

00:37:54,920 --> 00:37:58,250
we're nasty so what I'm going to do is

00:37:57,079 --> 00:38:00,260
I'm going to create a template file a

00:37:58,250 --> 00:38:02,510
dot PHP and into it I'm going to write

00:38:00,260 --> 00:38:04,430
the PHP that I want to write into index

00:38:02,510 --> 00:38:08,290
dot PHP in this case I'm going to set

00:38:04,430 --> 00:38:10,670
the location to the conference homepage

00:38:08,290 --> 00:38:15,470
and then I'm going to put the contents

00:38:10,670 --> 00:38:19,790
of that from the HP index the a PHP into

00:38:15,470 --> 00:38:20,960
index.php so this means that now that

00:38:19,790 --> 00:38:24,339
I've run this there should be a file

00:38:20,960 --> 00:38:24,339
called a dot PHP on the server

00:38:27,980 --> 00:38:33,900
there it is it's even been infected sit

00:38:33,150 --> 00:38:36,090
down in the bottom there we've got

00:38:33,900 --> 00:38:37,920
header location as PHP conference calm

00:38:36,090 --> 00:38:40,710
and put that content into the index dot

00:38:37,920 --> 00:38:43,110
PHP so now next time I go back to the

00:38:40,710 --> 00:38:46,070
home page might be able to do by

00:38:43,110 --> 00:38:59,670
clicking on here no I should do that

00:38:46,070 --> 00:39:01,800
might be nifty chromium's being really

00:38:59,670 --> 00:39:05,760
good occasion in the moment so I'm gonna

00:39:01,800 --> 00:39:11,940
copy that gotta close chromium again you

00:39:05,760 --> 00:39:14,390
drove Midian try and move it over to

00:39:11,940 --> 00:39:14,390
that screen

00:39:17,230 --> 00:39:29,040
oh you know what I haven't done I didn't

00:39:26,320 --> 00:39:37,089
run in a dot php' I'm glad you're around

00:39:29,040 --> 00:39:38,260
right let's try that all right no output

00:39:37,089 --> 00:39:40,000
which is what we were expecting

00:39:38,260 --> 00:39:52,450
now I'll go back to the home page I hit

00:39:40,000 --> 00:39:54,160
refresh excellent so now you can

00:39:52,450 --> 00:39:57,430
basically go round as long as you can

00:39:54,160 --> 00:39:59,859
find gallery systems - in fact it's um a

00:39:57,430 --> 00:40:02,470
really high class system as you know or

00:39:59,859 --> 00:40:06,820
release the open source you can please

00:40:02,470 --> 00:40:08,890
don't install it in production but yes

00:40:06,820 --> 00:40:10,240
we can now go around and start getting

00:40:08,890 --> 00:40:12,490
every website in the world to redirect

00:40:10,240 --> 00:40:14,079
to a PHP conference boost the profile of

00:40:12,490 --> 00:40:16,930
the conference even more do we need to

00:40:14,079 --> 00:40:17,230
and then next year we'll have to I don't

00:40:16,930 --> 00:40:19,020
know

00:40:17,230 --> 00:40:21,130
hire multiple conference centers and

00:40:19,020 --> 00:40:27,520
shuttle buses to get us between them

00:40:21,130 --> 00:40:31,119
probably all right but why am I telling

00:40:27,520 --> 00:40:32,410
you this so the main reason why I

00:40:31,119 --> 00:40:35,880
started looking at this so I'm my

00:40:32,410 --> 00:40:40,180
background is from security privacy I

00:40:35,880 --> 00:40:42,040
try and teach principles of how to look

00:40:40,180 --> 00:40:43,810
out for issues in your code all the rest

00:40:42,040 --> 00:40:47,490
of it then one day I thought we all

00:40:43,810 --> 00:40:50,619
think about how to protect ourselves

00:40:47,490 --> 00:40:52,060
which is great we should but one of the

00:40:50,619 --> 00:40:57,490
things we don't think about is how do we

00:40:52,060 --> 00:41:01,089
attack things so you might have seen a

00:40:57,490 --> 00:41:06,640
photo one of these fail photos on the

00:41:01,089 --> 00:41:08,650
internet of the gate over a driveway but

00:41:06,640 --> 00:41:10,480
there's a driving driving path around

00:41:08,650 --> 00:41:11,079
the side of it or the other one with a

00:41:10,480 --> 00:41:12,550
boom gate

00:41:11,079 --> 00:41:13,780
I showed this one in a talk earlier

00:41:12,550 --> 00:41:15,579
today there's a boom gate in the middle

00:41:13,780 --> 00:41:18,460
of a park and people just drive around

00:41:15,579 --> 00:41:20,920
it so it's all very well to think about

00:41:18,460 --> 00:41:21,880
how can I secure this driveway but if

00:41:20,920 --> 00:41:23,109
you don't actually think like an

00:41:21,880 --> 00:41:24,099
attacker and look at it and say well you

00:41:23,109 --> 00:41:27,040
know what even though there's a gate

00:41:24,099 --> 00:41:28,300
there I can do this then we're not going

00:41:27,040 --> 00:41:29,859
to think about all the possibilities so

00:41:28,300 --> 00:41:30,830
one thing I wanted to do for myself

00:41:29,859 --> 00:41:32,180
personally

00:41:30,830 --> 00:41:36,140
was to start thinking more maliciously

00:41:32,180 --> 00:41:39,770
in order to anticipate more what could

00:41:36,140 --> 00:41:40,940
potentially happen the other thing I

00:41:39,770 --> 00:41:43,760
want to do is learn something new and

00:41:40,940 --> 00:41:44,840
have some fun which hopefully you get

00:41:43,760 --> 00:41:46,280
more of an opportunity to do

00:41:44,840 --> 00:41:47,960
I love companies they have like 4 temp

00:41:46,280 --> 00:41:50,600
sent 20% days where you get to play

00:41:47,960 --> 00:41:52,190
around and build something it's great

00:41:50,600 --> 00:41:54,590
for the mind because it takes you away

00:41:52,190 --> 00:41:57,770
from your everyday playing with

00:41:54,590 --> 00:41:59,450
something new is a great way to still be

00:41:57,770 --> 00:42:02,690
productive while giving yourself a break

00:41:59,450 --> 00:42:05,840
and if at the same time you can do

00:42:02,690 --> 00:42:08,390
something very different then that's

00:42:05,840 --> 00:42:10,400
even more enjoyable for me anyway I'm

00:42:08,390 --> 00:42:15,520
gonna tell you what you like but give it

00:42:10,400 --> 00:42:17,810
a try anyway do you remember your pledge

00:42:15,520 --> 00:42:22,700
I'm getting nods good house I have to

00:42:17,810 --> 00:42:25,490
get you to do again so I want you to

00:42:22,700 --> 00:42:26,960
leave and think them lodges yet not

00:42:25,490 --> 00:42:28,280
don't you two just bugger off we do have

00:42:26,960 --> 00:42:30,140
beers in a second so I do want you to

00:42:28,280 --> 00:42:32,570
leave so I can have a beer too but I

00:42:30,140 --> 00:42:34,340
want you to leave today and after the

00:42:32,570 --> 00:42:37,580
conference and as you go on thinking

00:42:34,340 --> 00:42:39,410
more about what are the ways in which

00:42:37,580 --> 00:42:40,640
case in which I can break things we did

00:42:39,410 --> 00:42:42,620
this as children didn't we we broke

00:42:40,640 --> 00:42:43,580
things in order to take them apart I was

00:42:42,620 --> 00:42:45,380
speaking to somebody earlier in the

00:42:43,580 --> 00:42:48,380
conference who told me he used to take

00:42:45,380 --> 00:42:50,030
his mum's vacuum cleaner apart to learn

00:42:48,380 --> 00:42:51,200
all about it I don't actually know

00:42:50,030 --> 00:42:52,550
whether he learnt anything about it and

00:42:51,200 --> 00:42:54,650
his mum was very angry that he couldn't

00:42:52,550 --> 00:42:56,450
actually put it back together again but

00:42:54,650 --> 00:42:57,800
we learned through breaking so break

00:42:56,450 --> 00:43:00,470
things more often do it in a safe

00:42:57,800 --> 00:43:02,180
environment that was all the demo that I

00:43:00,470 --> 00:43:05,660
ran was in a vacant box I actually ran

00:43:02,180 --> 00:43:06,980
that on my host machine once I lost all

00:43:05,660 --> 00:43:10,100
of my PHP files because I had a

00:43:06,980 --> 00:43:14,240
recursive script to find every single

00:43:10,100 --> 00:43:15,290
PHP file and delete it which made it

00:43:14,240 --> 00:43:17,240
very interesting when I went back to

00:43:15,290 --> 00:43:20,150
work the next day and said I'm gonna

00:43:17,240 --> 00:43:21,230
need half a day to rebuild this so play

00:43:20,150 --> 00:43:23,120
in a safe environment

00:43:21,230 --> 00:43:25,310
we have send boxes as children we have

00:43:23,120 --> 00:43:27,650
send boxes as adults find them and use

00:43:25,310 --> 00:43:29,390
them well so with that I'd like to thank

00:43:27,650 --> 00:43:32,810
you for your time I'm happy to take any

00:43:29,390 --> 00:43:35,110
questions if not or even over beers if

00:43:32,810 --> 00:43:38,060
not thank you very much

00:43:35,110 --> 00:43:43,800
[Applause]

00:43:38,060 --> 00:43:43,800

YouTube URL: https://www.youtube.com/watch?v=oWG2-OTJbeU


