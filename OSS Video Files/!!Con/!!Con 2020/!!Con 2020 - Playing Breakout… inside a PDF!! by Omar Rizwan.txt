Title: !!Con 2020 - Playing Breakout… inside a PDF!! by Omar Rizwan
Publication date: 2020-05-28
Playlist: !!Con 2020
Description: 
	Playing Breakout… inside a PDF!! by Omar Rizwan

If you’re like me, you think of PDFs as basically benign creatures: they’re static documents where the author laid out some text and graphics, and when you open a PDF, all your PDF reader does is display that stuff.

Maybe that was what PDFs were originally, but today, the PDF specification is… 1,310 pages, and a PDF can contain things like:

embedded Flash
audio and video annotations
3D object annotations (!)
rich text forms using a subset of XHTML and CSS
but most interestingly…

JavaScript scripting (!!!!!!!)
So I wrote a game in JavaScript that lives inside a PDF: when you open the PDF in Chrome, you can play Breakout!

I’ll show some basics of the PDF standard, how you embed JavaScript, and then discuss the problems I ran into when making this game work.

It turns out, for example, that Adobe’s PDF JavaScript has a completely different standard library from browser JavaScript – and Chrome’s PDF reader only implements a weird subset of Adobe’s libraries! I’ll talk about the wild hacks I needed for basic things like tracking the player’s mouse cursor and making the Breakout game’s display update over time.

Omar Rizwan is fascinated by weird leftover details of file formats and by what those details say about a format’s history. He works as a researcher at Dynamicland in Oakland, California.
Captions: 
	00:00:13,110 --> 00:00:17,830
cool so I'm gonna start by I'm gonna

00:00:16,420 --> 00:00:21,279
talk about a project that I did a few

00:00:17,830 --> 00:00:24,400
years ago where I made this PDF that you

00:00:21,279 --> 00:00:27,220
load up in your Chrome browser and you

00:00:24,400 --> 00:00:29,470
can play breakout and slide up so it's a

00:00:27,220 --> 00:00:31,210
totally normal PDF totally normal Chrome

00:00:29,470 --> 00:00:35,050
browser and you just open it up and

00:00:31,210 --> 00:00:40,030
things start moving I'm not a great

00:00:35,050 --> 00:00:42,220
breakout player so I'm gonna talk about

00:00:40,030 --> 00:00:43,449
like how that works and I'm going to

00:00:42,220 --> 00:00:46,270
talk about some of the hacks I had to do

00:00:43,449 --> 00:00:48,449
to get it to work so I want to start out

00:00:46,270 --> 00:00:50,770
by talking a bit about the PDF format

00:00:48,449 --> 00:00:52,510
because you may not actually know that

00:00:50,770 --> 00:00:54,010
much about it I if you're like me you've

00:00:52,510 --> 00:00:56,109
probably read a bunch of PDFs but you

00:00:54,010 --> 00:00:58,570
may not know too much about how to make

00:00:56,109 --> 00:01:01,090
a PDF and it turns out that PDFs are

00:00:58,570 --> 00:01:03,699
actually really simple like this right

00:01:01,090 --> 00:01:05,950
here this this text here that basically

00:01:03,699 --> 00:01:07,840
fits on one editor screen is a complete

00:01:05,950 --> 00:01:09,460
PDF you can kind of just type it in and

00:01:07,840 --> 00:01:12,130
save it and you'll get something that

00:01:09,460 --> 00:01:14,860
looks like this so it's not so PDF is

00:01:12,130 --> 00:01:19,030
not a super complicated format at heart

00:01:14,860 --> 00:01:20,530
but over the years adobe has has added

00:01:19,030 --> 00:01:23,800
like layers and layers and layers of

00:01:20,530 --> 00:01:26,580
stuff that you can embed inside PDFs you

00:01:23,800 --> 00:01:29,530
know you can put flash files into a PDF

00:01:26,580 --> 00:01:32,800
you can put chunks of web pages into a

00:01:29,530 --> 00:01:35,679
PDF you can put functions inside a PDF

00:01:32,800 --> 00:01:37,030
like if you want to tell the PDF view or

00:01:35,679 --> 00:01:40,539
how to render colors and things like

00:01:37,030 --> 00:01:42,640
that you can put rich text inside like a

00:01:40,539 --> 00:01:44,530
form field in a PDF like it is actually

00:01:42,640 --> 00:01:47,440
like a subset of XHTML that you're

00:01:44,530 --> 00:01:49,989
allowed to put inside PDFs you can put

00:01:47,440 --> 00:01:52,360
video you can put sound you can even put

00:01:49,989 --> 00:01:55,390
three models into a PDF which i think is

00:01:52,360 --> 00:01:57,190
pretty wild but for the purpose of this

00:01:55,390 --> 00:02:00,069
talk and for the purpose of making the

00:01:57,190 --> 00:02:02,289
breakout game what I'm interested in is

00:02:00,069 --> 00:02:03,489
you can put JavaScript into a PDF you

00:02:02,289 --> 00:02:06,160
can put these things called JavaScript

00:02:03,489 --> 00:02:08,050
actions inside a PDF and make them run

00:02:06,160 --> 00:02:09,849
like when you first open the PDF or when

00:02:08,050 --> 00:02:11,410
you hover over something you can write

00:02:09,849 --> 00:02:13,209
little chunks of JavaScript and put them

00:02:11,410 --> 00:02:17,500
inside and then the PDF viewer is

00:02:13,209 --> 00:02:20,590
supposed to execute those so let's let's

00:02:17,500 --> 00:02:22,060
see one of those right now so what I'm

00:02:20,590 --> 00:02:24,250
going to do is I'm going to take that

00:02:22,060 --> 00:02:26,500
minimal PDF that I showed a few slides

00:02:24,250 --> 00:02:28,570
ago and I'm just going

00:02:26,500 --> 00:02:31,600
inject a little chunk of JavaScript

00:02:28,570 --> 00:02:34,180
inside so what this JavaScript that I've

00:02:31,600 --> 00:02:36,790
added is going to do is when I load this

00:02:34,180 --> 00:02:38,860
file in my PDF viewer it's gonna wait

00:02:36,790 --> 00:02:40,990
two seconds and then it's gonna show me

00:02:38,860 --> 00:02:47,980
a little pop-up box saying hello from

00:02:40,990 --> 00:02:51,580
PDF JavaScript so load this up and wait

00:02:47,980 --> 00:02:53,770
two seconds and we get our pop-up so

00:02:51,580 --> 00:02:58,540
that's the kind of very basic minimal

00:02:53,770 --> 00:02:59,680
JavaScript inside a PDF and now that

00:02:58,540 --> 00:03:00,880
you've seen that working I kind of want

00:02:59,680 --> 00:03:03,040
to zoom in on this code a little bit

00:03:00,880 --> 00:03:05,140
because it's it's like it's a little

00:03:03,040 --> 00:03:07,870
weird like if you've done browser

00:03:05,140 --> 00:03:10,239
JavaScript or a node j/s you're probably

00:03:07,870 --> 00:03:11,590
looking at this like this doesn't mesh

00:03:10,239 --> 00:03:12,940
up with like how you usually write

00:03:11,590 --> 00:03:15,790
JavaScript like it's the same JavaScript

00:03:12,940 --> 00:03:18,820
syntax it's the JavaScript language but

00:03:15,790 --> 00:03:20,470
the API is are not the same that you

00:03:18,820 --> 00:03:23,050
that you normally use in a browser

00:03:20,470 --> 00:03:25,600
there's this app dot thing there's a set

00:03:23,050 --> 00:03:28,570
timeout thing this app that alert is in

00:03:25,600 --> 00:03:31,299
a string and not my closure so it turns

00:03:28,570 --> 00:03:33,040
out that the JavaScript that you can

00:03:31,299 --> 00:03:35,290
embed in a PDF is the standard

00:03:33,040 --> 00:03:37,600
JavaScript language but the API is that

00:03:35,290 --> 00:03:39,160
you call to do things are totally

00:03:37,600 --> 00:03:41,380
different and adobe has this whole

00:03:39,160 --> 00:03:43,590
spectate hundred pages that's the

00:03:41,380 --> 00:03:46,120
reference just for PDF javascript calls

00:03:43,590 --> 00:03:48,489
and if you dig around in it you find for

00:03:46,120 --> 00:03:50,170
example the set timeout function that we

00:03:48,489 --> 00:03:53,049
were calling earlier and it has a

00:03:50,170 --> 00:03:55,209
capital o for instance where is the one

00:03:53,049 --> 00:03:56,950
browser obviously it's lowercase so it's

00:03:55,209 --> 00:04:03,040
just tons of little things like that are

00:03:56,950 --> 00:04:05,350
totally different but it actually gets

00:04:03,040 --> 00:04:07,570
even weirder than that to make this

00:04:05,350 --> 00:04:09,610
break out game because I've been showing

00:04:07,570 --> 00:04:11,560
you these PDFs in chrome and this

00:04:09,610 --> 00:04:13,209
reference is for Adobe Acrobat so this

00:04:11,560 --> 00:04:16,150
is like what you're supposed to do if

00:04:13,209 --> 00:04:18,989
your PDF viewer but chrome actually only

00:04:16,150 --> 00:04:21,340
implements a weird subset of these API

00:04:18,989 --> 00:04:23,560
so like I went and I dug around in the

00:04:21,340 --> 00:04:25,060
chrome source code and I found like the

00:04:23,560 --> 00:04:26,800
places where they implement the PDF

00:04:25,060 --> 00:04:28,750
functions that you can call from PDF

00:04:26,800 --> 00:04:30,490
JavaScript and it turns out that a lot

00:04:28,750 --> 00:04:33,490
of them are just like not implemented by

00:04:30,490 --> 00:04:34,660
Chrome for security reasons or just

00:04:33,490 --> 00:04:35,530
because Google didn't bother to

00:04:34,660 --> 00:04:37,120
implement them because they weren't

00:04:35,530 --> 00:04:39,710
important to whatever they wanted to do

00:04:37,120 --> 00:04:42,080
with a PDF viewer so

00:04:39,710 --> 00:04:45,440
to make this breakout game we're in this

00:04:42,080 --> 00:04:47,389
really weird situation where not only

00:04:45,440 --> 00:04:48,860
are we not using the normal browser AP

00:04:47,389 --> 00:04:51,080
eyes that were used to we're not even

00:04:48,860 --> 00:04:53,030
using the specified PDF JavaScript API

00:04:51,080 --> 00:04:55,699
that adobe says you're supposed to have

00:04:53,030 --> 00:04:58,340
we're using Chrome's weird subset of

00:04:55,699 --> 00:05:00,710
Adobe's weird PDF JavaScript API and

00:04:58,340 --> 00:05:02,870
this brings up like a lot of very

00:05:00,710 --> 00:05:04,970
strange problems and workarounds that I

00:05:02,870 --> 00:05:08,030
needed to do to get this to work so I'm

00:05:04,970 --> 00:05:09,500
gonna talk about three of them first how

00:05:08,030 --> 00:05:11,900
did I like draw things in the first

00:05:09,500 --> 00:05:15,470
place second how did I take mouse input

00:05:11,900 --> 00:05:16,910
and third how do I like get this to the

00:05:15,470 --> 00:05:18,050
screen to refresh clearly and that'll

00:05:16,910 --> 00:05:22,160
make more sense after I go through the

00:05:18,050 --> 00:05:25,250
first two so first how do I like draw

00:05:22,160 --> 00:05:27,440
the ball and the paddle and the bricks

00:05:25,250 --> 00:05:28,699
and how do I get them to move because

00:05:27,440 --> 00:05:31,310
you know if you're in the browser you

00:05:28,699 --> 00:05:32,660
can just use canvas or you can use SVG

00:05:31,310 --> 00:05:34,010
elements or whatever there's like a

00:05:32,660 --> 00:05:36,020
bunch of ways to draw things normally

00:05:34,010 --> 00:05:40,820
inside a browser but in PDF you don't

00:05:36,020 --> 00:05:42,620
get any of that so it turns out that the

00:05:40,820 --> 00:05:46,070
one thing that chrome does let you draw

00:05:42,620 --> 00:05:48,320
is text boxes so this green box here is

00:05:46,070 --> 00:05:52,120
actually a text box like the kind of

00:05:48,320 --> 00:05:52,120
form field that you type into in a PDF

00:05:52,180 --> 00:05:56,120
and it turns out like this is basically

00:05:54,470 --> 00:05:58,280
all you need to make a breakout game

00:05:56,120 --> 00:06:00,349
right you can just make a lot of text

00:05:58,280 --> 00:06:02,690
boxes so if we go look at this game

00:06:00,349 --> 00:06:07,610
again it turns out that everything here

00:06:02,690 --> 00:06:13,370
is actually just a text box so that

00:06:07,610 --> 00:06:15,740
solves our problem how to draw files but

00:06:13,370 --> 00:06:17,720
it doesn't solve the problem of how do

00:06:15,740 --> 00:06:19,280
we get input right is to play the

00:06:17,720 --> 00:06:21,020
breakout game we're constantly moving

00:06:19,280 --> 00:06:24,849
the mouse left and right so how do we

00:06:21,020 --> 00:06:24,849
know where the mouse is on the screen

00:06:24,909 --> 00:06:30,919
but it turns out that this hovering

00:06:28,039 --> 00:06:31,970
trick with the text box also gives us

00:06:30,919 --> 00:06:35,780
what we need to track the mouse position

00:06:31,970 --> 00:06:37,430
right because all we need to view to

00:06:35,780 --> 00:06:40,250
know where the mouse is is just make a

00:06:37,430 --> 00:06:41,539
ton of really tall thin text boxes so if

00:06:40,250 --> 00:06:44,330
you zoom in here you can actually see

00:06:41,539 --> 00:06:45,949
the individual text boxes that I'm using

00:06:44,330 --> 00:06:47,479
to track the mouse position so that's

00:06:45,949 --> 00:06:48,740
how I figure out where the mouse is I

00:06:47,479 --> 00:06:50,830
just figure out which of these really

00:06:48,740 --> 00:06:52,789
thin text boxes are you hovering over

00:06:50,830 --> 00:06:53,480
but you can see that this brings that

00:06:52,789 --> 00:06:55,910
starts to bring up

00:06:53,480 --> 00:07:00,260
third problem which is that chrome

00:06:55,910 --> 00:07:02,900
doesn't really expect that you're

00:07:00,260 --> 00:07:04,280
drawing new things when a PDF is open it

00:07:02,900 --> 00:07:06,260
doesn't expect that you're drawing that

00:07:04,280 --> 00:07:08,180
this thing is going to move and so when

00:07:06,260 --> 00:07:11,300
I move this paddle it actually gets

00:07:08,180 --> 00:07:12,650
smeared all over the PDF surface because

00:07:11,300 --> 00:07:16,790
chrome doesn't know to clear away the

00:07:12,650 --> 00:07:17,990
old paddles so that brings me to the

00:07:16,790 --> 00:07:20,180
third problem which is how do I tell

00:07:17,990 --> 00:07:22,870
chrome hey I've drawn a new paddle I

00:07:20,180 --> 00:07:27,530
want you to clear away the old stuff and

00:07:22,870 --> 00:07:31,280
to solve that I used again just a giant

00:07:27,530 --> 00:07:33,320
text box so what happens is I move the

00:07:31,280 --> 00:07:34,940
paddle around as I move the paddle

00:07:33,320 --> 00:07:37,580
around there's a giant text box in the

00:07:34,940 --> 00:07:39,140
background that just flashes here I'm

00:07:37,580 --> 00:07:40,700
having it flash pretty slowly so you can

00:07:39,140 --> 00:07:44,540
see how it fears away all the old

00:07:40,700 --> 00:07:45,980
paddles every time it flashes but in the

00:07:44,540 --> 00:07:51,470
actual game I do the exact same thing

00:07:45,980 --> 00:07:52,970
just a lot faster so as I'm moving the

00:07:51,470 --> 00:07:54,890
paddle here there's just a giant text

00:07:52,970 --> 00:07:56,570
box that's flashing many many times a

00:07:54,890 --> 00:07:58,340
second clearing away all the old stuff

00:07:56,570 --> 00:08:03,320
if not for that would be smeared all the

00:07:58,340 --> 00:08:05,900
time and you know with those three hacks

00:08:03,320 --> 00:08:07,430
and with the ability to write arbitrary

00:08:05,900 --> 00:08:09,680
JavaScript to run all these things

00:08:07,430 --> 00:08:14,420
that's basically all you need to make a

00:08:09,680 --> 00:08:16,810
breakout game and that's all it takes

00:08:14,420 --> 00:08:16,810

YouTube URL: https://www.youtube.com/watch?v=6rbJu10Telc


