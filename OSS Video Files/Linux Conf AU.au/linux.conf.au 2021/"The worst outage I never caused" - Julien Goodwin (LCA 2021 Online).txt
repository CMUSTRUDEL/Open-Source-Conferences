Title: "The worst outage I never caused" - Julien Goodwin (LCA 2021 Online)
Publication date: 2021-01-31
Playlist: linux.conf.au 2021
Description: 
	Julien Goodwin

https://lca2021.linux.org.au/schedule/presentation/104/

In 2017 I came one keypress from causing Google's main backbone to largely fall off the Internet. This is the story of how we used that incident as a learning opportunity, how a lack of buy-in hindered further improvements, and how an existing toolkit of python libraries allowed testing and validation tools to be quickly built, preventing any chance of a recurrence.

linux.conf.au is a conference about the Linux operating system, and all aspects of the thriving ecosystem of Free and Open Source Software that has grown up around it. Run since 1999, in a different Australian or New Zealand city each year, by a team of local volunteers, LCA invites more than 500 people to learn from the people who shape the future of Open Source. For more information on the conference see https://linux.conf.au/

Produced by Next Day Video Australia: https://nextdayvideo.com.au

#linux.conf.au #linux #foss #opensource

Sat Jan 23 17:05:00 2021 at Blemings Labs
Captions: 
	00:00:10,820 --> 00:00:14,060
[Music]

00:00:15,360 --> 00:00:19,039
welcome back to the sister

00:00:16,480 --> 00:00:22,880
administration mini conf

00:00:19,039 --> 00:00:25,599
for the end of our mini conf we have one

00:00:22,880 --> 00:00:26,800
final presentation julian is going to

00:00:25,599 --> 00:00:29,519
talk to us

00:00:26,800 --> 00:00:30,240
about learning from mistakes that you

00:00:29,519 --> 00:00:33,920
avoided

00:00:30,240 --> 00:00:37,520
actually making over to you julian

00:00:33,920 --> 00:00:39,280
hi so yeah this is a talk about

00:00:37,520 --> 00:00:42,079
an incident that never happened it's a

00:00:39,280 --> 00:00:45,840
talk from

00:00:42,079 --> 00:00:45,840
a couple of years ago

00:00:46,239 --> 00:00:52,800
and of course despite testing this the

00:00:49,840 --> 00:00:55,199
slide is not corresponding uh a bunch of

00:00:52,800 --> 00:00:56,800
things have changed since

00:00:55,199 --> 00:00:58,960
this is to get you thinking about your

00:00:56,800 --> 00:01:02,719
near misses not

00:00:58,960 --> 00:01:02,719
much about the incident itself

00:01:02,960 --> 00:01:06,159
your cast of characters for this at the

00:01:04,960 --> 00:01:09,040
time i was a

00:01:06,159 --> 00:01:10,000
network sre at google in sydney these

00:01:09,040 --> 00:01:12,080
days i work on

00:01:10,000 --> 00:01:13,600
insider risk elements still at google in

00:01:12,080 --> 00:01:16,640
sydney

00:01:13,600 --> 00:01:18,159
and my compatriot is chris morrow who

00:01:16,640 --> 00:01:20,159
is actually still in network security

00:01:18,159 --> 00:01:22,479
over in reston virginia

00:01:20,159 --> 00:01:23,600
one of the things of note here we are

00:01:22,479 --> 00:01:24,640
two people on the other side of the

00:01:23,600 --> 00:01:27,119
planet

00:01:24,640 --> 00:01:28,560
neither of us are in california home of

00:01:27,119 --> 00:01:30,320
google a lot of where our senior

00:01:28,560 --> 00:01:32,560
management are

00:01:30,320 --> 00:01:34,159
nor are our teams actually represented

00:01:32,560 --> 00:01:36,159
uh due to some weird oddities of

00:01:34,159 --> 00:01:39,920
google's network structure

00:01:36,159 --> 00:01:41,360
the we ended up with some teams in some

00:01:39,920 --> 00:01:42,000
weird locations and some of that is

00:01:41,360 --> 00:01:44,799
still true

00:01:42,000 --> 00:01:46,799
but things have consolidated since uh

00:01:44,799 --> 00:01:48,479
time zones are at the time so as you can

00:01:46,799 --> 00:01:51,200
see where

00:01:48,479 --> 00:01:52,479
luckily we're both people that can do

00:01:51,200 --> 00:01:57,600
weird hours

00:01:52,479 --> 00:02:00,799
but that's sub ideal so what happened or

00:01:57,600 --> 00:02:01,280
what nearly happened well one one monday

00:02:00,799 --> 00:02:03,439
morning

00:02:01,280 --> 00:02:05,040
i get a poke from chris going hey it's

00:02:03,439 --> 00:02:06,399
monday morning your time

00:02:05,040 --> 00:02:08,399
do you mind rolling out this change we

00:02:06,399 --> 00:02:10,800
did on the weekend

00:02:08,399 --> 00:02:12,400
all right why not i'm at the office

00:02:10,800 --> 00:02:16,560
before lunch time

00:02:12,400 --> 00:02:19,920
weirdly yeah i'll roll a change out

00:02:16,560 --> 00:02:21,840
and i trigger off the tool that pushes

00:02:19,920 --> 00:02:23,120
production changes for that part of the

00:02:21,840 --> 00:02:26,640
network

00:02:23,120 --> 00:02:27,280
now luckily this tool takes a while to

00:02:26,640 --> 00:02:28,879
confirm

00:02:27,280 --> 00:02:33,040
what's actually in scope for the change

00:02:28,879 --> 00:02:34,800
it ends up taking about a minute of prep

00:02:33,040 --> 00:02:36,319
and while i was doing that i just went

00:02:34,800 --> 00:02:37,920
and verified the diff in case

00:02:36,319 --> 00:02:39,840
other people had made changes and never

00:02:37,920 --> 00:02:41,920
pushed them which is something that

00:02:39,840 --> 00:02:43,440
sadly was common at the time

00:02:41,920 --> 00:02:46,000
this is not an element that was

00:02:43,440 --> 00:02:47,519
automated there's reasons why at the

00:02:46,000 --> 00:02:50,160
time

00:02:47,519 --> 00:02:52,959
and so i do it before stiff because all

00:02:50,160 --> 00:02:56,160
that config is in perforce

00:02:52,959 --> 00:02:57,840
and we're pushing rev 8 and

00:02:56,160 --> 00:02:59,599
quick check says rev 5 is the version

00:02:57,840 --> 00:03:03,599
live on the network

00:02:59,599 --> 00:03:05,200
and the diff is really big okay

00:03:03,599 --> 00:03:06,480
uh the file had actually been moved

00:03:05,200 --> 00:03:07,840
recently which is why the revision

00:03:06,480 --> 00:03:11,040
numbers were low those the

00:03:07,840 --> 00:03:11,040
actual revision numbers

00:03:11,680 --> 00:03:15,840
okay check five and six that's small and

00:03:14,720 --> 00:03:17,760
obviously legit

00:03:15,840 --> 00:03:19,920
check six and seven that's small and

00:03:17,760 --> 00:03:23,280
obviously legit

00:03:19,920 --> 00:03:27,360
okay seven and eight is our change but

00:03:23,280 --> 00:03:27,360
it's huge it should also be small

00:03:27,760 --> 00:03:33,760
okay so what did we end up doing

00:03:32,000 --> 00:03:36,159
we we changed the thing we were going to

00:03:33,760 --> 00:03:38,959
change the actual intended change

00:03:36,159 --> 00:03:40,400
but we also changed this magic number

00:03:38,959 --> 00:03:41,840
that was something we discussed on the

00:03:40,400 --> 00:03:44,720
change

00:03:41,840 --> 00:03:45,760
but it's clearly something i thought

00:03:44,720 --> 00:03:47,760
we'd do later

00:03:45,760 --> 00:03:50,720
so i go and check the list of magic

00:03:47,760 --> 00:03:54,400
numbers that's appropriate

00:03:50,720 --> 00:03:56,239
and oh it turns out that magic number is

00:03:54,400 --> 00:03:58,840
very very important and should not have

00:03:56,239 --> 00:04:02,080
been removed

00:03:58,840 --> 00:04:04,480
now luckily that push tool

00:04:02,080 --> 00:04:06,000
before takes a final confirmation once

00:04:04,480 --> 00:04:09,680
it confirms what's in scope and

00:04:06,000 --> 00:04:12,640
control c it's not going to push quick

00:04:09,680 --> 00:04:13,680
uh revision control revert of the file

00:04:12,640 --> 00:04:16,079
and

00:04:13,680 --> 00:04:19,199
no one pushing head will will push that

00:04:16,079 --> 00:04:19,199
broken file which is great

00:04:19,440 --> 00:04:26,560
but what would have happened well

00:04:23,199 --> 00:04:27,840
basically we'd have dropped google's ip

00:04:26,560 --> 00:04:29,199
addresses we would have stopped

00:04:27,840 --> 00:04:32,240
advertising most of google's ip

00:04:29,199 --> 00:04:35,600
addresses to the rest of the internet

00:04:32,240 --> 00:04:37,440
this breaks all sorts of things

00:04:35,600 --> 00:04:38,639
we know as well as of course all the

00:04:37,440 --> 00:04:40,080
google services that would have been

00:04:38,639 --> 00:04:42,240
broken

00:04:40,080 --> 00:04:43,840
there are isps that use reachability to

00:04:42,240 --> 00:04:46,880
google as a proxy for

00:04:43,840 --> 00:04:47,919
we are connected to the internet

00:04:46,880 --> 00:04:50,720
there's things that would have kept

00:04:47,919 --> 00:04:54,639
working there's weirdness

00:04:50,720 --> 00:04:56,800
and some things would have kept working

00:04:54,639 --> 00:04:58,639
but so little that calling it a complete

00:04:56,800 --> 00:05:01,759
outage is is fairly

00:04:58,639 --> 00:05:02,479
reasonable and because of an oddity of

00:05:01,759 --> 00:05:05,039
the way

00:05:02,479 --> 00:05:06,320
bgp works both in general and in the

00:05:05,039 --> 00:05:07,360
very specific design of google's

00:05:06,320 --> 00:05:09,919
backbone

00:05:07,360 --> 00:05:11,680
this would actually have taken effect

00:05:09,919 --> 00:05:16,000
within two or three seconds

00:05:11,680 --> 00:05:19,680
for the entire change

00:05:16,000 --> 00:05:19,680
or for the entire global backbone

00:05:20,479 --> 00:05:24,720
okay so some context rats on the

00:05:23,360 --> 00:05:26,400
internet come from a

00:05:24,720 --> 00:05:28,240
a bunch of different places you might

00:05:26,400 --> 00:05:29,600
have directly advertised by router

00:05:28,240 --> 00:05:31,199
connected to lan you might have direct

00:05:29,600 --> 00:05:32,400
advertisement from systems like load

00:05:31,199 --> 00:05:34,240
balancers

00:05:32,400 --> 00:05:36,400
you might aggregate the above so your

00:05:34,240 --> 00:05:38,880
load balancers advertise

00:05:36,400 --> 00:05:40,560
23 different ip addresses and as long as

00:05:38,880 --> 00:05:41,199
any of those are up you advertise the

00:05:40,560 --> 00:05:44,400
covering

00:05:41,199 --> 00:05:45,919
24 route ipv4 right and you might have

00:05:44,400 --> 00:05:47,360
static routes and

00:05:45,919 --> 00:05:48,720
anyone who's done a tiny bit of

00:05:47,360 --> 00:05:51,199
networking will hear static rats and go

00:05:48,720 --> 00:05:52,880
oh no no they're terrible don't use them

00:05:51,199 --> 00:05:55,840
unfortunately they ultimately are the

00:05:52,880 --> 00:06:00,000
least terrible option for a bunch of

00:05:55,840 --> 00:06:03,039
uh cases so for example

00:06:00,000 --> 00:06:07,360
we have google public dns quad eight

00:06:03,039 --> 00:06:10,400
we have the route 8.8.8.0

00:06:07,360 --> 00:06:12,800
and it doesn't have a location because

00:06:10,400 --> 00:06:14,000
it's anycast

00:06:12,800 --> 00:06:15,919
it's not actually something we really

00:06:14,000 --> 00:06:17,440
want to advertise in a single place so

00:06:15,919 --> 00:06:18,400
there ends up being a couple of reasons

00:06:17,440 --> 00:06:20,639
why

00:06:18,400 --> 00:06:22,240
we advertise some of our routes and

00:06:20,639 --> 00:06:27,120
essentially all the covering routes

00:06:22,240 --> 00:06:27,120
globally centrally uh through the system

00:06:27,440 --> 00:06:31,360
and these routes look like this they are

00:06:30,400 --> 00:06:33,520
a route

00:06:31,360 --> 00:06:35,120
a comment that is possibly helpful

00:06:33,520 --> 00:06:38,720
possibly not

00:06:35,120 --> 00:06:40,160
and a bunch of magic numbers and

00:06:38,720 --> 00:06:41,600
good luck remembering the magic numbers

00:06:40,160 --> 00:06:42,960
good luck remembering whether a one or a

00:06:41,600 --> 00:06:45,280
zero is the correct thing to be in the

00:06:42,960 --> 00:06:45,280
fifth

00:06:46,840 --> 00:06:50,720
column

00:06:48,800 --> 00:06:52,560
so some of these make think make

00:06:50,720 --> 00:06:53,840
differences like advertise the internet

00:06:52,560 --> 00:06:54,479
is important advertised to peers is

00:06:53,840 --> 00:06:57,759
important

00:06:54,479 --> 00:06:58,319
to internet exchanges now what actually

00:06:57,759 --> 00:07:01,759
happened

00:06:58,319 --> 00:07:04,479
was we have one that is prepend route in

00:07:01,759 --> 00:07:06,800
a certain situation

00:07:04,479 --> 00:07:07,840
and because of weirdness it's actually

00:07:06,800 --> 00:07:09,520
the combination of

00:07:07,840 --> 00:07:12,160
advertise the internet and prepend the

00:07:09,520 --> 00:07:15,280
route that was this magic behavior

00:07:12,160 --> 00:07:16,720
that we thought we had and the reason

00:07:15,280 --> 00:07:18,160
why we thought we had this magic

00:07:16,720 --> 00:07:21,280
behavior

00:07:18,160 --> 00:07:22,800
is because one set of tooling for

00:07:21,280 --> 00:07:25,039
explaining these magic numbers turning

00:07:22,800 --> 00:07:27,440
them back into human readable text

00:07:25,039 --> 00:07:29,039
simply took the last definition didn't

00:07:27,440 --> 00:07:31,280
take the first definition it didn't go

00:07:29,039 --> 00:07:32,400
hey there are multiple definitions it

00:07:31,280 --> 00:07:33,680
took the last and

00:07:32,400 --> 00:07:36,240
strictly it shouldn't have taken a

00:07:33,680 --> 00:07:39,599
combination definition

00:07:36,240 --> 00:07:40,960
but that was about

00:07:39,599 --> 00:07:43,680
so what were we actually doing in the

00:07:40,960 --> 00:07:44,879
first place we had a big block of ipv4

00:07:43,680 --> 00:07:47,440
addresses

00:07:44,879 --> 00:07:50,960
and we needed to break it up assign some

00:07:47,440 --> 00:07:50,960
of the block to specific uses

00:07:51,120 --> 00:07:54,400
so on a thursday morning at my time i

00:07:53,520 --> 00:07:56,639
made a comment

00:07:54,400 --> 00:07:58,800
saying the cl that oh this block of

00:07:56,639 --> 00:08:00,560
addresses we're not doing anything

00:07:58,800 --> 00:08:03,599
externally about them so let's just

00:08:00,560 --> 00:08:06,479
remove those extra magic numbers

00:08:03,599 --> 00:08:07,120
and we go on and do this and christmas

00:08:06,479 --> 00:08:08,639
comment but

00:08:07,120 --> 00:08:10,560
hey we're also setting these magic

00:08:08,639 --> 00:08:12,160
numbers do they matter

00:08:10,560 --> 00:08:13,680
and my comment was along the lines of oh

00:08:12,160 --> 00:08:15,440
yeah yeah that's that's obsolete it no

00:08:13,680 --> 00:08:17,520
longer does anything in the network

00:08:15,440 --> 00:08:19,360
we're completely fine we can just delete

00:08:17,520 --> 00:08:21,680
that everywhere that's

00:08:19,360 --> 00:08:24,479
that's great and i sort of assume that

00:08:21,680 --> 00:08:25,840
would be a cleanup later

00:08:24,479 --> 00:08:28,560
but chris ended up doing it and

00:08:25,840 --> 00:08:28,560
submitting the change

00:08:30,960 --> 00:08:37,279
so why did we get in this situation in

00:08:34,399 --> 00:08:37,279
the first place well

00:08:37,440 --> 00:08:40,320
obsolete config wasn't cleaned up if i

00:08:39,120 --> 00:08:41,519
had removed the behavior from the

00:08:40,320 --> 00:08:44,240
network

00:08:41,519 --> 00:08:45,680
there shouldn't be references to it um

00:08:44,240 --> 00:08:47,839
there's some possible arguments for

00:08:45,680 --> 00:08:48,959
archiving your obsolete magic numbers in

00:08:47,839 --> 00:08:52,320
one place so you

00:08:48,959 --> 00:08:54,320
know not to reuse them we had magic

00:08:52,320 --> 00:08:55,680
numbers humans were dealing with

00:08:54,320 --> 00:08:58,399
humans are terrible at magic numbers

00:08:55,680 --> 00:09:01,440
that's exactly why we built tooling

00:08:58,399 --> 00:09:01,920
but humans shouldn't need to deal with

00:09:01,440 --> 00:09:05,200
them

00:09:01,920 --> 00:09:07,920
we had no tests this is config this is

00:09:05,200 --> 00:09:10,640
config we have some possibility of we

00:09:07,920 --> 00:09:13,760
have some simulation frameworks

00:09:10,640 --> 00:09:16,720
but they weren't practical um we

00:09:13,760 --> 00:09:18,240
the one test we did have was a compil a

00:09:16,720 --> 00:09:19,839
syntax compiler

00:09:18,240 --> 00:09:23,200
that i had written one week while

00:09:19,839 --> 00:09:25,200
getting very annoyed with something else

00:09:23,200 --> 00:09:28,000
and it just validated the config looked

00:09:25,200 --> 00:09:28,000
like config

00:09:28,320 --> 00:09:32,240
we had a network simulation framework

00:09:31,200 --> 00:09:36,720
but the effort of

00:09:32,240 --> 00:09:38,560
actually spinning up a simulation was

00:09:36,720 --> 00:09:40,720
on the order of implausible to actually

00:09:38,560 --> 00:09:42,320
expect people to use

00:09:40,720 --> 00:09:44,640
we had no clear ownership and this is

00:09:42,320 --> 00:09:47,680
actually one of the bigger messes

00:09:44,640 --> 00:09:49,839
we had the ratting con fig at the time

00:09:47,680 --> 00:09:51,279
was regularly changed by people in three

00:09:49,839 --> 00:09:54,320
teams

00:09:51,279 --> 00:09:54,959
and no team really wanted to own it

00:09:54,320 --> 00:09:57,519
because

00:09:54,959 --> 00:09:59,920
well none of us were really staffed to

00:09:57,519 --> 00:10:02,079
actually fix the things we wanted

00:09:59,920 --> 00:10:04,480
and none of the other teams would accept

00:10:02,079 --> 00:10:07,440
that the other team fully owned it

00:10:04,480 --> 00:10:09,279
it was very much a haunted graveyard and

00:10:07,440 --> 00:10:11,839
shared haunted graveyards are even worse

00:10:09,279 --> 00:10:13,440
than the regular kind

00:10:11,839 --> 00:10:15,279
it was also config that people were

00:10:13,440 --> 00:10:18,240
scared of touching

00:10:15,279 --> 00:10:20,640
precisely because if you did bad it

00:10:18,240 --> 00:10:22,959
would cause this exact outage

00:10:20,640 --> 00:10:23,920
which is why it led to being out of date

00:10:22,959 --> 00:10:26,800
and

00:10:23,920 --> 00:10:28,720
normally that's a problem in this case

00:10:26,800 --> 00:10:29,680
because it was out of date i actually

00:10:28,720 --> 00:10:33,839
went and checked

00:10:29,680 --> 00:10:33,839
and that's what saved us

00:10:34,240 --> 00:10:38,480
all right so that's what happened what

00:10:36,079 --> 00:10:41,760
did we do

00:10:38,480 --> 00:10:44,480
well okay let's face it it's a near-miss

00:10:41,760 --> 00:10:46,720
nobody except the people within about a

00:10:44,480 --> 00:10:49,040
hundred meters who heard me screaming

00:10:46,720 --> 00:10:51,279
actually knew that this happened we can

00:10:49,040 --> 00:10:53,760
just move on

00:10:51,279 --> 00:10:56,959
nobody cares we've reverted it it's fine

00:10:53,760 --> 00:11:00,079
we're all just going to move on be happy

00:10:56,959 --> 00:11:03,120
yeah not so much

00:11:00,079 --> 00:11:06,880
so i was physically

00:11:03,120 --> 00:11:08,240
reacting to this three days later i'm

00:11:06,880 --> 00:11:10,959
i have a long history of working on

00:11:08,240 --> 00:11:13,519
major outages things don't tend to phase

00:11:10,959 --> 00:11:15,200
me very much

00:11:13,519 --> 00:11:18,240
and if they do they face me in the

00:11:15,200 --> 00:11:21,120
moment once they're solved i can move on

00:11:18,240 --> 00:11:22,800
this one possibly in part because i was

00:11:21,120 --> 00:11:25,360
part of the cause

00:11:22,800 --> 00:11:27,519
nope i was actually physically

00:11:25,360 --> 00:11:31,519
responding

00:11:27,519 --> 00:11:33,680
for a couple of days now

00:11:31,519 --> 00:11:35,839
when i wrote this presentation and was

00:11:33,680 --> 00:11:39,120
getting feedback from some of the other

00:11:35,839 --> 00:11:41,120
uh people i worked with at the time

00:11:39,120 --> 00:11:43,600
i got the interesting question of would

00:11:41,120 --> 00:11:46,560
we have been better off having the adage

00:11:43,600 --> 00:11:48,240
would we have been would that have been

00:11:46,560 --> 00:11:51,120
the shake-up we needed to get some of

00:11:48,240 --> 00:11:53,680
these underlying issues fixed

00:11:51,120 --> 00:11:55,200
and i spent a whole bunch of time

00:11:53,680 --> 00:11:58,240
thinking about it and my

00:11:55,200 --> 00:11:59,760
answer in this specific case is no

00:11:58,240 --> 00:12:01,360
because we actually had a very similar

00:11:59,760 --> 00:12:04,160
outage

00:12:01,360 --> 00:12:05,600
in some ways that was far more specific

00:12:04,160 --> 00:12:07,360
but it was far more specific in that it

00:12:05,600 --> 00:12:11,200
caused explicit pain to people that we

00:12:07,360 --> 00:12:14,160
most hate to cause pain to

00:12:11,200 --> 00:12:16,160
so we had that and we didn't fix things

00:12:14,160 --> 00:12:18,079
then

00:12:16,160 --> 00:12:20,079
so in this case i don't think having the

00:12:18,079 --> 00:12:23,279
outage would have been better but

00:12:20,079 --> 00:12:24,160
sadly that's a a real consideration in

00:12:23,279 --> 00:12:26,639
some of these

00:12:24,160 --> 00:12:26,639
events

00:12:27,279 --> 00:12:32,480
okay so what what to do well it was

00:12:29,519 --> 00:12:35,519
three days later i wrote a postmortem

00:12:32,480 --> 00:12:38,000
post-mortems being standard in

00:12:35,519 --> 00:12:38,959
google uh across engineering and very

00:12:38,000 --> 00:12:41,120
much so in opera

00:12:38,959 --> 00:12:42,560
in sat reliability engineering and net

00:12:41,120 --> 00:12:45,120
ops

00:12:42,560 --> 00:12:46,880
writer post-mortem and i couldn't really

00:12:45,120 --> 00:12:49,120
get traction people within my team cared

00:12:46,880 --> 00:12:50,399
people

00:12:49,120 --> 00:12:52,160
a couple of people in some of the other

00:12:50,399 --> 00:12:56,079
related teams kid but i couldn't

00:12:52,160 --> 00:12:56,079
get management by in which

00:12:56,720 --> 00:13:01,200
it's a near-miss who cares had this

00:12:59,360 --> 00:13:02,959
happened

00:13:01,200 --> 00:13:05,760
we certainly would have had meetings

00:13:02,959 --> 00:13:07,680
showing up with vps and it wouldn't be

00:13:05,760 --> 00:13:09,279
explain why i shouldn't fire you it

00:13:07,680 --> 00:13:11,120
would be explain the situation what

00:13:09,279 --> 00:13:14,560
you're doing to prevent it

00:13:11,120 --> 00:13:16,880
but it's

00:13:14,560 --> 00:13:19,600
it's a real shame that we it wasn't able

00:13:16,880 --> 00:13:22,880
to be used as that wake-up call that

00:13:19,600 --> 00:13:25,920
i think it was valuable to be

00:13:22,880 --> 00:13:28,959
now i have a thing when i

00:13:25,920 --> 00:13:32,000
when i work on post-mortems around

00:13:28,959 --> 00:13:34,959
haunted graveyard issues which

00:13:32,000 --> 00:13:35,680
tend to be pretty common for me they're

00:13:34,959 --> 00:13:40,560
a great

00:13:35,680 --> 00:13:42,240
time to document things because

00:13:40,560 --> 00:13:43,680
now you've got the incentive to go

00:13:42,240 --> 00:13:46,079
looking at the broken thing that's

00:13:43,680 --> 00:13:47,519
always been there

00:13:46,079 --> 00:13:50,800
write that in the post-mortem tell a

00:13:47,519 --> 00:13:53,680
story uh we

00:13:50,800 --> 00:13:54,880
around this time uh one of my dublin

00:13:53,680 --> 00:13:57,120
tech leads and i

00:13:54,880 --> 00:13:58,320
had collected this collection of our

00:13:57,120 --> 00:14:00,839
post-mortems

00:13:58,320 --> 00:14:02,320
and those unrelated teams that were

00:14:00,839 --> 00:14:05,040
teachable we

00:14:02,320 --> 00:14:06,560
used outages in these big scary systems

00:14:05,040 --> 00:14:09,199
that everyone was worried about but

00:14:06,560 --> 00:14:11,040
depended on as ways to teach these

00:14:09,199 --> 00:14:12,320
systems and understand them

00:14:11,040 --> 00:14:17,839
and learn whether they're still doing

00:14:12,320 --> 00:14:17,839
the right thing

00:14:17,920 --> 00:14:21,760
the other big thing i did is write a

00:14:20,720 --> 00:14:23,920
bunch of tests

00:14:21,760 --> 00:14:25,839
we we had libraries for this juniper

00:14:23,920 --> 00:14:28,959
style configuration

00:14:25,839 --> 00:14:29,760
so i wrote some and pretty much just

00:14:28,959 --> 00:14:32,639
going

00:14:29,760 --> 00:14:34,079
the text looks like the text we expect

00:14:32,639 --> 00:14:36,720
checking a couple of

00:14:34,079 --> 00:14:38,560
the most obvious things are we

00:14:36,720 --> 00:14:40,000
advertising at least 100 rats to the

00:14:38,560 --> 00:14:42,320
internet

00:14:40,000 --> 00:14:44,000
do we have unique routes do we have the

00:14:42,320 --> 00:14:46,480
right magic numbers

00:14:44,000 --> 00:14:47,839
is the topology correct and some of

00:14:46,480 --> 00:14:50,639
these are

00:14:47,839 --> 00:14:52,079
nice useful tests to have regardless

00:14:50,639 --> 00:14:55,120
because they show that assumptions we

00:14:52,079 --> 00:14:58,639
make about the network are true

00:14:55,120 --> 00:15:00,160
and they don't always matter but they do

00:14:58,639 --> 00:15:02,639
make things simpler they reduce your

00:15:00,160 --> 00:15:06,079
cognitive load and that's absolutely

00:15:02,639 --> 00:15:07,440
very helpful one of my experiences with

00:15:06,079 --> 00:15:09,440
writing tests

00:15:07,440 --> 00:15:11,279
for this sort of config has been that

00:15:09,440 --> 00:15:15,519
every single time i do it

00:15:11,279 --> 00:15:18,880
very quickly and even sometimes lately

00:15:15,519 --> 00:15:21,199
we discover they will stop outages

00:15:18,880 --> 00:15:23,440
sometimes we've had minor issues in the

00:15:21,199 --> 00:15:25,120
existing config that

00:15:23,440 --> 00:15:26,800
don't matter sometimes we discover the

00:15:25,120 --> 00:15:28,639
existing config would work fine on its

00:15:26,800 --> 00:15:31,839
own but not when we build

00:15:28,639 --> 00:15:33,839
a full device with that config sometimes

00:15:31,839 --> 00:15:35,360
they're just minor formatting issues but

00:15:33,839 --> 00:15:38,000
we should still should get them correct

00:15:35,360 --> 00:15:38,000
just in case

00:15:38,399 --> 00:15:42,959
uh i can't remember whether

00:15:41,519 --> 00:15:44,560
i cannot remember whether it was with

00:15:42,959 --> 00:15:45,279
these tests or with some of the other

00:15:44,560 --> 00:15:47,680
work

00:15:45,279 --> 00:15:50,160
but i discovered that about 200 lines of

00:15:47,680 --> 00:15:53,440
this file were commented out

00:15:50,160 --> 00:15:56,639
complete accident at one point the c

00:15:53,440 --> 00:15:59,440
style slash star or star slash

00:15:56,639 --> 00:16:00,560
was missing on a line and we had a

00:15:59,440 --> 00:16:04,240
couple hundred lines

00:16:00,560 --> 00:16:04,240
of config just missing

00:16:07,040 --> 00:16:11,680
and then a couple months later this

00:16:08,959 --> 00:16:13,920
event happened in april ish

00:16:11,680 --> 00:16:15,279
and over the thanksgiving holi us

00:16:13,920 --> 00:16:15,920
thanksgiving holiday when things were

00:16:15,279 --> 00:16:19,120
quiet

00:16:15,920 --> 00:16:20,880
i decided that well i was promised that

00:16:19,120 --> 00:16:24,480
the generator for this config

00:16:20,880 --> 00:16:26,320
is totally coming right now we swear and

00:16:24,480 --> 00:16:28,560
as it turned out i think it's actually

00:16:26,320 --> 00:16:33,600
been delivered now sometime last year

00:16:28,560 --> 00:16:35,519
but in the end it took quite a few years

00:16:33,600 --> 00:16:37,759
so i wrote a quick python script that

00:16:35,519 --> 00:16:41,279
took protocol buffer input because

00:16:37,759 --> 00:16:45,600
this is google and now protocol buffer

00:16:41,279 --> 00:16:48,240
is essentially the default and

00:16:45,600 --> 00:16:50,160
simply generated the file as an output

00:16:48,240 --> 00:16:51,759
and that let me

00:16:50,160 --> 00:16:53,120
improve things because now you can at

00:16:51,759 --> 00:16:54,320
least use the names for the magic

00:16:53,120 --> 00:16:57,120
numbers

00:16:54,320 --> 00:16:58,639
now one big set of the magic numbers is

00:16:57,120 --> 00:17:01,519
the locations

00:16:58,639 --> 00:17:02,160
to advertise or out for and instead of

00:17:01,519 --> 00:17:04,480
having

00:17:02,160 --> 00:17:07,520
27 of them except actually it should be

00:17:04,480 --> 00:17:09,280
23 except we added one and forgot

00:17:07,520 --> 00:17:10,640
which was the exact problem you have

00:17:09,280 --> 00:17:11,760
when you've got such magic number

00:17:10,640 --> 00:17:13,600
combinations

00:17:11,760 --> 00:17:16,240
you simply say advertise this everywhere

00:17:13,600 --> 00:17:17,760
and it's all fine

00:17:16,240 --> 00:17:19,360
and i was able to write that generator

00:17:17,760 --> 00:17:21,120
iteratively

00:17:19,360 --> 00:17:23,520
essentially making sure every code

00:17:21,120 --> 00:17:24,640
change either was a single diff that a

00:17:23,520 --> 00:17:27,439
human could verify

00:17:24,640 --> 00:17:28,160
or was no diff and that was really

00:17:27,439 --> 00:17:30,000
helpful

00:17:28,160 --> 00:17:33,840
because i could push the config and be

00:17:30,000 --> 00:17:33,840
sure i wasn't breaking the world

00:17:35,520 --> 00:17:40,160
and that's it thank you very much for

00:17:38,559 --> 00:17:42,799
those of you coming to the pdns

00:17:40,160 --> 00:17:42,799
have a good night

00:17:43,679 --> 00:17:47,360
thank you very much julian that was an

00:17:46,080 --> 00:17:50,880
excellent note to

00:17:47,360 --> 00:17:55,840
finish the system in mini conform and

00:17:50,880 --> 00:17:55,840

YouTube URL: https://www.youtube.com/watch?v=pJuF5YmpxD0


