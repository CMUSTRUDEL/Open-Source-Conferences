Title: DrupalCon London 2011: DAMN QUICK DRUPAL: HOW TO MAKE DRUPAL PERFORM
Publication date: 2013-03-23
Playlist: DrupalCon London - August 2011
Description: 
	Presented by
Michael Cooper
I've often heard folks complain that Drupal doesn't scale well and has issues with performance. You'll hear people saying it isn't suited for large sites, or that it is bloated and too slow. A year ago, after a Drupal site failed abysmally under load (in less than 60 seconds) I was wondering if all of those statements and predictions were true.

As it turned out, I was wrong and oh-so happy to be wrong. To a certain degree Drupal has been a victim of it's own success. The ease with which it can be extended has caused many coders to treat the inner workings as though they were a black box--an attitude that can bring about pain when it comes to light that code added to Drupal doesn't make proper use of all the advanced caching and tuning methods available.

This session is designed to both show how to enhance Drupal's performance drastically, with simple steps and tweaks; as well as provide you with the knowledge about how you can examine what your Drupal site is doing and extend these tweaks and best practices.

I will show you how to serve pages right out of Drupal (no Varnish or other reverse-proxy involved) at under 100ms per page with as many as 100 concurrent users. This course will show you how to make a Drupal site that can serve millions of monthly page-views off just two servers (web and mysql/cache). We'll discuss how to do this on fully anonymous sites as well as sites with high levels of authenticated users.

You'll learn how to make Drupal damn quick.

Intended audience
Coders and system administrators who want to make their Drupal site perform like it is just running core. How to make busy sites run really well on even a single server.

Questions answered by this session
How do I run a busy site with fast page load times

What is the difference between things like APC, memcache, memcached, authcache, boost, etc?

What exactly will pressflow do for my site--both for authenticated and anonymous users

How can I find out what I need to cache most

What are the trade-offs and caveats
Captions: 
	                              all right looks like we're good to go                               here now so I'm gonna start up the first                               thing that comes to my mind and it kind                               of left my mind as I SAT here waiting                               for just come up but I reminded of two                               years ago when he was only a year ago                               when i was at san francisco in the                               second day in the morning grease gets up                               and he stands in front of everybody he's                                just quiet for a moment and he says                                you're all still here and you're all                                still very intimidating I kind of feel                                like that people are saying we'll just                                imagine them naked and I thought well                                that's a great way to get me off the                                stage as quickly as possible a whole                                bunch of you naked nerds is not not my                                thing apparently so so I presentations                                on damn quick Drupal how to make Drupal                                performance scale like a rock star I                                might find yourself warning well who's                                the rock star is the Drupal the rock                                store and I the rock star but they'll do                                to the rock star that's that's the way                                it is so you're just aspiring be as cool                                as the the guy with the bagpipes but no                                it really is that I I do believe that                                Drupal is a rock star I think that                                Drupal is an amazing content management                                system it's fast as scalable it does                                everything I wanted to do before coming                                to Drupal I had built five other content                                management systems so I kind of I kind                                of knew all the stuff not to do at that                                point and I was quite glad to find very                                little of that in Drupal and we sort of                                have a thing at my work at Acquia and we                                have a thing where we say you know if                                you build one or two content management                                systems and you're good three sort of                                the hump at three you should be                                realizing you shouldn't be doing this                                anymore if you go over three it's a                                negative so unfortunately I've I've kind                                of gone that way but they hired me                                anyway so I must do something right so                                the first thing is kind of you know why                                me why am I doing this presentation and                                why I picked this topic well I've been                                writing web apps since                                                CMS's that some of them at their peak                                power                                                            automotive websites I've rumba things                                called auto mall so they're kind of like                                auto trader for those of you familiar                                with that they some of them would have                                five hundred thousand vehicles in them                                and you have to return results of a                                database under                                                     could have a query that would be you                                know querying a database full of cars                                with bhisma is twelve different                                parameters you have to get that result                                with maybe thousands of results back                                within half a second otherwise a safe                                site which is low too slow so I have a                                lot of experience in tweaking databases                                and understanding how they                                work I've built a lot of websites a lot                                of websites in Drupal my built websites                                and Drupal have to handle things like                                five posts a second which when you're                                running something like five plus a                                second varnish cannot save you anymore                                you know you have to actually have                                Drupal running properly you have to have                                a really good stack and I've also you                                know I've launched triple websites that                                came up and then died within                                           because of load so I figure you know I                                know what not to do and I've learned how                                to make that not happen again so that's                                sort of why why why I wanted to do this                                and why why I think I can you know give                                you guys some information to help you                                out with with building a really                                performance Drupal website now a lot of                                you probably think to yourself you look                                at all these Drupal websites out there                                and you sink like you look at like you                                know white house you look at maybe                                Acquia hopefully calm and sups one of                                the websites I run and you look a lot of                                other triple website you're like man                                these things are fast they respond                                quickly they perform really well how                                come mine doesn't do that it's like they                                downloaded this damn quick Drupal                                distribution and i downloaded molasses                                 Drupal or something like that like                                 that's the version that I got and I                                 don't know where I got it from its just                                 i went to drupal.org and apparently                                 there was a link that i clicked and it                                 was the wrong one so the question is you                                 know why our mini drupal websites slow                                 and fail and there's four main reasons                                 why that happens the first one is full                                 page renders that's when every single                                 time so it makes a request to a page                                 you're forcing Drupal to go out and                                 build every individual block and you're                                 forcing it to go out and figure out you                                 know there's URL redirects on links and                                 load the menu system theoretically you                                 can't actually do that unless you're                                 getting is really wrong though the menu                                 system from scratch each time and                                 generate all the HTML from scratch every                                 time you really if you're doing that to                                 all the time if every single page has to                                 do that you're literally looking at some                                 are the neighborhood of                                                queries per page to load a page which is                                 just there's no way that's going to                                 perform well there's no way that's going                                 to scale the other issue that really                                 causes people a lot of pain is the fact                                 that they're serving dynamic content to                                 anonymous users so you've got you know                                 the front page your website so you're                                 running a news site and you get you know                                 I don't know                                                             that website and for some reason rather                                 you feel that I need to have the latest                                 up-to-date content for these users so                                 every single one of those people gets a                                 fresh page but they don't need it you                                 know if you're up front page updates                                 every minute or every five minutes are                                 depending on how                                 your site is every hour even that may be                                 plenty you know some of those blocks                                 they may not need to be you know every                                 single request that you get a fresh                                 block in there so that's one of the                                 other things it causes a lot of pain                                 excessive slow and non-optimized                                 database queries this is the tied for                                 number one with wide jable websites are                                 slow it's you know it's it's both the                                 good the bane and the boon of Drupal is                                 that you don't really have to know SQL                                 all that well the problem is that a lot                                 of people that have built some contribs                                 and written a lot of their own coach or                                 Drupal don't know SQL all that well and                                 if you don't optimize your sequel then                                 you're simply not going to have a                                 website that runs fast or you just don't                                 don't use SQL and you might bill to save                                 yourself that way as well the last one                                 is naughty modules there are naughty                                 modules out there that are doing bad                                 things that are going to make your                                 website run slow and you have to know                                 what those are you have to you know look                                 at the issue queues for modules look at                                 how many sites use them and what not and                                 really make some decisions about about                                 whether or not you want these modules                                 but there's one thing there's one thing                                 that is the answer to pretty much every                                 single issue that you may have with your                                 Drupal that's like running slow and that                                 thing is cash you have to forgive my                                 horrible little picture here I was                                 trying to find a gnome that had cash and                                 all I could find was a geocache know so                                 I figured that's close enough a lot of                                 people you know I've even even last                                 night I was talking to some folks and                                 they were saying that my drupal site                                 runs slow so my you know my ADD bins are                                 trying to do this stuff with caching and                                 and they seem to think the caching is a                                 bad thing they seem to think like oh we                                 couldn't forgot to do it right so now                                 we've got a cache and the funny thing is                                 Aleppo realizes that the people are                                 doing it right that make their sites we                                 fast their site for fast because they're                                 cashing there's not some sort of like                                 secret thing that they're doing well                                 maybe some of them have a secret thing                                 there's haven't shared it with me but as                                 far as I know there's no secret thing                                 and I've got a lot of websites and I                                 work with a lot of people that run a lot                                 of really big websites and it really                                 comes down to is is caching is how well                                 you're caching when you're caching is                                 you're caching optimized and you don't                                 feel bad that you had to fall back on                                 cash and caching is a good thing in fact                                 I'm not going to read discusses a tongue                                 twister                                 but you gotta cash and your cash should                                 be in a cash and you should catch that                                 too and if you think about the entire                                 Internet is just a big long series of                                 caches your browser cache is your your                                 dns entries are cached you know the BGP                                 routes you go across on the internet or                                 cash is probably verse proxies in the                                 middle of all that caching was a CDN                                 caching there's you know when you get to                                 the actual web server there's you know                                 the things are cached on the disk things                                 are cached in RAM things are cached in                                 databases everything is cached and the                                 reason why everything is cached is                                 because stuff is slow if you actually                                 had to load a webpage and between you                                 and the web server nothing was cashed it                                 just would never happen you would never                                 see that web page load that's how really                                 how slow things actually are without                                 cash they just don't work and of course                                 this is the obligatory lolcat screen                                 drupal wants cash to has to have it                                 without cash Drupal wouldn't wouldn't                                 even operate so the question is how does                                 Drupal cash because a lot of you you                                 probably you may think I'll go to the                                 performance page and I see this little                                 checkbox says cash pages for anonymous                                 users or if I'm min Drupal                                             radio dropdowns for type of cash I want                                 to run but that's actually not the only                                 cash that Drupal runs there's actually                                 many many caches the Drupal running all                                 the time a lot of core modules                                 instantiate caches a lot of contributors                                 instantiate catches and they create                                 these cash tables in your database if                                 you ever look at the tables you'll                                 actually see a lot of like cash you know                                 cash filter cash node the vast majority                                 of them actually all use the same schema                                 to there's a couple that are different                                 but they're they're pretty                                 straightforward and how they do their                                 caching and successive versions of                                 Drupal have cached more and more all the                                 time in Drupal                                                        little was cashed in Drupal                                        started cashing a lot of the module                                 lists and whatnot and in Drupal                                          lot of the hooks like like the temple                                 your theme registry gets a lot more                                 things get cached in that so that Drupal                                 has to do less and less stuff on the fly                                 which is why by and large Drupal is                                 actually running faster and faster with                                 your successful successive version now                                 technically Drupal                                                     slower but that's if you start doing a                                 lot of crazy things that all the new                                 modules I had to core will allow you to                                 do but really the the fact that they've                                 added a lot of cash this helps a lot and                                 they've also done a lot of work and                                 successive versions are Drupal to make                                 it run better with more nodes for                                 example Drupal                                                          over the                                    node mark you're gonna start having                                 problems with drupal                                                    get up                                                               issues at all so it's a lot a lot of                                 good things in there one thing of note                                   is that the things I'm talking about in                                 this presentation the vast majority them                                 applied to both Drupal                                                   couple things there specific and I'll                                 call those out but i really want to to                                 make it as as broad as possible because                                 i know a lot of people are still running                                 big drupal                                                              the lot of them they probably want them                                 to run faster so how does Drupal use use                                 the cash in the database well that uses                                 these cash tables to store data and it                                 loads this file called cash Inc you'll                                 find your includes folder and amongst                                 other things it defines these two                                 functions called calf's at and cash gap                                 and they take the same order of                                 variables grab data stick it in your                                 cash get data out of cash provide it out                                 it's pluggable as well so you can                                 actually create your own caching you're                                 like you know what I don't like the way                                 the drupal one does this I don't like                                 the fact is storing it in the table like                                 this I've got this better way of doing                                 it you can come up with your own better                                 way of actually storing your cash and                                 you can do it like use a module a cash                                 router for example or if you use the                                 Drupal                                                                 it you can actually make it so that                                 different things store on different                                 caches so for example you could make it                                 so that your your filter cash stores and                                 a PC and your node cash stores and                                 memcache or something like that you can                                 define you know exactly where each one                                 goes and in fact that's what a lot of a                                 lot of these modules do that give you                                 some performance improvements to cash                                 I've got a couple of listed there like                                 once called cash ironically cash auditor                                 memcache APC these are all modules that                                 install and then you go into your                                 settings dot PHP file and you say ok for                                 here's my setting some include code for                                 this particular cache model going to say                                 i want this particular thing to catch                                 here this thing to cash there those are                                 those are big improvements i'm going to                                 get into exactly how those work but what                                 I really want to start up by showing you                                 guys is sort of just how Drupal CAPTCHA                                 so using the queries it runs show you                                 how you can optimize those queries cause                                 those queries not to run at all make                                 your website faster in some cases and                                 and get a website so they can serve                                 pages in under a second cuz that's                                 really the goal you really want so that                                 when Drupal is done with its HTML on it                                 sends its HTML back to apache or nginx                                 or whatever you're using for your web                                 server that it can do it in less than a                                 second                                 start going over a second that's a big                                 red flag you should really never have                                 that happen because you really want your                                 webpages to be loading for your end                                 users in three seconds and most of us                                 know that you know you design this great                                 website and then you know the marketing                                 guys I know you're out there you have                                 JavaScript includes you want me to put                                 on a website right now I know you do you                                 know they're going to give you a whole                                 bunch of JS files and they're going to                                 say we want all these cool images and                                 whatnot before you know it the front                                 page your website has like                                           that it's got a load after gets that                                 HTML so that HTML needs to be delivered                                 in a second to you know or at least be                                 sent out in a second so that everything                                 else that can happen used to happen so I                                 did a bunch of testing to try and make                                 that to show you guys how you can prove                                 that and I got the cheapest server I                                 could get my hands on I got a one of                                 Rackspace's cloud servers it cost ten                                 dollars a month it's a koala doctor on I                                 don't recall the speed it's got almost                                 no ram which i thought was great for a                                 test because we'll try and do this on                                 his little ram as possible and just                                 running apache my sequel PHP just                                 whatever you know the iran sent to us                                 whoever the you know the young install                                 gave me and no reverse proxy so that's                                 important to note nothing like varnish                                 your squid is involved in this i really                                 want just do my tests with exactly what                                 what the web server and what Drupal were                                 going to do I didn't want anything in                                 front cashing it so the tools that you                                 really want to use whenever you're doing                                 anything like this they're pretty                                 straightforward they're not that hard to                                 get your hands on the develop module is                                 key I'm sure that all of you know what                                 the develop module is and and you're                                 using it not on your production websites                                 but you're using it and if you don't                                 know just don't tell anybody because                                 just pretend you know what the dell                                 module is amusing then go quickly look                                 it up on drupal.org you want to use it                                 to determine what your page load times                                 is what your memory consumption is see                                 your queries and also the newspersons                                 our development integrate with this                                 thing called I called XH prop I think                                 it's always called H prof because I've                                 heard people say that it's this amazing                                 tool that actually grafts out for you                                 and draws diagrams of all the functions                                 and calls that your pages make and how                                 long everything takes integrates the                                 devel modulus it's pretty impressive we                                 have time at the end I'll show you guys                                 some screens at what it looks like new                                 relics a third-party service can be                                 really good for gathering a lot of this                                 data about how well your site's                                 performing its a daemon that runs on                                 your                                 and sort of watches what's going on in                                 reports back to a website that gives you                                 a lot of data and of course the good old                                 ones like Apache benchmark bombard CJ                                 meter some paid services system blitz or                                 services that can do a lot of                                 benchmarking for you but for what we're                                 gonna be doing here I'm actually going                                 to be using just the most basic easy to                                 get your hands on tools we're using the                                 develop module to gather some stats and                                 then we're going to use apache benchmark                                 to see how well things work after we've                                 made some tweaks to a site and just so                                 you guys just for a couple of terms                                 there's cold cash of warm cash i'll                                 refer to that a couple of times you pull                                 your people saying that cold cash just                                 means there's nothing in cash yet you                                 know the site hasn't loaded so the cash                                 tables are or you just click the clear                                 cache button on the performance page two                                 catches her empty warm cash                                 theoretically is when everything is in                                 cash sometimes it takes a couple of page                                 loads to get everything in cash as well                                 future cash warmed up in addition you                                 know things like apache actually has a                                 cache my sequel has a cache and that                                 when you search fire for my ask well                                 you're actually going to have a cold                                 cash and you'll get that warmed up key                                 value stores are things you've probably                                 heard about their things like a pc                                 cassandra memcache ritis all they do is                                 they have a key and a value there are                                 more complex ways to implement them as                                 well but really that in their basic                                 state that's what they are and they're                                 also a lot of times called no SQL and                                 there's opcode caches and compilers a                                 pce accelerator ioncube x cash there's a                                 whole a whole pile of them and what they                                 all do is they compile your PHP in                                 advance so that does not be done to fly                                 every time that's sort of a thing that a                                 lot of you know a lot of hardcore                                 programmers who've been dealing for the                                 languages they come to peach kind of                                 like my god you know why can't i                                 actually compile this in advance to see                                 if I've syntax errors and whatnot and                                 it's and if you think about it's                                 actually kind of crazy every single time                                 your Apache or whatever comes along and                                 says to PHP he says hey hero here give                                 me this page PHP says okay let me find                                 the files finds all the files does all                                 the includes compiles it optimizes it                                 and then hand as it pans it back it does                                 it every single time but the files are                                 the same every single time so there's                                 actually no logical reason to do that                                 and something like a PC will actually                                 cause you to stop having to do that APC                                 will compile all your PHP and then store                                 it in memory so it doesn't have to be                                 done every single time and that's that's                                 like a no-brainer like if you don't have                                 a pc running on a web server you're                                 really just you're asking for your web                                 pages to use four times as much memory                                 to load as they normally what you just                                 you have to use a pc                                 if I was to say that there's just one                                 thing that you could do to make it to                                 your websites more robust that would be                                 it would be to run a PC and it just you                                 just do a pekel install to get it our                                 sorry it's a depending on your OS some                                 some of them actually have them as I                                 think young you could just pull it right                                 down so I want to show you what sort of                                 a calf set looks like and unfortunately                                 that appears to be a little bit out of                                 focus but those big giant blocks over                                 there are actually the stuff that's                                 getting put into the database when cash                                 set is called and what you probably                                 can't read very well here is that says                                 it executed                                                           and I can see better here                                     milliseconds and the page was rendered                                 in                                                                   that's obviously not that good you                                 wouldn't want a page it took three point                                 three milliseconds just to get out of                                 out the door with Drupal you want that                                 page of course to be you know rendered                                 like said it and well under a second so                                 but this isn't this isn't how normally                                 is because this is when when cash set is                                 being run so the you know all the HTML                                 all these variables are all being                                 plugged into the cash once the the cash                                 has been has been set you'll see that                                 there's there's a lot less queries we're                                 down to                                                               all executed in                                                          page was rendered at                                                     can still see all those pesky cash get                                 calls in there and actually if I was to                                 show you to scroll down and show you the                                 whole page that this is the develop                                 module for those of you don't that                                 haven't used this before showing all the                                 sequel queries that were run you'll see                                 that there's probably about                                          cash gets that run on this page which                                 means one-third of all the sequel                                 queries that ran to generate this page                                 where cash gets and you're thinking                                 what's a key value stores it's a key                                 with a bunch of data attached to it does                                 that really need do I really need to be                                 firing up tcp/ip making a connection to                                 my sequel having to check my query                                 seeing if that data is in cash if not                                 pulling the data out of its cache                                 putting into cash that's just a lot of                                 work just for some of this information                                 so the thing that you really want to do                                 is you want to figure out ways to get                                 around that now this is just another                                 another screenshot this is actually                                 after my sequel has done all of its                                 cashing on its end and you'll see                                 the career the times were actually a lot                                 slower before a lot of those cash gets                                 were highlighted in red but now mysql is                                 actually cashed a bunch of stuff too so                                 it's running a lot better but it's still                                 not great so what we want to do then is                                 we want to use a key value store and I                                 mentioned a couple of them before the                                 bigger ones that you hear most of time                                 are a pc or memcache a pc aside from                                 being a a Don that can compile your code                                 also has what's called its user cash and                                 it can actually store variables in                                 memory the really cool thing about a PC                                 is that it runs in the exact same memory                                 space as the PHP process so it doesn't                                 have to make a tcp/ip connection to get                                 data PHP just says hey give me this data                                 and a piece a says there it is and it's                                 pretty quick the problem is if you're                                 running your site on more than one web                                 server then the APC can no longer share                                 memory and so if you run if you want to                                 running mobile web servers you can then                                 use something like memcache and you can                                 say here's my mem cache server out here                                 and then both servers can connect to it                                 which is really neat actually because                                 that means multiple web heads can                                 actually be generating cash entries and                                 storing them so the other webhead can                                 then access it and do otherwise if you                                 don't do something like that each web                                 head has to keep generate generating                                 cash isn't if you think about that                                 that's not ideal because one does all                                 this work to generate this cash the                                 other one doesn't have access to it                                 let's go do all this work to generate                                 cash and you've actually in some                                 respects actually increase the amount of                                 page amount of time it takes to load a                                 page so if you run multiple web heads                                 you really need to make sure that they                                 are sharing cash if you don't do that                                 you're asking for some pain so after                                 adding a key value store in this                                 particular instance I used the cash                                 router module to give myself a PC as my                                 cash because i'm spending one webhead                                 here it's not a problem and I'm actually                                 down to                                                          executed in                                                            page was generated and sent out the door                                 in                                                                    nice that means I'm actually you know                                 I'm a fifth of a second now to generate                                 this page an important thing to note too                                 is that this is a bit of a painful page                                 this is a front page of website that's                                 loading                                                                  showing showing attachments it's i'm                                 running the admin module I've got devel                                 running I've got a lot of stuff going on                                 here that you that you typically                                 wouldn't even be this this mean to your                                 website on a regular basis i'm also not                                 running it as ad                                 so there's a bunch of access node access                                 queries they're running in here as well                                 but I think I've got a pretty good                                 result here i'm down to you know down to                                                                                                  horrible it's pretty fast but i want                                 more so i'm going to go and check and                                 see if mysql is actually properly                                 caching now in this particular example                                 here it's not really this is a page ack                                 to the drupal provides if you actually                                 don't know where he's in drupal                                     haven't found it yet but in Drupal                                      you go to your status page your site /                                 page it'll show you the MySQL version                                 you're running you click on that link                                 it'll take you this page and if you look                                 on that and you look down at the bottom                                 there and you see query cache queries                                 and cash                                                                you know you're in trouble that means                                 that MySQL which has a very good cash                                 actually is not being used at all which                                 is which is bad and interestingly enough                                 this is the the result of the default                                 mysql install four percent OS the                                 defaults that came down didn't put                                 anything in there to enable any caching                                 whatsoever so i didn't really know you                                 don't want to rely on that in fact one                                 of these I've talked about a couple of                                 people recently is that you know there's                                 there's don't assume that the default                                 settings are good and also there's                                 another thing to keep mines there's no                                 one-size-fits-all group of settings for                                 things like a patch your MySQL or                                 whatnot if there was a one-size-fits-all                                 setting they would just come with that                                 and we'd never have to tweak it we have                                 to tweak it because every server is                                 different every environments different                                 every website is different the things                                 you're trying to do are all different so                                 I put in just a these are just the                                 settings I used on my website when I was                                 doing my optimization I had to keep it                                 pretty small because i only had                                          of ram so i couldn't have apache go and                                 chew up you know all of the ram and                                 leave nothing left over for PHP to use                                 so i just gave us some sane settings in                                 here and these are you know if you were                                 to pick seven settings that you have to                                 set on your mysql server you just simply                                 must set these settings these would be                                 then well I guess unless unless you're                                 not running my ISM then you can ignore                                 that one but key buffer size is the key                                 cash so every time you have a table                                 that's got indexes in it you know that                                 key cash is where those indexes gets                                 stored if you don't have that set then                                 every single time you run a query my my                                 school's got to go and load the indexes                                 off the hard drive which isn't really                                 that much of a cache and after a while                                 it's I mean your hard drive will                                 probably cash it for you as well but                                 it's not that well optimized query cache                                 caches the results of queries so if                                 you have two queries that are identical                                 mysql doesn't go out and say hey i'm                                 going to hit the hard drive and and find                                 out what this what the data is going to                                 be for this query it actually just                                 simply says iran this curry two seconds                                 ago i'm pretty sure the results going to                                 be the same dennis is now unless the                                 table has been changed and it'll just                                 give you that result right there query                                 cache limit just limits the size of the                                 query result that can be in there I                                 really hope that none of us are running                                 queries that return results greater than                                 two Meg's on a regular basis at least                                 you know you don't want that in the                                 front page of your website table cash is                                 a pretty neat thing to Maya school                                 actually has the ability to load up all                                 of the tables and just stick them in RAM                                 and it uses your table capsized to                                 number determine how many tables it can                                 do with that that with it once and if                                 you want to really know how well this is                                 working out for you PHP my admin has a                                 great page shows you all this                                 information or you can just run the show                                 status command and at my skull prompt                                 and you can see the setting called open                                 tables in fact i think this page shows                                 it as well nope it doesn't show it but                                 so you can put you can find other ways                                 and if you see that your your mysql is                                 constantly having to open tables that                                 means that these tables are not in cash                                 it's actually taking a table out of cash                                 putting a new table into cash and then                                 constantly doing that over and over                                 again so you got it you actually you                                 really need to watch that setting need                                 to make sure that it's not constantly                                 open tables and the table cash that you                                 have is good enough sort buffer size is                                 pretty important if you don't have a                                 buffer from mysql to do sorts and it's                                 going to create temporary tables on disc                                 into your sorts there and that's bad you                                 do not want to have to do that and a                                 great way to see if that's happening is                                 to will just jump back a couple of                                 slides here if you see a query in here                                 that's horribly slow like it's got like                                 you know those numbers and left you're                                 seeing something it's like                                           milliseconds just grab that query put                                 the word explain in front of it and then                                 run it at the my SQL prompt and it'll                                 actually tell you if it's able to if                                 it's using temporary tables do sorting                                 or if it's if it can't find an index or                                 something like that and now that's                                 that's incredibly important and that's                                 sort of where I got back to one of these                                 I said the beginning is that don't                                 assume that everything was done                                 perfectly for you                                 especially if your site's running slow                                 you want to uniquely you need to look at                                 those things you need to investigate the                                 the queries that are going on and make                                 sure that everything is properly                                 optimized and then the same thing your                                 smiles masoor buffers just other                                 exciting the first knife is used by you                                 know DB the sequences by my ism I                                 believe it's possible but one of the                                 rides the other later versions and then                                 the temp table size is the size of                                 temporary tables that MySQL will make in                                 RAM if you make it and if you end up if                                 there's a in the show status will                                 actually tell you if it has to create                                 temporary tables on disk a lot to do to                                 do joints and whatnot so you want to                                 make sure you have those set so again if                                 you if you if you have a server give                                 them my SQL server and you have not                                 looked at these settings you don't know                                 what they are you need to look at these                                 settings and you need to understand them                                 if you don't do that you simply are                                 gonna have a very hard time making a                                 website that the forum as well I'm not                                 going to give you a lot more detail on                                 this if you just look google like mysql                                 performance you're going to find like                                 the entire first pages we full of                                 websites to describe these settings and                                 tell you you should use this much of                                 your machines available memory for this                                 setting and as much for this setting but                                 they're they're absolutely key so after                                 I've done that I have no more slow                                 queries in fact a lot of these periods                                 that were taking ten they're taking they                                 had like double digit numbers I'll just                                 saying here a lot of them are actually                                 down to just like single digit numbers                                 or even lower if I scroll down here                                 you'll see that none of them are                                 highlighted and read before when on                                 every single screen to fight scroll down                                 there were still some that were                                 highlighted in red and now my my queries                                 are down to                                                            of my queries for my website which is                                 awesome so now i know that mysql is no                                 longer a bottleneck on my site so i'm                                 good i can now look at some other things                                 and so one of things i mentioned before                                 was was a pc a pc i just i just can't i                                 can't say enough about a pc i love it if                                 i did was already married i'd wanted                                 like seriously start taking a pc out at                                 some dates so again like I mentioned                                 before what it does is it's going to                                 compile all of your all of your PHP code                                 and it's going to serve that compiled                                 version it's it's awesome it has this                                 other really cool setting to one of the                                 it does is before it serves that                                 compiled version it goes and checks to                                 make sure your file hasn't changed                                 before it does that so it's like okay                                 file hasn't changed my compiled version                                 is still good but for the majority of us                                 you know we're going to using source                                 control we're not releasing stuff like                                 crazy you know when we when we cut a tag                                 we deploy that to our server that codes                                 not going to change                                 it's going to be the same thing until                                 the you know next week when we cut our                                 next head so this really cool setting                                 called stat zero that you can set or                                 stat and you said                                                     set that in your AP co dot ini file and                                 it no longer runs that check so it's a                                 really neat thing to do you can actually                                 you can actually blow up your website                                 and in fact is set to stat zero just                                 going to leet your files and your                                 website will still a load because my APC                                 actually has them all caption memory it                                 doesn't even check the disc anymore                                 which is great because you know you just                                 you don't wanna hit the disc if you can                                 get away with not hitting the disc you                                 want to do it and other neat things to a                                 drupal module such as caps router and                                 the APC module and other ones will                                 actually integrate with a pc so that if                                 you were to go in clear cache in drupal                                 it knows to go and clear the APC cash as                                 well so you don't have to worry about                                 like all i've got to go in like restart                                 apache when I want to do this stuff you                                 just hit the clear cache button in                                 Drupal and you know the the the cache                                 inc module that comes with cash router                                 for examples it says okay we're using a                                 PC and it goes off and makes the call to                                 clear the APC cash so it's pretty sweet                                 the other thing you get with APC is you                                 get this really cool page that gives you                                 all these stats on how much of your                                 you're a PC cash you're using its                                 fragmented it's also got some hits and                                 misses not in here so you can see if                                 you're getting good hit rates and good                                 mrs. and you can optimize and tweak from                                 there on in it also shows all of your                                 stats down below and in addition you can                                 see that's got you can put I don't you                                 can see that perfectly well up there but                                 you've got system cache entries and user                                 cache entry so system cache is the                                 opcode cash where's captioning all the                                 pages and then user cache entries is                                 where it's actually captioning like your                                 key value stores you can clear those                                 independently as well so it's pretty                                 neat I've actually seen the people have                                 made this from memcache as well so you                                 guys use memcache for some of the stuff                                 there's a page like this as you can get                                 from memcache which is is pretty awesome                                 so the result of all of these tweaks and                                 tests when it's all said and done is                                 that this page now runs                                               there's another thing I did in the                                 middle in here that i forgot to run made                                 all my screenshots is that another big                                 table once you eliminate all the caching                                 tables the table is going to cause you                                 most pain is the session table because                                 every single time some module decides                                 the store value in the session it                                 whenever Drupal hit cook eggs eat it                                 goes out and it says okay here's all my                                 session stuff and it goes and puts it in                                 a session table for that user and you'll                                 end up with just massive inserts going                                 into the session table                                 and the problem is that especially                                 you're running my ism which you                                 shouldn't be doing you should be writing                                 you know didi especially the running my                                 is and you're locking the table during                                 that insert and when every user and your                                 website is waiting for this you know the                                 session insert to insert call to get it                                 done so a PC and memcache both have                                 options you can take your session table                                 and you can stick that into those caches                                 as well and you're no longer doing those                                 rights to to mysql and in fact you'll                                 notice that i went down from                                         queries which is great especially                                 considering that we started out at three                                 over                                                                    now the page is being sent out the door                                 in                                                                      only taking                                                           like I said this is a front page it's                                 got a lot of stuff on it I'm using a                                 very slim theme so obviously if I would                                 be running some big monstrous theme I                                 would probably see a lot of my numbers                                 double in there but for the for the                                 purposes of this test i wanted to show                                 just really what what settings are                                 affecting what kind of sort of course                                 settings are out you can speed things up                                 and then for a single note if we could                                 just one node will see that                                                                                                                     was a little longer but that was plugged                                 because something was getting written                                 into cash probably the page got written                                 into cash and it was                                                     the other thing too is you want to see                                 well how fast is this for anonymous                                 users so a great tool for that if you                                 guys known as ever use that before is to                                 use get the Firebug extension for                                 Firefox and hit the net panel and if you                                 get the net net panel you can actually                                 see all of the files on your website and                                 how long they take to load and we'll see                                 that our page itself to get out the door                                 with the packaging everything took two                                 hundred and two hundred ninety nine                                 milliseconds which is pretty good that                                 means that my brows are made a request                                 went out to Apache Apache talk to PHP                                 got the result back send it back to my                                 browser and I got it                                                  which is good that's what I want and in                                 fact my entire page loaded none one                                 under one second which is what I want                                 except I've made a classic mistake here                                 I forgot to hit aggregation for jsin and                                 CSS files so if I do that will actually                                 see that I now I'm only making                                    request to my web server which is                                 awesome and all of us forget that                                 sometimes it's okay I do it too so a                                 little bit more on Drupal castings we've                                 talked a little bit about how Drupal is                                 doing all this caching where it's                                 putting it how we can improve our sites                                 by sticking it somewhere else and so you                                 wonder well when does Drupal create cash                                 the answer is all the time                                 you know you're a new module makes us                                 change to the the variables table well                                 the variables table is cash so you go                                 when you hit the save page on the module                                 Drupal goes out and it clears the the                                 variables cache entry out of the cash                                 table builds a new one sticks into that                                 cash table you know you may you change a                                 menu item well that menu cash is an                                 updated all the time caches are being                                 updated and so the next question is well                                 when does your book clear cache and the                                 answer that is all the time Drupal is                                 constantly clearing things out of cash                                 putting new things into cash now some of                                 the things are kind of interesting here                                 that that I was actually not even fully                                 aware of even up to like a year ago is                                 that there are things that get cleared                                 out of cash at times you just would not                                  expect so for example if you've gone                                  into the performance page and you said                                  cache blocks or used to chat set on                                  Drupal                                                                  default on Drupal                                                        pages for anonymous users what that                                  actually does is on hook exit Drupal                                  takes all the HTML just rendered to                                  deliver that patient it sticks it into a                                  cache table so that doesn't have to keep                                  doing that over and over again which is                                  fantastic I'm and again if we do                                  something like a pc or memcache it                                  didn't stick into a cache table stuck                                  into a key value store up in a server                                  somewhere that's going to save us even                                  more time but if you save a node Drupal                                  calls this function called cache clear                                  all and what cache clear all does                                  without any primers paths to is it wipes                                  the node in the block caches so you're                                  like you know your site's being hammered                                  you're like yay it's standing up well                                  everything's going well and one of the                                  editors is like oh crap we got / dotted                                  I have this mistake in there so that                                  editor goes they modify that note they                                  hit save and your block Cashin your page                                  cache for your site are wiped out and                                  now the next thousand people that are                                  about to hit your website are all                                  waiting you know maybe six or seven                                  seconds for the first person that hits a                                  page again for the caches to all be                                  rebuilt which is obviously not good at                                  all the reason of course why Drupal does                                  that is say for example you've got a                                  front page with a bunch of views                                  displaying you know it's a bunch of                                  nodes on it you've got a list of nodes                                  on the front page of what not maybe a                                  couple of blocks and they maybe they                                  pull data from a note as well as rupal                                  doesn't really know or you know it's not                                  feasible for it to keep track of exactly                                  what knows are stored in the front page                                  which it says if you modify a note I                                  have no idea where data from this node                                  could possibly be called from at any                                  time so I was got clear all the caches                                  because chances are data from this node                                  showed up somewhere so that's why or not                                  all the cash is the                                  lock in the node caches so that's why it                                  does that but you can get around this                                  you can save yourself from accidentally                                  stumbling and falling on this particular                                  issue and what that is is on your                                  performance page is this a little                                  drop-down it says minimum cash lifetime                                  and that is your savior you know that                                  thing there it that setting wants you to                                  set something other than                                             desperate for you to do it's calling out                                  it's like give me at least five minutes                                  so whenever cash clear all is called it                                  says I'm gonna clear catch for                                  everything that has been that's older                                  than that setting which is what can                                  really save you you know went from a lot                                  of things if you think about all the                                  content editors doing things on your                                  website every single time they're saving                                  a node they're clearing the block in the                                  node cash for a single page in your site                                  so give that thing instead and giving it                                  at least five minutes and that way                                  things like your front page and whatnot                                  are going to always be cached or five                                  minutes now there's some people say oh                                  my goodness five minutes is a long time                                  for for this page be cash but keep in                                  mind this just for anonymous users                                  authenticated users they're still                                  getting a fresh page so if you think                                  about if you've got like a news site                                  it's okay for that front page to be                                  cached for five minutes it really is i                                  promise you you know no one's going to                                  cry if that no title that's in that one                                  block over on the side it doesn't update                                  for five minutes or if it is imperative                                  that it does you know go and                                  deliberately hid the clear cache button                                  that will do it don't let fate sort of                                  just have its way with you i would                                  strongly recommend setting that setting                                  to like an hour or even six hours if you                                  can get away with it and just be smart                                  about knowing when to clear cache you                                  know by hitting the clear all caches                                  button so again that's that's an easy                                  win you know set that setting SATA page                                  cache you know you may not have that may                                  anonymous users but still set that page                                  cache so that they don't have to so you                                  don't have to be generating you know                                  fresh pages for them all the time and                                  then the last thing is to double check                                  your headers make sure that the headers                                  at your browser you're sending out to                                  the browsers don't say things like no                                  cash or don't have a max age because                                  those are the things that determine                                  whether that the browser is going to be                                  able to cash the cash the page or not if                                  the browser can't capture page the                                  browser's making a fresh request every                                  single time and you can save yourself                                  from that                                  in Drupal                                                              flow to get the option to have a max age                                  and in or you can just a series of                                  patches you can use as well and in                                  Drupal                                                                    so I'm just going to show you guys some                                  examples here we saw before that it took                                  two hundred and ninety nine milliseconds                                  to get this page out the door but by                                  turning on the Drupal cash duple normal                                  cash in Drupal                                                            milliseconds and then by using Drupal                                  aggressive we drop that down to                                     milliseconds the difference between the                                  two of those is that Drupal normal will                                  still make a couple of database calls                                  and make sure check some variables and                                  look for it actually doesn't fire hook                                  in it but it looks for a couple other                                  things you can you can kind of get your                                  get your foot in the door on that one to                                  make some changes drupal aggressive                                  basically instantiates the database and                                  the first thing it goes off to do is                                  look to see if it has that page in cash                                  if it does it gets that page serves it                                  and exits but Drupal aggressive requires                                  you to set a min and a max age to really                                  make use out of it like I said about                                  that max age you're not going to get                                  things like like varnish is going to                                  build a cache and whatnot so it's pretty                                  key and Drupal                                                        fixed soon to whoever's responsible or                                  such things there's no option in the                                  interface to set an aggressive cash you                                  actually have to go and make some                                  changes in your settings about PHP file                                  and if you google or if you look on                                  drupal.org for Drupal                                                    a page written by Peter will land and he                                  has the exact instructions on what you                                  need to do in your settings about PHP                                  file to get an aggressive cash for                                  Drupal                                                            aggressive cash I can't think of well I                                  can give a couple reasons but they're                                  very minor why you wouldn't want to grip                                  on aggressive and even if you're looking                                  there and you're looking in Drupal                                        you see aggressive and you see all these                                  modules listed out in red that that are                                  incompatible with aggressive that                                  doesn't mean those modules just                                  disintegrate and your website falls over                                  something like that it just means that                                  the hooks that they may want to run                                  don't get called when you choose                                  aggressive for an example be the                                  statistics module when you set the                                  aggressive cash the hook that statistics                                  module requires which i believe is hook                                  exit                                  to gather statistics just doesn't get                                  called it doesn't mean that your weapon                                  is going to break it just means those                                  modules may not have all the                                  functionality so I mean if you if you                                  think you can get away with with without                                  those modules having full functionality                                  for your anonymous users set aggressive                                  there's there's absolutely no reason not                                  to do that so the next thing up here is                                  apache and PHP now i'm talking mainly                                  patching in fact all my tests were done                                  in apache because that's the one that we                                  run the most sure there's things like                                  light H TBD and there's engine X and                                  whatnot but the folks are running those                                  honestly probably already know all this                                  stuff and in addition there's a lot of                                  times where you may not want to run                                  apache but you have to maybe you need to                                  use like the ldap module and pass you to                                  do some sort of reverse proxy or it's                                  very mod proxy and model off and apache                                  do some sort of ldap reverse proxy                                  authentication where you've got to get                                  through your proxy server with storing                                  session cookies and stuff like that and                                  you've just got to use apache because                                  they're the only wasn't have that so i'm                                  talking about you here and all my tests                                  were done at apache and the bit first                                  question with Apaches while do you run                                  mod PHP or do you run fast CGI                                  personally I would almost always                                  advocate running mod PHP mod PHP gives                                  you a lot of benefits one is that the                                  Apache workers have already brought p                                  brought PHP up they've got it running                                  any time Apache workers fires up at                                  Scott HP already running and loading in                                  it whereas fast CGI doesn't necessarily                                  do that now the advantage of flip side                                  of that is if your website serves a lot                                  of other stuff that's not PHP then then                                  maybe mob gauge bezel of a detriment                                  because Apache fires up in every single                                  worker thread brings up k HB along with                                  it and it serves a gif file and that                                  happen if that happens more often than                                  PHP files then you know then you can                                  have a problem although if your web                                  server is serving gobs of non PHP files                                  you really shouldn't be getting to                                  Apache for that usually running a CDN or                                  be running something varnish and serving                                  all those files but there the other                                  advantage is that if you run plot mod p                                  HB every single apache process can share                                  memory or more specifically the PHP                                  running for every Apache process can                                  share memory so that way if you've got                                  like                                                           the Apache and they're all running my                                  PHP that means that if this particular                                  one does something and it sticks to say                                  for example of the apc's caches this one                                  can grab it as well and pull that data                                  out if you're running fcgi then this one                                  put something into cash this one has no                                  access to it so in fact everything I                                  said about PHP or about a pcs speeding                                  up want everything and making it                                  wonderful / virtually goes out the door                                  with Mon fcgi not entirely because it's                                  still better than having no cash at all                                  but none of these processes can share                                  cash anymore and on the flip in addition                                  to that is that you know most websites                                  you probably looking at                                                 you want to give to a pc to store stuff                                  well if you're using s CGI that means                                  every single process is going to use up                                  in                                                                    which is maybe you don't have enough                                  memory for that in your server or maybe                                  you didn't even think about that you're                                  thinking okay PHP is only taking you                                  know                                                                     got you know                                                            for PHP therefore I can have you know X                                  number of processes but you forgot about                                  the fact that APC is in there you know                                  and you've been able caches for that                                  every mob cage being you're like adding                                                                                                            processes which can bring your site down                                  if you get hammered in a way that you                                  weren't expecting and that brings us to                                  maximum simultaneous processes you need                                  to understand those settings I'm going                                  to get into that a lot more detail                                  because you can do everything right and                                  just put one number wrong and your                                  battery configuration file and have your                                  website disintegrate and not even under                                  heavy load in some cases you to                                  understand the Apache modules I know                                  this sounds crazy i'm like telling you                                  to do something you really don't want to                                  do but look at the apache modules that                                  are running in the apache conf file and                                  then go to the Apaches website and read                                  up what they do chances are you don't                                  need half over them but every single one                                  of them spinning stuff up and loading                                  into memory on every single page request                                  and you're never going to use it and                                  there's no reason for it pre fork I                                  prefer pre fork                                  I'm just because that way it's already                                  done and also because it does depend                                  someone your operating system whether                                  all you want to run the the forked                                  Apache or if you want to run the the                                  threaded version of patchy ironically on                                  Windows threaded works better and on                                  Linux pre for coach better which is                                  pretty much what everybody runs and then                                  min servers and sparrow servers these                                  these two little numbers that are set in                                  your patchy configuration for I almost                                  feel like ah says eight and five that                                  looks good to me or something like that                                  the thing that those really do is that                                  the say for example your you you have                                  your maximum number of Apache process is                                  set to                                                                    your spare set to eight that means that                                  you turn on a patchy and it fires up                                  five of those processes and then it says                                  and you get to get slammed and it fills                                  up all                                                                 it'll shut some of them off as they're                                  not being used and it'll drop down and                                  keep                                                                      is that you want to keep those do you                                  want to try actually keep a lot more                                  servers right a lot more processes                                  running for a patch you want to have as                                  many children as Vale bows you think                                  you're going to need at any given time                                  so you need to chances are you two up                                  those numbers because firing up those                                  additional process is expensive if you                                  have five Apache processes running you                                  get                                                                       it needs to fire up so you get                                     requests each one is additional five                                  innings fire pits like firing up a                                  program it takes as long well it takes                                  last time you know than if you're doing                                  it to know s but it's like it's like                                  starting something up it's actually got                                  to fire it up it's got a little over the                                  modules process the configuration files                                  and so on and so forth and you really                                  don't want to have to do that and the                                  last one is child lifetime there's this                                  little setting and it says child                                  lifetime and I think the default is that                                                                                                         means that child processes there and is                                  serving pages and it's firing up you                                  know but PHP and doing all this stuff                                  and it gets ten thousand you're being                                  slammed by the way your website just                                  being hammered it gets to a thousand                                  says up someone thought I must've a                                  memory leak I'll just shut down now and                                  it shuts down and patches like I got to                                  fire another one up and you're doing                                  that probably at very inopportune times                                  if you don't think you have memory leaks                                  and you've watched Apache and it stays                                  pretty stable limit it shuts off                                  processes the memory consumption it goes                                  back down set that to zero and then                                  maybe just restart apache manually you                                  know on a certain schedule or just let                                  your ops team if you have guys like that                                  handle that but you really you don't                                  want to set that something like a                                  thousand because that means after a                                  thousand requests that restarting                                  setting that number two                                  thousand getting slammed will bring down                                  your website quite likely so you know                                  set that to a really high number or                                  possibly set it to zero and just have                                  those things never restarted                                  automatically just wait for Apache self                                  to be restarted to determine that so the                                  one of these I touched on briefly here                                  was the maximum simultaneous processes                                  that's really the the most important                                  thing like how many simultaneous                                  requests are you getting how many                                  simultaneous processes you'll be firing                                  up to handle that if you get those                                  numbers wrong like I said you'll bring                                  your site down so the first thing you                                  need to do to understand that is you                                  need to know will how much time does it                                  take to look for me to load a page and                                  how much memory does it take to load                                  that page I'm talking in PHP at this                                  point so this is the performance                                  monitoring sub-module that comes with                                  devel like I said there's a lot of other                                  ways to get these get these numbers as                                  well you can use New Relic as a great                                  tool to but this is something that we                                  just have all available to us you                                  download the module you install you let                                  it run for a while and we'll see that                                  this particular website this was a small                                  test website the average memory per page                                  is is                                                                     nine milliseconds to load a page so what                                  that tells me is that my test server                                  that I had with                                                        assume that i can maybe give allow PHP                                  to have                                                                   a little bit too generous i probably                                  don't actually have quite that much                                  memory available for it i should also                                  take that number and add to it because                                  that's really that's from hook hook boot                                  to hook exit that's how long or how I                                  that's how long it took for those two                                  things to happen but there's some stuff                                  that happens before and after that and                                  there's probably little bit of time that                                  apache is spending dealing with the                                  request before and after that so you                                  know you could be safe you could add ten                                  to fifteen percent of that number which                                  then gives me                                                          the result out the door for the fur my                                  page loads on average on this site now                                  that means that I can have                                     simultaneous processes running so then                                  ideally I will be able to serve                                           per second                                  that gives you your number so if you                                  were sorry with that a minute yep yeah                                  so it's per second so yeah                                               second does that means this website can                                  serve                                                                    great now considering this is a fairly                                  small website and there's not a lot                                  going on that's going to be okay you're                                  gonna of course come up with probably                                  significantly higher numbers on this and                                  a lot of will be due to your theme                                  believe it or not that's what's going to                                  chew up a lot of the RAM when it comes                                  to loading your page so you want to know                                  what your what your traffic peak is so                                  free cuz those numbers I gave you those                                  numbers are probably gathered a lot of                                  them at times in my websites not really                                  doing anything which means those numbers                                  are all ideal so what you want to do is                                  you actually want to use a tracking                                  system you can use Google Analytics oh                                  but that's not gonna help you a lot of                                  you're using page caching like barn is                                  just something like that performance                                  logging is a great one to use like I                                  showed you can use your web server logs                                  and you want to remind page loads you                                  get during your peak traffic time so say                                  for example your peak traffic time is                                  one in the afternoon you don't want to                                  you want to get like you want to grab                                  the peak so you want to grab like the                                  top ninety percent removing the top                                  ninety-five percent of that peak and you                                  really want to look at the numbers                                  during that part of the peak you don't                                  want the whole thing because that's                                  going to skew you you're going to see                                  better page load times at the bottom and                                  they're going to skew your numbers you                                  want to basically make sure that your                                  website is going to perform perfectly at                                  peak because to be honest when you get /                                  dotted and                                                            your website your web site falls over                                  that's time your bosses get really                                  pissed they don't care as much for                                  crashes at two in the morning for some                                  obscure reasons they don't want to crash                                  then so you have to you have to plan for                                  your Peaks so you determine you how many                                  pages by minute you get during that peak                                  and you know how long it takes to                                  generate your pages so you can use this                                  this handy-dandy little equation and you                                  can say okay my pages serve / my minutes                                  x my execution time /                                                  the concurrent processes I need to serve                                  this request so my example down here                                  I've got                                                              five minutes if it takes a third of a                                  second to serve them all then I only                                  need to point to two concurrent                                  processes to serve these requests it's                                  long would be great i would be great                                  because we just figured out that my my                                  website can be know that my web server                                  is set to                                                                processes now this this will bite you in                                  the ass if uses exactly like this                                  because you know not all of your users                                  are just waiting you know making their                                  you know in nice order you might have                                  like                                                                  once so you would logically you'd want                                  you'd want to try and work that out you                                  wanted me to try and say okay chances                                  are that my spikes are really sharp on                                  my web server which means i'm getting a                                  lot of people making simultaneous                                  requests sure I've averaged them out                                  over a particular period of time but I                                  know that you know within that five                                  minutes i have i have high points in                                  there so you either a just want to                                  multiply that number by something like                                  four to say okay you know that's going                                  to give me some head room or if you want                                  take a smaller sample you want to figure                                  out like maybe down to like half a                                  minute how many requests are getting in                                  your dirt in that top half minute of                                  your peak and base your numbers off of                                  that but you want to know you want to be                                  smart about that so after setting all                                  the stuff up my website decide to hammer                                  it and unfortunately this isn't well in                                  focus freeze you can't see it in great                                  detail but i use apache benchmark for                                  these tests patrick benchmark is                                  probably not something you want to run a                                  full-scale web test against but it gives                                  really cool stats and I like see doesn't                                  seem to give sort of the level of detail                                  that I like or there's a setting that                                  that's unaware of but the mac i mean a                                  thousand requests with patchy benchmark                                  against the server and I requested a                                  concurrency of                                                           gentle on my server I'm saying I know it                                  can handle                                                             serve only ask for                                                        so it took twenty one point four seconds                                  to serve those thousand requests and I                                  was like to able to serve                                                 second which is pretty freaking awesome                                  actually I think and down here in the                                  the left hand side you'll see that my                                  lowest request was served in six                                  milliseconds and ninety-nine percent of                                  the press were served in under eighty                                  nine milliseconds which is pretty good                                  so next question as well what can we do                                  now so I then said I want to make a five                                  thousand requests and I request them                                      at a time and so the interesting thing                                  is that my website survived this and                                  actually survived it fairly well it only                                  took twenty eight point nine                                  milliseconds there are five thousand                                  requests whereas before I always served                                  a thousand                                                             that's pretty                                  good and the reason why this happens of                                  course is because the operating system                                  when Apache says hey I'm full I can only                                  take                                                                      system doesn't just sorry guys you know                                  you're getting you're getting a                                      error of some sort it'll just queue them                                  up and wait but the thing you'll notice                                  here is that my meantime per request is                                  significantly worse so i'm at                                     milliseconds to request there and now at                                                                                                       survey request which means my users are                                  not happy with me now their website                                  their pages are loading a lot slower                                  than they were before and that's because                                  most of those users are sitting in queue                                  waiting you know for apache to get                                  around to serving the request Apaches                                  fine my run queue when I ran these tests                                  in the servers at around like ya know                                  wasn't it was like point H or something                                  like that so it was good but law of the                                  time that might the user group we're                                  dealing with we're standing just waiting                                  for those requests to come through so                                  then just for kicks I'm like well what                                  if i take my server limit and i change                                  it to                                                                  ram court but maybe the maybe the disk                                  can handle it and i'll swap and we'll be                                  all right and what we'll discover is                                  that it takes longer by setting it to                                     so i've actually have actually made my                                  made my test take longer and I've made                                  the the users wait longer as well so                                  that's kind of interesting you know I I                                  had a I had my web server i know my web                                  server wasn't really adequate for the                                  task and I but I was being you know                                  setting my max on the proper that I'd                                  done the math I figured out how much ram                                  it took it how much ram i had available                                  and i knew that i could handle                                     concurrent processes patchy was not                                  going to have to start swapping on the                                  disk to serve those                                               processes because i had enough ram for                                  it but i went over that now the thing                                  starts to get worse and if i have to set                                  this to                                                                 bring the server down it'll actually                                  lock up i'll have to reboot it what i                                  what i would do that so that's that's an                                  important thing to understand and just                                  to give you guys an idea on the default                                  setting in apache typically as                                                                                                                  down so and if you think about if you                                  think your website takes                                                  this that's a conceivable number to get                                  a page out the door and it's up to                                      you better have a lot of rama on that                                  machine a deal with the super web we                                  press otherwise patch is just going to                                  say yeah bring them on i can serve these                                  requests and it's gonna shoot a monogram                                  and then it falls over so you do not                                  want that you want you need to go in                                  there you need to tweak that setting the                                  default install apache is designed for                                  HD                                  pages it's not designed for for you know                                  a CMS like drupal and it will it will                                  bring your site down but the good news                                  is like I said that you can you can                                  still handle you know more traffic than                                  you should be able to handle because if                                  you're if you're telling if you're not                                  make forcing Apache to do two more work                                  than I can handle you know the OS will                                  cue the request and they'll all get                                  through without bringing your site down                                  the site couldn't handle you know                                      concurrent requests for forever and it                                  wouldn't have gone down now some of the                                  users might eventually got timeouts on                                  the request but the server wouldn't go                                  down which means that you know                                  worst-case scenario you don't have to                                  sit there making a call to a data center                                  getting the reboot a server in the                                  middle of your of your peak you might                                  stuff a couple people that don't get                                  pages obviously still not ideal but it's                                  better than the alternative so after                                  doing all of this you then need to                                  assume the worst you need to assume that                                  you just got slashed dotted and you've                                  got more requests and you've ever seen                                  coming to your website and like I                                  mentioned before that content a door                                  sees that they've made a typo in an                                  article and they go and edit a page and                                  it clears cash and suddenly Drupal has                                  none as data and cache men cast been                                  cleared a PC has been cleared and                                  everything is being built up from                                  scratch now if we remember when we go                                  all if I were to go all the way back to                                  the slide scratch was a lot longer                                  scrapping you know when I but I'm                                  running well I'm able to serve requests                                  in                                                                       things from scratch it was taking over                                  three seconds so what you really should                                  be doing is you should be going and                                  running all of these tests that we just                                  went developing all of these numbers all                                  of the stuff with Drupal page caching                                  turned off assume that someone made a                                  mistake someone was doing something last                                  night and they turned off page caching                                  and you don't have that available to you                                  and that you're taking longer to run                                  your request so when you go back                                  actually to the we're gonna pop back to                                  here                                  when you go back and you get your                                  numbers from the develop module or                                  whomever you want to get them make sure                                  that when you do when you get those                                  numbers MBU have to you have to spin up                                  a test site and mimic the traffic to do                                  this but you get those numbers you know                                  with page caching turned off because you                                  need to assume that page caching is not                                  running when when you get hit I mean                                  granted that you don't you don't ever                                  want that to happen but you don't want                                  to be in that position where your                                  servers cannot handle anything like that                                  or you know or cash gets cleared or                                  something like that or or just it turns                                  out that you know a bunch of your pages                                  you set like a good number you set an                                  hour something like that but that number                                  happened to coincide with the middle of                                  a spike I mean there's a lot of reasons                                  why that could happen now on the flip                                  side you could simply just go and and                                  turn off all of your cash in turn off                                  all of those features about modify it                                  modified court but dress will find you                                  and you won't like what happens so                                  apparently i'm actually going really                                  long here i just realized i had looked                                  at my time with all but there's some                                  some other optimizations you can do and                                  one of them is that Drupal is a giant                                                                                                          and other URLs you hit exist it's a                                  giant                                                                here's this pretend you are a long and                                  pass that index top cage music is a                                  variable and Drupal will know what to do                                  the problem is that if you get a website                                  and so I made a mistake there's a gift                                  that's not not there anymore you know                                  there's a JPEG that's not there anymore                                  an area near your CSS file that means                                  that you're actually taking three page                                  loads to load a page because page loads                                  up there's missing there's missing files                                  and drupal's like one I'm handling those                                  files so it's serving pages to the                                  browser for missing gift and is serving                                  a page for missing missing missing jpg                                  or something like that and instead of                                  taking you know in my case                                             ram to load the page it now takes                                     megs of ram below that page because i'm                                  serving these                                                           there's drupal                                                           but if you google along if you look                                  around rupal oh there's a thread on how                                  to write some code into your settings                                  about PHP to make basically detect                                  extensions you don't want triple to                                  serve with the exception of image cache                                  URLs and serve those you know just as                                  it's just static little header and like                                  a little bit of text saying this is a                                                                                                         actually I'd made call fast for for that                                  you can check out as well that does that                                  sort of thing is a module and it'll also                                  do it for URLs you want to be careful                                  cookies because setting cookies will                                  clear your varnish cash I won't get                                  great detail and path alias cash is a                                  really big thing this comes with press                                  flow in Drupal                                                          get it there what happens is if you                                  think about every single you got a front                                  page you got only these notes /                                           to note /                                                               but you've enabled URL aliases then what                                  Drupal is going to do is for every                                  single one of those it's going to make a                                  query to the URL Isis table and say hey                                  you got an alias for this thing and if                                  it does it's going to use that alias                                  instead the problem is you could have                                  hundreds of those on a page you're                                  thinking about a front page of your site                                  there's got a lot of block showing views                                  and whatnot you were going to be making                                  hundreds of extra queries so the path                                  alias cash what does is it says okay for                                  this page these are all the path aliases                                  on this page I'm going to store them all                                  just one big chunk and that way we don't                                  have to make hundreds of queries we just                                  make one query and get those out like I                                  said session data cache in hoops session                                  data caching is something that you go                                  back up that you definitely want to do                                  you want to use the memcache module to                                  your session data caching or you can use                                  a PC and cash router for that sort of                                  thing examine those views like I said                                  you really want to be looking at those                                  if you run devel and you see a bunch of                                  user taking forever to load you want to                                  examine those views run the explain                                  query against them I'm normal time to                                  talk about head site includes but                                  there's a module on drupal.org called                                  edge side include ESI you want to look                                  up that module that module can allow you                                  to actually use varnish and in concert                                  with logged in users and serve them some                                  cache data mix in with some non-cash                                  data and save yourself a lot of pain and                                  then the last thing you can always                                  consider doing is making it so your                                  front pages always cash regardless of                                  who they are I've done this before with                                  varnish you could actually get away with                                  doing this and Drupal as well where you                                  could basically just on like hook boot                                  you can learn you could write this in                                  your boot strap depending on how your                                  how you want to set this up or you could                                  look and say okay the even though the                                  users authenticate this is my front page                                  I'm just gonna served in the cache page                                  anyway because the majority of your                                  pages probably hit your front page so                                  that's always a good option to consider                                  and then front-end optimizations are                                  some things you might want to look at I                                  didn't want to talk about this in great                                  detail but those are options                                  mod PageSpeed something that Google has                                  made mod PageSpeed actually what it does                                  is in the it's in patchy module and what                                  it'll do is it'll say hey you've got                                  like inline styles i'm going to put                                  those in the head and your drupal                                  already does this for us but it'll                                  aggregate all of your jss and CSS files                                  but it'll do as well as and say oh a                                  bell these CSS background images                                  combines all those into one sprite and                                  then modifies your CSS to show just what                                  it needs to so instead of serving like                                                                                                            serves one and your browser cache that                                  sauce making all the requests so it's an                                  awesome thing CD and reverse proxies you                                  know varnish is a big one if you ask                                  anybody about varnish you'll be able to                                  give you a lot of details on that and                                  then domain chart is a pretty cool thing                                  to that services like yata will offer                                  and a couple other ones as well where a                                  browser by default it's probably getting                                  a little to hire a newer versions we                                  only make two requests at a time so if                                  we saw my one example there I has                                     things that need to be loads load my                                  page by browsers going to ask for those                                  two at a time but the main charting what                                  a lot of services will do is they'll                                  give you like you know you know                                  subdomain one dot your domain comments                                  up the main to your domain com stop the                                  main three and then actually the mod                                  PageSpeed module will do this in concert                                  with some CD ends as well on the fly and                                  it'll rewrite your your HTML to make its                                  assets load from different subdomains in                                  the project request them all at once                                  rather than doing them all on the serial                                  fashion and you'll get your page loading                                  a lot faster so that's that's pretty                                  cool thing as well so you know as just                                  sort of the quick summary you know                                  understand what's going on to the hood                                  ensure everything is cashing check your                                  headers tune MySQL that's just an                                  obvious thing and use key value stores                                  that's not rocket science it's not you                                  know a terribly difficult thing that's                                  that's what it would take to to make                                  your site's load that fast so does                                  anybody have any questions yes                                  yes                                  okay so the question was that my school                                  allows use different storage engines for                                  different tables this is true you don't                                  have to use nodb for everything or my                                  ism you can use the in memory storage                                  table and that is that is definitely an                                  option you could say for these ones                                  these particular tables that are                                  ephemeral and I don't care if they get                                  wiped out with my skill restarts you can                                  store them in memory the one reason why                                  you may not want to do that is because                                  maybe maybe your mysql server your                                  you're hitting it so hard that you're                                  worried about open have more TCP IP                                  connections and using more of its                                  internal caching memory for dealing with                                  that stuff so if you use memcache you're                                  just sort of spreading out the load                                  between different damon's but the result                                  would be the same provide you my sequel                                  server had enough memory to handle that                                  had enough had the T copp tcp/ip sockets                                  it could do that just fine anything else                                  I can't see very well oh yes                                  yes if I didn't mention was lightly um                                  okay I I do I think a lot of other web                                  servers are great like i mentioned ng                                  nexus one lot but we'll talk about to                                  but the one that the majority of us are                                  going to find ourselves running for a                                  variety of reasons is apache if you can                                  get away with running one of the faster                                  lighter web servers you should                                  definitely do it because they're faster                                  and they're lighter the downside though                                  someone's might may come to you at some                                  point and say hey we need to XYZ and                                  you're like shooting now we need to re                                  architect our entire system because we                                  we chose a server that can't do this one                                  thing but if you think you know your                                  scope is fixed it's a great option                                  anyone else yes                                  ok so the performance module has been                                  removed from de Valence looking for help                                  so I'm not sure if you're asking me to                                  help but I could think about that but if                                  anybody is interested that's that's a                                  very important module it's pretty key                                  anyone else yes                                  so the question was do I recommend my is                                  amor nodb and the big difference between                                  those sorry or the other way around and                                  actually you know I work at Acquia in                                  the and I sit behind the hosting in the                                  Ops guys and there's a lot of                                  discussions about this and I've always                                  actually been to preferred my ism the                                  problem is that my is Amon inserts and                                  deletes does full table locks whereas                                  nodb does rowlocks there are certain                                  tables in Drupal that perform better on                                  my ISM than nodb for example your                                  watchdog table and if you use the                                  statistics module your access table will                                  actually perform better under my ISM                                  than they will under nodb so if you want                                  to really play around and tweak and two                                  and you could pick certain tables and                                  run one table on one engine in one table                                  on another tables that have a lot of                                  inserts and deletes going at the same                                  time though nodb is your best choice all                                  the time for those yes                                  in in the in memory engine okay okay                                  so the point made was that there's a                                  member there's probably a minute there's                                  a memory leak problem in the in-memory                                  my sequel engine you don't if they                                  solved it Owen lady okay urn lady sorry                                  okay yeah I haven't really invested                                  you'll played around with those a lot i                                  do pretty much everything in apache so                                  but yeah you definitely that's the other                                  thing too is that with apache you know                                  that it's going to be fairly solid in if                                  there are problems or get a thousand                                  forum post explaining them so that's one                                  of the reasons why it's better to thank                                  you thank you oh and uh go and take the                                  survey if you liked my presentation                                  you'd like to see more give me good                                  marks thanks have a good have a good                                  session oh good you're back on
YouTube URL: https://www.youtube.com/watch?v=MED5ZepzhEk


