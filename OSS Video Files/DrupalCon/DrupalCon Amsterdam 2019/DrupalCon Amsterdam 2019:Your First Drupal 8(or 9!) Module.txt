Title: DrupalCon Amsterdam 2019:Your First Drupal 8(or 9!) Module
Publication date: 2019-10-30
Playlist: DrupalCon Amsterdam 2019
Description: 
	Room: Auditorium
Presenter: Ted Bowman
Description: This presentation will start you on your journey into Drupal 8(and 9) module development. It will show you the steps you need to take to make a simple but useful Drupal module. The module will also work on the upcoming Drupal 9.

Topics that will be covered

* The Plugin System
* Providing Blocks as Plugins
* Creating Routes and Menu items
* Creating Forms
* Module Permissions
* Drupal's Hook System (yes it's still there)
* Letting other modules integrate with your module
* Making sure your module works with Drupal 9

We will step through adding functionality to the module from a blank PHP file to the completed module. You will learn how each step works along the way. You will also get access to the source code for each step so you can study it after the session.

To get the most out of this session, you should have some experience with PHP or another programming language, at least a beginner's knowledge of Drupal and a desire to make it your own. Come see how simple it is to add functionality to Drupal.
Captions: 
	00:00:02,449 --> 00:00:07,950
hi thanks for coming so I've reserved

00:00:05,970 --> 00:00:11,700
the first five rows but besides that

00:00:07,950 --> 00:00:13,049
feel free to come closer I was kind of

00:00:11,700 --> 00:00:16,049
surprised when I got the auditorium but

00:00:13,049 --> 00:00:21,570
you know it's fun so this is your first

00:00:16,049 --> 00:00:23,400
Drupal eight and nine module yeah so I

00:00:21,570 --> 00:00:25,320
am Ted Bowman I'm a principal software

00:00:23,400 --> 00:00:26,539
engineer at Acquia as part of the Drupal

00:00:25,320 --> 00:00:31,439
acceleration team

00:00:26,539 --> 00:00:32,940
I'm Ted Bo on Twitter and drupal.org we

00:00:31,439 --> 00:00:34,350
do a lot of stuff at the Drupal

00:00:32,940 --> 00:00:38,059
acceleration team lately I've been

00:00:34,350 --> 00:00:40,620
working on Drupal 9 preparation just

00:00:38,059 --> 00:00:43,170
update module stuff and just trying to

00:00:40,620 --> 00:00:45,030
make sure it all goes smoothly I worked

00:00:43,170 --> 00:00:48,960
on layout builder but there's a bunch of

00:00:45,030 --> 00:00:51,660
other stuff that we do so how many

00:00:48,960 --> 00:00:55,739
people here have already started to make

00:00:51,660 --> 00:00:59,399
Drupal 8 modules ok how many people may

00:00:55,739 --> 00:01:01,710
Drupal 7 modules oh great sort of my

00:00:59,399 --> 00:01:03,510
audience how many people have an

00:01:01,710 --> 00:01:08,070
object-oriented programming background

00:01:03,510 --> 00:01:09,479
some sort all-righty sort of pretend

00:01:08,070 --> 00:01:11,670
that I can see your hands is very bright

00:01:09,479 --> 00:01:14,220
lights but that's fine no I think I have

00:01:11,670 --> 00:01:16,740
a general idea so let's make a module

00:01:14,220 --> 00:01:18,540
this is a lot to cover so I'm gonna go

00:01:16,740 --> 00:01:19,920
kind of quickly I'll have a little time

00:01:18,540 --> 00:01:23,820
for questions at the end but feel free

00:01:19,920 --> 00:01:26,040
to catch me afterwards also all the

00:01:23,820 --> 00:01:28,350
source code is available with tons of

00:01:26,040 --> 00:01:29,670
comments in the source code so the

00:01:28,350 --> 00:01:32,280
module we're gonna make is called roll

00:01:29,670 --> 00:01:34,140
notices and basically I'm going to show

00:01:32,280 --> 00:01:35,880
you the module in eight different stages

00:01:34,140 --> 00:01:40,350
from like a hello world to a finish

00:01:35,880 --> 00:01:42,899
module and on the project page you can

00:01:40,350 --> 00:01:45,210
get the module in folders which each

00:01:42,899 --> 00:01:48,600
stage or you can use get tags like I use

00:01:45,210 --> 00:01:51,930
up here to like go from like 1 to 8 so

00:01:48,600 --> 00:01:54,840
what the module does is it allows user

00:01:51,930 --> 00:01:57,360
admins to set notices for each users and

00:01:54,840 --> 00:02:00,270
then it's displayed in a block and it's

00:01:57,360 --> 00:02:03,390
displayed other ways it's always trouble

00:02:00,270 --> 00:02:04,770
when you're making a teaching module to

00:02:03,390 --> 00:02:07,140
find something that hasn't been done

00:02:04,770 --> 00:02:09,360
already so example would be you have

00:02:07,140 --> 00:02:11,610
message to your editors that says check

00:02:09,360 --> 00:02:13,620
that spelling and admin stop deleting

00:02:11,610 --> 00:02:15,420
people's accounts

00:02:13,620 --> 00:02:16,830
so we're going this module is going to

00:02:15,420 --> 00:02:18,720
provide a permission it's going to

00:02:16,830 --> 00:02:20,130
provide a settings forum it's going to

00:02:18,720 --> 00:02:22,349
provide a block we're gonna use a

00:02:20,130 --> 00:02:24,720
service it's gonna take into account

00:02:22,349 --> 00:02:26,849
caching the last two I don't think we'll

00:02:24,720 --> 00:02:28,260
get to here but it'll add an extra field

00:02:26,849 --> 00:02:31,290
to your profile to show you your

00:02:28,260 --> 00:02:33,780
messages and it'll allow the ability for

00:02:31,290 --> 00:02:36,209
other modules to alter your notices but

00:02:33,780 --> 00:02:38,690
if you look at the module code later on

00:02:36,209 --> 00:02:41,370
those last two items will be there also

00:02:38,690 --> 00:02:43,170
so let's look at the finished module

00:02:41,370 --> 00:02:44,060
just to see an idea of like what we're

00:02:43,170 --> 00:02:47,850
trying to make

00:02:44,060 --> 00:02:50,580
so basically when we go to a list people

00:02:47,850 --> 00:02:55,110
there'll be a new tab let me bump this

00:02:50,580 --> 00:02:57,720
up there'll be a there'll be a new tab

00:02:55,110 --> 00:03:01,950
called rural notices and we click that

00:02:57,720 --> 00:03:04,019
there will be a there'll be a text area

00:03:01,950 --> 00:03:06,239
for each roll that we have and it's we

00:03:04,019 --> 00:03:09,299
add new rolls it'll show up there we'll

00:03:06,239 --> 00:03:11,370
be able to you know have notices for

00:03:09,299 --> 00:03:15,660
each different roll and then when you go

00:03:11,370 --> 00:03:19,049
and see the block so this person is an

00:03:15,660 --> 00:03:21,090
administrator and also an authenticated

00:03:19,049 --> 00:03:22,350
user so they see two messages you're

00:03:21,090 --> 00:03:25,140
great and you're the greatest

00:03:22,350 --> 00:03:29,790
admin so that's the basics of what we're

00:03:25,140 --> 00:03:31,079
gonna cover today in the module at the

00:03:29,790 --> 00:03:33,810
module source you would actually be able

00:03:31,079 --> 00:03:35,340
to also have in manage display say like

00:03:33,810 --> 00:03:38,100
you know show your notices or whatever

00:03:35,340 --> 00:03:41,040
here and also there would be the ability

00:03:38,100 --> 00:03:42,930
there's another module sub module that

00:03:41,040 --> 00:03:45,239
alters those notices before they go out

00:03:42,930 --> 00:03:48,019
to show you sort of how hooks work

00:03:45,239 --> 00:03:51,600
because we still have folks in Drupal 8

00:03:48,019 --> 00:03:54,450
okay so I think that is pretty much the

00:03:51,600 --> 00:03:57,060
end of my slides go into slides mode for

00:03:54,450 --> 00:03:59,459
a moment let's try it alright so what

00:03:57,060 --> 00:04:02,519
we're going to do is I have the module

00:03:59,459 --> 00:04:05,400
right now checked out at the simplest

00:04:02,519 --> 00:04:07,290
not the simplest okay I have this little

00:04:05,400 --> 00:04:09,650
script I'm gonna go to the hello world

00:04:07,290 --> 00:04:12,120
example it's gonna check out the module

00:04:09,650 --> 00:04:13,500
it's gonna check out the module at the

00:04:12,120 --> 00:04:15,840
earliest stage and it's going to clear

00:04:13,500 --> 00:04:17,789
cache so I'm not gonna clear cache each

00:04:15,840 --> 00:04:19,739
time I do something new I'll try to

00:04:17,789 --> 00:04:21,570
mention when you need to clear cache but

00:04:19,739 --> 00:04:23,970
any time you like have a new route or

00:04:21,570 --> 00:04:26,760
new block you're gonna need to clear

00:04:23,970 --> 00:04:30,780
cache so

00:04:26,760 --> 00:04:33,780
if we look at this the first thing that

00:04:30,780 --> 00:04:37,290
we need to do is we need to have a dot m

00:04:33,780 --> 00:04:39,000
fo mo file and this is going to

00:04:37,290 --> 00:04:41,520
determine the machine name of your

00:04:39,000 --> 00:04:45,590
module so this is roll underscore

00:04:41,520 --> 00:04:50,280
notices fo ya mo so this is like the

00:04:45,590 --> 00:04:52,830
info files in Drupal 7 so very similar

00:04:50,280 --> 00:04:55,080
except we're using yeah mo format we

00:04:52,830 --> 00:04:56,760
have the name type module because it

00:04:55,080 --> 00:05:00,180
could be a theme or a profile

00:04:56,760 --> 00:05:02,040
description package we're gonna show

00:05:00,180 --> 00:05:06,900
later how we can make this for Drupal 9

00:05:02,040 --> 00:05:10,410
- but right now we're it's simply a

00:05:06,900 --> 00:05:12,600
Drupal 8 module and then just has one

00:05:10,410 --> 00:05:14,070
dependency on block because one of the

00:05:12,600 --> 00:05:15,960
main things it does is it displays a

00:05:14,070 --> 00:05:17,820
block so there's no need and having the

00:05:15,960 --> 00:05:22,230
module if you don't have block enabled

00:05:17,820 --> 00:05:24,870
though most people do so that gets it on

00:05:22,230 --> 00:05:28,530
the module page I think I've enabled it

00:05:24,870 --> 00:05:32,340
but I'm going to disable it just to be

00:05:28,530 --> 00:05:35,370
sure so I'm just disabling the module so

00:05:32,340 --> 00:05:37,790
we can start from scratch okay so it's

00:05:35,370 --> 00:05:42,240
successfully disabled so we will go to

00:05:37,790 --> 00:05:49,590
extend and we will look in the search

00:05:42,240 --> 00:05:52,890
for role we see our module disabled I'm

00:05:49,590 --> 00:05:59,970
in the wrong tab okay so it should be

00:05:52,890 --> 00:06:03,480
disabled on this one and so if I look

00:05:59,970 --> 00:06:04,680
for a role here we have role notices we

00:06:03,480 --> 00:06:05,700
have a prescription that we saw there

00:06:04,680 --> 00:06:09,180
and then we have our dependency

00:06:05,700 --> 00:06:10,860
unblocked so let's enable it so the

00:06:09,180 --> 00:06:12,540
first thing that this first stage is

00:06:10,860 --> 00:06:14,730
going to do is it's sort of like it

00:06:12,540 --> 00:06:15,930
doesn't really affect the other work

00:06:14,730 --> 00:06:17,250
with the other part of the module but I

00:06:15,930 --> 00:06:22,020
just wanted to get something out on the

00:06:17,250 --> 00:06:23,430
page hello world so how we do that is we

00:06:22,020 --> 00:06:25,770
need to create a route so if you're

00:06:23,430 --> 00:06:27,270
familiar with Drupal 7 there was hook

00:06:25,770 --> 00:06:29,430
menu which did a whole bunch of things

00:06:27,270 --> 00:06:32,130
that's been split up into a bunch of

00:06:29,430 --> 00:06:34,140
different areas and so the the ability

00:06:32,130 --> 00:06:36,780
of hook menu to say at this particular

00:06:34,140 --> 00:06:39,870
path I want you to call this function

00:06:36,780 --> 00:06:40,770
has been moved to your dot routing dot

00:06:39,870 --> 00:06:42,690
yeah more

00:06:40,770 --> 00:06:45,540
so again it's my machine named her for

00:06:42,690 --> 00:06:49,470
my module role notices dot routing yeah

00:06:45,540 --> 00:06:51,030
MO and then in here we have individual

00:06:49,470 --> 00:06:53,670
routes so this is a hello world route

00:06:51,030 --> 00:06:55,710
has a machine name there has a path and

00:06:53,670 --> 00:06:57,780
then the controller basically says

00:06:55,710 --> 00:07:00,720
what's gonna take over this so I could

00:06:57,780 --> 00:07:02,280
technically just have this go to a

00:07:00,720 --> 00:07:04,020
global function but that's usually not

00:07:02,280 --> 00:07:09,540
done in Drupal 8 you usually have like

00:07:04,020 --> 00:07:11,130
class and then a method on that class so

00:07:09,540 --> 00:07:13,470
basically needs to be something it can

00:07:11,130 --> 00:07:15,390
call so if we look at and then we have a

00:07:13,470 --> 00:07:16,680
permission so the permission here is

00:07:15,390 --> 00:07:18,840
saying if you don't have this permission

00:07:16,680 --> 00:07:22,170
you can't get to this route or you can

00:07:18,840 --> 00:07:25,650
go there but you'll access denied so if

00:07:22,170 --> 00:07:27,660
we go here this is very similar to

00:07:25,650 --> 00:07:32,000
Drupal 7 in that I'm returning a render

00:07:27,660 --> 00:07:35,460
array it's of the type markup and and

00:07:32,000 --> 00:07:38,250
then my markup is hello world that is

00:07:35,460 --> 00:07:40,050
translated with T function so I could

00:07:38,250 --> 00:07:41,970
use the global T function here but

00:07:40,050 --> 00:07:44,730
usually if you're in a class you should

00:07:41,970 --> 00:07:46,890
not you can use the string translation

00:07:44,730 --> 00:07:48,780
and it's gonna treat which will provide

00:07:46,890 --> 00:07:51,750
you with the T function and then also

00:07:48,780 --> 00:07:56,130
like I think singular plural translation

00:07:51,750 --> 00:07:58,380
stuff so pretty similar to Drupal 8 so

00:07:56,130 --> 00:08:00,419
let's see what that looks like if we go

00:07:58,380 --> 00:08:03,560
how we would find it if we didn't have a

00:08:00,419 --> 00:08:09,000
menu item is we would just copy the path

00:08:03,560 --> 00:08:12,180
go to the site and hello world live demo

00:08:09,000 --> 00:08:14,130
God so far have been shining on me okay

00:08:12,180 --> 00:08:20,640
so that's what we do we can see that if

00:08:14,130 --> 00:08:23,640
we change it it should change with it so

00:08:20,640 --> 00:08:27,870
let's put a little emoji save that so we

00:08:23,640 --> 00:08:30,090
have our emoji here so so yeah hello

00:08:27,870 --> 00:08:32,339
world you know this is the basics of

00:08:30,090 --> 00:08:34,020
getting something on a page so the other

00:08:32,339 --> 00:08:37,140
thing that this first stage of the

00:08:34,020 --> 00:08:42,390
module does is it creates a menu item so

00:08:37,140 --> 00:08:45,030
if we look at the roll notices dot links

00:08:42,390 --> 00:08:46,800
top menu this is again in Drupal 7 was

00:08:45,030 --> 00:08:49,050
part of hook menu I think if I remember

00:08:46,800 --> 00:08:50,910
correctly so we're providing again a

00:08:49,050 --> 00:08:52,380
machine name we we use for our machine

00:08:50,910 --> 00:08:54,480
name usually the machine name of our

00:08:52,380 --> 00:08:54,720
module dot something else so that we

00:08:54,480 --> 00:08:57,750
don't

00:08:54,720 --> 00:09:00,240
with other modules title description and

00:08:57,750 --> 00:09:01,589
then a route name so basically it

00:09:00,240 --> 00:09:04,139
doesn't have to be our route it just has

00:09:01,589 --> 00:09:07,529
to be a route that exists that's going

00:09:04,139 --> 00:09:09,860
to be read where Drupal should make a

00:09:07,529 --> 00:09:13,079
link to that route and then the parent

00:09:09,860 --> 00:09:15,689
menu item so if I search this I would

00:09:13,079 --> 00:09:21,000
find this in another links top menu

00:09:15,689 --> 00:09:24,560
provided by the system module so how we

00:09:21,000 --> 00:09:28,769
see that menu as if we go to system

00:09:24,560 --> 00:09:31,319
reports there should be a new item role

00:09:28,769 --> 00:09:33,300
notices hello world same page we just

00:09:31,319 --> 00:09:37,379
saw just providing the menu item for

00:09:33,300 --> 00:09:40,050
there okay so let's go to me look and

00:09:37,379 --> 00:09:42,120
see if that's all the files and here's

00:09:40,050 --> 00:09:43,980
where we define our permission again

00:09:42,120 --> 00:09:47,279
this was I think hook permissions in

00:09:43,980 --> 00:09:49,560
Drupal 7 we have a machine name here and

00:09:47,279 --> 00:09:53,459
then we have a human readable name if

00:09:49,560 --> 00:09:54,990
this was a free with halt if it was like

00:09:53,459 --> 00:09:56,970
security permission then there would be

00:09:54,990 --> 00:09:58,529
another section here I forgot what the

00:09:56,970 --> 00:10:02,040
key is but basically to say this don't

00:09:58,529 --> 00:10:03,569
only give this to trusted users we don't

00:10:02,040 --> 00:10:06,709
have to create our own permission we

00:10:03,569 --> 00:10:09,000
could simply in our route use access

00:10:06,709 --> 00:10:10,379
content or content access whatever it is

00:10:09,000 --> 00:10:12,959
therefore that's provided by the node

00:10:10,379 --> 00:10:18,149
module actually it's provided by the

00:10:12,959 --> 00:10:20,129
system module now and but this is an

00:10:18,149 --> 00:10:22,259
example of you know we want to say ok

00:10:20,129 --> 00:10:27,050
only people who have our permission can

00:10:22,259 --> 00:10:33,389
see our form to set the notices okay so

00:10:27,050 --> 00:10:38,370
let's go to step simple form let's go to

00:10:33,389 --> 00:10:42,569
a slightly more advanced form oh I

00:10:38,370 --> 00:10:43,920
forgot to mention one thing about no we

00:10:42,569 --> 00:10:51,000
haven't got to the form yet sorry I'm

00:10:43,920 --> 00:10:53,490
going to skip back to yeah okay so now

00:10:51,000 --> 00:10:59,209
we're at the simple form state so we

00:10:53,490 --> 00:10:59,209
have a new route up here that is

00:11:02,380 --> 00:11:07,000
Rolle notices settings form we haven't

00:11:04,510 --> 00:11:08,710
we have a different path and in this

00:11:07,000 --> 00:11:12,130
time instead of pointing to an actual

00:11:08,710 --> 00:11:13,690
method on a class when we have the

00:11:12,130 --> 00:11:15,360
underscore controller we have to point

00:11:13,690 --> 00:11:19,450
to something a method that's callable

00:11:15,360 --> 00:11:21,790
has to be a public function here if we

00:11:19,450 --> 00:11:23,980
do underscore form this has to point to

00:11:21,790 --> 00:11:26,200
a class that implements the form

00:11:23,980 --> 00:11:27,730
interface class and as long as it

00:11:26,200 --> 00:11:29,830
implements the form interface class

00:11:27,730 --> 00:11:32,020
correctly then Drupal will know what to

00:11:29,830 --> 00:11:35,010
do let's see how that works and again

00:11:32,020 --> 00:11:42,130
we're going to use the same permission

00:11:35,010 --> 00:11:44,560
so this is our class that I pointed to

00:11:42,130 --> 00:11:48,130
and then we have form base here so

00:11:44,560 --> 00:11:50,790
foreign base it implements the form

00:11:48,130 --> 00:11:53,980
interface I was telling you about

00:11:50,790 --> 00:11:56,440
so because it does that I have to have a

00:11:53,980 --> 00:11:58,450
get get form ID and I just have to

00:11:56,440 --> 00:12:00,340
return a string there so unique to my

00:11:58,450 --> 00:12:03,210
form and then what's actually going to

00:12:00,340 --> 00:12:06,040
make the page and make the form is the

00:12:03,210 --> 00:12:08,620
build form so in Drupal 7 I think this

00:12:06,040 --> 00:12:11,080
was like in hook menu you would point to

00:12:08,620 --> 00:12:13,300
a form call back or something basically

00:12:11,080 --> 00:12:15,730
it was like a global method global

00:12:13,300 --> 00:12:18,730
function here what we're actually

00:12:15,730 --> 00:12:22,330
returning is very similar to Drupal 7 in

00:12:18,730 --> 00:12:24,700
the sense that it is a form array so the

00:12:22,330 --> 00:12:27,010
form API documentation so on the link

00:12:24,700 --> 00:12:29,080
inside the finished module is a link to

00:12:27,010 --> 00:12:31,090
more documentation on this but basically

00:12:29,080 --> 00:12:33,610
the simplified version is we're making

00:12:31,090 --> 00:12:36,880
one text area and we're having one

00:12:33,610 --> 00:12:46,290
submit button and how we're gonna let's

00:12:36,880 --> 00:12:50,530
see if that looks like role notices so

00:12:46,290 --> 00:12:52,300
here my test message here says it's

00:12:50,530 --> 00:12:54,750
saved I can see that when I reload the

00:12:52,300 --> 00:12:57,460
form it's still there

00:12:54,750 --> 00:13:00,390
so how it saves it in this case is

00:12:57,460 --> 00:13:03,760
because this module is meant to save the

00:13:00,390 --> 00:13:06,460
notices on production so the idea is you

00:13:03,760 --> 00:13:09,550
don't want to have to move your notices

00:13:06,460 --> 00:13:10,960
from development via config onto your

00:13:09,550 --> 00:13:13,750
production server you want to be able to

00:13:10,960 --> 00:13:14,649
just set notices live so we're using the

00:13:13,750 --> 00:13:16,779
Drupal state

00:13:14,649 --> 00:13:18,790
servus so this is basically we'll save

00:13:16,779 --> 00:13:23,860
this on your local state so it's not

00:13:18,790 --> 00:13:25,660
deployable and then I call so this is

00:13:23,860 --> 00:13:27,639
how I get a service from Drupal which

00:13:25,660 --> 00:13:29,110
will make our own in a little bit so

00:13:27,639 --> 00:13:32,290
that'll have more information about how

00:13:29,110 --> 00:13:35,619
services worked but the state service

00:13:32,290 --> 00:13:39,939
has this method called a public method

00:13:35,619 --> 00:13:41,829
called get where I can get a state

00:13:39,939 --> 00:13:44,379
setting and I'm saying the default

00:13:41,829 --> 00:13:46,149
should be empty strings so basically if

00:13:44,379 --> 00:13:50,860
it hasn't been set just return me an

00:13:46,149 --> 00:13:52,779
empty string this is so one thing's nice

00:13:50,860 --> 00:13:55,329
I'm using PHP storm is I can just say

00:13:52,779 --> 00:13:57,009
okay I can do control B here and it'll

00:13:55,329 --> 00:13:59,619
take me to the class that implements

00:13:57,009 --> 00:14:04,269
this service that's because I have a

00:13:59,619 --> 00:14:06,550
couple plugins added the symphony

00:14:04,269 --> 00:14:08,860
plug-in the drupal symphony bridge

00:14:06,550 --> 00:14:10,449
plug-in and I think annotations plug-in

00:14:08,860 --> 00:14:12,040
and I always to forget like where each

00:14:10,449 --> 00:14:14,259
one stops but if you have the

00:14:12,040 --> 00:14:16,119
combination of those three it's sort of

00:14:14,259 --> 00:14:21,339
aware of services and what class they

00:14:16,119 --> 00:14:23,290
attach to so I get the I get the value

00:14:21,339 --> 00:14:25,360
in this case if we never install the

00:14:23,290 --> 00:14:27,399
module before or we haven't set set

00:14:25,360 --> 00:14:29,949
something before then this would be a

00:14:27,399 --> 00:14:32,279
default value of just empty string but

00:14:29,949 --> 00:14:34,689
as soon as we submit it once

00:14:32,279 --> 00:14:36,490
so because we implemented the form

00:14:34,689 --> 00:14:38,559
interface it knows to build it here and

00:14:36,490 --> 00:14:43,300
it knows Drupal knows when I submit it

00:14:38,559 --> 00:14:45,879
to call my public submit form method so

00:14:43,300 --> 00:14:47,589
here when I submit instead of like in

00:14:45,879 --> 00:14:50,470
Drupal seven your submit callbacks I

00:14:47,589 --> 00:14:52,029
think would both get two arrays we get

00:14:50,470 --> 00:14:54,129
an array for the form here of the

00:14:52,029 --> 00:14:56,259
current form but then the form state

00:14:54,129 --> 00:14:58,449
comes back in a form state interface

00:14:56,259 --> 00:15:01,420
object so instead of like going through

00:14:58,449 --> 00:15:04,920
a nested array I can just say okay the

00:15:01,420 --> 00:15:08,199
method is get Val with a good value and

00:15:04,920 --> 00:15:12,459
my value here is the same value as my

00:15:08,199 --> 00:15:15,459
key for my text area so notice so these

00:15:12,459 --> 00:15:16,899
two are the same and so I have all four

00:15:15,459 --> 00:15:19,079
all of the elements that I would have in

00:15:16,899 --> 00:15:22,240
my form I would have a corresponding

00:15:19,079 --> 00:15:25,059
value item in the form state so this

00:15:22,240 --> 00:15:28,420
case it would be a string in this case I

00:15:25,059 --> 00:15:30,850
use the Drupal state service again

00:15:28,420 --> 00:15:33,070
ooh I do it do different ways actually I

00:15:30,850 --> 00:15:35,170
forgot so up here I'm calling it in a

00:15:33,070 --> 00:15:38,589
way that says I know there's a service

00:15:35,170 --> 00:15:40,480
called state but on the Drupal class

00:15:38,589 --> 00:15:42,730
there's a couple helper functions for

00:15:40,480 --> 00:15:46,300
like really commonly used services and

00:15:42,730 --> 00:15:47,889
so the one of them is the state one

00:15:46,300 --> 00:15:53,290
which basically if I looked at it just

00:15:47,889 --> 00:15:55,779
says get me the state service so in this

00:15:53,290 --> 00:15:57,160
case instead of calling get this is the

00:15:55,779 --> 00:16:00,010
form submit so I'm going to call set

00:15:57,160 --> 00:16:02,110
again I use the same key as I did up

00:16:00,010 --> 00:16:05,019
here so when I get it will notice this

00:16:02,110 --> 00:16:07,600
test when I said it rule notices test

00:16:05,019 --> 00:16:09,670
and then I just set this notice here and

00:16:07,600 --> 00:16:12,399
I send a message and you'll notice here

00:16:09,670 --> 00:16:14,529
I'm using the deprecated Drupal set

00:16:12,399 --> 00:16:16,329
message so we'll see later on how I will

00:16:14,529 --> 00:16:20,399
remove that and it'll make it old rupal

00:16:16,329 --> 00:16:29,680
nine compatible all right so let's go to

00:16:20,399 --> 00:16:31,089
a little more advanced form so here I

00:16:29,680 --> 00:16:33,699
wouldn't actually have to clear cache

00:16:31,089 --> 00:16:36,550
because I haven't changed anything that

00:16:33,699 --> 00:16:39,490
Drupal needs to cache as far as like

00:16:36,550 --> 00:16:41,079
definitions or anything since my class

00:16:39,490 --> 00:16:43,360
hasn't changed it would still call this

00:16:41,079 --> 00:16:45,339
method each time it made the form so

00:16:43,360 --> 00:16:47,199
this is a little this is more

00:16:45,339 --> 00:16:49,240
complicated not going into all of us

00:16:47,199 --> 00:16:52,990
right now but basically what I'm doing

00:16:49,240 --> 00:16:54,339
is I'm getting the roll names it's

00:16:52,990 --> 00:16:57,040
calling this global function that Drupal

00:16:54,339 --> 00:16:59,350
provides so this will have the role IDs

00:16:57,040 --> 00:17:01,269
and then the role is the role IDs as the

00:16:59,350 --> 00:17:04,540
keys and the role values will be the

00:17:01,269 --> 00:17:07,209
role names and then I'm making a form

00:17:04,540 --> 00:17:10,689
element as it can sort of like as a

00:17:07,209 --> 00:17:12,549
container here basically I'm setting

00:17:10,689 --> 00:17:14,589
this pound tree which means that

00:17:12,549 --> 00:17:18,520
everything below this that's nested in

00:17:14,589 --> 00:17:21,100
this array will come back as will come

00:17:18,520 --> 00:17:23,919
back as one array instead of me having

00:17:21,100 --> 00:17:25,630
to get like notice for authenticated

00:17:23,919 --> 00:17:30,580
users notice for administrators

00:17:25,630 --> 00:17:32,860
so I basically what to do as I go over

00:17:30,580 --> 00:17:35,530
each role and I make a text area so

00:17:32,860 --> 00:17:37,929
instead of having one text area that I

00:17:35,530 --> 00:17:40,540
had before all of these are nested with

00:17:37,929 --> 00:17:42,580
the role IDs this is pretty much the

00:17:40,540 --> 00:17:45,159
same the only

00:17:42,580 --> 00:17:47,320
difference here is that when I get the

00:17:45,159 --> 00:17:50,140
state here I'm saying if nothing has

00:17:47,320 --> 00:17:52,539
been set give me an empty array so the

00:17:50,140 --> 00:17:54,730
idea being here that instead of storing

00:17:52,539 --> 00:17:58,659
a string now in that state I've changed

00:17:54,730 --> 00:18:02,590
changed the key slightly I'm gonna store

00:17:58,659 --> 00:18:03,909
an array because I want one notice free

00:18:02,590 --> 00:18:06,970
string so I don't have to serialize it

00:18:03,909 --> 00:18:09,669
anything myself and the submit function

00:18:06,970 --> 00:18:12,100
is I think exactly the same except for

00:18:09,669 --> 00:18:13,840
the key for my value for my form State

00:18:12,100 --> 00:18:16,090
thing has changed because it's notices

00:18:13,840 --> 00:18:20,830
and the key for my state has changed

00:18:16,090 --> 00:18:22,179
from notice to notices so I'm just going

00:18:20,830 --> 00:18:24,100
to save that in the same way that I

00:18:22,179 --> 00:18:24,909
would and then the message is the

00:18:24,100 --> 00:18:27,159
message is the same

00:18:24,909 --> 00:18:29,080
I've actually updated here because I was

00:18:27,159 --> 00:18:32,580
doing as stage as I forgot but we'll go

00:18:29,080 --> 00:18:35,830
back to it later to update to Drupal 9

00:18:32,580 --> 00:18:40,419
so let me show you how that works so I

00:18:35,830 --> 00:18:42,909
reload this I have I think I made a few

00:18:40,419 --> 00:18:44,320
roll I made one extra roll editor so

00:18:42,909 --> 00:18:46,330
I've editor administrator and

00:18:44,320 --> 00:18:48,519
authenticated user I've already filled

00:18:46,330 --> 00:18:52,570
out these values I'm going to change

00:18:48,519 --> 00:18:55,690
this one say hi admins and for editors

00:18:52,570 --> 00:18:59,740
I'm going to say check your spelling and

00:18:55,690 --> 00:19:02,230
I'm gonna spell it incorrectly and I'll

00:18:59,740 --> 00:19:04,419
save this and we can see that you know

00:19:02,230 --> 00:19:05,649
if I reload it it saves us because it's

00:19:04,419 --> 00:19:09,309
saving it in the drupal state and

00:19:05,649 --> 00:19:12,159
bringing it back each time okay so for

00:19:09,309 --> 00:19:13,870
the next one let's make a simple block

00:19:12,159 --> 00:19:16,450
so the idea is there's no point in

00:19:13,870 --> 00:19:18,460
saving these notices unless I can

00:19:16,450 --> 00:19:20,919
display them somewhere so we're gonna

00:19:18,460 --> 00:19:22,600
display them in a block so that the site

00:19:20,919 --> 00:19:23,760
builder can place the block wherever

00:19:22,600 --> 00:19:26,889
they want to

00:19:23,760 --> 00:19:31,659
so blocks are provided in plugins in

00:19:26,889 --> 00:19:34,720
Drupal 8 so a lot of things that in

00:19:31,659 --> 00:19:36,250
Drupal 7 were like hook something info I

00:19:34,720 --> 00:19:38,200
think there was like hook block info

00:19:36,250 --> 00:19:40,389
where you'd say okay these are all the

00:19:38,200 --> 00:19:42,580
blocks that I provide a lot of that and

00:19:40,389 --> 00:19:44,649
Drupal 8 has moved to plugins so instead

00:19:42,580 --> 00:19:47,950
of having a hook where I say these are

00:19:44,649 --> 00:19:50,470
all the blocks that I provide I make the

00:19:47,950 --> 00:19:54,460
plug-in in the correct folder here so if

00:19:50,470 --> 00:19:56,650
we look at this inside my SRC directory

00:19:54,460 --> 00:19:58,780
in all of my

00:19:56,650 --> 00:20:01,570
all of my source code should be in this

00:19:58,780 --> 00:20:03,309
SRC directory I have a plug-in folder

00:20:01,570 --> 00:20:05,710
and then under that I have a block

00:20:03,309 --> 00:20:07,540
folder and usually to learn this I mean

00:20:05,710 --> 00:20:09,400
you can look at the the plug-in manager

00:20:07,540 --> 00:20:12,460
for blocks but usually the easiest way

00:20:09,400 --> 00:20:14,050
is just to look where other modules put

00:20:12,460 --> 00:20:17,130
their plugins for like if you want to

00:20:14,050 --> 00:20:21,010
block plug-in or field formatter plug-in

00:20:17,130 --> 00:20:23,100
so I have a roll notices block PHP file

00:20:21,010 --> 00:20:27,580
which corresponds to the same class and

00:20:23,100 --> 00:20:31,809
in this one one thing is important here

00:20:27,580 --> 00:20:34,470
is that I am in this class I have an

00:20:31,809 --> 00:20:36,520
annotation so this is metadata in

00:20:34,470 --> 00:20:38,620
comments some people call it code in

00:20:36,520 --> 00:20:42,910
comments it's really more metadata in

00:20:38,620 --> 00:20:44,830
comments so I use this at block to tell

00:20:42,910 --> 00:20:48,940
it this is a this is a block annotation

00:20:44,830 --> 00:20:50,800
I give it an ID so role notices and then

00:20:48,940 --> 00:20:54,360
an admin label so this is the label that

00:20:50,800 --> 00:20:56,590
will show up on the block layout page

00:20:54,360 --> 00:20:59,790
and I have a link here if you go to the

00:20:56,590 --> 00:21:01,780
source codes more about how this works

00:20:59,790 --> 00:21:02,230
after you get used to it it's pretty

00:21:01,780 --> 00:21:05,050
easy

00:21:02,230 --> 00:21:07,360
oftentimes if you use Drupal console

00:21:05,050 --> 00:21:08,860
it'll generate this for you but also if

00:21:07,360 --> 00:21:10,720
you just copy another block and then

00:21:08,860 --> 00:21:13,780
just fill in your own values there it's

00:21:10,720 --> 00:21:16,260
usually pretty easy to this block is

00:21:13,780 --> 00:21:19,000
extending block base almost all blocks

00:21:16,260 --> 00:21:20,980
that you would make yourself you would

00:21:19,000 --> 00:21:22,480
do this you don't have to but has a lot

00:21:20,980 --> 00:21:25,150
of helper functions in there for you and

00:21:22,480 --> 00:21:27,730
has implemented some stuff for you this

00:21:25,150 --> 00:21:29,320
is common for like field for matters or

00:21:27,730 --> 00:21:32,440
field types they'll have a base class

00:21:29,320 --> 00:21:36,760
that usually can just extend and the

00:21:32,440 --> 00:21:39,610
base class will let me see if I like it

00:21:36,760 --> 00:21:41,140
won't extend the things that I need it

00:21:39,610 --> 00:21:42,730
won't give me the methods that I

00:21:41,140 --> 00:21:45,730
absolutely need to implement so

00:21:42,730 --> 00:21:47,440
obviously the the block base can't do

00:21:45,730 --> 00:21:49,390
the build for me because it doesn't know

00:21:47,440 --> 00:21:51,309
what should be rendered in my block

00:21:49,390 --> 00:21:53,830
right that's up to me so if I if I

00:21:51,309 --> 00:21:56,110
forgot to do the build one here so I'm

00:21:53,830 --> 00:21:57,640
gonna change this to build X phpstorm is

00:21:56,110 --> 00:22:02,350
gonna say hey you haven't implemented

00:21:57,640 --> 00:22:04,419
the build function so the build function

00:22:02,350 --> 00:22:06,250
technically all I would need to do here

00:22:04,419 --> 00:22:09,250
is return or render array so it's very

00:22:06,250 --> 00:22:11,220
similar to Drupal 7 as far as what it

00:22:09,250 --> 00:22:14,920
expects

00:22:11,220 --> 00:22:16,690
here is similar to what we did in the

00:22:14,920 --> 00:22:21,070
forum in the sense that the first thing

00:22:16,690 --> 00:22:23,650
I'm going to do is I am going to try to

00:22:21,070 --> 00:22:28,600
make this text a little smaller oh it's

00:22:23,650 --> 00:22:29,650
my uh yeah okay so the first thing I'm

00:22:28,600 --> 00:22:31,810
going to do is I'm gonna use the same

00:22:29,650 --> 00:22:34,030
Drupal state service and I'm gonna get

00:22:31,810 --> 00:22:36,490
the key that I saved in the form submit

00:22:34,030 --> 00:22:38,230
function the same basically this is

00:22:36,490 --> 00:22:40,390
straight exactly the way it my form

00:22:38,230 --> 00:22:43,180
submit works then the next thing I'm

00:22:40,390 --> 00:22:44,380
gonna do is I'm going to call a helper

00:22:43,180 --> 00:22:46,720
function that's going to get me the

00:22:44,380 --> 00:22:49,780
current user and after that I'm gonna

00:22:46,720 --> 00:22:51,490
get the roles so this sort of this line

00:22:49,780 --> 00:22:53,950
here basically what I'm doing is saying

00:22:51,490 --> 00:22:55,840
I know which roles I have I know they

00:22:53,950 --> 00:22:58,360
correspond to certain role IDs and I

00:22:55,840 --> 00:22:59,920
know my notices I know their keys also

00:22:58,360 --> 00:23:02,050
correspond to role ID so I'm gonna

00:22:59,920 --> 00:23:05,200
intersect the two and I only want the

00:23:02,050 --> 00:23:08,890
notices for the current users role so

00:23:05,200 --> 00:23:11,320
after I do that again I think this is

00:23:08,890 --> 00:23:14,260
very similar to Drupal seven is that I

00:23:11,320 --> 00:23:16,120
have this pound theme function and I'm

00:23:14,260 --> 00:23:18,190
sorry pound theme property in my render

00:23:16,120 --> 00:23:21,310
array so this is basically saying I

00:23:18,190 --> 00:23:23,110
don't want to determine how the HTML is

00:23:21,310 --> 00:23:25,600
ultimately rendered I want to tell

00:23:23,110 --> 00:23:28,270
Drupal this is a list render this

00:23:25,600 --> 00:23:30,160
however you render lists and if I looked

00:23:28,270 --> 00:23:31,930
at the template file it would say okay I

00:23:30,160 --> 00:23:34,510
need something called items which is

00:23:31,930 --> 00:23:36,460
gonna be in my case gonna be strings so

00:23:34,510 --> 00:23:39,010
I just pass in the notices that I got

00:23:36,460 --> 00:23:40,570
from the state and then it just does

00:23:39,010 --> 00:23:42,820
whole bunch of stuff basically passes it

00:23:40,570 --> 00:23:48,640
ultimately on to the twig funk the twig

00:23:42,820 --> 00:23:51,070
file and renders the list so and this

00:23:48,640 --> 00:23:53,440
one in this session I'm not gonna really

00:23:51,070 --> 00:23:55,750
say how to make new ones but you can

00:23:53,440 --> 00:23:59,260
also provide new I think it's hook theme

00:23:55,750 --> 00:24:01,360
you can provide new templates so let's

00:23:59,260 --> 00:24:03,430
look and see what that looks like I may

00:24:01,360 --> 00:24:09,220
have already placed the block let's go

00:24:03,430 --> 00:24:10,390
back to the home page and see I have not

00:24:09,220 --> 00:24:14,320
placed the box so we're gonna go to

00:24:10,390 --> 00:24:16,600
structure block layout and this block

00:24:14,320 --> 00:24:20,980
will just be like any other block if I

00:24:16,600 --> 00:24:23,750
go to sidebar first role my role notices

00:24:20,980 --> 00:24:25,880
block again so this is directly from the

00:24:23,750 --> 00:24:27,980
annotation and the MOT in the category

00:24:25,880 --> 00:24:29,930
is from my module name though I think I

00:24:27,980 --> 00:24:32,990
can override it in the annotation but if

00:24:29,930 --> 00:24:35,570
I don't it comes from my module name so

00:24:32,990 --> 00:24:39,350
this comes from the annotation I place

00:24:35,570 --> 00:24:41,780
block I am going to just not do anything

00:24:39,350 --> 00:24:47,080
different it's there so if I go back to

00:24:41,780 --> 00:24:49,700
the site then over here I have my hello

00:24:47,080 --> 00:24:52,340
these are my two messages because I'm an

00:24:49,700 --> 00:24:56,110
authenticated user and an admin so

00:24:52,340 --> 00:25:02,120
basically if I looked at the source

00:24:56,110 --> 00:25:04,460
group the twig the chick template would

00:25:02,120 --> 00:25:11,780
have just made a ordered list with the

00:25:04,460 --> 00:25:14,600
two items here alright so it rendered so

00:25:11,780 --> 00:25:16,730
basically so I'm basically only in

00:25:14,600 --> 00:25:19,160
charge of a couple things if I'm gonna

00:25:16,730 --> 00:25:22,060
make a block the very minimum is I got

00:25:19,160 --> 00:25:24,380
to do block access because I don't

00:25:22,060 --> 00:25:26,660
because I'm not using I'm not allowing

00:25:24,380 --> 00:25:28,730
messages for the unauthenticated users I

00:25:26,660 --> 00:25:30,320
could have done that but I'm not only

00:25:28,730 --> 00:25:32,240
thing I'm doing a block access is

00:25:30,320 --> 00:25:35,680
checking to see if they are

00:25:32,240 --> 00:25:39,110
authenticated so what I do is I get the

00:25:35,680 --> 00:25:42,350
block access will send me an object of

00:25:39,110 --> 00:25:44,420
the type account interface and on that

00:25:42,350 --> 00:25:46,640
there's a method called is authenticated

00:25:44,420 --> 00:25:50,330
so that's going to return it true or

00:25:46,640 --> 00:25:51,710
false and then here what block access is

00:25:50,330 --> 00:25:53,690
going to return again like the

00:25:51,710 --> 00:25:56,510
definition is actually in the interface

00:25:53,690 --> 00:26:02,330
itself or the documentation it's going

00:25:56,510 --> 00:26:05,060
to return it's going to return an access

00:26:02,330 --> 00:26:09,170
result object so this is basically

00:26:05,060 --> 00:26:12,080
saying allow this if this is true and

00:26:09,170 --> 00:26:14,540
this will be true if the youth current

00:26:12,080 --> 00:26:15,980
user is currently authenticated so if I

00:26:14,540 --> 00:26:17,900
was to look at this as an

00:26:15,980 --> 00:26:20,840
unauthenticated user I would not see the

00:26:17,900 --> 00:26:24,860
block at all if I logged out I wouldn't

00:26:20,840 --> 00:26:27,500
see the block at all so that's the

00:26:24,860 --> 00:26:29,630
basics of the build let me see if

00:26:27,500 --> 00:26:31,400
there's anything new in this step I have

00:26:29,630 --> 00:26:33,440
this little script that tells me what

00:26:31,400 --> 00:26:35,660
files changed okay so only this file

00:26:33,440 --> 00:26:37,430
changed and my test so there are tests

00:26:35,660 --> 00:26:39,350
if you want to look at

00:26:37,430 --> 00:26:41,990
just for my sanity so I don't break the

00:26:39,350 --> 00:26:46,520
module as I change it but I don't go

00:26:41,990 --> 00:26:50,600
into that here okay so let's go back and

00:26:46,520 --> 00:26:52,310
we made the block so we're gonna add now

00:26:50,600 --> 00:26:55,070
we're gonna next thing we're gonna do is

00:26:52,310 --> 00:27:00,050
we're going to move a bunch of stuff

00:26:55,070 --> 00:27:03,170
into a service so right now we have a

00:27:00,050 --> 00:27:05,540
few things going on multiple places the

00:27:03,170 --> 00:27:09,140
same here we get the notices the same in

00:27:05,540 --> 00:27:12,800
the form we get the notices the same and

00:27:09,140 --> 00:27:14,420
in the finished version of the module we

00:27:12,800 --> 00:27:17,840
also get the notices when we make the

00:27:14,420 --> 00:27:20,060
user profile field so the idea here is

00:27:17,840 --> 00:27:23,630
I'm doing the same thing multiple times

00:27:20,060 --> 00:27:26,120
the same way and my form my block and

00:27:23,630 --> 00:27:28,280
ultimately my field all have to know how

00:27:26,120 --> 00:27:31,040
to get these notices and if I wanted to

00:27:28,280 --> 00:27:32,920
change that it would be difficult it's

00:27:31,040 --> 00:27:36,620
also would be super easy for me to

00:27:32,920 --> 00:27:38,660
accidentally change the some letter in

00:27:36,620 --> 00:27:40,070
this key and get it wrong and I wouldn't

00:27:38,660 --> 00:27:44,540
get an error but it would basically say

00:27:40,070 --> 00:27:45,530
well I don't have any notices so what

00:27:44,540 --> 00:27:48,170
I'm gonna do here is I'm gonna make a

00:27:45,530 --> 00:27:50,540
service to basically encapsulate the

00:27:48,170 --> 00:27:52,640
getting and setting of notices so that

00:27:50,540 --> 00:27:55,250
all of these classes have to do is load

00:27:52,640 --> 00:27:58,480
the service and say get me notices or

00:27:55,250 --> 00:28:05,350
set notices so that's the next step

00:27:58,480 --> 00:28:10,880
which is five simple notices manager

00:28:05,350 --> 00:28:16,390
okay so let's look so to make a service

00:28:10,880 --> 00:28:20,660
basically all I need to do is in this I

00:28:16,390 --> 00:28:22,520
have a class or sorry I have another

00:28:20,660 --> 00:28:27,170
llamo file called role notices dot

00:28:22,520 --> 00:28:29,290
services yamo and in that file I have

00:28:27,170 --> 00:28:32,300
this services top key and it's basically

00:28:29,290 --> 00:28:34,190
to define a service the very minimum is

00:28:32,300 --> 00:28:37,070
just to say I have a service here's the

00:28:34,190 --> 00:28:40,760
Machine name and I have a class that is

00:28:37,070 --> 00:28:44,240
that service and Drupal will take care

00:28:40,760 --> 00:28:45,620
of constructing that class for each time

00:28:44,240 --> 00:28:48,500
somebody asks for that well not each

00:28:45,620 --> 00:28:51,049
time because it's one instance of this

00:28:48,500 --> 00:28:53,360
object one instance of the class

00:28:51,049 --> 00:28:55,669
anytime ask and be asked for services

00:28:53,360 --> 00:29:00,619
the same one so if I go to the notices

00:28:55,669 --> 00:29:03,350
manager this is a class I just put it at

00:29:00,619 --> 00:29:08,350
the top level often this often modules

00:29:03,350 --> 00:29:11,480
put it just right directly under SRC and

00:29:08,350 --> 00:29:13,220
this class if you notice it doesn't like

00:29:11,480 --> 00:29:15,169
extend anything there so there's nothing

00:29:13,220 --> 00:29:17,059
special about this class it doesn't have

00:29:15,169 --> 00:29:20,269
to extend you know services space or

00:29:17,059 --> 00:29:22,429
whatever so I have a few public

00:29:20,269 --> 00:29:26,029
functions on this a public methods on

00:29:22,429 --> 00:29:29,509
this class one is get user notices one

00:29:26,029 --> 00:29:33,519
is get all notices and one is set all

00:29:29,509 --> 00:29:37,970
notices and you'll see here basically

00:29:33,519 --> 00:29:39,769
the get all notices and set all notices

00:29:37,970 --> 00:29:41,269
are doing the exact same thing I was

00:29:39,769 --> 00:29:44,509
doing before when I was getting a notice

00:29:41,269 --> 00:29:48,769
just using the state service getting and

00:29:44,509 --> 00:29:50,539
setting up at the top for the get user

00:29:48,769 --> 00:29:52,879
notices I'm doing what I did in the

00:29:50,539 --> 00:29:56,179
block where I said give me the notices

00:29:52,879 --> 00:29:59,629
and then determine what you what roles

00:29:56,179 --> 00:30:02,359
the user has then intersect the two so I

00:29:59,629 --> 00:30:06,350
only get notices for the user so

00:30:02,359 --> 00:30:14,619
basically I made this class and to load

00:30:06,350 --> 00:30:14,619
it or to use it in the forum I just say

00:30:15,580 --> 00:30:18,529
instead of calling the state service I

00:30:17,929 --> 00:30:21,109
call my own

00:30:18,529 --> 00:30:25,190
Mike tell Drupal load my service here

00:30:21,109 --> 00:30:27,080
and then I say get all notices because

00:30:25,190 --> 00:30:28,999
in the forum I want to display all of I

00:30:27,080 --> 00:30:31,460
want to be able to edit all of them not

00:30:28,999 --> 00:30:33,409
just that use of the current users so

00:30:31,460 --> 00:30:35,029
and here the forum that's the only line

00:30:33,409 --> 00:30:37,580
that's changed in the forum or the two

00:30:35,029 --> 00:30:40,519
lines and then down here i do drupal

00:30:37,580 --> 00:30:43,159
service and i get my the same service

00:30:40,519 --> 00:30:45,769
and i say set all notices sending at the

00:30:43,159 --> 00:30:47,539
forum value so basically the forum has

00:30:45,769 --> 00:30:49,369
changed very little just instead of

00:30:47,539 --> 00:30:52,639
knowing directly that at stored and

00:30:49,369 --> 00:30:55,279
state it just says hey notices manager I

00:30:52,639 --> 00:30:57,679
want notices and I have notices I want

00:30:55,279 --> 00:30:59,509
to save now so it doesn't care how it

00:30:57,679 --> 00:31:01,700
saves like so I could easily if I wanted

00:30:59,509 --> 00:31:03,859
to change this module to say hey I would

00:31:01,700 --> 00:31:04,760
really like just change save these

00:31:03,859 --> 00:31:07,970
notices as

00:31:04,760 --> 00:31:10,160
configuration all I would have to do as

00:31:07,970 --> 00:31:11,470
far as the form is can form and the

00:31:10,160 --> 00:31:13,850
block is concerned nothing would change

00:31:11,470 --> 00:31:16,610
because it doesn't really it doesn't

00:31:13,850 --> 00:31:21,590
know how the notices are stored at this

00:31:16,610 --> 00:31:24,620
point so the block class the only thing

00:31:21,590 --> 00:31:26,240
that's that's the manager again the

00:31:24,620 --> 00:31:31,360
block class the only thing that has

00:31:26,240 --> 00:31:31,360
changed is instead of it having to know

00:31:32,590 --> 00:31:36,700
instead of it having to know how to

00:31:36,880 --> 00:31:42,530
basically you know it has to note before

00:31:40,610 --> 00:31:44,690
it had to know to intersect the roles

00:31:42,530 --> 00:31:46,880
that the user had and the notice the

00:31:44,690 --> 00:31:48,770
notices that existed to make the notices

00:31:46,880 --> 00:31:50,510
it just says get user notices so the

00:31:48,770 --> 00:31:52,160
service takes care of that the other

00:31:50,510 --> 00:31:55,070
thing that's nice about that is later on

00:31:52,160 --> 00:31:57,530
in the module when I provide the alter

00:31:55,070 --> 00:31:59,960
so that modules can alter which services

00:31:57,530 --> 00:32:01,550
which notices appear and there's the sub

00:31:59,960 --> 00:32:04,040
module called role notices wait that

00:32:01,550 --> 00:32:05,330
says only get the notice with the role

00:32:04,040 --> 00:32:07,280
with the highest way to the lowest

00:32:05,330 --> 00:32:10,550
weight I forget but the idea here is

00:32:07,280 --> 00:32:12,200
that if when I get the notices and

00:32:10,550 --> 00:32:14,360
display them in new ways like on the

00:32:12,200 --> 00:32:17,360
user profile each place doesn't have to

00:32:14,360 --> 00:32:19,910
know to call that alter hook so I'm not

00:32:17,360 --> 00:32:21,260
going to show you anything on the site

00:32:19,910 --> 00:32:22,970
because there's not there's no

00:32:21,260 --> 00:32:24,410
functionality from the user point of

00:32:22,970 --> 00:32:26,930
view that's actually changed at this

00:32:24,410 --> 00:32:28,580
point it's just sort of encapsulating

00:32:26,930 --> 00:32:31,580
the logic that I had before into a

00:32:28,580 --> 00:32:38,470
service all righty

00:32:31,580 --> 00:32:42,500
so we're on five I'm going to load six

00:32:38,470 --> 00:32:43,700
so right now actually I'm going to not

00:32:42,500 --> 00:32:44,960
do that I'm going to go back to five

00:32:43,700 --> 00:32:48,410
because I want to show you the problem

00:32:44,960 --> 00:32:50,420
that six is solving so right now we

00:32:48,410 --> 00:32:53,360
haven't told anything to Drupal about

00:32:50,420 --> 00:32:56,870
when to change these notices like so the

00:32:53,360 --> 00:32:59,840
block oh we haven't said hey when

00:32:56,870 --> 00:33:01,610
somebody update its updates notices make

00:32:59,840 --> 00:33:05,840
sure you re render the block so right

00:33:01,610 --> 00:33:08,990
now let's look at the site and I'm going

00:33:05,840 --> 00:33:11,780
to yeah okay so I have hello and hi

00:33:08,990 --> 00:33:17,390
admins and I'm gonna open up another tab

00:33:11,780 --> 00:33:18,510
and I'm going to go to role notices and

00:33:17,390 --> 00:33:23,190
I'm gonna say

00:33:18,510 --> 00:33:27,210
thanks for being a member so I've

00:33:23,190 --> 00:33:31,020
changed the notice Oh actually this is

00:33:27,210 --> 00:33:33,450
gonna update it's gonna update now

00:33:31,020 --> 00:33:36,410
because I cleared cache when I change

00:33:33,450 --> 00:33:40,650
the get files but let's do it again and

00:33:36,410 --> 00:33:44,010
add a bunch of exclamation points and

00:33:40,650 --> 00:33:45,600
save it and hopefully yeah so now it

00:33:44,010 --> 00:33:47,460
didn't update it so the first time the

00:33:45,600 --> 00:33:49,740
only reason that updated the first time

00:33:47,460 --> 00:33:51,450
is because I didn't show it doesn't you

00:33:49,740 --> 00:33:53,309
don't see this but every time I go to a

00:33:51,450 --> 00:33:55,020
new stage I clear cache so that's why

00:33:53,309 --> 00:33:57,480
that you don't want to have to obviously

00:33:55,020 --> 00:34:00,390
every time you save your notices to okay

00:33:57,480 --> 00:34:04,230
remember to clear cache so here I didn't

00:34:00,390 --> 00:34:07,230
actually bring in the new it didn't

00:34:04,230 --> 00:34:09,270
bring in the new exclamation points

00:34:07,230 --> 00:34:11,190
because Drupal didn't know like didn't

00:34:09,270 --> 00:34:14,940
have any reason to re-render it so let's

00:34:11,190 --> 00:34:22,440
look at how that is done well we have to

00:34:14,940 --> 00:34:25,320
go to the new stage which is six and so

00:34:22,440 --> 00:34:28,470
when we do that basically the only thing

00:34:25,320 --> 00:34:31,440
that's changed here is that basically in

00:34:28,470 --> 00:34:33,659
my block I add this pound cast so I'm

00:34:31,440 --> 00:34:35,190
basically telling Drupal hey this is

00:34:33,659 --> 00:34:38,970
some information about when to

00:34:35,190 --> 00:34:41,609
invalidate this rendered output so the

00:34:38,970 --> 00:34:46,050
first thing I do is put context user dot

00:34:41,609 --> 00:34:49,200
roles and this is a contact a cache

00:34:46,050 --> 00:34:51,659
context provided by Drupal core that is

00:34:49,200 --> 00:34:53,940
the combination of the user role so

00:34:51,659 --> 00:34:55,950
basically if this was the only thing I

00:34:53,940 --> 00:34:58,710
had then it would cache it for anybody

00:34:55,950 --> 00:35:01,440
who has the same roles for me as me so

00:34:58,710 --> 00:35:03,869
the idea is that if I get the new editor

00:35:01,440 --> 00:35:05,670
role I want to see the editor messages

00:35:03,869 --> 00:35:08,340
so it has to endure plasti know that oh

00:35:05,670 --> 00:35:10,530
when the combination of roles changes

00:35:08,340 --> 00:35:12,810
make sure you re render this so you get

00:35:10,530 --> 00:35:14,730
the new message as most person might

00:35:12,810 --> 00:35:17,040
have conversely if I take the editor

00:35:14,730 --> 00:35:19,680
role away I should no longer see that

00:35:17,040 --> 00:35:24,510
message the other thing that I'm doing

00:35:19,680 --> 00:35:26,550
here is I am return I want to also set a

00:35:24,510 --> 00:35:30,090
an array of strings which are render

00:35:26,550 --> 00:35:31,750
tags are sorry cache tags and here I

00:35:30,090 --> 00:35:34,500
just have

00:35:31,750 --> 00:35:37,570
an element in the array called tags and

00:35:34,500 --> 00:35:39,310
here again I'm using my manager so up

00:35:37,570 --> 00:35:42,670
here I call the service and set it to

00:35:39,310 --> 00:35:44,380
notice this manager and what I'm doing

00:35:42,670 --> 00:35:46,660
is I'm calling I made a new public

00:35:44,380 --> 00:35:48,910
function called get render tags because

00:35:46,660 --> 00:35:51,190
I don't want the block itself and

00:35:48,910 --> 00:35:53,770
ultimately the user field when I have it

00:35:51,190 --> 00:35:56,560
to have to figure out how to do that so

00:35:53,770 --> 00:35:57,400
here I just basically if I get a bunch

00:35:56,560 --> 00:36:00,040
of role IDs

00:35:57,400 --> 00:36:02,980
I make strings that's role notice : role

00:36:00,040 --> 00:36:04,660
ID role notice : role ID so for any for

00:36:02,980 --> 00:36:07,480
all the notices that are displayed

00:36:04,660 --> 00:36:10,660
that's what I would have here so I am

00:36:07,480 --> 00:36:12,550
going to kind of I'll I'll show you that

00:36:10,660 --> 00:36:13,510
it works and then we'll go on to the

00:36:12,550 --> 00:36:17,470
next one because we have very little

00:36:13,510 --> 00:36:21,580
time okay so I'm gonna save this so it

00:36:17,470 --> 00:36:25,650
didn't before it did an update now it

00:36:21,580 --> 00:36:31,450
should update yeah so it updated there

00:36:25,650 --> 00:36:34,000
so so basically I think that's it for

00:36:31,450 --> 00:36:38,619
this stage was just to add the cache

00:36:34,000 --> 00:36:42,460
tags where's my block and one thing if

00:36:38,619 --> 00:36:45,310
you do test out this module user one has

00:36:42,460 --> 00:36:46,780
a different doesn't actually use its

00:36:45,310 --> 00:36:49,210
combination of roles

00:36:46,780 --> 00:36:51,430
it always has this is super one so this

00:36:49,210 --> 00:36:53,170
if you test this out test it with not

00:36:51,430 --> 00:36:56,800
user one for this the tag thing will

00:36:53,170 --> 00:37:00,520
work but the way core does roles for

00:36:56,800 --> 00:37:02,590
user one is different but it will still

00:37:00,520 --> 00:37:06,280
user one would still update with new

00:37:02,590 --> 00:37:08,680
notices okay so I'm gonna skip

00:37:06,280 --> 00:37:09,880
dependency injection for right now but

00:37:08,680 --> 00:37:11,830
if you want to take a look at it that

00:37:09,880 --> 00:37:14,320
step is in the one so we can see the

00:37:11,830 --> 00:37:16,900
Drupal 9 thing and the dependency

00:37:14,320 --> 00:37:19,210
injection step also has a lot of inline

00:37:16,900 --> 00:37:20,980
comments to explain what's going on so

00:37:19,210 --> 00:37:24,190
what I'm gonna do now is I'm going to go

00:37:20,980 --> 00:37:26,140
to step eight where I go back and I make

00:37:24,190 --> 00:37:28,810
sure that I'm using a deprecated

00:37:26,140 --> 00:37:30,700
function so I have something to upgrade

00:37:28,810 --> 00:37:32,980
so one thing about this module is the

00:37:30,700 --> 00:37:36,010
last time I did this session was in 2015

00:37:32,980 --> 00:37:38,350
and so I got this module out justed it

00:37:36,010 --> 00:37:40,480
off and I ran the upgrade ER and the

00:37:38,350 --> 00:37:43,540
only thing I had to change besides the

00:37:40,480 --> 00:37:45,460
info file was this right here Drupal set

00:37:43,540 --> 00:37:46,780
message

00:37:45,460 --> 00:37:50,339
so the think two things don't have to

00:37:46,780 --> 00:37:50,339
change the drupal set message and

00:37:50,970 --> 00:37:55,869
something in info file which I'll show

00:37:52,869 --> 00:37:58,930
you in a second i have the updater

00:37:55,869 --> 00:38:01,150
module update status grade status module

00:37:58,930 --> 00:38:02,650
and I'm not gonna basically I'm not

00:38:01,150 --> 00:38:06,579
gonna run it right now I've already run

00:38:02,650 --> 00:38:08,470
it and what it's telling me is hey

00:38:06,579 --> 00:38:09,670
Drupal set message needs to change so

00:38:08,470 --> 00:38:11,650
it's basically telling me what I

00:38:09,670 --> 00:38:13,000
actually need to change it to and it

00:38:11,650 --> 00:38:14,619
says if you want this to actually be

00:38:13,000 --> 00:38:18,099
compatible with Drupal at nine here's

00:38:14,619 --> 00:38:21,819
what you do I am going to do that switch

00:38:18,099 --> 00:38:23,559
to nine compatible module and I won't

00:38:21,819 --> 00:38:27,400
even show you this on this site what I

00:38:23,559 --> 00:38:29,020
will do is I will copy this no I think I

00:38:27,400 --> 00:38:31,720
need to open up the fine so I have my

00:38:29,020 --> 00:38:34,950
finder for my Drupal 9 site here oppa

00:38:31,720 --> 00:38:44,349
triple nine and then I go to my module

00:38:34,950 --> 00:38:51,099
and so I'm gonna go to modules I have

00:38:44,349 --> 00:38:53,530
nothing in there nothing at my sleep I'm

00:38:51,099 --> 00:38:57,220
gonna drag this onto here so now I have

00:38:53,530 --> 00:38:58,869
roll notices here my Drupal 9 site the

00:38:57,220 --> 00:39:02,500
thing that I had the other thing besides

00:38:58,869 --> 00:39:06,250
the Drupal set message that I had to

00:39:02,500 --> 00:39:08,859
update was I hope I didn't take it out

00:39:06,250 --> 00:39:13,540
of this one hope it copied it I feeling

00:39:08,859 --> 00:39:25,680
it didn't it didn't I can show you it on

00:39:13,540 --> 00:39:25,680
this one so we're gonna skip to Adam yes

00:39:26,309 --> 00:39:31,089
okay so I

00:39:29,079 --> 00:39:32,349
besides the Drupal set message thing I

00:39:31,089 --> 00:39:34,450
had to change this core version

00:39:32,349 --> 00:39:36,400
requirement too this is a composer

00:39:34,450 --> 00:39:38,950
constraint that to the right of the

00:39:36,400 --> 00:39:41,680
colon so I couldn't be more fine-grained

00:39:38,950 --> 00:39:44,020
but I'm basically saying any 8 or 9 that

00:39:41,680 --> 00:39:55,420
this should work on and then if we look

00:39:44,020 --> 00:39:58,299
at the form then down here we have the I

00:39:55,420 --> 00:39:58,900
get the messenger and then I add

00:39:58,299 --> 00:40:00,700
messages

00:39:58,900 --> 00:40:02,109
this is just from form base gives me a

00:40:00,700 --> 00:40:06,430
little helper to get the message service

00:40:02,109 --> 00:40:09,000
and let's go to Drupal 9 this is my

00:40:06,430 --> 00:40:12,069
Drupal 9 version I'm good to go to

00:40:09,000 --> 00:40:15,789
extend hopefully I didn't already enable

00:40:12,069 --> 00:40:17,859
it roll so roll notices so it recognizes

00:40:15,789 --> 00:40:20,770
it be basically it recognizes it now

00:40:17,859 --> 00:40:27,069
because the info llamo file I enable it

00:40:20,770 --> 00:40:33,970
and while I should everything should

00:40:27,069 --> 00:40:35,740
work so I'm out of time but I already

00:40:33,970 --> 00:40:38,819
had this enabled on the site that's we

00:40:35,740 --> 00:40:41,890
have they one two three so basically

00:40:38,819 --> 00:40:45,670
that's it so it's not really like the

00:40:41,890 --> 00:40:48,309
big takeaway is Drupal most in most

00:40:45,670 --> 00:40:49,900
cases Drupal your Drupal 8 module is

00:40:48,309 --> 00:40:54,010
very very close to being Drupal 9

00:40:49,900 --> 00:40:55,200
compatible so I don't think do have time

00:40:54,010 --> 00:40:58,180
for questions

00:40:55,200 --> 00:41:00,220
anyways I don't think I do but feel free

00:40:58,180 --> 00:41:01,980
to come up and ask me questions so thank

00:41:00,220 --> 00:41:09,789
you

00:41:01,980 --> 00:41:09,789

YouTube URL: https://www.youtube.com/watch?v=NSE_mYn-o8c


