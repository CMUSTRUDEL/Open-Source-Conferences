Title: DrupalCon Munich 2012: Deploy with Capistrano
Publication date: 2013-03-29
Playlist: DrupalCon Munich - August 2012
Description: 
	Prepare to be dazzled with how easily you save yourself time, money and unicorns by using a deployment tool like Capistrano. No longer shall you battle with command line RSI! It's time to embrace the power of deployment tools, today!

This session will give a 101 on installing and configuring Capistrano to deploy you projects and demonstrate some neat tricks for special cases. The session is a very practical, hands on look at using Capistrano in combination with Git to accelerate your deployment processes.
Captions: 
	                              okay hello everyone you ret deployed                               with Capistrano everybody having fun                               too warm all right my name is Michael                               priests I'm a tech lead with trailin and                               I've been working with them for about                               three and a half years now working with                               Drupal about six and a half or so from                               Adelaide Australia so it's been a fare                               hike to get here but it's good to be                                here unfortunately things are almost                                over but that's too bad ok so I'm going                                to talk about Capistrano and a bit of an                                introduction to automated deployment and                                I'll just kind of pre takes things with                                why I got interested in Capistrano and                                basically it was client concerns we                                needed to do a pretty complex sort of                                deployment we're quite needed to review                                a site before it went live in and tight                                in its entirety you know in a staging                                environment before getting pushed to                                multiple production servers sitting                                behind a load balancer so that's kind of                                I didn't really look too much around I                                just knew of Capistrano and that seemed                                to be fine for the job so that's why                                I've gone with it but there are other                                options ok so the point of automated                                deployment is to make a new version of                                application available on one or more                                remote web servers Wikipedia said it                                must be true so we wanted to play our                                new features new functionality                                configuration changes globe fixes                                whatever that change maybe put it in                                code and hopefully we can deploy it                                nicely so what I've deal with today is                                just this very basic use case but you                                know capistrano supports a whole range                                of you know and inside of many other                                deployment tools support a range of                                multiple server deployments and we'll                                have                                so I guess we'll start with how people                                are deploying right now hopefully                                hopefully not that definitely not the                                the first one how SCP or a sink well                                it's not not a whole lot better but                                you're probably on a command line that's                                a good start bash scripting well that's                                kind of one step before you realize that                                that's not enough and maybe you want to                                use some sort of framework like                                Capistrano or fabric or something a lot                                of people are just happy to you know log                                into that production server and just get                                pull or you know if you're still using                                svn some people are deploying using ager                                don't know much about it myself but and                                rushers always getting new features in                                relation to deployment so I'm sure I                                have no idea what's going on there and                                its really awesome but we're going to                                look at Capistrano equity devcloud and                                Pantheon also have some really nice                                tools for just drag and drop the point                                between like a development staging and                                production environment which is very                                nice and similar to this but this is                                more about a custom solution so if if                                something like that is going to work for                                you and you're willing to to pay their                                their fees and what have you rather than                                run your own server that might be a good                                option to maybe you don't care maybe you                                have some minions to do that job for you                                so um                                the reasons why you want to automate                                this process you know it's a very                                repetitive process log into production                                go through all these steps and getting                                tomorrow you make a change and you need                                to do the same thing again that's great                                it's boring coders are lazy for the most                                part I think and so we want to do it                                once and then never have to worry about                                it pick in humans are prone to making                                errors so when we're logging into a                                server I'm sure that some of us that are                                guilty of doing something silly on a                                server I know that I've managed to wipe                                out of production database once many                                years ago it was backed up you know                                within the last                                                        deal but it was some time ago I've                                learnt my lesson and then there's                                permissions issues you need to have                                access to that production server and so                                perhaps you know on the smaller side of                                 things this this permissions too lenient                                 and so you can log in and you know                                 you've got root on that server and you                                 can accidentally stuff things up very                                 easily in that didn't work so well in                                 the in a bigger sort of environment you                                 tend to find that permissions are too                                 restrictive you log into that production                                 server and then oh I dunno shoot all                                 access or don't have permission to                                 rewrite those files or whatever so                                 all this can lead to a bit of rage on                                 when you face a sysadmin please fix it                                 for me and this will ensure so the aims                                 of automated deployment you know we want                                 quick safe so by quick I mean we just                                 want to run one command or a very                                 limited set of commands to do our                                 deployment safe you know we're thinking                                 about permissions so that if we have a                                 set of steps in place they're just going                                 to execute and nothing different will                                 happen from the last time that we did it                                 it should be easy you know one step and                                 efficient so we've right at once get it                                 right and then after that we start                                 reaping those rewards of setting this up                                 properly in the first place and and not                                 having to do everything manually so it's                                 awesome how do I do it first you need to                                 pick a tool there's quite a few hammers                                 to get the job done capistrano is just                                 one of them but it seems to be that                                 python is all the rage given a number of                                 these other ones available fabric was                                 aimed to be very similar to Capistrano                                 zappy is a we looked at Capistrano on                                 fabric and we don't like it it's too                                 complex everything's broken let's make                                 it really simple you can find that one                                 on code google com and answer ball he is                                 a bit of a combination of configuration                                 management and automated deployment and                                 codes appointments so that's kind of a                                 new one and I think for kitchens have a                                 good blog post about that which might be                                 worth checking out okay so Capistrano                                 was written in Ruby originally based                                 around deploying rails applications                                 because I'm sure that can be a bit of a                                 pain I don't know much about Ruby but it                                 sounds like people were having a lot of                                 trouble and so Capistrano came about to                                 simplify that process now what                                 Capistrano does is build us a set of                                 commands locally so from from where you                                 initiate the deployment and then ssh is                                 in to each remote server you may only                                 have one door you may even deploy to                                 your local machine but it will still SSH                                 you in locally and execute whatever                                 commands you have queued up you know no                                 task and so                                 there's a few sort of aspects of that                                 automated deployment and really we're                                 just concerned with code deployment of                                 the Capistrano you can essentially run                                 whatever commands you want but there's                                 some other better tools like for                                 configuration management or no system                                 automation like Hudson and Jenkins for                                 for that and chef and puppet our                                 configuration management tools so                                 okay so                                 really it was just a convenient way for                                 me to to get the job done but you know                                 it's not limited to Ruby or anything you                                 can use it for deploying any sort of                                 application installing it is pretty                                 straightforward on ubuntu I did it this                                 way you know and that will already                                 install the cap cap stratagem but if you                                 want to get it up to the latest release                                 you just install the the jam through the                                 gem package manager which is like rubies                                 equivalent of at get or pickle I just                                 had some other things there just to you                                 know it was interesting to see how many                                 other gems are available in the in that                                 repository related to Capistrano in                                 Drupal might be worth having a look so                                 if you're not on ever to or debian or                                 something similar you know you probably                                 need to do something a bit more                                 substantial to get up and running with                                 ruby and rails and the gems to be able                                 to install the gems which Capistrano is                                 a gem itself                                 and you can find some links from the                                 double key which are I've got some links                                 at the end                                 okay so one thing you do need to get                                 configured well it's not a hard                                 requirement but if you don't set up SSH                                 keys each time you run like a set of                                 commands a task you will be prompted for                                 a password which is very annoying so I                                 recommend setting up this SSH keys and                                 you may also need it for authenticating                                 with get if you're using like github or                                 something which requires a ssh key for                                 authentication                                 ok                                 son d                                 I think this is                                 let's load okay all right so these are                                 the the two sort of files that you can                                 serve with when you start using                                 capistrano ones your cap file which                                 contains you know project specific                                 requirements so in terms of if you're                                 using some plugin for Capistrano which                                 you can install through like the gem                                 management tool then you need to specify                                 that in there and also you're able to                                 define your own task within that cap                                 file so that if you have some very                                 specific tasks that you know specific to                                 your project you would want to define                                 them in there and also the deployed RB                                 and that's where you define things like                                 paths and passwords users all these                                 sorts of things that are required to log                                 in or you know specify where an                                 application is living                                 so the terminology can be a little bit                                 daunting if you haven't looked at it a                                 code deployment tool before so primarily                                 you deal with roles and so role is                                 essentially a server and it there could                                 be you know you can assign multiple                                 servers to a role and also multiple                                 roles to our server so basically that                                 means that when a task is executed you                                 know it can be run against many servers                                 or just one or you know you can mix and                                 match as you need to there is one                                 special thing there about the primary                                 and that's just to say that that's the                                 primary database server so if you                                 specify other database servers that's                                 the one that Capistrano will try and                                 deploy to when you're using Capistrano                                 to make database changes                                 so a task is pretty straightforward you                                 you give it a name and you say which                                 hosts or which roles it applies to so                                 you can just not worry about the roles                                 if you if you want you can just specify                                 a host correctly and then some command I                                 mean this is just an example so it's                                 pretty pretty useless command really so                                 in my drupal okay so when you start                                 using Capistrano you need to Kappa Phi                                 your project which creates the cap file                                 and the deploy our B file and these are                                 very default sort of configuration so                                 pretty useless for in terms of Drupal                                 you really need to make some changes                                 there a few changes to to get up and                                 running but you just replace them as you                                 do too and it's as simple as just                                 running kappa phi and then the path so                                 dot works just fine and you'll see those                                 files get generated additionally you can                                 set up a multi-stage deployment and and                                 so you would just manually add these                                 conflict deploy dev staging production                                 and you can also add task within those                                 are beasts as well so that you can have                                 specific tasks related to a specific                                 server which could be useful but try and                                 write things generally so that you can                                 reuse them                                 okay so                                 this is where as I said you keep your                                 configuration and you can set up some                                 roles in there so this is an example for                                 setting our application which is                                 basically the the directory that lives                                 in or for the most part a repository                                 that's where we're pulling from where we                                 climb from and the app path is where we                                 are deploying to and which branch we                                 want to want to be pulling against and                                 some of these are a little bit of school                                 and you just kind of have to deal with                                 it unfortunately and there are some                                 strange ones down the bottom default run                                 options this one is required to prompt                                 you for a password as needed so if you                                 run a sudo command on a remote host then                                 it needs a way of prompting on your                                 local to you know receive a password                                 back that's one little gotcha and the                                 ssh options Ford agent that's about get                                 authentication using an SSH key okay                                 so the responsibilities of the cap file                                 load those tasks from any sort of gems                                 that you're you know plugins for                                 Capistrano and define any project                                 specific tasks so it may look something                                 like this these are the gems at the top                                 and this is like what you get by default                                 when you kappa phi it's basically just                                 the way of loading those recipes by                                 default you know and you can comment                                 these out if you don't want any of this                                 standard recipes okay                                 so deploying should be as simple as just                                 cap deployed just running that which                                 sounds easier than all that to me or                                 maybe more depending on how many servers                                 you have to do or whatever so it sounds                                 good in theory it does require an                                 investment of time up front to get                                 everything up and running working and                                 you know learning Capistrano or any                                 deployment tool I'm sure has some                                 learning curve you know I don't know                                 Ruby so just some of those basic sort of                                 things that I wanted to do we're a                                 little bit tougher just because they're                                 to learn the syntax a bit you know or                                 understand how capstone is a little bit                                 strange about global variables like when                                 you you can just sort of set up some                                 variables but bringing those into scopus                                 you know there's a little trick to it so                                 documentation tends to be a bit Ruby                                 specific and so it's targeted to point a                                 ruby application most the time but I                                 think that that's starting to change a                                 bit the more you sort of people around                                 you can find some more triple specific                                 information there's quite a few links on                                 the wiki from well there's a link on the                                 wiki to a drupal specific deployment                                 there's a Capistrano triple gem which                                 i'm going to show you later does require                                 bit of sysadmin knowledge and what i                                 mean by that is when you're building a                                 recipe yourself you know building                                 writing some tasks the error is that you                                 get back can be kind of obscure at times                                 and so your can be scratching your head                                 a little bit and basically Google Sites                                 a day eventually so just keep going                                 around and you'll figure it out or                                 so try to keep it simple to start with                                 at least is my recommendation and if you                                 can find something that somebody else is                                 written that works well some of it                                 because it can be a little bit                                 time-consuming figuring out yourself all                                 right so I'm going to try and demo this                                 let's could be interesting                                 so I have two virtual servers here and                                 they both have triple running off each                                 so the Adelaide server is like where                                 it's coming from and unix where it's                                 going and so if we this is where we're                                 app is living so we cap deploy                                 you see that runs through a bunch of                                 commands that have been defined in this                                 Capistrano Drupal gym now this this                                 Capistrano Drupal gem you just need to                                 install through the the gym installer                                 and it's something that Sam was made by                                 Kim pepper from previous next in                                 Australia and so he's kind of to the                                 inspiration for this talk really so it's                                 not perfect I found but works for the                                 most part it just it's very finicky                                 about where you configure things and                                 make some assumptions about setting                                 things up a certain way to begin with so                                 right so now we've made a release let's                                 have a look on the other side so this is                                 how the production side looks we've got                                 this releases folder which we look in                                 there you can see a time stamp set of                                 folders which has each release in there                                 our shared folder is where our files                                 kept files and private files neither of                                 those get changed between releases so                                 they're kind of put aside in a static                                 area and settings PHP that's something                                 that won't be changing each time it's                                 something with production specific                                 settings so you keep that aside and the                                 Acacia copy is basically a git checkout                                 of                                 you're the lightest                                 so if we                                 in the case to copy second                                 okay so i can see that a bunch of                                 releases got tagged the reason that not                                 all of those releases in the tags is                                 because i came across a little bug and                                 was debugging that and the deployments                                 to work but the very last step is to tag                                 those releases and so that's why you're                                 missing so I can                                 I'm just going to show you the natural                                 gem itself                                 so if you install it I mean this is                                 probably the easiest way to find it just                                 do a locate on Capistrano dash Drupal do                                 that                                 do                                 alright                                 okay so this is the Capistrano Drupal                                 gem and so for example this is that tag                                 piece of code that I they had the                                 problem with so this is this is a task                                 push deploy tag and so it was it was                                 having some health issues this doesn't                                 seem quite right in this section so I've                                 just kind of hacked it to make sure that                                 it changes to the right directory before                                 it does that tag get tagged and push the                                 origin that you tagged okay                                 so                                 with a bit of luck to do a bit more                                 demonstration and we'll try and make a                                 change commit it and see what happens on                                 the other side so                                 trying                                 make a change to a feature and export                                 feature and                                 see what happens                                 when we deploy and                                 if it ever loads this is a very slow                                 laptop                                 so the the benefits also is that like                                 when you've done a deployment you can do                                 a cap rollback if something goes wrong                                 with that deployment and it will just                                 take that symlink and kind of miss this                                 point so you see that current release is                                 just a symlink to a specific release and                                 so on a roll back it's just changing                                 that simply back to the previous release                                 hmm                                 we might skip that I think it's probably                                 not going to work but all right                                 that we comes back                                 very possibly                                 barlow right okay sorry                                 probably give thanks to Kim pepper for                                 really making a fair bit of effort on                                 that capistrano drupal gem it really is                                 in need of some TLC and it's it's a                                 project on github so if you want to                                 contribute you know I'm sure is more                                 than welcome to motor some commits motor                                 some patches and thanks for trying for                                 getting me here because it's it's very                                 long dream for me so any questions                                 do so like you can                                 roll back ok yeah right                                 not with the Capistrano Drupal gem it's                                 not really concerned with doing a                                 database deployment it's just code so no                                 not for that instance but you wrote the                                 another project um where we did do a                                 whole like database dump and you know                                 that's been since improved for this                                 client project where that database was                                 restored and yeah that's right right so                                 so another thing that we did on on that                                 particular project was instead of like                                 replacing the existing database we just                                 have like a navy database so when you                                 actually switch symlink you had a second                                 settings PHP file which you know aloud                                 and two databases sitting side by side                                 so when it came time to actually deploy                                 you could very quickly roll back to the                                 previous database without having to                                 reload the database to restore so as                                 well as making backups of course but                                 yeah anything else sure just them using                                 like five please                                 hopefully works hello when user uploaded                                 images and files this is something you                                 should think about best practice are you                                 talking in terms of like on on the                                 production server or I mean using this                                 particular Capistrano Drupal gem I mean                                 those files are set aside so they're not                                 unless Drupal has some sort of bug where                                 it decides to delete them you're not                                 really and having too much of a problem                                 well they're just set aside there in                                 that in oh right so you know they get                                 sim linkedin to where they need to be                                 right exactly yeah                                 so if you're starting from scratch                                 course that functionality is in there                                 but if you use like that capistrano                                 drupal jam you get a whole heap of                                 features for free but it's just a little                                 bit finicky sure                                 you mentioned that you were you have                                 hack the gem a little bit because those                                 write something about the files not                                 being the right places or something I                                 just how default are the sort of the                                 settings is it trying to do something                                 like fart dub dub dub or in that case I                                 think it was using a call which would                                 have been looking in my home directory                                 rather than actually changing into the                                 directory where the where drupal is you                                 know so so when it was trying to                                 convince something was trying to                                 generate that tag you know there was no                                 repository because it was sitting around                                 so it was it was trying it was a                                 situation because of how you develop                                 rather than say a problem with the gem                                 itself well I I'm not a hundred percent                                 sure I think it may be a problem with                                 the gym it may be a problem with my                                 configuration I just haven't figured out                                 and that's why I mean with this this                                 particular gem it's just a little bit                                 finicky and so that would that was like                                 the last issue that I had to resolve                                 with it around for this presentation                                 really my my use of it for for Ellen was                                 completely from scratch and so dealing                                 with this other deployment which had                                 some very special means so                                 any other questions                                 going once going twice three times sold                                 all right thanks everyone                                 right                                 I think if I had my time back I probably                                 hit towards one of those Python once one                                 of the Python alternatives rather than                                 capistrano but
YouTube URL: https://www.youtube.com/watch?v=fvkiWfjmKQ4


