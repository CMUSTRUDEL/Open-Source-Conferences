Title: DrupalCon Denver 2012: GETTING IT INTO DRUPAL WITH MIGRATE
Publication date: 2013-03-28
Playlist: DrupalCon Denver - March 2012
Description: 
	Migrate module is a powerful tool for importing, transforming and syncing content from external sources into Drupal. The power comes from an object oriented API that's tricky to get started with. We'll walk through the various classes in the module and how they work together to manage migrations.

Questions answered by this session: 
What are the parts of the Migrate module?
How do they work together?
How do I start building a migration?
What functionality does Migrate provide and what do I need to write?
When should I use Migrate instead of Feeds?
Captions: 
	                              all right well I guess we're good to go                               thank you for coming I'm Andrew Morton                               gonna do the deed hear me                               is that working no at all                               is this better at all anybody hear me                               louder can anybody hear me how's this                               all right                               it sounds really loud up here either way                               so you know so I'm Andrew Morton gonna                                be giving a talk on the migrate module                                and you know getting stuff into Drupal                                I'm one of the maintainer x' the progeny                                the guy that started it Mike Ryan is                                here in the front I think I don't know                                if the motion is in this room but                                they're they're also giving another I                                think more of kind of a business                                oriented talk after this in the same                                room so if if this one's a little too                                technical then you know maybe that's                                that's the one you want so you've got                                this old website or you know CSV file or                                you know something that you're trying to                                get into Drupal I'm guessing you're here                                because you want a better way to do that                                could we get a show hands of like you                                know just shout out what you guys are                                doing right now like you know what's                                what's your strategy you know do you                                have the intern copy and paste things or                                oh so note import feeds CSV file with                                like a custom script or do you do with                                feeds oh you want to know okay all right                                cool so yeah I definitely have done some                                kind of you know the the full range of                                things used feed CSV files a little                                custom script and and whatnot and and I                                think migrates a much better solution so                                here's kind of my goals for this                                presentation the the migrate module is                                kind of complex but it's complex for a                                reason                                and what I want to do is give you kind                                of like the mental framework to                                understand it so you can understand you                                know why it seems as inscrutable as it                                does and then we'll kind of step through                                the basics of like how you would build a                                migration module and you know if you                                guys are contributors and I'm gonna try                                to convince you that it's worth your                                time to provide support for migrating                                your modules so we're gonna talk about                                migrate                                                              version that was primarily views driven                                you'd use you know views to kind of do                                all the mapping between source and                                destination migrate to is primarily code                                based there's a there's a UI and there's                                address interface but all of the setup                                and configuration is done in PHP classes                                and it's got a steep learning curve                                you know you might call it the migraine                                module cuz I spent two weeks just                                banging my head against it before I got                                to the point where I was like oh okay                                here's how you actually get this to work                                so what I really don't want is you guys                                to have that experience hopefully you                                know you'll get done with this and the                                the system will make a little more sense                                I'm what I'm not going to do is                                demonstrate the UI or the drives                                interface they're both pretty neat I'm                                going to show you the screenshot to                                prove that they do exist and encourage                                you to check those out in your own time                                there's also a Drupal                                                 basically a back port of the                                           of ways it uses dbn g DB TNG and                                autoload so you can kind of jump back                                and forth pretty easily                                except that then you're back in Drupal                                  and like wondering why nothing works                                right                                there's the my great extras module which                                is sort of the you know dumping ground                                for construed module support that isn't                                in those contributed modules so you know                                like address field and I'm gonna space                                out on thinking of like what web form                                you know those kind of things that                                haven't been put into the module those                                live in mom in my grade extras so you                                want to take a look there if you're                                trying to figure out how to get                                something into ended rupal and one other                                thing that's kind of important to point                                out is that the the best documentation                                 for it aside from this presentation is                                 in the the beer and wine files in the my                                 great example module those get updated                                 pretty much with any kind of change and                                 they they serve as unit tests for the                                 for the module so give that a look                                 there's a ton of ton of really useful                                 information in there it's all really                                 well documented and you know in you can                                 kind of copy and paste a lot of stuff to                                 get started I've given this talk a                                 couple times and this generally comes up                                 like why not just use feeds and you know                                 I'm a pragmatist like if it works for                                 you use it it's it's a lot easier to set                                 up it's you know you can kind of almost                                 hand it off to the admin to go you know                                 kind of map the fields but my grade is                                 definitely to be like a higher                                 performance solution you're gonna be                                 able to it's it's gonna run a lot faster                                 you're not trying to have it be cron                                 driven and where feeds kind of falls                                 down is where you've got a couple of                                 different things that you're bringing in                                 and you need to have some kind of                                 relationships between them and that's                                 where my grade is a better solution so                                 what kind of talk about the theory of                                 this and like I say I kind of explain                                 why Margit migrate is what it is so you                                 got a you got a source and you got a                                 destination right you got something                                 you're coming out of and something                                 you're going into and you know those                                 have you know fields in the you know in                                 the likes a sequel sense on the source                                 side and on the in the Drupal field                                 sense on the destination                                 well not necessarily pretend like so you                                 know your source it's it's kind of the                                 interface into into whatever you've                                 already got if it's a you know CSV file                                 if it's a you know Microsoft sequel                                 server                                 you know other another my sequel                                 database you know a web feed that kind                                 of thing and and what it really provides                                 is just a list of fields and optionally                                 descriptions about them and and then it                                 just needs to be able to step through                                 them in order it just needs to be                                 iterated cross them on the destination                                 side it's it's a little bit more                                 complicated because it needs to handle                                 writing it and so for the most of the                                 Drupal entities that you know come come                                 with Drupal core the support is already                                 provided you know the the entities like                                 users and nodes                                 you know those you're not gonna run with                                 but you can also do other things on the                                 destination side there's a destination                                 that'll just let you write sequel rows                                 and one thing that's kind of important                                 to point out is the the destination is                                 first was for a specific type so if                                 you've got say a table full of user                                 information that you're going to use to                                 create users and then to create you know                                 profile to profiles that needs to be two                                 different that's two different                                 destinations and the migration so you're                                 actually can end up with two migrations                                 you can end up with one that creates                                 users and one that creates the profiles                                 so the next kind of step is you know                                 you've got fields on both sides what                                 what goes where and so they the concept                                 for that is a field mapping and the way                                 that kind of works is you just give it                                 the on the source side you give it a                                 field name on the destination side you                                 give it a field name and it encapsulates                                 some other information and as the kind                                 of example shows like you don't have to                                 map all the fields you know some things                                 maybe know there's some stuff that you                                 know you just don't care about on the                                 source side and you know maybe on the                                 destination side you just want to                                 hard-code default values so you know                                 again it kind of holds on to you know                                 the names of the fields on each side and                                 it has some people to do some kind of                                 basic transformations if you've got like                                 a comma separated you know field it can                                 it can split those out so that then                                 you know handled as an array like if                                 you're going into a multi-value field on                                 the destination side and and it has                                 ability to hold arguments that can pass                                 the destination and we'll say more about                                 those later                                 so with those first three pieces you                                 basically have what feeds gives you                                 right you've got you know some kind of                                 abstraction on the source side you've                                 got a destination and you've got you                                 know field mappings and and what I said                                 was that you know that feeds kind of                                 falls down when you've got more than one                                 type and you need to have a relationship                                 between them and so one of the the way                                 that kind of migrated addresses that is                                 with a migration map and it tracks the                                 the source ID and then what it becomes                                 in the destination ID so if you're                                 importing something and say you're                                 importing you know articles and users                                 when you bring them into Drupal they're                                 probably gonna have new IDs you know                                 your WordPress user ID is not going to                                 be the same as your Drupal user ID so                                 when you go to import your articles you                                 you know you're you you're given the                                 WordPress ID but you want the Drupal                                 user ID so what the that might mate                                 excuse me migration map does is lets you                                 look up what the old ID is and kind of                                 translate back and forth so to do that                                 it needs to know what your what your                                 keys look like what are the IDS look                                 like so it'll support composite keys                                 which is the case where you'd have an ID                                 that's in two separate fields so and it                                 has a couple of other nice side effects                                 since you're keeping track of all the                                 IDs that you've created you can go                                 rollback and delete all those records                                 and then the other is that you could                                 rerun a migration so you imported those                                 articles and you realize that oh the you                                 know that the timezone is all screwy so                                 you can just you know fix that in your                                 migration rerun it and then it'll update                                 those articles in place so you don't                                 have to you know run up your node ID                                 counter or whatever                                 and then then the next piece is is a                                 migration that kind of wraps it and puts                                 all the pieces together and and that's                                 the that that's actually what you'll be                                 building you you implement a migration                                 class and it has a couple of other                                 little helper functions that I'm just                                 gonna like mention here so that you know                                 kind of visually where they live                                 but I'll say more about it when we talk                                 about building a migration and so as I                                 said it's it's it's where you configure                                 all the pieces you know the source the                                 destination the map and then all the                                 field mappings and then the next kind of                                 piece is the field handlers and so if                                 you think about the way that Drupal kind                                 of builds entities they're these like                                 the fields are typically these like                                 nested arrays and it's it's a                                 non-obvious structure it's it's kind of                                 complicated and if you think about what                                 the source is going to be the source is                                 going to be a simple value it's going to                                 be a string it's going to be an ID you                                 know and it's and so how do you get it                                 from that single value into that nested                                 array and and that's the job of the                                 field handlers and and they also are                                 what consumes the the data that you put                                 into those arguments on the field                                 mapping there's there's one other kind                                 of piece that is more of kind of an                                 implementation detail but is is of                                 interest and just to be complete here                                 we'll talk about it it's the destination                                 handler what that does is lets you kind                                 of extend a destination without the                                 destination having to know about all the                                 possible handlers or if there's a module                                 that gets turned on like that the                                 obvious an example is the comet module                                 where it adds a couple fields to the                                 node that if you don't have common                                 enabled you don't care about so node                                 doesn't have to care about the no                                 destination doesn't have to care about                                 the comments the comment and ler can                                 take care of that some of these names                                 get a little long so                                 you can blame Mike yeah sort of the same                                 thing and the destination Hitler is one                                 of the things that can trip                                 module maintainer z' might need to                                 create so let's look at this in practice                                 right you know sounds good but what what                                 does it actually look like the way that                                 you go about building the module is the                                 first off just put it in a separate                                 module don't put it in with the rest of                                 your custom site functionality because                                 what you want to do is be able to just                                 turn this off once you get everything                                 into your site turn it off                                 there's some other use cases for migrate                                 where you might have it doing continuous                                 imports but for the most part you still                                 want that in a separate module so go                                 ahead and create a new module don't just                                 do it in migrate example create a new                                 module with your namespace and then you                                 can leave my great example alone to you                                 know copy and paste from and then you                                 need to implement the the migrate api                                 hook you know create a class sometimes                                 I'll just get if it's a single migration                                 I'll just put in the module file be a                                 little lazy and then in the constructor                                 you know you set up the the source of                                 destination math and the you know field                                 mappings and if the class is in a                                 separate dot Inc file then you want to                                 make sure you add it to the dot info                                 file so that the autoloader can find it                                 so here's kind of what the constructor                                 would look like there's there's the for                                 there's the the three properties and                                 then one function that that you'll be                                 calling to do that setup and we'll go                                 through each of these in in term so                                 here's a like a sequel source                                 it's a DB T&G query you know it's                                 pulling up the what beer topic table it                                 picks out a couple fields                                 it sets a sort I don't really know why                                 we did that but so you take that query                                 and you pass it into the migrated source                                 sequel class and then yet it's able to                                 go and turn that into account query so                                 we can figure out how many things you're                                 going to be importing and you know does                                 does some other stuff but that's that's                                 kind of the basic the most basic use of                                 a sequel source one thing you'll notice                                 is that you're not specifying                                 a list of fields or you know the source                                 fields it's able to pull that out of the                                 query so like when you contrast that                                 like a CSV file because there you just                                 kind of have numbered columns you you                                 want to give them like a little bit more                                 readable names so for a CSV file you'd                                 build an array of the names and then you                                 know optionally in descriptions and I                                 think that's I think this might have a                                 little typo in it but then you give it a                                 path to the CSV file and the column                                 information and then that's your source                                 for for that example there's other                                 there's there's quite a few other                                 sources for doing like XML files JSON                                 files for those you're probably gonna                                 have to do some tweaking right because                                 if you're trying to pull in some like                                 something out of an API for like a JSON                                 file you'll probably end up sub-classing                                 one of the existing sources and                                 overriding some stuff maybe adding                                 pagination or adding caching you'll                                 probably definitely want to add caching                                 and there's a couple of base classes to                                 help with those I'm not really gonna dig                                 and do it too much I'm gonna leave this                                 slide here so that afterwards when you                                 realize you need them                                 you'll go download the slides and you                                 know kind of read about it the next is                                 the the migration map and as I kind of                                 mentioned it needs to know what those                                 the keys on the source and destinations                                 ID look like so you do that using the                                 Drupal's schema like hook schema format                                 and you'd give it an array of your                                 your-your-your fields on the source side                                 on the destination there's typically                                 helper functions so the destination                                 class and then it'll be that gets key                                 get key schema function so that you                                 don't have to manually type those in one                                 other thing that I should mention is                                 that first parameter to the sequel map                                 is the migrations machine name and and                                 the reason it needs to know that so I'll                                 just say what the machine name is that's                                 basically the class name but if it has                                 migrated on the end it just deletes                                 migrate so that it's a little                                 a little shorter and and the reason you                                 want to specify that you so that when                                 you're having another migration look up                                 a key in it it knows what it's called so                                 let's look at the destinations these are                                 a little simpler right because there's                                 not as much variation Drupal knows what                                 you know what the what the term had how                                 to build the term how to you know build                                 an article and so to figure out what                                 you're gonna pass into the constructor                                 on those like on the on the term that's                                 a machine name for taxonomy vocabulary                                 you know the nodes is going to be a node                                 type user you don't need one but I'd say                                 pull up the pull up the class for that                                 and you can usually see sometimes                                 there's some other options that you know                                 you might might find useful and the the                                 last kind of piece is the is the field                                 mappings and so that's how you get you                                 know source to destination one little                                 quirky thing is the the order the                                 destination is the first parameter the                                 source is the second and and the reason                                 for that is in that next example there's                                 the default value where so that you                                 don't have a source so it's a it's less                                 awkward having it be destination default                                 value rather than you know no comma                                 destination and the add field mappings                                 function returns a class that you can                                 then call the functions on and those are                                 those are chainable so that you know you                                 can specify separator pass some                                 arguments in and have a bit more compact                                 syntax so the                                 one kind of problem with migrate right                                 now that there's there's you know we're                                 trying to kind of figure out how to                                 address is that if you have a field that                                 has multiple kind of sub values in it                                 say the node body well yeah like a node                                 body it has you know the body text it                                 has a HTML or a you know a filter format                                 and it has a summary well so there's                                 three different pieces there but my my                                 great really only sees it is one field                                 so the question is how do you pass those                                 other values in and the kind of the hack                                 that we've come up with is you pass it                                 in through the arguments not great                                 hopefully we'll get that sorted out                                 pretty quick but so it has a little bit                                 of a kind of quirky format to it if you                                 pass in just a literal value like in the                                 example there you know format of one                                 that's gonna be hard coded as one but if                                 you use that array notation where it's                                 an array with a source field key                                 whatever the value of that key is will                                 be used as a field name it'll go look up                                 the value of that that field so in this                                 case you know we're importing we're                                 taking the teaser field on this row and                                 that's going to go into the end of the                                 summary on it on the destination side                                 one thing I guess I shouldn't mention is                                 if you guys have questions or something                                 doesn't quite make sense you know just                                 shout something out because otherwise                                 I'll just kind of keep steam rolling                                 along here so some of them might some of                                 the arguments have little helper                                 functions to build them I personally                                 think that first example is much harder                                 to read when you have to remember the                                 order of the things I think the second                                 where you pass in named parameters in                                 the array is a little bit easier but                                 yeah I think I think that's us trying to                                 work around a failure in the API by kind                                 of putting another bandaid on it so                                 let's talk about how you would do that                                 lookup of user and art and the user an                                 article example that I'd mentioned                                 the way you do that is you specify a                                 source migration on the field mapping so                                 in this we'd be creating our articles                                 and on the old side it was the author's                                 author underscore ID on the new site                                 it's UID and so what we want to do is we                                 want to translate that using the                                 migration map from the beer user                                 migration and so for this to really work                                 you kind of want the beer user migration                                 they've already run so you use a                                 dependency you for that you can you can                                 pass an array of migration names and                                 migrant want let you run this migration                                 until the dependencies have been                                 fulfilled and so with those those pieces                                 you could pretty much do quite a bit of                                 quite a quite a bit with migration but                                 there's a few other functions that you                                 can use to kind of customize the flow                                 confusingly they're named prepare row                                 and prepare and complete the the best                                 I've been able to figure is that prepare                                 came first and then we decided we needed                                 something else so we had to prepare row                                 so we'll try to make it clear what does                                 what prepare row gets called when when                                 the sources is looking at records and                                 you are able to skip a record it's kind                                 of the first pass so you're importing                                 files and you want to you want to skip                                 over temporary files so what you do is                                 you just return false if it's you know                                 whatever that the status field is temp                                 you know then you return false that row                                 gets skipped and you don't end up with                                 anything on the destination side you can                                 also make changes to it so you know say                                 you want to convert a you know date                                 string into a timestamp or you know fix                                 the case on something this is an easy                                 place to do that because this will                                 happen before it gets transformed into                                 the gets transformed by the the                                 destination                                 field handlers into that array structure                                 so it's a really easy place to do it you                                 can just you know fix it on the row the                                 next function you can implement to                                 affect the flow is prepare and it hands                                 you two pieces it hands you the entity                                 that's been built up so if you're                                 building a node it's gonna have all the                                 fields in that crazy array syntax and                                 then the second parameter is going to be                                 the source row so you know whatever came                                 out of the database or out of your CSV                                 file and this is a great place if you've                                 got a field that you don't have a field                                 handler for you can just go ahead and                                 hack it into that array structure and                                 you know or if you need to make some                                 other changes it's a it's an easy place                                 to do that and then the last one is                                 complete which gets called once the                                 entity has been saved so if you need to                                 you know say send out an email or                                 something with the new ID you could do                                 that here one thing I will point out is                                 if you're calling node save or entity                                 save on the if your if you're receiving                                 the thing you just imported you're                                 probably doing something wrong the one                                 kind of useful thing that I'd seen was                                 in commerce migrate they needed to                                 there's the orders and the line items                                 and they both need to know the IDS of                                 each other so what they were doing in                                 there was after so you'd create the                                 order then you create the line items and                                 then you'd go back and tell once as each                                 you know line item finished it would go                                 tell the order hey here's a new line                                 item or it might have done the other                                 order but that that's one kind of like                                 legitimate use of that that I've run                                 into so one one other kind of thing you                                 run into you and this is this is one of                                 those where this is what makes my grade                                 really really nice is dealing with                                 circular circular dependencies you know                                 this this is like one of those that I                                 kind of bang my head against with some                                 custom scripts you know say you've got                                 what one one example I ran into with                                 another commerce migration was if you're                                 there they've got like kind of a user                                 profile for for the building and the                                 shipping information                                 and a user right so the user has to                                 entity references to the billing and                                 shipping information and the shipping                                 the shipping and billing profiles both                                 have a user ID so which do you create                                 first how do you get that in there and                                 the answer is you you know use a stub so                                 you go ahead and if you're importing you                                 know dependent it's going to depend on                                 which one you want import first but you                                 you know just go ahead and create a                                 dummy user and then you know get your                                 profile set up and then you go back and                                 you know match them up or whatever and                                 so the way you do that is you specify                                 the source migration on the field                                 mapping and then the the migration that                                 sorry I'm going to screw up the naming                                 on this because I need to give them some                                 names so if you've got your first                                 migration that's running along and and                                 what it's going to try to do is it's                                 going to say okay go look up this ID in                                 the source migration for me it goes and                                 looks it doesn't exist so then it calls                                 that second migration that had just                                 checked and didn't have and it gives it                                 a chance to go ahead and create a new                                 record and it doesn't really put                                 anything in there it just creates it                                 gets the ID saves the ID back into the                                 map and then lets the first migration                                 continue on and then when the second                                 migration gets run yet because it's got                                 the idea in the map it just goes ahead                                 and updates that record fills out the                                 rest of the information and then you're                                 able to kind of move on so yeah that's                                 that's that's basically that process so                                 now I'm gonna just try to kind of                                 summarize the way that the import flows                                 through here I've got this next slide                                 that I'm gonna kind of do a little                                 reading off of because it's sort of hard                                 to keep it all in your head this is like                                 a nice little reference slide so the the                                 way that it's going to start is the                                 migration is going to ask the source for                                 record and it's going to keep grabbing a                                 record and then it's going to look at it                                 in the prepare row and if it skips it                                 it's gonna keep skipping in until it                                 finds one that you know is okay and then                                 whatever changes you made me prepare are                                 going to be kind of carried forward the                                 migration will go ahead and apply all                                 those field handlers                                 to transform the data into the into the                                 you know sort of the entity format of                                 all those nested arrays once that's done                                 the migration is going to call the                                 prepare function and let you do any                                 final modifications on the entity then                                 the death then it hands it to the                                 destination the destination oh go ahead                                 and save that entity and then it gets                                 passed back to the migrations complete                                 function and then the migration saves                                 the new and old IDs into the migration                                 map so yeah so if you've got a                                 contraband                                 help one would be providing a                                 destination so like and if if it's                                 something where you've got your own                                 structure like a web form submission you                                 know if you provide a destination then                                 you know people will love you if you're                                 doing the other would be a field tailor                                 so hopefully we won't need to if it's an                                 entity there's actually some pretty good                                 work that's been done on that as part of                                 the commerce Margate module so there's                                 that issue that you can go look at and                                 kind of just base it off that but if if                                 not my great extras has some pretty good                                 sample code that you can use to kind of                                 figure out how to go about writing a                                 destination on the other side would be                                 like a field Handler so if you've got a                                 C CK field like you're doing well                                 address field in you know email field in                                 the phone field have support but if it's                                 a single value field like if you've just                                 got you know one value that you write                                 you can extend the migrate simple field                                 Handler and very easily provide support                                 if you look at what we actually do in                                 migrate things like the user user                                 reference and the node reference those                                 those fields use that                                 so I'll just put this up and kind of ask                                 what what kind of questions do you guys                                 actually grab the mic back there in the                                 middle of in the middle of the row                                 I just wondered if you would make the                                 slides available to us yeah there are                                 they should be on the presentation note                                 on the conference so you could download                                 them off there it's as a PDF right now                                 oh is it they had it they had a                                 multi-value file filled on there like                                 two weeks ago and I had like a bunch of                                 different versions and then sometimes                                 since then they change it to a single                                 value field and so okay I'll put the                                 I'll put a PDF up there well I want to                                 thank everybody who's worked on the                                 module my use case was importing                                         records every month and on a continual                                 basis so migrate is hefty enough to do                                 the job                                 I found hook uninstall in the migrate                                 install file that was commented out some                                 code that it got rid of the tables for                                 the migrate messages and that's how I                                 was able to reset and begin a new                                 monthly import each time and it would                                 clear out all the messages all the stuff                                 that was there so getting again is there                                 a better way to do that to wipe it clean                                 wipe it fresh and then start another so                                 on your source thing you don't want to                                 keep the ones you've imported all the                                 information once it's imported I want to                                 start a new migration completely fresh I                                 don't want to do any all the mappings                                 and everything else is gone are the IDS                                 changing on those there are actually no                                 IDs that come in it's all basic text it                                 so but yeah that once they're created                                 and in then I can just drop all those so                                 that it was really nice it said you know                                 select from the schema information table                                 name and then drop those but does                                 anybody else that you know of any these                                 cases for that OD register migration                                 like says okay I don't know if that if                                 that helps if not come up and chat with                                 us afterwards yes so do you register                                 because I keep the all the module                                 information there but D register then                                 will clear out those tables with the                                 messages and he's he's nodding yes so                                 okay yes I think that's yes thank you                                 I'm working on a site that has a content                                 type that really should have been three                                 from the start is migrated something                                 that would help me split all of those                                 existing notes into three notes or more                                 you could yeah so one thing that                                 migrated I guess I you know in my whole                                 selling on my grade one thing it doesn't                                 do great is dealing with like Drupal                                 sites because there's like the                                    different joins as soon as you start                                 adding CZK fields so if they're actually                                 if it's on the same site you can kind of                                 get you can you can sort of be a little                                 sneaky and you could in your source just                                 go build your query to select your nodes                                 and then just select the note ID and                                 then in your prepare you can call node                                 load in there and so that that's how you                                 could kind of get it but then since it's                                 all in that that crazy nested array                                 structure you're gonna have to do some                                 flattening on that but it would be                                 pretty it would it would probably work                                 pretty well for that because you could                                 go through define your fields on the                                 source type and then be able to specify                                 you know you would become three                                 migrations right one for each of the                                 node types that you'd be creating but                                 you yeah I mean I think I think it would                                 probably be a you would be able to do                                 that pretty it's one of those how many                                 notes you have to that's kind of the                                 other thing because if it's like                                    nodes there's there's a about a thousand                                 at this point yeah then you know I think                                 it would be a reasonable fit for that                                 so my question is about dependencies if                                 you if you've got a road that                                 essentially has a column on it that                                 would indicate a node reference but                                 you're essentially free tagging them                                 right so when it comes across it that                                 node reference might be by title but it                                 may or may not exist yet                                 I guess could you speak to how I guess                                 out of the box those field handlers I                                 guess we're handling that or would you                                 do sort of a chain dependency of first                                 of all go through all the records and                                 create those nodes and do you get where                                 I'm sort of going with that say a little                                 bit more on kind of using sort of so you                                 say you have you know five rows and you                                 know row number one as a has a column                                 that's out to node a but node a doesn't                                 exist yet three four and five point to                                 node a is that would I just create that                                 would I just create that                                 programmatically at some point your                                 that's where that create stubs would                                 probably come in handy cuz it sounds                                 like if you can't order your source so                                 that those things you know sometimes                                 it's kind of like obvious the way you're                                 gonna do it right like just the node IDs                                 are gonna be earth at you know source                                 IDs are gonna be in such an order that                                 like you can kind of get the parents                                 ahead of the children but if not that                                 that the the create stub it doesn't have                                 to be a different migration it can be it                                 can kind of be in itself that's sort of                                 what the taxonomy terms do because for                                 the hierarchical ones you you know you                                 can kind of get these these orders where                                 the parent doesn't exist yet but the                                 child is kind of pointing to it and you                                 want to know what the new ideas so                                 that's that's exactly what it would do                                 it goes it and it's gonna create it it's                                 gonna create it with like a empty turn                                 name or whatever and then you know when                                 it finally gets down to it it's gonna go                                 ahead and fill that one out it's gonna                                 it's got the ID already in the map so it                                 knows okay here's the one I need to fill                                 out with that information so that makes                                 sense on the first row but then as is                                 the stub implementation smart enough to                                 know that it already created a stub okay                                 yeah cuz it looks in the map when it                                 when it when it first thing it does when                                 it pulls up a record as it goes to look                                 in the map to see if it                                 if it's already been imported and that's                                 how it can do the updates rather than                                 you know duplicating a bunch of records                                 Thanks welcome my use case is to migrate                                 a PHP VB forum into Drupal Commons                                 discussions and my question is to create                                 something on a destination and this is                                 triple                                                                   API or how do you know how to create the                                 record properly I'm guessing that it's                                 not a good idea to just write SQL and                                 write rows to the actual Drupal database                                 right so there's got to be a better way                                 of creating records well so for the                                 destination side for for like a comment                                 there's already a destination for that                                 so it it knows the kind of built in what                                 are they calling like properties on the                                 entity right those fields that are on                                 that base table and then yet the way                                 that the fields are actually implemented                                 there's a destination handler that goes                                 and like looks up the entity and figures                                 out what fields and then it kind of                                 passes through to the to loading the                                 right field handler so it's kind of a                                 two-step thing right there's the fields                                 that are on the base entity and then                                 there's all those I always want to clump                                 CZK fields but I guess that's you know                                 Drupal fields that then get kind of                                 populated so I think it should be                                 setting those up for you and and that's                                 one of the things where the UI is really                                 handy is it'll show you all the fields                                 that the destination is is listing and                                 so you can kind of basically go through                                 and copy those in and then you know go                                 look at the destination tab and go copy                                 and paste and then kind of match them up                                 that way and you know turns out I                                 probably would have had time to to show                                 some of that I mean I guess we could                                 probably go into that if you know if we                                 get through the questions that people                                 still want to see some stuff thank you                                 my questions really do performance and                                 like based on your experience using this                                 module like what's the kind of a good                                 number before things timeout on running                                 this process like if you have like                                 million customers which we want to                                 import from one system into Drupal can                                 we use this and if we can can we go in                                 one go or do we have to like schedule it                                 for light and sorry and related to that                                 the second question is if for example it                                 breaks in the middle like when we're                                 importing does it rollback everything I                                 am or then this is this this it might                                 actually be worth kind of showing it so                                 there's the two ways that you can do it                                 through the UI it uses the bad shape II                                 I which is slower but just if you're                                 familiar with ripples API it kind of                                 runs for a second stops runs for a                                 second stop so that you avoid the PHP                                 time limit the drush mode just                                 effectively disables the time limit and                                 well actually I think it's got some kind                                 of trickiness so it kind of spawns sub                                 processes to avoid that but basically it                                 you don't you don't have to worry about                                 timeouts with it but if if you stop it                                 in the middle because it keeps track of                                 everything in the migration map it knows                                 what's already been imported so then                                 it'll just kind of scan through the                                 records until it finds one that hasn't                                 been aborted and then carry on from                                 there so you should be able to you know                                 resume it with without any problems but                                 in the middle of the migration if there                                 is an error which happens or something                                 does it rollback know it well if if the                                 record gets created the record got                                 created on the destination side and in                                 some cases that'll be sitting there just                                 spewing errors and you know depending on                                 what you've got going on in your code it                                 might just be spewing errors and like                                 you know so fields are not getting set                                 up right but nodes are getting created                                 but you know and so then you control see                                 stop it and it's those nodes are still                                 going to be there it's not gonna not                                 going to do that you can you can                                 manually roll those back and have those                                 deleted or you could rerun the                                 the migration and there's a there's an                                 upgrade or update flag you can specify                                 to have it update the records that are                                 already on the on the on the site so                                 that's an easy way to kind of resolve                                 some of those you know if you have if                                 you have a bug in your migration that's                                 how you can kind of fix that this this                                 module provides some kind of logging                                 that we can check that what's completed                                 what's not you know let me just let me                                 hop out of here and go let's pull up                                 yeah because it does it does log okay                                 let me oh you know I'm gonna have to do                                 I'm gonna have to switch the have to                                 because otherwise I'm not gonna be able                                 to see the thing while you're seeing it                                 okay                                 all right so here's our Drupal                                        and so the my great UI lives in a tab on                                 the content page and it'll list out all                                 of the migrations it knows about show                                 the amount of you know rows they've got                                 what the kind of status is and it'll try                                 to track the throughput and when the                                 migration was last run and then you can                                 go kind of click into one of them and                                 get a little bit more detail I think                                 there's a bug in here that I had I                                 noticed earlier but didn't really want                                 to try to trick down so to list the                                 overview it actually has some kind of                                 abilities to kind of track sort of                                 metadata about the migration you can                                 kind of associate people with it I found                                 that kind of maybe be a little bit more                                 trouble than it was working it worth but                                 I guess it depends on your organization                                 and then you know you can kind of look                                 at the destination so if we like let's                                 just go and like run a couple of these                                 and then just you kind of see the you                                 don't see what see what this after you                                 know there's there's there's here's the                                 list of operations it supports you can                                 do an import you could do a rollback you                                 can stop a migration it's in progress or                                 and so sometimes like if it they'll                                 they'll get kind of wedged and then you                                 can reset it                                 but here's sort of the here's what                                 become the battery API looks like and so                                 it'll tell you you know what got created                                 and then inside the migration there's                                 where do the log stuff live Mike within                                 our log tab                                 yeah                                 okay so where am i I'm totally missing                                 this oh yeah okay right so here's the so                                 here's where the message you can see                                  kind of like so this was probably thrown                                  as a warning and so those that's what                                  those will get logged yeah what a next                                  question I guess how do you deal with                                  attachments like images or other                                  uploaded files kind of a pain                                  the that's actually one of the kind of                                  the drivers of the sub of that kind of                                  fixing the arguments thing because that                                  that little example that I'd showed in                                  that one slide was sort of doing an                                  image field so where you give it a path                                  and you give it that kind of stuff it                                  works but there's definitely some kind                                  of issues with it                                  what I would sort of say for is look in                                  the beer and wine they both have samples                                  for dealing with files but it does kind                                  of suck                                  so you mentioned that this wasn't really                                  easy to do for taking content from one                                  Drupal site into another Drupal site and                                  that's actually my use cases migrating                                  an old broken site into a new rewrite                                  and awesome site so other ways to make                                  that an easier transition or is there                                  something other than migrated that you                                  would suggest trying to use well there's                                  some new stuff that do you want to just                                  talk about that Mikey do want to talk                                  about the D to D because one of the                                  things that's getting probably just                                  grabbed one of the Mike's one of the                                  things that that's kind of coming up in                                  in Drupal                                                               to do the major version migrations and                                  using my grade instead and and so you've                                  been working on some kind of like stuff                                  there is an experimental module migrate                                  D to D for doing drupal the drupal                                  migrations it's in my sandbox so it's a                                  little bit hidden but if you go to my                                  profile find me mike ryan on drupal.org                                  under my projects you find my sandbox                                  and right now it works for your basic                                  Drupal                                                                   are contributing triple                                                and it's early but it I've just used it                                  successfully on a client project ok I've                                  done some kind of like nasty things                                  where we had one that we sort of had to                                  keep the site up and running so I ended                                  up kind of writing this custom web                                  service module to just export them all                                  as Jason because I found it a lot easier                                  to have Drupal tell me what fields were                                  on there rather than trying to join                                  everything manually and just then I had                                  the code kind of flatten that it wasn't                                  great enough that I really want to                                  release but yeah and then you kind of                                  have two problems you've got that you                                  get to deal with the Jason trying to                                  talk to it so I am excited to have an                                  excuse to try out Mike's project                                  I I have a source that I'm migrating to                                  to different type of nodes to different                                  content types                                  so I'm running it through the prepare                                  row so I can return false and having two                                  separate migrations is that the best way                                  to do that or what's it stored in is it                                  a sequel table or is it like a CSV file                                  or something oh so they're coming from                                  is the source is a sequel table I would                                  probably try to do to restrict that                                  using a where clause on the sequel query                                  because then you avoid then the counts                                  are going to show up right yeah okay I                                  think that would be the best and then                                  you you know then you show the counts                                  because otherwise you'll see all those                                  numbers skipped because it'll in the                                  logging it reports and then it keeps                                  skipping the ones that it and so it's                                  going to slow it down because it                                  actually loads all those records hands                                  it to your migration and then you say no                                  thanks and then it goes to the next one                                  but you would still do two separate                                  migrations because you have to declare                                  the content type in the yes you because                                  they have mostly the same fields would                                  there be an option to in the prepare to                                  change the node type what I would do is                                  do a do one if it's basically the same                                  fields then I would do a just do a                                  subclass of the migration and then you                                  could say specify everything but the you                                  know you could just you could just have                                  separate queries and then pass those                                  into the source separately like you                                  could have the base thing where you set                                  up all the the fields and whatnot and                                  then in your subclass you don't make you                                  change you'd be the source but                                  definitely two different two separate                                  migrations yeah yeah yeah                                  this is kind of a follow-up question                                  it's interesting a couple people have                                  already kind of touched on this it's                                  something that I was wondering about                                  myself and so you mentioned that Drupal                                  to Drupal maybe isn't the best right now                                  but then Mike was saying but there is                                  something in the works that maybe they                                  would take six to seven or like five to                                  seven and so I'm wondering if is there                                  any discussion                                  like with Drupal core in terms of like                                  the way that like d                                                     would be built so that maybe we can have                                  like better integration so that like one                                  person was saying so like if we had our                                  Drupal                                                                   the certain ways that things weren't                                  feel double entities so we built the                                  site in a certain way that now that                                  seven allows you to have the field about                                  entities is there any kind of discussion                                  going on and the Drupal community now                                  about building Drupal in a way that it's                                  going to be able to then plug-in cleanly                                  to using something like my grade because                                  that's what it seems to me like as well                                  as like if you can take a WordPress site                                  into a Drupal site why can't we take a                                  Drupal site into a Drupal site and go it                                  just avoid this whole pain of trying to                                  say well I'm on Drupal whatever and then                                  I've got to get to the next and the next                                  and the next why can't I think that's                                  exactly the conversation that that's                                  kind of starting and you know and the                                  kind of difference between the WordPress                                  one is it's oh you know you've got a lot                                  it's sort of the same reason it's easier                                  to do themes in WordPress right there's                                  just a lot less you know dumb stuff you                                  can do to kind of configure it in                                  strange ways                                  whereas in Drupal you know you give you                                  all sorts of rope to you know hang                                  yourself and you know you get you can                                  put                                                                       you know I did one migration where they                                  had you know literally dozens of content                                  types and then like hundreds of fields                                  and that was the one that I did that                                  Jason thing on because it was like                                  there's no way I'm gonna do all these                                  you know queries to or figure out how to                                  do the the sequel queries to do that so                                  I think that's definitely part of the                                  conversation is figuring out how you                                  build sources in such a way that you                                  know and the nice thing is if it's                                  locked to a to a version right you can                                  say okay here's what C CK on d                                        like and so it can go do the                                  introspection in the tables figure out                                  how to do all the joins and then kind of                                  just build that for you                                  versus like right now we're you know the                                  you know the d                                                          know what a d                                                             know it's just that that first passed                                  the firt that kind of the first thing                                  that's easy to do is get all the sequel                                  stuff and then the kind of you know                                  building that layer on top of it and so                                  I think we've got you know some kind of                                  like good building blocks and then it's                                  exactly what you're talking about like                                  how do you start setting it up so that                                  you know Drupal seven knows how to you                                  know hand itself off yeah well because                                  I'm thinking nine main what's done is                                  done in the past five was built it was                                  built six was built something but I I'm                                  wondering like going forward here if                                  that's kind of like the thought                                  processes so that I'm not saying that we                                  should be able to take a troop of five                                  site to a Drupal                                                       with eight or like or nine isn't that                                  it's kind of be built into Drupal itself                                  that like this whole upgrade process of                                  getting from eight to nine for instance                                  or from eight to ten or from nine to ten                                  will just be an easier thing for us so                                  that we aren't kind of caught in the                                  situation of when we're building a site                                  for somebody and thinking like oh god                                  you know what that's kind of more what                                  I'm after is like looking forward to the                                  future here if we're gonna maybe have a                                  just sort of a more natural kind of                                  plug-and-play way that Drupal itself is                                  aware of the migrate module so it's just                                  like it's much more of a snap to get                                  from there is a core issue to put                                  something based on the migrate API into                                  core for Drupal                                                          out there and tomorrow one o'clock I'm                                  hosting a bath to talk about that I                                  think it's room                                                   interested in that drop I thank you yes                                  the one thing I would kind of add to                                  that is that you don't necessarily know                                  you're going to be so it's sort of hard                                  to future-proof because you know                                       should be enough right                                  my keys case is that I'm using the                                  address field module with three                                  addresses a specific number and so the                                  csv file that i have has three address                                  three different sets of fields one for                                  each address so and that gets that would                                  be using the geo coder module as well to                                  query Google and geo code that I'm                                  wondering at that if you know if you've                                  had experience doing that type of thing                                  actually grow the status of a field                                  handler for the address fields and                                  that's kind of where I realized that our                                  argument things totally busted                                  because what it does is it you for the                                  for the field you specify the country                                  code and then you pass everything else                                  through the arguments and it's kind of                                  tedious but if you look at my great                                  micro textures in I think it's in the                                  two three version it's the one that just                                  just recently came out so that might                                  have been why you missed it because this                                  is on my plate this week so oh yeah it                                  it it's a little tedious to set up but                                  it'll definitely do it and yet you so                                  you just kind of key all the arguments                                  based off of I forget what they're it's                                  actually pretty well documented sorry I                                  would say I would say pull that up and                                  give it a look as it should it should                                  address that pretty well there's fun any                                  any other questions do you guys want me                                  to poke around in to rush because I                                  think we've got easier question and back                                  to your original slide                                  steep learning curve our migration I                                  believe is much simpler not ten thousand                                  entities coming out of another database                                  into XML and then into Drupal it would                                  seem that there might be an easier                                  approach I think we got a one-to-one                                  match can you comment on that because it                                  seems that the learning curve to get to                                  use migrate this migration it's gonna be                                  pretty difficult here what else you                                  looking at using                                  I'm guessing feeds I mean how BIG's the                                  XML file excuse me do you know how big                                  the XML file is is it a single file or                                  is it well they're about they're about                                                                                                     because like                                                         entry and about                                                                                                                                  I mean I had one where it was trying to                                  do a                                                                 think feeds is gonna be happy with that                                  because it because the problem with so                                  one of the things that we ended up                                  building in I think the recent version                                  of migrate is once you get the big XML                                  files like that it's hard to because PHP                                  runs out of memory so I mean you can                                  kind of just pump your memory up really                                  you know - okay whatever gig kind of                                  thing but I think my problem is not as                                  trivial as I was open it was yeah you                                  can do                                  I'm just spacing on                                  so he's suggesting in feeds you can do                                  the background background process it                                  depends on the size because that's                                  that's gonna be the one that cuz like                                  trying to do an XPath queries gets slow                                  too is the other thing like I'm just                                  facing on the name of it there's a                                  there's a way you can do XML files like                                  xxxx whatever basically you don't have                                  to load the whole file it just runs                                  through the tokens and then you can kind                                  of grab subsets of it and then just                                  process those and and depending on the                                  size of the file that might be worth it                                  if it's small enough or if you can chunk                                  it up you know but yeah give it a get a                                  drug feeds if it's a single type then                                  you know if you can get that working                                  yeah anybody else do you guys want to                                  see me poke around with rush a little                                  bit or okay all right so                                  oops that's too small                                  okay so boy this is there is really no                                  worse way to try to type that in front                                  of an audience okay so just to dress                                  help to list out the the kind of the                                  commands so there's this big block of                                  migrate commands right most of them have                                  little aliases I'm just gonna kind of                                  show a couple that so you know drush ms                                   migrate status is kind of you know nice                                  for just sort of seeing where things are                                  at right you can kind of see that okay                                  the term finished user finished and so                                  to run one you can it's a rush mi for                                  migrate import and so it'll go off and                                  you know it tells you when it gets done                                  tells you how many it did you know what                                  you know what worked what didn't and                                  give you kind of a throughput and most                                  of these have you know some kind of                                  switches oh boy that's not really                                  readable so one thing that like a lot of                                  times would be kind of debugging                                  migration and you want to keep kind of                                  running the same record so what what                                  I'll find myself doing is doing an                                  update because that'll rerun the                                  migration and update the records and                                  then you can specify a limit this I hate                                  you have I think it got fixed but you                                  have to sew one item                                  okay so now you can just type                                             so so it'll just keep running that same                                  one record so if it's kicking out a                                  bunch of warnings you know that's kind                                  of Handy I wonder if I can get something                                  that's gonna take long enough that I can                                  cancel it you could stick a weight in                                  there or something like that but do you                                  that's low right                                  we'll just do - - all which will just                                  grind through all the imports that it                                  has so you can see it's gonna kind of                                  look at the ones that are already done                                  it'll just work its way down the list                                  did we hit baseball there okay so we got                                  something going slow so you know I'm                                  like hey I don't know what's going on                                  here let's just kill it and then we can                                  do you know drushyam ass and it'll show                                  us okay so oh it thinks it's still                                  importing right well it's not important                                  because I hit control-c so we're gonna                                  go copy that                                  thrush mrs thrush mrs. Josh migrate                                  reset or something I don't know some of                                  those you just kind of memorize and so                                  then a no for the status you can                                  actually specify a migration status so                                  you don't have to pick through the whole                                  list so okay it was going along it got                                  kind of stuck and and that's sort of how                                  you'd reset that when they when they                                  fall over what else oh my what's what's                                  oh yeah let's do rollback so so we just                                  oh Mr yeah just rush mister they're both                                  Stern Stern folks one resets and the                                  other deletes so yeah it's gonna sit                                  there and you know kind of grind along                                  and then when it gets done it'll tell us                                  you know how long it took to delete all                                  that stuff I can't let it run a little                                  too long I think yeah so you know it'll                                  it'll tell you kind of what what it did                                  any other questions everybody happy I                                  think like said there's another                                  migration session in here directly after                                  this so you know stick around if you've                                  been having fun
YouTube URL: https://www.youtube.com/watch?v=3fG4wBvLrOI


