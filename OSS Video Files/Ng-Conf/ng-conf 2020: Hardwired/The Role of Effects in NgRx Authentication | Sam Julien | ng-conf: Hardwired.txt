Title: The Role of Effects in NgRx Authentication | Sam Julien | ng-conf: Hardwired
Publication date: 2020-09-17
Playlist: ng-conf 2020: Hardwired
Description: 
	Get your free ticket to EnterpriseNG conference Keynote: https://ng-conf.org

Building token authentication into an NgRx application can be overwhelming and confusing. Authentication is already a big, scary subject and so is NgRx. When you put them together, things get confusing fast. In this talk, we’ll do a comparison of how authentication in a vanilla Angular app differs from auth in an NgRx app. We’ll then see how the central nervous system of authentication shifts from a service in regular Angular to Effects in NgRx.

This talk will be practical and code-driven, leaving you equipped to tackle adding this feature to your NgRx application at work on Monday. You’ll learn how Effects can handle loading authentication state, navigate users to protected routes, and process tokens received from an identity provider. By the end, you’ll feel way better about tackling auth in NgRx!
Watch all the ng-conf: Hardwired presentations/videos at https://videos.ng-conf.org

ng-conf is a three-day Angular conference focused on delivering the highest quality training in the Angular JavaScript framework. 1500+ developers from across the globe converge on Salt Lake City, UT every year to attend talks and workshops by the Angular team and community experts.

ng-conf: Hardwired is brought to you by:
- https://thinkster.io/ The best Angular and JavaScript tutorials on the web
- https://herodevs.com/ Engineering and consulting by web development experts
- https://xlts.dev/  Extended support for AngularJS

Follow us on twitter https://twitter.com/ngconf
Official Website: https://www.ng-conf.org/
Captions: 
	00:00:00,180 --> 00:00:02,970
[Music]

00:00:02,400 --> 00:00:16,630
[Applause]

00:00:02,970 --> 00:00:16,630
[Music]

00:00:17,600 --> 00:00:20,880
all right

00:00:18,320 --> 00:00:22,960
uh before i begin i want to give a quick

00:00:20,880 --> 00:00:24,240
shout out to my friend kim mida we were

00:00:22,960 --> 00:00:25,039
originally going to be doing a joint

00:00:24,240 --> 00:00:26,960
talk

00:00:25,039 --> 00:00:28,240
at this conference and she had some some

00:00:26,960 --> 00:00:30,160
issues come up and

00:00:28,240 --> 00:00:31,599
uh so i just want to give her a quick

00:00:30,160 --> 00:00:34,000
shout out i hope she's doing well

00:00:31,599 --> 00:00:35,360
and i hope my slides live up to her

00:00:34,000 --> 00:00:37,280
expectations

00:00:35,360 --> 00:00:38,480
so we're going to be talking about the

00:00:37,280 --> 00:00:42,800
role of effects

00:00:38,480 --> 00:00:45,920
in ngrx authentication and

00:00:42,800 --> 00:00:47,280
i love to teach ngrx i love ngrx in

00:00:45,920 --> 00:00:49,280
general it's one of my favorite

00:00:47,280 --> 00:00:50,960
technologies right now and i love

00:00:49,280 --> 00:00:51,520
teaching about it i think it's because

00:00:50,960 --> 00:00:54,160
it's

00:00:51,520 --> 00:00:55,199
complex abstract concepts and so i love

00:00:54,160 --> 00:00:56,960
breaking that down

00:00:55,199 --> 00:00:58,480
and making it understandable to

00:00:56,960 --> 00:01:01,440
newcomers and

00:00:58,480 --> 00:01:02,079
junior developers but what a lot of us

00:01:01,440 --> 00:01:05,280
have found

00:01:02,079 --> 00:01:08,159
in the ngrx ecosystem is that

00:01:05,280 --> 00:01:08,720
effects are one of the hardest parts of

00:01:08,159 --> 00:01:12,560
learning

00:01:08,720 --> 00:01:14,720
ngrx i know it was for me and i think

00:01:12,560 --> 00:01:16,960
part of that is because while on the one

00:01:14,720 --> 00:01:19,920
hand effects are really powerful

00:01:16,960 --> 00:01:22,000
and can do a lot of things they're

00:01:19,920 --> 00:01:22,320
really abstract they're not as concrete

00:01:22,000 --> 00:01:24,000
as

00:01:22,320 --> 00:01:25,759
actions or reducers there's something

00:01:24,000 --> 00:01:27,680
about

00:01:25,759 --> 00:01:30,000
actions just dispatching a payload to

00:01:27,680 --> 00:01:32,159
the reducer to update state that

00:01:30,000 --> 00:01:34,479
i think people get a lot faster than

00:01:32,159 --> 00:01:36,640
getting effects

00:01:34,479 --> 00:01:38,400
so in addition to loving ngrx and

00:01:36,640 --> 00:01:41,680
teaching about ngrx

00:01:38,400 --> 00:01:43,200
i also love auth which makes sense

00:01:41,680 --> 00:01:45,600
given that i work for an identity

00:01:43,200 --> 00:01:46,320
company and over the last year i've been

00:01:45,600 --> 00:01:48,240
giving this

00:01:46,320 --> 00:01:49,759
talk on demystifying token

00:01:48,240 --> 00:01:52,159
authentication and

00:01:49,759 --> 00:01:53,360
consistently i've found that it turns

00:01:52,159 --> 00:01:55,280
out that effects

00:01:53,360 --> 00:01:56,640
are really the cornerstone of the whole

00:01:55,280 --> 00:01:59,920
auth process

00:01:56,640 --> 00:02:00,799
in ngrx so it doesn't take a rocket

00:01:59,920 --> 00:02:03,920
scientist

00:02:00,799 --> 00:02:06,000
to put that together right the that

00:02:03,920 --> 00:02:06,880
effects are the hardest part of learning

00:02:06,000 --> 00:02:08,879
ngrx

00:02:06,880 --> 00:02:10,080
but they're also the biggest part of the

00:02:08,879 --> 00:02:13,040
auth process

00:02:10,080 --> 00:02:15,680
in ngrx and that combination is enough

00:02:13,040 --> 00:02:18,319
to induce a mild panic attack

00:02:15,680 --> 00:02:20,160
so in this talk my goal is to turn you

00:02:18,319 --> 00:02:23,280
from mild panic attack

00:02:20,160 --> 00:02:25,440
to sigh of relief as i teach you some

00:02:23,280 --> 00:02:26,480
uh ways to overcome some common

00:02:25,440 --> 00:02:28,800
struggles with

00:02:26,480 --> 00:02:30,319
effects in ngrx and especially in

00:02:28,800 --> 00:02:31,599
authentication

00:02:30,319 --> 00:02:33,760
so what we're going to do in this talk

00:02:31,599 --> 00:02:35,440
we're going to cover some

00:02:33,760 --> 00:02:37,680
general concepts about effects and how

00:02:35,440 --> 00:02:39,120
they're the dj of ngrx

00:02:37,680 --> 00:02:41,360
we're going to talk about common

00:02:39,120 --> 00:02:43,040
struggles people have with effects

00:02:41,360 --> 00:02:44,480
and then we're going to look at effects

00:02:43,040 --> 00:02:46,560
in the login flow

00:02:44,480 --> 00:02:49,360
and how you can overcome those struggles

00:02:46,560 --> 00:02:52,239
that everyone faces there

00:02:49,360 --> 00:02:52,560
so frosty mentioned i'm sam julene i am

00:02:52,239 --> 00:02:55,519
a

00:02:52,560 --> 00:02:57,519
developer advocate for authxero we're a

00:02:55,519 --> 00:02:58,800
identity and access management company

00:02:57,519 --> 00:03:00,959
for developers

00:02:58,800 --> 00:03:02,400
i'm also a google developer expert and

00:03:00,959 --> 00:03:03,959
angular collaborator

00:03:02,400 --> 00:03:06,159
i created the course upgrading

00:03:03,959 --> 00:03:06,560
angularjs.com and i'm an instructor for

00:03:06,159 --> 00:03:09,599
both

00:03:06,560 --> 00:03:11,120
thinkster and egghead so

00:03:09,599 --> 00:03:13,599
let's start by just talking about

00:03:11,120 --> 00:03:17,360
effects in general and we'll do a quick

00:03:13,599 --> 00:03:20,640
architecture review to get that started

00:03:17,360 --> 00:03:22,640
so in vanilla angular we typically have

00:03:20,640 --> 00:03:24,080
services and components and they

00:03:22,640 --> 00:03:27,360
interact with each other

00:03:24,080 --> 00:03:29,920
in both directions but in ngrx

00:03:27,360 --> 00:03:31,200
we don't really do that right instead

00:03:29,920 --> 00:03:32,560
instead of having services and

00:03:31,200 --> 00:03:33,040
components that are interacting with

00:03:32,560 --> 00:03:36,480
each other

00:03:33,040 --> 00:03:39,120
directly we break apart our architecture

00:03:36,480 --> 00:03:41,200
so that our app state is updated by

00:03:39,120 --> 00:03:43,360
dispatching actions to reducers

00:03:41,200 --> 00:03:45,840
and then components read that state

00:03:43,360 --> 00:03:48,080
through selectors

00:03:45,840 --> 00:03:50,080
effects also listen for actions and

00:03:48,080 --> 00:03:53,120
handle side effects

00:03:50,080 --> 00:03:55,200
effects do a lot of things and i think

00:03:53,120 --> 00:03:57,519
what most people think of is what that

00:03:55,200 --> 00:03:58,720
effects decide when to call services and

00:03:57,519 --> 00:04:00,959
they communicate with

00:03:58,720 --> 00:04:02,000
apis that tends to be where people start

00:04:00,959 --> 00:04:04,159
to get

00:04:02,000 --> 00:04:05,439
effects they start to realize oh i need

00:04:04,159 --> 00:04:08,480
to call an api

00:04:05,439 --> 00:04:09,040
so i must use an effect here but effects

00:04:08,480 --> 00:04:10,959
can do

00:04:09,040 --> 00:04:12,480
one more thing which is handle control

00:04:10,959 --> 00:04:14,159
flow logic and this is where i think

00:04:12,480 --> 00:04:16,880
people start to get tripped up

00:04:14,159 --> 00:04:18,959
what do i mean by handling control flow

00:04:16,880 --> 00:04:21,919
logic that's kind of a

00:04:18,959 --> 00:04:22,560
jargon jargony phrase there well what

00:04:21,919 --> 00:04:25,199
that means

00:04:22,560 --> 00:04:26,720
is that effects function as a task

00:04:25,199 --> 00:04:29,840
runner

00:04:26,720 --> 00:04:31,919
effects are the brain of ngrx mike and

00:04:29,840 --> 00:04:35,040
brandon say that effects are the meat

00:04:31,919 --> 00:04:37,759
of the ngrx lasagna i like to say that

00:04:35,040 --> 00:04:38,160
effects are the dj of the ngrx dance

00:04:37,759 --> 00:04:39,600
floor

00:04:38,160 --> 00:04:41,440
they make sure everything everyone's

00:04:39,600 --> 00:04:42,560
having a good time and the music is

00:04:41,440 --> 00:04:44,560
playing in the right order and

00:04:42,560 --> 00:04:47,840
everything's going well

00:04:44,560 --> 00:04:49,840
but working with the facts isn't always

00:04:47,840 --> 00:04:51,759
a bowl of cherries

00:04:49,840 --> 00:04:53,280
and there are few things that people

00:04:51,759 --> 00:04:56,320
really tend to struggle with

00:04:53,280 --> 00:04:59,040
three in particular the first is

00:04:56,320 --> 00:05:00,400
actions that only trigger effects now

00:04:59,040 --> 00:05:03,199
what do i mean by that this is

00:05:00,400 --> 00:05:03,840
actions that don't touch the reducer to

00:05:03,199 --> 00:05:06,960
modify

00:05:03,840 --> 00:05:09,600
state the second is

00:05:06,960 --> 00:05:10,080
non-dispatching effects these are

00:05:09,600 --> 00:05:13,199
effects

00:05:10,080 --> 00:05:14,000
that don't return an action and then the

00:05:13,199 --> 00:05:17,280
third one

00:05:14,000 --> 00:05:17,919
is complex effects so complex effects

00:05:17,280 --> 00:05:19,520
this is when

00:05:17,919 --> 00:05:21,840
you run into a scenario where you're

00:05:19,520 --> 00:05:25,120
trying to handle multiple side effects

00:05:21,840 --> 00:05:27,919
at once it turns out

00:05:25,120 --> 00:05:29,120
when you're implementing auth in ngrx

00:05:27,919 --> 00:05:31,600
you come across

00:05:29,120 --> 00:05:33,440
all of these problems do we have actions

00:05:31,600 --> 00:05:36,000
that only trigger effects in auth

00:05:33,440 --> 00:05:36,960
we sure do how about non-dispatching

00:05:36,000 --> 00:05:40,160
effects

00:05:36,960 --> 00:05:42,800
yep and what about complex effects

00:05:40,160 --> 00:05:43,440
yep we've got some of those too so let's

00:05:42,800 --> 00:05:46,080
look at

00:05:43,440 --> 00:05:47,360
effects in the login flow and we'll see

00:05:46,080 --> 00:05:48,800
how we can overcome each of these

00:05:47,360 --> 00:05:52,080
struggles

00:05:48,800 --> 00:05:52,720
before we get to auth and ngrx let's

00:05:52,080 --> 00:05:55,280
just look at

00:05:52,720 --> 00:05:56,880
auth in general just to get an idea of

00:05:55,280 --> 00:05:58,720
the flow that we're working with

00:05:56,880 --> 00:06:00,880
what we're going to talk about here is

00:05:58,720 --> 00:06:02,240
just the the basic login process so you

00:06:00,880 --> 00:06:04,000
kick off the login by

00:06:02,240 --> 00:06:05,919
usually clicking a button or something

00:06:04,000 --> 00:06:08,160
you get sent over to some sort of

00:06:05,919 --> 00:06:10,400
identity provider where you log in

00:06:08,160 --> 00:06:11,840
and then that provider sends you back to

00:06:10,400 --> 00:06:13,280
the application

00:06:11,840 --> 00:06:14,960
the application then needs to handle

00:06:13,280 --> 00:06:15,440
that redirect usually you've got some

00:06:14,960 --> 00:06:18,400
sort of

00:06:15,440 --> 00:06:20,240
auth sdk or something that goes out and

00:06:18,400 --> 00:06:22,080
exchanges a code for a token

00:06:20,240 --> 00:06:24,880
and brings back a success or error

00:06:22,080 --> 00:06:26,160
message inside of that success is where

00:06:24,880 --> 00:06:28,400
we'll usually have our

00:06:26,160 --> 00:06:30,960
user and token and then we'll get some

00:06:28,400 --> 00:06:32,840
sort of url usually we need to send our

00:06:30,960 --> 00:06:34,319
user to another part of the app that's

00:06:32,840 --> 00:06:36,319
protected

00:06:34,319 --> 00:06:38,560
now in vanilla angular what we typically

00:06:36,319 --> 00:06:40,960
do here is we throw everything

00:06:38,560 --> 00:06:42,800
into an auth service so this auth

00:06:40,960 --> 00:06:45,199
service does a bunch of stuff right

00:06:42,800 --> 00:06:48,240
it stores the token and user in memory

00:06:45,199 --> 00:06:50,720
it interacts with the auth sdk and it

00:06:48,240 --> 00:06:52,639
handles all of the redirect logic for us

00:06:50,720 --> 00:06:54,479
and then that auth service interacts

00:06:52,639 --> 00:06:57,360
directly with the components

00:06:54,479 --> 00:06:58,960
and also interacts with data services

00:06:57,360 --> 00:07:01,680
usually we need to

00:06:58,960 --> 00:07:03,599
add the token to an outgoing request so

00:07:01,680 --> 00:07:04,720
that we can hit like a protected api or

00:07:03,599 --> 00:07:06,960
something

00:07:04,720 --> 00:07:08,000
but this isn't how we do it in ngrx

00:07:06,960 --> 00:07:10,400
instead of having

00:07:08,000 --> 00:07:12,160
an auth service with data services and

00:07:10,400 --> 00:07:14,319
components interacting together

00:07:12,160 --> 00:07:15,199
we have this distributed architecture

00:07:14,319 --> 00:07:18,479
right where

00:07:15,199 --> 00:07:21,440
our auth service becomes this thin layer

00:07:18,479 --> 00:07:23,199
around our sdk alongside of our effects

00:07:21,440 --> 00:07:25,520
and the rest of those responsibilities

00:07:23,199 --> 00:07:27,680
get spread out between effects selectors

00:07:25,520 --> 00:07:29,199
and reducers

00:07:27,680 --> 00:07:31,599
so now what i want to do is look at that

00:07:29,199 --> 00:07:33,840
flow again from the standpoint of

00:07:31,599 --> 00:07:35,120
ngrx and i have a little bit of a

00:07:33,840 --> 00:07:36,800
challenge here for you

00:07:35,120 --> 00:07:38,319
when we go through this again i want you

00:07:36,800 --> 00:07:41,120
to think about which

00:07:38,319 --> 00:07:42,240
parts of the off flow directly change

00:07:41,120 --> 00:07:44,960
state

00:07:42,240 --> 00:07:46,400
so we kick off our login process we get

00:07:44,960 --> 00:07:48,479
sent over to the provider

00:07:46,400 --> 00:07:49,520
we get sent back to the app to handle

00:07:48,479 --> 00:07:52,160
the redirect

00:07:49,520 --> 00:07:53,120
and then we process the successor error

00:07:52,160 --> 00:07:55,759
and we pull out

00:07:53,120 --> 00:07:57,520
our user and our token and then send the

00:07:55,759 --> 00:07:59,680
user on their merry way

00:07:57,520 --> 00:08:01,440
now which parts of that actually update

00:07:59,680 --> 00:08:03,599
state in the application

00:08:01,440 --> 00:08:05,440
well it's actually only this part where

00:08:03,599 --> 00:08:07,440
we get the user and the token

00:08:05,440 --> 00:08:09,039
these are the only things i mean you may

00:08:07,440 --> 00:08:09,520
store more than this but these are the

00:08:09,039 --> 00:08:11,039
only

00:08:09,520 --> 00:08:13,039
this is the only part that we're going

00:08:11,039 --> 00:08:15,840
to actually put in our store

00:08:13,039 --> 00:08:16,560
in our state everything else in this

00:08:15,840 --> 00:08:18,560
process

00:08:16,560 --> 00:08:19,840
is a side effect which means that

00:08:18,560 --> 00:08:22,400
everything else needs

00:08:19,840 --> 00:08:22,960
effects so let's break this into two

00:08:22,400 --> 00:08:26,160
pieces

00:08:22,960 --> 00:08:27,440
first let's zoom in on the just starting

00:08:26,160 --> 00:08:30,639
the login process

00:08:27,440 --> 00:08:32,640
and getting sent over to the provider

00:08:30,639 --> 00:08:34,159
we have a probably an instinct to go

00:08:32,640 --> 00:08:34,479
ahead and create an action because we

00:08:34,159 --> 00:08:36,000
know

00:08:34,479 --> 00:08:38,000
somehow we've got to kick off this

00:08:36,000 --> 00:08:38,880
process so we can we create a login

00:08:38,000 --> 00:08:41,760
action

00:08:38,880 --> 00:08:43,599
and then you're probably thinking okay i

00:08:41,760 --> 00:08:43,919
know i need to call the auth service to

00:08:43,599 --> 00:08:46,080
log

00:08:43,919 --> 00:08:47,519
in so i must need an effect for that so

00:08:46,080 --> 00:08:50,080
that's a good instinct

00:08:47,519 --> 00:08:51,279
so we create a login effect and that

00:08:50,080 --> 00:08:53,120
login effect

00:08:51,279 --> 00:08:54,959
listens for the login action that we've

00:08:53,120 --> 00:08:55,360
created and then we're going to use the

00:08:54,959 --> 00:08:57,279
tap

00:08:55,360 --> 00:08:59,360
operator that's just the operator that's

00:08:57,279 --> 00:09:00,560
used for side effects in rxjs

00:08:59,360 --> 00:09:02,720
and we're going to call the auth

00:09:00,560 --> 00:09:04,720
services login function

00:09:02,720 --> 00:09:06,399
now this login function on the auth

00:09:04,720 --> 00:09:08,800
service let's just zoom in on this and

00:09:06,399 --> 00:09:09,440
see what it's doing so in the auth

00:09:08,800 --> 00:09:12,080
service

00:09:09,440 --> 00:09:12,959
this login function is just wrapping the

00:09:12,080 --> 00:09:15,279
auth client's

00:09:12,959 --> 00:09:16,959
login function whatever sdk you're using

00:09:15,279 --> 00:09:17,760
you'll just sort of use this as a pass

00:09:16,959 --> 00:09:20,560
through

00:09:17,760 --> 00:09:20,880
so then we could go back to the effect

00:09:20,560 --> 00:09:23,920
and

00:09:20,880 --> 00:09:25,920
after we call the login we're not going

00:09:23,920 --> 00:09:27,200
to dispatch a new action here because

00:09:25,920 --> 00:09:29,440
we're just going to be sent off

00:09:27,200 --> 00:09:30,560
to somewhere else so we need to pass

00:09:29,440 --> 00:09:33,760
this dispatch

00:09:30,560 --> 00:09:36,800
set to false options object

00:09:33,760 --> 00:09:39,120
so right away you can see here just

00:09:36,800 --> 00:09:40,080
just in our first step here we've

00:09:39,120 --> 00:09:42,399
already encountered

00:09:40,080 --> 00:09:43,200
two of people's common struggles with

00:09:42,399 --> 00:09:44,959
effects

00:09:43,200 --> 00:09:46,320
we've already come across actions that

00:09:44,959 --> 00:09:49,440
only trigger effects

00:09:46,320 --> 00:09:50,000
and non-dispatching effects so what can

00:09:49,440 --> 00:09:51,600
we do

00:09:50,000 --> 00:09:53,680
to help us understand this a little bit

00:09:51,600 --> 00:09:56,320
better well this is where it really

00:09:53,680 --> 00:09:59,519
comes in handy to remember that effects

00:09:56,320 --> 00:10:02,079
are a task runner for ngrx they are the

00:09:59,519 --> 00:10:04,959
dj of the ngrx dance floor

00:10:02,079 --> 00:10:06,720
but what do i mean by that well so if

00:10:04,959 --> 00:10:07,519
you tell your dj to play your favorite

00:10:06,720 --> 00:10:09,839
song

00:10:07,519 --> 00:10:11,839
unless the dj just immediately starts

00:10:09,839 --> 00:10:14,480
serenading you on the spot

00:10:11,839 --> 00:10:15,920
nothing happens right away right the dj

00:10:14,480 --> 00:10:18,399
has to do things like

00:10:15,920 --> 00:10:20,399
go grab a record put it on the record

00:10:18,399 --> 00:10:22,800
player and then play the song

00:10:20,399 --> 00:10:24,000
so everything until the song actually

00:10:22,800 --> 00:10:26,160
starts playing

00:10:24,000 --> 00:10:27,600
is just a task that needs to happen it's

00:10:26,160 --> 00:10:29,680
just a side effect

00:10:27,600 --> 00:10:30,720
and we can look at our app and logging

00:10:29,680 --> 00:10:33,760
into our app

00:10:30,720 --> 00:10:34,560
the same way so what do we need to do in

00:10:33,760 --> 00:10:36,320
order to get

00:10:34,560 --> 00:10:38,000
our user and our token well we need to

00:10:36,320 --> 00:10:40,399
call the auth service to log in

00:10:38,000 --> 00:10:42,160
we need to handle this redirect flow and

00:10:40,399 --> 00:10:44,480
then we need to update the store with

00:10:42,160 --> 00:10:47,040
the user and the token

00:10:44,480 --> 00:10:48,800
everything until we do that though is

00:10:47,040 --> 00:10:49,839
just a side effect it's a task that

00:10:48,800 --> 00:10:53,360
needs to happen

00:10:49,839 --> 00:10:55,200
and that's where ngrx can help us

00:10:53,360 --> 00:10:57,760
so let's look at the second half of this

00:10:55,200 --> 00:10:59,200
process so we get sent back to the app

00:10:57,760 --> 00:11:01,600
and we have to handle the redirect we

00:10:59,200 --> 00:11:03,440
got to interact with our auth sdk

00:11:01,600 --> 00:11:04,959
and then we need to process the success

00:11:03,440 --> 00:11:06,800
to get the user in token

00:11:04,959 --> 00:11:08,160
and send the user to wherever we need to

00:11:06,800 --> 00:11:10,480
send them

00:11:08,160 --> 00:11:12,720
so there's a lot happening here we know

00:11:10,480 --> 00:11:14,000
that we do need to do some sort of

00:11:12,720 --> 00:11:16,160
action to kick off this

00:11:14,000 --> 00:11:17,040
part of the process when we get sent

00:11:16,160 --> 00:11:19,839
back to the app

00:11:17,040 --> 00:11:20,800
by the provider so we create an action

00:11:19,839 --> 00:11:22,240
here

00:11:20,800 --> 00:11:24,959
and then we know that we're going to

00:11:22,240 --> 00:11:26,480
need to interact with the sdk and do a

00:11:24,959 --> 00:11:28,800
whole bunch of other stuff

00:11:26,480 --> 00:11:30,880
so hopefully your instinct is starting

00:11:28,800 --> 00:11:33,680
to think that you need an effect here

00:11:30,880 --> 00:11:35,440
so we create a handle redirect effect

00:11:33,680 --> 00:11:36,480
and we listen for the handle redirect

00:11:35,440 --> 00:11:40,240
action

00:11:36,480 --> 00:11:42,720
but then we've got our exhaust map here

00:11:40,240 --> 00:11:45,839
to help us with whatever we need to do

00:11:42,720 --> 00:11:48,399
but what do we actually put inside of it

00:11:45,839 --> 00:11:49,760
well let's take a stab at it well so we

00:11:48,399 --> 00:11:52,399
know we need to call this

00:11:49,760 --> 00:11:53,920
auth services handle redirect function

00:11:52,399 --> 00:11:56,880
this is just an observable

00:11:53,920 --> 00:11:57,360
that works with the sdk to go get your

00:11:56,880 --> 00:12:00,079
token

00:11:57,360 --> 00:12:01,600
and your user and whatever redirect url

00:12:00,079 --> 00:12:03,839
you need

00:12:01,600 --> 00:12:05,360
but then after that what do we need to

00:12:03,839 --> 00:12:06,639
do well we know we need to have some

00:12:05,360 --> 00:12:08,160
sort of success

00:12:06,639 --> 00:12:10,000
that we dispatch and we need to have

00:12:08,160 --> 00:12:11,120
some sort of failure that we dispatch if

00:12:10,000 --> 00:12:12,800
there's an error

00:12:11,120 --> 00:12:15,360
but what about all this stuff in the

00:12:12,800 --> 00:12:17,839
middle somehow we need to go

00:12:15,360 --> 00:12:19,519
set the user in token somewhere and

00:12:17,839 --> 00:12:22,160
somehow we need to navigate

00:12:19,519 --> 00:12:24,320
to the redirect url but do we do that

00:12:22,160 --> 00:12:26,320
here do we do that elsewhere

00:12:24,320 --> 00:12:27,360
seems like a lot and then we need to

00:12:26,320 --> 00:12:28,880
dispatch a success

00:12:27,360 --> 00:12:31,680
action but is that supposed to have a

00:12:28,880 --> 00:12:33,200
payload what do we need to do

00:12:31,680 --> 00:12:34,720
so this is where things start start to

00:12:33,200 --> 00:12:36,399
get really confusing

00:12:34,720 --> 00:12:38,160
and people start to get tripped up i

00:12:36,399 --> 00:12:39,200
know it was tripping me up when i first

00:12:38,160 --> 00:12:41,440
started this

00:12:39,200 --> 00:12:43,200
it turns out here that we've run into a

00:12:41,440 --> 00:12:45,040
complex effect scenario

00:12:43,200 --> 00:12:46,480
where we're trying to do too many things

00:12:45,040 --> 00:12:48,639
in one effect

00:12:46,480 --> 00:12:50,800
so usually that i found in this

00:12:48,639 --> 00:12:52,480
situation if i start to feel like

00:12:50,800 --> 00:12:54,720
i'm getting confused about what to put

00:12:52,480 --> 00:12:56,480
in my effect i've missed something or

00:12:54,720 --> 00:12:59,440
taken something for granted

00:12:56,480 --> 00:12:59,920
so i need to go back back up and try to

00:12:59,440 --> 00:13:02,000
find

00:12:59,920 --> 00:13:02,959
the hidden side effect that i've missed

00:13:02,000 --> 00:13:05,600
along the way

00:13:02,959 --> 00:13:07,600
somehow i've taken something for granted

00:13:05,600 --> 00:13:08,160
so i go back and i look at this flow

00:13:07,600 --> 00:13:10,079
again

00:13:08,160 --> 00:13:11,839
and i realize that calling the auth

00:13:10,079 --> 00:13:14,880
service to handle the redirect

00:13:11,839 --> 00:13:17,760
is already a side effect and then

00:13:14,880 --> 00:13:18,240
we go and uh grab the token and

00:13:17,760 --> 00:13:21,440
everything

00:13:18,240 --> 00:13:23,600
and proceed with the process so

00:13:21,440 --> 00:13:24,880
we need to know how to work through this

00:13:23,600 --> 00:13:27,839
so what i like to do

00:13:24,880 --> 00:13:28,720
is break a complex effect into smaller

00:13:27,839 --> 00:13:30,880
pieces

00:13:28,720 --> 00:13:31,839
and that way we can just let one effect

00:13:30,880 --> 00:13:34,160
handle one

00:13:31,839 --> 00:13:35,920
side effect when i was chatting with

00:13:34,160 --> 00:13:37,920
mike ryan about this talk

00:13:35,920 --> 00:13:39,920
a week ago as i was building it he said

00:13:37,920 --> 00:13:40,880
that if he ever gives a talk on good

00:13:39,920 --> 00:13:42,720
effect hygiene

00:13:40,880 --> 00:13:43,920
this will be one of the tenants let one

00:13:42,720 --> 00:13:45,839
effect handle one

00:13:43,920 --> 00:13:47,120
side effect another thing that really

00:13:45,839 --> 00:13:49,519
helps me is to write

00:13:47,120 --> 00:13:51,680
out the flow so just like we did with

00:13:49,519 --> 00:13:52,880
our dj and our login process we can

00:13:51,680 --> 00:13:54,639
write this part out

00:13:52,880 --> 00:13:56,240
so what do we need to do here we need to

00:13:54,639 --> 00:13:57,040
call the auth service to process

00:13:56,240 --> 00:13:59,680
everything

00:13:57,040 --> 00:14:01,440
we need to update the store and we need

00:13:59,680 --> 00:14:03,600
to redirect the user

00:14:01,440 --> 00:14:04,560
so only one of these is actually

00:14:03,600 --> 00:14:07,680
impacting state

00:14:04,560 --> 00:14:08,800
right so the first and the third are

00:14:07,680 --> 00:14:10,800
side effects

00:14:08,800 --> 00:14:11,920
and updating the store is changing the

00:14:10,800 --> 00:14:14,320
state

00:14:11,920 --> 00:14:15,120
so when we go back to our effect we know

00:14:14,320 --> 00:14:16,880
we need to

00:14:15,120 --> 00:14:18,720
handle the redirect where we're calling

00:14:16,880 --> 00:14:20,959
the auth service and this is already a

00:14:18,720 --> 00:14:23,440
side effect that we're dealing with

00:14:20,959 --> 00:14:24,480
so instead of trying to do everything

00:14:23,440 --> 00:14:27,199
here

00:14:24,480 --> 00:14:28,959
let's refactor this and we'll dispatch a

00:14:27,199 --> 00:14:30,880
success action and this time

00:14:28,959 --> 00:14:32,880
we'll pass along the payload and the

00:14:30,880 --> 00:14:34,800
redirect url

00:14:32,880 --> 00:14:37,680
what this lets us do is go back to the

00:14:34,800 --> 00:14:39,199
reducer and we can add a case for handle

00:14:37,680 --> 00:14:41,440
redirect success

00:14:39,199 --> 00:14:44,320
and here we can just go ahead and update

00:14:41,440 --> 00:14:46,560
the token and the user profile

00:14:44,320 --> 00:14:47,760
and that lets us create a new effect a

00:14:46,560 --> 00:14:50,079
second effect

00:14:47,760 --> 00:14:52,639
for handle redirect success we'll listen

00:14:50,079 --> 00:14:54,480
for that handle redirect success action

00:14:52,639 --> 00:14:56,639
and then we'll use that tap operator

00:14:54,480 --> 00:14:58,880
again to navigate the user to the

00:14:56,639 --> 00:15:01,680
redirect url now notice again

00:14:58,880 --> 00:15:04,399
here we're not dispatching a new action

00:15:01,680 --> 00:15:07,360
so we need to set dispatch to false

00:15:04,399 --> 00:15:08,720
for this effect so now we've

00:15:07,360 --> 00:15:10,320
successfully tackled

00:15:08,720 --> 00:15:13,120
all three of these actions that only

00:15:10,320 --> 00:15:15,760
trigger effects non-dispatching effects

00:15:13,120 --> 00:15:17,440
and writing complex effects so i've hit

00:15:15,760 --> 00:15:18,880
you with a lot let's do a really quick

00:15:17,440 --> 00:15:20,560
review

00:15:18,880 --> 00:15:23,279
so like we said effects are one of the

00:15:20,560 --> 00:15:25,199
hardest parts of learning ngrx

00:15:23,279 --> 00:15:27,680
and it's also a huge part of

00:15:25,199 --> 00:15:30,320
implementing auth in ngrx

00:15:27,680 --> 00:15:31,759
in vanilla angular we tend to have one

00:15:30,320 --> 00:15:33,680
giant auth service

00:15:31,759 --> 00:15:35,199
that interacts with our components and

00:15:33,680 --> 00:15:37,040
our data services

00:15:35,199 --> 00:15:38,399
but in ngrx we have this different

00:15:37,040 --> 00:15:40,240
architecture where

00:15:38,399 --> 00:15:42,000
our auth service just becomes this thin

00:15:40,240 --> 00:15:44,160
wrapper around the sdk

00:15:42,000 --> 00:15:46,000
and the reducers and selectors and

00:15:44,160 --> 00:15:47,759
effects are sort of distributing that

00:15:46,000 --> 00:15:49,759
responsibility

00:15:47,759 --> 00:15:51,839
most people think about effects when it

00:15:49,759 --> 00:15:54,720
comes to calling services and

00:15:51,839 --> 00:15:56,639
apis and that's where people the light

00:15:54,720 --> 00:15:59,040
bulb starts to go on and starts to click

00:15:56,639 --> 00:15:59,920
that they need an effect but people tend

00:15:59,040 --> 00:16:02,959
to forget

00:15:59,920 --> 00:16:04,240
including me that effects also handle

00:16:02,959 --> 00:16:06,639
your control flow logic

00:16:04,240 --> 00:16:08,800
effects are the dj of the ngrx dance

00:16:06,639 --> 00:16:09,920
floor i promise if there's one thing you

00:16:08,800 --> 00:16:12,880
remember from this talk

00:16:09,920 --> 00:16:14,160
that's going to be it so we looked at

00:16:12,880 --> 00:16:16,160
though there are three

00:16:14,160 --> 00:16:17,279
major things that people struggle with

00:16:16,160 --> 00:16:19,680
here and

00:16:17,279 --> 00:16:22,000
it turns out that all of them show up

00:16:19,680 --> 00:16:24,800
when you're implementing auth in an ngrx

00:16:22,000 --> 00:16:26,720
app so we first we found the first two

00:16:24,800 --> 00:16:28,320
just when we try to log into the app

00:16:26,720 --> 00:16:30,240
just clicking the login button

00:16:28,320 --> 00:16:31,839
actually has a lot of complexity behind

00:16:30,240 --> 00:16:36,160
it so

00:16:31,839 --> 00:16:37,839
to break this down and to overcome this

00:16:36,160 --> 00:16:39,600
what you want to do is remember that

00:16:37,839 --> 00:16:41,199
effects function as a task runner and

00:16:39,600 --> 00:16:44,000
try to identify

00:16:41,199 --> 00:16:47,040
where the side effects are and where the

00:16:44,000 --> 00:16:50,320
store is being updated

00:16:47,040 --> 00:16:52,000
and then we found the the complex effect

00:16:50,320 --> 00:16:53,360
at the second part of this process of

00:16:52,000 --> 00:16:55,360
handling the redirect

00:16:53,360 --> 00:16:56,959
getting the user in token and sending

00:16:55,360 --> 00:16:58,720
them to a new place

00:16:56,959 --> 00:17:00,639
so this was a complex effect and when

00:16:58,720 --> 00:17:02,560
you run into complex effects

00:17:00,639 --> 00:17:04,319
there are a few things you can do to

00:17:02,560 --> 00:17:06,079
make your life a little bit easier

00:17:04,319 --> 00:17:07,839
first you want to back up find the

00:17:06,079 --> 00:17:08,640
hidden side effect what have you taken

00:17:07,839 --> 00:17:11,039
for granted

00:17:08,640 --> 00:17:12,959
maybe it's a a call that's being run

00:17:11,039 --> 00:17:15,919
that doesn't actually return anything

00:17:12,959 --> 00:17:17,360
but it has to get run anyway so break

00:17:15,919 --> 00:17:20,000
apart the complex the

00:17:17,360 --> 00:17:21,120
complex effect into smaller pieces so

00:17:20,000 --> 00:17:24,400
that you can only let

00:17:21,120 --> 00:17:26,000
one effect handle one side effect again

00:17:24,400 --> 00:17:26,880
it helps to write this out and just

00:17:26,000 --> 00:17:28,799
figure out

00:17:26,880 --> 00:17:30,640
what things are just tasks and side

00:17:28,799 --> 00:17:33,360
effects and what is actually

00:17:30,640 --> 00:17:35,520
needing to be updated by the reducer in

00:17:33,360 --> 00:17:37,840
the store

00:17:35,520 --> 00:17:38,960
and now hopefully in addition to just

00:17:37,840 --> 00:17:41,760
figuring this out in

00:17:38,960 --> 00:17:43,600
auth when you come across these problems

00:17:41,760 --> 00:17:46,720
with effects in your application

00:17:43,600 --> 00:17:50,240
you'll go from a mild panic attack to

00:17:46,720 --> 00:17:52,080
a sigh of relief one last thing before i

00:17:50,240 --> 00:17:54,480
let you go

00:17:52,080 --> 00:17:55,280
ngrx is planning a conference in

00:17:54,480 --> 00:17:56,880
november

00:17:55,280 --> 00:17:59,039
and i have a discount code for it i'll

00:17:56,880 --> 00:18:00,559
be there kim will be there mike will be

00:17:59,039 --> 00:18:02,880
there a lot of people will be there

00:18:00,559 --> 00:18:03,679
and i hope to see you there in november

00:18:02,880 --> 00:18:06,799
you can find

00:18:03,679 --> 00:18:10,000
that link as well as all of my slides

00:18:06,799 --> 00:18:12,640
are at sam j dot im slash ng comp

00:18:10,000 --> 00:18:14,320
hardwired well they will be in about

00:18:12,640 --> 00:18:17,520
four minutes when i finished uh

00:18:14,320 --> 00:18:18,160
uploading them and uh yeah that's all i

00:18:17,520 --> 00:18:28,250
got

00:18:18,160 --> 00:18:28,740
thank you

00:18:28,250 --> 00:18:32,160
[Applause]

00:18:28,740 --> 00:18:34,240
[Music]

00:18:32,160 --> 00:18:34,240

YouTube URL: https://www.youtube.com/watch?v=SFXaCADPkcE


