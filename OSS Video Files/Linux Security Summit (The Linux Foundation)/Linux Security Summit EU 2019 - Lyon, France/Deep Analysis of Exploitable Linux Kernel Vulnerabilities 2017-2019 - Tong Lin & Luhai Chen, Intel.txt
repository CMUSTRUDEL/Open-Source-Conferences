Title: Deep Analysis of Exploitable Linux Kernel Vulnerabilities 2017-2019 - Tong Lin & Luhai Chen, Intel
Publication date: 2019-11-04
Playlist: Linux Security Summit EU 2019 - Lyon, France
Description: 
	Deep Analysis of Exploitable Linux Kernel Vulnerabilities 2017-2019 - Tong Lin & Luhai Chen, Intel

To improve security, a series of hardening features (such as SMEP/PXN, SMAP/PAN, KASLR, CFI, etc.) were added to Linux kernel. Indeed, these mitigations have reduced the impact of vulnerabilities and made some exploits invalid. However, at the same time, some exploitation techniques which could bypass these existing mitigations are constantly being disclosed.

This talk will first detail the basic Linux kernel privilege escalation techniques, highlighting how these techniques work and how adversaries are using them. Then, some typical exploitable Linux kernel vulnerabilities from 2017 to 2019 will be selected for in-depth analysis. Specifically, the complete exploit chain which includes getting kernel arbitrary R/W and bypassing mitigations will be shown for each case.
Captions: 
	                              hello santolina good morning everyone                               I'm Tony and from India                               glad to see you at night with you here                               and that's for coming to my talk today                               today I'm going to talk about                               exploitable in in Colonel Warren                               Beatty's                                                           first of all before the technical                               discussion I will show you some                                background information about the Linux                                kernel wannabe today I will introduce                                the basic kernel is partition techniques                                nest our key studies I choose to export                                pcs which I've seen her in two minds                                about the PPF world fire bypass and                                another is timer of the risk intention                                and the last part is conclusion I think                                everyone sitting here today are already                                familiar with Linux kernel and is made                                distribution families but for the                                newcomer to the Linux one of the most                                confusing scene is how many                                distributions are the ocean there are                                maybe a would mount true or red hinge                                Enterprise Linux or the Android advanced                                most people are familiar with but there                                are hundreds or others at will and we                                all know these distributions have more                                or less modified the Linux kernel to                                meet their cut memorization is so how                                can we ensure the security of the so                                many distributions seems there are no                                Universal solutions but and the but at                                least we should do is to time leap for                                pulling the patches from the mainline                                kernel and the                                even more widely deployed security                                medication that sounds simple but is not                                actual let's say I wish to quickly                                review Salinas Colonel Warren Beatty's                                trends from                                                             with the CBS                                                            this year CV never is twice the second                                most rector years and the from the below                                                                                                      that the total number of CVS are slowly                                increasing before                                                      and absence number of CV is returned to                                to be normal and stands - and tends to                                be stable                                I also I also summary the CW the Linux                                kernel vulnerability in Subhash - three                                years                                Sita B is coming witness in numeration a                                suitabie is more like categories wife is                                vulnerability come from and each three                                belong to Sita be here at least the top                                six c ee basically CCW types are also                                the common types o exploit                                vulnerabilities for example the sita be                                four one six user for free we shall know                                well has which has a high probability of                                its petition for privilege escalation                                and in this page I list some                                representative Colonel Warren Beatty's                                according to the timeline they are about                                why are true represent you Colonel were                                abilities each year which can be used to                                get a universal root cause is only based                                on my personal opinion                                and it does not include the                                vulnerabilities we are going to talk                                about today also they also see how we                                have been talking about series in our                                previous as live content or what we need                                to emphasize here is an Linux security                                fix and not equal to cv is actually only                                small part of kernel fix God series just                                like Greg said with stable in-kernel                                maintainer as a linear foundation fellow                                he said if you are not using OS diva or                                long-term kernel you have is an insecure                                system finally at the end of the                                overview part I will build some news                                about the falling technical discussion                                the talk is mainly focus on the over or                                Linux kernel is prediction techniques as                                a slated kisses are based on the x                                      arm architecture with Ubuntu or Android                                as target platform and will cause all                                the warranties mission the nest have                                already been public media mitigated and                                fixed so the next part Colonel is                                partition for privilege escalation first                                let's take a look at the definition of                                the privilege escalation described in                                simple sentence than either a user                                received privilege they are not entitled                                to because they are motivated to achieve                                 the privilege escalation in links for                                 example exploiting route services and                                 the weak system configuration and even                                 the past horrible                                 besides if the attacker can also exploit                                 as UID executables or the sudo right at                                 least a three year                                                      seven here because it's just a newly                                 disclosed disclosed us to do a security                                 policy bypass                                 mobility a few days ago finally what I                                 want to introduce is exploiting                                 vulnerabilities is our main topic today                                 too easily under understand the                                 following case studies                                 let's have a look at the common root                                 flow on links the whole flow conceives                                 over two stages the purpose of stage one                                 is to get arbitrary kernel memory right                                 and the stage two is to get privilege                                 escalation of course there are some                                 steps to bypass the related mitigations                                 in the process for one area to exploit                                 they are often different techniques for                                 different one ability type and for the                                 other part like control execution flow                                 and get arbitrary memory right and                                 privilege they are also some general                                 tips I will detail some in nest in s                                 life first to control execution flow                                 this URI can be done by modifying the                                 victim function pointer of the stack                                 register of course there are some                                 criteria to choose the right function                                 pointer the first thing to Centrify is                                 the ritual wall and if it's union                                 triggered from the user space it eludes                                 me no talking about the later contingent                                 and the second condition is that the                                 shorter called has with with few checks                                 the better and if this will reduce the                                 difficulty of constructions or special                                 data to bypass the check and usually                                 triggers a control pointer and the last                                 one account effects the data structure                                 used in our excavation process across                                 the choice or the comet had the function                                 pointer is your base tons of an ability                                 types                                 for example if we are dealing with an                                 ultra bunch right one ability like                                 re-index                                 how to advance we already have the                                 option to directly modify the pointer                                 instruct our operations and for the                                 stack overflow the return register is a                                 calming victim target and for the heap                                 overflow we choose to modify the pointer                                 in adjacent victim heap object and the                                 last user for free we early over all                                 right the victim pointer by means of                                 heap spree and what we need to think                                 here is whether the control flow hijack                                 primitive is enough for the kernel a                                 purely education you know a few kisses                                 like oh the kernel with fewer                                 medications the answer may be yes but                                 for most cases as an app free kernel                                 memory read or write is much better                                 because we can utilize this to bypass                                 many differences then let's talking                                 about get a free memory right you                                 already there two weeks here the first                                 one is exploit one ability directly but                                 as Windows communicate communications                                 and the developers p.m. on a more                                 adhesion to scrutiny in recent years                                 this type of an ability has become less                                 and less because according to the                                 quality of the one ability the memory                                 right can be divided into the arbitrary                                 memory right and the restricted memory                                 right and the difference between them is                                 rather than memory location and the                                 return content are arbitrary and                                 controllable and another way is to                                 modify address limit                                 first let's look at what is address                                 limit to be simply address limit can be                                 seen answer Penton at a partition                                 between the user and kernel space it's a                                 group of wearable and a member of the                                 kernels structures read info awareness                                 here starting with some version of the                                 kernel some sweaty enforce feels like                                 you're just image has been moved to the                                 thread strut past is that in the thread                                 our follow-up analysis so Europe and him                                 for setting address limiting the car                                 noise and follows we said FS to Colonel                                 Diaz the process can gain access to the                                 entire process the entire address space                                 and after competing the require                                 operations the process will be restored                                 to its original normal accessibility but                                 if the kernel could be made to opt or be                                 hijacked the code flow between the two                                 set FS cause the second call restore the                                 address limit will never be made and                                 that left the kernel data open to be                                 overridden by the by user space and the                                 last look has the two codes snips from a                                 real colonel we can see that for the                                 post two functions between the two set                                 FS e are either a pointer which can be                                 controlled through the first parameter                                 of the function if we can make the code                                 flow to one of the one of these two                                 functions and at the same time we can                                 control the first parameter then we can                                 jump out of the function and the skips                                 the address limit early recovery in the                                 code is set FS to LDS and after that we                                 can get arbitrary memory right                                 so the last part                                 kingroot privilege the most common and                                 the classic method is to color falling                                 to functions it had been used by many                                 real world attacks in addition to use                                 function calls to modify process                                 credential we can also modify each                                 directly if we want want to modify it                                 directly we need to first locate the                                 position of the process-related that has                                 the structure first and it didn't find                                 the location with the creep structure a                                 piece that it's offset one thing we need                                 to make we need to pay more attention                                 here is the offset may be different for                                 different kernel version after after                                 that the last step is to modify the                                 process UID and GID and screwed up three                                 memory writing nest are case studies the                                 first kiss is Yi PPI verifier bypass                                 Warner Beijing before the DTO or                                 nobility analysis let's first look at                                 what is eb PF y BBF was originally used                                 for network packet filter and again and                                 it can be used to wrong user space code                                 inside as an incentive checking with                                 promotion and we all know there are                                 security risks with allow users with                                 code to running to wrong inside kernel                                 so before the eb b PF program loaded a                                 service will check will be performed at                                 the first the first test ensure that the                                 EPP I have programmed terminus and the                                 don't and that not contain any routes                                 and the second stage is more involved                                 and that require the word fire to                                 simulate the execution of the EP BF                                 program or when instruction and                                 and the virtual machine stitch is                                 checked before and after the execution                                 of every instruction to ensure that we                                 register and the stack stick                                 I mean well I wanted this is a timeline                                 about the formaiities                                 proof found this warranted and the webs                                 were walking exploit but he that in the                                 public is just to post some information                                 on on Twitter you can see from the left                                 all right and in early December                                         home of lumber general fund age and                                 reported to the upstream yeah I think                                 maybe jiho is sitting somewhere now yeah                                 because I see his his topic for the risk                                 condition is partition is next to my                                 topic after that Bruce public the                                 exploit code and English in the March                                                                                                       public release the different version of                                 exploit code and his Twitter viewers                                 that's Ubuntu instill effective the                                 order to solve this the mainly patch is                                 also back loaded to the four point four                                 stable kernel this session we'll discuss                                 the root cause of this one a pages less                                 embodies a simple description fourth                                 root cause is inconsistency between the                                 simulation execution in world fire and                                 the actual code running in the kernel a                                 from the first patch commit information                                 we can see that the check euro P                                 function does not make a specific                                 distinction between some certain                                 operations the attacker can utilize this                                 to achieve ministers code execution and                                 the following is a text inner forward                                 fire bypass which I cough long blues if                                 broad code a less observed                                 which is respond for processing the                                 first instruction first check the leop                                 function we are being invoked to check                                 so when I did he also related                                 instruction and here we can see Dan's                                 immediate value is retrieved the from                                 instruction and it's stored into the Reg                                 stitch and the node stand here that I am                                 a man in red stitch and in the PPF                                 instruction are both signed integer                                 ranlo then we come to the second                                 instruction for this instruction do                                 check has to decide which branch to tip                                 to take we find that the right code                                 snippet is responsible that deciding                                 which branch to take and at this point                                 is still comparing to sign the integer                                 based on the source window giving in the                                 EVF program as a false rule an                                 instruction will be taken and the other                                 branch or the put push deck operations                                 will be ignored and the instruction                                      very clear if if to assign the value to                                 the return register let's look at the                                 instruction for since the previously                                 push stack operation has not been                                 executed so when you want to pop stack                                 to see if there are any instructions                                 that we need to continue checking the                                 Pops deck will return net he went                                 directly since the do check will F huge                                 bridge to jump out of the entire check                                 process as a result is if there are some                                 other instructions be behind it for                                 instructions as we will not be worried                                 fired and the nest to let's look at the                                 actual could run we notice that the regs                                 here is different from the regs gaming                                 in the do check is an unsigned a                                        wendel in the first instructions the                                 into well I                                 which is each F we are do sign extension                                 to an unsigned the                                                     means that the new one laws dot in DST                                 is                                                                      the result here is exactly the object                                 the results from the world fire process                                 this to lor and not equal in this case                                 such a jump bridge will be thick and the                                 marriage should be PF instruction will                                 be executed                                 this piece is a brief summary of the                                 previous total analysis that is when                                 verifying the program we are good to                                 exceed bathroom when actually it                                 actually could running the program we                                 are good for that back holder and the                                 flop here can more clearly understand                                 the root cause of the one bit and the                                 for the privilege escalation through the                                 previously introduction we can already                                 asked you'd actually IEP PE BBF program                                 the next thing is to construct it so                                 specifically PB PBF instruction to                                 achieve actually memory rich or right                                 after that we can modify the process to                                 create a structure to get through the                                 privilege due to the time limit if you                                 want to learn more details about this                                 part you can refer the blue puppy it's                                 royal code and we didn't introduce the                                 middle medication bypass for this is                                 Floyd in fact all these calm image                                 medications are you married                                 for each especially as a whole exploit                                 doesn't need to know the address or a                                 particular symbol or we need to we don't                                 need a gadget so we don't need to know                                 the symbol of summer address and also we                                 doesn't ask you the user speed code or                                 access user space data with with the                                 supervisor mode so there is no need to                                 consider the key area                                 MEP and SM EP for the key CFI also is                                 not broadly adopted by the major Linux                                 kernel version it's worth defined - the                                 difference the control flow related                                 attack however for this it's point is a                                 doesn't a temper with the control flow                                 and it's just utilized and the native                                 functionality to change the program's                                 normal behavior                                 so it's also invalid a simple key                                 summary and this should be considered a                                 detail-oriented attacks with the ability                                 to cause great damages especially the                                 type of attack this type of attack have                                 used to modify the pin tables and change                                 the memory from permission of the kernel                                 code to be writable and then injected on                                 my shirts coded to the kernel space and                                 for example we can patch the                                 implementation with a control flow check                                 to bypass the Kiev PC Fi the good news                                 is that many Linux distributions are are                                 affected because they don't oppose IPPF                                 feature and they don't allow the normal                                 user access next a timer of the URIs                                 condition I found and report this issue                                 to the Google Android screw team in the                                 early                                                                    on a raid because it's related to the                                 timer and can be used to get universal                                 root it's based on the fell descriptor                                 and there are three main system cause                                 Tamra F decreed time release at half                                 time of decay time associated with age                                 and look at the world media analysis                                 both Tamara FD set up castle function                                 and the timer FD removed                                 new remove cancel function or we are per                                 mo where perform the least operations                                 that the Webster's want to protest might                                 cancel cranium only by sets the context                                 Matt Cassel is your global variable to                                 true or false to prepare to prepare the                                 list of operations a pasties protect the                                 protection method that not working                                 looking to the risk conditions less sure                                 her clarify this by special attack sir                                 scenario in the net speak first let's                                 look at Left diagram the spread a said                                 the contest might cancel to force and                                 send delete the list in the normal case                                 it's important both was ready to delete                                 the list again because it will not pass                                 the if judgment however if it before the                                 judge image if the CPU which is context                                 at who runs read B and the thread we                                 modify modify the count has my cancel to                                 true and since view count has switch to                                 a switch again at these times ready will                                 pass if judgment and delete see list and                                 other game cause the list corruption                                 problem and in this case the system we                                 are also crash there is another                                 situation so similarly as a seamless to                                 note if ad is indeed a twice in this                                 case we are no longer delete the note so                                 the note when doing the listed delete                                 operations causing the dangling pointer                                 the problem and in this case that the                                 dangling pointer problem can be                                 converted to the user for free and is                                 pot what get privileged education by                                 exporting this the following is the list                                 operation details to expire why it's                                 called dangling pointer                                 issue sole look at if we add the same                                 code twice and the same delete each what                                 will happen after the execution of the                                 Luigi the linked list operation we found                                 the note it's still in the list after                                 after the delete operation that means if                                 we already ended the same note twice we                                 can't we can never delete it and the                                 quickly go through the conventional uef                                 exploiting the first three step is to                                 cause is to used with key risk condition                                 to cause the user for free problem and                                 after we did the hip spree at the last                                 two step our trigger and gets the code                                 execution but we are in trouble but we                                 are in triple or triggering so victim                                 pointer there is camp or checking our                                 trigger path the ordinary process                                 doesn't allow the cap system capability                                 and so we can't access to the victim                                 pointer but as we all know fall onto no                                 privilege is required that to create a                                 username space so can we use this to                                 bypass the permission check the answer                                 is also no let's look at the information                                 from the marriage of the username space                                 it clearly describes some privileged                                 operations like camp system campuses                                 module tab make note and not associate                                 associated with any name and speech tags                                 only in the initial user name space can                                 perform such operations                                 before injured in traduced a final                                 solution now we all first introduced to                                 concepts a way to secure and another is                                 pipe subsystem to teach you means time                                 you checked to time we use the following                                 simple example could give us a good                                 understanding of that after the access                                 check will link the field who so weak                                 team fail for example the commuters                                 password and we can override the                                 password if justice in a simple example                                 and look has a pipe subsystem here I                                 will introduce a system call related to                                 the pipe system read with is call it                                 used a service or our whicker's to                                 describe user buffer if the number of                                 our Victor is greater than each it will                                 Kamel of the memory on the heap at what                                 it will put our weight around us death                                 and when no window contains over it both                                 from the right right and read we may                                 block in the kernel then we can with our                                 winters may stay in the kernel or heap                                 so according to the bough a distribute                                 the description we can use read we for                                 hip spring in this case our victim                                 buffer is grid stage so can use this to                                 secure also exists in the maps system we                                 found pipe will check that our victor                                 and make sure is                                 i will be spawned my points to the user                                 space after that when pipe perform copy                                 to user it will it will not check the ow                                 i will be soaking so if we can modify                                 the owl with her at this internal to                                 achieve this we can                                 there are two types of one abilities can                                 be used to modify die with her between                                 between the internal of the time of                                 check and the Tamil youth and the                                 warranty we are discarding now if                                 actually use offer free one bid so we                                 should be able to use these to compete                                 the full rate production the following                                 is detail list operations we combine the                                 list operation with type heaps pre I                                 think this part is difficult to                                 understand unless you do it by yourself                                 step-by-step so I will quickly go                                 through and only explain some result and                                 if you are interested in this part you                                 can deep dive into it of life the first                                 step we add with him context twice and                                 it's in delete and freed age through the                                 previous introduction we know that such                                 operations we are not delete so wick                                 team note there are technibond her in                                 the hip buffer so next we needed to do                                 is a hip three so we use the rid we                                 threw hips free to modify the lift a                                 node then we block with we and modify                                 our piece by delete another node contact                                 and the last step we pipe right our                                 prepared container to modify content be                                 nest and content beneath and previous                                 pointer and finally we delete contrary                                 to achieve with treat memory right                                 for the colonel address space layout                                 randomization and attacker does not even                                 need an arbitrary read premier primitive                                 to buy passage with info leak from a                                 message it can be easily bypassed                                 especially for one - and there are no                                 restrictions access to the message and                                 we can just to trigger some warning                                 information or false                                 big pitch fault because the panic ops is                                 not enabled in Ubuntu and for the                                 Android a salinas will restrict access                                 to the de message but there are some                                 still a small number of wonders or                                 products that can allow access to the                                 dimitru and the blue pager                                 of course in addition to this we can                                 also used hardware side channel timing                                 attacking method to bypass the key FL                                 and nest as mep bob has the first method                                 is Beach flipping while we use a needle                                 right here for the scheduled said                                 affinities his call is to foster a sport                                 program to be a skewed on West Pico and                                 just make sure that the user space                                 payload will be a skewed on the same                                 call aware we have this a border so SME                                 be a need to mention here the schedule                                 set affinity as if cocci also be used to                                 help improve affect the success which                                 also hips cream and another method is                                 address limit exploiting we haven't read                                 introduces rivers and one situation to                                 discuss here is what to do if the first                                 parameter the first panda nature is idea                                 in the x                                                            register in the city for                                 architecture if it can't be controlled                                 what give what we can do instead we can                                 control appoint her in the first                                 structure                                 I think construct in the like the yellow                                 everything and check flags interfere                                 operation and think rather parameters we                                 need in the user mode of course SM EP                                 will block this method but if there are                                 only FME EP in a border this is valid                                 about several years ago red to di are                                 also have been proposed to bypass an SME                                 pianist and maybe however with a kernel                                 patch applied this fifth fifth map which                                 are no longer suitable so currently if                                 not when it is except for sampled okay                                 no worship so the key summary in this                                 case attackers can trigger the victim                                 function hunter due to the capability                                 check as a result we can't use                                 traditional user for free exposing its                                 partition techniques but by combining at                                 least operations with with the pipe rip                                 spree we also achieved memory right also                                 we write the right content is restrict                                 after so we have two options why it's                                 modified address limit to get our free                                 memory read and write and another one is                                 to directly read the drivers associated                                 the function to spectacle do pigeon to                                 achieve a free memory read I'd like it's                                 like we can modify the I will control                                 all the spectacle driver like the PGM X                                 DV PGM eggs and make is some command Oh                                 how control point mm better to be                                 chained to the weather he gets actually                                 memory right and the last thing cooler                                 the latter part                                 the first one is important to know your                                 enemy as we all know defense is more                                 difficult because it requires a                                 continuation or workers attack and if                                 the tech means and the attack surface so                                 we counted separates the difference from                                 the attack we need to keep abreast of                                 the exploit techniques to promote                                 defense better as a second security is                                 not just it's not just as simple an                                 integration of the workers medications                                 just like you have already able the                                 kernel address space layout                                 randomization but it can be easily                                 bypassed the only through the Demasi                                 jean-philippe as as sees a small leak we                                 all sink a great ship and the last one                                 now                                 the widely deployed medications are                                 against as a control flow attack so the                                 this is attack we are talking about are                                 mostly based on the control flow attack                                 but we also need to appear memo teaching                                 to the data oriented attack even some                                 mid key how have no distance there are                                 some people's proposed some medications                                 to prevent data oriented attack but it                                 can be predicted that there will be many                                 rigid warrants in the future this is a                                 reference that's all thank you                                 an imperfect speculum hey great tuck                                 have you looked at the exploit ability                                 of l                                                              meltdown vulnerabilities that came out                                 in the last two years because they are                                 exploitable in a lab environments but I                                 yet to see someone publicly claimed that                                 they can do that in real native                                 environment do you mean the best one                                 Milton                                 yeah a spectrum well down L                                           you have you looked how exploitable they                                 are in real environment where you know                                 the cache is flying or everywhere yeah I                                 know what Oh what do you mean it's the                                 special and Milltown are the CPU based                                 warren beatty's it's different what we                                 are talking to be if the is Flom so                                 colonel OS version we are talking about                                 today i know there are some techniques                                 used to likely just use it to some catch                                 flash and some other to rotate but i i                                 don't know much detailed about it so                                 sorry for that                                 any other questions                                 thanks for the talk you mentioned this                                 SMTP bypass with native rights ef                                       register function and recently there was                                 some additional mitigation for Sierra                                 for pinning did you have a look at it                                 and other any comments yeah I know there                                 are some medications new medications                                 that that adopted to mitigate this this                                 kind of attack like we can't use the                                 uses so I introduced the nest and the                                 nest method we can we can control our                                 code flow through the could flow through                                 the to to this kind of address and if we                                 if we also in addition to control the                                 color flow if we also can control one                                 register like idea and x                                                 if it's contained in the user name space                                 and to use this method to get the                                 upstream Emory right yeah so the first                                 method is not needed if you use the                                 second one right yeah oh thank you                                 no one else's question I have a question                                 so you mentioned that we entered we                                 should be paying more attention to his                                 data oriented to talks so is there any                                 technique or a group of technique which                                 you feel is the most prominent I mean                                 from defense point of view against his                                 data oriented to talk about                                           security people should be start paying                                 more attention and looking into many                                 proposed envy research and have you do                                 have your own luck things you may be                                 preferences what you think what some                                 defenses are more kind of better shot to                                 do and to look into a chronic space yeah                                 yeah this is a difficult question but if                                 yet just as the first Isis                                 defense is I think the defense is                                 difficult than the attack he hates work                                 hard to knows every attack surface and                                 we need to out know every the attacker                                 means so I so forth                                 for the difference the web how maybe a                                 once so Amelia once suggested and except                                 for to be focus on the defense itself                                 it's it be better to know something more                                 about the royal teaching techniques I                                 think the suggestion is it should be                                 educating ourselves more is data                                 oriented to talks and kind of thinking                                 more towards how do they protect against                                 them yeah so I need more questions or so                                 in red case let's find his paper                                 [Applause]
YouTube URL: https://www.youtube.com/watch?v=MYEAGmP_id4


