Title: LSM Stacking - What You Can Do Now and What's Next - Casey Schaufler, Intel
Publication date: 2019-11-04
Playlist: Linux Security Summit EU 2019 - Lyon, France
Description: 
	LSM Stacking - What You Can Do Now and What's Next - Casey Schaufler, Intel
Forum 1

Speakers: Casey Schaufler
Before the 5.1 Linux kernel it was only possible to combine Linux security modules (LSM) that don't use extended security "blobs". With the introduction of infrastructure blob management it is now possible for a limited set of extended system security data to be shared, allowing greater flexibility in security module combination. This talk will describe what data can currently be shared. It moves on to describe plans to expand the blobs that can be shared. Plans for achieving the ultimate goal of complete module stacking wrap up the presentation. Feedback on the plans, and suggestions for alternatives and improvements are solicited.
Captions: 
	                              welcome back so does anybody here know                               what a Linux security module is okay                               well great Linux security modules are                               really they're fascinating little aspect                               of the kernel that we've got allows you                               to apply additional restrictions to the                               existing traditional Linux security                               policies in general the mechanisms                               reflect to the existing policies the                                hood bits that you see on files for                                example in a few cases they actually are                                used for other things security concerns                                that aren't necessarily what you would                                normally consider a security policy                                issue these are things like binding to                                sockets that isn't really something                                where you've got a subject or an object                                involved but it's a security thing it's                                something that people think is a                                security issue so we've got got                                mechanisms for for controlling that                                today today we've got to make mechanism                                called module stacking where you can                                have registered more than one security                                module back in the in the old days you                                could only have one llaman came in and                                we had the man that was manually stacked                                in it was hard-coded in that didn't                                really sit very well so we fixed that so                                we now have just lists of modules and                                but we have some issues with that the                                problem really came down to the fact                                that the way we manage data we call them                                security blobs which we associate with                                the various thing you know things that                                are managed within the kernel but you                                only had one pointer off of each of                                these things you could really only have                                one module at a time we've changed that                                a little bit so now we actually have LSM                                types we've got legacy major which were                                the                                kind of major modules the selinux smack                                Tamayo a partners and we also have what                                we call in some of the modular market is                                exclusive so what is exclusive me an                                exclusive module is you can only have                                one of them so if you have yeah selinux                                is marked exclusive app armor that                                marked exclusive that means you can't                                use them both at the same time that's                                bad now for a long time you know people                                kind of threw up their hands well why                                would anybody ever want to do that                                that was before the days of containers                                now in the container world we've got                                people who are running ubuntu on their                                their data center they want to run                                android in their containers well nobody                                ever wanted to do anything crazy like                                that before so now we've got these                                exclusive modules we can't use them                                together so the goal that the the                                project we're working on these days is                                to get rid of the notion of exclusive                                module to mark as many modules as we                                possibly can it's to be not exclusive                                but why do we have to have them                                exclusive and why can't we just load                                them all up no it's because of the                                security I guess because of the security                                blocks so as of the                                                     set of blobs that are instead of being                                managed by the secured modules                                themselves they're managed by the                                infrastructure so when you load selinux                                selinux tells the infrastructure how                                much space it wants in the credential                                and file and the inode blobs and the                                infrastructure takes care of allocating                                it and freeing it and then the security                                modules can use it to their heart's                                content what this means is that if you                                have a security module that uses just                                these blobs it doesn't use any other                                blobs you don't have to mark it as                                exclusive and you can run it at the same                                time you're running in SELinux and so                                you                                have to turn off SELinux your IT people                                are really happy because hey you've got                                the standard thing with with SELinux                                you're still using that everybody                                everybody's fine but you've also got                                this other security module that you've                                built that can go in and use those use                                those interfaces to do whatever it wants                                so you don't have to guess you selinux                                just because you've got this new and                                 cool new cool thing implementing some                                 policy of your choice and that's great                                 so right now yeah we've got a number of                                 minor modules coming in we've got Sarah                                 white egret land lock several others                                 that I've heard of today that I had not                                 heard of before that are coming in that                                 we can you can put in with SC Linux or a                                 farmer or smack or tomorrow and and they                                 just run flawlessly they don't interfere                                 with each other very much and                                 everybody's happy but not everybody's                                 happy because we still have some                                 limitations so that brings us around to                                 what's coming next                                 so the plan is and no we're not there                                 yet we don't know for absolute sure we                                 got to get enough sign offs and tested                                 buys and and AK spies in order to make                                 sure we can get this but we've got the                                 the code actually to a point where it's                                 pretty close to solid I hope and so the                                 goal for our next next major release on                                 this and we're targeting five point five                                 is to remove the exclusive from app                                 armor why is a farmer our our next                                 target app armor is different from smack                                 it's different from SC Linux in that it                                 is path name based ish less so now than                                 it used to be but it has a difference of                                 a different fundamental security model                                 than either smacker SE linux mac and SC                                 Linux are based on subjects and objects                                 where the objects are things like the                                 inode                                 whereas a parm is much more oriented                                 toward pathnames the profiles are                                 different the use cases are different so                                 it does in some cases make sense to have                                 SELinux and a partner if you want to do                                 get the kinds of values you get from                                 both of those or do you smacking in a                                 partner if you want to do do certain                                 configurations so it does make sense to                                 actually target a partner as the next                                 thing that we want to get the exclusive                                 tag off of that requires a couple of we                                 do a couple of things first off we need                                 to add the sock security blob to those                                 those that are managed by the                                 infrastructure that's actually a                                 relatively straightforward thing we know                                 how to do that we've actually done it                                 with the you know with these with these                                 other blobs so it's just a matter of you                                 know take that code change change a few                                 names in it and everybody's happy                                 everything think that smoothly that's                                 not the only problem we've got that's                                 the easy part                                 yeah I love fixing the easy part because                                 that doesn't take very long and nobody                                 complains about it so when you get to                                 the hard part that people start to do                                 things like bike shed and the favorite                                 one on that one if you've got a Parmer                                 and SELinux running at the same time you                                 have to deal with the fact that both of                                 these LSMs want to look at proc bid at                                 our current to find out what the                                 security attributes of the process are                                 now since both of them want to do that                                 same thing you can't do that because you                                 don't know who it is                                 so we're introduced in a couple a couple                                 of new interfaces here prop pin at a                                 context which is like current except                                 that it has all of the information about                                 all of the security modules that are                                 affecting the process at the same time                                 and it's done in a very simple four                                 Matt it's the name of the LSM I know the                                 value and no name of the next LSM and                                 all the value so forth so if you have                                 for example if you have SMAC and a                                 partner on a system you get this you'll                                 get the smack label the word snack and                                 then there's the value for the smack                                 label the word out at Barmer and then                                 the value for that of that context                                 salsa we're also introducing a sop                                 context which is like Pierce SOP R Seck                                 it's the same set of information but                                 it's what comes across the UNIX what                                 comes across the socket again we have to                                 have a different interface because you                                 can't be backward compatible if you                                 change the format and we proposed at                                 least about a half a dozen different                                 formats for this at commis operate                                 separated lists you know in a known                                 order or smack equals value comma half                                 armory equals value but we finally did                                 the the intelligent thing which is to                                 ask the user community and particularly                                 the guys from d-bus to ask them okay                                 what do you want to see and they said                                 well just give us give us a null                                 separated list we don't know how long it                                 is so you know we'll read the first one                                 we hit that's not all of it keep going                                 until we've gotten at all so that's kind                                 of a lesson if you're doing doing kernel                                 development yeah you're you have an                                 issue like this don't just debate it                                 amongst yourselves you'll never come up                                 with a right answer                                 ask somebody who's going to use it and                                 then they'll tell you what they want and                                 then you can say okay I don't have to                                 worry about it anymore I'm gonna go with                                 what they want but that still doesn't                                 solve all the problems because of course                                 we got legacy programs how many of you                                 have changed system demons recently okay                                 nobody excellent                                 how many have changed the colonel                                 recently okay a whole lot more okay what                                 does this tell us it tells us that                                 people are changing the colonel they're                                 not changing the system system services                                 people don't want to touch those things                                 I mean they've been working for                                          yeah they got some CVEs but somebody                                 else will take care of that and it's                                 like you know I'm it's a system service                                 I'm not gonna change that nobody's                                 changing these things so we need                                 mechanisms that will allow us to run                                 these things in the way they're                                 accustomed without breaking and so we                                 have to come up with a mechanism whereby                                 we can say under these circumstances you                                 should you use the SELinux information                                 under these circumstances smack                                 information and so forth                                 so we're introducing another process                                 attribute which we're calling the                                 display so you write Crockett self add                                 or display and you write the name of the                                 LSM you want to get the information for                                 this is especially useful if for example                                 like the app armor people are doing                                 where you're using SELinux in a                                 container on top of your app armor                                 system or the other way around so you                                 can say when you start up the container                                 you can set the display to SELinux and                                 so the things that are running in the                                 container will think they're using                                 selinux they'll get the information                                 about SELinux that's what they're                                 expecting everybody's happy                                 the base system can use app armor get                                 the information they want everybody's                                 happy and you haven't had to change any                                 of those pesky system services because                                 again nobody wants to change them they                                 just work now there was a big long                                 debate here about how you would decide                                 whether or not it would be okay to                                 change the display my original take on                                 it was why not and it's like it's system                                 information why should anybody care what                                 the display is well Stephen Smalley had                                 some really good reasons                                 you wouldn't want to do that you might                                 be able to for example trick trick a                                 program into writing a context that                                 another LSM wouldn't be able to use the                                 right and in the right time it was all                                 very messy so my first my first I was a                                 little fine well put it under cap Mac                                 admin because that's the right thing to                                 do that's the capability used to can                                 control changes to the mandatory access                                 control environment                                 well SELinux people didn't like that                                 either turns out that they don't like                                 using capabilities they want to do all                                 the privilege control themselves okay                                 fine so what do you do well what they                                 wanted is every yellow cent to pipe in                                 and say yes or no just no I don't like                                 that yes I do like that and since the                                 default on that was going to be yes or                                 go ahead then you find everybody's got a                                 each of the LSMs                                 that has that uses the the proc                                 interface now has to have a just have to                                 have to say how it's going to vote on                                 using the display and so SELinux that                                 actually added a an element to the                                 policy which is whether or not you can                                 modify the display app armors done                                 essentially the same thing and smack                                 goes yeah sure go ahead because that's                                 the right thing the other thing that                                 came up is binder any of you familiar                                 with binder okay great yes okay so                                 binders is something that Android uses                                 it's an access canapa Naxos control                                 mechanism that came from somewhere else                                 okay somebody's laughing that's good                                 yeah it's it has its own own intrinsic                                 issues but one of the things that it                                 does do is it uses the mechanism the                                 internal mechanisms for displaying the                                 security context to pass information                                 from one side of the                                 buying to the other and so we had to                                 make sure that when you run the binder                                 that the sender and the receiver are                                 talking about the same LSM when they                                 pass the information it doesn't matter                                 which one it is you so long as it's the                                 same one so that it doesn't send an se                                 Linux context to a process that thinks                                 it's going to be looking for a partner                                 because they give apartment and NSC                                 Linux would get very confused now smacks                                 pretty good about this Mac smack will                                 take anything as a valid context but                                 that's just kind of an implementation                                 detail of that the next thing that we                                 had to do is do some enhancement to the                                 audit data because what do you do when                                 you have to subject labels one from                                 selinux one from a farmer went from                                 Cenac from bloom from a farmer you can't                                 just put that in a compound context                                 because the audit records are going the                                 audit parsers aren't going to be able to                                 deal with that from a compatibility                                 standpoint so we're adding additional                                 information additional fields into the                                 audit record when you've got more than                                 one LSM that has subject information so                                 in this example here if we have SELinux                                 is the first LSM and a parmer is the                                 second so it's going to say the subject                                 is a : b : c : d which is the selinux                                 context but then we're also going to say                                 and then the the subjects for sa Lennox                                 is going to be a : b : c : d and the                                 subject for app armor is going to be Z                                 or whatever it happens to be yeah this                                 is a little Burgos yeah there's a                                 there's a little bit of duplication of                                 information in there but for backward                                 compatibility                                 it'll be a bit backward compatibility                                 thank you                                 you need to have the subs equals because                                 the everything that reads auto records                                 is going to be looking for that and the                                 new tools you're going to need to know                                 which LS m is responsible for which data                                 and without some in                                 indication that says oh by the way the                                 subject is going to be the SELinux                                 subject you need to actually have that                                 as well so you can't drop the subject                                 equal even though it's redundant in this                                 case and because app armor doesn't                                 currently have object labels on anything                                 we don't need to do it for objects but                                 we are going to have to have to do it at                                 some point in the future so when we need                                 to do that we're going to do the same                                 thing there so the auto records are                                 going to get bigger and they have to                                 because there's more information                                 involved so that's actually what we need                                 to do for a partner it's not very not                                 actually very complex well I it doesn't                                 look very complex on the outside there's                                 a significant amount of data structure                                 changes within the kernel that nobody                                 outside the kernel sees in order to deal                                 with the compound contexts one of the                                 issues is that when you allocate one of                                 these text strings you then have to free                                 it at some point but in order to do that                                 you need to know which LSM allocated it                                 because they have different policies for                                 whether for how you should go about                                 freeing so there's a little bit of                                 complication there but it actually makes                                 the some of the internal interfaces a                                 little bit cleaner so I consider that a                                 winner so that's what we need to do to                                 take the exclusive tag off of a partner                                 so when we've got that in then there's                                 the next phase here which coming along                                 coming before all that log and that's                                 the next step and the next step set of                                 goals is is really simple and that is to                                 remove the exclusive completely and that                                 would be from selinux and format from                                 smack so that you could not use any of                                 the security modules together all at                                 once and singing in three-part harmony                                 and it'll all be beautiful that's a                                 little bit more challenging and the                                 reason why it's a little bit more                                 challenging is that smacking selinux do                                 a lot of the same things in particular                                 they use both use networking extensively                                 so we have to add a few more                                 infrastructure managed blobs that would                                 be included so along with the sock we                                 have to have the key and the super block                                 super black part block partly because                                 both SELinux and smack use mount options                                 mount options are a really challenging                                 set of set of interfaces as David                                 Howells will tell you that length if you                                 let him Alvaro will concur because he's                                 been working with with David on                                 restructuring them that the amount                                 interfaces that's one of the things that                                 we have to do so instead of just saying                                 well I'm going to send it to the LS m to                                 do the mat options Yap saying they sent                                 it to all the LS ends that do mat                                 options and oh by the way if you give                                 them out option that you don't recognize                                 you have to not pay attention to it                                 because somebody else might might be                                 paying attention to it but then in the                                 end you still have to say wait a second                                 nobody paid attention to this so it's a                                 little adds a little bit of complication                                 there but it's not actually as bad as it                                 sounds well actually it is but then they                                 have to get onto the networking stuff                                 networking stuff has it has a wonderful                                 set of challenges the first of them is                                 is the net label interface the net label                                 interface is very convenient very                                 powerful it allows you to generically do                                 packet labeling using the SIP so and                                 Calypso network protocols but if you                                 have two LSMs                                 that want to put labels on packets you                                 have to decide what to do about this                                 because you can't put two labels on the                                 packet and only put one so they're after                                 a lot of crying and gnashing of teeth on                                 how how we could possibly make this work                                 finally agreed                                 that the the right thing to do is to say                                 if you can get the LSM all the LSMs to                                 agree on the labeling then you can do it                                 and if you can't you have to fail it                                 well that's a little bit harsh but yeah                                 it kind of makes sense if you're gonna                                 put a label on a packet and if you can't                                 get people to agree on what's what it                                 should be then you probably shouldn't                                 have send it                                 actual deployment indicates that this is                                 going to happen very rarely because the                                 granularity of that the LSMs use is                                 going to be very different but there                                 there are circumstances you can you can                                 use where this watch we actually come                                 out part of the problem with it is that                                 you set the label on the LS the the net                                 label interface at the beginning you say                                 when you create the Sykes a this is this                                 is how I want this to be labeled well                                 what that would mean is that if you                                 don't agree when you're creating the                                 socket the socket creation is going to                                 fail and you're going to fall over and                                 that means nobody's ever gonna create a                                 socket because nobody's going to agree                                 at that point you don't really care                                 about to actually want to send it so                                 there's some slight change the net                                 little interface that has to happen in                                 order to make that actually work                                 properly some change in selinux but more                                 change in in smack because smack doesn't                                 use net label the same way as he Linux                                 uses a net label and that makes things                                 complicated so smack has opportunities                                 for improvement so those have those do                                 have to go in so that's for packet                                 labeling that's a bit a bit of a project                                 but once you can you actually get gifts                                 so that the the you can settle a you can                                 request the label you want and then when                                 you're actually going to send the packet                                 that's when you decide whether or not                                 you're going to you agree on what it                                 should be labeled then you can actually                                 have a system that that functions at                                 least marginally in some cases the next                                 issue would be sec marks so if you're                                 using                                 nf tables or IP tables                                 you've got us this opportunity to put                                    bits into the packet header you know                                 into the the sk buff to pass it around                                 and recommend what the the labeling                                 should be unfortunately                                                enough for to represent two                                 cents or three LSMs or                                                   to do something not clear exactly what                                 we're going to do a hash table to come                                 up with with a mapping possibility                                 exclusively use this is the easiest way                                 to do it just say well yeah SC Lennox's                                 smacks gonna say hey selinux wants you                                 sure go ahead I won't bother or vice                                 versa that's another way to do it that's                                 that's kind of a cop-out though not                                 everybody likes that one and skb                                 extension yeah maybe                                 we're a little bit weary on that the                                 networking people haven't always been                                 especially accommodating when we made                                 requests like that so we're not exactly                                 sure how that's going to work yet but                                 we'll come up with something we're not                                 one of the two okay so and then there's                                 labeled NFS for NFS for this is a really                                 interesting conundrum here because                                 labeled NFS was defined and it defined                                 was defined as and the definition                                 included information about how the data                                 that's being passed back and forth from                                 between the plans of servers formatting                                 which si which smattering which Linux                                 very carefully ignores doesn't put it in                                 doesn't read it just assumes that the                                 information that came in is the format                                 that whoever is going to read it wants                                 to use that's gonna require some some                                 enhancement before so that we can                                 actually tell who's going who's going                                 which way the NFS developers are looking                                 at that looking at how they might might                                 go about doing that we'll see how that                                 goes so that's where we are yeah that's                                 where we're headed hopefully you will                                 have will have the next round in five                                 five ish                                 hopefully we'll have all the rest of the                                 things all the rest of the problem                                 solved and a path for them not too long                                 after that and that's where we are                                 questions nine months                                 and in the audit records you show that                                 the various LSM contacts will be                                 displayed parallel alongside the legacy                                 accel equal one is the same thing gonna                                 be there in progress as well so yes so                                 so what we'll do in proc FS okay you                                 will get the value use the existing in                                 their faces for example proxy self at or                                 current you will get the first one first                                 LSM that provides one unless you have                                 set the display in which case you're                                 going to get the value these you've said                                 it for okay we have to do new interfaces                                 for the new for the the compound format                                 because otherwise it's you're not going                                 to get information that you're going to                                 be able to read if you get the got the                                 compound format if you're running smack                                 the first the labor you would get would                                 always be smack and that's not what you                                 want you want the value of smack about                                 the name of smack so backward                                 compatibility it would be really nice                                 you just put it in one place we know we                                 can't is that the question okay how                                 questions                                 Oh gonna send me some men pages patches                                 for those Proctor's sorry you're going                                 to send me some men page patches for                                 those proc changes of course thank you                                 our questions                                 if not let's thank you for the talk                                 thank you                                 [Applause]
YouTube URL: https://www.youtube.com/watch?v=XtKodXBxY6U


