Title: NixUP â€“ State and Future of a Nix-Managed User Profile by Thomas Strobel (NixCon 2017)
Publication date: 2017-10-30
Playlist: NixCon 2017 (Munich)
Description: 
	Nix User Profile (NixUP) should have been a declarative configuration for the user environment [1]. By now similar solutions have emerged, like nix-home [2] or home-manager [3]. In this talk the different approaches will be reviewed and an update on the state and future of NixUP will be given. [1] https://github.com/NixOS/nixpkgs/pull/9250 [2] https://github.com/sheenobu/nix-home [3] https://github.com/rycee/home-manager
Captions: 
	00:00:00,030 --> 00:00:07,830
all right let's start so you remember

00:00:04,410 --> 00:00:12,240
from before the statistics there was one

00:00:07,830 --> 00:00:15,150
issue with 155 comments I think is the

00:00:12,240 --> 00:00:18,330
one that's too much well started almost

00:00:15,150 --> 00:00:22,080
two years ago and so today is gonna talk

00:00:18,330 --> 00:00:26,010
about this issue thank you for the kind

00:00:22,080 --> 00:00:29,779
introduction hello everyone so yes I

00:00:26,010 --> 00:00:32,489
want to talk about mix-up mix-up is a

00:00:29,779 --> 00:00:35,190
declarative way of managing your user

00:00:32,489 --> 00:00:38,309
environment and what it basically is

00:00:35,190 --> 00:00:42,329
it's copying the way how we manage the

00:00:38,309 --> 00:00:44,399
NICS OS operating system into and use

00:00:42,329 --> 00:00:47,520
the same method that we learn to

00:00:44,399 --> 00:00:49,620
actually manage our home user

00:00:47,520 --> 00:00:52,110
environment so you have a central

00:00:49,620 --> 00:00:53,670
configuration file that we write down

00:00:52,110 --> 00:00:55,739
which packages we want to have installed

00:00:53,670 --> 00:00:58,559
which services should be running and

00:00:55,739 --> 00:01:01,260
which resources or files we want to have

00:00:58,559 --> 00:01:03,629
linked in to our home directory and then

00:01:01,260 --> 00:01:06,450
a set of su the tools to instantiate

00:01:03,629 --> 00:01:08,369
this user profile and as you've already

00:01:06,450 --> 00:01:10,979
heard behaviorist rod Rhodes

00:01:08,369 --> 00:01:12,479
so I remember people talking about it

00:01:10,979 --> 00:01:16,170
back in 2014

00:01:12,479 --> 00:01:18,390
Nickolas then implemented at first the

00:01:16,170 --> 00:01:20,640
first a year and then I opened this

00:01:18,390 --> 00:01:25,049
long-standing cool request which by now

00:01:20,640 --> 00:01:28,500
has 150 comments and 60 participants and

00:01:25,049 --> 00:01:30,840
it last year it already had enough

00:01:28,500 --> 00:01:35,220
attention so that Peter had to mention

00:01:30,840 --> 00:01:37,110
it in his April Fool's joke and finally

00:01:35,220 --> 00:01:39,840
by beginning of this year Robert

00:01:37,110 --> 00:01:41,579
Ferguson he implemented or announced a

00:01:39,840 --> 00:01:44,369
real implementation of it called Home

00:01:41,579 --> 00:01:46,020
Manager and then when I heard about this

00:01:44,369 --> 00:01:49,399
conference I thought what do I do about

00:01:46,020 --> 00:01:52,890
this pull request should I actually just

00:01:49,399 --> 00:01:55,290
work on it and so I wonder is it worth

00:01:52,890 --> 00:01:57,420
the effort our people really interested

00:01:55,290 --> 00:01:59,790
in to this feature ends up I have this

00:01:57,420 --> 00:02:01,469
problem I went through this pull request

00:01:59,790 --> 00:02:03,060
and I saw a lot of comments and people

00:02:01,469 --> 00:02:05,369
like that and had a lot a lot of thumbs

00:02:03,060 --> 00:02:07,409
up and likes and I thought but they're

00:02:05,369 --> 00:02:09,629
so cheap are people really willing to

00:02:07,409 --> 00:02:12,090
put their money where their mouth is and

00:02:09,629 --> 00:02:13,740
so I thought could I just ask them to

00:02:12,090 --> 00:02:16,560
donate money to the next one

00:02:13,740 --> 00:02:19,860
Foundation just for me to measure how

00:02:16,560 --> 00:02:22,560
real the interest really is and if the

00:02:19,860 --> 00:02:26,730
result was that in the end around 20

00:02:22,560 --> 00:02:28,710
people donated or pledged 650 euros so

00:02:26,730 --> 00:02:31,320
big thanks to all of you with it then

00:02:28,710 --> 00:02:33,060
but for me it wasn't conclusive what I

00:02:31,320 --> 00:02:34,920
should do in the end if it would have

00:02:33,060 --> 00:02:35,430
been a hundred people I would have said

00:02:34,920 --> 00:02:38,370
yes

00:02:35,430 --> 00:02:40,470
people loved it so I should really do it

00:02:38,370 --> 00:02:42,090
and if it would have been just fifty

00:02:40,470 --> 00:02:44,490
years I would have said well apparently

00:02:42,090 --> 00:02:46,680
it's just me and I would have dropped it

00:02:44,490 --> 00:02:49,740
but this result somehow left me in

00:02:46,680 --> 00:02:54,750
between and then I thought well Tomas

00:02:49,740 --> 00:02:56,700
come on just do it and so and so the

00:02:54,750 --> 00:02:58,680
overall design was very clear for me

00:02:56,700 --> 00:03:00,360
from the beginning there are this whole

00:02:58,680 --> 00:03:02,520
miniature and so I reached out to Robert

00:03:00,360 --> 00:03:03,750
and said can we somehow join forces

00:03:02,520 --> 00:03:07,770
because I didn't want to start another

00:03:03,750 --> 00:03:10,290
project and so he said yes we should and

00:03:07,770 --> 00:03:13,170
so I could just focus on this deep

00:03:10,290 --> 00:03:17,430
embedding into Nexus which whole manager

00:03:13,170 --> 00:03:20,790
so far has not and so with a little bit

00:03:17,430 --> 00:03:24,000
of luck by the end of the workshop next

00:03:20,790 --> 00:03:26,180
week you should have an option mix-up

00:03:24,000 --> 00:03:31,710
enable within your mix OS or

00:03:26,180 --> 00:03:34,170
configuration and the your configuration

00:03:31,710 --> 00:03:37,140
file should go or we'll go into config

00:03:34,170 --> 00:03:39,720
mix up profile dot next and then with a

00:03:37,140 --> 00:03:44,370
little bit of luck Nick cerebral switch

00:03:39,720 --> 00:03:47,970
should do its job and present you all

00:03:44,370 --> 00:03:51,210
the features that is right before the

00:03:47,970 --> 00:03:52,920
content of the next up profile next is

00:03:51,210 --> 00:03:55,500
something that you should get you

00:03:52,920 --> 00:03:58,230
probably familiar with from the Nexus S

00:03:55,500 --> 00:03:59,790
configuration itself so you can write

00:03:58,230 --> 00:04:01,620
down which packages you want to have

00:03:59,790 --> 00:04:03,930
which file should be linked in to your

00:04:01,620 --> 00:04:06,510
home directory or which services should

00:04:03,930 --> 00:04:09,420
be running maybe system D services might

00:04:06,510 --> 00:04:12,510
be switched to user services I don't

00:04:09,420 --> 00:04:14,790
know yet but Indian it's very standard

00:04:12,510 --> 00:04:17,310
the only thing that took a little bit

00:04:14,790 --> 00:04:21,030
more effort for me it was this part here

00:04:17,310 --> 00:04:23,550
so linking files into the home directory

00:04:21,030 --> 00:04:26,250
is something I'm very careful about

00:04:23,550 --> 00:04:27,040
because your link you have the users

00:04:26,250 --> 00:04:29,050
home

00:04:27,040 --> 00:04:31,720
directory and I linked things in when I

00:04:29,050 --> 00:04:33,700
switch to a certain profile and if I

00:04:31,720 --> 00:04:36,490
switch away from the profile I somehow

00:04:33,700 --> 00:04:39,340
want to remove this links or data that I

00:04:36,490 --> 00:04:41,040
copied again and so this is something

00:04:39,340 --> 00:04:44,260
where I had to be sure that I'm not

00:04:41,040 --> 00:04:46,780
accidentally deleting stuff files that

00:04:44,260 --> 00:04:49,720
the user actually cared about and so to

00:04:46,780 --> 00:04:53,560
solve this or my idea was that I

00:04:49,720 --> 00:04:56,140
implemented a way of adding extended

00:04:53,560 --> 00:04:59,500
filesystem attributes to every file that

00:04:56,140 --> 00:05:01,900
I generated or they're linked and I

00:04:59,500 --> 00:05:04,360
tagged them with a hash of the path

00:05:01,900 --> 00:05:06,640
relative to its home directory and the

00:05:04,360 --> 00:05:08,440
initial content so that afterwards if

00:05:06,640 --> 00:05:09,700
you would change the content of the file

00:05:08,440 --> 00:05:12,940
of it or if you would move it around

00:05:09,700 --> 00:05:16,210
this could be detected then switching

00:05:12,940 --> 00:05:21,540
away from this profile so that this

00:05:16,210 --> 00:05:21,540
content in the from the user is actually

00:05:22,140 --> 00:05:28,270
for generating the files you will get a

00:05:25,390 --> 00:05:30,700
few options as well the first one is

00:05:28,270 --> 00:05:34,420
that sources can be either static or

00:05:30,700 --> 00:05:38,410
dynamic static means that whatever is

00:05:34,420 --> 00:05:41,500
within the next store is just copied or

00:05:38,410 --> 00:05:46,750
linked into your home directory dynamic

00:05:41,500 --> 00:05:48,310
means that what is stored in the mix in

00:05:46,750 --> 00:05:51,850
the next door it's more or less a

00:05:48,310 --> 00:05:54,670
function that is called with a parameter

00:05:51,850 --> 00:05:57,250
to the file that you should want to that

00:05:54,670 --> 00:06:02,560
you actually want to create so it means

00:05:57,250 --> 00:06:05,170
that dynamic sources they take the

00:06:02,560 --> 00:06:08,710
current file as input and should

00:06:05,170 --> 00:06:10,540
generate the new content as output for

00:06:08,710 --> 00:06:12,940
the files that are generated you also

00:06:10,540 --> 00:06:14,830
have two options the I began can be

00:06:12,940 --> 00:06:18,240
non-volatile which means they are

00:06:14,830 --> 00:06:21,340
protected or volatile which me so

00:06:18,240 --> 00:06:23,260
non-volatile means that if you're

00:06:21,340 --> 00:06:25,360
switching away we're checking the hash

00:06:23,260 --> 00:06:28,450
that we stored against the content that

00:06:25,360 --> 00:06:29,920
is there at this moment and if it is not

00:06:28,450 --> 00:06:32,260
the same which are stopped

00:06:29,920 --> 00:06:34,840
whereas for volatile we don't care about

00:06:32,260 --> 00:06:38,530
this initial content and we just remove

00:06:34,840 --> 00:06:40,720
the file as we expected it to change so

00:06:38,530 --> 00:06:41,379
these two options they give you great

00:06:40,720 --> 00:06:43,030
power

00:06:41,379 --> 00:06:46,030
but they also will come with great

00:06:43,030 --> 00:06:49,229
responsibility so just be warned

00:06:46,030 --> 00:06:53,770
a few more notes about it about

00:06:49,229 --> 00:06:55,900
switching the files so files itself if

00:06:53,770 --> 00:06:58,479
if the file is present in the old and

00:06:55,900 --> 00:07:01,240
the new profile this file will be

00:06:58,479 --> 00:07:04,180
switched atomically so you should all it

00:07:01,240 --> 00:07:06,669
should always be there symbolic links

00:07:04,180 --> 00:07:09,340
into the next store will always be

00:07:06,669 --> 00:07:12,159
followed so before creating the link we

00:07:09,340 --> 00:07:14,379
really resolve it to the final target so

00:07:12,159 --> 00:07:17,979
either a file or a directory or the

00:07:14,379 --> 00:07:19,599
dangling link and so this is the one

00:07:17,979 --> 00:07:22,960
thing the thing that will be stored or

00:07:19,599 --> 00:07:25,240
ever be created there is no switching

00:07:22,960 --> 00:07:27,539
atomic switching of sets of files

00:07:25,240 --> 00:07:30,490
because I couldn't give you any

00:07:27,539 --> 00:07:31,840
particular girl and he's only the only

00:07:30,490 --> 00:07:33,939
thing that I can guarantee that is

00:07:31,840 --> 00:07:35,949
guaranteed is that the order of

00:07:33,939 --> 00:07:39,990
switching from one profile to the other

00:07:35,949 --> 00:07:43,449
always deactivates unwanted services

00:07:39,990 --> 00:07:46,060
switches the resource files or final

00:07:43,449 --> 00:07:50,289
resources and then activates the new

00:07:46,060 --> 00:07:53,889
services and the best thing about it it

00:07:50,289 --> 00:07:56,020
it's almost done so I will need a little

00:07:53,889 --> 00:07:58,180
more help about with testing and

00:07:56,020 --> 00:08:01,029
especially security review and writing

00:07:58,180 --> 00:08:05,319
documentation but I'm very confident

00:08:01,029 --> 00:08:05,830
that this can get done so thank you very

00:08:05,319 --> 00:08:10,089
much

00:08:05,830 --> 00:08:12,099
and before I stop talking I take the

00:08:10,089 --> 00:08:15,699
chance to talk about what I want to work

00:08:12,099 --> 00:08:19,300
on next so the next thing I want to work

00:08:15,699 --> 00:08:21,939
upon is about managing States indexes so

00:08:19,300 --> 00:08:24,159
Nix is is this wonderful purely

00:08:21,939 --> 00:08:27,149
functional Linux distribution for

00:08:24,159 --> 00:08:29,469
installing packages but what about

00:08:27,149 --> 00:08:31,930
executing the services that you install

00:08:29,469 --> 00:08:34,690
so we all know about what guarantees do

00:08:31,930 --> 00:08:36,370
we have that once we want to execute a

00:08:34,690 --> 00:08:40,419
service that it has actually the right

00:08:36,370 --> 00:08:43,209
data to operate on so you always know

00:08:40,419 --> 00:08:44,920
this procedure you are this this let's

00:08:43,209 --> 00:08:50,290
have some happening you upgrade your

00:08:44,920 --> 00:08:53,079
software as a database server gets

00:08:50,290 --> 00:08:54,910
upgraded it executes for the first time

00:08:53,079 --> 00:08:56,290
it upgrades your database

00:08:54,910 --> 00:08:58,600
and then for whatever reason you want to

00:08:56,290 --> 00:09:00,640
roll back and you can't discuss your

00:08:58,600 --> 00:09:02,410
data is already nearer than the version

00:09:00,640 --> 00:09:04,540
of your software that you want to switch

00:09:02,410 --> 00:09:06,280
to so how can we prevent this from

00:09:04,540 --> 00:09:09,520
happening that's the thing that I want

00:09:06,280 --> 00:09:12,370
to work on and mine export checkers

00:09:09,520 --> 00:09:14,350
obvious and we are here is that we I

00:09:12,370 --> 00:09:18,040
could we could maybe just annotate

00:09:14,350 --> 00:09:20,290
resources within that within our mixer s

00:09:18,040 --> 00:09:24,040
configuration list cut some kind of text

00:09:20,290 --> 00:09:26,230
types that we collect during the build

00:09:24,040 --> 00:09:29,250
of the new operating system of the

00:09:26,230 --> 00:09:33,220
configuration and that we check before

00:09:29,250 --> 00:09:35,020
we activate this so this is something

00:09:33,220 --> 00:09:37,270
that probably requires another

00:09:35,020 --> 00:09:41,460
conference for me to get started but

00:09:37,270 --> 00:09:41,460
that's it thank you very much

00:09:47,200 --> 00:09:57,800
any questions so in the original

00:09:55,300 --> 00:10:00,350
configuration paid you showed on the

00:09:57,800 --> 00:10:02,270
first page it basically specified a path

00:10:00,350 --> 00:10:05,390
into the home directory where the Knicks

00:10:02,270 --> 00:10:06,950
up config was for that user what if you

00:10:05,390 --> 00:10:08,960
wanted to use this with something like

00:10:06,950 --> 00:10:11,630
Knicks ops where when you do a Knicks

00:10:08,960 --> 00:10:15,110
ops deploy it grabs your configuration

00:10:11,630 --> 00:10:20,840
file from the local repo and sets up the

00:10:15,110 --> 00:10:26,300
home users directory okay I couldn't so

00:10:20,840 --> 00:10:28,100
sorry so um on the first page your slide

00:10:26,300 --> 00:10:34,670
you showed a or it might have been the

00:10:28,100 --> 00:10:37,910
second page you showed right next one

00:10:34,670 --> 00:10:40,820
the one with the brown and it that one

00:10:37,910 --> 00:10:43,820
there no right back dot config Knicks up

00:10:40,820 --> 00:10:46,520
profile mix so I'm assuming that's

00:10:43,820 --> 00:10:49,670
basically a file that the user would put

00:10:46,520 --> 00:10:51,110
in their home directory what if you

00:10:49,670 --> 00:10:55,580
wanted to use this with something like

00:10:51,110 --> 00:10:57,860
Knicks ops for remote instances where

00:10:55,580 --> 00:11:00,200
you wanted to basically manage some

00:10:57,860 --> 00:11:02,780
files in a single users home directory

00:11:00,200 --> 00:11:05,660
using this tool but you wanted that

00:11:02,780 --> 00:11:08,210
declaratively defined on the system

00:11:05,660 --> 00:11:11,000
where you're actually using it so so you

00:11:08,210 --> 00:11:13,850
mean you want to be finding the OS

00:11:11,000 --> 00:11:17,540
configuration you want to define them

00:11:13,850 --> 00:11:21,260
like the deployment dot next file in

00:11:17,540 --> 00:11:26,930
like Knicks ops so basically instead of

00:11:21,260 --> 00:11:28,730
having the mix-up config file on the

00:11:26,930 --> 00:11:30,530
system itself you want the Knicks up

00:11:28,730 --> 00:11:32,030
config file defined where you're running

00:11:30,530 --> 00:11:35,000
Knicks off yeah and this is that

00:11:32,030 --> 00:11:38,360
possible or you know it's plan its plan

00:11:35,000 --> 00:11:41,060
so so now I just want to get it in man

00:11:38,360 --> 00:11:43,580
get this basic feature and then it

00:11:41,060 --> 00:11:47,450
should be possible to also have some

00:11:43,580 --> 00:11:49,190
declarative configuration within the

00:11:47,450 --> 00:11:52,370
operating system configuration as well

00:11:49,190 --> 00:11:53,990
so I think this I hope without knowing

00:11:52,370 --> 00:11:58,780
it but I guess this would resolve this

00:11:53,990 --> 00:11:58,780
issue as well ok last question

00:12:00,660 --> 00:12:06,790
well hello I have a simple question

00:12:04,630 --> 00:12:09,610
could you summarize what are the

00:12:06,790 --> 00:12:12,360
limitations of your implementation at

00:12:09,610 --> 00:12:17,170
the moment just summarize limitations

00:12:12,360 --> 00:12:23,940
and if there are any as compared to the

00:12:17,170 --> 00:12:25,900
system way of declaring sister packages

00:12:23,940 --> 00:12:29,910
I'm absolutely sure that their

00:12:25,900 --> 00:12:54,970
limitations could you which ones are you

00:12:29,910 --> 00:12:55,860
thinking about and that's a very good

00:12:54,970 --> 00:12:58,860
question

00:12:55,860 --> 00:13:06,880
[Laughter]

00:12:58,860 --> 00:13:08,800
so yeah we will see we will see it's

00:13:06,880 --> 00:13:10,750
it's so the implementation is very new

00:13:08,800 --> 00:13:14,980
we need a lot of people to test it and I

00:13:10,750 --> 00:13:18,040
think they they have to tell me because

00:13:14,980 --> 00:13:19,779
they are it's the same issue as putting

00:13:18,040 --> 00:13:22,209
secrets into the year in excess

00:13:19,779 --> 00:13:24,940
configuration so tonight we can talk

00:13:22,209 --> 00:13:28,589
about it on the drink yeah

00:13:24,940 --> 00:13:28,589
I think there was one last question oh

00:13:30,600 --> 00:13:34,860
okay thank you very much

00:13:37,040 --> 00:13:39,100

YouTube URL: https://www.youtube.com/watch?v=RpuUrORZr-M


