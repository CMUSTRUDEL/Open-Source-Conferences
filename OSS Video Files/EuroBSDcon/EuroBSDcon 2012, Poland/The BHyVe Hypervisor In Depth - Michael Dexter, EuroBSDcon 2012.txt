Title: The BHyVe Hypervisor In Depth - Michael Dexter, EuroBSDcon 2012
Publication date: 2012-12-07
Playlist: EuroBSDcon 2012, Poland
Description: 
	EuroBSDcon 2012
Warsaw, Poland 18 - 21 October
Captions: 
	                              Jean Dubreuil good morning hope you're                               all feeling well first thing Sunday                               morning my name is Michael Dexter and I                               have taken upon myself to document the                               beehive hypervisor and i will give some                               background and my goal today is to whet                               your appetite as they say and to make it                               easy for you to give it a try and                               hopefully begin developing on it so a                                little background on beehive who's                                familiar with an unconference ok Fred so                                an unconference is a novel idea where                                you congregate you typically put up a                                giant board and have stick on messages                                and you propose topics you announce your                                topic in front of the group put it up                                and through a combination of voting and                                rearranging and horse trading you come                                up with a schedule the few people have                                prepared slides and it's a remarkably                                effective tool for getting an up-to-date                                topic discussed so meet PSD California                                took place in                                                         next month it's an unconference format                                with a few prepared sessions and you                                congregate your proposed you break out                                into sessions and if you're lucky repeat                                the next day so you're doing it wrong                                somehow at meet BST                                                     to attend the virtualization session I                                had never seen that everyone got in a                                room every breakout room was empty and                                we discussed virtualization so one                                hundred percent attendants there like                                the vendor summit meeting there was a                                small intimate discussion the next day                                after everyone had time to think about                                what they discussed and the conclusion                                was we need a hypervisor and as always                                we have no idea who will pursue that                                so the result at the fckn                                          nattu and Peter grillin at the dev                                summit announced beehive to a rather                                stunned audience and you can find their                                slides on the freebsd wiki and there is                                an audio recording of that maybe a video                                i suggest you check them out and a                                history of my involvement about six                                months after PFC can i said hey that's                                pretty cool what's going on and they                                have day jobs and i said well it's out                                there and yes we can help you get it get                                going so at my little journal i put up                                an article on beehive demonstrating                                everything I've learned to date and how                                to build it and in april i set up                                behaved org simply as a repository and i                                should have a special thanks to the new                                york city PSD users group who has some                                storage space for some prepared guest                                images because throwing around                                        hundred megabyte images is not something                                for everyone server there wasn't there                                was a google summer of code project the                                summer that is not completed because a                                developer ran into an issue towards the                                end hopefully that will complete and it                                is a project to include a bios for                                supporting foreign operating systems so                                if you're not familiar with the                                convention too long didn't read for                                those of you who want to run it requires                                intel extended page tables guests are                                booted from disk images unlike jails                                which are typically from a file system                                jhb Jon Baldwin recently made some                                changes to the assembler entry that                                allows for the existing gplv                                         assembler to include the new instruction                                sets the bin utils package is gplv                                     that concerns the number of people it's                                close to being ready to be dropped into                                head but not yet there's a bit of a                                chicken and egg issue so I want your                                involvement to hopefully push that over                                the top it can be dropped into nine                                point out quite reliably and I'll show                                that and it's easiest to test on freebsd                                                                                were patches                                                           I checked so the fire has been lit under                                them the developers and it began life at                                previously                                                           possible with some workarounds from                                seven to forward which might be quite                                attractive to those with say embedded                                products and who want to contain them on                                newer host operating systems it should                                build was clang quite easily and I                                 haven't tried this but for those with                                 max reportedly vmware fusion on the                                 Macintosh has vtx and perhaps v TD pass                                 through such that you can run this in                                 virtualization on hardware that supports                                 it if you do in VirtualBox you'll find                                 out that is the pre generic pc without                                 extended page tables that's a cool trick                                 so in context and which touched on this                                 briefly before the talk the proprietary                                 and dominant players VMware quite a few                                 hands came up for those using that it                                 contains busy box and I challenge any                                 user to get sources from the vendor and                                 build busy box and put it into your to                                 your VMware instance as per the terms of                                 the GPL they may be violating it and                                 that could be a mess Linux has the kvm                                 hypervisor which is the closest of                                 closest work like closest designed to                                 beehive they also have alexey containers                                 which were inspired by freebsd jails                                 they have a few interesting features and                                 are missing a few features so it's sort                                 of the linux jail smart OS a a                                 derivative Lumos formerly open solaris                                 has the linux kvm hypervisor that they                                 imported they have zones which were                                 clearly inspired by freebsd jails                                 they've added new features new features                                 and they actually run their hypervisor                                 in a in a zone such that if you break                                 out of it you'll you're stuck in his own                                 freebsd has made the most progress as a                                 as a guest on say amazon                                 c                                                                       going on but I'm not clear if the                                 previous tease n host is fully up to                                 speed and not should you want that an                                 honorable mention at the SD Zen the                                 classic open source hypervisor it is                                 large it is reliable but you can see my                                 multiplicity talk for a little more                                 about that so in context what is this                                 hypervisor thing quite some time ago I                                 was a year old Papa King Goldberg                                 defined a hypervisor back on in IBM                                 mainframe hardware where they were in                                 Hardware accommodating previous                                 generations of the system so they define                                 the formal requirements for a hypervisor                                 and the the qualities you look for the                                 properties you look for now it doesn't                                 help to get too caught up in different                                 types of hypervisor type one is a                                 dedicated kernel and user land which is                                 generally off-the-shelf parts such as                                 vmware and it launches then come your                                 guests a type two is something that is                                 built under some form of host operating                                 system one can argue that the                                 intricacies are hidden in the host                                 operating system but FreeBSD is rather                                 proven that is Alastair crooks pointed                                 out yesterday more data has gone through                                 FreeBSD thanks to netflix than any other                                 OS so I wouldn't get too concerned about                                 the risks of type                                                   properties of a good hypervisor are                                 equivalents fidelity basically it should                                 look like the host system that's running                                 on and that raises the question of does                                 the guests need to be modified in any                                 way or can it simply be installed from                                 an ISO image and booted as if it's in a                                 nice friendly familiar system resource                                 control is the hypervisor indeed control                                 of the guests or is there a risk of it                                 running free and monopolizing resources                                 and efficiency primarily compared to say                                 a software emulator where there's a                                 significant significant performance drop                                 a hyper                                 I should be near native performance                                 because you are using Hardware                                 extensions to get as close as you can to                                 a proper experience and the Wikipedia                                 pages are pretty good not great but good                                 so hardware-assisted virtualization this                                 is in the words of peter yesterday                                 beehive is all built on V TX exits they                                 are used to build the pti emulation                                 since I of instructions are used for pc                                 i can take space you may read that the                                 biggest breakthrough was the extended                                 page tables that were introduced with                                 nehalem hardware from intel and is                                 that's basically core i                                        generation forward I'll touch on that                                 and newer systems but EPT was a                                 breakthrough and as I've joked before                                 let's party like it's                                                 finally have a pc with some tiny                                 mainframe features so hardware-assisted                                 assisted virtualization the V you've                                 probably heard the buzz word vtx v TD                                 and others and seen it show up in your d                                 message so systems have had vtx for                                 quite some time since i think even                                 pentium                                                           privileged instructions and grabs them                                 and things such as page mrs. and all                                 were handled in software recently intel                                 added virtualization for directed i oh                                 so that hardware devices can be masked                                 out from the host system and provided to                                 a hypervisor and the extended page                                 tables replace a large amount of mmu                                 software emulation in hardware and that                                 is a major performance improvement                                 source and i believe like many of these                                 technologies like AMD                                                  these and they're out there and beehive                                 can support them in theory but it's a                                 matter of just a few developer hours so                                 if you have a system you can try this                                 here                                 you've probably seen the vmx little                                 feature for quite some time the one to                                 look for is pop count that is not the                                 best choice of a phrase it could be                                 mispronounced and traditionally and I                                 believe in all cases hop count includes                                 EPT in any of the similar generation                                 processors quite recently intel has                                 kindly added a EPT compatibility on                                 their site and i'll get to that so                                 nehalem sandybridge ivybridge systems                                 most core systems that start with an i                                 but they've complicated by adding                                 celeron and pentium systems which is a                                 surprise so I                                                            the Gion processors from that generation                                 perhaps all although there's eons back                                 to                                                                       this context surprisingly let's see                                 pentia mobile and celeron processors and                                 v TD is available on generally higher                                 end processors so i'll show you how to                                 find that out some vendors will have a                                 bios option to enable or disable the vtx                                 features why I don't know so I don't                                 know what harm they would do and                                 potentially a vendor might block them                                 out entirely from your system even                                 though it's on the cpu blue pill fair                                 enough                                 so art intel com is your friend core                                 processors get all the attention and I                                 was surprised to find a Pentium                                 processor with extended page tables and                                 btx so for about the last year at the                                 very bottom of those processor                                 descriptions they've included EPT                                 there's absolutely no graphic matrix                                 with all the processor names the                                 wattages the EPT and the price that                                 would be too convenient you know what                                 I'm talking about so the assembler                                 implications I've touched on this                                 earlier so if I want to recap too much                                 but previously has had a somewhat older                                 binutils assembler because it was gplv                                  licensed you could add the gplv                                  versions newer one that includes support                                 for the EPT instructions but that would                                 never make it into base key points so                                 for quite some time one would just drop                                 that in which seemed to be version                                       to underscore or three but Jon Baldwin                                 implemented the missing instructions                                 everyone thought it would be way too                                 hard and take forever but no we just did                                 it and if you look at the freebsd                                 revision                                                              will see those changes and those changes                                 can be dumped on a a                                                  build in utils and it works just fine so                                 here's a brief description of what he                                 changed just those instructions for                                 those who care                                 so here is how I pulled those in you'll                                 find that in the different revisions                                 some were updated later so you have to                                 pull all of them twice I just pulled out                                 these five of them and it worked hop in                                 there and build it and you have a                                 working assembler this makes life much                                 easier so the versioning moving target                                 he had began life with freebsd                                         so I've found freebsd                                                 point of reference although I started my                                 work before even the release was out so                                 it's it's very good to have a fixed                                 point of reference to which one can say                                 it works or doesn't work so since nine                                 there have been a number of floating                                 point changes and beehive is slowly                                 catching up and of course that's all in                                 head so freebsd                                                       they have not yet set up a build system                                 and they would like to have I so's built                                 and he mentioned hosting them maybe at                                 all bsd and my first logical thought was                                 okay i will build the current one make a                                 release and try it and spending a half a                                 day doing that each one and then having                                 it blow up on me and i knew there had to                                 be a more efficient way to test for                                 regression so my solution start with                                    release and fortunately pc-bsd                                       freebsd                                                                  can work with them and do presentations                                 and and hypervisor at the same time demo                                 on the build environment beehive is tiny                                 and building world for as you'll see a                                 very small amount of components is a                                 waste of time and resources and SSD                                 kicks so I came up with a way to                                 one not touch the included release                                 source directory with the help of all                                 Union FS mounted to a similar one which                                 is source beehive drop from svn the                                 changes which are not very large and on                                 an SSD system put a memory device for                                 object so I'm just blasting the results                                 into ram and if you unmount that unfs                                 you get to see essentially a diff albeit                                 binary of what was changed very cool so                                 here are the components of beehive there                                 is a just three user facing utilities                                 user actually I think that's yes NS been                                 beehive beehive load and vmmc TL I've                                 given the link of the sources in source                                 what directory there in there is a                                 library that's used which is in user                                 source library l lib vm m api which has                                 a number of components and there the                                 blue ones are visible you'll see them in                                 your file system they're not like built                                 into the kernel and the red ones are                                 actual utilities that you can call that                                 you in fact will only call beehive which                                 you include beehive load and vmmc TL and                                 pretty pretty elegant and the modules of                                 emm KO colonel so currently guests must                                 be modified just a little bit it's                                 running freebsd on freebsd so it's it's                                 not monumental it's important to have MP                                 table even though for each of the                                 versions that in time will change there                                 is the BBM console which simply means it                                 starts booting and jumps in your own                                 console and it's just a as they put it                                 bring dead simple console the x                                       support which is for performance so it                                 may be optional but you want it MP                                 mocked up and the colonel configuration                                 file which simply has the console and mb                                 table and when they get a CPI working                                 that                                 we'll go away not a whole lot of changes                                 and anyone who's built freebsd you can                                 figure these out so helping the guests                                 are verte I oh and there are a number of                                 Burt IO projects out there this is the                                 one from Brian event occur I'll guess                                 Germans in the audience help me there um                                 not to out of Japan and there is the tap                                 network device which allows a guest to                                 have networking and you build a guest                                 without modules because it will not be                                 looking at hardware it's simply in a                                 little contained environment so this is                                 the file layout use built a jail in the                                 past that's basically a user land here                                 is a user land in a disk image which can                                 either be just dev or MD root for memory                                 back image the colonel is external to                                 the guest file system a bit like Zen                                 where you point it at a colonel and say                                 go to town divert IO modules are outside                                 of that environment and the boot                                 director is pretty much off the shelf I                                 copy it from the host and it works and                                 user boot esso required by the utilities                                 and the red is a heavy lifting where you                                 must build the colonel and prepare your                                 disk image but and you can use whatever                                 tricks you like be it even now no bsd                                 are otherwise to build that user land                                 it's simply a freebsd user land so host                                 preparation arm currently one must                                 deduct memory from the host to allow it                                 to be used by guests and one does that                                 with the HW phys mem property there's                                 two takes a an eight gig or                                        system down to four gigs to the host                                 operating system and allow the rest to                                 be available to guests currently                                 beehives a bit noisy so there's the you                                 might want to suppress some debug output                                 and the last ones can be done from the                                 online such as load the dmm kernel and                                 set up your networking pretty                                 straightforward so this is what my                                 system puts out if I've done the entry                                 real memory and available memory if I'm                                 now down to four gigs out of                                            amazed how affordable memory is right                                 now just let the record show so from the                                 beginning neil has had a very simple                                 downloadable guest image it has a few                                 shortcomings in my opinion it is md                                 route backed meaning it's a memory file                                 system meaning any changes you make                                 vanish upon reboot and it's like                                     percent capacity so you can't really                                 drop anything exciting in there and test                                 that and for what it's worth to                                 accommodate using a large md root                                 there's a kernel option you probably                                 want to set that the system is fine with                                 that so here is the boot string and neil                                 has kindly provided a captive script                                 that simplifies this but for development                                 purposes I wanted as verbose as possible                                 you can see the user land utilities vmmc                                 TLB have load and beehive that are                                 simply available in s bin variables such                                 as the name of your guests and memory                                 allocation I believe above and below the                                 i                                                                     the networking interfaces and I found                                 that I needed to sleep ifconfig weight                                 to the system boots then launch it so                                 you can have networking and we'll get to                                 this later but yet boots like a freebsd                                 system it is freebsd on freebsd and                                 that's just a capture from my console so                                 shut down you can shut down a reboot if                                 you do reboot it'll give you the splash                                 screen hit escape type quit and it'll                                 drop back into your post coach console                                 and I mentioned not wanting to build                                 world all afternoon did it through                                 Thanksgiving and family didn't like that                                 so to build these components ala carte I                                 had to do a few tricks one is dropping                                 in from svn the modified components for                                 bee hive on topless on top of the source                                 tree and again that I did with the Union                                 FS mount I had to do a few make file                                 changes just so that they could build                                 incite us as opposed to in the full                                 build world and several of the utilities                                 needed machine linked in there so it                                 knows where the heck it is so building                                 the guest image again use your preferred                                 jail building technique I simply made a                                 disk image                                                               at three md config labeled it mount it                                 on mount and over the wire fetch the                                 release and just drop it on top you                                 could probably do the same with the                                 pc-bsd basic release but it's probably a                                 lot larger I did take time to get the FS                                 tab right Marcia conf if you have want                                 networking resolved comp and ttys                                 because you're going to a console and a                                 console it's not complex but it needs to                                 be done and I've scripted everything to                                 do that and you might want to enable ssh                                 login for further testing although you                                 do see the booted console into your                                 console now how you get there I've had                                 beehive menu SH out there for quite some                                 time hopefully by the end of the day                                 I'll update the rest of these I've done                                 it all the cards you can see exactly                                 what's happening I want to be very                                 verbose about this so there's no magic                                 to worry about prepare the sources like                                 the union FS mount patch the assembler                                 build the assembler copy it in and patch                                 the loader for the memory reduction so                                 this was a quotation from a little while                                 ago theater at was a bit concerned that                                 x                                                                  placing another nearly full colonel full                                 of new bugs on top of the nasty x                                   architecture which barely has correct                                 page protection then running your                                 operating system                                 on the other side of this brand new pile                                 of stuff you are absolutely diluted if                                 not stupid if you think that a worldwide                                 collection of software engineers who                                 can't write operating systems or                                 applications without security holes can                                 then turn around and suddenly right                                 virtualization layers without security                                 holes Theo Dirac so the heavy lifting of                                 beehive is vmx see which does all the                                 bit banging for the extended page tables                                 and vtx functions I downloaded it I                                 sorted it dump the comments dump the                                 spaces and                                                           small and in my process I build a simple                                 package of the user land utilities the                                 the kernel module and all that and                                 thought wait I should check this and                                 it's                                                                     a Meg so again who's run vmware who's                                 runs in who's run all the alternatives                                 that you can keep in your head this is                                 good the future so I got some comments                                 from Peter last night planning may pick                                 tables I'm not a developer some of this                                 is simply internal features and of                                 course through the course of this                                 intel's releasing new features so and                                 freebsd simultaneously so beehive has to                                 catch up with the two of them but                                 generally the result is very good i                                 think just yesterday neil contributed                                 the either first part of or all of                                 guests idle detection currently a guest                                 will monopolize the cpu at one hundred                                 percent that will drop down to nothing                                 if the guest is doing nothing I see ahci                                 device emulation verte I OMSI support if                                 you if you're familiar with those that                                 will make sense I sure hope after you                                 will complete his work let's work on him                                 it's exciting stuff he he took on a hard                                 challenge bus is hard I cornered him in                                 a bar in Tokyo and said hey can you put                                 this to openbsd and instead he's doing                                 bio switches would be a killer app to                                 have say                                 windows or linux booting natively on                                 beehive so good props his way more emil                                 more internal goodies and md support                                 which is straightforward of using nested                                 page tables instead of extended page                                 tables are our VI as they've renamed it                                 and all these technologies get renamed                                 by the marketing department every few                                 months on the horizon better integration                                 with the ho scheduler memory over commit                                 such that you can convince a guess that                                 it has a gigabyte of memory and really                                 only use what's what's being used like a                                 like a sparse disk image and on that                                 note sparse disk images and i haven't                                 tried this but it should work with z                                 vols right now very cool um Burt io has                                 been developed in parallel and the                                 developer is not a key a core committer                                 so it's been a bit of a game getting it                                 into freebsd and then further in the                                 beehive and a generalization of the cpu                                 ids if you stay boot a guest on your                                 little core i                                                         your z on down at the data center if                                 some of the cpuid issues are generalized                                 anonymized whatever the guests will not                                 care that it's on a different cpu                                 currently it will say oh my gosh what                                 happened what have you done to me my                                 to-do list um pci pass through it's a                                 bit frustrating that not all hardware                                 has the v TD extension so when you're                                 shopping for a notebook or something                                 look pretty carefully it at art done in                                 telecom if it has the v TD extension                                 there's the syntax you find out what the                                 device is you use the black hole driver                                 to mask it from the host operating                                 system so the physical card is there the                                 OS ignores it i think we'll get to the                                 proper term ill it probes it says okay                                 let's not talk to you                                 on and then when you're launching the                                 Beehive guest you add the dash F option                                 and tell it what card or device what pci                                 device to go after all so you can                                 redirect to a serial console for what                                 it's worth and somewhat excitingly nano                                 beehive so I'm impressed with free nests                                 and                                                                      quite simple and for all those who have                                 their like VMware served by a nice cozy                                 machine could have the hypervisor on                                 that little flash card I'm excited and I                                 don't know who saw the Christmas worden                                 talked yesterday it should be quite                                 simple to include beehive support                                 instead of a freebsd jail instead of a                                 linux jail have a beehive jail that's in                                 the works and mmm dog food I actually                                 did this running pc-bsd on my little                                 refurbished thinkpad and use LibreOffice                                 it was a bit painful at times but I'm                                 happy to do that and I'll do it a little                                 live demo any questions here and now                                 impossible                                 yes that's the the heart of it and there                                 have been oh there was a past project                                 years ago that was a simple bios for                                 another purpose and that might be usable                                 um you've probably seen that I think                                 it's Zen and even kvm use a lot of the                                 qemu components they have a more                                 compatible licensing and they're                                 probably big bloated components but                                 that's the heart of it um adapting                                 another bsd to boot shouldn't be too                                 difficult it's mostly just loader issues                                 and it's it's far more familiar than say                                 windows I hope that answers your                                 question other questions                                 more people interested Neal and Peter                                 have day jobs and they blast out what                                 they can but again it's a bit of a                                 chicken and egg issue if they're three                                 of us using it having that you know tiny                                 user group is a bit limiting so do get                                 out there there's there countless                                 opportunities to improve it from                                 packaging I just throw things a little                                 tarball in the directories and it's                                 definitely not a correct freebsd package                                  but it works so uh vendors look at                                 the code it's it's not big test it see                                 what hardware it works on brakes on I                                 haven't had incompatibility issues do                                 check out my site call for testing org                                 and behaved or guy again described where                                 the utilities are how they're built what                                 they do and just familiarize yourself                                 because again it's not a lot of code                                 fair enough other questions you will see                                 that the post system it has access to                                 about both the video almost just over                                 three gigabytes of memory out of                                         stat e above all the VMM kernel driver                                 is running and                                 the disk dev is a four hundred megabyte                                 disk image that I've built the scripts                                 the boot directory is quite familiar                                 there's the host OS there's pc-bsd has                                 quite a few added components but the                                 beehive guest boot is quite simple there                                 are the colonel mostly vert I obits and                                 a colonel so as I mentioned earlier one                                 can one cannot reduce host memory on the                                 fly one has to reboot but one can                                 obviously load the kernel modules so I                                 have a very simple script vm prep that                                 does that preparation and and as I                                 described in that breakdown of the                                 command vm run                                 today sorry I suspense is killing it                                 that is beehive it's strictly freebsd on                                 freebsd will funny treatment of the                                 border there no biggie you'll see that                                 vert io drivers fly by and what do you                                 want top it's running a standard base                                 installation I didn't try doing the                                 networking through the wireless so at                                 the moment I cannot I cannot probably                                 network you will see that it is                                 consuming the processor however the                                 patches went in in this in hopefully the                                 full solution just literally within the                                 last                                                                   to near zero percent tada                                 and do catch me in the hallway etc and                                 I'll help set you up with it let's we                                 have just a moment so let's see midori                                 web                                 short come from                                 okay at beehive org you will find the                                 images I booting from right here it's                                 the four hundred megabyte image thank                                 you nice bug and the                                                     that bill link to the presentation and I                                 will get my my ala carte scripts up                                 there as soon as possible there is a                                 wiki entry page but it's it's hit or                                 miss because the developers through in                                 the few of their napkin notes and what I                                 started with was literally their own                                 notes themselves that were not ready for                                 consumption on the outside my article on                                 the subject and the mailing list is the                                 best place to discuss it there is no                                 dedicated beehive mailing list                                 yep                                 and oh this is like Sherman so thank you
YouTube URL: https://www.youtube.com/watch?v=4d0rLrgArHw


