Title: FreeNAS system architecture - John Hixson, EuroBSDcon 2012
Publication date: 2012-12-07
Playlist: EuroBSDcon 2012, Poland
Description: 
	EuroBSDcon 2012
Warsaw, Poland 18-21 October
Captions: 
	                              hi I'm a Don Hickson I'm with Iook                               systems and I'm going to do a talk about                               freenas I'm going to do it A Thousand                               Foot level overview of how free nose                               looks if you're programming court all                               right the reason I'm doing this talk is                               to get more people on board we we don't                               have a few that work on it currently                               we'd like to get more people involved                                and we'd like to give people more                                knowledge than what's available in the                                current documentation the current                                documentation is basically how to use                                free knows there's not a whole lot                                available on how it looks coming in as a                                software engineer so first things first                                we use nano VSD and all all that nano                                BST brings you know that we have the                                build script and we we've modified it                                quite a bit to include PBIS along with                                other extensions we've added targets                                that it builds we have we have several                                build targets we have the freenas build                                target so we build the frenos image we                                have a jail image that we build for the                                plugins and then we have plugins that we                                also build and all of those are part of                                the build system and do build SH does                                all of that for you                                so in when you check out the source code                                Dupree knows you know you check out the                                branch right under the branch you have                                nano bsd and under nana bsd you have                                these are the configuration files that i                                just spoke about OS space is your                                configuration for free knows itself it's                                just it's just a nano bsd config file                                with all of our freenas courts and                                customizations plug in space same thing                                but for the plugins jail the plugins joe                                is a ppi and underneath the plugins                                directory that's where if you have a                                plug-in currently we have three plugins                                but if you have more you just add more                                files in there and then again those are                                nano bsd configuration files and then                                under the files directory that contains                                basically the freebsd hierarchy you have                                user local etsy all of that until you                                any any files you want placed into those                                directories on free now is you're going                                to place under there currently we we                                only have a few together in there most                                of its stock freebsd alright so when you                                kick off a free now's build the first                                thing it does is you have to divine the                                freeing as our freebsd CVS sub post and                                it will either use CBS SF if sub                                versions available italy subversion if                                model ease CBS CBS up and it'll grab                                this pre bsd source code and once it                                does that it just we have a patching                                directory and I think that's the next                                slide and it'll go through noodle fly                                all of our local freebsd patches and                                ports patches and that's right here so                                under the patches direct reads any any                                patches you have for freebsd they go in                                here in that format dot patch                                and for the plugins tail and plugins as                                I said reason pbi we're using the same                                TV format that Chris that peep pc-bsd                                uses so not quite yet currently we're                                free now's is on eight and we're using                                version                                                                take an eight pbi and use it on freenas                                nine but once once we move to nine on                                preen ads you'll be able to take PB is                                from pc-bsd and use them on pre now's                                the installer more we've taken more from                                pc-bsd they give us so much good stuff                                we keep taking more we wrote a print end                                it's just a shell script that generates                                the back end PC system stall config file                                and then we just use pc sis install to                                install that image and freeing as its it                                builds an image and it writes it out the                                disk it's it doesn't do any kind of                                partitioning if you have a large hard                                drive so you know we right now it's at                                two gigs and if you have a you know a                                   gig hard drive                                                       it's going to use the whole thing for                                green eyes but you're only going to see                                two gigs so use a flash drive freenas                                uses the ingenious web server engine X                                I've always called it in genomics we we                                used to use light HTTP we switched in                                engine X we like it it's faster it's                                 better it's pretty straightforward we                                 don't do anything weird with it we use a                                 fast CGI for the plugins that's the only                                 semi weird thing plug so plugins get                                 installed in the jail as a ppi and then                                 every plug-in has a a web interface and                                 then that has to be able to speak with                                 external to the jail to the Indian                                 xserver through fast CGI oh I'm sorry                                 and then it's only engine X only serves                                 the static content all the dynamic                                 content comes from django django early                                 on django was chosen i mainly because                                 model-view-controller you know and all                                 of that height and it's pretty cool                                 because every everything you seen the                                 free nose interface it's represented in                                 django as a as a model so you get you                                 know this really cool mapping from                                 python classes that are mapped directly                                 to the database i'm sure you know Ruby                                 does that I'm not familiar with the                                 other ones but I think it's pretty cool                                 and and Django you you have models views                                 and forms so the model is a python class                                 and then you have a form view and then                                 you have the view although I don't think                                 it's actually a view it's what it's                                 called you but it's where all of the                                 methods get called that handled the data                                 once it's submitted I think the actual                                 view and Django is the template files                                 which is your static content that has                                 filled in dynamically I guess you would                                 call the heart of Reno's is the notifier                                 the notifier is this it's this                                 gargantuan spy pond class that has a                                 method for everything we it started off                                 it was supposed to be you know kind of                                 small but we kept adding to it and                                 adding to it and adding to it and so now                                 we you know we would like to rewrite it                                 it should we'd like to make it a demon                                 and but for now it's this class and                                 pretty much everything you do in the                                 interface it makes a call to the                                 notifier everything you know rather your                                 gfs you know anything you do with                                 configuring ZFS your inner                                 this is you know all of it it's down at                                 the bottom it's making a call to                                 notifier and that's the notifier sure                                 okay so yes so but you have to you have                                 there's some you have to enable some                                 various various logging it's not just a                                 click this button and okay I could watch                                 it go from the web interface down to the                                 bottom you know of the shell you you                                 have to log I mean you can turn on some                                 stuff goes out the prologue messaging                                 you could turn on some verbose lock and                                 you can turn on debug logging Django has                                 its own logging so there's a couple                                 things involved so if you're working on                                 a particular field you can turn all of                                 that on and you'll get a good idea but                                 if you're just coming in you know                                 anything okay what does this do you know                                 it's it's not as cut and dry as that we                                 use sequel light small fast we don't                                 need anything crazy and it also it's                                 also the mechanism that we use so when                                 we when we update so that the data                                 persist because upgrades wipe out                                 everything so if you have any local                                 files in your file system anything it                                 goes bye-bye you know you it's wiped out                                 so everything that you want to keep                                 either back up or put it on to a volume                                 or it's stored in the sequel light                                 database okay so boot this is just nan                                 obsd booting and you have your / comp                                 base and then you have you know bar at                                 sea and memory disks are created for                                 each each of those and then all the                                 content from those it's copied over to                                 the memory disk and then afterwards                                 users mounted read-only and then the                                 volumes that the bawdy ins are mounted                                 on / mount                                 etsy.com of you know it's rc                                             that's where we store all of our preen                                 as variables RC comp local that has a                                 lot of the freenas configuration when                                 you boot that's where most of the like                                 you're never configuring your route you                                 know all of that happens in the RC comp                                 local and then in our CD we have a                                 series of I x-files perhaps those should                                 be renamed you know perhaps however                                 there there I X and those are all of our                                 pre Archie scripts as in they they                                 retrieve data from sequel light you know                                 and then they generate some sort of                                 config file i'll be going over these                                 like you know NSS switch hosts you know                                 all of that comes from an IX file it                                 generates it and then it continues to                                 boot as normal and then net CLA I that's                                 our our little shell you don't have to                                 run it but by default that's what comes                                 on and that's the menu you know one                                 through whatever it is that gives you                                 the options to configure your interfaces                                 and why not from the command line system                                 okay here here we're going into the                                 interface so system it's you named ina                                 say nothing fancy there none of it's                                 stored or retreat from the database in                                 under network for global configuration                                 on those network global configuration is                                 the sequel light table pretty much your                                 default you know your dns default route                                 just the standard configuration you do                                 when you first get your free nice box                                 and one i configure it                                 and their interfaces again it's just a                                 another sequel I'd table your standard                                 in you know IP address mask nothing                                 fancy we have a python class that grabs                                 all of that information it's not                                 necessarily in the database some of it                                 could be if you can define it in the if                                 you define it in the interface it will                                 store it to the database but if not this                                 class will grab it and that's handled an                                 RC conf local as I mentioned earlier                                 aliases same thing another another table                                 looks very similar to network interfaces                                 except for now we have some you know                                 keys so that knit Network alias points                                   network interfaces and that's handled in                                 the same place that network interfaces                                 and lag do the same thing lags a little                                 more interesting and just you know you                                 group together different interfaces and                                 you can have a different lag type and                                 all that but it's in the database is                                 just another table that points to the                                 interfaces and groups them together                                 VLAN same thing static routes very                                 simple so the the basic volume is just a                                 path in the disk so volumes they're just                                 stored as pass and mount points you can                                 that there's we used to store more                                 information but a lot of people they                                 wanted to you know and I don't blame                                 them they want it to be able to                                 manipulate DFS from the command line and                                 so every time they did do so it wouldn't                                 reflect in the interface so we got rid                                 of a lot of the extra information where                                 it carried and now we keep it minimal so                                 that you can just log in and if you want                                 to do ZFS and commands from the command                                 line it will reflect in the interface                                 and that's why it's so simple snapshots                                 our periodic snapshots you you define                                 you know the data sets and the volumes                                 that you would like to snapshot and                                 you're given a an interval you know it's                                 basically a cron job so and that's what                                 that's what gets stored but you know                                 recursive and then it writes it out not                                 directly as a cron job but we have a                                 python wrapper that will check if if                                 it's the python wrapper is the actual                                 cron job and it determines if there's                                 anything that's configured to be a                                 snapshot and this is how it's stored in                                 the database                                 snapshots same thing                                 if you destroy your snapshot just calls                                 notifier and this goes away with it                                 replication just another table in the                                 database and you didn't fill in as much                                 as I'd like to hear we we do it with ssh                                 you know you do it with keys and we it's                                 just a ZFS sin and ZFS receive now on to                                 sharing we have                                                         we have apple AFP windows sips and then                                 NFS unix and these are pretty                                 straightforward you know just a name in                                 the end up in a path of the simplest                                 level and for AFP we have the standard                                 I've script that writes out the                                 configuration file so in this case meta                                 talk and it writes out Apple volumes NFS                                 the standard IX script and it writes out                                 at sea exports and I think we've                                 recently made it to where it actually                                 understands everything that can be an                                 Etsy export this looks simple that                                 Tiff's uses samba so there's nothing                                 simple about it it's ridiculously                                 complicated but you know for the share                                 itself simple and and we have all these                                 other Samba settings that we write out                                 but the share sharing part is pretty                                 simple you know it's just standard samba                                 share and that's the IX ama script that                                 generates not just smb.conf but                                 everything all the shares along with it                                 oh I'm sorry there's a question database                                 oh you mean the tdb files yes no no no                                 those those are persistent um I don't                                 remember at the moment but they they are                                 persistent um yes those don't don't get                                 regenerate every single time they're                                 there they're under you need to fine a                                 scratch area basically and they stay                                 under there I'm I don't remember where                                 it's at at the moment that they're okay                                 yes we ok we you can use your standard                                 etsy password free BS to use but we're                                 about to go to services you can also                                 have ldap and Active Directory users as                                 well but not at the same time so we'll                                 all right so services there's just a                                 service table and we have whatever                                                                                                               name and if it's enabled or not that's                                 the standard format for all of our                                 services ok here you go my first slide                                 active directory so active directory and                                 once you enable it to configure it you                                 have to put in you know your demesne                                 worker bad man pretty minimal as far as                                 getting it going getting it actually to                                 work and sometimes be complicated as far                                 as using it that that's where you'll get                                 your your users and groups from Active                                 Directory and so if you if you turn on                                 Active Directory you know it's not                                 really a service but it it it joins the                                 domain you now have Active Directory                                 users and groups that are that will come                                 when you go to set your permissions                                 those will now appear in your                                 user and group lists and did I put that                                 in here yes I did okay so active                                 directory there's all kinds of stuff                                 involved here we have to generate a                                 kerberos file and then we have to get a                                 Crow's ticket and then we have to go                                 attach all of these Pam files so that                                 Pam services work with Active Directory                                 users and groups NSS which it has to be                                 pulled to use winbind if hello like if                                 if your Active Directory supports unix                                 it has unix extensions then we don't                                 actually use winbindd for name                                 resolution we use ldap and last okay I                                 attack trickery that joins the domain                                 and then I X cash that just caches all                                 the users and groups locally so that it                                 doesn't have to go out the Active                                 Directory every time you do some kind of                                 user group operation Samba if active                                 directory is turned on it generates the                                 whole it generates all of your wind by                                 and directives for understanding active                                 directory I think I just went over that                                 you get a ticket join the domain casual                                 users Apple earlier we talked about the                                 shares this this is where you actually                                 turn the service on and it generates                                 your net attack off and and then all of                                 your shares as well AFP works with both                                 ldap and active directory by the way                                 sifts                                 just it generates the smb.conf I ex amma                                 again it's pretty complicated because                                 there's so many so many sips                                 configurations possible in so many                                 settings you can do so even though                                 there's three little things there it's                                 the monster we support dynamic dns ftp                                 you can configure it like most ftp                                 servers it's Pro users pro ftp just                                 another service I think you think you                                 can run it in a jail and/or seh route I                                 scuzzy you know I don't even know where                                 to begin with this one I I'm listing all                                 the tables here I go over briefly I                                 don't have that deep of understanding of                                 ice Kelly but it's it's another                                 complicated Beast that we support and                                 then we support very well and we have                                 people that do know about it so                                 basically all of those tables you you                                 know for for your I scuzzy configuration                                 we use is TGT and for each file or                                 directive in the file it just pulls from                                 a database table some of them you know                                 you have multiple weird joins to get                                 done correctly                                 I documented the tables and how they're                                 joined beyond that I don't really                                 understand it very well held up it's                                 it's very similar to active directory                                 and how we how we configure the system                                 to work with it did I put it there okay                                 so I excelled app it will generate your                                 your open l-com and your NS SS                                 underscore ldap comp and and it gets a                                 little confusing because NSF's                                 underscore that conf is what's required                                 for Pam to be able to work and and then                                 you have openldap and it's as it has a                                 ldap comp that is necessary if you want                                 to be able to go to the command line and                                 held app search and your other ldap                                 commands and further complicated NSS                                 underscore elle.com still it's not                                 necessary but it complains very heavily                                 and it logs very heavily heavily if you                                 don't name it elle.com so you have to                                 link NS seven or square all day off to                                 al.com otherwise it's loud and complains                                 a lot we do the same thing with IX cash                                 it it caches your LDAP users NSS which                                 you know it adds ldap to the NSS which                                 file we go through the pan we add the                                 necessary modules and the necessary the                                 correct order for ldap user and group                                 indication and samba it's Santa sama                                 isn't necessary for ldap Duran however                                 lot of people use it and if you have                                 that up turn on then we can figure sama                                 to understand l doubt it                                 alright I just went over this NFS                                 straightforward you go into the GUI you                                 defined the past you would like to share                                 and how you like to share them it's                                 stored in the database and it's the                                 exports gets generated something to keep                                 in mind and something we'd like to work                                 on a change in the future it is a lot of                                 these files not all of them but a lot of                                 them you can't edit by hand it followed                                 all of your information to start in the                                 database and every time you restart the                                 service or boot up it's going to rewrite                                 over that file just something to keep in                                 mind it'd be great if we could get to my                                 to work on that what's that absolutely                                 why don't we patches are welcome plugins                                 what happens when you configure plug-in                                 or the plugin do you need to tell it the                                 jail name the the path the plugins path                                 and IP address and when you turn on                                 plugins it just starts up and configures                                 the jail and think we had to patch                                 backport the image i might be wrong but                                 we needed it for one of our plugins                                 needed to do                                 what was it I don't remember but a lot                                 of people wanted it so we have to do                                 that multi casting and on our sink we                                 support and you can configure both our                                 sink and our sink you can figure it as a                                 server or you can configure to push and                                 pull as well and that's done and the                                 services are synced d table and that                                 will generate our sink ecom smart                                 SNMP it's pretty much the same Nessus                                 age we don't really do anything fancy                                 with ssh by default it's turned off one                                 of the first things everyone does is                                 turn it on tftp and we run the standard                                 stock freebsd tftp server and that's                                 enabled n                                                               ups okay so users and groups so you can                                 configure users and groups from the                                 interface and all it does is in the                                 database its lord how you would think                                 it'd be stored users groups and then                                 kima you know keys to what users in                                 white grapes every time you make a                                 change etsy master password is generated                                 and then the password database gets                                 rebuilt and all of that as described                                 here                                 and my summary here is that we need help                                 we need more developers to add things                                 like pre and post hooks for                                 configuration files and we need more                                 plugins we're a small group right now                                 that are developing for free nose and                                 we'd love to have more people come on                                 and more people that understand it all                                 right well I guess that's it um thank                                 you for coming
YouTube URL: https://www.youtube.com/watch?v=fw6g_R8SM4U


