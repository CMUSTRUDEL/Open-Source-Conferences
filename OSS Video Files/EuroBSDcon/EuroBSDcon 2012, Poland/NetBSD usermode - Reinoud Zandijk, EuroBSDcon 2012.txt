Title: NetBSD usermode - Reinoud Zandijk, EuroBSDcon 2012
Publication date: 2012-12-07
Playlist: EuroBSDcon 2012, Poland
Description: 
	EuroBSDcon 2012
Warsaw, Poland 18-21 October
Captions: 
	                              okay um well welcome all this is my                               first presentation in English bit                               nervous and I also tried out a new                               concept in at least for me new concept                               in presentations like having less sheets                               so it's also getting used to you well                               I'm going to talk about the PSD user                               mode there will be a extracting that                               isn't on the sheets and it's a demo if I                                have enough time Wow the beginning is                                beginning what isn't it is the user mode                                well it's never intended to be a                                successor or replacement of sin oxy or a                                queue ego of virtualbox or rump whatever                                it's meant to be a completely thing of                                its own for ease of kernel development                                and what it can be used for for hosting                                virtual servers for the corner                                development let's trade that since it's                                yeah it's about one hundred percent                                kernel code you run so there is no                                strange modifications like ramp that                                some things are just too difficult to                                test because rump is really only user                                space for file systems etc and some                                networking try to X expanded but yeah                                don't get me started to rub it's nice                                but very intrusive it's also very handy                                for experimenting with new kernels and                                installations you can just say install a                                virtual machine with with net-based a                                user mode using me with this throw and                                just ever look if everything works okay                                if they stole our works okay                                you can experiment with some setups                                without actually having to have machine                                for it can also be used for education                                purposes as its people for running as an                                research OS on a machine for say network                                testing or for a new grade scheme or you                                name it you can just insert it like in a                                normal colonel and of course with                                sandboxing just trying out packet filter                                or whatever yeah there are several                                strategies of virtual machines the first                                one is of course the simulation of                                processor and the Machine like you a new                                but we all know the speed and accuracy                                you can also use a machine only                                emulation using normal processors from                                QA mule or VirtualBox can use it and of                                course a kind of facilitation I am kind                                of a term I invented this is more like a                                criminal emulation that looks like it's                                adding machine like sin or so it's                                dedicated to show like a new gene and                                user mode is different in that thing                                that it's very fast to start up try out                                things but most importantly it's hundred                                percent Colonel behavior it has no                                modifications are needed for the main                                kernel code that's one of its strong                                points and the biggest problem with                                rumba if you ever want to enhance or                                change in interface you have to do it in                                the basic colonel any room otherwise it                                will never fail it was won't compile and                                it's very well erica irritating to say                                the least especially if you want to just                                testing                                it's implemented as a portal new machine                                so all the code can be separated from                                the rest let's just treat it like my pc                                build system as yet another machine and                                since the user then program it can also                                be debugged like a normal program i can                                just attach gdb to it watch very I                                variables print for our goals make a                                breakpoint in the kernel etc so it's                                kind of like a virtual well how to code                                a scratch and burn machine in I normally                                used with KGB in the serial port but                                well it's not very easy and you have to                                have a spare machine all that kind of                                stuff so yeah so that's a really handy                                thing that you can just enter the                                colonel watch data structures call                                functions even it's also very fast boot                                so it's very easy you don't have to copy                                the colonel to a medium then insert a                                medium tested Oh doesn't work okay next                                try so it's it's also like yeah it's a                                speed up development a lot and we've                                course used it a lot bin within the                                development of that means the user mode                                so yeah make it as fast or as simple as                                possible to test for more it's not                                dedicated to I                                                          currently is I just recently heard the                                 transaction arm Persian never numeric                                 system and virtualbox if it runs is                                 almost always exclusively amd                                            so yeah so there's no reason why it                                 couldn't run on the spark or an arm                                 and one of them more well any points it                                 doesn't emulate real devices it isn't                                 like it's emulating a PCI I to become                                 the pc i ided bus or a satyr bus driver                                 so it doesn't emulate hardware that                                 software then in the kernel needs to                                 work with etc so you don't have that                                 extra boundary of course it has no                                 perfect one of the critics I had on the                                 mailing list normally chat was safety                                 like how safe is it can I really just                                 goin up do one for say a web server well                                 of course but it's never it's not                                 completely idiot safe as in yes it's                                 possible please from the inside                                 knowledge to retrieve some information                                 etc so it must be more like seen as a                                 chroot privacy it's that's that's the                                 security the OS and gives through a                                 process and that's the process safety                                 you get you can't really yeah go out of                                 your route UJ also to say so if there is                                 improvement in that security                                 automatically gets it there's also no                                 pci or the USB driver yet that's also a                                 shame but that's working progress so you                                 can just debug here USB drivers that                                 would be very great yes yeah well you                                 just oil or PCI driver where you can                                 just use lens drive a pci see how it                                 handles how did sitter but that hasn't                                 been done yet well it's working progress                                 it's quite stable under general                                 I've found some P map packs and that                                 turned out to be the main course of all                                 the crashes I've had it's just memory                                 knots existing where it should be and                                 when the memory handler is off then oh                                 you get a penny well in the user mode                                 kernel of course not every corner and it                                 only has one cpu for now most CPUs is                                 possible it will need some fundamental                                 changes in it because well how do you                                 separate the memory of one CPU and the                                 other sir p cpu we have one memory space                                 so they only have one you can't identify                                 them or you have to have a kind of yeah                                 pthread way and then yeah also bite so                                 the SP is a bit difficult but of course                                 one could use multiple threads in                                 hardware so to say emulating it it's                                 also yeah could be useful research stuff                                 like no cause that share the memory                                 space but not of course the registers                                 decision                                 um now I'm going to talk about design                                 choices oops sorry that should be not                                 like i said it's yeah virtual memory                                 used to be a big problem originally the                                 port to stare started with jared by                                 jerry to me and we finally got stuck on                                 the virtual memory like how do you do                                 virtual memory the linux user mode as                                 some of you know completely avoid this                                 by just providing a flat memory space we                                 have much protection or whatever because                                 it just emulate some machine without an                                 MMU well it's a very easy way out but                                 busy and the DC in special can't handle                                 that it can't handle a machine                                        you so the emulous solution what does                                 not fit ball visible we've gone for                                 complete virtual memory support so you                                 can make pages executable readable right                                 we'll all the more model stuff we did                                 choose a unified memory model where the                                 colonel and users per usual and share                                 one memory space that did come on to                                 heavy critics because yeah it's it's                                 seen as a potential problem for security                                 and also for stability issues but                                 splitting them would mean lots of                                 communication between two processes and                                 how do you deal with that and                                 communication between the two processes                                 is not the best thing done in busy as in                                 you could use signals of course but then                                 you have to have a dedicated piece in                                 the other memory space it only runs that                                 one and then well you already have kind                                 of a hub then what's the difference                                 between the whole memory space sharing                                 or just a small part but that's well                                 like I said it's also nice researcher                                 ways that you could try to emulate it or                                 create a different memory spaces for                                 each processor one memory space for                                 example but then you have to have a kind                                 of host tiny bits of like d if anyone                                 knows the BBC young computers it's kind                                 of bit of like a tube you would need                                 that for them those who don't know what                                 I'm talking about google it the physical                                 memory it has is backed up by file we                                 try to do some stuff is a shared memory                                 it says riveted it always kept lingering                                 around giving lots of trouble because of                                 the reference counting you have to                                 explicitly kill the shared memory and                                 yeah it didn't really work out and the                                 physical memory backed up with a disk or                                 file was just lot easier it can also be                                 a just a device I mean no reason it                                 should be a file it's completely                                 implemented using M F and n signals like                                 this it seffy                                 and be honest it can be seen as you p.m.                                 torture because on every process which                                 it gets a                                                             met goals and so it was you nice test                                 for you vm we already found at least one                                 bug in it my reference count back so                                 yeah that case it was also nurses nice                                 the the reference are they read modify                                 write testing etc is also done using a                                 map and the segmentation fault it's                                 implemented like a kind of TLB and it                                 one of the idea is to switch to the                                 machine independent version of till BP                                 math but that's yeah it didn't exist                                 when we started we wrote our own and                                 yeah there are perks eNOS um well system                                 calls how do you see what what system                                 calls are made from the colonel userland                                 colonel or the momo ordered new                                 zealand's colonel usual end yeah we had                                 a cup of solutions we try them out we                                 try patching them up that was nearly                                 impossible in i                                                      it's hard to detect all the instruction                                 before you know you're missing the data                                 or whatever so that's that we abandoned                                 that very easy very early we try to use                                 ptrace but yeah Peter S is really more                                 like giving what's his name suggests a                                 trace of signals you can't                                 I say you can't intercept assistant call                                 you will just yeah the whole kernel                                 needed to be fixed and modified for that                                 to be allowed and then it didn't work                                 anywhere the most easy way we found                                 worse to use dedicated illegals he has                                 dedicated illegal instructions on Indian                                 i                                                                       that are officially labeled as undefined                                 and you will always get a trapper me so                                 i built a special userland that's                                 created instead of the Cisco or the in                                                                                                         for Eddie realm but we wanted to have to                                 run a normal use land so we had to                                 giving a bit in our original idea of                                 making it random every POSIX cheating                                 and it's a bit of Colonel sport for it                                 or you can say this region don't allow                                 system calls in that it is a system                                 called is in this region then give us an                                 illegal instruction the old way of an                                 illegal instruction of course still                                 possible for say if you want to try that                                 on freebsd if it runs on that I mean we                                 haven't tried yet it probably needs                                 supporting then you can always use the                                 illegal instructions without modifying                                 anything about Colonel then I come to                                 the point of process switching and we                                 couldn't use Patriot of course because                                 lapiz red switch to whatever it wants a                                 switch and we can't have that because we                                 want to emulate the colonel so we use                                 the get to context set context it's not                                 that much used anymore just be the                                 predecessor of pietra and sometimes                                 bitrate is implemented using certain get                                 text so yeah it's quite dense i call it                                 the dance because it's it's like you                                 giving control to another one remember                                 one another one I just if every                                 reference is correct you keep walking                                 correcting around and no one is sleeping                                 or now complex is lost an hour of course                                 on critical sections in which set                                 context color get contacts get                                 completely fails and one of the SD yeah                                 well rather pesky Kirk rock or Carell VP                                 variable it must always refer to the                                 running process but if you try to set                                 the forest and then switch there can be                                 an intro between and although the window                                 is very small it happens and then you                                 get panics so we tried to emulate the                                 whole process switching as a hundred                                 percent let beastie and well you can                                 even get teased for a walk so one knows                                 what comes against it and put it                                 interrupts well we use the kind of used                                 signals as interpreters                                 that hurts yeah well it's a logical                                 choice of course because it's the only                                 way to get input asynchronously from                                 running program we had some trouble                                 though with stacks because you can't                                 leave anything on the stack you have to                                 hey honestly it's not used to this miss                                 few slides and afraid okay ah I'll keep                                 the life and I'll hurry up a bit maybe                                 I'm a little bit too slow nobody's had                                 some trouble like I said with the signal                                 stack because you can't just stay on the                                 signal stack because you might switch                                 away and another one comes in and you go                                 back and you jump into port so every leb                                 has got a signal stack or a system stack                                 of its own just to counter for a                                 possible interrupt that might happen and                                 it yeah it's had some feet in the earth                                 I'd say it worked enter priority was                                 just doing SPL our the whole array of                                 functions are waiting for the correct                                 intrapleural the main i/o was just done                                 by a TTI console for easy day bargaining                                 and testing and you don't need anything                                 else enter V&C console for graphic so                                 you can also test say                                 frame prefer drivers and stuff like font                                 stuff we SWS console stuff discs it uses                                 unblocked I all as much as possible for                                 easy disk access the disks are normally                                 specified it as a file can be on my NFS                                 even but edifice is probably possible                                 with us I tried it a few times and it                                 works like a charm it just it's only                                 reading and writing from it so it                                 doesn't really matter and even as                                 Network there's a top device flying even                                 goes audio for them strange testing with                                 ya it's also there I come to performance                                 not very an important thing and we tried                                 to get as much performance as possible                                 it was not a main goal of the whole                                 system but considered important and                                 especially on the cisco stuff and the                                 implementation is Pete Pete race it was                                 just walk slowly it didn't really work                                 the fingers are that in native you can                                 have about well on one test machine of                                 course I would love to have a graphic                                 but had some troubles creating it and                                 native it's about                                                        and the user mode it's about sex                                         a second but even though it's affected                                                                                                         is the rather hairy coat at the end of                                 the system call where the                                 where their signals are all handled and                                 it's never been written for speed with                                 sound so at least it's our current                                 estimate of the reasons for this ski oh                                 it doesn't matter I got native and user                                 mode about                                                            one described of One artists nothing                                 special so that's well it's suspected                                 the compilation however there is a                                 difference if you most packages are now                                 mama day is done with a configured part                                 and the compile talk and it's configure                                 especially if someone isn't you see                                 running amd                                                          part for combo and well it shares also                                 in user mode the the configure is about                                 almost three to four times slower than                                 normal but the compilation is the same                                 so this position power is the same it's                                 only be continuous creating of new                                 processes swapping in stuff managing it                                 etc makes it slow suspected this it is                                 effectively due to a reduced their                                 memory bandwidth to the high bridge fold                                 latency because even page fold it needs                                 to get a signal and the signal it needs                                 a map and then twice again yeah probably                                 that's the main reason what is working                                 well pima perks there are small box it's                                 a fully beautiful machine you've got TTI                                 fianc√©e console natural duplex audio CD                                 and DVD drives are working progress then                                 the read fine but I also want to have                                 write access to CDs and both qmu and                                 even virtualbox count right to CDs it's                                 a bit silly but now the next nothing to                                 do about it so also no le working is X                                 the whole screen mapping and bit mapping                                 everything works ok you can just get a                                 whole ex running only the keyboard and                                 mouse well I'm very essential with those                                 two are well not working fine i mean                                 keyboard is yeah okie codes are not                                 completely fine and some kids just don't                                 work and yeah so the plans are well                                 finishing cd/dvd USB pci and also ports                                 to are more spark or well freebsd linux                                 wherever and now i want to show you a                                 little demo same problem as before I                                 can't see what I'm doing on my screen                                 one thing is oh yeah you see the module                                 wasn't loaded yet my machine has a                                 battery life of                                                        it booting it's just a normal boot                                 physical memory is currently set on                                    gigabytes can be of course be more but                                 so some small bugs to be solved at least                                 I encountered it last week and go back                                 home that's not mess with it will have                                 to give a presentation so yeah here you                                 have a normal machine where you can just                                 pop whatever you want and yeah I think                                 it's fairly very fast at least text                                 output it's a job you wouldn't say it's                                 a emulated one but then there is also                                 very far more interesting thing what                                 works this time no it doesn't Wow I'll                                 ever see                                 this parameter answer well here you can                                 see I've now automatically added some                                 stuff hope it's still there I've set a                                 breakpoint on the opening of the audio                                 device for debugging and I can show you                                 here let this one file that it stops now                                 suddenly because the audio device is                                 opening and you can see you can just                                 print out whatever variables the right                                 just like in KGB you have used KGB then                                 ddb as hell because you can't really                                 look at all the rainbows and all the                                 structures and it just has complete                                 information of course this is just the                                 silly example but it gives you yeah some                                 you could even put watch points in it                                 probably watch point I have never really                                 used myself but breakpoints are very                                 handy let's just continue it it goes                                 right outside your voice twice why we                                 are not and you can see the audio is now                                 playing on user mode so its user mode                                 Colonel that's about it for now of                                 course it starts me so but here you can                                 see it's a it just it works fine even                                 when interrupted it will just start from                                 where it was it won't mess up with                                 timing and so there some time keeping                                 problems but well there are minor really                                 as you can see it hardly takes any time                                 and it you can just enjoy and play with                                 it the network layer is also very it's                                 also completely done I wanted to                                 demonstrate it but this version is with                                 all that's in this machine there are                                 some reversal network box but it should                                 be so from the current now                                 and you can just well using tab click                                 and just ssh to it you can you can do                                 whatever you want with it you can use it                                 for particle evaluation you can also                                 start up many programs you can you can                                 start up                                                                 another arm and I have them communicate                                 with each other so it's also useful                                 useful for say distributed computing                                 tests or protocol tests or whatever and                                 it's also main advantage because yeah in                                 virtualbox yeah it is possible of course                                 but yeah then you have to run purchase                                 and queuing you know I don't think you                                 want to wait on that well that concludes                                 my presentation are there any questions                                 yeah well it was removed to random it                                 was removed already know it is oh no one                                 Jared's tried to end it methods but it                                 turns out to be not that handy because                                 it would mean that you get a signal for                                 each system call being done you can't                                 specify like in this address space I                                 want darling just normal criminal                                 behavior I got good just normal human                                 behavior and in this space I want                                 everything emulated so one of the                                 solutions we had was to to fork                                 reprocessing starch and have a kind of                                 hyper visor and then but then again they                                 got stuck on the same problem because                                 you had to                                 signal the other process that it was                                 continuing and you had a lot of                                 communication proceeded to programs                                 because it had to intercept the program                                 and then it had to signal an illegal                                 instruction so you have all everything                                 double well currently you don't need any                                 final destruction well it is a kernel                                 module so its support from the colonel                                 yeah a bit on the other end Patriot the                                 emulation part is also a hack and of                                 course only available on a pc so if you                                 so it's a bit of both ways well it could                                 be done up but I think the performance                                 would drop dramatically because you need                                 two signals or at least you need a                                 communication of the colonel to                                 hypervisor and then hypervisor to the                                 current law etc so it would have the                                 system calls speed so yeah I think we                                 tested it but it turns out to be very                                 slow and of course the user name colonel                                 also uses system calls and all those                                 system calls also need to be checked so                                 it it's not only that the user length of                                 the user mode kernel is running slower                                 with the kernel itself is also slowing                                 down                                 oh yeah I'd any other questions ya know                                 now they are not yet they are currently                                 in sick upon all they are in the use of                                 mode Colonel is in arch I                                              amd                                                                  sorry on I'm mixing up in six point all                                 they are in arts use mode but they                                 decided to let the colonel live in in                                 the architecture breakfasting rings long                                 too so it's a bit yeah it's a bit                                 different than we we see it there's a                                 bit of a better release really not but                                 you can build it yourself um just test                                 it immediately it works the pmab birkoff                                 horse is still very risky but it's                                 easily buildable just like any normal                                 colonel only don't you use the built                                 framework yet others some strange                                 interaction between the build framework                                 and the criminals that's why they are                                 not using that's why they are not                                 currently outer belt I'll try to solve                                 it but it got so hacky there any yeah it                                 is finally build them but you couldn't                                 use them so it only gives more confusion                                 there was something there's something                                 just really going wrong between the part                                 that this compiles the colonel and a                                 part of this compilers userland program                                 is glued together                                 built-in dog SH completely messes up                                 that something it is a linker problem                                 properly we haven't figured it out yet                                 thank you very much
YouTube URL: https://www.youtube.com/watch?v=D4f0SkohCbg


