Title: Using routing domains routing tables in a production network - Peter Hessler, EuroBSDcon 2012
Publication date: 2012-12-07
Playlist: EuroBSDcon 2012, Poland
Description: 
	EuroBSDcon 2012
Warsaw, Poland 18-21 October
Captions: 
	                              my name is Peter Hessler I am with the                               obsd organization and I also work for a                               company called the intronic secure                               networks in Germany and is this working                               ok now it's working sorry about that and                               my talk of today will be on using                               routing tables and routing domains in in                               networks so many of you are probably                               asking you know just working no okay I                                push both too did no work I blame                                Henning so the okay so a lot of you                                asking what are these so ordinarily you                                would have a single routing table inside                                the colonel and that chooses where                                packets will go so what this does is we                                give you two additional mechanisms so                                the first one is an art table which is                                an alternative routing table but still                                within the same overall the overall                                instance the key point is that the IP                                addresses and networks cannot overlap                                that you had they have to be unique                                within the entire system you can have                                multiple routing tables within the same                                our domain which then brings us to what                                is an our domain it's completely                                independent writing table instance so                                for example you can have the                                       network a dozen times on your system and                                this can talk to the individual networks                                that is connected to without interfering                                with the other behavior in openbsd these                                are the interface itself is assigned to                                a writing domain and that's what                                determines where the package leave the                                system else determines which writing                                table it's assigned to the packets come                                in and our domains always contain at                                least one                                our table they can create more but this                                is a not very common use case a big                                caveat for now i think is for only yes                                thank you heading i am working on                                bringing ipv                                                          now i can pass packets for about four                                seconds and then they get lost somewhere                                so we're ninety percent of the way there                                we just have the remaining ninety                                percent of the code to write so uh this                                using our tables and our domains there's                                two very common terminology they'll be                                used purple eyes mostly by cisco vrf                                light and then full vrf so the air                                flight is multiple running tables                                multiple running domains it's done by                                hand it's all centralized within one or                                two machines it's common in your smaller                                single location small number of location                                systems and as i mentioned the the big                                example are the big advantage that                                you'll need a single system to to use it                                you don't need to connect to anybody                                else you're not to explain to them what                                your network configuration is probably                                some good examples are like small to                                medium-sized ISPs with the number of                                customers connecting to it you give the                                customers individual writing domains                                that way they cannot get access to the                                other writing domains of for alternative                                customers and then you have a full vrf                                this is fairly commonly known as MPLS                                basically this is for large enterprises                                with many multiple sites connecting up                                altogether uses BGP ldp which I will                                explain a few minutes and so a good                                example of vrf and mpls would be like                                for example                                um like Deutsche Telekom they have                                hundreds and thousands of locations all                                over the world and they want to have a                                single network within within their                                organization but they don't want to                                advertise this network over the wide                                Internet so when you are doing this                                there are a number of things that you                                need to be aware of the most important                                one default route all of the things                                always default route because when we                                take when we receive an incoming packet                                we will check if we have a route to the                                destination and this happens before you                                have any chance to steal the package or                                to move the packet or to decide where                                it's going to go it's something we                                should look into but this is how it is                                today that's how it's been for quite                                some time so this is an extremely common                                mistake at the company I work for                                 venture onyx probably forty percent of                                 our support calls for there's a problem                                 with my new our domain is this problem                                 the very common mistake is very easy to                                 overlook which means debugging can be                                 painful sometimes because which route                                 which our domain is it using it's not                                 using the normal interfaces it's using a                                 slightly different area which is also                                 means so which route will it use                                 ordinarily traffic within writing domain                                 will stay within that writing domain                                 unless you steal it possibly with PF PF                                 is able to make decisions on on which                                 writing domain a packet came in on and                                 should go to so a very common                                 configuration of veera flight so                                 normally vrf light is the more common                                 case that I've seen as I mentioned                                 earlier this is very common in like a                                 shared in structure for an ISP you have                                 let's say                                                                your network and they need access to the                                 raw internet and your shared management                                 systems but they also need to be                                 completely separated from the other                                 customers everybody uses                                        everybody uses                                                       uses the all the other internal private                                 networks and so in before our domains                                 you would have to have completely                                 separate routers and then at all the                                 boxes independently to get to your main                                 network it's a lot of boxes it's a lot                                 of power it's a lot of cooling and it's                                 going to cost you a lot of money to                                 actually buy all this stuff so instead                                 you can synchronize them all to a single                                 machine and have this route for your                                 network very commonly you'll have things                                 like a shared backup system that will                                 connect to the customers location                                 monitoring of all the customers location                                 and that will need to have access to all                                 of the different are domains in in their                                 system or in Delhi need have access to                                 all of the customer systems so it'll use                                 the art of maine's to jump over and get                                 access to those and then you have full                                 vrf this is again is primarily mpls you                                 use a ldp which is a label distribution                                 protocol and this is a way of telling                                 the other the other mpls routers on your                                 network who you are and where and how                                 they should propagate your routes it on                                 and then over this you use bgp to do the                                 translation to also advertise your                                 internal routes over this external route                                 protocol it basically builds up some                                 essential what's called just because                                 they're just VPN tunnels but with no                                 encryption at all so they can be really                                 fast                                 done in Hardware on the bigger more                                 expensive like Cisco routers and things                                 that have no cpu but a lot dedicated                                 hardware that will process your networks                                 sadly I don't have a lot of experience                                 in running the full vrf the vast                                 majority of our customers are doing just                                 simple vieira flight with our domains on                                 their machines themselves so after we                                 got this written we started to implement                                 this and actually deploy this now as i'm                                 sure you all know testing a system and                                 designing something kind of new is one                                 thing but actually running it and having                                 real traffic go over it it's completely                                 another thing so first bit is a way to                                 execute commands within a dedicated our                                 domain so for example for route we added                                 the exec command so normally when you                                 run a system everything is in our domain                                                                                                      ping or a server or anything else need                                 to jump over to the other one we                                 originally developed the route exec for                                 testing just that way we did not have to                                 you know add supports to everything                                 individually turns out it's very very                                 useful the great thing great thing to                                 use that we don't have to add support to                                 everything and this is now the                                 recommended way to start multiple                                 services and multiple damon's in                                 different our domains so if you want to                                 have a web server and say our domain                                    you would just write exact g                                            Apache but of course there's a few                                 necessary network tools and a few dames                                 worth this doesn't quite work out which                                 I will describe in just a bit the next                                 part is when you add an IP address or                                 when you add an r domain to an interface                                 then the question is what should we do                                 if there's any IP address already                                 configured on it should we keep it                                 should we delete it turns out the best                                 solution is to just simply erase the                                 configuration on on that interface so                                 you so you need to re add the IP address                                 and netmask and all that's figurations                                 after you assign the our domain you can                                 have dedicated tagged VLANs in a                                 different our domain than the parent                                 interface it's completely legal it's                                 just encapsulated packets not a problem                                 carp for failing over does need to be in                                 the same our domain as its parent                                 because incoming packets come on carp                                 outgoing go on the parent having them in                                 different will create a lot of problems                                 we ran into some problems with ftp proxy                                 so when going through that you need a                                 helper because ftp is just incredibly                                  protocol a problem is is that                                 when we is sometimes you don't want to                                 just change it from any protocol to our                                 domain                                                                   need to do both which is why this the                                 source and destinations are domains                                 matter you need to be able to make                                 decisions and to assign them fidus now                                 as i mentioned when with with route exec                                 you want to run some damon's multiple                                 times this gets extremely entertaining                                 when you try and run ntpd so you want to                                 want to start serving time to more                                 systems well that's always a very good                                 thing everything should be in sync so                                 for everything else you started again                                 what with ntp it tries to synchronize                                 your clock as well so you start two or                                 five ntp demons                                 and they're all sinking the clock and                                 they all think they're the master so                                 after about                                                            laptop is now five hours ahead and after                                 leaving it overnight it's now next year                                 so you definitely don't want to do that                                 obviously we do yes because customers                                 going to be different locations and we                                 need to be careful with this so ntpd is                                 one of these demons that actually does                                 run that actually does have internal                                 knowledge how our domains work so that                                 way you can say i have my server in one                                 set of our domains like in the                                 management network i'm providing i am                                 providing time for people in these other                                 our domains as well and then another                                 thing we needed to add was not just                                 identify a packet and then send it to a                                 different our domain or our table we                                 need to be able to make filtering                                 decisions in the firewall based on the                                 incoming arta mean because with artemis                                 since you could have multiple IP                                 addresses again the                                                      longer just the one network you've                                 always been used to so then you need be                                 able to specify where it came in on                                 so when designing your when you                                 designing your network make sure you                                 always add any fault route again it                                 doesn't have to point to a real place if                                 you're going to if you're only going to                                 be stealing the packets with PF and                                 putting them into another one but you                                 definitely have to have this normally                                 you will see this because you always                                 have a default route to your ISP or if                                 you're in BGP then you get all of the                                 routes from the internet anyways so it's                                 so common I need to emphasize this many                                 times there are some neat tricks that                                 you can do with PF which I will explain                                 in a few minutes just be aware of what                                 you can and cannot do and it's very                                 helpful to spend as much time as you can                                 in the planning stage because it is                                 complicated you will have to think about                                 which our domain is traffic coming in on                                 where do I want to route it how do i                                 want to firewall these things off and                                 since a lot of people are simply not                                 used to having multiple routing tables                                 it takes a few extra it takes a few                                 action minutes to just work yourself                                 through all all these problems so                                 definitely plan it correctly so here is                                 a very very simple setup I assigned my                                 interface to our domain one and then I                                 assigned of course the Ten Network                                 because this is what everybody uses and                                 then I had a default personally as soon                                 as I assigned the first address I                                 assignor I assignor out so that way I                                 don't forget later and then you can do                                 nifty nifty tricks in pf so this I will                                 explain a bit more in detail so we can                                 do we have anchors which allow you to                                 have a set of                                 rules that only apply if the first line                                 matches basically an and statement so                                 for example for the customer all of                                 their traffic on our domain                                              you block all the traffic by default                                 allow ICMP traffic so pings and Tracy at                                 work and then you allow access to just                                 HTTP of course when you're doing you                                 should do more specific depending on                                 which direction things are going so that                                 way you don't have any any stealth web                                 servers is just merely show you what                                 that you can add all sorts of rules into                                 here this next rule pass in on our                                 domain to our cable for will for any                                 incoming traffic that is received on our                                 domain to it'll be sent out the system                                 in arch ND our table number for this                                 rule is not doing at so in that case you                                 would you probably should have separate                                 IP addresses otherwise things will get                                 confused but this is how you can just                                 steal traffic and send it over and then                                 the final rule is an app so you pass out                                 from this network and then you can                                 simply assign it to the outbound table                                 this is actually a this is a rule at one                                 of our customer uses that's how they get                                 access for a lot of a lot of things up                                 to the internet you can have your                                 default route going over non our table                                   it's perfectly fine they're basically                                 full-featured running tables um so                                 that's                                 yeah so so part of what I do at venture                                 onyx is I write a little bit of code but                                 I mostly do the customer support and so                                 I'm able to remember the questions that                                 my customers are asking and the type of                                 networks they're trying to design and so                                 I actually have to deal with this stuff                                 and so thankfully I'm helpful I'm able                                 to help polish it up get it working                                 better discover all of these evil evil                                 things yeah so so Claudio actually took                                 a look at at what Cisco how all the                                 cisco documents about this describing                                 how they're implementing it decided this                                 is actually is a good idea and that we                                 should implement it as well you know                                 relatively similarly he also had to put                                 up with all my just crazy questions in                                 the beginning especially the default                                 route case that screwed me over a couple                                 times at the very very beginning                                 no of course yeah so in so as I                                 mentioned earlier we have multiple                                 routing tables but they're all exists                                 within the same routing domain and that                                 you can always move up in the in the                                 tables but you cannot move to another                                 domain unless you explicitly declare it                                 in pf or you do loopback connection back                                 into the system there are cases where I                                 have wanted to do this where that would                                 have solved several problems yes so any                                 questions                                 um there is not a public bench mark but                                 at venture onyx we have benchmarked it                                 we found basically zero difference in                                 performance with this the only hit is a                                 bit more memories used in the kernel to                                 store an additional routing table                                 however the writing tables are only are                                 the additional routing tables and                                 digital writing domains are only created                                 on demand so when the normal use case of                                 I just want you know my single default                                 route you're not wasting anything extra                                 yeah so the question is uh do we need                                 dedicated physical physical interfaces                                 or can we virtualize this the answer is                                 is in openbsd vlans are real interfaces                                 and so you can have as many vlans on top                                 of the same physical interface as you                                 would like up to the the RFC maximum of                                 I think                                                             different our domain if you would like I                                 believe we have a hard-coded limit of                                                                                                         array is                                                                 our domains in the defaults you can just                                 it's one defined if you want to changes                                 but you would have of course have to be                                 recompile you colonel the but if you are                                 using physical interfaces you would have                                 to have one our domain / interface you                                 cannot mix them unless you have a child                                 I guess like a VLAN interface that code                                 is not being committed yes you probably                                 can play evil evil games with the ether                                 and and bridge and other of our pseudo                                 interfaces yes we can do stacked vlans                                 yes then the answer is one physical                                 interface                                                             domains completely legit which is how                                 most of our customers are running it                                 over                                                                 then just as many vlans they can throw                                 on it so any other questions that's                                 something for the future I personally am                                 NOT looked at it we do support larger                                 than                                                                   cards as long as they as long as the                                 card itself support and the driver                                 supports jumbos you of course can                                 configure this manually but I we don't                                 have an automatic method of changing the                                 MTU size for this                                 sir yes so the question is how do you                                 manage the ARP table and arp is                                 independent for each each our domain and                                 that's my problem right now with the six                                 code is the neighbor discovery protocol                                 essentially the ipv                                                      has a few bugs still left in it that I                                 know I need to fix but I believe once                                 that's fixed soon then that can be                                 committed anything else on our largest                                 customer we have                                                    design of their network is not as                                 optimal as it could be they only really                                 need to use three the yeah but they                                 insisted on using this feature and so                                 actually thank thanks to them that's how                                 we discovered a lot of these issues and                                 things that that needed more polish on                                 it                                 yes the fastest we can get is nine                                 gigabit                                                                size and that is without PF that's pure                                 routing I believe with PF we can get                                     or eight gigabit group on IX which is                                 the Intel                                                                I don't remember all the details but                                 reasonably new super fast xeon                                 processors it's the HP dl                                               latest                                 so the question is does this use                                 multiple threads so it's it's is it MMP                                 in the kernel and the answer is openbsd                                 no not yet we can do a MP and user land                                 but right now the colonel is still has                                 the big lock and still on single CPU                                 there's a couple syscalls but nothing in                                 but nothing within the routing area so                                 yeah unfortunately now we are still                                 limited to a single CPU there is work                                 being done on this of course we have                                 very high interest in this the newer                                 network cards allow you to assign                                 interrupt cues to independent CPU so                                 that way you can actually get quite a                                 bit of of performance out of them                                 we have many networks which you want to                                 have identical because                                 okay so the question is is it so just so                                 I understand correctly the question is                                 how many interfaces can be a part of an                                 hour or writing domain and the answer is                                 as many as you want you're allowed to                                 have so of course no PSD the default                                 router domains are writing the main zero                                 and so all the interfaces you up there                                 you can assign as many interfaces as you                                 want to any arbitrary our domain um                                 there's not so the question is can you                                 have the same writing table just copied                                 multiple times and the answer is you                                 would have to create it manually there's                                 not an automatic way to simply copy it                                 over because that's an extremely rare                                 case in the vast majority of cases I've                                 seen it's it's been completely different                                 networks even within the individual                                 writing writing domains so the most                                 common cases you have to do it yourself                                 uh anything else okay so thank you very                                 much                                 you
YouTube URL: https://www.youtube.com/watch?v=yp8wbteYfMw


