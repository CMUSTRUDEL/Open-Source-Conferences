Title: The pivot_root system call for BSD systems (NetBSD) - Adrian Steinmann, EuroBSDcon 2012
Publication date: 2012-12-07
Playlist: EuroBSDcon 2012, Poland
Description: 
	EuroBSDcon 2012
Warsaw, Poland 18-21 October
Captions: 
	                              thank you for                               my talk on the route for a BST I just                               could it be this morning that this is my                               second talk in a PSD conference only and                               the first one was seven years ago                               and this happens to be the second part                               of that talk in between I was working on                               um disk file system small systems did a                               number of tutorials and also                                investigated nikrif on FreeBSD I've                                worked a lot on previously gonna have a                                business that also manages FreeBSD                                systems for my customers and recently                                about a year and half ago I then became                                a member of the the net BSD Foundation                                because I actually started moving over                                and looked at some of their coding was                                very I learned a lot from it and then I                                figured okay let's do something more in                                that area so it's actually quite nice to                                prepare and I urge everybody to try to                                do this and I've also given a tutorial                                in comparing the two in Japan but I                                noticed that the interest was not that                                high it was a bit strange the net BST                                people wanted to see the net bsd stuff                                and the freebsd people wanted to see the                                freebsd stuff but the comparison was not                                what people were expecting                                so here I'll be showing you the route                                which I've implemented and Misty but I                                plan to all support it to freebsd so                                it's very simple structure of my                                presentation it first tell you what what                                problem it solves what it is actually                                and then I will present I'll show you                                how it how it solves it and then I will                                talk about the implementation so I've                                noticed I've been talking about the                                route for ages because it was the end of                                the other talk I gave and people keep                                asking while you're gonna do is so                                you're gonna do this every now and then                                and I said well it's not that much                                interest but I noticed also there was                                also misconceptions so I'm gonna tell                                you what it is                                first just so you understand the                                difference and then I will show you how                                it runs and then of course show you on                                the command line so most people say oh                                well it's just true isn't it                                but we have that well it is something                                like truth but it's not just for one                                process it's for the whole system                                so truth obviously it's a process into a                                different route and from there on all                                the sub processes are in that route but                                it's not that innit route gets closer to                                the truth is a mechanism where the first                                process of the UNIX when it boots goes                                into a different root filesystem than                                you would have in the beginning this is                                actually it's a workaround for not                                having to give it route because then                                when you boot into a system with a ram                                just for example you then have in it                                already running and it's stuck there so                                in it truth is a little this is control                                or can if it's in freebsd and that would                                then tell in it truth into this other                                file system which will be there at the                                time you you're doing it and from then                                on all the other processes of course                                when a PID one will be in that new route                                so you've actually pivoted into the                                other route that you've prepared and you                                can say in a way that's dependent but                                the problem is you've doing this at the                                time and that's it because you once you                                start any test where you are                                now sometimes say well it's also a male                                jails it's also changing everything                                the won't becomes something many where                                you have any network stacking some user                                energy all the sudden I realize that                                this a supermoon above so what's not bad                                either so the question is what is it and                                I think the best way to understand what                                it is is to look at how you would                                how look at the file system structure                                and see what you want to do so obviously                                we have the Repton node where we hang                                off our file systems and we always have                                the wrong file system at least on small                                systems we only have that and that file                                system will then have somewhere down the                                line a directory which for these                                presentation are always called new route                                 it's a directory on the root filesystem                                 you know Larry memo then mount another                                 file system so did you know is it                                 covered the directory the node and this                                 is actually a bit of a complication                                 we'll see later it covers that and you                                 have the new route now the new route                                 obviously should have very much the same                                 infrastructure they have on the other                                 route so if you want to make that than I                                 won't everything is where you expect it                                 to be slash bin slash as being bar and                                 everything else in that file sister you                                 will have a directory called put old                                 just a directory nothing mounted there                                 and now you want to pet it so what you                                 when you pivot you actually just simply                                 move that and you're done right so                                 that's very hard you were thinking there                                 one little thing though now root is in                                 the middle it's not on the top anymore                                 so you have two real able them so now                                 you have the end state where the new                                 root has become the root of your                                 training system and the old route is on                                 put old where you then can go and clean                                 it up I mean you usually want to get rid                                 of the old root that's why you're                                 pivoting away from it and you still have                                 it under your no root to do things to it                                 before you can unmount it so we look at                                 it once more quickly                                 this is I think where the name comes                                 from because it's a quite an old name                                 and I'll show you on the command line                                 how that looks like so on an MPC system                                 we usually have wd                                                      small system where you all we have root                                 and everything is I in the root this                                 would look something like that                                 and here's a copy of root on the second                                 disc and I happen to have it mounted on                                 new root so we're talking about the                                 system call but obviously we have to                                 have a user space program to call it so                                 this is a user space program which for                                 all practical purposes we can call per                                 the root we could call it something else                                 I'll come to that later and we say well                                 my new root is on the mount point new                                 root and the old one will be on put old                                 I'm using these word these names because                                 it's traditionally called like that in                                 the system call get to when I do this                                 okay you expect you its flipped w                                     now wrapped it's on the list on the                                 mount list on top because you want room                                 to be first on the listing appointment                                 and wd                                                               root so you can still do things like                                 clean it up so the question is it                                 doesn't run it didn't run for a long                                 time but it does now so I was going to                                 show you quickly and I'll be showing                                 another demo later on more sophisticated                                 I just wanted to show you see it show                                 you how we run                                 I see I'm already in a virtual box here                                 with two discs same size                                                can go to the outside I've been locking                                 from the inside it's running a BST head                                 and yeah here you can see it's running                                 head and it's a Kuro loadable modules so                                 I have to first load the module into                                 in type and I talk I mean big deal it's                                 just you know I can type in and I just                                 picked up my frontal so I thought it up                                 it'll remind you because it's a kernel                                 loadable modules so that if I forget to                                 do that it's you know it's not in Lipsy                                 yet so then program portals but since I                                 loaded the module then the code is there                                 and you can can run so actually here I                                 have wd                                                                 let's just call it like that and I have                                 a proc infest Mountain because that's                                 pretty standard so we're gonna see                                 something happen here yes something else                                 I actually do when I am when I was                                 defining this I would put a WD                                         file there on WD                                                         I would have one is when you switch you                                 want to make sure am I on the right one                                 so they're not totally identical okay so                                 we go                                 so put all is that just that directory                                 and now we have this situation so you                                 see proc F Brock FS followed along it's                                 obvious I mean it was on the route                                 before and it went along and just that                                 can amount now progress I sent I'll talk                                 about on mounting other things and but                                 my other demonstration will be running                                 on a slightly different setup so I'm                                 gonna now reboot the the VM and we'll                                 look at it later alter because I'm gonna                                 boot into a ram disk later on okay so                                 back to the presentation                                 yeah so yes so actually maybe this is                                 more important question I mean first of                                 all it has to run yeah but the second                                 thing is why do we want it's actually                                 and we've been able to live without it                                 for ten years                                 root comes from Linux this could be a                                 reason why we don't have it in pretty                                 busy for so it's Lena's but also that                                 there was no need for it really for a                                 long time so why I had it you know I                                 just just make sense that seven years                                 ago I discovered that this was called                                 pivot root when I was doing my talk                                 about RAM distance and so on and but                                 there was the inner truth solution that                                 came out and it was good enough to move                                 into a different route when you were                                 shooting up and so there was no pressure                                 but when you work with embedded systems                                 where you want to upgrade firmware or                                 very often your root filesystem comes in                                 the way so                                 it would be handy to have it and large                                 boxes take a long time to boot but you                                 might want to fill up real upgrade full                                 the full user space but you know the                                 colonel won't update so you just keep                                 the colonel is saying but everything                                 else in a change so what is actually                                 Linux it Rd do probably most of you know                                 whoever worked with Linux but it's the                                 two stage who process they go into an                                 initial Ram Dass and that's why it's                                 called init Rd and then that ard looks                                 for the root classes and they may be                                 loading more drivers and doing other                                 things to get to the root filesystem and                                 once that's prepared it mounts it and                                 then it pivots into it this is for most                                 Luc's users and even admin is totally                                 transparent they don't even know that                                 this people root thing magic happens                                 there but then their system is finished                                 is finally booted so at the end you can                                 free of course the initial memory they                                 need Rd memory which we want to do as                                 well so I'm a PC or SD people now would                                 like to also encrypt their root file                                 system with CTE or jelly or TBD on                                 FreeBSD and there you need to do exactly                                 this type of mechanism you have to boot                                 into something which has enough                                 infrastructure to to decrypt the root                                 filesystem and then you can go mount it                                 so you generally do this with a ram disk                                 and then you used in its root mechanism                                 so right now we could of course route                                 where this is actually idea come from                                 it's really old I mean that's how all                                 the OS installs always installs                                 themselves they they come up and they go                                 into around this is sure to see around                                 you have no writable media and you take                                 the memory to do that and then from                                 there you                                 pair the media you want to install your                                 OS on with me playing the disk and then                                 later on using truth to get a roll down                                 and then you reboot into it now in this                                 case you wouldn't have to reboot you                                 could just hit the root into it at the                                 end and the system would be running now                                 obviously it's really big booty but you                                 don't need to and it might be good for a                                 live file system for example you're just                                 you're never gonna because you don't                                 need it at the end anyway so this ideas                                 that revolution it's just an incremental                                 change the change I think is that you                                 can do this any time I only get some                                 time and this is actually the firmware                                 upgrade in situation when you're doing                                 it at the end of the lifetime of an                                 appliance where it's the new image it                                 will actually do the pivot root to do it                                 so how would you do in a plate of a                                 firmware on an appliance you would have                                 a running system you would take its full                                 root filesystem witches or maybe some                                 read-only some read-only root files as                                 to which you would then put into memory                                 on RAM disk you would then pivot into                                 that so you're still writing the same                                 exact system and this frees up the old                                 route which you then can you need and                                 then you can do a second paper route                                 back into the new state so obviously                                 this works perfectly honest you're                                 upgrading your kernel which then you                                 have to first do to take advantage of                                 it's also a situation where you might                                 just have your hardest for some reason                                 software or hardware not doing what you                                 expect you need to do right and you                                 don't want to write your system because                                 you might lose evidence for some reason                                 you want to keep your system running                                 have the old route there too                                 maybe fix it or investigate because once                                 you boot you lose all that information                                 so it'd be nice to go to a different                                 which you know is safe an NFS server                                 work from there and investigate what's                                 actually wrong before your system                                 totally locks up this is a picture from                                 windows support and they just say well                                 you know if you have a disfavor reboot                                 don't know how that's gonna solve the                                 problem but this effect this I think I                                 Windows                                                       sophisticated so they're selling that                                 it's a nice cute photo here so that's                                 the description of pity root hope it's                                 clear that this difference between any                                 truth short and bitter root and now the                                 question is how is this implemented so I                                 thought it was actually pretty easy and                                 to start but I stopped working on it I                                 had a version in FreeBSD which to kind                                 of work but it always panicked at the                                 end and it was I was never able to                                 remove the old root and every time I                                 touched old Rudy system would go haywire                                 and I lost interest because just gonna                                 solve it and I left it for a while from                                 actually a few years and then when I                                 started looking at Pepe's decode I said                                 let's try again and so you have to ask                                 yourself a few questions how do you want                                 to do this earlier I just put it into                                 EFS mount and made it a different way                                 and activate to see could I get it to                                 work but then when I was doing it                                 whenever you see I wanted also become                                 more familiar with kernel loadable                                 modules so I said well can I make a new                                 system call because I want to make a                                 system call which is that is actually                                 Linux compatible and I want to put it in                                 a chrome agile so it's a learning                                 process for me but later on actually                                 occurred to me I also saw some quote                                 from Scott long had written something                                 like that while that never really worked                                 a few years back and it was independent                                 amount                                 system call which i think is quite                                 attractive because you don't need a lip                                 see bump or anything you just it's a                                 different type of file system you pivot                                 and it's all part of the mail system                                 call this drawback to that to that I'll                                 get to that later                                 and you have a user land stuff it's                                 either the mount call or the mount                                 program or the pivot root program and                                 that program of course could help you do                                 other things before or after you involve                                 the system and the final question I had                                 is what do we do on FreeBSD jails                                 because a freebies djl it may you cannot                                 do pivot per se because it will turn the                                 world inside out and everybody else                                 would be underneath it's only route but                                 you could imagine that the jail itself                                 can do its own pivot its own little                                 world and actually this is an attractive                                 thing I'll talk about later on so what                                 does the user land program look like                                 this is just the important part of it                                 it's a tray for totally straightforward                                 but one of the things that I think you                                 have to do right away is to make sure                                 that the input is validated so you make                                 sure that you can call relative else or                                 you call real path so you get a nice                                 string this is important because these                                 strings will eventually go into the                                 mount list and if you can do real path                                 in user space that's good and obviously                                 that doesn't stop somebody from using                                 your assistant call raw but if they were                                 asking for trouble that's what they get                                 here if you use the user space this will                                 be guaranteed to have clean clean and                                 path names because real path takes out                                 all redundant slashes and dotson                                 anything else and then you can do some                                 more possibility checks here is                                 basically underneath each other and so                                 on and then you call the system calls                                 all the work obviously it's done here                                 one more thing that you might want to do                                 at the end                                 signal the process number one and is now                                 I'm coming to the additional difficulty                                 that you will have when you do pivot                                 root it's all seems so simple and I want                                 to make it look this simple because it                                 is quite simple and the usage of it                                 should be simple but there is the                                 problem that processes like one unit or                                 other process they're still they still                                 have file descriptors on the old route                                 that doesn't really change you see in                                 the system coordination that we can do                                 some things for the process but we can't                                 do everything so maybe in the user land                                 program this is just I thought this we                                 could do it this way we could tell in it                                 ok open reopen your file descriptors                                 done on the new route well signal on see                                 kill minus one just stop signal means                                 hang up reopen your father scriptures so                                 now about the system call itself the                                 other part the hard part when you're                                 doing the pivot root system all you have                                 to contend with the virtual file system                                 for any structure and this is actually                                 the part which seems easy but then it's                                 very complicated because it's all over                                 the place and you can read the manual                                 many times for me it's seems                                 straightforward but it's not so easy so                                 first of all the root you know it's a                                 global variable so you're gonna be                                 changing that at some point back global                                 variables in the current line and you                                 change it at the right point you have                                 any notes to look at I'll tell you what                                 the Vino is later but they are connected                                 to the directories that you working with                                 it would be moot and old and of course                                 now points rootbound point the new route                                 and later on when you put the old the                                 new route the old route on the ole                                 so these are the mount points are                                 continuing and all these structures to                                 have flocks and references meaning that                                 when you use them you raise a reference                                 by one or if you drop the usage you                                 release the reference this has to match                                 up otherwise eventually they'll be                                 problem later on you have the name of go                                 up which is the way that the path name                                 gets translated into a V node there's a                                 cache there so you have to make sure                                 that cache is a handle correctly and                                 then you have locks on the mount list                                 itself is one big mount list and each                                 mount point in that list again has locks                                 and actually once you get all this                                 strafed you still have the problem that                                 the running process themselves they all                                 have a current working directory and                                 root directory since your                                             then they have to be told about this so                                 this is actually what we need to to do                                 so how will we start the implementation                                 we first I did this several times but I                                 thought this is the best way to do it we                                 first get you know it off the old root                                 that's where we're going to put the root                                 later on it's actually below in the root                                 but this has to exist and if it doesn't                                 exist we don't even know that go on then                                 we get to MVP the new you know this is                                 all without locks and we oh there is a                                 lot there's a lot in the beginning to go                                 into the system called there's a reason                                 for it I'll tell you later                                 so we only have run instance of this to                                 call running because otherwise we could                                 create two hairy race conditions but                                 then we get the root node which is above                                 the put old and we check to see does it                                 all line up meaning that the foot all                                 has to be on the new root filesystem new                                 root has to be the root of a mounted                                 file system and                                 and well if it's not under it then we                                 just exit in Belgium                                 now if the process that was calling this                                 was actually not under new route we                                 should move there before because                                 otherwise we'll be we'll be blocking                                 ourselves so you silently move to the                                 new route so that you're in the route                                 later on when you've done the call this                                 is all preparation and then once that                                 has all kind of been set up without any                                 locks you go into the Maoist and you                                 start the first part so you you move it                                 to the then MP is the man plane and you                                 move it to to the top of the list so                                 that when somebody does mount or D F                                 they hit the list in the right order                                 it's also necessary other places expect                                 route to be first and you think for each                                 of the map points adjust the Stata FS                                 which you saw happen with property and                                 then this is where you do the main work                                 and you don't adjust rupee note right                                 away because you have an interesting                                 routine in nappies you know so in bc                                  signal all the processes that the root                                 filesystem that their main point has                                 changed this is used by the mound system                                 call to tell all process listen your and                                 you may be underneath and a file system                                 which now is being mounted over you so                                 they have to move over over on top and                                 the interesting thing is that routine                                 actually changes the route Vinodh when                                 you call it from the top from the room                                 you know itself at the end                                 now this difficut is infinity slash                                 deficit ffs so the device is so you                                 actually would have that move down to                                 and that would be very bad because                                 anything that would happen right after                                 the pin route would not find slash dish                                 and would probably fail so you actually                                 do it the favor in inside the system                                 also move step back again to the new                                 route                                 no what you hook it up there and in an                                 MPC you don't need to do this because                                 there's no that FS but in Epis D you                                 have to I mean update the current at                                 root eyeballs not so easy because                                 they're actually well it's obviously                                 doable but they're constants they're                                 read-only so probably have to delete                                 them in and remake them for for the new                                 route that part I haven't done yet                                 because I discovered it just recently                                 that I want those to be correct if                                 somebody looks is controlled by rebels                                 they better be correct this could be                                 misleading otherwise so I'm not gonna go                                 into the code further because once I                                 commit it and I will we can all look at                                 it in detail but what do you have to                                 work with when you're doing yes you use                                 the name I and it's synchronous by                                 everybody wants to make it better and do                                 its thing but it's complicated                                 but but nice thing is in MVC we have the                                 name is simple kernel and the name my                                 simple user which I actually they do                                 most of the work that name I does for                                 the most common cases so fertile means                                 that you take paths that are from kernel                                 space and translate into Dino's and in                                 if you have user space data when the                                 system call gets started of course this                                 user space data you get a V node and                                 your copy in the user space date into                                 kernel space and then get the V node of                                 new root and put all so once you have                                 that either through the nd in it named I                                 or through that interface                                 you then can reference them with you                                 change reference in space calling VF or                                 you release turbulence by Counting out                                 with beer la so these are inverse                                 operations you can lack have you note if                                 you need to change these you have to                                 love it you can decide to lock it                                 immediately when you're doing the name I                                 call inside the name I call with a flag                                 you'll a key                                 or you can lock it explicitly with being                                 lock and obviously when you're feeling                                 with you know you have to lock it but I                                 saw that it was much better to actually                                 lock towards after all the validation                                 because you don't want to accept you                                 don't want to lock against yourself if                                 somebody gives you two V nodes on the                                 same file system you could lock against                                 your own root filesystem which then of                                 course makes the kernel hang so you do                                 it unlock when you do the validation to                                 make sure that the nodes are underneath                                 each other and then you get the locks to                                 do the work and then the mountainous                                 locks or are mutexes this is for the                                 whole list once and this is for each                                 mount point and this actually is the                                 magic sauce when you call this after                                 you've set up all the right things                                 you call mount check tears with rupee                                 note and it realizes that you've set                                 this up that rupee note is actually                                 mounted on new route and at the end of                                 telling all the processes that listen                                 your current working directory and                                 writing has changed it will then                                 actually change rupee note to new route                                 for you and this part actually is in the                                 offense mount see already it has the                                 correct locks works very nice because it                                 made anyway you are mounting route once                                 more somewhere else so when you're doing                                 this how do you debug all this I had to                                 I just put it right down a core to make                                 it work obviously so I had to do                                 debugging and on a PC I found some nice                                 routines that do this for you so you get                                 output like this and you stare at it and                                 stare at it and trying to find out well                                 the reference is they're important they                                 go up they go down and if you do it the                                 wrong way you have you you then have                                 either hang or a penny later on maybe                                 much later on that's the interesting                                 thing then you need to look at the flash                                 because you will be changing these and                                 if you're mountain you have your holding                                 you know as well and you may have locks                                 so you see that there's a lot in the                                 system you know which thing you can                                 match up with another mediator you're                                 watching so by looking at this debug as                                 you're doing dinner                                 you you see what's happening and you see                                 what you need to do to make it really                                 work and man points very similar because                                 obviously they interact with each other                                 man points cover me notes and then you                                 see which we know is being covered right                                 the other you can see the flag if it                                 says it is through fastest or something                                 else or where is it mounted and also the                                 status information which is down below                                 you see what the paths are which of                                 course you're changing as you go through                                 the mat list so these two routines are                                 actually already there you just have to                                 print them out in the right place and                                 you obviously have to look at the                                 different you knows and they're                                 obviously pointing to each other because                                 it's all forward and back linked lists                                 so you can find out where the Vino is                                 actually mounted because the video may                                 be down somewhere but it's mounted up on                                 a root door on you and you know what yes                                 and then if it's the mount points there                                 you have it maybe cover so you have to                                 look at this which we of course mind if                                 I                                 and in in certain cases you then have to                                 follow right through and look at all                                 these to get the references in lakhs                                 correct so what things can go wrong why                                 I thought I was pretty security and I                                 had called which kind of was working for                                 a long time and I didn't think about                                 well if I let somebody do get a root out                                 of a treat environment this is gonna let                                 him see everything and everybody else                                 will see nothing so that's actually very                                 bad so the first thing that this is Tim                                 Cole does his checks to see am i being                                 called from a true if so deeper but this                                 was not in there for a long time so he                                 would have been home and when you were                                 validating input I first was using wax                                 and then in certain situations where I                                 would be bit or mount points a new mount                                 new route was on the same path it was                                 logic said the system would freeze and                                 then I would have to go into the                                 debugger and finalize it do you know oh                                 it makes sense and there's also problem                                 with when you're taking to binos and you                                 you you shouldn't like to you know at                                 the same time because this opens you to                                 a potential race because you're trying                                 to get one and another sister for                                 somebody else is getting the other one                                 in your your uh your your deadlock so I                                 haven't found a way to set get this                                 solved completely but since I'm breaking                                 the rules in given route I make a lot                                 around the route and I also have the                                 lock on the madness and I tried to keep                                 that area very short but I need to have                                 both the put old and the old route                                 locked at the same time to the flip the                                 certain values can't do it one after the                                 other I may be able to fix that still                                 but to me it seems like I need to have                                 both lost at the same time because I'm                                 getting a value which I then put into                                 the other one and okay phenomenally what                                 happened is economic when you look at                                 your system after you've run about                                 a few things can can happen for example                                 it may seem to have worked but you panic                                 when you reboot which means that some                                 reference has not been counted down                                 correctly anything will tell you when it                                 reboots oh I couldn't even mount this                                 thing it's too many references and then                                 it panics Wireless shutting down so that                                 means there's a problem in your code and                                 it's latent there but it doesn't really                                 seem like there's a problem until you do                                 the reboot or honestly yeah if you                                 access the old route under the put old                                 it may lock up your system I had that                                 too because you you've left you've left                                 the reference too much and you see there                                 just it locks on you so this actually                                 then shows you how complicated VMs can                                 get if you try to fit I talked about the                                 processes which run on they get moved                                 their current working directly but their                                 file descriptors of course the processes                                 have to contend that with themselves I                                 mean there's no way for a secure shell                                 daemon to to know what to open on the                                 other side so you have to restart these                                 services so that's something that                                 actually the administrators left to do                                 he only has the possibility to work with                                 put old and make sure that all the                                 processes remove their references on the                                 old file system so that's how much I've                                 done till now and this is what I tend to                                 do I'm still not so sure if all the code                                 it's very much code actually it's wanted                                 to subroutines that I could actually put                                 into the mount EFS mount code and should                                 support the minus T pivot option but the                                 drawback is that then it would always be                                 in the kernel in making it's just                                 control turning it on and off I mean                                 it's just added                                 aggravation for a route to have to do                                 because either you lack it out and you                                 have to read would anyway which is the                                 kind of pointless because that you were                                 trying to avoid to do that and if you                                 make a kernel module then of course it's                                 isolated it doesn't your kernel proper                                 doesn't have this but anybody can load                                 it right so I have this right now which                                 means I need to do this it's probably                                 harder to do this to this it's better to                                 isolate from the rest of the tree then                                 once that's done obviously it's nice to                                 support the given route just in call so                                 you wouldn't have an investor calls that                                 we cap the comparative library we just                                 have a little shame to also support that                                 and I still need to update this these                                 persistent variables and when I have                                 Ronnie called for net BST but I do plan                                 to do it also for FreeBSD or with some                                 helpful previously people M in this last                                 step has to be double this is actually                                 the easy part because it's just one                                 thing straight forward and in FPS D you                                 could ask well should should the kernel                                 also look at is there a dish pts and if                                 so move it over because there may be                                 network connections and so on but I'm                                 not so sure I'm gonna have to discuss                                 this on my manliness if you want to do                                 this I think it's the UNIX fast used to                                 do as little as necessary and let other                                 programs put them together these small                                 permitted to put them together to make                                 the complete solution so I'm gonna show                                 you another demo a bit longer                                 yeah after enough time and what is it                                 it's actually a very large nippy SD                                 kernel                                                                   and strip it nothing and it it's a                                 generic install kernel current head                                 it has an                                                               it's a custom randiss with secure                                 shelving and running in a root file a                                 new route home directory and SS Asian                                 authorized keys so I can log into the                                 system from the outside show this so I                                 mean the RAM disk and then I will                                 well people came eyes already loaded and                                 I could load it and I will switch like I                                 did before and then I will restart all                                 the processes to in fact get rid of all                                 those file - scripts still hanging off                                 my RAM disk this time because this is my                                 root and then I unmount the RAM disk in                                 you will see that my system still                                 running and still logging from the                                 outside so this is the way this demo is                                 showing you step by step                                 that unit Rd of Linux ten years later                                 but it's instructive it also shows you                                 that it works and I'll just now drive                                 this through and then later on we can                                 maybe do some questions                                 we probably do one question now reason                                 being that when I boot this thing into                                 the RAM disk it you will see will take a                                 very long time well very long time it's                                 I think it takes about                                            because yep you see when it boots and it                                 discovers that slash def is empty def                                 consoles missing it says all I have to                                 make the def file system so it makes                                 that it uses shell make that it makes                                 all the device and it takes a long time                                 because it's I mean this is a virtual                                 machine so it's not fast and eventually                                 we'll see it making these devices that                                 unfortunately takes some time so you                                 can't really see it but you know it's                                 it's all green until it discovers the                                 Nepean a it's doing this thing which                                 takes                                                                    I can then login also in VirtualBox when                                 I login with it when you start with a                                 different DHCP setup it changes the IP                                 so it's not                                                             I'm gonna have to log in as root here                                 because I only have room on my Rambis                                 and I have a secure shell secret key so                                 I don't need to tie the password so did                                 something happen back here yes it's                                 finished                                 it starts at secure shell demon well                                 Allah it actually loads to me that route                                 came out because if I forget I had                                 coordinates and ugly in a demo so it                                 should be listening here and I can then                                 login yeah first time oh yeah well                                 actually I shouldn't do this I have this                                 thing called ish which it's a stupid                                 little program it actually just doesn't                                 store the secure shell keys and because                                 you know if it's a one-time thing you                                 don't want them stored in your known                                 host because                                 you will it'll just pollute it so I                                 assured it doesn't do that so I see I                                 got in without answering the stupid                                 question so I'm in the ramdisk air route                                 is quite full                                                       selection of programs here                                 it's crunched of course so whoops                                 we got typing with one hand and then                                 term caps a bit bad than here all right                                 so on there's                                                           crunch together here it's very similar                                 to rescue but a few have thrown out if                                 you have put in to have the the                                 networking party and it's all crunched                                 into one program obviously and I'm the                                 route scrunched in there too so now we                                 have we have the NFS this                                            thing and we have well there's nothing                                 because it's all a memory and now we                                 mount the device w                                                   looked at before                                 yes slashes Missy so we excuse me yep                                 just as far up as it can go all right so                                 yeah thanks                                 hold up Plus sorry so this is the route                                 we had before to Hin it works better and                                 we put it into it                                 well that's what we expected but                                 actually I should have showed you the                                 ps                                                                       we have to now take care of these so                                 yeah what do I do now I actually this is                                 the last command I'm going to type in                                 I'm gonna start et CR see this is what                                 actually it would do and the funny thing                                 is actually it's reconfiguring this                                 network again obviously because it was                                 the system with the config in RC conf                                 and but I get to keep this is a network                                 connection obviously so I get to keep                                 keep that our connection now I could                                 actually go and this of course will fail                                 because I can't check route it's a                                 rewrite but that doesn't bother me but                                 now I have all the stuff already running                                 in new route and I could now unmount the                                 old stuff but I'm so we're time and                                 maybe it's actually time for one smart                                 question maybe we can go to lunch                                 I'm intrigued about the possibilities of                                 the Linux emulation of doing the the                                 this is cold can you think of a use case                                 well intrigued the thing is we have a                                 list of syscalls that we can emulate                                 with changing a few arguments or                                 something to make them work the same way                                 now I don't think there's a large use                                 case because Linux why would you be                                 running and root on a Linux application                                 this is a operating system                                 infrastructure but since we have people                                 we would have to root we also put it                                 into the system into the compatible                                 library just because we have it not                                 because we expect the application to                                 actually use it and if it wouldn't use                                 it it would it would not fail it would                                 work so I agree with you there's really                                 no real use case because if you're doing                                 pivot root you probably use doing                                 running Linux anyway I had a question                                 myself and I don't have an answer to it                                 but we have a very cool testing                                 environment on that BSD and I don't know                                 how we're going to test this though                                 because when you test favorite root                                 you're changing everything and the whole                                 test test automation will then of course                                 start failing because it's in the wrong                                 route so I don't mean you know how we                                 would test that with the FreeBSD jail it                                 would be easier because you put in a LNA                                 would do it in that level and you could                                 look at it from the outside so what yeah                                 but still you're changing the route but                                 how would your onions test suite then                                 continuing the New World                                 okay so the basic idea is you can use                                 one-to-one a user left corner and you                                 could mount okay you can also bind                                 additional processes to it to a degree                                 and then you can do the people to it and                                 test that okay so the missing link is                                 having the kernel running in on the run                                 yes okay yes the good that's actually a                                 very good point                                 so I have a way to test it I have no                                 excuse okay I think otherwise you know                                 if you for you to come and ask me                                 questions some other time
YouTube URL: https://www.youtube.com/watch?v=6itw0i2OHwM


