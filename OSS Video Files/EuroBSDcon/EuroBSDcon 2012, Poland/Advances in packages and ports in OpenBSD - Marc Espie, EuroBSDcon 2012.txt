Title: Advances in packages and ports in OpenBSD - Marc Espie, EuroBSDcon 2012
Publication date: 2012-12-07
Playlist: EuroBSDcon 2012, Poland
Description: 
	EuroBSDcon 2012
Warsaw, Poland 18-21 October
Captions: 
	                              right so let's hope fat seat and that we                               can finally start so I'm Marcus PIV open                               space we project and I've been walking                               on how about                                                         lots of things ready to that over the                               past                                                                  talk about quite recent advances that we                               did very recently for some of them it                               was last week so obviously if you're                                looking into V openbsd three you won't                                find everything but I'm talking about in                                it yet but we've like it should be                                committed in about a month or so so the                                slides are not yet up obviously because                                I want you to listen to the talk first                                but I should be able to upload them                                probably tomorrow I expect yeah very                                shortly so this is not the first talk i                                have given about this topic if you were                                here two years ago for the PBE pots and                                nice if you don't know everything about                                it was going to be a very quick summary                                this is our distributed boat builder it                                has been in prediction news for about                                   I'd say and it's basically used by                                everything in openbsd that build                                packages for almost every architecture                                you have at least one pot builder here                                with doing spark and maybe some other                                stuff I don't remember yeah so is an                                associate you see because park what's                                with the old machine i'm not talking                                sparc                                                              distributes lots of requesters and it                                has lots of very simple mechanisms                                actually but managed to distribute the                                load quite evenly and give very nice                                results Indians so i think i have an                                example oh yeah two years ago I said                                that there was a lot of stuff to do yet                                with DP be so I wanted to come back so                                that I could                                able to tell you that most of that stuff                                has been done and works now and we have                                done even more and now we are obviously                                running into new problems but first I'm                                going to talk about the stuff that we                                manage to solve both both by ketchup as                                problems which I'm going to explain our                                she kicked your dependence which is very                                important for stuff like spa because you                                don't want to have heroes all over your                                lot for instance fetching stuff making                                things simpler for some of our people                                well not here today like Bob for                                instance and I am going to talk a bit                                about the burfi seriously okay this                                projector is a bit like but it                                should be enough to see progress this is                                what the people look slike when it                                finishes running so you have civil                                curves here when it starts up first it                                scanning the Pops tree and it's already                                building stuff right from the start                                that's one very big difference from what                                we had before is that as soon as it                                finds something that it can build                                without only depends it starts it's                                right away so you basically have one                                scanning job on one machine and                                everything else is already building so                                you see here you have actually two                                interesting q                                                         has been scanned but cannot be built yet                                because it's missing dependencies and                                the blue one here is stuff that we can                                actually build so in normal usage it                                goes up very very quickly so here we                                have about                                                          when it's finished canning the Pops free                                basically it already has almost                                      prosthetic can already billed to choose                                from to try to find a very good build                                order and then it goes very slowly for a                                while right a very good reason for that                                actually it's that since it knows what                                it is going to build and what's going to                                take a lot of time in all of a spot you                                suppose machines crawling because we are                                building huge things like UT for GCC                                compiler                                office stuff like that and then near the                                end Ron vespa it accelerates quite                                quickly you see vacu going down unit is                                that the stars that cannot be built yet                                is almost done                                                          this point EPB has more pots tree at its                                disposal you can choose whatever I'd Q                                which is to build next and so the end of                                 the queue almost always looks like this                                 the green line that's actually the                                 number of big package that you can                                 install and on every                                                    see that in the end it's an external                                 show usually for all common situations                                 you will see DPP and building packages                                 on every machine in the cluster in                                 parallel and everything is going to end                                 at exactly the same time I should have                                 some photo from synchronized dancing or                                 something like that because everything                                 ends within                                                         usually so veg graph has taken from                                     which is a cluster with six machines                                 we've whipped across it it's almost an                                 optimal setup for the ppv stays and                                 until we get better i simply and i could                                 have put a grasp of runs of DPP on over                                 machines but it would be very boring                                 because the shape of the graph and                                 whatever you see here it's mostly                                 dependent on the actual pot                                           much time it's going to take to build                                 stuff relative to each other and not                                 that much on which machine you are going                                 to use actually so this grass is what I                                 see on Opie it's also what I see on my                                 laptop when I do the same thing and it's                                 also what I see on other machines like                                 native new box the only difference of                                 course is going to be tight if you have                                 a slower machine is going to be                                 stretched over three or four days for                                 Pete usually takes something like                                       hours each ish and of course on the                                 sparkler story takes about three weeks                                 right but it looks exactly the same                                 everywhere so how does it manage to do                                 that the very simple idea was simply                                 that each time you are going to build                                 the wall Paul Street you're going to                                 store how much time it's going to take                                 to build one given component so when you                                 go into the next situation you have the                                 bill times for each and every port and                                 you just use that to direct the PB in                                 the right direction so it can build the                                 biggest dependencies first we don't                                 store the dependencies that's a very                                 important point you only have to stop a                                 bill times for each individual port and                                 since the baby will figure out the most                                 current set of dependencies is something                                 changes like for instance suddenly we                                 have lots of pots pots depends on GCC                                                                                                                                                                           sticks and sheets like that it's going                                 to figure out how to build things in                                 parallel so that everything is built at                                 about first the same time it's very                                 strange because I would with God and                                 some time I Freud some new workload and                                 I see do it in a very efficient way and                                 figure out critical path without me                                 having to do anything so this is a                                 slightly different grass actually do you                                 notice the difference from the previous                                 one it's a bit tricky not really for                                 differences here you have a green line                                 that goes over for quite some time                                 actually yeah I know it's a shitty                                 projector so you probably can see it but                                 on the previous bill they built and it                                 here here it goes on for about two hours                                 so this is a problem                                 what happened actually while you can                                 talk all you want about doing the PBE in                                 stuff correctly so that things and at                                 the same time but we actually have an                                 elephant in a pod stream strangely                                 enough really font of course is lip                                 office if you look at the wall pottery                                 on openbsd you'll notice that shit's                                 like lip office is going to take about I                                 think one fourth of the full time it                                 will take to build most tourists so in                                 that case which was a new machine with                                 two sorry a new cluster with two                                 machines per eight core each where was                                 the critical path which was very easy to                                 see which was reading for GCC                                            and Apophis and at the same time you                                 also had to have GCC                                                 didn't go fast enough in the end you                                 solve a wall cluster trying to build                                 that Andy gap building log office while                                 other stuff was finishing and still two                                 hours to go and leave office is not yet                                 done so this couldn't do and the                                 theoretical computer science is not                                 going to save us again so we're going to                                 have to do practical stuff interesting                                 enough we had a very similar programming                                 make actually so since I was walking on                                 neck at the time I decided to maybe                                 reviews with some idea so let have a                                 small parenthesis if you run bills using                                 necks you probably know about the                                 problem you might run into if you try to                                 do recursive max like you have making a                                 directory you try to invoke it in                                 parallel and you go into a selector                                 and another sub directory and if you                                 start with make my energy for for                                 instance you end up with                                              usually your pawn machine is not going                                 to like that so what we did actually is                                 simply try to figure out whether what we                                 were running was recursive Mickey it's                                 very easy you just look at the command                                 and if you see anything that looks like                                 make with a few exceptions because you                                 want to avoid us on could make or make                                 dot C for instance but apart from that                                 if you were running something that looks                                 like Mac you are going to decide ok i'm                                 running a recursive maggie and then                                 you're not going to run into several of                                 these because you are going to start                                 your process is normally and as soon as                                 you started something that looks like me                                 then you stops starting new processes                                 you just learn wait for everything to                                 finish finish that one and then keep                                 going so if you make a very simple                                 computation you're going to have four                                 processes at the first level but most                                 only one of those processes is going to                                 be making so you are going to add four                                 more processes at the next level and                                 four more processes at the fair labor so                                 for simple recursive make with three                                 areas you might up with only                                    processes and even so that's probably a                                 transient because we make at the first                                 level which is which not it running is                                 going to block over stuff from starting                                 until it finishes so you are probably                                 going to start with                                                    are going to dwindle down back to                                     then for so at most six processes and                                 make which is running something else in                                 a different directory that doesn't                                 consume my GPU so in practice we end up                                 having recursing make working making                                 efficient use of our CPU we watch any                                 program                                 so let's go back to the PV what we did                                 was very simple since we don't quite                                 know what's a recursive job in that                                 context we're just going to mark some                                 very expensive ports as being build a                                 barn in parallel and of course what                                 spots are going to start on one core but                                 run with make minus G whatever and at                                 some point your DP P is going to be                                 running more jobs I need supposed to                                 write because you just started something                                 that's expensive you have other stuff                                 that is still running and you have maybe                                 on the four core machines six or seven                                 processes right but since four sports                                 are very long-lived like LIBOR face                                 eventually the rest is going to die and                                 instead of starting new stuff on the                                 same machine you're just going to steal                                 the CPUs for your office and as soon as                                 you started something big on one single                                 machine then anything else on that                                 machine until you've gone down to the                                 number of course that you actually have                                 this is a very small strict wit which is                                 that if you have eight course on your                                 computer you are not going to go full                                 parallel and say you are going to start                                 McManus g                                                               just going to use by default half of                                 that so you're going to have eight plus                                 free processes and very quickly it's                                 going to whittle down again to wait                                 processes the main reason why it works                                 is that you only have a few critical                                 paths so you only need to mock the big                                 pots has being built in palette using                                 vest method and this Trust works I could                                 have put a new graph of neuron on the                                 same machine that you saw before but it                                 would be now again the same Mizuki                                 because now with just this small tweak                                 why it took a few times to fix it                                 because each time you have to run the                                 patch and check that it works and change                                 it again and now again wearable to build                                 a full top three on                                                     we vote having any stragglers likely                                 brophy's being around for                                                at the end so this is a bit of what I                                 said what are we going to mark as                                 parents stuff only critical stuff right                                 and also only things that paranoia is                                 well because if you build software you                                 know that some of that stuff is epic new                                 stuff for instance and it's going to                                 spend a most of its time doing configure                                 and then building part of it and when                                 configuring again and when trying to                                 build over stuff she's like that                                 actually in what we are doing a little                                 bit of configure is going to help                                 because if you try to build a port using                                 parallel make right we'll patch the                                 sorry extract patch config your part is                                 going to be sick unsure anyways even if                                 you start it with make my new chief or                                 in our case that means that you have you                                 mean it's critical minutes during which                                 your big pot is what actively stealing                                 CPUs and in which other stuff is going                                 to be able to finish go back so yeah                                 again what I said we did some more work                                 on this because just marking a few ports                                 does help fullback bits but we have a                                 few not so critical parts mapped as well                                 so that for instance if you only want to                                 rebuild                                                                three you will benefit from it as well                                 stuff like jb is mapped in my tree for                                 instance i'm not sure it's made it to                                 jinhua tree yet and in practice most of                                 the time if you have                                                   have stuff marked with parallel you'll                                 notice that you really have                                              running and not more the transient part                                 where you have started a big thing and                                 you have more mushy training is going to                                 be very small compared to the normal                                 work we build any question about that                                 can you speak sorry I mean what does                                 what mean ah right i mean that with this                                 change instead of having leave office                                 finishing                                                          europhys finishes and then you still                                 have two hours very small sheet building                                 to endow work so last plenty of room if                                 it gets bigger or something like that it                                 will still work some of our technical                                 stuff mining fetches it's a come back to                                 what i was doing two years ago with DP                                 be because at that point DPP only knew                                 about building stuff and sometimes it                                 could be frustrating because you have                                 your machine which is sitting around                                 doing nothing just grabbing stuff with                                 TP it was something that had to be known                                 it was not very complicated to do but                                 basically synthesis object-oriented PL I                                 just needed to kind of tweak the engine                                 and I don't have a violation of eng but                                 instead of building stuff which are                                 simply fetch stuff grab stuff from ftp                                 and run it through another q so priority                                 is important here as well since I of                                 course fetching stuff won't take any cpu                                 bandwidth but you don't want to be                                 fetching                                                              same time or why some people are really                                 not going to like you one very good                                 thing about basis that it made life                                 simpler for some of our developers like                                 but bank and Tommy are well of a guy you                                 are running the these files mirrors                                 because prior to that it required a lot                                 of handling and looking at our logs and                                  like that                                 and at some point we reach a point where                                 we disparage me wrong well almost never                                 up to date she's usually a bad fee so                                 instead of that the new DP be metered                                 just works I don't know what I can say                                 about it but it gives us lots of                                 log error reports that are readable and                                 that you can fit Mossad to actually go                                 through ftp least quite quickly and                                 figure out which one is going to work                                 and stuff like that I would like to do                                 this somewhere to maybe even classify                                 whether some mirror is good or not good                                 and preferentially go to the source                                 false mural that works for instance not                                 be necessary so far it's good enough for                                 what we do oh yeah sorry last thing to                                 say about that is that it also on dolls                                 all kind of concerning exams so                                 that we can build a little bit faster                                 because actually once we fetch a file                                 and discovered that it has right                                 checksums we won't go check again some                                 people are going to say it's bad for                                 security but you have to realize why you                                 are using checks on right you have your                                 post machine your billing stuff on it                                 and if anything gets tampered with on                                 that machine basically your facts the                                 only reason we have checks and of course                                 is to check whether we have to be                                 upstream is good on it right West wing's                                 meet next part of a stock our beloved                                 users while this projector is a little                                 bad but maybe you've seen by stupid                                 movie which is called done and number                                 that's basically some of our users in                                 that case that would be probably on                                    who have the two most annoying gauging                                 exists                                 between tio is never happy with how                                 things work and out well basically said                                 now I can't use the PB I don't want to                                 have to put any options to it so you                                 write to main page you write a complex                                 program you give it lots of options then                                 you let me scare you say is going to                                 tell you now I'm not going to use it to                                 complicate it for me guess what is right                                 it doesn't have to be complicated well                                 we are some cases in which was options                                 are useful but that shouldn't be always                                 and for the simple case of just finding                                 stuff you should be able to just run dpb                                 and that's it and two years ago that                                 wasn't the case because all that stuff                                 that I was talking about four for                                 instance being able to use information                                 from previous bills to prime the current                                 one so that's everything and at the                                 right time it was an option so we never                                 used it you never benefited from it and                                 instead we switch to a different                                 approach twice little bit of code to                                 write its little bit more complicated                                 for me but Microsoft happy now with it                                 the idea being quite simply but instead                                 of keep having to say well vlog of a                                 previous building is I just saw a Jonah                                 of what's been going on before in no                                 place that's not going to go away                                 stalled we've destroyed usually and it's                                 just a rolling log so if it goes to all                                 it just vanishes but usually I think I                                 keep the information for the                                         previous bills of a given pot and on                                 average I get pretty good build                                 information as far as the time it takes                                 to build one piece so that I get                                 percentage and so that is get optimal                                 built it turned out to be surprisingly                                 useful for these fights                                 there was one program with mirrors is                                 that over the time of our life of a pop                                 sweet these fights are going to                                 accumulate each time you get to new                                 version you're going to fetch it so                                 foster batch angie is quite often likely                                 brofist or Mozilla and which has be                                 Spice it's sewn going to be a problem so                                 at some point we want to remove all                                 stuff but how do we decide her what's                                 all stuff in upholstery especially from                                 your arm which has to get her to users                                 who are using you guys from two years                                 ago ovation from one years ago snapshots                                 or budget you can't rely on the time                                 stamps for a fight doesn't work because                                 we timestamp shirts tell you it's you                                 sorry the first time the file was                                 fetched not the last time it was used                                 nope just to lock it in that case access                                 time is not really reliable in many                                 cases each time you start the PB for a                                 full bill it will scan from over these                                 files and it will mark okay this one                                 we've seen and if it doesn't see you're                                 given this file it would say okay this                                 is the first time we haven't seen this                                 one so afterwards you actually have time                                 to time stamps that tell you they still                                 waste this file with but specific                                 section disappeared at that time it can                                 come back for instance if later or if it                                 was a mistake or we upgraded and we got                                 back to a previous session then this                                 time stamp this file is no longer use                                 will vanish and so you keep exactly the                                 facts that you want and you can even say                                 okay I just want to put Midas files for                                 two years ago for instance                                 same thing something most of the stuff                                 that's currently in the PB you don't                                 need options to use for instance if you                                 want to have extra parallelism it's                                 owned by default now I think that it                                 took maybe a week between the time i                                 added reaction and the time i decided to                                 make it to default let's make it work                                 and trash like knob why keep it around                                 but only for a specific case by default                                 you have half your curls from on one                                 given machine which are going to be used                                 to build a big stuff and so it's very                                 good font one because now if you wants                                 to build the wall it just has to say DPP                                 and it was an options if you want to use                                 the PB on the cluster again it's very                                 simple all you need to have is your                                 pottery under NFS set up things so that                                 on the local machine your walk object                                 here is going to be local you definitely                                 don't want to build things when FSU                                 would have to be crazy make sure the                                 best system is the same that's the Quran                                 tricky part going to get better and                                 that's all folks you just have to tell                                 DP be ok I want you to run on best                                 machine what machine what machine and                                 that machine and that's it there were                                 few issues to fix because in order to                                 works it has to have access to NFS on a                                 timely basis and FS is the pile of crap                                 so it doesn't always work sometimes                                 files show up with a small-time like and                                 the solvers special casing inside EPB to                                 say okay I'm supposed to have finish                                 this package it hasn't shown up on this                                 machine yet it is not a program i'm                                 going to wait for it helps on probably                                 on spark a lot                                 overall crap we still have action at                                 this one now we have a guy who is stupid                                 enough to do bills on it and it only has                                                                                                         given process data but it's the                                 tournament so hired to give it some                                 special love so that it fits and                                 unfortunately it has to avoid which                                 fetch part which isn't really a big                                 problem considering that all those                                 machines usually run from the same                                 network and so we actually share                                 distribution files and right now it fits                                 I think that the last I've seen it EPB                                 was running on something between                                        forty megabytes so if we grow up up                                 three too much we'll have a program                                 again but it's not much of a problem                                 really because the only reason we are                                 still running the pee pee on the wax                                 itself it's because it's cool to be able                                 to what some people think it's cool to                                 be able to run us but on Stefan all                                 but it's quite possible to drive a                                 volbeat process from a machine which is                                 from a different architecture absolutely                                 no program with that                                 eros how much time do I have left I'm                                 probably need to get some stuff add so                                 much it's I wanted to talk about what I                                 decided to commit it all so we need to                                 get some yeah our pocket system is                                 a bit complicated with this because we                                 have also packages and Trevor's and                                 everything I am being to be a bit longer                                 and it all works most of the time buddy                                 peebee has to deal with all the strange                                 to us in particular we have something                                 which is called pseudo packages which is                                 that sometimes on some architectures you                                 have to get some stuff to vanish like                                 for instance if you want to build Hawaii                                 it normally has a mono component but                                 mono only builds on amd                                                 an                                                                    spark even over with probably built so                                 what we did was simplify stuff so that                                 one it's easy to build a mixed file but                                 works for specifically in this case and                                 two so the DPP is aware about it and so                                 that if you are running something which                                 isn't mainstream architecture and why                                 some stuff that you can build because it                                 requires asamblea logs budget it won't                                 even try to build it and not flag it as                                 an ear this is a big progress compared                                 to what we were doing before because now                                 you can run a deep ebe on spark and                                 actually see only package sled built and                                 not lots of how many rows                                           maybe more I don't know thousands                                 thousands and thousands                                 oh yeah if you want to stop playing with                                 openbsd bending pots on our machine is                                 very simple now I was not thinking about                                 you actually but if you want to take it                                 for yourself and mostly what's important                                 is that Envy hand we have snapshots                                 almost all the time for almost every                                 architecture right now is this lady is                                 building                                                                 or each two days so that's how fast we                                 can crank things out with fast machines                                 and still with facts well I think we                                 could have one snapshots of remorse soy                                 sauce throughout any problem oh yeah and                                 another important part is that usually                                 candle people don't talk two pots people                                 and vice versa yeah but what's true now                                 is that you have no excuse if you're                                 racking on the colonel to try DP v to                                 try to figure out why are simply is not                                 very fast and like that if you say                                 so yeah let's think about production I'm                                 going to talk about this very quickly                                 and is that for people who are actually                                 using the PB for prediction you don't                                 have to stop it you can just fix errors                                 remove a log file and it keeps going                                 yeah a smart i'm not going to talk about                                 basically just that we have much better                                 ways to control dependencies with this                                 so that we are able to remove stuff that                                 is not marked as a dependency from the                                 pots on a given machine this has two                                 advantages one is that when you end up                                 building the wall street you don't end                                 up having two thousand packages and                                 start on your machine and the second                                 part is that we catch hidden                                 dependencies stuff that hasn't been                                 declared but that boosters                                 rap is going to pick up on anyways                                 another thing that's been happening very                                 recently is that i took what i did in                                 EPB and I realized wait a second what we                                 are doing in make is completely wrong                                 it's ways to complicate it so instead of                                  one process for each target in                                 make now we do it the same way that we                                 do the PB by using one single process                                 for each command we are going to run                                 which means much better control which                                 means that we don't need a pipe since                                 Mack is doing most of a printing and so                                 all kinds of benefit in parallel mode we                                 have TTYL we have bitter errors etc etc                                 yeah Fred stuff and VFS looking but was                                 our women to problems with DPP with this                                 I have plans I should be German in that                                 case because I'm going to take over the                                 world you know I've started playing with                                 using vpb to build not only the pottery                                 but X in ocala as well and source is                                 next on the list and it works at least                                                                                                     don't buy DPP and what you see here this                                 is the critical path this part is x                                    this part is GL and this party's wakes                                 up any questions                                 yeah a one-point forgotten to mention                                 all I've talked about concerning                                 parallelism is in DPP now in the country                                 chongqing works as well all the mix                                 stuff has been committed the part that                                 stealing progresses using the PB to                                 build x and eventually source as well                                 for now it's only working over NFS so                                 that's some sense of speeds over notes                                 but that was already done two years ago                                 which is that you can say that phase                                 machine has got a small speed factor for                                 instance compared to another one and                                 then it will take volk you stuff it can                                 build and it will spit valve upload into                                 parts so that the slowest machine gets a                                 smaller part to build and the fastest                                 machine as access to the work you right                                 now it suppose that its own local                                 cluster and I with this file is                                 accessible for NFS I we haven't had any                                 practical use for one out yet just                                    seconds heist for baby still connected                                 so this is DPP welcome what you're                                 seeing here is opie cluster which is                                 located elsewhere and what you're seeing                                 here is about something like six                                 machines running I think that laundry                                 you want it to wait with                                                 so you see here                                                     parallel and I don't know if you can                                 read it but each pot actually has a                                 percentage number right at the end of a                                 line like for instance here which is                                 telling you that okay compared to                                 previous built it's about thirty-eight                                 percent for the world and lines that was                                 top means that it's the stuff that's                                 been billing for longest so you'll see                                 but it's the manatee to start chromium                                 fairly early and nip office is still                                 building it's going to be here for this                                 feels more I guess maybe a bit more and                                 viendo the list is going to be moving                                 fairly quickly really soon because we're                                 actually reaching a smaller pots here                                 and at the end you probably can't read                                 well numbers but I can tell you that we                                 have built                                                           already at five thousand and seven                                 hundred and we are still                                               packages that we don't have for the                                 dependencies for this is what goes on                                 about once a day which almost no human                                 intervention thank
YouTube URL: https://www.youtube.com/watch?v=sNNHt3oQ-d0


