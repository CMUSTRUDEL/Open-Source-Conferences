Title: Otto Kekäläinen: How to investigate and recover from a security breach - real-life experien...
Publication date: 2019-09-08
Playlist: WordCamp Nordic 2019
Description: 
	Sometimes the bad guys get in, despite all the protections and precautions. If that happens, there are many techniques that can be used to stop further damage, track down what the intruder did and how they got in. Finally the site needs to be cleaned up and re-opened for visitors. In this talk the most important techniques are presented along with real-life examples when they were used.

Presentation slides: https://drive.google.com/open?id=152qttfNnJEoDc-D5ywKo1IUtT9kpB9Bm
WPTV link: https://wordpress.tv/2019/06/10/otto-keka%cc%88la%cc%88inen-how-to-investigate-and-recover-from-a-security-breach-real-life-experiences-with-wordpress/
Captions: 
	00:00:00,060 --> 00:00:06,960
so hello everybody nice to see so many

00:00:03,449 --> 00:00:08,820
familiar faces here so I'm Otto and I

00:00:06,960 --> 00:00:12,300
believe many of you have seen me talking

00:00:08,820 --> 00:00:16,080
before I visit the 14th word camp I'm

00:00:12,300 --> 00:00:18,720
attending and I'm a very I'm the CEO for

00:00:16,080 --> 00:00:21,390
Siravo and I'm a very technical CEO and

00:00:18,720 --> 00:00:24,000
I've been involved in doing plug-ins and

00:00:21,390 --> 00:00:27,630
done some patches for WordPress core and

00:00:24,000 --> 00:00:30,750
in fact to most of the stack that we're

00:00:27,630 --> 00:00:34,380
using because I'm a die-hard Linux and

00:00:30,750 --> 00:00:38,010
open source advocate and I've spoken

00:00:34,380 --> 00:00:41,070
many times at word camps about this talk

00:00:38,010 --> 00:00:43,770
WordPress security 101 and in that talk

00:00:41,070 --> 00:00:45,600
I tell what you should do what you

00:00:43,770 --> 00:00:48,000
should focus on if you want to protect

00:00:45,600 --> 00:00:50,309
your site and what are the unnecessary

00:00:48,000 --> 00:00:53,280
things you can ignore because there's so

00:00:50,309 --> 00:00:55,350
many too much false security advice out

00:00:53,280 --> 00:00:57,750
there and if you haven't seen that

00:00:55,350 --> 00:01:04,110
presentation before I recommend you go

00:00:57,750 --> 00:01:06,450
and check it out but today I'm not going

00:01:04,110 --> 00:01:08,760
to talk about how to protect your

00:01:06,450 --> 00:01:12,510
WordPress site today I'm going to talk

00:01:08,760 --> 00:01:16,259
about something different I'm going to

00:01:12,510 --> 00:01:19,590
talk to you about a Friday in November

00:01:16,259 --> 00:01:22,619
what happened then and hopefully you can

00:01:19,590 --> 00:01:25,770
learn something maybe some technical

00:01:22,619 --> 00:01:29,520
techniques but first of all a mindset

00:01:25,770 --> 00:01:32,310
about what needs to be done when despite

00:01:29,520 --> 00:01:36,600
all protections somebody gets in and

00:01:32,310 --> 00:01:39,060
there's a security breach so I'm from a

00:01:36,600 --> 00:01:42,750
company that does premium hosting an OP

00:01:39,060 --> 00:01:44,579
deep for WordPress so that involves that

00:01:42,750 --> 00:01:51,899
we take care of security for our

00:01:44,579 --> 00:01:54,930
customers and we do upkeep which means

00:01:51,899 --> 00:01:57,750
that if the site goes down we take it

00:01:54,930 --> 00:02:01,020
back up and that covers also security

00:01:57,750 --> 00:02:03,479
incidents so if if if you're our client

00:02:01,020 --> 00:02:06,530
and your site gets hacked despite our

00:02:03,479 --> 00:02:09,300
protections then we will fix it for free

00:02:06,530 --> 00:02:12,349
remove the malware and make it back

00:02:09,300 --> 00:02:15,810
online so that's that's

00:02:12,349 --> 00:02:18,390
that's something we have a like two and

00:02:15,810 --> 00:02:22,440
a half thousand sites that we are up

00:02:18,390 --> 00:02:25,470
keeping so security incidents are rare

00:02:22,440 --> 00:02:28,319
but since we have so many sites we also

00:02:25,470 --> 00:02:31,590
have they are regular and we have lots

00:02:28,319 --> 00:02:34,620
of experience in investigating and

00:02:31,590 --> 00:02:38,480
cleaning up sites and today I'm gonna

00:02:34,620 --> 00:02:43,080
tell you about one Friday which was

00:02:38,480 --> 00:02:47,750
slightly unusual and it started like

00:02:43,080 --> 00:02:50,880
this just an average Friday no space no

00:02:47,750 --> 00:02:55,530
warning signs of anything and then

00:02:50,880 --> 00:02:57,120
suddenly at 11:37 one site started

00:02:55,530 --> 00:03:00,810
alerting that it doesn't work anymore

00:02:57,120 --> 00:03:03,420
and then a few minutes later another and

00:03:00,810 --> 00:03:05,970
then immediately a third and then two

00:03:03,420 --> 00:03:11,220
minutes later a fourth one so something

00:03:05,970 --> 00:03:13,410
very suspicious was going on and it

00:03:11,220 --> 00:03:21,959
wasn't even that Friday 13 just an

00:03:13,410 --> 00:03:24,180
average Friday so we went to look what

00:03:21,959 --> 00:03:26,160
happened to the site and immediately

00:03:24,180 --> 00:03:28,980
noticed that it had they had all of the

00:03:26,160 --> 00:03:32,310
four sites had the same site earth and

00:03:28,980 --> 00:03:35,069
this is not the real site or order for

00:03:32,310 --> 00:03:37,920
the site that we started wondering at

00:03:35,069 --> 00:03:40,950
what's going on is this a mistake by the

00:03:37,920 --> 00:03:43,470
customer or the customers admin did they

00:03:40,950 --> 00:03:45,450
change this on purpose and the

00:03:43,470 --> 00:03:47,880
interesting thing was that all of these

00:03:45,450 --> 00:03:50,310
four sites belong to the same customer

00:03:47,880 --> 00:03:53,910
they were all new sites and the same

00:03:50,310 --> 00:03:55,350
media conglomerate owned owns them so it

00:03:53,910 --> 00:03:59,250
was really weird that they all stopped

00:03:55,350 --> 00:04:00,630
working at the same time and this was

00:03:59,250 --> 00:04:04,319
the symptom that you could immediately

00:04:00,630 --> 00:04:06,510
see and we quickly figured out that that

00:04:04,319 --> 00:04:08,609
page doesn't exist that didn't work and

00:04:06,510 --> 00:04:12,030
this doesn't make any sense and it's not

00:04:08,609 --> 00:04:15,239
something the customer did and then

00:04:12,030 --> 00:04:17,160
since it was the same customer who owned

00:04:15,239 --> 00:04:19,470
all the sites we immediately started

00:04:17,160 --> 00:04:23,640
suspecting some kind of targeted attack

00:04:19,470 --> 00:04:25,860
against that customer but what happened

00:04:23,640 --> 00:04:27,629
on the site didn't make sense

00:04:25,860 --> 00:04:30,080
we didn't understand how why would

00:04:27,629 --> 00:04:35,389
somebody do a targeted attack like this

00:04:30,080 --> 00:04:38,159
to a customer but definitely it was a

00:04:35,389 --> 00:04:46,020
security issue somebody had got in and

00:04:38,159 --> 00:04:47,789
done something weird so the first person

00:04:46,020 --> 00:04:51,289
in our staff who noticed this and

00:04:47,789 --> 00:04:54,569
started investigating it immediately

00:04:51,289 --> 00:04:57,270
realized it's a security issue and then

00:04:54,569 --> 00:05:01,949
notified our security officer on call

00:04:57,270 --> 00:05:05,400
about that this needs attention and the

00:05:01,949 --> 00:05:07,949
first first technical thing done is that

00:05:05,400 --> 00:05:11,039
we saved the process list what was going

00:05:07,949 --> 00:05:14,219
on at those customer sites and then we

00:05:11,039 --> 00:05:17,370
shut them down temporarily so that no

00:05:14,219 --> 00:05:19,860
further damage would happen then we

00:05:17,370 --> 00:05:21,360
notified the customer that there's a

00:05:19,860 --> 00:05:24,360
security incident and we're

00:05:21,360 --> 00:05:26,789
investigating it and then since it was

00:05:24,360 --> 00:05:33,029
four sites and we realized this is

00:05:26,789 --> 00:05:34,770
something unusual and big we that it was

00:05:33,029 --> 00:05:36,479
escalated so it was not just the

00:05:34,770 --> 00:05:39,270
security officer and call about three

00:05:36,479 --> 00:05:47,219
three person team investigating all the

00:05:39,270 --> 00:05:51,719
sites in parallel so by 11:55 the

00:05:47,219 --> 00:05:57,360
security investigation had started full

00:05:51,719 --> 00:06:00,509
speed so these are the questions we ask

00:05:57,360 --> 00:06:02,819
when we start to investigate a security

00:06:00,509 --> 00:06:05,940
incident first of all what's happening

00:06:02,819 --> 00:06:07,560
and it's still happening what do we need

00:06:05,940 --> 00:06:11,159
to do to stop it

00:06:07,560 --> 00:06:14,370
and what happened before this what led

00:06:11,159 --> 00:06:20,550
to this situation and when did it start

00:06:14,370 --> 00:06:22,469
and is there does the site currently

00:06:20,550 --> 00:06:25,710
have malicious code some kind of

00:06:22,469 --> 00:06:29,099
backdoor or something hidden somewhere

00:06:25,710 --> 00:06:32,129
and what has in general changed on the

00:06:29,099 --> 00:06:33,930
site right now and recently something in

00:06:32,129 --> 00:06:37,080
the files nothing in the database and

00:06:33,930 --> 00:06:38,790
what changes are valid something that's

00:06:37,080 --> 00:06:41,610
supposed to change and

00:06:38,790 --> 00:06:45,390
what is an anomaly something potentially

00:06:41,610 --> 00:06:48,300
done by an intruder and then of course

00:06:45,390 --> 00:06:50,790
who did it well we don't see any names

00:06:48,300 --> 00:06:54,000
and rarely the investigation leads to

00:06:50,790 --> 00:06:55,740
finding a real human suspect but at

00:06:54,000 --> 00:06:57,210
least what we can do is find out the IP

00:06:55,740 --> 00:07:00,000
addresses and where the traffic

00:06:57,210 --> 00:07:01,890
malicious traffic is coming from and

00:07:00,000 --> 00:07:05,010
then we can also figure out a few

00:07:01,890 --> 00:07:12,300
identifiers and the fingerprints related

00:07:05,010 --> 00:07:14,280
to the attacker and then after that when

00:07:12,300 --> 00:07:17,310
you have the situation under control

00:07:14,280 --> 00:07:20,820
you want to figure out how they got in

00:07:17,310 --> 00:07:24,690
how they did it and what kind of level

00:07:20,820 --> 00:07:26,670
of access the intruder got what data

00:07:24,690 --> 00:07:28,440
could potentially have been likud leaked

00:07:26,670 --> 00:07:32,810
because then we'd know what to tell the

00:07:28,440 --> 00:07:35,190
customer about what what is the maximum

00:07:32,810 --> 00:07:39,180
kind of damage that could have happened

00:07:35,190 --> 00:07:40,800
in this case and then maybe try to

00:07:39,180 --> 00:07:43,140
figure out something about the motive

00:07:40,800 --> 00:07:45,360
was it a targeted attack what is just

00:07:43,140 --> 00:07:47,820
somebody trying to plant backdoors and

00:07:45,360 --> 00:07:51,420
sell them sell them later in the black

00:07:47,820 --> 00:07:57,890
market and an in general what damage was

00:07:51,420 --> 00:08:02,490
caused so then the next steps in

00:07:57,890 --> 00:08:04,710
practice what we did and the steps I'm

00:08:02,490 --> 00:08:10,560
presenting here is kind of our standard

00:08:04,710 --> 00:08:14,190
steps or at least the last fall version

00:08:10,560 --> 00:08:17,580
of them what we do we constantly improve

00:08:14,190 --> 00:08:20,820
our our process what we do at security

00:08:17,580 --> 00:08:24,030
incidents and this is almost our latest

00:08:20,820 --> 00:08:26,870
process at the moment so the first thing

00:08:24,030 --> 00:08:30,690
to do is to make a backup the backup

00:08:26,870 --> 00:08:32,300
stores the state the whole system was in

00:08:30,690 --> 00:08:34,710
at the onset of the security

00:08:32,300 --> 00:08:36,510
investigation and then also when you

00:08:34,710 --> 00:08:39,020
have a fresh backup it's easier to

00:08:36,510 --> 00:08:42,210
compare the fresh backup with the latest

00:08:39,020 --> 00:08:44,790
backup to see trackdown changes because

00:08:42,210 --> 00:08:47,880
sometimes the intruders try to mask

00:08:44,790 --> 00:08:50,070
their changes and modify file dates and

00:08:47,880 --> 00:08:52,270
stuff so it would be more difficult to

00:08:50,070 --> 00:08:54,220
find what happened and we

00:08:52,270 --> 00:08:57,340
the backups you can then compare the

00:08:54,220 --> 00:09:00,490
backups and we have a few custom tools

00:08:57,340 --> 00:09:03,190
built for that so that we get easy quick

00:09:00,490 --> 00:09:06,160
quickly a list of which files changed

00:09:03,190 --> 00:09:09,880
and then just using basic command line

00:09:06,160 --> 00:09:13,030
diff tools you can compare two folders

00:09:09,880 --> 00:09:16,690
and all of the files in in in them to

00:09:13,030 --> 00:09:18,970
compare the the like the backup the

00:09:16,690 --> 00:09:25,030
previous backup and then the latest

00:09:18,970 --> 00:09:30,160
state this will reveal changes and then

00:09:25,030 --> 00:09:32,590
after that we check in check who logged

00:09:30,160 --> 00:09:36,100
into the VP admin and who logged in

00:09:32,590 --> 00:09:38,860
using SSH and try to detect if there was

00:09:36,100 --> 00:09:47,020
somebody some IP addresses or user names

00:09:38,860 --> 00:09:49,870
that don't belong there and then the

00:09:47,020 --> 00:09:51,820
next step is that we use this VP CLI

00:09:49,870 --> 00:09:54,930
commands which are very handy how many

00:09:51,820 --> 00:09:59,050
of you use VP CLI put your hand up

00:09:54,930 --> 00:10:01,630
alright those who don't do please learn

00:09:59,050 --> 00:10:03,250
it it's really really really convenient

00:10:01,630 --> 00:10:06,610
especially if you work with lots of

00:10:03,250 --> 00:10:11,460
WordPress sites so the EP CLI has this

00:10:06,610 --> 00:10:15,130
built-in tools that you can verify that

00:10:11,460 --> 00:10:18,970
that your WordPress core files haven't

00:10:15,130 --> 00:10:20,680
been modified it will compare the

00:10:18,970 --> 00:10:22,120
checksums of the original word press

00:10:20,680 --> 00:10:26,860
release and their release you have

00:10:22,120 --> 00:10:29,560
installed and there's also it you can

00:10:26,860 --> 00:10:32,890
also do it for plugins and teams but

00:10:29,560 --> 00:10:35,200
this of course is works only for plugins

00:10:32,890 --> 00:10:38,200
that are in the wordpress.org directory

00:10:35,200 --> 00:10:40,540
if there are like custom plugins then

00:10:38,200 --> 00:10:42,840
there's nothing to compare against or if

00:10:40,540 --> 00:10:48,220
there are paid plugins that are not

00:10:42,840 --> 00:10:52,050
accessible publicly then BPCL I can't

00:10:48,220 --> 00:10:58,570
compare them then we also have one

00:10:52,050 --> 00:11:01,390
custom VP CLI package which we use it's

00:10:58,570 --> 00:11:04,060
it does the same thing but it also can

00:11:01,390 --> 00:11:05,680
show you the disk so if it detects that

00:11:04,060 --> 00:11:07,529
the file has been changed it will

00:11:05,680 --> 00:11:11,560
show you what is the difference between

00:11:07,529 --> 00:11:15,370
the plugin files of this version on your

00:11:11,560 --> 00:11:22,540
system and then the plugin files of the

00:11:15,370 --> 00:11:27,459
same release in wordpress.org so in this

00:11:22,540 --> 00:11:31,660
case we found actually several plugins

00:11:27,459 --> 00:11:33,940
that had code modified didn't the

00:11:31,660 --> 00:11:35,649
plugins didn't match the versions that

00:11:33,940 --> 00:11:38,560
are released on wordpress.org

00:11:35,649 --> 00:11:41,020
but unfortunately wordpress.org the

00:11:38,560 --> 00:11:43,029
current subversion system they use and

00:11:41,020 --> 00:11:46,000
the tagging system they use doesn't

00:11:43,029 --> 00:11:48,610
enforce that one single release version

00:11:46,000 --> 00:11:51,610
would be exactly the same the plug-in

00:11:48,610 --> 00:11:55,330
developer can make changes for example

00:11:51,610 --> 00:11:57,130
to the readme file so it depends on at

00:11:55,330 --> 00:11:58,990
what time you install that plug-in which

00:11:57,130 --> 00:12:01,600
version you will get so there's some

00:11:58,990 --> 00:12:05,470
false positives that this technique and

00:12:01,600 --> 00:12:07,420
yield and in this case we use the defect

00:12:05,470 --> 00:12:09,580
tool to see what was the changes then

00:12:07,420 --> 00:12:12,070
under and came to the conclusion that

00:12:09,580 --> 00:12:17,350
this was false alerts this was not

00:12:12,070 --> 00:12:21,070
related to the security incident right

00:12:17,350 --> 00:12:24,190
and we went through all kinds of things

00:12:21,070 --> 00:12:26,620
and it takes some time and even if you

00:12:24,190 --> 00:12:30,490
had three people working on four sites

00:12:26,620 --> 00:12:31,990
in parallel took some time and remember

00:12:30,490 --> 00:12:34,570
that the sites were shut down

00:12:31,990 --> 00:12:41,140
temporarily all of this during this

00:12:34,570 --> 00:12:44,100
entire investigation right and then the

00:12:41,140 --> 00:12:47,200
next step we do is to check the

00:12:44,100 --> 00:12:50,950
WordPress user list if there are any

00:12:47,200 --> 00:12:53,140
recently added users or some user names

00:12:50,950 --> 00:12:56,170
or email addresses that don't look valid

00:12:53,140 --> 00:12:58,980
and then we also check the database

00:12:56,170 --> 00:13:05,230
itself if there are any recent posts or

00:12:58,980 --> 00:13:08,230
something recent changes injected into

00:13:05,230 --> 00:13:10,959
the database and this is the SQL this is

00:13:08,230 --> 00:13:13,630
one example of the SQL queries you can

00:13:10,959 --> 00:13:17,140
do and by the way I will be posting my

00:13:13,630 --> 00:13:18,910
slides on Twitter after the talk so you

00:13:17,140 --> 00:13:21,390
will get you can copy/paste all of this

00:13:18,910 --> 00:13:21,390
commensal

00:13:23,770 --> 00:13:32,480
so using at this step we noticed

00:13:27,850 --> 00:13:35,540
something fishy that there was on

00:13:32,480 --> 00:13:39,410
multiple on many of the investigated

00:13:35,540 --> 00:13:45,950
sites there was this variation of troll

00:13:39,410 --> 00:13:48,040
hairpin in the user database and some

00:13:45,950 --> 00:13:51,080
foreign addresses which our customers

00:13:48,040 --> 00:13:58,310
surely don't use this was an unknown

00:13:51,080 --> 00:14:01,270
anomaly and normally and since these

00:13:58,310 --> 00:14:05,540
have the dates when the users have been

00:14:01,270 --> 00:14:09,020
registered then this was kind of bingo

00:14:05,540 --> 00:14:13,580
for us because this then opened opened

00:14:09,020 --> 00:14:16,190
up gave us lots of data to find more

00:14:13,580 --> 00:14:19,510
clues about what had happened so we knew

00:14:16,190 --> 00:14:23,720
that somebody had managed to get

00:14:19,510 --> 00:14:25,700
additional user accounts registered on

00:14:23,720 --> 00:14:27,860
WordPress and we knew what email

00:14:25,700 --> 00:14:29,840
addresses they had been using and we

00:14:27,860 --> 00:14:32,300
knew the timestamp when it happened so

00:14:29,840 --> 00:14:33,380
based on the timestamp we could then

00:14:32,300 --> 00:14:35,870
look in the logs

00:14:33,380 --> 00:14:38,270
what happened around that time before it

00:14:35,870 --> 00:14:40,250
and slightly after it then we found the

00:14:38,270 --> 00:14:42,560
IP addresses and with the IP address we

00:14:40,250 --> 00:14:46,340
could find more but the same attacker

00:14:42,560 --> 00:14:48,410
had done and just those are things you

00:14:46,340 --> 00:14:50,990
can do with basic grip from blogs

00:14:48,410 --> 00:14:57,040
assuming that you have access to to all

00:14:50,990 --> 00:15:00,410
of the access logs of your server so

00:14:57,040 --> 00:15:05,120
with this clue we found out in the logs

00:15:00,410 --> 00:15:07,970
when this what happened and this is how

00:15:05,120 --> 00:15:12,580
the entry looks like looked from an

00:15:07,970 --> 00:15:12,580
access point log from access log

00:15:17,320 --> 00:15:25,680
can the people in the back of the room

00:15:19,480 --> 00:15:29,800
cedar to small yeah you can see right so

00:15:25,680 --> 00:15:31,870
we saw this pattern do you can you based

00:15:29,800 --> 00:15:36,850
on looking at this request understand

00:15:31,870 --> 00:15:41,649
what's happening so there are some post

00:15:36,850 --> 00:15:45,160
requests to the VP admin and they return

00:15:41,649 --> 00:15:47,589
return 200 okay as the result which

00:15:45,160 --> 00:15:50,350
means that those posts were accepted and

00:15:47,589 --> 00:15:52,240
they didn't fail so they did something

00:15:50,350 --> 00:15:55,440
that they shouldn't be able to do from

00:15:52,240 --> 00:15:59,860
the outside and then quickly after that

00:15:55,440 --> 00:16:01,660
somebody registered an account and then

00:15:59,860 --> 00:16:04,420
verified that account because when you

00:16:01,660 --> 00:16:06,790
register account you get an email which

00:16:04,420 --> 00:16:08,980
you need to click on to verify that

00:16:06,790 --> 00:16:13,329
before wordpress activates your account

00:16:08,980 --> 00:16:16,750
and after that they continue doing

00:16:13,329 --> 00:16:21,970
something sending some requests to

00:16:16,750 --> 00:16:24,670
wordpress which were successful and that

00:16:21,970 --> 00:16:26,199
was the IP address it was an russian IP

00:16:24,670 --> 00:16:28,569
but you can't really make any

00:16:26,199 --> 00:16:30,940
conclusions of this it can be from

00:16:28,569 --> 00:16:34,029
anywhere in the world just happened to

00:16:30,940 --> 00:16:35,610
be that there was the the last hope was

00:16:34,029 --> 00:16:38,019
in russia so there was probably some

00:16:35,610 --> 00:16:39,760
Windows XP machine or something that

00:16:38,019 --> 00:16:44,889
hasn't been updated for years and was

00:16:39,760 --> 00:16:48,579
used by others to attack and we also

00:16:44,889 --> 00:16:50,260
knew the user agent of those requests

00:16:48,579 --> 00:16:55,269
but that doesn't mean anything either it

00:16:50,260 --> 00:16:57,339
can be spoofed to be anything and if you

00:16:55,269 --> 00:17:00,279
look how quickly this happened in just

00:16:57,339 --> 00:17:06,339
few seconds all of this and you can know

00:17:00,279 --> 00:17:10,209
that this was completely automated right

00:17:06,339 --> 00:17:14,020
so what was those weird post requests to

00:17:10,209 --> 00:17:16,360
the WordPress admin so we don't log post

00:17:14,020 --> 00:17:17,799
requests or obvious reasons it would be

00:17:16,360 --> 00:17:25,870
a huge amount of data and it will

00:17:17,799 --> 00:17:28,209
violate privacy so so we don't we don't

00:17:25,870 --> 00:17:31,750
log post contents and hopefully nobody

00:17:28,209 --> 00:17:36,490
else blogs posts first contents at least

00:17:31,750 --> 00:17:38,890
not hosting providers but luckily we

00:17:36,490 --> 00:17:41,950
have lots of other logs PHP logs and

00:17:38,890 --> 00:17:47,230
database logs and others so we found

00:17:41,950 --> 00:17:50,380
some anomalies around this time and for

00:17:47,230 --> 00:17:53,820
example there was lots of requests to a

00:17:50,380 --> 00:17:57,760
table in the database with this name and

00:17:53,820 --> 00:17:59,919
that looked weird so when you when you

00:17:57,760 --> 00:18:02,260
investigate a case you find lots of

00:17:59,919 --> 00:18:03,730
weird things and the method is that you

00:18:02,260 --> 00:18:06,490
check all these weird things and then

00:18:03,730 --> 00:18:09,130
try to eliminate if this was actually

00:18:06,490 --> 00:18:09,900
normal after all or not and this looked

00:18:09,130 --> 00:18:13,360
weird

00:18:09,900 --> 00:18:19,150
so we then grabbed from the files

00:18:13,360 --> 00:18:22,659
what plugin is talking to this table in

00:18:19,150 --> 00:18:25,659
the database and then we found it that

00:18:22,659 --> 00:18:28,450
it was about this VP GDP our compliance

00:18:25,659 --> 00:18:31,169
plugin it was doing something but we

00:18:28,450 --> 00:18:36,610
didn't know which line of code it was

00:18:31,169 --> 00:18:39,940
and what what and more at this time it

00:18:36,610 --> 00:18:42,549
was slightly past 2 and the site's had

00:18:39,940 --> 00:18:48,669
been down for two and a half hours

00:18:42,549 --> 00:18:50,740
almost so then we started looking into

00:18:48,669 --> 00:18:53,440
this plugin is there something weird

00:18:50,740 --> 00:18:55,840
with this plugin and we looked at its

00:18:53,440 --> 00:18:58,809
change log and since it's open source

00:18:55,840 --> 00:19:01,419
and on wordpress.org we could go exactly

00:18:58,809 --> 00:19:04,270
look at what lines of code was changed

00:19:01,419 --> 00:19:07,450
in the recent release and then we found

00:19:04,270 --> 00:19:09,760
that they've done if you know what SQL

00:19:07,450 --> 00:19:15,670
injections are then you if you see

00:19:09,760 --> 00:19:18,700
developers adding this

00:19:15,670 --> 00:19:20,470
around what they're passing to SQL then

00:19:18,700 --> 00:19:23,050
you know it's probably something they've

00:19:20,470 --> 00:19:28,630
been fixing they're probably been fixing

00:19:23,050 --> 00:19:30,520
SQL injection stuff so at that point we

00:19:28,630 --> 00:19:33,880
were pretty sure that it's related to

00:19:30,520 --> 00:19:35,320
this plugin and our first solution was

00:19:33,880 --> 00:19:38,620
to just remove that plugin

00:19:35,320 --> 00:19:41,470
it's kind of ironic that the customer

00:19:38,620 --> 00:19:43,810
had this gdpr plugin to improve security

00:19:41,470 --> 00:19:48,730
and then it was the point of entry for

00:19:43,810 --> 00:19:52,360
an attacker and then very quickly after

00:19:48,730 --> 00:19:55,060
that was the afternoon in Finland so us

00:19:52,360 --> 00:19:58,570
woke up and people in the u.s. started

00:19:55,060 --> 00:20:00,250
blogging and posting news and then we

00:19:58,570 --> 00:20:03,300
found out that other people had found

00:20:00,250 --> 00:20:06,220
similar attacks and posting about it and

00:20:03,300 --> 00:20:07,930
here are some links and as I said I will

00:20:06,220 --> 00:20:09,760
post my presentation on Twitter

00:20:07,930 --> 00:20:12,430
afterwards so you can go and read read

00:20:09,760 --> 00:20:13,960
on these articles to see more details

00:20:12,430 --> 00:20:16,870
about what happened

00:20:13,960 --> 00:20:20,500
sue curry has a very good blog post on

00:20:16,870 --> 00:20:27,730
this specific vulnerability in this

00:20:20,500 --> 00:20:31,240
plugin yeah so what was it so it it was

00:20:27,730 --> 00:20:33,940
an SQL injection thing so that it was

00:20:31,240 --> 00:20:39,330
possible to edit WordPress options

00:20:33,940 --> 00:20:42,970
inject WordPress up options without any

00:20:39,330 --> 00:20:45,990
authentication so what the attacker did

00:20:42,970 --> 00:20:48,160
with those post requests that first they

00:20:45,990 --> 00:20:50,350
changed the settings in WordPress that

00:20:48,160 --> 00:20:53,430
anybody can register and then they

00:20:50,350 --> 00:20:56,440
changed the settings that the default

00:20:53,430 --> 00:20:59,350
role when you register new users is

00:20:56,440 --> 00:21:01,180
administrator said and then after that

00:20:59,350 --> 00:21:03,460
they registered a new account which were

00:21:01,180 --> 00:21:05,770
had administrator privileges and after

00:21:03,460 --> 00:21:09,630
that they could access the site and do

00:21:05,770 --> 00:21:13,930
more and this is this was reported by

00:21:09,630 --> 00:21:17,050
Adrienne merchant so credit credit goes

00:21:13,930 --> 00:21:19,420
to him for figuring this out and this

00:21:17,050 --> 00:21:25,840
was fixed in GDP our compliance version

00:21:19,420 --> 00:21:27,970
1 4 3 so when we figured this out we

00:21:25,840 --> 00:21:29,950
knew that this effects everybody running

00:21:27,970 --> 00:21:34,669
this plugin

00:21:29,950 --> 00:21:36,679
so we we in addition to that normal test

00:21:34,669 --> 00:21:38,480
that updates we do we also do security

00:21:36,679 --> 00:21:39,919
updates and we decided it is something

00:21:38,480 --> 00:21:42,980
that we need to update for all of our

00:21:39,919 --> 00:21:45,140
customers immediately and we enter this

00:21:42,980 --> 00:21:47,720
into our automation and started rolling

00:21:45,140 --> 00:21:52,490
updates for everybody then sure that

00:21:47,720 --> 00:21:54,350
nobody else would get breached and then

00:21:52,490 --> 00:21:58,760
it was almost three o'clock in the

00:21:54,350 --> 00:22:02,500
afternoon so this was the invocate

00:21:58,760 --> 00:22:05,270
investigation part then we started

00:22:02,500 --> 00:22:07,909
thinking what do we wets which steps do

00:22:05,270 --> 00:22:11,600
we need to take before we can reopen the

00:22:07,909 --> 00:22:14,450
sites again so what you want to do is

00:22:11,600 --> 00:22:16,880
you want to ensure that whatever was the

00:22:14,450 --> 00:22:19,580
entry point is closed and removed so

00:22:16,880 --> 00:22:21,770
nobody can re-enter and then you want to

00:22:19,580 --> 00:22:24,649
make sure there are no planted code or

00:22:21,770 --> 00:22:27,320
backdoors that could be used to access

00:22:24,649 --> 00:22:29,210
it so obviously we removed those user

00:22:27,320 --> 00:22:35,029
accounts which were not authorized

00:22:29,210 --> 00:22:37,669
and then we our rule is that we tried to

00:22:35,029 --> 00:22:39,409
recover backups and get back to those

00:22:37,669 --> 00:22:41,929
because that's the only way you can be

00:22:39,409 --> 00:22:43,700
sure the site is clean but in this case

00:22:41,929 --> 00:22:45,679
it was a site with lots of traffic and

00:22:43,700 --> 00:22:49,970
lots of changes and going back to an old

00:22:45,679 --> 00:22:52,510
backup was not an option so we used our

00:22:49,970 --> 00:22:55,520
security scanners to find if there are

00:22:52,510 --> 00:22:57,730
any suspicious PHP calls which are

00:22:55,520 --> 00:23:04,190
usually typically used in backdoors

00:22:57,730 --> 00:23:06,350
figure out and luckily luckily we didn't

00:23:04,190 --> 00:23:08,649
find any malware or actually we did find

00:23:06,350 --> 00:23:11,600
one one file but not more than that and

00:23:08,649 --> 00:23:14,020
then also in addition to removing these

00:23:11,600 --> 00:23:16,490
fake accounts we also as a precaution

00:23:14,020 --> 00:23:19,159
changed everybody's passwords and we

00:23:16,490 --> 00:23:21,649
have a automated tool for that which

00:23:19,159 --> 00:23:23,090
also our customers can do if they think

00:23:21,649 --> 00:23:29,750
that they want to change all of the

00:23:23,090 --> 00:23:32,330
passwords at once for all users and here

00:23:29,750 --> 00:23:36,200
is a screenshot from our our custom tool

00:23:32,330 --> 00:23:38,450
so we scan for patterns of malicious

00:23:36,200 --> 00:23:41,059
code all the time from our customers and

00:23:38,450 --> 00:23:43,010
then we analyze when we have findings

00:23:41,059 --> 00:23:46,190
then we need to analyze if it's a

00:23:43,010 --> 00:23:49,790
false positive or is it actually malware

00:23:46,190 --> 00:23:52,220
or is it just like bad practice

00:23:49,790 --> 00:23:53,929
malpractice that somebody wrote the

00:23:52,220 --> 00:23:58,790
plugin and did something stupid but it's

00:23:53,929 --> 00:24:00,950
not intentionally a backdoor and then

00:23:58,790 --> 00:24:04,940
finally after several hours of work

00:24:00,950 --> 00:24:07,990
intense work we were able to open the

00:24:04,940 --> 00:24:12,500
sites again and notify our customer that

00:24:07,990 --> 00:24:19,400
that they are public again and sites are

00:24:12,500 --> 00:24:21,200
clean and reopened and once the sites

00:24:19,400 --> 00:24:25,400
have been reopened you naturally need to

00:24:21,200 --> 00:24:28,130
continue to monitor it closely to see if

00:24:25,400 --> 00:24:30,650
that there are new attack attempts or if

00:24:28,130 --> 00:24:32,660
there are calls if there was some

00:24:30,650 --> 00:24:34,610
backdoor that you didn't detect and some

00:24:32,660 --> 00:24:38,440
there's some suspicious traffic going on

00:24:34,610 --> 00:24:42,320
and during the investigation of course

00:24:38,440 --> 00:24:44,870
we since it took so long unusually long

00:24:42,320 --> 00:24:47,240
we send lots of status updates to the

00:24:44,870 --> 00:24:50,480
customer telling them how we're

00:24:47,240 --> 00:24:52,580
progressing and what's the state we sent

00:24:50,480 --> 00:24:55,880
eight emails all in all and then

00:24:52,580 --> 00:25:01,190
afterwards along a report about what had

00:24:55,880 --> 00:25:03,919
happened also we found out afterwards

00:25:01,190 --> 00:25:06,980
that the customer did actually get the

00:25:03,919 --> 00:25:09,100
notification emails from this fake user

00:25:06,980 --> 00:25:11,390
accounts but they just didn't realize

00:25:09,100 --> 00:25:13,270
something fishy was going on and you

00:25:11,390 --> 00:25:16,070
can't really blame blame the customer

00:25:13,270 --> 00:25:17,840
from it because there's you know lots of

00:25:16,070 --> 00:25:20,270
emails anyway and then there's Justin

00:25:17,840 --> 00:25:23,690
new registration email and nothing

00:25:20,270 --> 00:25:29,360
indicating that that it's an alarm or

00:25:23,690 --> 00:25:31,340
something and our biggest fear was that

00:25:29,360 --> 00:25:34,580
it was a targeted attack because the

00:25:31,340 --> 00:25:37,100
same customers site all went down at the

00:25:34,580 --> 00:25:39,049
same time but luckily it was just a

00:25:37,100 --> 00:25:40,640
coincidence that they were using the

00:25:39,049 --> 00:25:46,220
same plugin and all of their sites and

00:25:40,640 --> 00:25:49,090
and they were all all targeted during

00:25:46,220 --> 00:25:49,090
the same days

00:25:52,250 --> 00:25:59,660
yeah so be prepared so most of the

00:25:57,950 --> 00:26:03,880
advice online when you google about

00:25:59,660 --> 00:26:07,060
WordPress security is about how to

00:26:03,880 --> 00:26:10,250
protect your site but you also need to

00:26:07,060 --> 00:26:13,510
keep in mind that despite all possible

00:26:10,250 --> 00:26:15,980
protections some day there are zero day

00:26:13,510 --> 00:26:19,940
vulnerabilities that will get out and

00:26:15,980 --> 00:26:22,760
and bad actors are going to start

00:26:19,940 --> 00:26:24,740
bombarding the net to find sites that

00:26:22,760 --> 00:26:27,260
have those vulnerabilities and someday

00:26:24,740 --> 00:26:29,960
somebody might end bridge the site

00:26:27,260 --> 00:26:32,900
anyway so you need to have some kind of

00:26:29,960 --> 00:26:43,220
plan what steps you're going to do if

00:26:32,900 --> 00:26:46,790
that happens so here's our steps what we

00:26:43,220 --> 00:26:49,520
did in practice I hope you learned got

00:26:46,790 --> 00:26:51,200
some ideas and I hope you all think

00:26:49,520 --> 00:26:53,660
what's your strategy what will you do

00:26:51,200 --> 00:26:55,690
when you get if if you get the bad news

00:26:53,660 --> 00:26:57,860
and if you do lots of WordPress sites

00:26:55,690 --> 00:27:02,770
eventually one day you will get some bad

00:26:57,860 --> 00:27:05,990
news and you need to react thank you

00:27:02,770 --> 00:27:05,990
[Applause]

00:27:07,409 --> 00:27:13,809
when few of them so I think we have a

00:27:11,559 --> 00:27:16,299
couple of minutes and this is my twitter

00:27:13,809 --> 00:27:19,510
handle so keep an eye on it for the

00:27:16,299 --> 00:27:23,890
slides for some questions so I think

00:27:19,510 --> 00:27:34,320
young as a mic and so raise your hand if

00:27:23,890 --> 00:27:37,360
you have a question Thanks a cushion

00:27:34,320 --> 00:27:40,840
slightly related to this plug-in or gdpr

00:27:37,360 --> 00:27:42,940
plugin if the site has been hacked there

00:27:40,840 --> 00:27:46,029
is a question if personal data had been

00:27:42,940 --> 00:27:47,470
leaked and if data protection agency

00:27:46,029 --> 00:27:50,260
needs to be notified about that

00:27:47,470 --> 00:27:53,649
have you ever with WordPress done also

00:27:50,260 --> 00:27:55,779
this kind of forensics to decide or

00:27:53,649 --> 00:27:58,120
maybe what was it was wasn't important

00:27:55,779 --> 00:28:02,049
with these sites to decide if something

00:27:58,120 --> 00:28:07,090
has also been taken off the site yeah so

00:28:02,049 --> 00:28:09,640
in this case we knew that the intruder

00:28:07,090 --> 00:28:11,620
got administrator access so they could

00:28:09,640 --> 00:28:13,720
download everything if they want but we

00:28:11,620 --> 00:28:14,919
didn't find in the logs any signs at

00:28:13,720 --> 00:28:18,130
which they would have download

00:28:14,919 --> 00:28:20,080
everything and also the attack which

00:28:18,130 --> 00:28:22,240
they did that they tried they changed

00:28:20,080 --> 00:28:23,860
the site URL the redirect all the

00:28:22,240 --> 00:28:26,950
traffic somewhere else that was kind of

00:28:23,860 --> 00:28:29,429
their motivation and it didn't work very

00:28:26,950 --> 00:28:31,600
well because that site they rewrite

00:28:29,429 --> 00:28:35,679
redirect the two didn't work anymore

00:28:31,600 --> 00:28:37,870
probably got too much traffic so in this

00:28:35,679 --> 00:28:40,270
case we concluded there was not not any

00:28:37,870 --> 00:28:42,789
significant risk that all of the user

00:28:40,270 --> 00:28:45,789
data could have leaked but in other

00:28:42,789 --> 00:28:47,890
cases this is something you need to

00:28:45,789 --> 00:28:50,350
consider in Europe that you need to

00:28:47,890 --> 00:28:53,020
notify the Data Protection Agency about

00:28:50,350 --> 00:28:54,730
this and first and foremost you need to

00:28:53,020 --> 00:28:59,919
notify the customer as quickly as

00:28:54,730 --> 00:29:03,909
possible I think we had another question

00:28:59,919 --> 00:29:06,789
over there yes my question is a little

00:29:03,909 --> 00:29:10,210
more on the human side communicating

00:29:06,789 --> 00:29:14,140
this to our customer is always difficult

00:29:10,210 --> 00:29:15,970
so did you communicate it was the

00:29:14,140 --> 00:29:17,140
technical team who communicated with the

00:29:15,970 --> 00:29:20,490
customer first

00:29:17,140 --> 00:29:26,530
four and then was the customer reaction

00:29:20,490 --> 00:29:28,510
that of alarm and and kind of made your

00:29:26,530 --> 00:29:32,530
work a little bit more difficult or was

00:29:28,510 --> 00:29:34,750
a comprehension on yes so we have we

00:29:32,530 --> 00:29:36,940
have ready-made templates about what

00:29:34,750 --> 00:29:39,010
what kind of notifications we tell the

00:29:36,940 --> 00:29:41,350
customer so this is the part of the

00:29:39,010 --> 00:29:43,240
preparation you should do that in

00:29:41,350 --> 00:29:45,070
addition to having backups and

00:29:43,240 --> 00:29:46,630
everything you can do in advance and

00:29:45,070 --> 00:29:49,060
then knowing some tools how to

00:29:46,630 --> 00:29:51,490
investigate and cleanup you should also

00:29:49,060 --> 00:29:53,320
include in your process that what kind

00:29:51,490 --> 00:29:56,530
of email templates you have and what

00:29:53,320 --> 00:30:00,130
what you are notifying and where so we

00:29:56,530 --> 00:30:02,050
have a we have a good text to send to

00:30:00,130 --> 00:30:04,540
the customer so that they immediately

00:30:02,050 --> 00:30:07,660
know what's going on but they don't get

00:30:04,540 --> 00:30:08,230
too much freaked and don't do anything

00:30:07,660 --> 00:30:10,150
stupid

00:30:08,230 --> 00:30:12,310
and in this case everything worked very

00:30:10,150 --> 00:30:14,680
well the customer quickly replied that

00:30:12,310 --> 00:30:16,600
they got the email and they started to

00:30:14,680 --> 00:30:19,630
do their own investigations on their own

00:30:16,600 --> 00:30:21,040
side and checking through the day of

00:30:19,630 --> 00:30:23,320
course they didn't have access to the

00:30:21,040 --> 00:30:25,750
site during the time it was shut down

00:30:23,320 --> 00:30:27,400
but then afterwards when we reopened it

00:30:25,750 --> 00:30:29,500
we asked the customer to please log in

00:30:27,400 --> 00:30:31,540
and check continue and check if there's

00:30:29,500 --> 00:30:34,210
some animal it is because of course the

00:30:31,540 --> 00:30:37,800
customer knows the site more deeply than

00:30:34,210 --> 00:30:42,120
we do so they can detect if there's some

00:30:37,800 --> 00:30:45,820
something more unusual on the site and

00:30:42,120 --> 00:30:49,030
and yeah we sent out eight emails to the

00:30:45,820 --> 00:30:51,160
customer during this this process so the

00:30:49,030 --> 00:30:55,890
communication it's a very important part

00:30:51,160 --> 00:30:55,890
of this Thanks

00:30:56,040 --> 00:31:07,900
other questions I have one maybe I'm

00:31:05,680 --> 00:31:09,940
good I also have a question to the

00:31:07,900 --> 00:31:13,620
audience how many of you have been

00:31:09,940 --> 00:31:20,350
involved that your site got hacked

00:31:13,620 --> 00:31:22,630
ouch well you came to the right talk we

00:31:20,350 --> 00:31:25,900
have another question over here hi oh

00:31:22,630 --> 00:31:27,700
and thanks for the talk in general what

00:31:25,900 --> 00:31:31,770
do you think that's how big part of

00:31:27,700 --> 00:31:36,250
these hacks are related to

00:31:31,770 --> 00:31:38,140
yeah so that's in my security 101 talk I

00:31:36,250 --> 00:31:41,350
recommend you go and check it out on

00:31:38,140 --> 00:31:43,870
WordPress the TV so WordPress core is

00:31:41,350 --> 00:31:47,980
pretty secure at least for recent years

00:31:43,870 --> 00:31:51,370
and all of the security issues are

00:31:47,980 --> 00:31:55,150
related to teams and and most of all

00:31:51,370 --> 00:31:58,600
plugins and the sad thing is that if you

00:31:55,150 --> 00:32:01,300
look at VP Volcom which lists this known

00:31:58,600 --> 00:32:03,820
security vulnerabilities and in my

00:32:01,300 --> 00:32:06,700
security 101 talk I usually show this

00:32:03,820 --> 00:32:09,400
slide with statistics of which plugins

00:32:06,700 --> 00:32:11,500
have most security issues then in the

00:32:09,400 --> 00:32:15,670
top then there is item security and

00:32:11,500 --> 00:32:18,730
wordfriends so it's kind of ironic that

00:32:15,670 --> 00:32:21,040
most security issues are in plugins and

00:32:18,730 --> 00:32:22,809
then when people install plugins to

00:32:21,040 --> 00:32:27,600
mitigate security issues they actually

00:32:22,809 --> 00:32:27,600
get more security issues or can get more

00:32:27,929 --> 00:32:33,370
yes

00:32:29,110 --> 00:32:34,120
plugins are is the problem any other

00:32:33,370 --> 00:32:38,710
questions

00:32:34,120 --> 00:32:40,780
great questions by the way I had one

00:32:38,710 --> 00:32:44,380
thing about the checksum that you were

00:32:40,780 --> 00:32:46,360
showing how the different versions etc

00:32:44,380 --> 00:32:48,790
yeah I'm just go through that again like

00:32:46,360 --> 00:32:57,790
how you know updating a readme and how

00:32:48,790 --> 00:33:00,550
the PP CLI command can fail yeah so so

00:32:57,790 --> 00:33:02,380
the thing with the wordpress.org plug-in

00:33:00,550 --> 00:33:05,230
directory is that when you submit a new

00:33:02,380 --> 00:33:08,920
plug-in to get it in it needs to pass

00:33:05,230 --> 00:33:11,260
review but once it's in you can update

00:33:08,920 --> 00:33:14,710
it as many times you want and there's no

00:33:11,260 --> 00:33:18,850
review anymore after that and luckily

00:33:14,710 --> 00:33:20,440
there's a project called VP tied coming

00:33:18,850 --> 00:33:22,960
coming to core so that there will be

00:33:20,440 --> 00:33:25,750
more automatic quality control in the

00:33:22,960 --> 00:33:27,160
WordPress plug-in directory but

00:33:25,750 --> 00:33:30,429
currently the WordPress plug-in

00:33:27,160 --> 00:33:34,179
directory is not very supportive in

00:33:30,429 --> 00:33:37,270
quality things and this thing I was

00:33:34,179 --> 00:33:39,550
talking about is that when you publish a

00:33:37,270 --> 00:33:44,080
new version of a plug-in let's say one

00:33:39,550 --> 00:33:44,910
point five then you change the version

00:33:44,080 --> 00:33:51,000
string

00:33:44,910 --> 00:33:54,060
in the in the main plug in PHP file and

00:33:51,000 --> 00:33:56,550
push that to wordpress.org repositories

00:33:54,060 --> 00:33:58,470
and after that people will see that they

00:33:56,550 --> 00:34:01,490
have an update and they start updating

00:33:58,470 --> 00:34:04,800
that but you can also make other changes

00:34:01,490 --> 00:34:07,260
to the plug-in and push that without

00:34:04,800 --> 00:34:11,220
changing the version number so there can

00:34:07,260 --> 00:34:13,980
exist in the repository like slightly

00:34:11,220 --> 00:34:15,419
different versions of the plug-in but

00:34:13,980 --> 00:34:18,149
they still have the exact same version

00:34:15,419 --> 00:34:22,470
number and this makes it hard to verify

00:34:18,149 --> 00:34:24,750
that if you have version 1.5 installed

00:34:22,470 --> 00:34:27,960
on your system to verify in a completely

00:34:24,750 --> 00:34:30,120
automated fashion if it's still intact

00:34:27,960 --> 00:34:32,550
and not modified in any way because it

00:34:30,120 --> 00:34:35,629
can be modified it can have different

00:34:32,550 --> 00:34:41,610
versions okay thank you

00:34:35,629 --> 00:34:45,310
and if further questions then I'll think

00:34:41,610 --> 00:34:46,230
we end there with a bigger boat photo

00:34:45,310 --> 00:34:47,360
[Applause]

00:34:46,230 --> 00:34:50,139
[Music]

00:34:47,360 --> 00:34:50,139

YouTube URL: https://www.youtube.com/watch?v=WFOr7uOsufo


