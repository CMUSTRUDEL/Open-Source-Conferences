Title: Christian Boltz: AppArmor Crash Course
Publication date: 2016-06-26
Playlist: openSUSE Conference 2016
Description: 
	https://media.ccc.de/v/786-apparmor-crash-course

AppArmor is an effective and easy-to-use Linux application security system. AppArmor proactively protects the operating system and applications from external or internal threats, even zero-day attacks, by enforcing good behavior and preventing even unknown application flaws from being exploited. AppArmor security policies, called profiles, completely define what system resources individual applications can access, and with what privileges. A number of default profiles are included with AppArmor, and using a combination of advanced static analysis and learning-based tools, AppArmor profiles for even very complex applications can be deployed successfully in a matter of hours. This talk gives an introduction to AppArmor. I'll show the AppArmor tools to create and update profiles and also explain the profile syntax so that you can understand and manually edit profiles. I'll also show some advanced usage - securing a typical webserver, setting up read-only root access to do backups and how to (ab)use AppArmor for debugging.

Christian Boltz
Captions: 
	00:00:07,550 --> 00:00:13,170
so good morning everybody I'm happy to

00:00:11,490 --> 00:00:15,929
see that so many people are interested

00:00:13,170 --> 00:00:18,060
in security in the early morning so

00:00:15,929 --> 00:00:21,420
let's start you probably know me

00:00:18,060 --> 00:00:24,570
Christian toils I'm the Obama maintain

00:00:21,420 --> 00:00:29,730
an open SUSE and also upstream for at

00:00:24,570 --> 00:00:33,780
user space tools and so let's just start

00:00:29,730 --> 00:00:36,059
what does Obama do well basically the

00:00:33,780 --> 00:00:39,120
answer is simple because it allows

00:00:36,059 --> 00:00:41,809
applications to do only what which are

00:00:39,120 --> 00:00:45,329
supposed to do and deny everything else

00:00:41,809 --> 00:00:47,850
but in fact it isn't that easy because

00:00:45,329 --> 00:00:51,540
first we must tell apparmor what the

00:00:47,850 --> 00:00:55,140
application should be allowed to do so

00:00:51,540 --> 00:00:58,200
why apparmor well easier lis we would

00:00:55,140 --> 00:01:01,920
have bug free and secure software but

00:00:58,200 --> 00:01:05,220
well you all know o climbers can perform

00:01:01,920 --> 00:01:07,649
metric and that's why we have to keep an

00:01:05,220 --> 00:01:09,600
eye on what word they are doing and

00:01:07,649 --> 00:01:13,439
about more money towards the

00:01:09,600 --> 00:01:18,110
applications at the kernel level so

00:01:13,439 --> 00:01:18,110
hands up who is using app Amara

00:01:18,710 --> 00:01:24,780
okay so who is using it without knowing

00:01:22,950 --> 00:01:29,990
it because it enabled by default

00:01:24,780 --> 00:01:33,630
I guess nearly everybody so who already

00:01:29,990 --> 00:01:41,759
created or updated profile with the AAA

00:01:33,630 --> 00:01:46,290
tools okay who edited a profile with vir

00:01:41,759 --> 00:01:48,900
another editor okay I'm surprised test

00:01:46,290 --> 00:01:49,350
you seem to prefer the editor but why

00:01:48,900 --> 00:01:52,909
not

00:01:49,350 --> 00:01:57,930
and because check who never used Obama

00:01:52,909 --> 00:02:00,960
okay so also some so let's start with

00:01:57,930 --> 00:02:02,970
the usual hello well script I have a

00:02:00,960 --> 00:02:04,700
look what it does it just writes hello

00:02:02,970 --> 00:02:07,860
world to a file

00:02:04,700 --> 00:02:14,430
catch this file and deletes it again so

00:02:07,860 --> 00:02:16,770
let's create a profile right so when you

00:02:14,430 --> 00:02:18,800
create a profile there's the tool named

00:02:16,770 --> 00:02:22,790
a

00:02:18,800 --> 00:02:26,910
shrimp off and you just tell it the

00:02:22,790 --> 00:02:30,000
program Kevon to profile start it and

00:02:26,910 --> 00:02:32,910
then switch to another X term or

00:02:30,000 --> 00:02:37,950
whatever and actually on the program so

00:02:32,910 --> 00:02:41,520
in that case just hello you see it works

00:02:37,950 --> 00:02:45,660
you also see that the locates field so

00:02:41,520 --> 00:02:53,970
let's create the profile so I type as

00:02:45,660 --> 00:02:57,570
first kind elope and move up it yes so

00:02:53,970 --> 00:03:00,570
there are different ways how to execute

00:02:57,570 --> 00:03:03,959
an application I'll choose inherit I'll

00:03:00,570 --> 00:03:08,910
explain later what it does and the same

00:03:03,959 --> 00:03:12,060
for RM so then our script needs to write

00:03:08,910 --> 00:03:14,100
to the console and in that case we can

00:03:12,060 --> 00:03:16,290
use an abstraction that's the include

00:03:14,100 --> 00:03:20,900
file with a set of rules that are

00:03:16,290 --> 00:03:23,730
typical for that so a like a low of

00:03:20,900 --> 00:03:27,930
course it needs to write it some file

00:03:23,730 --> 00:03:33,739
and to read it and basically that's it

00:03:27,930 --> 00:03:37,860
so let's view the profile so you'll see

00:03:33,739 --> 00:03:39,959
the console abstraction it needs bash to

00:03:37,860 --> 00:03:43,290
run it needs to read the script itself

00:03:39,959 --> 00:03:47,220
of course pleat and by the temp file and

00:03:43,290 --> 00:03:56,340
execute cat and I am so let's save that

00:03:47,220 --> 00:03:58,920
Oh file and finish that stuff so I'm

00:03:56,340 --> 00:04:02,610
afraid I have bad news because that

00:03:58,920 --> 00:04:11,720
script is insecure so can someone parent

00:04:02,610 --> 00:04:11,720
out why it is insecure any ideas

00:04:13,280 --> 00:04:19,470
nobody occurs seems you didn't have

00:04:16,229 --> 00:04:22,260
enough coffee so let me explain it it's

00:04:19,470 --> 00:04:22,740
quite simple it uses a fixed filename in

00:04:22,260 --> 00:04:24,840
temp

00:04:22,740 --> 00:04:29,870
and that means you can do a sibling

00:04:24,840 --> 00:04:39,150
attack so back to the shell

00:04:29,870 --> 00:04:46,970
let's check the profile okay good hint

00:04:39,150 --> 00:04:50,310
thank you so that's a our profile we

00:04:46,970 --> 00:04:55,170
already have seen it when creating it

00:04:50,310 --> 00:04:59,640
so trust stop and now let's say we are

00:04:55,170 --> 00:05:05,460
an evil hacker who done something like

00:04:59,640 --> 00:05:15,420
that to make it more funny let's even

00:05:05,460 --> 00:05:19,560
even do it as good so we now have a

00:05:15,420 --> 00:05:23,430
sibling and if we now found hello world

00:05:19,560 --> 00:05:24,000
script again it will just say permission

00:05:23,430 --> 00:05:30,240
denied

00:05:24,000 --> 00:05:32,130
and you can also see it in the lock so

00:05:30,240 --> 00:05:34,350
the sibling pointed to the route

00:05:32,130 --> 00:05:37,590
authorized piece but the profile denied

00:05:34,350 --> 00:05:41,420
access to it so that's the first case

00:05:37,590 --> 00:05:47,280
where a bomb were prevented an exploit

00:05:41,420 --> 00:05:49,770
so back to the presentation and let's

00:05:47,280 --> 00:05:52,320
see what what does a bomb or a tool in

00:05:49,770 --> 00:05:54,930
detail so it monitors and restricts file

00:05:52,320 --> 00:05:58,050
access we have already seen that also

00:05:54,930 --> 00:06:02,940
network access capabilities like change

00:05:58,050 --> 00:06:06,000
on make note set your ID whatever men

00:06:02,940 --> 00:06:08,850
seven capabilities has a full list you

00:06:06,000 --> 00:06:11,520
can set a limits also known as you limit

00:06:08,850 --> 00:06:14,340
and in general Obama restricts

00:06:11,520 --> 00:06:17,190
permissions what does a bomb were not do

00:06:14,340 --> 00:06:19,800
it does not replace the traditional file

00:06:17,190 --> 00:06:22,890
permissions so please do not change mode

00:06:19,800 --> 00:06:25,200
seven seven seven everything it does not

00:06:22,890 --> 00:06:28,410
replace the user permission so you

00:06:25,200 --> 00:06:30,690
shouldn't run everything else would then

00:06:28,410 --> 00:06:31,710
if you're on a web server you want to

00:06:30,690 --> 00:06:34,610
have

00:06:31,710 --> 00:06:38,580
my SQL user for each hosting and task

00:06:34,610 --> 00:06:41,100
you probably also want to test the MySQL

00:06:38,580 --> 00:06:43,260
firewall we heard yesterday you should

00:06:41,100 --> 00:06:46,710
of course validate the user input

00:06:43,260 --> 00:06:49,290
you should escape special chars and the

00:06:46,710 --> 00:06:53,280
PHP files who have seen extension is

00:06:49,290 --> 00:06:56,550
also a nice thing so it's the surface if

00:06:53,280 --> 00:06:58,460
you are now hmm if I would say yes it

00:06:56,550 --> 00:07:02,160
would be too easy because security

00:06:58,460 --> 00:07:04,740
consists of a lot of things and apparmor

00:07:02,160 --> 00:07:08,310
protects you from a lot but not

00:07:04,740 --> 00:07:10,920
everything and I think we can say with a

00:07:08,310 --> 00:07:16,320
bomber at the server is more secure than

00:07:10,920 --> 00:07:19,530
without so what are the epimer tools we

00:07:16,320 --> 00:07:22,530
have a status which shows you an

00:07:19,530 --> 00:07:25,560
overview of the loaded profiles and how

00:07:22,530 --> 00:07:27,840
they are used we have a a unconfined

00:07:25,560 --> 00:07:32,370
which shows you which running processes

00:07:27,840 --> 00:07:35,430
are protected and what which not you can

00:07:32,370 --> 00:07:39,690
get desktop notifications and lock

00:07:35,430 --> 00:07:41,880
summaries with a a notify then we have a

00:07:39,690 --> 00:07:43,680
a complaint this switches the profile

00:07:41,880 --> 00:07:46,620
into learning mode so it allows

00:07:43,680 --> 00:07:48,560
everything but writes to the look the

00:07:46,620 --> 00:07:52,590
things that are not in the profile yet

00:07:48,560 --> 00:07:54,840
we have a inverse which does exactly the

00:07:52,590 --> 00:07:57,000
opposite and switch the profile Indian

00:07:54,840 --> 00:08:00,420
forest mode so if something is not in

00:07:57,000 --> 00:08:02,880
the profile it will be blocked we have a

00:08:00,420 --> 00:08:05,070
a disabled which you hopefully don't

00:08:02,880 --> 00:08:08,580
need too often because it trust is a

00:08:05,070 --> 00:08:11,640
piece of profile and we have a a audit

00:08:08,580 --> 00:08:13,590
which switches the whole profile in the

00:08:11,640 --> 00:08:15,960
audit mode which means it looks

00:08:13,590 --> 00:08:21,120
everything even if it's allowed in the

00:08:15,960 --> 00:08:24,090
profile then we have a a lock port

00:08:21,120 --> 00:08:27,420
that's a tool to update existing all

00:08:24,090 --> 00:08:30,270
files based on the audit log I already

00:08:27,420 --> 00:08:33,690
showed a HN off that's for creating a

00:08:30,270 --> 00:08:36,480
new profile a very small version to

00:08:33,690 --> 00:08:39,330
create the basic profile is a Auto tab

00:08:36,480 --> 00:08:42,770
which you typically don't run manually

00:08:39,330 --> 00:08:46,490
because it's done by a train of already

00:08:42,770 --> 00:08:48,620
then there is a easy proof that's a

00:08:46,490 --> 00:08:50,600
template based system which is not

00:08:48,620 --> 00:08:54,560
really used in openSUSE part open to

00:08:50,600 --> 00:08:57,890
users is quite a bit one of the newer

00:08:54,560 --> 00:09:00,560
tools is a report that is if you have

00:08:57,890 --> 00:09:03,110
free surface and over the time the

00:09:00,560 --> 00:09:05,120
profiles were updated you know on one

00:09:03,110 --> 00:09:08,330
sapphire edit is on the other you're at

00:09:05,120 --> 00:09:12,380
a debt and a markup roof can be used to

00:09:08,330 --> 00:09:16,070
indicate everything again a clean path

00:09:12,380 --> 00:09:19,100
is trust cleanup so it removes holes

00:09:16,070 --> 00:09:22,190
that are covered by other holes so it's

00:09:19,100 --> 00:09:25,370
the profile whatever so it looks clear

00:09:22,190 --> 00:09:29,660
again then we'll have a little helper

00:09:25,370 --> 00:09:32,029
named ad code because if your file has a

00:09:29,660 --> 00:09:35,540
special name which can be for example

00:09:32,029 --> 00:09:38,899
with space in it the audit lock will

00:09:35,540 --> 00:09:41,899
contain somewhat encoded string which is

00:09:38,899 --> 00:09:46,820
not user readable and API code will make

00:09:41,899 --> 00:09:49,459
it readable again and we have a exact

00:09:46,820 --> 00:09:52,430
which can be used to execute something

00:09:49,459 --> 00:09:58,040
with profile that is not a default

00:09:52,430 --> 00:10:01,610
profile right so let's have a look at a

00:09:58,040 --> 00:10:06,649
a unconfined that's an example output so

00:10:01,610 --> 00:10:09,860
we see we SFTP T is not confined and

00:10:06,649 --> 00:10:12,800
there's a trainer on all of everything

00:10:09,860 --> 00:10:16,430
that is accessible from the Internet

00:10:12,800 --> 00:10:21,649
should be perfect protected and because

00:10:16,430 --> 00:10:26,270
we as if DBT is not we should just fix

00:10:21,649 --> 00:10:28,459
that and yeah as I already showed off

00:10:26,270 --> 00:10:33,200
the HelloWorld script the best method to

00:10:28,459 --> 00:10:36,500
do is to extremes in the first johan ahn

00:10:33,200 --> 00:10:41,089
probe in the second queue actually used

00:10:36,500 --> 00:10:44,480
application and usual techniques is for

00:10:41,089 --> 00:10:47,570
us trust to a start and stop and then

00:10:44,480 --> 00:10:50,350
update the profile a first time that

00:10:47,570 --> 00:10:52,160
means you don't get to be clock gated

00:10:50,350 --> 00:10:54,230
passives in the profile

00:10:52,160 --> 00:10:56,510
then in the second step you use the

00:10:54,230 --> 00:10:59,540
application scandal

00:10:56,510 --> 00:11:02,090
again update the profile and so on and

00:10:59,540 --> 00:11:05,150
when you have done that you probably

00:11:02,090 --> 00:11:06,820
might run want to run the profile in the

00:11:05,150 --> 00:11:09,950
learning mode for some time because

00:11:06,820 --> 00:11:10,810
usually you don't get everything in five

00:11:09,950 --> 00:11:23,030
minutes

00:11:10,810 --> 00:11:31,870
so let's just create a profile so a a

00:11:23,030 --> 00:11:35,390
trend of V as FTP D so let's just

00:11:31,870 --> 00:11:39,640
restart it you see there are already

00:11:35,390 --> 00:11:43,460
some things in the look so scandal log

00:11:39,640 --> 00:11:46,640
let's see what does it want to do it

00:11:43,460 --> 00:11:52,810
needs the net ban service capability not

00:11:46,640 --> 00:11:56,960
surprising then it needs name service

00:11:52,810 --> 00:11:59,330
that includes the network access but

00:11:56,960 --> 00:12:04,280
also things like rating results on

00:11:59,330 --> 00:12:09,020
asking your name server whatever it is

00:12:04,280 --> 00:12:11,570
it's config file then that's neat in

00:12:09,020 --> 00:12:16,340
from something else but why not I'll

00:12:11,570 --> 00:12:19,940
just ignore it for now okay the edge

00:12:16,340 --> 00:12:23,170
client is doing funny stuff with me but

00:12:19,940 --> 00:12:26,540
let's focus on the FTP T profile and

00:12:23,170 --> 00:12:31,640
that's the basic one for at least being

00:12:26,540 --> 00:12:36,620
able to start and stop it so safety

00:12:31,640 --> 00:12:46,670
changes again now we should probably use

00:12:36,620 --> 00:12:47,150
it so let's say look in so we are logged

00:12:46,670 --> 00:12:50,840
in

00:12:47,150 --> 00:12:55,310
look out again and now back to scanning

00:12:50,840 --> 00:12:59,540
the lock so we see FTP logins mean

00:12:55,310 --> 00:13:02,720
change old so we should allow that it's

00:12:59,540 --> 00:13:04,690
it's the user ID to the login name so

00:13:02,720 --> 00:13:07,850
that's also okay

00:13:04,690 --> 00:13:10,660
it writes through the audit log when

00:13:07,850 --> 00:13:10,660
someone logged in

00:13:12,010 --> 00:13:21,800
and it needs to read environment file

00:13:16,630 --> 00:13:24,770
FTP use us it needs to do identification

00:13:21,800 --> 00:13:27,710
so let's just include the RT different

00:13:24,770 --> 00:13:33,250
kind in abstraction so that includes

00:13:27,710 --> 00:13:38,440
everything it checks to eat it seashells

00:13:33,250 --> 00:13:38,440
the edge client again ignore it for now

00:13:38,890 --> 00:13:47,000
no so what do we have

00:13:42,310 --> 00:13:51,050
you see we added the abstraction for

00:13:47,000 --> 00:13:57,200
identification some capabilities and so

00:13:51,050 --> 00:13:59,060
on so safe that one and I'll finish for

00:13:57,200 --> 00:14:02,300
now but the profile is not really

00:13:59,060 --> 00:14:04,370
finished because we still did not upload

00:14:02,300 --> 00:14:08,120
any file so that's missing from the

00:14:04,370 --> 00:14:13,850
profile so let's put it in the learning

00:14:08,120 --> 00:14:16,130
mode okay but I think I don't need to

00:14:13,850 --> 00:14:21,650
show this in detail because it's exactly

00:14:16,130 --> 00:14:24,260
the same workflow so let's see file

00:14:21,650 --> 00:14:27,710
permissions we already had some of them

00:14:24,260 --> 00:14:32,840
read and write are obvious there's a for

00:14:27,710 --> 00:14:37,520
append l for harding's k for a look and

00:14:32,840 --> 00:14:40,940
for a map so for libraries you usual it

00:14:37,520 --> 00:14:45,860
and there are different execute options

00:14:40,940 --> 00:14:49,220
so we have the inherit option IX means

00:14:45,860 --> 00:14:51,650
on the program with the same profile and

00:14:49,220 --> 00:14:55,040
that's what you use for a helper

00:14:51,650 --> 00:14:59,480
application edge shell so cat crap and

00:14:55,040 --> 00:15:02,660
bash whatever and you can also use it

00:14:59,480 --> 00:15:05,390
for a whole based access control style

00:15:02,660 --> 00:15:08,570
if you just confine the use as well

00:15:05,390 --> 00:15:10,730
which should then be a shell with a non

00:15:08,570 --> 00:15:15,170
default name because you don't want to

00:15:10,730 --> 00:15:21,200
have a covert operation another way our

00:15:15,170 --> 00:15:24,590
child profiles see it's that thing that

00:15:21,200 --> 00:15:28,820
gets used for a full foothold by bar

00:15:24,590 --> 00:15:32,060
but not if you call foof stand alone and

00:15:28,820 --> 00:15:34,550
that's useful if the helper program

00:15:32,060 --> 00:15:39,980
needs more or less permissions than the

00:15:34,550 --> 00:15:42,410
main application we have 2 px option

00:15:39,980 --> 00:15:45,980
which means create a separate profile

00:15:42,410 --> 00:15:48,260
for the other application and this

00:15:45,980 --> 00:15:50,750
profile is also used when the other

00:15:48,260 --> 00:15:54,260
application is called standalone and as

00:15:50,750 --> 00:15:56,930
I already said do not do this for any

00:15:54,260 --> 00:15:58,870
shell because it will just make your

00:15:56,930 --> 00:16:01,700
system unusable

00:15:58,870 --> 00:16:04,300
except if you allow basically everything

00:16:01,700 --> 00:16:07,250
and that would make the profile useless

00:16:04,300 --> 00:16:10,220
and finally we have the option if

00:16:07,250 --> 00:16:13,730
nothing else is possible to use

00:16:10,220 --> 00:16:17,810
unconfined so if a program gets executed

00:16:13,730 --> 00:16:20,090
it runs without a bubble protection that

00:16:17,810 --> 00:16:22,400
should be a highly used but it can be

00:16:20,090 --> 00:16:25,430
useful for example if you protect your

00:16:22,400 --> 00:16:27,980
SSH daemon and then after the login you

00:16:25,430 --> 00:16:30,880
can allow to run the shells unconfined

00:16:27,980 --> 00:16:35,000
so that the users can actually work

00:16:30,880 --> 00:16:37,040
there are also 4 peg holes like peek

00:16:35,000 --> 00:16:39,830
spooks and the same for child profiles

00:16:37,040 --> 00:16:43,820
which means for Peaks if a profile

00:16:39,830 --> 00:16:45,860
exists use it and otherwise fall back to

00:16:43,820 --> 00:16:48,230
the current profile and I think the

00:16:45,860 --> 00:16:52,370
other ones are obvious so I don't need

00:16:48,230 --> 00:16:57,020
to explain them in detail there's also

00:16:52,370 --> 00:17:01,030
the option to apply a name to a profile

00:16:57,020 --> 00:17:04,490
and use named execute rules so you can

00:17:01,030 --> 00:17:07,100
say you use a short name for the profile

00:17:04,490 --> 00:17:09,790
like I show with profile ping and then

00:17:07,100 --> 00:17:13,040
the path so it will still apply to ping

00:17:09,790 --> 00:17:16,310
but it has a short name so it's easier

00:17:13,040 --> 00:17:18,740
to refer and the rules look like what

00:17:16,310 --> 00:17:21,920
you see in the bottom right so just the

00:17:18,740 --> 00:17:25,070
arrow and a file name as target so you

00:17:21,920 --> 00:17:29,750
can call separate help us with the same

00:17:25,070 --> 00:17:32,600
profile for example then there's another

00:17:29,750 --> 00:17:34,730
thing with execute holes you can decide

00:17:32,600 --> 00:17:37,310
if you want to clean the environment

00:17:34,730 --> 00:17:40,370
variables like LD preload and so

00:17:37,310 --> 00:17:42,620
on in general you should do that because

00:17:40,370 --> 00:17:46,730
it's more secure that are the uppercase

00:17:42,620 --> 00:17:49,670
holes and if you really need LD preload

00:17:46,730 --> 00:17:55,880
and so on tree soft then use lower kites

00:17:49,670 --> 00:17:59,960
execution rules so there are also other

00:17:55,880 --> 00:18:04,430
cool types like network we already have

00:17:59,960 --> 00:18:08,300
that and the newest currently hold also

00:18:04,430 --> 00:18:11,600
supports steepest mountain areas hybrid

00:18:08,300 --> 00:18:13,880
hood and unique sockets but that stuff

00:18:11,600 --> 00:18:16,520
that is currently only in the open do

00:18:13,880 --> 00:18:20,170
kernel so where promised to upstream it

00:18:16,520 --> 00:18:24,230
but didn't have time to do it yet

00:18:20,170 --> 00:18:27,320
so just a small look at the audit log

00:18:24,230 --> 00:18:30,710
format again you probably notice that

00:18:27,320 --> 00:18:35,780
there are lots of tickets in it so you

00:18:30,710 --> 00:18:39,530
have this one that's actually two types

00:18:35,780 --> 00:18:42,050
them and if you want that in a human

00:18:39,530 --> 00:18:45,500
little readable way you can trust you

00:18:42,050 --> 00:18:48,440
state minus th and then the number and

00:18:45,500 --> 00:18:51,500
that will convert it to something human

00:18:48,440 --> 00:18:56,540
cannon can understand and you should

00:18:51,500 --> 00:18:58,940
also check your auditor regularly so ad

00:18:56,540 --> 00:19:02,660
to the Lochte cast or lit on mail loot

00:18:58,940 --> 00:19:06,220
summary created by a a notify whatever

00:19:02,660 --> 00:19:09,740
you prefer are the event types can be

00:19:06,220 --> 00:19:13,730
denied that are blocked violations of

00:19:09,740 --> 00:19:16,610
profiles in enforce mode you can have

00:19:13,730 --> 00:19:18,710
audit events which happen if you

00:19:16,610 --> 00:19:22,420
switched a profile to the audit mode or

00:19:18,710 --> 00:19:26,210
if all has the audit here at in it and

00:19:22,420 --> 00:19:31,160
there's the allowed event for profiles

00:19:26,210 --> 00:19:33,500
in complain mode so now to the more

00:19:31,160 --> 00:19:37,670
interesting stuff there's an Apache

00:19:33,500 --> 00:19:39,920
module madhava MOA so typically you're

00:19:37,670 --> 00:19:43,150
out in your global Apache config

00:19:39,920 --> 00:19:47,030
somewhere the a a default head name

00:19:43,150 --> 00:19:49,970
default for her for example because

00:19:47,030 --> 00:19:51,170
otherwise it could happen that Obama

00:19:49,970 --> 00:19:54,550
proposes one

00:19:51,170 --> 00:19:57,980
had a file and that's a bit too much

00:19:54,550 --> 00:20:00,920
then you can intrude set it for each

00:19:57,980 --> 00:20:05,780
virtual host with a default head name

00:20:00,920 --> 00:20:08,740
again and that is what you usually do to

00:20:05,780 --> 00:20:12,590
restrict each virtual host to itself and

00:20:08,740 --> 00:20:14,540
if you have several wireless ebonite

00:20:12,590 --> 00:20:18,560
things on a virtual host like let's say

00:20:14,540 --> 00:20:23,360
a wiki for our home and whatever on the

00:20:18,560 --> 00:20:26,780
same domain so you can also set the head

00:20:23,360 --> 00:20:31,220
to use for each directory or even for a

00:20:26,780 --> 00:20:34,040
single file if you really want so I

00:20:31,220 --> 00:20:37,670
mentioned the word heads a few times

00:20:34,040 --> 00:20:39,920
what's that heads are similar to support

00:20:37,670 --> 00:20:41,990
files the difference is that an

00:20:39,920 --> 00:20:45,260
application can switch between them

00:20:41,990 --> 00:20:47,960
easily there's the change head call in

00:20:45,260 --> 00:20:50,420
the lip of amaura but you can also trust

00:20:47,960 --> 00:20:53,920
write to a file in Bock if you really

00:20:50,420 --> 00:20:56,840
want and the typical use case is

00:20:53,920 --> 00:21:00,350
aperture with several heads one per

00:20:56,840 --> 00:21:05,870
virtual host at least and that's the

00:21:00,350 --> 00:21:09,380
syntax so how did it does it look in

00:21:05,870 --> 00:21:13,690
like this for example for my own home

00:21:09,380 --> 00:21:16,400
page the base configuration first

00:21:13,690 --> 00:21:21,830
include the common abstraction stuff

00:21:16,400 --> 00:21:25,040
like our pages and whatever then allowed

00:21:21,830 --> 00:21:27,530
to lead password for accessing my web

00:21:25,040 --> 00:21:30,110
statistics of course hello reading

00:21:27,530 --> 00:21:33,560
everything in the document hood and

00:21:30,110 --> 00:21:36,500
low-light access to the looks you see I

00:21:33,560 --> 00:21:38,900
also allow write access to looks that

00:21:36,500 --> 00:21:42,740
are just rotated away but aperture is

00:21:38,900 --> 00:21:45,410
not a started yet the reader except said

00:21:42,740 --> 00:21:51,680
he sticks write access to the temp file

00:21:45,410 --> 00:21:54,440
for like PHP sessions yeah and you want

00:21:51,680 --> 00:21:56,480
to create that snippets with a script

00:21:54,440 --> 00:21:59,600
because you need it for each virtual

00:21:56,480 --> 00:22:04,179
host and doing doing it manually

00:21:59,600 --> 00:22:07,220
no fangs there's a special hose a

00:22:04,179 --> 00:22:10,190
special hat named handling untrusted

00:22:07,220 --> 00:22:14,090
input that is used when are purchased

00:22:10,190 --> 00:22:17,299
just idling around and the interesting

00:22:14,090 --> 00:22:19,280
thing is it sometimes does a bit more

00:22:17,299 --> 00:22:23,059
than you would think so

00:22:19,280 --> 00:22:25,789
it happens that it does the look lights

00:22:23,059 --> 00:22:28,130
for each virtual host because for some

00:22:25,789 --> 00:22:29,830
reason I Petra leaves the virtual host

00:22:28,130 --> 00:22:35,030
head too early

00:22:29,830 --> 00:22:38,210
so how tied to the profile be I have a

00:22:35,030 --> 00:22:41,120
real world example of a forum you know

00:22:38,210 --> 00:22:44,600
it allows to upload avatar pictures

00:22:41,120 --> 00:22:47,330
that's nice but it's not so nice if you

00:22:44,600 --> 00:22:51,770
can upload something like my photo dot

00:22:47,330 --> 00:22:56,090
PHP and so the question is does your

00:22:51,770 --> 00:22:58,940
profile have a low uploading any file in

00:22:56,090 --> 00:23:04,250
the avatar and actually or a low trust

00:22:58,940 --> 00:23:07,990
JPEG PNG and chief and you can also use

00:23:04,250 --> 00:23:12,740
a hole like deny owner slash everything

00:23:07,990 --> 00:23:15,320
dot PHP read and write that means to

00:23:12,740 --> 00:23:18,620
deny reading and writing files that are

00:23:15,320 --> 00:23:22,610
owned by the user so the Apache user

00:23:18,620 --> 00:23:25,100
effectively that prevents exploits but

00:23:22,610 --> 00:23:27,650
the problem is that a modern content

00:23:25,100 --> 00:23:29,990
management systems have functions to

00:23:27,650 --> 00:23:33,350
update themselves and basically will

00:23:29,990 --> 00:23:40,220
need to read and write files that are

00:23:33,350 --> 00:23:43,220
owned by the Apache user so I also did

00:23:40,220 --> 00:23:46,070
some creative usage of Abba more like an

00:23:43,220 --> 00:23:49,760
inventor release so which we actual hose

00:23:46,070 --> 00:23:52,789
uses the scripts I have in Asafa variety

00:23:49,760 --> 00:23:56,210
rectory which we actual host called sent

00:23:52,789 --> 00:23:58,429
mail you can also use it as a debugging

00:23:56,210 --> 00:24:00,799
tool if you want to find out which files

00:23:58,429 --> 00:24:03,919
an application reads and writes it's

00:24:00,799 --> 00:24:10,010
probably easier to use ten space in some

00:24:03,919 --> 00:24:13,230
cases an important detail is the PS set

00:24:10,010 --> 00:24:16,080
out so the abacus set will

00:24:13,230 --> 00:24:19,380
include the current profiler processes

00:24:16,080 --> 00:24:21,630
using so you can for example see for at

00:24:19,380 --> 00:24:24,750
the aperture processes in which virtual

00:24:21,630 --> 00:24:27,660
hosts it is currently that's good if you

00:24:24,750 --> 00:24:30,000
want up mmm what is this process doing

00:24:27,660 --> 00:24:33,540
with an eating CPU or something like

00:24:30,000 --> 00:24:36,410
that and another funny example is feed

00:24:33,540 --> 00:24:40,290
only a good excess for doing backups and

00:24:36,410 --> 00:24:43,620
that looks like that basically it

00:24:40,290 --> 00:24:48,090
consists of two parts first I have to

00:24:43,620 --> 00:24:51,780
assess ap in the otherwise keys with the

00:24:48,090 --> 00:24:54,929
restriction command who'd been as in

00:24:51,780 --> 00:24:58,410
trend so that he can only be used to

00:24:54,929 --> 00:25:02,120
execute this one command and that's

00:24:58,410 --> 00:25:05,460
actually a little script which first

00:25:02,120 --> 00:25:09,179
writes the command through the syslog

00:25:05,460 --> 00:25:13,260
then checks if it's really as soon call

00:25:09,179 --> 00:25:17,910
that trust an additional safety net and

00:25:13,260 --> 00:25:21,809
finally execute sit and the second part

00:25:17,910 --> 00:25:25,860
is the profile so the short version is

00:25:21,809 --> 00:25:29,070
it allows to execute a sink with inherit

00:25:25,860 --> 00:25:31,740
so with the same profile it also allows

00:25:29,070 --> 00:25:34,620
to execute lookup bash and prep that's

00:25:31,740 --> 00:25:38,490
needed by the script and it allows

00:25:34,620 --> 00:25:40,620
reading stuff in et Cie home and yes you

00:25:38,490 --> 00:25:43,679
probably want to add some other

00:25:40,620 --> 00:25:48,929
directories there but I think you get

00:25:43,679 --> 00:25:52,110
the point so it can't write anything so

00:25:48,929 --> 00:25:54,330
maybe some of you heard I was at DEFCON

00:25:52,110 --> 00:25:58,140
fall so so is there any relation between

00:25:54,330 --> 00:26:02,610
dependent openSUSE well I'd say it

00:25:58,140 --> 00:26:06,330
depends how you turn it but to be more

00:26:02,610 --> 00:26:07,620
serious I helped a peon people a bit to

00:26:06,330 --> 00:26:12,120
get started with a pamoja

00:26:07,620 --> 00:26:15,330
and if everything works out well now be

00:26:12,120 --> 00:26:17,640
in Cape Town and work on a profile

00:26:15,330 --> 00:26:18,360
people for a cost distribution or

00:26:17,640 --> 00:26:21,570
file-sharing

00:26:18,360 --> 00:26:24,809
so everyone benefits

00:26:21,570 --> 00:26:27,359
and we shouldn't forget open to because

00:26:24,809 --> 00:26:34,769
some other obama developers are working

00:26:27,359 --> 00:26:38,249
for canonical so there's a final profile

00:26:34,769 --> 00:26:41,429
i will show i don't recommend to use

00:26:38,249 --> 00:26:44,970
that style because well as you can see

00:26:41,429 --> 00:26:45,559
it's not too readable so what does this

00:26:44,970 --> 00:26:49,639
do

00:26:45,559 --> 00:26:54,029
first there's the file hole that means

00:26:49,639 --> 00:26:56,759
hello all file access yeah that's the

00:26:54,029 --> 00:26:59,009
real part of this profile because you

00:26:56,759 --> 00:27:02,099
should not do that because then you need

00:26:59,009 --> 00:27:05,669
to that to use deny rules to create

00:27:02,099 --> 00:27:08,879
exceptions so i think i'll just show

00:27:05,669 --> 00:27:11,999
what we do so as i started the global

00:27:08,879 --> 00:27:15,090
file rule is the bad idea and then we

00:27:11,999 --> 00:27:18,570
have to add some exceptions so i have a

00:27:15,090 --> 00:27:21,499
lot of fun first we deny writing to

00:27:18,570 --> 00:27:25,080
files directly into the popular actually

00:27:21,499 --> 00:27:30,090
then the next hole is the most funny one

00:27:25,080 --> 00:27:36,869
we deny writing to everything instead of

00:27:30,090 --> 00:27:39,179
pork number so the poke pit or boxes so

00:27:36,869 --> 00:27:43,739
these two are allowed and everything

00:27:39,179 --> 00:27:48,349
else in pork is denied and then it goes

00:27:43,739 --> 00:27:52,379
into the detail even more as though

00:27:48,349 --> 00:27:58,769
effectively it denies everything that is

00:27:52,379 --> 00:28:03,389
in boxes but not boxes curdled as age am

00:27:58,769 --> 00:28:05,039
something so the pet thing is this is

00:28:03,389 --> 00:28:06,720
not something I made up this is

00:28:05,039 --> 00:28:11,539
something that it's used in the real

00:28:06,720 --> 00:28:11,539
world and that's the reaction

00:28:16,730 --> 00:28:24,800
so it's really profile where I say yes

00:28:20,610 --> 00:28:27,840
as Perrine might be needed to avoid edge

00:28:24,800 --> 00:28:30,810
so if you want more information about

00:28:27,840 --> 00:28:33,590
Abba MOA that's the Abba more 30 main

00:28:30,810 --> 00:28:36,210
page that describes the profile syntax

00:28:33,590 --> 00:28:38,850
that's of course the upstream homepage

00:28:36,210 --> 00:28:41,340
and we give we have something in the

00:28:38,850 --> 00:28:44,820
openSUSE Vicky deep ian has something

00:28:41,340 --> 00:28:46,950
opened oh there's also a nice chapter in

00:28:44,820 --> 00:28:51,630
the openSUSE security guide about Abba

00:28:46,950 --> 00:28:54,480
MOA and if you need help come to the IRC

00:28:51,630 --> 00:28:58,170
channel on the absolute mailing list or

00:28:54,480 --> 00:29:03,120
maybe even on the tibia Abama mailing

00:28:58,170 --> 00:29:10,890
lists and basically that's it any

00:29:03,120 --> 00:29:21,330
questions ok wait for the microphone

00:29:10,890 --> 00:29:24,200
please I'm developing a Balin server and

00:29:21,330 --> 00:29:26,940
I'm wondering but I could use a Parma to

00:29:24,200 --> 00:29:30,960
confine which applications are allowed

00:29:26,940 --> 00:29:33,390
to accept which protocols like in KDE we

00:29:30,960 --> 00:29:35,760
have a few privileged protocols which we

00:29:33,390 --> 00:29:38,730
only want certain applications to be

00:29:35,760 --> 00:29:42,780
able to access would apparmor be a

00:29:38,730 --> 00:29:45,660
solution for that I'd have to check how

00:29:42,780 --> 00:29:49,500
exactly these protocols are used so you

00:29:45,660 --> 00:29:52,230
could be hurt one if you can do it on a

00:29:49,500 --> 00:29:54,330
file level like the protocol needs that

00:29:52,230 --> 00:30:01,350
to read that file you could deny it that

00:29:54,330 --> 00:30:05,240
way not the network restrictions are not

00:30:01,350 --> 00:30:09,780
too detailed I plans to change this but

00:30:05,240 --> 00:30:12,570
nothing did it yet so maybe you could do

00:30:09,780 --> 00:30:15,960
something on allowing or not allowing to

00:30:12,570 --> 00:30:19,530
execute in a binary that would be an

00:30:15,960 --> 00:30:21,930
option so in general I think it should

00:30:19,530 --> 00:30:25,730
be possible but I'm happy to discuss it

00:30:21,930 --> 00:30:25,730
in detail Rafi okay let's do that

00:30:27,180 --> 00:30:42,960
other questions okay doesn't look so so

00:30:38,970 --> 00:30:47,210
I'm not sure did I tell you everything

00:30:42,960 --> 00:30:51,380
are you still just liking coffee so

00:30:47,210 --> 00:30:51,380

YouTube URL: https://www.youtube.com/watch?v=o2xa8JYcrmw


